"use strict";(self.webpackChunkcode_note_blog=self.webpackChunkcode_note_blog||[]).push([[5572],{34153:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>c,default:()=>p,frontMatter:()=>o,metadata:()=>i,toc:()=>l});var r=t(11527),a=t(88672);const o={},c="Spring Cloud LoadBalancer",i={id:"Spring\u5168\u5bb6\u6876/SpringCloud\u6e90\u7801\u5206\u6790/SpringCloudLoadBalancer\u6e90\u7801\u5206\u6790",title:"Spring Cloud LoadBalancer",description:"\u6982\u8ff0",source:"@site/docs/Spring\u5168\u5bb6\u6876/SpringCloud\u6e90\u7801\u5206\u6790/SpringCloudLoadBalancer\u6e90\u7801\u5206\u6790.md",sourceDirName:"Spring\u5168\u5bb6\u6876/SpringCloud\u6e90\u7801\u5206\u6790",slug:"/Spring\u5168\u5bb6\u6876/SpringCloud\u6e90\u7801\u5206\u6790/SpringCloudLoadBalancer\u6e90\u7801\u5206\u6790",permalink:"/code-note-blog/docs/Spring\u5168\u5bb6\u6876/SpringCloud\u6e90\u7801\u5206\u6790/SpringCloudLoadBalancer\u6e90\u7801\u5206\u6790",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Spring\u5168\u5bb6\u6876/SpringCloud\u6e90\u7801\u5206\u6790/SpringCloudLoadBalancer\u6e90\u7801\u5206\u6790.md",tags:[],version:"current",frontMatter:{},sidebar:"spring",previous:{title:"SpringCloudHystrix\u6e90\u7801\u5206\u6790",permalink:"/code-note-blog/docs/Spring\u5168\u5bb6\u6876/SpringCloud\u6e90\u7801\u5206\u6790/SpringCloudHystrix\u6e90\u7801\u5206\u6790"},next:{title:"SpringCloudOpenFeign\u6e90\u7801\u5206\u6790",permalink:"/code-note-blog/docs/Spring\u5168\u5bb6\u6876/SpringCloud\u6e90\u7801\u5206\u6790/SpringCloudOpenFeign\u6e90\u7801\u5206\u6790"}},s={},l=[{value:"\u6982\u8ff0",id:"\u6982\u8ff0",level:2},{value:"\u5165\u95e8\u793a\u4f8b",id:"\u5165\u95e8\u793a\u4f8b",level:2},{value:"\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u5207\u6362",id:"\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u5207\u6362",level:2},{value:"\u96c6\u6210\u65b9\u5f0f",id:"\u96c6\u6210\u65b9\u5f0f",level:2},{value:"\u539f\u7406",id:"\u539f\u7406",level:2},{value:"RestTemplate",id:"resttemplate",level:3},{value:"<strong>LoadBalancerAutoConfiguration</strong>",id:"loadbalancerautoconfiguration",level:3},{value:"<strong>LoadBalancerLnterceptor</strong>",id:"loadbalancerlnterceptor",level:3},{value:"<strong>LoadBalancerClient</strong>",id:"loadbalancerclient",level:3},{value:"<strong>LoadBalancerClientFactory</strong>",id:"loadbalancerclientfactory",level:3},{value:"ReactiveLoadBalancer",id:"reactiveloadbalancer",level:3},{value:"LoadBalancerClientConfiguration",id:"loadbalancerclientconfiguration",level:3},{value:"<strong>LoadBalancerRequestFactory</strong>",id:"loadbalancerrequestfactory",level:3},{value:"ReactorLoadBalancerClientAutoConfiguration",id:"reactorloadbalancerclientautoconfiguration",level:3},{value:"\u81ea\u5b9a\u4e49\u8d1f\u8f7d\u5747\u8861\u5668",id:"\u81ea\u5b9a\u4e49\u8d1f\u8f7d\u5747\u8861\u5668",level:2}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"spring-cloud-loadbalancer",children:"Spring Cloud LoadBalancer"}),"\n",(0,r.jsx)(n.h2,{id:"\u6982\u8ff0",children:"\u6982\u8ff0"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"Spring Cloud LoadBalancer\u76ee\u524dSpring\u5b98\u65b9\u662f\u653e\u5728spring-cloud-commons\u91cc\uff0cSpring Cloud\u6700\u65b0\u7248\u672c\u4e3a2021.0.2"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://docs.spring.io/spring-cloud-commons/docs/3.1.2/reference/html/#spring-cloud-loadbalancer",children:"Spring Cloud LoadBalancer \u5b98\u7f51\u6587\u6863\u5730\u5740"})," ",(0,r.jsx)(n.a,{href:"https://docs.spring.io/spring-cloud-commons/docs/3.1.2/reference/html/#spring-cloud-loadbalancer",children:"https://docs.spring.io/spring-cloud-commons/docs/3.1.2/reference/html/#spring-cloud-loadbalancer"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://docs.spring.io/spring-cloud/docs/current/reference/html/",children:"Spring Cloud\u5b98\u7f51\u6587\u6863\u5730\u5740"})," ",(0,r.jsx)(n.a,{href:"https://docs.spring.io/spring-cloud/docs/current/reference/html/",children:"https://docs.spring.io/spring-cloud/docs/current/reference/html/"})]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"\u4e00\u65b9\u9762Netflix Ribbon\u505c\u6b62\u66f4\u65b0\uff0cSpring Cloud LoadBalancer\u662fSpring Cloud\u5b98\u65b9\u81ea\u5df1\u63d0\u4f9b\u7684\u5ba2\u6237\u7aef\u8d1f\u8f7d\u5747\u8861\u5668,\u62bd\u8c61\u548c\u5b9e\u73b0\uff0c\u7528\u6765\u66ff\u4ee3Ribbon\u3002"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u5e38\u89c1\u8d1f\u8f7d\u5747\u8861\u5668\u5206\u4e3a\u670d\u52a1\u7aef\u8d1f\u8f7d\u5747\u8861\u5668(\u5982\u7f51\u5173\u5c42\u5747\u8861\u8d1f\u8f7d)\u548c\u5ba2\u6237\u7aef\u5c42\u5747\u8861\u8d1f\u8f7d\u3002","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u7f51\u5173\u5c42\u5982\u786c\u4ef6\u5c42\u9762\u7684F5\u6216\u8f6f\u4ef6\u5c42\u9762\u7684LVS\u3001\u6216\u8005nginx\u7b49\u3002"}),"\n",(0,r.jsx)(n.li,{children:"\u5ba2\u6237\u7aef\u5c42\u5c31\u5982Spring Cloud LoadBalancer\uff0c\u4f5c\u4e3a\u4e00\u4e2a\u5ba2\u6237\u7aef\u53bb\u53d1\u73b0\u66f4\u65b0\u7ef4\u62a4\u670d\u52a1\u5217\u8868\uff0c\u81ea\u5b9a\u4e49\u670d\u52a1\u7684\u5747\u8861\u8d1f\u8f7d\u7b56\u7565\uff08\u968f\u673a\u3001\u8f6e\u8be2\u3001\u5c0f\u6d41\u91cf\u7684\u91d1\u4e1d\u96c0\u7b49\u7b49\uff09\u3002"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Spring Cloud\u63d0\u4f9b\u4e86\u81ea\u5df1\u7684\u5ba2\u6237\u7aef\u8d1f\u8f7d\u5e73\u8861\u5668\u62bd\u8c61\u548c\u5b9e\u73b0\u3002\u5bf9\u4e8e\u8d1f\u8f7d\u5747\u8861\u673a\u5236\uff0c\u589e\u52a0\u4e86ReactiveLoadBalancer\u63a5\u53e3\uff0c\u5e76\u63d0\u4f9b\u4e86\u57fa\u4e8eround-robin\u8f6e\u8be2\u548cRandom\u968f\u673a\u7684\u5b9e\u73b0\u3002\u4e3a\u4e86\u4ece\u54cd\u5e94\u5f0fServiceInstanceListSupplier\u4e2d\u9009\u62e9\u5b9e\u4f8b\uff0c\u9700\u8981\u4f7f\u7528ServiceInstanceListSupplier\u3002\u76ee\u524d\u652f\u6301ServiceInstanceListSupplier\u7684\u57fa\u4e8e\u670d\u52a1\u53d1\u73b0\u7684\u5b9e\u73b0\uff0c\u8be5\u5b9e\u73b0\u4f7f\u7528\u7c7b\u8def\u5f84\u4e2d\u7684\u53d1\u73b0\u5ba2\u6237\u7aef\u4eceService Discovery\u4e2d\u68c0\u7d22\u53ef\u7528\u7684\u5b9e\u4f8b\u3002"}),"\n",(0,r.jsx)(n.p,{children:"\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u914d\u7f6e\u6765\u7981\u7528Spring Cloud LoadBalance"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"spring:\n  cloud:\n    loadbalancer:\n      enabled: false\n\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u5165\u95e8\u793a\u4f8b",children:"\u5165\u95e8\u793a\u4f8b"}),"\n",(0,r.jsxs)(n.p,{children:["\u524d\u9762simple-ecommerce\u9879\u76ee\u521b\u5efa\u5df2\u5728\u7236Pom\u5f15\u5165\u4e09\u5927\u7236\u4f9d\u8d56\uff0c\u8be6\u7ec6\u53ef\u4ee5\u770b\u4e0b\u524d\u9762\u7684\u6587\u7ae0",(0,r.jsx)(n.code,{children:"<<SpringCloudAlibaba\u6ce8\u518c\u4e2d\u5fc3\u4e0e\u914d\u7f6e\u4e2d\u5fc3\u4e4b\u5229\u5668Nacos\u5b9e\u6218\u4e0e\u6e90\u7801\u5206\u6790>>"}),"\uff0c\u5176\u4e2dSpring Cloud\u7684\u7248\u672c\u4e3a2021.0.1\uff0c\u524d\u9762\u6587\u7ae0\u4e5f\u5df2\u8bf4\u8fc7\uff0cSpring Cloud Alibaba\u6574\u5408\u5728spring-cloud-starter-alibaba-nacos-discovery\u672c\u8eab\u5c31\u4f9d\u8d56spring-cloud-loadbalancer\u3002"]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u6ce8\u610f\u5982\u679c\u662fHoxton\u4e4b\u524d\u7684\u7248\u672c\uff0c\u9ed8\u8ba4\u8d1f\u8f7d\u5747\u8861\u5668\u4e3aRibbon\uff0c\u9700\u8981\u79fb\u9664Ribbon\u5f15\u7528\u548c\u589e\u52a0\u914d\u7f6espring.cloud.loadbalancer.ribbon.enabled: false\u3002"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"\u5982\u679c\u662f\u5728Spring Boot\u9879\u76ee\u4e2d\u6dfb\u52a0\u4e0b\u9762\u7684\u542f\u52a8\u5668\u4f9d\u8d56\uff0c\u8be5starter\u4e5f\u5305\u542b\u4e86Spring Boot Caching and Evictor."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"        <dependency>\n            <groupId>org.springframework.cloud</groupId>\n            spring-cloud-starter-loadbalancer\n        </dependency>\n\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u6211\u4eec\u4f7f\u7528Spring\u5b98\u65b9\u63d0\u4f9b\u4e86\u8d1f\u8f7d\u5747\u8861\u7684\u5ba2\u6237\u7aef\u4e4b\u4e00RestTemplate\uff0cRestTemplate\u662fSpring\u63d0\u4f9b\u7684\u7528\u4e8e\u8bbf\u95eeRest\u670d\u52a1\u7684\u5ba2\u6237\u7aef\uff0cRestTemplate\u63d0\u4f9b\u4e86\u591a\u79cd\u4fbf\u6377\u8bbf\u95ee\u8fdc\u7a0bHttp\u670d\u52a1\u7684\u65b9\u6cd5\uff0c\u80fd\u591f\u5927\u5927\u63d0\u9ad8\u5ba2\u6237\u7aef\u7684\u7f16\u5199\u6548\u7387\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cRestTemplate\u9ed8\u8ba4\u4f9d\u8d56jdk\u7684HTTP\u8fde\u63a5\u5de5\u5177\u3002\u521b\u5efaRestTemplateConfig\u914d\u7f6e\u7c7b\uff0c\u6807\u6ce8 @LoadBalanced\u6ce8\u89e3\uff0c\u9ed8\u8ba4\u4f7f\u7528\u7684ReactiveLoadBalancer\u5b9e\u73b0\u662fRoundRobinLoadBalancer\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"package cn.itxs.ecom.order.config;\n\nimport org.springframework.cloud.client.loadbalancer.LoadBalanced;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.web.client.RestTemplate;\n\n@Configuration\npublic class RestTemplateConfig {\n    @LoadBalanced\n    @Bean\n    public RestTemplate restTemplate() {\n        return new RestTemplate() ;\n    }\n}\n\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u8ba2\u5355\u5fae\u670d\u52a1\u4e2d\u8ba2\u5355\u63a7\u5236\u5668\u589e\u52a0deductRest\u65b9\u6cd5"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'package cn.itxs.ecom.order.controller;\n\nimport cn.itxs.ecom.commons.service.OrderService;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RestController;\nimport org.springframework.web.client.RestTemplate;\n\n/**\n * @Name \uff1aOrderController\n * @Description \uff1a\u8ba2\u5355\u63a7\u5236\u5668\n * @Author \uff1aitxs\n * @Date \uff1a2022/4/10 20:15\n * @Version \uff1a1.0\n * @History \uff1a\n */\n@RestController\npublic class OrderController {\n\n    @Autowired\n    OrderService orderService;\n\n    @Autowired\n    private RestTemplate restTemplate;\n\n    @RequestMapping("/create/{userId}/{commodityCode}/{count}")\n    public String create(@PathVariable("userId") String userId,@PathVariable("commodityCode") String commodityCode, @PathVariable("count") int count){\n        return orderService.create(userId,commodityCode,count).toString();\n    }\n\n    @RequestMapping("/deductRest/{commodityCode}/{count}")\n    public String deductRest(@PathVariable("commodityCode") String commodityCode, @PathVariable("count") int count){\n        String url = "http://ecom-storage-service/deduct/"+commodityCode+"/"+count;\n        return restTemplate.getForObject(url, String.class);\n    }\n}\n\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u524d\u9762server.port\u6211\u4eec\u662f\u653e\u5728Nacos\u914d\u7f6e\u4e2d\u5fc3\u91cc\uff0c\u8fd9\u91cc\u6211\u4eec\u6ce8\u91caNacos\u914d\u7f6e\u4e2d\u5fc3\u7684\u914d\u7f6e\u653e\u5728\u672c\u5730\u914d\u7f6e\u6587\u4ef6bootstrap.yml\u91cc\uff0c\u5206\u522b\u914d\u7f6e\u4e3a4080\u30014081\u30014082\u542f\u52a83\u4e2a\u5e93\u5b58\u670d\u52a1\u5b9e\u4f8b\uff0c\u5e76\u542f\u52a8\u8ba2\u5355\u5fae\u670d\u52a1"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"server:\n  port: 4080\n\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/938570a0b63b56671a862e8bda11577a.png",alt:"image-20220505191143684"})}),"\n",(0,r.jsx)(n.p,{children:"\u67e5\u770bnacos\u670d\u52a1\u7ba1\u7406-\u670d\u52a1\u5217\u8868\u91cc\u670d\u52a1\u8be6\u60c5\uff0c\u53ef\u4ee5\u770b\u52303\u4e2a\u5065\u5eb7\u7684\u5e93\u5b58\u5b9e\u4f8b\u548c1\u4e2a\u8ba2\u5355\u5fae\u670d\u52a1\u5b9e\u4f8b"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/33fa03d937354fe00bb0bb2f3dd5c805.png",alt:"image-20220505182432182"})}),"\n",(0,r.jsxs)(n.p,{children:["\u8bbf\u95ee6\u6b21\u8ba2\u5355dedect\u63a5\u53e3\uff1a",(0,r.jsx)(n.a,{href:"http://localhost:4070/deductRest/1001/1",children:"http://localhost:4070/deductRest/1001/1"})," \uff0c\u4ece\u6d4b\u8bd5\u7684\u7ed3\u679c\u4e5f\u9a8c\u8bc1\u4e86LoadBalancer\u9ed8\u8ba4\u662f\u8f6e\u8be2\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u3002"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/1fc20b1d482d2a4e3924c5707ac2ff19.png",alt:"image-20220505192217715"})}),"\n",(0,r.jsx)(n.h2,{id:"\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u5207\u6362",children:"\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u5207\u6362"}),"\n",(0,r.jsx)(n.p,{children:"\u521b\u5efa\u81ea\u5b9a\u4e49\u8d1f\u8f7d\u5747\u8861\u914d\u7f6e\u7c7bCustomLoadBalancerConfiguration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"package cn.itxs.ecom.order.config;\n\nimport org.springframework.cloud.client.ServiceInstance;\nimport org.springframework.cloud.loadbalancer.core.RandomLoadBalancer;\nimport org.springframework.cloud.loadbalancer.core.ReactorLoadBalancer;\nimport org.springframework.cloud.loadbalancer.core.ServiceInstanceListSupplier;\nimport org.springframework.cloud.loadbalancer.support.LoadBalancerClientFactory;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.core.env.Environment;\n\npublic class CustomLoadBalancerConfiguration {\n\n    @Bean\n    ReactorLoadBalancer<ServiceInstance> randomLoadBalancer(Environment environment,\n                                                            LoadBalancerClientFactory loadBalancerClientFactory) {\n        String name = environment.getProperty(LoadBalancerClientFactory.PROPERTY_NAME);\n        return new RandomLoadBalancer(loadBalancerClientFactory\n                .getLazyProvider(name, ServiceInstanceListSupplier.class),\n                name);\n    }\n}\n\n"})}),"\n",(0,r.jsx)(n.p,{children:"RestTemplateConfig\u914d\u7f6e\u7c7bLoadBalancerClient\u6307\u5b9a\u968f\u673a\u7684\u914d\u7f6e\u7c7b\uff0cvalue\u7684\u503c\u4e3a\u63d0\u4f9b\u8005\u4e5f\u5373\u662f\u5e93\u5b58\u5fae\u670d\u52a1\u540d\u79f0\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'package cn.itxs.ecom.order.config;\n\nimport org.springframework.boot.web.client.RestTemplateBuilder;\nimport org.springframework.cloud.client.loadbalancer.LoadBalanced;\nimport org.springframework.cloud.loadbalancer.annotation.LoadBalancerClient;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.web.client.RestTemplate;\n\n@Configuration\n@LoadBalancerClient(value = "ecom-storage-service", configuration = CustomLoadBalancerConfiguration.class)\npublic class RestTemplateConfig {\n\n    @LoadBalanced\n    @Bean\n    public RestTemplate restTemplate(RestTemplateBuilder builder) {\n        return builder.build() ;\n    }\n}\n\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u591a\u6b21\u8bbf\u95ee\u8ba2\u5355dedect\u63a5\u53e3\u6d4b\u8bd5\u786e\u8ba4\u5df2\u5207\u6362\u4e3a\u968f\u673a\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u3002"}),"\n",(0,r.jsx)(n.h2,{id:"\u96c6\u6210\u65b9\u5f0f",children:"\u96c6\u6210\u65b9\u5f0f"}),"\n",(0,r.jsx)(n.p,{children:"\u5b98\u7f51\u63d0\u4f9b3\u4e2d\u96c6\u6210Spring Cloud LoadBalancer\u7684\u65b9\u5f0f\uff0c\u9664\u4e86\u7b2c\u4e00\u79cd\u4e0a\u9762\u5df2\u4f7f\u7528\u8fc7\uff0c\u8fd8\u652f\u6301Spring Web Flux\u54cd\u5e94\u5f0f\u7f16\u7a0b\uff0cWebClient\u662f\u4eceSpring WebFlux 5.0\u7248\u672c\u5f00\u59cb\u63d0\u4f9b\u7684\u4e00\u4e2a\u975e\u963b\u585e\u7684\u57fa\u4e8e\u54cd\u5e94\u5f0f\u7f16\u7a0b\u7684\u8fdb\u884cHttp\u8bf7\u6c42\u7684\u5ba2\u6237\u7aef\u5de5\u5177\u3002\u5b83\u7684\u54cd\u5e94\u5f0f\u7f16\u7a0b\u7684\u57fa\u4e8eReactor\u7684\u3002WebClient\u4e2d\u63d0\u4f9b\u4e86\u6807\u51c6Http\u8bf7\u6c42\u65b9\u5f0f\u5bf9\u5e94\u7684get\u3001post\u3001put\u3001delete\u7b49\u65b9\u6cd5\uff0c\u53ef\u4ee5\u7528\u6765\u53d1\u8d77\u76f8\u5e94\u7684\u8bf7\u6c42\u3002"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/ad44f363342f540b1cb1805b20be6ef0.png",alt:"image-20220506233248585"})}),"\n",(0,r.jsx)(n.p,{children:"\u5728\u8ba2\u5355\u5fae\u670d\u52a1\u4e2d\u5f15\u5165spring-boot-starter-webflux\u4f9d\u8d56"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            spring-boot-starter-webflux\n        </dependency>\n\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u8ba2\u5355\u5fae\u670d\u52a1\u4e2d\u589e\u52a0WebClientConfig\u914d\u7f6e\u7c7b"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"package cn.itxs.ecom.order.config;\n\nimport org.springframework.cloud.client.loadbalancer.LoadBalanced;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.web.reactive.function.client.WebClient;\n\n@Configuration\npublic class WebClientConfig {\n    @LoadBalanced\n    @Bean\n    WebClient.Builder webClientBuilder() {\n        return WebClient.builder();\n    }\n\n    @Bean\n    WebClient webClient() {\n        return webClientBuilder().build();\n    }\n}\n\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u8ba2\u5355\u5fae\u670d\u52a1\u8ba2\u5355\u63a7\u5236\u5668\u4e2d\u6dfb\u52a0WebClient\u63a5\u53e3\u5b9e\u73b0\uff0c\u4ee3\u7801\u5982\u4e0b"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'    @Autowired\n    private WebClient webClient;   \n\n\t@RequestMapping(value = "/deductWebClient/{commodityCode}/{count}")\n    public Mono<String> deductWebClient(@PathVariable("commodityCode") String commodityCode, @PathVariable("count") int count) {\n        String url = "http://ecom-storage-service/deduct/"+commodityCode+"/"+count;\n        // \u57fa\u4e8eWebClient\n        Mono<String> result = webClient.get().uri(url)\n                .retrieve().bodyToMono(String.class);\n        return result;\n    }\n\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u91cd\u65b0\u542f\u52a8\u8ba2\u5355\u5fae\u670d\u52a1"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/ec48e022accfb3298069c96b7e3799e7.png",alt:"image-20220506234934948"})}),"\n",(0,r.jsxs)(n.p,{children:["\u8bbf\u95ee\u8ba2\u5355\u63a7\u5236\u5668\u4e2d\u7684\u51cf\u5e93\u5b58WebClient\u63a5\u53e3\uff0c",(0,r.jsx)(n.a,{href:"http://localhost:4070/deductWebClient/1001/1",children:"http://localhost:4070/deductWebClient/1001/1"})," \uff0c\u7ed3\u679c\u8fd4\u56de\u6210\u529f"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/5f737fc9d8806dc072ce3e1fdf983de6.png",alt:"image-20220506234627330"})}),"\n",(0,r.jsx)(n.p,{children:"\u6211\u4eec\u8fd8\u53ef\u4ee5\u914d\u7f6e\u57fa\u4e8e\u8fc7\u6ee4\u5668\u7684\u65b9\u5f0f\uff0c\u901a\u8fc7WebClient\u4f7f\u7528ReactiveLoadBalancer\u3002\u5982\u679c\u9879\u76ee\u4e2d\u6dfb\u52a0\u4e86Spring Cloud LoadBalancer starter\uff0c\u5e76\u4e14Spring -webflux\u5728\u7c7b\u8def\u5f84\u4e2d\uff0cReactorLoadBalancerExchangeFilterFunction\u5219\u662f\u81ea\u52a8\u914d\u7f6e\u7684\u3002"}),"\n",(0,r.jsx)(n.p,{children:"\u8ba2\u5355\u5fae\u670d\u52a1\u8ba2\u5355\u63a7\u5236\u5668\u4e2d\u6dfb\u52a0WebClient\u4f7f\u7528ReactiveLoadBalancer\u63a5\u53e3\u5b9e\u73b0\uff0c\u4ee3\u7801\u5982\u4e0b"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'    @Autowired\n    private ReactorLoadBalancerExchangeFilterFunction lbFunction;   \n\n    @RequestMapping(value = "/deductWebFluxReactor/{commodityCode}/{count}")\n    public Mono<String> deductWebFluxReactor(@PathVariable("commodityCode") String commodityCode, @PathVariable("count") int count) {\n        String url = "/deduct/"+commodityCode+"/"+count;\n        Mono<String> result = WebClient.builder().baseUrl("http://ecom-storage-service")\n                .filter(lbFunction)\n                .build()\n                .get()\n                .uri(url)\n                .retrieve()\n                .bodyToMono(String.class);\n        return result;\n    }\n\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u91cd\u65b0\u542f\u52a8\u8ba2\u5355\u5fae\u670d\u52a1"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/3546b9913f1253a1b23039ad6f7546d1.png",alt:"image-20220507000930179"})}),"\n",(0,r.jsxs)(n.p,{children:["\u8bbf\u95ee\u8ba2\u5355\u63a7\u5236\u5668\u4e2d\u7684\u51cf\u5e93\u5b58WebClient\u63a5\u53e3\uff0c",(0,r.jsx)(n.a,{href:"http://localhost:4070/deductWebFluxReactor/1001/1",children:"http://localhost:4070/deductWebFluxReactor/1001/1"})," \uff0c\u7ed3\u679c\u8fd4\u56de\u6210\u529f"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/0bc2b04d23d11bc85009c7e040900b2b.png",alt:"image-20220507000746900"})}),"\n",(0,r.jsx)(n.p,{children:"\u5173\u4e8eLoadBalancer\u5b98\u7f51\u8fd8\u63d0\u4f9b\u5f88\u591a\u5176\u4ed6\u529f\u80fd\uff0c\u6709\u5174\u8da3\u53ef\u81ea\u884c\u8be6\u7ec6\u67e5\u9605\u548c\u52a8\u624b\u5b9e\u9a8c"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/1d8f35933945b317a2dd71627fdfa748.png",alt:"image-20220507001132987"})}),"\n",(0,r.jsx)(n.h2,{id:"\u539f\u7406",children:"\u539f\u7406"}),"\n",(0,r.jsx)(n.h3,{id:"resttemplate",children:"RestTemplate"}),"\n",(0,r.jsx)(n.p,{children:"Spring Cloud LoadBalancer\u6e90\u7801\u5206\u6790\u6211\u4eec\u5148\u4eceRestTemplate\u8d1f\u8f7d\u5747\u8861\u7684\u7b80\u5355\u5b9e\u73b0\u6765\u5206\u6790\u5165\u624b\uff0c\u9664\u6b64\u4e4b\u5916\u5176\u652f\u6301Spring Web Flux\u54cd\u5e94\u5f0f\u7f16\u7a0b\u7684\u5b9e\u73b0\u539f\u7406\u601d\u60f3\u4e5f\u662f\u76f8\u540c\uff0c\u90fd\u662f\u901a\u8fc7\u5ba2\u6237\u7aef\u6dfb\u52a0\u62e6\u622a\u5668\uff0c\u5728\u62e6\u622a\u5668\u4e2d\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\u3002\u4eceRestTemplate\u7684\u6e90\u7801\u4e2d\u53ef\u4ee5\u77e5\u9053\u5176\u7ee7\u627f\u81eaInterceptingHttpAccessor\u62bd\u8c61\u7c7b"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/c3ee7af69f54aeed5f1026823779fee8.png",alt:"image-20220508142236428"})}),"\n",(0,r.jsx)(n.p,{children:"\u800cInterceptingHttpAccessor\u62bd\u8c61\u7c7b\u5219\u63d0\u4f9b\u4e86\u4e00\u4e2a\u65b9\u6cd5setInterceptors\uff0c\u7528\u4e8e\u8bbe\u7f6e\u62e6\u622a\u5668\uff0c\u62e6\u622a\u5668\u9700\u8981\u5b9e\u73b0ClientHttpRequestInterceptor\u63a5\u53e3\u5373\u53ef\uff0c\u5728\u5b9e\u9645\u8fdc\u7a0b\u8bf7\u6c42\u670d\u52a1\u7aef\u63a5\u53e3\u4e4b\u524d\u4f1a\u5148\u8c03\u7528\u62e6\u622a\u5668\u7684intercept\u65b9\u6cd5\u3002\u8fd9\u91cc\u7684\u62e6\u622a\u5668\u76f8\u5f53\u4e8eServlet\u6280\u672f\u4e2d\u7684Filter\u529f\u80fd"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"\t// \u4ee3\u7801\u5b9e\u73b0\u5728\u62bd\u8c61\u7236\u7c7bInterceptingHttpAccessor\u91cc\n\t// RestTemplate.InterceptingHttpAccessor#setInterceptors\n\tpublic void setInterceptors(List<ClientHttpRequestInterceptor> interceptors) {\n\t\tAssert.noNullElements(interceptors, \"'interceptors' must not contain null elements\");\n\t\t// Take getInterceptors() List as-is when passed in here\n\t\tif (this.interceptors != interceptors) {\n\t\t\tthis.interceptors.clear();\n\t\t\tthis.interceptors.addAll(interceptors);\n\t\t\tAnnotationAwareOrderComparator.sort(this.interceptors);\n\t\t}\n\t}\n\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/5062f793bb2bd7f996eb944f77af7137.png",alt:"image-20220508142443637"})}),"\n",(0,r.jsx)(n.h3,{id:"loadbalancerautoconfiguration",children:(0,r.jsx)(n.strong,{children:"LoadBalancerAutoConfiguration"})}),"\n",(0,r.jsx)(n.p,{children:"\u4ece\u5b98\u7f51\u53ef\u4ee5\u77e5\u9053Spring Cloud LoadBalancer\u653e\u5728spring-cloud-commons\uff0c\u56e0\u6b64\u4e5f\u4f5c\u4e3a\u5176\u6838\u5fc3\u7684@LoadBalanced\u6ce8\u89e3\u4e5f\u5c31\u662f\u7531spring-cloud-commons\u6765\u5b9e\u73b0\uff0c\u4f9d\u636eSpringBoot\u81ea\u52a8\u88c5\u914d\u7684\u539f\u7406\u5148\u67e5\u770b\u4f9d\u8d56\u5305\u7684\u5b9e\u73b0\u903b\u8f91\uff0c\u4e0d\u96be\u53d1\u73b0spring-cloud-commons\u5f15\u5165\u4e86\u81ea\u52a8\u914d\u7f6e\u7c7bLoadBalancerAutoConfiguration\u548cReactorLoadBalancerClientAutoConfiguration\u3002"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/b5be12e0dd8d515aa07613738efab122.png",alt:"image-20220509001530634"})}),"\n",(0,r.jsx)(n.p,{children:"\u5f53\u6ee1\u8db3\u4e0a\u8ff0\u7684\u6761\u4ef6\u65f6\uff08@Conditional\u4e3a\u6761\u4ef6\u6ce8\u89e3\uff09\uff0c\u5c06\u81ea\u52a8\u521b\u5efaLoadBalancerInterceptor\u5e76\u6ce8\u5165\u5230RestTemplate\u4e2d\u3002"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/676f6d81529228511c862c780b0c4532.png",alt:"image-20220508143752218"})}),"\n",(0,r.jsx)(n.h3,{id:"loadbalancerlnterceptor",children:(0,r.jsx)(n.strong,{children:"LoadBalancerLnterceptor"})}),"\n",(0,r.jsx)(n.p,{children:"LoadBalancerInterceptor\u5b9e\u73b0\u4e86ClientHttpRequestInterceptor\u63a5\u53e3\uff0c\u56e0\u6b64\u4e5f\u5b9e\u73b0intercept\u65b9\u6cd5\uff0c\u7528\u4e8e\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\u7684\u62e6\u622a\u5904\u7406\u3002"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/bb587d8122fee4973eba2fc00ed1af3f.png",alt:"image-20220508144048248"})}),"\n",(0,r.jsx)(n.h3,{id:"loadbalancerclient",children:(0,r.jsx)(n.strong,{children:"LoadBalancerClient"})}),"\n",(0,r.jsx)(n.p,{children:"LoadBalancerClient\u7528\u4e8e\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\u903b\u8f91\uff0c\u7ee7\u627f\u81eaServiceInstanceChooser\u63a5\u53e3\uff0c\u4ece\u670d\u52a1\u5217\u8868\u4e2d\u9009\u62e9\u51fa\u4e00\u4e2a\u670d\u52a1\u5730\u5740\u8fdb\u884c\u8c03\u7528\u3002\u5728LoadBalancerClient\u79cd\u5b58\u5728\u4e24\u4e2aexecute()\u65b9\u6cd5\uff0c\u5747\u662f\u7528\u6765\u6267\u884c\u8bf7\u6c42\u7684\uff0creconstructURI()\u662f\u7528\u6765\u91cd\u6784URL\u3002"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/a3590c0ab24cb5ee04cf1cf513724fc0.png",alt:"image-20220508144435104"})}),"\n",(0,r.jsx)(n.p,{children:"\u5bf9\u4e8eLoadBalancerClient\u63a5\u53e3Spring Cloud LoadBalancer\u7684\u63d0\u4f9b\u9ed8\u8ba4\u5b9e\u73b0\u4e3aBlockingLoadBalancerClient"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/256e4815a982966d7d6bfb82e0e97f67.png",alt:"image-20220508144750601"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'@SuppressWarnings({ "unchecked", "rawtypes" })\npublic class BlockingLoadBalancerClient implements LoadBalancerClient {\n\n\tprivate final ReactiveLoadBalancer.Factory<ServiceInstance> loadBalancerClientFactory;\n\n\t/**\n\t * @deprecated in favour of\n\t * {@link BlockingLoadBalancerClient#BlockingLoadBalancerClient(ReactiveLoadBalancer.Factory)}\n\t */\n\t@Deprecated\n\tpublic BlockingLoadBalancerClient(LoadBalancerClientFactory loadBalancerClientFactory,\n\t\t\tLoadBalancerProperties properties) {\n\t\tthis.loadBalancerClientFactory = loadBalancerClientFactory;\n\t}\n\n\tpublic BlockingLoadBalancerClient(ReactiveLoadBalancer.Factory<ServiceInstance> loadBalancerClientFactory) {\n\t\tthis.loadBalancerClientFactory = loadBalancerClientFactory;\n\t}\n\n\t@Override\n\tpublic <T> T execute(String serviceId, LoadBalancerRequest<T> request) throws IOException {\n\t\tString hint = getHint(serviceId);\n\t\tLoadBalancerRequestAdapter<T, DefaultRequestContext> lbRequest = new LoadBalancerRequestAdapter<>(request,\n\t\t\t\tnew DefaultRequestContext(request, hint));\n\t\tSet<LoadBalancerLifecycle> supportedLifecycleProcessors = getSupportedLifecycleProcessors(serviceId);\n\t\tsupportedLifecycleProcessors.forEach(lifecycle -> lifecycle.onStart(lbRequest));\n\t\tServiceInstance serviceInstance = choose(serviceId, lbRequest);\n        // \u9009\u62e9\u670d\u52a1\n\t\tif (serviceInstance == null) {\n\t\t\tsupportedLifecycleProcessors.forEach(lifecycle -> lifecycle.onComplete(\n\t\t\t\t\tnew CompletionContext<>(CompletionContext.Status.DISCARD, lbRequest, new EmptyResponse())));\n\t\t\tthrow new IllegalStateException("No instances available for " + serviceId);\n\t\t}\n\t\treturn execute(serviceId, serviceInstance, lbRequest);\n\t}\n\n\t@Override\n\tpublic <T> T execute(String serviceId, ServiceInstance serviceInstance, LoadBalancerRequest<T> request)\n\t\t\tthrows IOException {\n\t\tDefaultResponse defaultResponse = new DefaultResponse(serviceInstance);\n\t\tSet<LoadBalancerLifecycle> supportedLifecycleProcessors = getSupportedLifecycleProcessors(serviceId);\n\t\tRequest lbRequest = request instanceof Request ? (Request) request : new DefaultRequest<>();\n\t\tsupportedLifecycleProcessors\n\t\t\t\t.forEach(lifecycle -> lifecycle.onStartRequest(lbRequest, new DefaultResponse(serviceInstance)));\n\t\ttry {\n\t\t\tT response = request.apply(serviceInstance);\n\t\t\tObject clientResponse = getClientResponse(response);\n\t\t\tsupportedLifecycleProcessors\n\t\t\t\t\t.forEach(lifecycle -> lifecycle.onComplete(new CompletionContext<>(CompletionContext.Status.SUCCESS,\n\t\t\t\t\t\t\tlbRequest, defaultResponse, clientResponse)));\n\t\t\treturn response;\n\t\t}\n\t\tcatch (IOException iOException) {\n\t\t\tsupportedLifecycleProcessors.forEach(lifecycle -> lifecycle.onComplete(\n\t\t\t\t\tnew CompletionContext<>(CompletionContext.Status.FAILED, iOException, lbRequest, defaultResponse)));\n\t\t\tthrow iOException;\n\t\t}\n\t\tcatch (Exception exception) {\n\t\t\tsupportedLifecycleProcessors.forEach(lifecycle -> lifecycle.onComplete(\n\t\t\t\t\tnew CompletionContext<>(CompletionContext.Status.FAILED, exception, lbRequest, defaultResponse)));\n\t\t\tReflectionUtils.rethrowRuntimeException(exception);\n\t\t}\n\t\treturn null;\n\t}\n\n\tprivate <T> Object getClientResponse(T response) {\n\t\tClientHttpResponse clientHttpResponse = null;\n\t\tif (response instanceof ClientHttpResponse) {\n\t\t\tclientHttpResponse = (ClientHttpResponse) response;\n\t\t}\n\t\tif (clientHttpResponse != null) {\n\t\t\ttry {\n\t\t\t\treturn new ResponseData(clientHttpResponse, null);\n\t\t\t}\n\t\t\tcatch (IOException ignored) {\n\t\t\t}\n\t\t}\n\t\treturn response;\n\t}\n\n\tprivate Set<LoadBalancerLifecycle> getSupportedLifecycleProcessors(String serviceId) {\n\t\treturn LoadBalancerLifecycleValidator.getSupportedLifecycleProcessors(\n\t\t\t\tloadBalancerClientFactory.getInstances(serviceId, LoadBalancerLifecycle.class),\n\t\t\t\tDefaultRequestContext.class, Object.class, ServiceInstance.class);\n\t}\n\n\t@Override\n\tpublic URI reconstructURI(ServiceInstance serviceInstance, URI original) {\n\t\treturn LoadBalancerUriTools.reconstructURI(serviceInstance, original);\n\t}\n\n\t@Override\n\tpublic ServiceInstance choose(String serviceId) {\n\t\treturn choose(serviceId, REQUEST);\n\t}\n\n    // \u901a\u8fc7\u4e0d\u540c\u7684\u8d1f\u8f7d\u5747\u8861\u5ba2\u6237\u7aef\u5b9e\u73b0\u9009\u62e9\u4e0d\u540c\u7684\u670d\u52a1\n\t@Override\n\tpublic <T> ServiceInstance choose(String serviceId, Request<T> request) {\n\t\tReactiveLoadBalancer<ServiceInstance> loadBalancer = loadBalancerClientFactory.getInstance(serviceId);\n\t\tif (loadBalancer == null) {\n\t\t\treturn null;\n\t\t}\n\t\tResponse<ServiceInstance> loadBalancerResponse = Mono.from(loadBalancer.choose(request)).block();\n\t\tif (loadBalancerResponse == null) {\n\t\t\treturn null;\n\t\t}\n\t\treturn loadBalancerResponse.getServer();\n\t}\n\n\tprivate String getHint(String serviceId) {\n\t\tLoadBalancerProperties properties = loadBalancerClientFactory.getProperties(serviceId);\n\t\tString defaultHint = properties.getHint().getOrDefault("default", "default");\n\t\tString hintPropertyValue = properties.getHint().get(serviceId);\n\t\treturn hintPropertyValue != null ? hintPropertyValue : defaultHint;\n\t}\n\n}\n\n'})}),"\n",(0,r.jsx)(n.h3,{id:"loadbalancerclientfactory",children:(0,r.jsx)(n.strong,{children:"LoadBalancerClientFactory"})}),"\n",(0,r.jsxs)(n.p,{children:["BlockingLoadBalancerClient\u4e2d\u6301\u6709LoadBalancerClientFactory\u901a\u8fc7\u8c03\u7528\u5176getInstance\u65b9\u6cd5\u83b7\u53d6\u5177\u4f53\u7684\u8d1f\u8f7d\u5747\u8861\u5ba2\u6237\u7aef\u3002\u901a\u8fc7\u5de5\u5382\u7c7bLoadBalancerClientFactory\u83b7\u53d6\u5177\u4f53\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u5b9e\u4f8b\uff0c\u540e\u9762\u7684loadBalancer.choose(request)\u8c03\u7528\u5176\u63a5\u53e3choose()\u65b9\u6cd5\u5b9e\u73b0\u6839\u636e\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u9009\u62e9\u4e0b\u4e00\u4e2a\u670d\u52a1\u5668\u5b8c\u6210\u8d1f\u8f7d\u5747\u8861\uff0c\u800cReactiveLoadBalancer",(0,r.jsxs)("t",{children:[" getInstance(String serviceId) \u6709\u9ed8\u8ba4\u5b9e\u73b0LoadBalancerClientFactory\n",(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/4014445b0c2ea7189a232b5d257fb938.png",alt:"image-20220508190132565"})]})]}),"\n",(0,r.jsx)(n.p,{children:"LoadBalancerClientFactory\u5ba2\u6237\u7aef\u5b9e\u73b0\u4e86\u4e0d\u540c\u7684\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\uff0c\u6bd4\u5982\u8f6e\u8be2\u3001\u968f\u673a\u7b49\u3002LoadBalancerClientFactory\u7ee7\u627f\u81eaNamedContextFactory\uff0cNamedContextFactory\u7ee7\u627fApplicationContextAware\uff0c\u5b9e\u73b0Spring ApplicationContext\u5bb9\u5668\u64cd\u4f5c\u3002"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/18f62338fdb636327fcdb2d08d33661b.png",alt:"image-20220508190412076"})}),"\n",(0,r.jsx)(n.h3,{id:"reactiveloadbalancer",children:"ReactiveLoadBalancer"}),"\n",(0,r.jsx)(n.p,{children:"ReactiveLoadBalancer\u8d1f\u8f7d\u5747\u8861\u5668\u5b9e\u73b0\u670d\u52a1\u9009\u62e9\uff0cSpring Cloud Balancer\u4e2d\u5b9e\u73b0\u4e86\u8f6e\u8be2RoundRobinLoadBalancer\u3001\u968f\u673aRandomLoadBalancer\u3001NacosLoadBalancer\u7b97\u6cd5\u3002"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/f19b9fd0d246dbae37b05e67b1a79805.png",alt:"image-20220508235128931"})}),"\n",(0,r.jsx)(n.h3,{id:"loadbalancerclientconfiguration",children:"LoadBalancerClientConfiguration"}),"\n",(0,r.jsx)(n.p,{children:"\u5982\u679c\u6ca1\u6709\u663e\u5f0f\u6307\u5b9a\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\uff0c\u9ed8\u8ba4\u7f3a\u7701\u503c\u4e3aRoundRobinLoadBalancer"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"\t@Bean\n\t@ConditionalOnMissingBean\n\tpublic ReactorLoadBalancer<ServiceInstance> reactorServiceInstanceLoadBalancer(Environment environment,\n\t\t\tLoadBalancerClientFactory loadBalancerClientFactory) {\n\t\tString name = environment.getProperty(LoadBalancerClientFactory.PROPERTY_NAME);\n\t\treturn new RoundRobinLoadBalancer(\n\t\t\t\tloadBalancerClientFactory.getLazyProvider(name, ServiceInstanceListSupplier.class), name);\n\t}\n\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/c8ae46d4cedb33f40939edb4f6fde542.png",alt:"image-20220508235645313"})}),"\n",(0,r.jsx)(n.h3,{id:"loadbalancerrequestfactory",children:(0,r.jsx)(n.strong,{children:"LoadBalancerRequestFactory"})}),"\n",(0,r.jsx)(n.p,{children:"LoadBalancerRequest\u5de5\u5382\u7c7b\u8c03\u7528createRequest\u65b9\u6cd5\u7528\u4e8e\u521b\u5efaLoadBalancerRequest\u3002\u5176\u5185\u90e8\u6301\u6709LoadBalancerClient\u5bf9\u8c61\u4e5f\u5373\u6301\u6709BlockingLoadBalancerClient\u3002"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/c928dcb312df87a44c33ee77a296ee84.png",alt:"image-20220509000049541"})}),"\n",(0,r.jsx)(n.p,{children:"\u5728\u65e5\u5e38\u9879\u76ee\u4e2d\uff0c\u4e00\u822c\u8d1f\u8f7d\u5747\u8861\u90fd\u662f\u7ed3\u5408Feign\u4f7f\u7528\uff0c\u540e\u7eed\u6211\u4eec\u6709\u65f6\u95f4\u518d\u6765\u5206\u6790Feign\u6574\u5408LoadBalancer\u7684\u81ea\u52a8\u914d\u7f6e\u7c7bFeignLoadBalancerAutoConfiguration\u7684\u5b9e\u73b0"}),"\n",(0,r.jsx)(n.h3,{id:"reactorloadbalancerclientautoconfiguration",children:"ReactorLoadBalancerClientAutoConfiguration"}),"\n",(0,r.jsx)(n.p,{children:"\u6211\u4eec\u4e5f\u629b\u4e00\u4e0b\u57fa\u4e8eWebClient\u7684@Loadbalanced\u7684\u6d41\u7a0b\u7684\u5f15\u5165\uff0c\u9996\u5148\u58f0\u660e\u8d1f\u8f7d\u5747\u8861\u8fc7\u6ee4\u5668ReactorLoadBalancerClientAutoConfiguration\u662f\u4e00\u4e2a\u81ea\u52a8\u88c5\u914d\u5668\u7c7b\uff0c\u5728\u9879\u76ee\u4e2d\u5f15\u5165\u4e86 WebClient \u548c ReactiveLoadBalancer \u7c7b\u4e4b\u540e\uff0c\u81ea\u52a8\u88c5\u914d\u6d41\u7a0b\u5c31\u5f00\u59cb\u8fd0\u884c\uff0c\u5b83\u4f1a\u521d\u59cb\u5316\u4e00\u4e2a\u5b9e\u73b0\u4e86 ExchangeFilterFunction \u7684\u5b9e\u4f8b\uff0c\u5728\u540e\u9762\u8be5\u5b9e\u4f8b\u5c06\u4f5c\u4e3a\u8fc7\u6ee4\u5668\u88ab\u6ce8\u5165\u5230WebClient\u3002\u540e\u7eed\u6d41\u7a0b\u6709\u5174\u8da3\u518d\u81ea\u884c\u7814\u7a76"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/869a4ea9a6e1409b84c927db08cebea1.png",alt:"image-20220509001650781"})}),"\n",(0,r.jsx)(n.h2,{id:"\u81ea\u5b9a\u4e49\u8d1f\u8f7d\u5747\u8861\u5668",children:"\u81ea\u5b9a\u4e49\u8d1f\u8f7d\u5747\u8861\u5668"}),"\n",(0,r.jsx)(n.p,{children:"\u4ece\u4e0a\u9762\u53ef\u4ee5\u77e5\u9053LoadBalancerClientFactory\u662f\u521b\u5efa\u5ba2\u6237\u673a\u3001\u8d1f\u8f7d\u5747\u8861\u5668\u548c\u5ba2\u6237\u673a\u914d\u7f6e\u5b9e\u4f8b\u7684\u5de5\u5382\u3002\u5b83\u6839\u636e\u5ba2\u6237\u7aef\u540d\u79f0\u521b\u5efa\u4e00\u4e2aSpring ApplicationContext\uff0c\u5e76\u4ece\u4e2d\u63d0\u53d6\u6240\u9700\u7684bean\u3002\u56e0\u6b64\u8fdb\u5165\u5230LoadBalancerClientFactory\u7c7b\u4e2d\uff0c\u9700\u8981\u53bb\u5b9e\u73b0\u5b83\u7684\u5b50\u63a5\u53e3ReactorServiceInstanceLoadBalancer\uff0c\u56e0\u4e3a\u53bb\u83b7\u53d6\u8d1f\u8f7d\u5747\u8861\u5668\u5b9e\u4f8b\u7684\u65f6\u5019\uff0c\u662f\u901a\u8fc7\u53bb\u5bb9\u5668\u4e2d\u67e5\u627eReactorServiceInstanceLoadBalancer\u7c7b\u578b\u7684bean\u6765\u5b9e\u73b0\u7684\uff0c\u53ef\u4ee5\u53c2\u7167RandomLoadBalancer\u5b9e\u73b0\u4ee3\u7801"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'package org.springframework.cloud.loadbalancer.core;\n\nimport java.util.List;\nimport java.util.concurrent.ThreadLocalRandom;\n\nimport org.apache.commons.logging.Log;\nimport org.apache.commons.logging.LogFactory;\nimport reactor.core.publisher.Mono;\n\nimport org.springframework.beans.factory.ObjectProvider;\nimport org.springframework.cloud.client.ServiceInstance;\nimport org.springframework.cloud.client.loadbalancer.DefaultResponse;\nimport org.springframework.cloud.client.loadbalancer.EmptyResponse;\nimport org.springframework.cloud.client.loadbalancer.Request;\nimport org.springframework.cloud.client.loadbalancer.Response;\n\npublic class RandomLoadBalancer implements ReactorServiceInstanceLoadBalancer {\n\n\tprivate static final Log log = LogFactory.getLog(RandomLoadBalancer.class);\n\n\tprivate final String serviceId;\n\n\tprivate ObjectProvider<ServiceInstanceListSupplier> serviceInstanceListSupplierProvider;\n\n\t/**\n\t * @param serviceInstanceListSupplierProvider a provider of\n\t * {@link ServiceInstanceListSupplier} that will be used to get available instances\n\t * @param serviceId id of the service for which to choose an instance\n\t */\n\tpublic RandomLoadBalancer(ObjectProvider<ServiceInstanceListSupplier> serviceInstanceListSupplierProvider,\n\t\t\tString serviceId) {\n\t\tthis.serviceId = serviceId;\n\t\tthis.serviceInstanceListSupplierProvider = serviceInstanceListSupplierProvider;\n\t}\n\n\t@SuppressWarnings("rawtypes")\n\t@Override\n\tpublic Mono<Response<ServiceInstance>> choose(Request request) {\n\t\tServiceInstanceListSupplier supplier = serviceInstanceListSupplierProvider\n\t\t\t\t.getIfAvailable(NoopServiceInstanceListSupplier::new);\n\t\treturn supplier.get(request).next()\n\t\t\t\t.map(serviceInstances -> processInstanceResponse(supplier, serviceInstances));\n\t}\n\n\tprivate Response<ServiceInstance> processInstanceResponse(ServiceInstanceListSupplier supplier,\n\t\t\tList<ServiceInstance> serviceInstances) {\n\t\tResponse<ServiceInstance> serviceInstanceResponse = getInstanceResponse(serviceInstances);\n\t\tif (supplier instanceof SelectedInstanceCallback && serviceInstanceResponse.hasServer()) {\n\t\t\t((SelectedInstanceCallback) supplier).selectedServiceInstance(serviceInstanceResponse.getServer());\n\t\t}\n\t\treturn serviceInstanceResponse;\n\t}\n\n\tprivate Response<ServiceInstance> getInstanceResponse(List<ServiceInstance> instances) {\n\t\tif (instances.isEmpty()) {\n\t\t\tif (log.isWarnEnabled()) {\n\t\t\t\tlog.warn("No servers available for service: " + serviceId);\n\t\t\t}\n\t\t\treturn new EmptyResponse();\n\t\t}\n\t\tint index = ThreadLocalRandom.current().nextInt(instances.size());\n\n\t\tServiceInstance instance = instances.get(index);\n\n\t\treturn new DefaultResponse(instance);\n\t}\n\n}\n\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u4fdd\u7559\u6838\u5fc3\u5b9e\u73b0\u8fdb\u884c\u7b80\u5355\u4eff\u5199\u5982\u4e0b"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'package cn.itxs.ecom.order.config;\n\nimport java.util.List;\nimport java.util.Random;\nimport org.springframework.beans.factory.ObjectProvider;\nimport org.springframework.cloud.client.ServiceInstance;\nimport org.springframework.cloud.loadbalancer.core.ReactorServiceInstanceLoadBalancer;\nimport org.springframework.cloud.loadbalancer.core.ServiceInstanceListSupplier;\nimport org.springframework.cloud.client.loadbalancer.DefaultResponse;\nimport org.springframework.cloud.client.loadbalancer.EmptyResponse;\nimport org.springframework.cloud.client.loadbalancer.Request;\nimport org.springframework.cloud.client.loadbalancer.Response;\nimport reactor.core.publisher.Mono;\n\npublic class ItxsRandomLoadBalancerClient implements ReactorServiceInstanceLoadBalancer {\n    // \u670d\u52a1\u5217\u8868\n    private ObjectProvider<ServiceInstanceListSupplier> serviceInstanceListSupplierProvider;\n\n    public ItxsRandomLoadBalancerClient(ObjectProvider<ServiceInstanceListSupplier> serviceInstanceListSupplierProvider) {\n        this.serviceInstanceListSupplierProvider = serviceInstanceListSupplierProvider;\n    }\n\n    @Override\n    public Mono<Response<ServiceInstance>> choose(Request request) {\n        ServiceInstanceListSupplier supplier = serviceInstanceListSupplierProvider.getIfAvailable();\n        return supplier.get().next().map(this::getInstanceResponse);\n    }\n\n    /**\n     * \u4f7f\u7528\u968f\u673a\u6570\u83b7\u53d6\u670d\u52a1\n     * @param instances\n     * @return\n     */\n    private Response<ServiceInstance> getInstanceResponse(\n            List<ServiceInstance> instances) {\n        System.out.println("ItxsRandomLoadBalancerClient start");\n        if (instances.isEmpty()) {\n            return new EmptyResponse();\n        }\n\n        System.out.println("ItxsRandomLoadBalancerClient random");\n        // \u968f\u673a\u7b97\u6cd5\n        int size = instances.size();\n        Random random = new Random();\n        ServiceInstance instance = instances.get(random.nextInt(size));\n\n        return new DefaultResponse(instance);\n    }\n}\n\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u5c06\u4e0a\u9762CustomLoadBalancerConfiguration\u66ff\u6362\u4e3a\u5982\u4e0b\u5185\u5bb9"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"package cn.itxs.ecom.order.config;\n\nimport org.springframework.beans.factory.ObjectProvider;\nimport org.springframework.cloud.loadbalancer.core.ReactorServiceInstanceLoadBalancer;\nimport org.springframework.cloud.loadbalancer.core.ServiceInstanceListSupplier;\nimport org.springframework.context.annotation.Bean;\n\npublic class CustomLoadBalancerConfiguration {\n\n    @Bean\n    public ReactorServiceInstanceLoadBalancer customLoadBalancer(ObjectProvider<ServiceInstanceListSupplier> serviceInstanceListSupplierProvider) {\n        return new ItxsRandomLoadBalancerClient(serviceInstanceListSupplierProvider);\n    }\n}\n\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u542f\u52a8\u5e93\u5b58\u5fae\u670d\u52a1\u548c\u8ba2\u5355\u5fae\u670d\u52a1\uff0c\u8bbf\u95ee",(0,r.jsx)(n.a,{href:"http://localhost:4070/deductRest/1001/1",children:"http://localhost:4070/deductRest/1001/1"})," \uff0c\u63a7\u5236\u53f0\u5df2\u6253\u5370\u81ea\u5b9a\u4e49ItxsRandomLoadBalancerClient\u4e2d\u7684\u65e5\u5fd7\u548c\u6210\u529f\u8bbf\u95ee\u7ed3\u679c"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/c72e3f02f7e0d5d3343f8ae9c464b69c.png",alt:"image-20220509003807968"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/59796bbbd6b3524e32759d42b622f1bc.png",alt:"image-20220509003927550"})}),"\n",(0,r.jsx)(n.h1,{id:"\u53c2\u8003\u6587\u7ae0",children:"\u53c2\u8003\u6587\u7ae0"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://lijunyi.xyz/docs/SpringCloud/SpringCloud.html#_2-2-x-%E5%88%86%E6%94%AF",children:"https://lijunyi.xyz/docs/SpringCloud/SpringCloud.html#_2-2-x-%E5%88%86%E6%94%AF"}),"\n",(0,r.jsx)(n.a,{href:"https://mp.weixin.qq.com/s/2jeovmj77O9Ux96v3A0NtA",children:"https://mp.weixin.qq.com/s/2jeovmj77O9Ux96v3A0NtA"}),"\n",(0,r.jsx)(n.a,{href:"https://juejin.cn/post/6931922457741770760",children:"https://juejin.cn/post/6931922457741770760"}),"\n",(0,r.jsx)(n.a,{href:"https://github.com/D2C-Cai/herring",children:"https://github.com/D2C-Cai/herring"}),"\n",(0,r.jsx)(n.a,{href:"http://c.biancheng.net/springcloud",children:"http://c.biancheng.net/springcloud"}),"\n",(0,r.jsx)(n.a,{href:"https://github.com/macrozheng/springcloud-learning",children:"https://github.com/macrozheng/springcloud-learning"})]})]})}function p(e={}){const{wrapper:n}={...(0,a.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},88672:(e,n,t)=>{t.d(n,{Z:()=>i,a:()=>c});var r=t(50959);const a={},o=r.createContext(a);function c(e){const n=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:c(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);