"use strict";(self.webpackChunkcode_note_blog=self.webpackChunkcode_note_blog||[]).push([[4607],{44430:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>d,default:()=>u,frontMatter:()=>a,metadata:()=>s,toc:()=>i});var t=r(11527),l=r(88672);const a={},d=void 0,s={id:"Spring\u5168\u5bb6\u6876/SpringMVC\u6e90\u7801\u5206\u6790/\u8bf7\u6c42\u6267\u884c\u6d41\u7a0b\uff08\u4e8c\uff09\u4e4b\u6267\u884cHandler\u65b9\u6cd5",title:"\u8bf7\u6c42\u6267\u884c\u6d41\u7a0b\uff08\u4e8c\uff09\u4e4b\u6267\u884cHandler\u65b9\u6cd5",description:"\u672c\u6587\u662f springmvc \u8bf7\u6c42\u6267\u884c\u6d41\u7a0b\u7684\u7b2c\u4e8c\u7bc7\u6587\u7ae0\uff0c\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u5206\u6790\u4e86 DispatcherServlet#doDispatch \u65b9\u6cd5\uff0c\u603b\u7ed3\u51fa\u8bf7\u6c42\u6267\u884c\u5206\u4e3a\u5982\u4e0b\u6b65\u9aa4\uff1a",source:"@site/docs/Spring\u5168\u5bb6\u6876/SpringMVC\u6e90\u7801\u5206\u6790/\u8bf7\u6c42\u6267\u884c\u6d41\u7a0b\uff08\u4e8c\uff09\u4e4b\u6267\u884cHandler\u65b9\u6cd5.md",sourceDirName:"Spring\u5168\u5bb6\u6876/SpringMVC\u6e90\u7801\u5206\u6790",slug:"/Spring\u5168\u5bb6\u6876/SpringMVC\u6e90\u7801\u5206\u6790/\u8bf7\u6c42\u6267\u884c\u6d41\u7a0b\uff08\u4e8c\uff09\u4e4b\u6267\u884cHandler\u65b9\u6cd5",permalink:"/code-note-blog/docs/Spring\u5168\u5bb6\u6876/SpringMVC\u6e90\u7801\u5206\u6790/\u8bf7\u6c42\u6267\u884c\u6d41\u7a0b\uff08\u4e8c\uff09\u4e4b\u6267\u884cHandler\u65b9\u6cd5",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Spring\u5168\u5bb6\u6876/SpringMVC\u6e90\u7801\u5206\u6790/\u8bf7\u6c42\u6267\u884c\u6d41\u7a0b\uff08\u4e8c\uff09\u4e4b\u6267\u884cHandler\u65b9\u6cd5.md",tags:[],version:"current",frontMatter:{},sidebar:"spring",previous:{title:"Spring MVC \u5904\u7406\u5668\u5f02\u5e38\u89e3\u6790\u5668",permalink:"/code-note-blog/docs/Spring\u5168\u5bb6\u6876/SpringMVC/SpringMVC\u4e2d\u7684\u5f02\u5e38\u5904\u7406\u5668"},next:{title:"\u8bf7\u6c42\u6267\u884c\u6d41\u7a0b\uff08\u4e00\uff09\u4e4b\u83b7\u53d6Handler",permalink:"/code-note-blog/docs/Spring\u5168\u5bb6\u6876/SpringMVC\u6e90\u7801\u5206\u6790/\u8bf7\u6c42\u6267\u884c\u6d41\u7a0b\uff08\u4e00\uff09\u4e4b\u83b7\u53d6Handler"}},o={},i=[{value:"5. \u6267\u884c spring \u7684\u62e6\u622a\u5668\uff1a<code>HandlerInterceptor#preHandle</code>",id:"5-\u6267\u884c-spring-\u7684\u62e6\u622a\u5668handlerinterceptorprehandle",level:3},{value:"6. \u65b9\u6cd5\u7684\u6267\u884c\uff1a<code>AbstractHandlerMethodAdapter#handle</code>",id:"6-\u65b9\u6cd5\u7684\u6267\u884cabstracthandlermethodadapterhandle",level:3},{value:"\u53c2\u6570\u89e3\u6790",id:"\u53c2\u6570\u89e3\u6790",level:4},{value:"\u6267\u884c handler \u65b9\u6cd5",id:"\u6267\u884c-handler-\u65b9\u6cd5",level:4},{value:"\u5904\u7406\u8fd4\u56de\u53c2\u6570",id:"\u5904\u7406\u8fd4\u56de\u53c2\u6570",level:4},{value:"\u83b7\u53d6 ModelAndView",id:"\u83b7\u53d6-modelandview",level:4},{value:"7. \u6267\u884c\u62e6\u622a\u5668\uff1a<code>HandlerInterceptor#postHandle</code>",id:"7-\u6267\u884c\u62e6\u622a\u5668handlerinterceptorposthandle",level:3}];function c(e){const n={a:"a",blockquote:"blockquote",code:"code",em:"em",h3:"h3",h4:"h4",hr:"hr",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.p,{children:["\u672c\u6587\u662f ",(0,t.jsx)(n.strong,{children:"springmvc \u8bf7\u6c42\u6267\u884c\u6d41\u7a0b"}),"\u7684\u7b2c\u4e8c\u7bc7\u6587\u7ae0\uff0c\u5728\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u5206\u6790\u4e86 ",(0,t.jsx)(n.code,{children:"DispatcherServlet#doDispatch"})," \u65b9\u6cd5\uff0c\u603b\u7ed3\u51fa\u8bf7\u6c42\u6267\u884c\u5206\u4e3a\u5982\u4e0b\u6b65\u9aa4\uff1a"]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\u83b7\u53d6\u5bf9\u5e94\u7684 ",(0,t.jsx)(n.code,{children:"HandlerExecutionChain"}),", \u83b7\u53d6\u7684 ",(0,t.jsx)(n.code,{children:"HandlerExecutionChain"})," \u4e2d\u5305\u542b\u771f\u6b63\u5730\u5904\u7406\u5668\uff08",(0,t.jsx)(n.code,{children:"Controller"})," \u4e2d\u7684\u65b9\u6cd5\uff09\u548c\u4e00\u7ec4 ",(0,t.jsx)(n.code,{children:"HandlerInterceptor"})," \u62e6\u622a\u5668\uff1b"]}),"\n",(0,t.jsxs)(n.li,{children:["\u83b7\u53d6\u5bf9\u5e94\u7684 ",(0,t.jsx)(n.code,{children:"handlerAdapter"}),"\uff0c\u8be5\u5bf9\u8c61\u7528\u6765\u8fd0\u884c ",(0,t.jsx)(n.code,{children:"handler(xxx)"})," \u65b9\u6cd5\uff1b"]}),"\n",(0,t.jsxs)(n.li,{children:["\u6267\u884c spring \u7684\u62e6\u622a\u5668\uff0c\u8fd0\u884c ",(0,t.jsx)(n.code,{children:"HandlerInterceptor#preHandle"})," \u65b9\u6cd5\uff1b"]}),"\n",(0,t.jsxs)(n.li,{children:["\u5904\u7406\u8bf7\u6c42\uff0c\u4e5f\u5c31\u662f\u901a\u8fc7\u4e0a\u9762\u83b7\u53d6\u5230\u7684 ",(0,t.jsx)(n.code,{children:"handlerAdapter"})," \u6765\u8c03\u7528 ",(0,t.jsx)(n.code,{children:"handle(xxx)"})," \u65b9\u6cd5\uff1b"]}),"\n",(0,t.jsxs)(n.li,{children:["\u6267\u884c spring \u7684\u62e6\u622a\u5668\uff0c\u8fd0\u884c ",(0,t.jsx)(n.code,{children:"HandlerInterceptor#postHandle"})," \u65b9\u6cd5\uff1b"]}),"\n",(0,t.jsxs)(n.li,{children:["\u5904\u7406\u8fd4\u56de\u7ed3\u679c\uff0c\u8fd9\u91cc\u4f1a\u6e32\u67d3\u89c6\u56fe\uff0c\u4ee5\u53ca\u6267\u884c spring \u62e6\u622a\u5668\u7684 ",(0,t.jsx)(n.code,{children:"HandlerInterceptor#afterCompletion"}),"\u3002"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["\u63a5\u7740\uff0c\u6211\u4eec\u7ee7\u7eed\u5206\u6790 ",(0,t.jsx)(n.code,{children:"HandlerExecutionChain"})," \u7684\u83b7\u53d6\u4ee5\u53ca ",(0,t.jsx)(n.code,{children:"handlerAdapter"})," \u7684\u83b7\u53d6\uff0c\u4e66\u63a5\u4e0a\u56de\uff0c\u672c\u6587\u5c06\u7ee7\u7eed\u5206\u6790\u63a5\u4e0b\u6765\u7684\u6b65\u9aa4\u3002"]}),"\n",(0,t.jsxs)(n.h3,{id:"5-\u6267\u884c-spring-\u7684\u62e6\u622a\u5668handlerinterceptorprehandle",children:["5. \u6267\u884c spring \u7684\u62e6\u622a\u5668\uff1a",(0,t.jsx)(n.code,{children:"HandlerInterceptor#preHandle"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"protected void doDispatch(HttpServletRequest request, HttpServletResponse response) throws Exception {\n    ...\n    // 3\\. \u8fd0\u884cspring\u7684\u62e6\u622a\u5668, \u8fd0\u884c HandlerInterceptor#preHandle \u65b9\u6cd5\n    // \u8fd9\u4e2amappedHandler\uff0c\u5c31\u662f\u7b2c1\u6b65\u83b7\u53d6\u7684HandlerExecutionChain\n    if (!mappedHandler.applyPreHandle(processedRequest, response)) {\n        return;\n    }\n    ...\n}\n\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u4e0a\u9762\u7684 ",(0,t.jsx)(n.code,{children:"mappedHandler"}),"\uff0c\u5c31\u662f\u7b2c 1 \u6b65\u83b7\u53d6\u7684 ",(0,t.jsx)(n.code,{children:"HandlerExecutionChain"}),"\uff0c\u8fdb\u5165 ",(0,t.jsx)(n.code,{children:"HandlerExecutionChain#applyPreHandle"}),"\uff1a"]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"HandlerExecutionChain#applyPreHandle"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'/**\n * \u6267\u884c HandlerInterceptor#preHandle \u65b9\u6cd5\n */\nboolean applyPreHandle(HttpServletRequest request, HttpServletResponse response) \n        throws Exception {\n    // \u83b7\u53d6\u6240\u6709\u7684\u62e6\u622a\u5668\n    HandlerInterceptor[] interceptors = getInterceptors();\n    if (!ObjectUtils.isEmpty(interceptors)) {\n        // \u904d\u5386\u6267\u884c preHandle \u65b9\u6cd5\n        for (int i = 0; i < interceptors.length; i++) {\n            HandlerInterceptor interceptor = interceptors[i];\n            if (!interceptor.preHandle(request, response, this.handler)) {\n                // \u5931\u8d25\u4e86\uff0c\u8fd8\u4f1a\u7ee7\u7eed\u6267\u884c HandlerInterceptor#afterCompletion \u65b9\u6cd5\n                triggerAfterCompletion(request, response, null);\n                return false;\n            }\n            this.interceptorIndex = i;\n        }\n    }\n    return true;\n}\n\n/**\n * \u6267\u884c HandlerInterceptor#afterCompletion \u65b9\u6cd5\n * \u4e3a\u4e86\u4fdd\u8bc1HandlerInterceptor#afterCompletion\u7684\u6267\u884c\uff0c\n * \u63a5\u4e0b\u6765\u7684\u5206\u6790\u4f1a\u770b\u5230\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u4f1a\u5728\u591a\u4e2a\u65b9\u6cd5\u8c03\u7528\u5230\n */\nvoid triggerAfterCompletion(HttpServletRequest request, \n        HttpServletResponse response, @Nullable Exception ex) throws Exception {\n    HandlerInterceptor[] interceptors = getInterceptors();\n    if (!ObjectUtils.isEmpty(interceptors)) {\n        // \u904d\u5386\u6267\u884c HandlerInterceptor#afterCompletion \u65b9\u6cd5\n        for (int i = this.interceptorIndex; i >= 0; i--) {\n            HandlerInterceptor interceptor = interceptors[i];\n            try {\n                interceptor.afterCompletion(request, response, this.handler, ex);\n            }\n            catch (Throwable ex2) {\n                logger.error("HandlerInterceptor.afterCompletion threw exception", ex2);\n            }\n        }\n    }\n}\n\n'})}),"\n",(0,t.jsxs)(n.p,{children:["\u6211\u4eec\u6765\u770b\u4e00\u773c ",(0,t.jsx)(n.code,{children:"HandlerExecutionChain"}),"\uff1a"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-40ba62630b5d83a16ed9aba35aba48af8be.png",alt:""})}),"\n",(0,t.jsxs)(n.p,{children:["\u518d\u6765\u770b\u770b\u4f20\u5165 ",(0,t.jsx)(n.code,{children:"HandlerInterceptor"})," \u7684 ",(0,t.jsx)(n.code,{children:"handler"})," \u662f\u5565\uff1a"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-6c50a936804c1db4a7b817dbb5ff417034d.png",alt:""})}),"\n",(0,t.jsxs)(n.p,{children:["\u8fd9\u4e2a ",(0,t.jsx)(n.code,{children:"handler"})," \u5c31\u662f ",(0,t.jsx)(n.code,{children:"HandlerMethod"}),"\uff0c\u91cc\u9762\u5305\u542b\u7684\u4fe1\u606f\u8fd8\u662f\u633a\u4e30\u5bcc\u7684\uff0c\u50cf ",(0,t.jsx)(n.code,{children:"bean"}),"/",(0,t.jsx)(n.code,{children:"beanFactory"}),"/",(0,t.jsx)(n.code,{children:"method"}),"\uff0c\u5229\u7528\u8fd9\u51e0\u4e2a\u5c5e\u6027\uff0c\u6211\u4eec\u53ef\u4ee5\u5bf9\u5176\u8fdb\u884c\u5404\u79cd\u64cd\u4f5c\u3002"]}),"\n",(0,t.jsxs)(n.h3,{id:"6-\u65b9\u6cd5\u7684\u6267\u884cabstracthandlermethodadapterhandle",children:["6. \u65b9\u6cd5\u7684\u6267\u884c\uff1a",(0,t.jsx)(n.code,{children:"AbstractHandlerMethodAdapter#handle"})]}),"\n",(0,t.jsxs)(n.p,{children:["\u6211\u4eec\u518d\u56de\u5230 ",(0,t.jsx)(n.code,{children:"DispatcherServlet#doDispatch"}),"\uff0c\u6267\u884c\u5b8c ",(0,t.jsx)(n.code,{children:"HandlerInterceptor#preHandle"})," \u65b9\u6cd5\u540e\uff0c\u5c31\u6765\u5230\u6240\u6709\u6d41\u7a0b\u4e2d\u7684\u91cd\u5934\u620f\uff1a",(0,t.jsx)(n.code,{children:"handler"})," \u7684\u6267\u884c\uff0c\u4e5f\u5c31\u662f ",(0,t.jsx)(n.code,{children:"controller"})," \u4e2d\uff0c",(0,t.jsx)(n.code,{children:"url"})," \u5bf9\u5e94\u7684\u65b9\u6cd5\u6267\u884c\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"protected void doDispatch(HttpServletRequest request, HttpServletResponse response) throws Exception {\n    ...\n    // 4\\. \u901a\u8fc7\u4e0a\u9762\u83b7\u53d6\u5230\u7684handlerAdapter\u6765\u8c03\u7528handle\n    mv = ha.handle(processedRequest, response, mappedHandler.getHandler());\n    ...\n}\n\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u4e00\u8def\u8ddf\u8fdb\u53bb\uff0c\u6700\u7ec8\u6765\u5230\u4e86 ",(0,t.jsx)(n.code,{children:"RequestMappingHandlerAdapter#invokeHandlerMethod"})," \u65b9\u6cd5\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'protected ModelAndView invokeHandlerMethod(HttpServletRequest request,\n        HttpServletResponse response, HandlerMethod handlerMethod) throws Exception {\n    // \u5305\u88c5reques\u4e0erequest\u5bf9\u8c61\n    ServletWebRequest webRequest = new ServletWebRequest(request, response);\n    try {\n        // \u83b7\u53d6 @InitBinder \u6ce8\u89e3\u7684\u65b9\u6cd5\uff0c\n        // \u5305\u542b\u5f53\u524dcontroller\u4e0e @ControllerAdvice \u6807\u6ce8\u7684\u7c7b\u91cc\u7684 @InitBinder \u6ce8\u89e3\u7684\u65b9\u6cd5\n        WebDataBinderFactory binderFactory = getDataBinderFactory(handlerMethod);\n        // \u83b7\u53d6 @ModelAttribute \u6ce8\u89e3\u7684\u65b9\u6cd5\uff0c\n        // \u5305\u542b\u5f53\u524dcontroller\u4e0e @ControllerAdvice \u6807\u6ce8\u7684\u7c7b\u91cc\u7684 @ModelAttribute \u6ce8\u89e3\u7684\u65b9\u6cd5\n        ModelFactory modelFactory = getModelFactory(handlerMethod, binderFactory);\n        // \u521b\u5efa\u65b9\u6cd5\u6267\u884c\u5bf9\u8c61\n        ServletInvocableHandlerMethod invocableMethod = createInvocableHandlerMethod(handlerMethod);\n        if (this.argumentResolvers != null) {\n            invocableMethod.setHandlerMethodArgumentResolvers(this.argumentResolvers);\n        }\n        if (this.returnValueHandlers != null) {\n            invocableMethod.setHandlerMethodReturnValueHandlers(this.returnValueHandlers);\n        }\n        invocableMethod.setDataBinderFactory(binderFactory);\n        invocableMethod.setParameterNameDiscoverer(this.parameterNameDiscoverer);\n        // \u521b\u5efaModelAndView\u7684\u5bb9\u5668\n        ModelAndViewContainer mavContainer = new ModelAndViewContainer();\n        mavContainer.addAllAttributes(RequestContextUtils.getInputFlashMap(request));\n        modelFactory.initModel(webRequest, mavContainer, invocableMethod);\n        mavContainer.setIgnoreDefaultModelOnRedirect(this.ignoreDefaultModelOnRedirect);\n        // \u5904\u7406\u5f02\u6b65\u8bf7\u6c42\n        AsyncWebRequest asyncWebRequest = WebAsyncUtils.createAsyncWebRequest(request, response);\n        asyncWebRequest.setTimeout(this.asyncRequestTimeout);\n        WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);\n        asyncManager.setTaskExecutor(this.taskExecutor);\n        asyncManager.setAsyncWebRequest(asyncWebRequest);\n        asyncManager.registerCallableInterceptors(this.callableInterceptors);\n        asyncManager.registerDeferredResultInterceptors(this.deferredResultInterceptors);\n        if (asyncManager.hasConcurrentResult()) {\n            Object result = asyncManager.getConcurrentResult();\n            mavContainer = (ModelAndViewContainer) asyncManager.getConcurrentResultContext()[0];\n            asyncManager.clearConcurrentResult();\n            LogFormatUtils.traceDebug(logger, traceOn -> {\n                String formatted = LogFormatUtils.formatValue(result, !traceOn);\n                return "Resume with async result [" + formatted + "]";\n            });\n            invocableMethod = invocableMethod.wrapConcurrentResult(result);\n        }\n        // \u6267\u884cController\u7684\u65b9\u6cd5\uff08\u91cd\u70b9\uff09\n        invocableMethod.invokeAndHandle(webRequest, mavContainer);\n        if (asyncManager.isConcurrentHandlingStarted()) {\n            return null;\n        }\n        // \u5904\u7406\u8fd4\u56de\u7ed3\u679c\n        return getModelAndView(mavContainer, modelFactory, webRequest);\n    }\n    finally {\n        webRequest.requestCompleted();\n    }\n}\n\n'})}),"\n",(0,t.jsxs)(n.p,{children:["\u8fd9\u4e2a\u65b9\u6cd5\u6709\u70b9\u957f\uff0c\u4f46\u91cd\u70b9\u65b9\u6cd5\u53ea\u6709\u4e00\u884c\uff1a",(0,t.jsx)(n.code,{children:"invocableMethod.invokeAndHandle(webRequest, mavContainer);"}),"\uff0c\u5728\u8fd9\u4e2a\u65b9\u6cd5\u524d\u7684\u90e8\u5206\u90fd\u662f\u5728\u505a\u65b9\u6cd5\u6267\u884c\u524d\u7684\u51c6\u5907\u5de5\u4f5c\uff0c\u5982\u83b7\u53d6 ",(0,t.jsx)(n.code,{children:"@InitBinder"})," \u6ce8\u89e3\u7684\u65b9\u6cd5\u3001\u83b7\u53d6 ",(0,t.jsx)(n.code,{children:"@ModelAttribute"})," \u6ce8\u89e3\u7684\u65b9\u6cd5\uff0c\u51c6\u5907\u65b9\u6cd5\u53c2\u6570 ",(0,t.jsx)(n.code,{children:"webRequest"}),"(\u5305\u88c5 ",(0,t.jsx)(n.code,{children:"request"})," \u4e0e ",(0,t.jsx)(n.code,{children:"response"})," \u5bf9\u8c61) \u4e0e ",(0,t.jsx)(n.code,{children:"mavContainer"}),"(",(0,t.jsx)(n.code,{children:"ModelAndView"})," \u5305\u88c5\u5bf9\u8c61) \u7b49\u3002\u8fd9\u91cc\u6211\u4eec\u76f4\u63a5\u8fdb\u5165 ",(0,t.jsx)(n.code,{children:"invocableMethod.invokeAndHandle"}),"\uff0c\u770b\u770b\u65b9\u6cd5\u662f\u5982\u4f55\u6267\u884c\u7684\uff1a"]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"ServletInvocableHandlerMethod#invokeAndHandle"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'public void invokeAndHandle(ServletWebRequest webRequest, ModelAndViewContainer mavContainer,\n        Object... providedArgs) throws Exception {\n    // \u6267\u884chandler\u65b9\u6cd5\n    Object returnValue = invokeForRequest(webRequest, mavContainer, providedArgs);\n    // \u8bbe\u7f6e RequestHandled \u5c5e\u6027\u503c\uff0cspringmvc\u4f1a\u6839\u636e\u8be5\u503c\u5224\u65ad\u8981\u4e0d\u8981\u8df3\u8f6c\n    if (returnValue == null) {\n        if (isRequestNotModified(webRequest) || getResponseStatus() != null \n                || mavContainer.isRequestHandled()) {\n            disableContentCachingIfNecessary(webRequest);\n            mavContainer.setRequestHandled(true);\n            return;\n        }\n    }\n    else if (StringUtils.hasText(getResponseStatusReason())) {\n        mavContainer.setRequestHandled(true);\n        return;\n    }\n    mavContainer.setRequestHandled(false);\n    Assert.state(this.returnValueHandlers != null, "No return value handlers");\n    try {\n        // \u5904\u7406\u8fd4\u56de\u7ed3\u679c\n        this.returnValueHandlers.handleReturnValue(\n                returnValue, getReturnValueType(returnValue), mavContainer, webRequest);\n    }\n    catch (Exception ex) {\n        throw ex;\n    }\n}\n\n'})}),"\n",(0,t.jsxs)(n.p,{children:["\u8fd9\u91cc\u65b9\u6cd5\u5148\u662f\u8c03\u7528\u4e86 ",(0,t.jsx)(n.code,{children:"invokeForRequest"})," \u6267\u884c\u65b9\u6cd5\uff0c\u7136\u540e\u518d\u6839\u636e\u65b9\u6cd5\u7684\u8fd4\u56de\u503c\u6765\u8bbe\u7f6e ",(0,t.jsx)(n.code,{children:"mavContainer"})," \u7684 ",(0,t.jsx)(n.code,{children:"RequestHandled"})," \u503c\uff0c\u6700\u540e\u5904\u7406\u8fd4\u56de\u7ed3\u679c\u3002\u7ee7\u7eed\u8ddf\u8fdb ",(0,t.jsx)(n.code,{children:"invokeForRequest"})," \u65b9\u6cd5\uff1a"]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"InvocableHandlerMethod#invokeForRequest"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"@Nullable\npublic Object invokeForRequest(NativeWebRequest request, @Nullable ModelAndViewContainermavContainer,\n        Object... providedArgs) throws Exception {\n    // \u5904\u7406\u53c2\u6570\u7ed1\u5b9a\n    Object[] args = getMethodArgumentValues(request, mavContainer, providedArgs);\n    // \u53cd\u5c04\u8c03\u7528\u65b9\u6cd5\n    return doInvoke(args);\n}\n\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u8fd9\u4e2a\u65b9\u6cd5\u91cc\u5148\u662f\u5904\u7406\u4e86\u53c2\u6570\u89e3\u6790\uff0c\u7136\u540e\u4f7f\u7528\u53cd\u5c04\u8fdb\u884c\u65b9\u6cd5\u8c03\u7528\u3002\u4e8b\u5b9e\u4e0a\uff0c\u6574\u4e2a\u6267\u884c\u6d41\u7a0b\u4e2d\uff0c\u6700\u6838\u5fc3\u7684\u5c31\u662f\u53c2\u6570\u89e3\u6790\u4e86\uff0c\u5728 controller \u91cc\u7684 handler \u65b9\u6cd5\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u8fd9\u6837\u6307\u5b9a\u53c2\u6570\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'// \u76f4\u63a5\u4f20\u53c2\n@RequestMapping("xxx")\npublic Object test(String name) {\n    ...\n}\n\n// \u5728\u53c2\u6570\u4e0a\u6807\u6709@RequestParam\u3001@RequestHeader\u7b49\u6ce8\u89e3\n@RequestMapping("xxx")\npublic Object test(@RequestParam("name") String name, \n                   @RequestHeader("uid") String uid) {\n    ...\n}\n\n// \u5c06\u4f20\u5165\u7684\u53c2\u6570\u5c01\u88c5\u4e3a\u5bf9\u8c61\n@RequestMapping("xxx")\npublic Object test(User user) {\n    ...\n}\n\n// \u4e0a\u9762\u7684\u65b9\u6cd5\u90fd\u662f\u4f7f\u7528form\u8868\u5355\u4f20\u53c2(\u4e5f\u5c31\u662fk1=v1&2=v2&...\u7684\u65b9\u6cd5)\n// \u8fd9\u4e2a\u65b9\u6cd5\u4f7f\u7528 RequestBody \u65b9\u5f0f\u4f20\u53c2\uff0c\u5c06\u53c2\u6570\u5185\u5bb9\u653e\u5165\u6d88\u606f\u4f53\u4e2d\n@RequestMapping("xxx")\npublic Object test(@RequestBody User user) {\n    ...\n}\n\n...\n\n'})}),"\n",(0,t.jsx)(n.p,{children:"\u5f53\u6211\u4eec\u6309\u89c4\u8303\u4f20\u5165\u53c2\u6570\u65f6\uff0cspringmvc \u90fd\u80fd\u6b63\u5e38\u5904\u7406\uff0c\u6211\u4eec\u6765\u770b\u770b springmvc \u662f\u5982\u4f55\u505a\u5230\u8fd9\u4e00\u70b9\u7684\u3002"}),"\n",(0,t.jsx)(n.h4,{id:"\u53c2\u6570\u89e3\u6790",children:"\u53c2\u6570\u89e3\u6790"}),"\n",(0,t.jsxs)(n.p,{children:["\u7ee7\u7eed\uff0c\u8fdb\u5165 ",(0,t.jsx)(n.code,{children:"InvocableHandlerMethod#getMethodArgumentValues"})," \u65b9\u6cd5\uff1a"]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"InvocableHandlerMethod#getMethodArgumentValues"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'protected Object[] getMethodArgumentValues(NativeWebRequest request, \n        @Nullable ModelAndViewContainer mavContainer, Object... providedArgs) throws Exception {\n    // \u83b7\u53d6\u65b9\u6cd5\u7684\u6240\u6709\u53c2\u6570\uff0c\u53ef\u4ee5\u7b80\u5355\u7406\u89e3\u4e3a\u5229\u7528\u53cd\u5c04\u83b7\u53d6handler\u65b9\u6cd5\u53c2\u6570\uff0c\u7136\u540e\u5305\u88c5\u4e3a MethodParameter\n    MethodParameter[] parameters = getMethodParameters();\n    if (ObjectUtils.isEmpty(parameters)) {\n        return EMPTY_ARGS;\n    }\n    Object[] args = new Object[parameters.length];\n    // \u4f9d\u6b21\u5904\u7406\u6bcf\u4e2a\u53c2\u6570\n    for (int i = 0; i < parameters.length; i++) {\n        MethodParameter parameter = parameters[i];\n        parameter.initParameterNameDiscovery(this.parameterNameDiscoverer);\n        args[i] = findProvidedArgument(parameter, providedArgs);\n        if (args[i] != null) {\n            continue;\n        }\n        // \u5224\u65ad\u662f\u5426\u6709\u53c2\u6570\u89e3\u6790\u7c7b\u652f\u6301\u5f53\u524d\u53c2\u6570\u7684\u89e3\u6790\n        if (!this.resolvers.supportsParameter(parameter)) {\n            throw new IllegalStateException(formatArgumentError(parameter, "No suitable resolver"));\n        }\n        try {\n            // \u5904\u7406\u53c2\u6570\u89e3\u6790\n            args[i] = this.resolvers.resolveArgument(parameter, mavContainer, request, \n                    this.dataBinderFactory);\n        }\n        catch (Exception ex) {\n            throw ex;\n        }\n    }\n    return args;\n}\n\n'})}),"\n",(0,t.jsxs)(n.p,{children:["\u8fd9\u4e2a\u65b9\u6cd5\u5148\u83b7\u53d6\u4e86 handler \u65b9\u6cd5\u7684\u53c2\u6570 (\u53ef\u4ee5\u7b80\u5355\u7406\u89e3\u4e3a\u5229\u7528\u53cd\u5c04\u83b7\u53d6 handler \u65b9\u6cd5\u53c2\u6570\uff0c\u7136\u540e\u5305\u88c5\u4e3a ",(0,t.jsx)(n.code,{children:"MethodParameter"}),")\uff0c\u7136\u540e\u5bf9\u8fd9\u4e9b\u53c2\u6570\u9010\u4e2a\u89e3\u6790\u3002\u89e3\u6790\u65f6\uff0c\u4f1a\u7528\u5230\u4e24\u4e2a\u91cd\u8981\u7684\u65b9\u6cd5\uff1a",(0,t.jsx)(n.code,{children:"resolvers.supportsParameter(...)"})," \u4e0e ",(0,t.jsx)(n.code,{children:"resolvers.resolveArgument(...)"}),"\uff0c\u8fd9\u4e24\u4e2a\u65b9\u6cd5\u6700\u7ec8\u8c03\u7528\u7684\u65b9\u6cd5\u5728 ",(0,t.jsx)(n.code,{children:"HandlerMethodArgumentResolverComposite"})," \u4e2d\uff1a"]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"HandlerMethodArgumentResolverComposite"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"@Nullable\npublic Object resolveArgument(MethodParameter parameter, @Nullable ModelAndViewContainermavContainer,\n        NativeWebRequest webRequest, @Nullable WebDataBinderFactory binderFactory) throws Exception {\n    // \u83b7\u53d6\u4e00\u4e2a\u89e3\u6790\u5668\n    HandlerMethodArgumentResolver resolver = getArgumentResolver(parameter);\n    if (resolver == null) {\n        throw new IllegalArgumentException(...);\n    }\n    // \u89e3\u6790\u53c2\u6570\uff0c\u8c03\u7528 HandlerMethodArgumentResolver#resolveArgument \u65b9\u6cd5\n    return resolver.resolveArgument(parameter, mavContainer, webRequest, binderFactory);\n}\n\nprivate HandlerMethodArgumentResolver getArgumentResolver(MethodParameter parameter) {\n    HandlerMethodArgumentResolver result = this.argumentResolverCache.get(parameter);\n    if (result == null) {\n        // \u904d\u5386\u6240\u6709\u7684\u89e3\u6790\u5668\n        for (HandlerMethodArgumentResolver resolver : this.argumentResolvers) {\n            // \u627e\u5230\u5176\u4e2d\u4e00\u4e2a\u89e3\u6790\u5668\uff0c\u8fd4\u56de\n            // \u8c03\u7528 HandlerMethodArgumentResolver#supportsParameter \u65b9\u6cd5\n            if (resolver.supportsParameter(parameter)) {\n                result = resolver;\n                this.argumentResolverCache.put(parameter, result);\n                break;\n            }\n        }\n    }\n    return result;\n}\n\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u8fd9\u4e24\u4e2a\u65b9\u6cd5\u4e3b\u8981\u662f\u904d\u5386\u89e3\u6790\u5668\uff0c\u7136\u540e\u8c03\u7528 ",(0,t.jsx)(n.code,{children:"HandlerMethodArgumentResolver#supportsParameter"})," \u4e0e ",(0,t.jsx)(n.code,{children:"HandlerMethodArgumentResolver#resolveArgument"})," \u5904\u7406\u5177\u4f53\u7684\u64cd\u4f5c\u3002",(0,t.jsx)(n.code,{children:"HandlerMethodArgumentResolver"})," \u662f\u4e2a\u63a5\u53e3\uff0c\u91cc\u9762\u4ec5\u6709\u4e24\u4e2a\u65b9\u6cd5\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"public interface HandlerMethodArgumentResolver {\n    /**\n     * \u5f53\u524d\u662f\u5426\u652f\u6301\u5904\u7406\u5f53\u524d\u53c2\u6570\n     */\n    boolean supportsParameter(MethodParameter parameter);\n\n    /**\n     * \u5177\u4f53\u7684\u89e3\u6790\u64cd\u4f5c\n     */\n    @Nullable\n    Object resolveArgument(MethodParameter parameter, @Nullable ModelAndViewContainer mavContainer,\n            NativeWebRequest webRequest, @Nullable WebDataBinderFactory binderFactory) throws Exception;\n}\n\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u8fd9\u4e2a\u5c31\u662f\u771f\u6b63\u7684\u53c2\u6570\u89e3\u6790\u5668\u4e86\u3002\u5728 springmvc \u4e2d\uff0c\u63d0\u4f9b\u4e86\u591a\u5c11\u79cd\u53c2\u6570\u89e3\u6790\u5668\u5462\uff1f\u7ecf\u8fc7\u672c\u4eba\u7684\u8c03\u8bd5\uff0c\u53d1\u73b0\u591a\u8fbe 26 \u4e2a\uff1a"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-fd30bc847fc2cf7082de3731e68df6ae5f9.png",alt:""})," ",(0,t.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-894b391bbe4567734ee7237d900bc55ee31.png",alt:""})]}),"\n",(0,t.jsx)(n.p,{children:"\u6b63\u662f\u5728\u8fd9\u4e9b\u53c2\u6570\u89e3\u6790\u5668\u7684\u5e2e\u52a9\u4e0b\uff0cspringmvc \u80fd\u652f\u6301\u591a\u79cd\u53c2\u6570\u63a5\u6536\u65b9\u5f0f\uff01\u5bf9\u4e8e\u53c2\u6570\u89e3\u6790\u5668\uff0c\u7531\u4e8e\u8bbe\u8ba1\u6bd4\u8f83\u590d\u6742\uff0c\u6d89\u53ca\u591a\u79cd\u4f20\u53c2\u65b9\u5f0f\uff0c\u672c\u6587\u5e76\u4e0d\u60f3\u5c55\u5f00\u8ba8\u8bba\uff0c\u611f\u5174\u8da3\u7684\u5c0f\u4f19\u4f34\u53ef\u81ea\u884c\u67e5\u9605\u76f8\u5173\u6587\u6863\u3002"}),"\n",(0,t.jsx)(n.h4,{id:"\u6267\u884c-handler-\u65b9\u6cd5",children:"\u6267\u884c handler \u65b9\u6cd5"}),"\n",(0,t.jsxs)(n.p,{children:["\u5904\u7406\u5b8c\u53c2\u6570\u89e3\u6790\u540e\uff0c\u5c31\u5f00\u59cb\u6267\u884c handler \u65b9\u6cd5\u4e86\u3002\u8ba9\u6211\u4eec\u56de\u5230 ",(0,t.jsx)(n.code,{children:"InvocableHandlerMethod#invokeForRequest"})," \u65b9\u6cd5\uff1a"]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"InvocableHandlerMethod#invokeForRequest"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"@Nullable\npublic Object invokeForRequest(NativeWebRequest request, @Nullable ModelAndViewContainermavContainer,\n        Object... providedArgs) throws Exception {\n    // \u5904\u7406\u53c2\u6570\u7ed1\u5b9a\n    Object[] args = getMethodArgumentValues(request, mavContainer, providedArgs);\n    // \u53cd\u5c04\u8c03\u7528\u65b9\u6cd5\n    return doInvoke(args);\n}\n\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u8fdb\u5165 ",(0,t.jsx)(n.code,{children:"doInvoke"})," \u65b9\u6cd5\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"@Nullable\nprotected Object doInvoke(Object... args) throws Exception {\n    // \u4f7f\u7528\u53cd\u5c04\u6267\u884c\u65b9\u6cd5\n    ReflectionUtils.makeAccessible(getBridgedMethod());\n    try {\n        // \u8fd9\u91cc\u5c31\u662f\u53cd\u5c04\u64cd\u4f5c\n        return getBridgedMethod().invoke(getBean(), args);\n    }\n    catch (...) {\n        ...\n    }\n}\n\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u8fd9\u4e2a\u65b9\u6cd5\u5f88\u7b80\u5355\uff0c\u5c31\u662f\u5229\u7528\u53cd\u5c04\u6765\u8fdb\u884c\u65b9\u6cd5\u6267\u884c\u7684\uff0c\u5c31\u4e0d\u8fc7\u591a\u5206\u6790\u4e86\u3002"}),"\n",(0,t.jsx)(n.h4,{id:"\u5904\u7406\u8fd4\u56de\u53c2\u6570",children:"\u5904\u7406\u8fd4\u56de\u53c2\u6570"}),"\n",(0,t.jsxs)(n.p,{children:["\u8ba9\u6211\u4eec\u56de\u5230 ",(0,t.jsx)(n.code,{children:"ServletInvocableHandlerMethod#invokeAndHandle"})," \u65b9\u6cd5\uff1a"]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"ServletInvocableHandlerMethod#invokeAndHandle"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"public void invokeAndHandle(ServletWebRequest webRequest, ModelAndViewContainer mavContainer,\n        Object... providedArgs) throws Exception {\n    // \u6267\u884chandle\u65b9\u6cd5\n    Object returnValue = invokeForRequest(webRequest, mavContainer, providedArgs);\n    ...\n    try {\n        // \u5904\u7406\u8fd4\u56de\u7ed3\u679c\n        this.returnValueHandlers.handleReturnValue(\n                returnValue, getReturnValueType(returnValue), mavContainer, webRequest);\n    }\n    catch (Exception ex) {\n        throw ex;\n    }\n}\n\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u5904\u7406\u5b8c\u65b9\u6cd5\u6267\u884c\u540e\uff0c\u63a5\u7740\u5c31\u5904\u7406\u8fd4\u56de\u7ed3\u679c\uff1a"}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"HandlerMethodReturnValueHandlerComposite#handleReturnValue"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"@Override\npublic void handleReturnValue(@Nullable Object returnValue, MethodParameter returnType,\n        ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception {\n    // \u6839\u636e\u8fd4\u56de\u7c7b\u578b\u627e\u4e00\u4e2a\u5408\u9002\u7684handler\u6765\u5904\u7406\u8fd4\u56de\u6570\u636e\n    HandlerMethodReturnValueHandler handler = selectHandler(returnValue, returnType);\n    if (handler == null) {\n        throw new IllegalArgumentException(...);\n    }\n    handler.handleReturnValue(returnValue, returnType, mavContainer, webRequest);\n}\n\n@Nullable\nprivate HandlerMethodReturnValueHandler selectHandler(@Nullable Object value, MethodParameterreturnType) {\n    boolean isAsyncValue = isAsyncReturnValue(value, returnType);\n    // \u904d\u5386\uff0c\u9010\u4e2a\u5224\u65ad\u662f\u5426\u80fd\u5904\u7406\u5f53\u524d\u8fd4\u56de\u7c7b\u578b\n    for (HandlerMethodReturnValueHandler handler : this.returnValueHandlers) {\n        if (isAsyncValue && !(handler instanceof AsyncHandlerMethodReturnValueHandler)) {\n            continue;\n        }\n        if (handler.supportsReturnType(returnType)) {\n            return handler;\n        }\n    }\n    return null;\n}\n\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u83b7\u53d6 ",(0,t.jsx)(n.code,{children:"ReturnValueHandler"})," \u7684\u5957\u8def\u4e0e\u524d\u9762\u83b7\u53d6 ",(0,t.jsx)(n.code,{children:"ArgumentResolver"})," \u7684\u5957\u8def\u76f8\u5173\u65e0\u51e0\uff0c",(0,t.jsx)(n.code,{children:"ReturnValueHandler"})," \u662f ",(0,t.jsx)(n.code,{children:"HandlerMethodReturnValueHandler"})," \u7684\u5b50\u7c7b\uff0c",(0,t.jsx)(n.code,{children:"HandlerMethodReturnValueHandler"})," \u4ee3\u7801\u5982\u4e0b\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"public interface HandlerMethodReturnValueHandler {\n\n    /**\n     * \u5224\u65ad\u5f53\u524dReturnValueHandler\u80fd\u5426\u5904\u7406\u4f20\u5165\u7684returnType\n     */\n    boolean supportsReturnType(MethodParameter returnType);\n\n    /**\n     * \u5177\u4f53\u7684\u5904\u7406\u903b\u8f91\n     */\n    void handleReturnValue(@Nullable Object returnValue, MethodParameter returnType,\n            ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception;\n\n}\n\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u540c\u524d\u9762\u53c2\u6570\u89e3\u6790\u5668\u4e00\u6837\uff0c\u8fd9\u4e2a\u63a5\u53e3\u91cc\u4e5f\u6709\u4e24\u4e2a\u65b9\u6cd5\uff1a"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"boolean supportsReturnType(xxx)"}),"\uff1a\u5224\u65ad\u5f53\u524d ",(0,t.jsx)(n.code,{children:"ReturnValueHandler"})," \u80fd\u5426\u5904\u7406\u4f20\u5165\u7684 ",(0,t.jsx)(n.code,{children:"returnType"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"void handleReturnValue(xxx)"}),"\uff1a\u5177\u4f53\u7684\u5904\u7406\u903b\u8f91"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"\u540c\u6837\u5730\uff0cspringmvc \u4e5f\u63d0\u4f9b\u4e86\u975e\u5e38\u591a\u7684\u5b9e\u73b0\u6765\u5904\u7406\u8fd4\u56de\u53c2\u6570\uff1a"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-8e3c1fd4dca7c13efbceac5800e26145963.png",alt:""})}),"\n",(0,t.jsx)(n.p,{children:"\u5bf9\u4e8e\u53c2\u6570\u7684\u8fd4\u56de\uff0c\u6211\u4eec\u6765\u770b\u4e00\u4e2a\u7b80\u5355\u7684\u793a\u4f8b\uff1a"}),"\n",(0,t.jsx)(n.p,{children:"\u5982\u679c\u6211\u4eec\u50cf\u8fd9\u6837\u8fd4\u56de\u503c\u65f6\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'@Controller\n@RequestMapping("/xxx")\npublic class XxxController {\n\n    @RequestMapping("/index")\n    public String index() {\n        return "index";\n    }\n}\n\n'})}),"\n",(0,t.jsxs)(n.p,{children:["\u8fd4\u56de\u5230\u9875\u9762\u7684\u5c06\u662f\u4e00\u4e2a\u89c6\u56fe\uff0c\u5bf9\u5e94\u7684 ",(0,t.jsx)(n.code,{children:"HandlerMethodReturnValueHandler"})," \u4e3a ",(0,t.jsx)(n.code,{children:"ViewNameMethodReturnValueHandler"}),"\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'public class ViewNameMethodReturnValueHandler implements HandlerMethodReturnValueHandler {\n\n    @Nullable\n    private String[] redirectPatterns;\n\n    // \u7701\u7565 redirectPatterns \u7684setter\u4e0egetter\u65b9\u6cd5\n    ...\n\n    @Override\n    public boolean supportsReturnType(MethodParameter returnType) {\n        Class<?> paramType = returnType.getParameterType();\n        // \u652f\u6301\u5904\u7406\u7684\u8fd4\u56de\u503c\u7c7b\u578b\uff1a\u8fd4\u56de\u503c\u7c7b\u578b\u4e3avoid\uff0c\u6216\u8005\u4e3a\u5b57\u7b26\u4e32\u7c7b\u578b\n        return (void.class == paramType || CharSequence.class.isAssignableFrom(paramType));\n    }\n\n    /**\n     * \u5177\u4f53\u7684\u5904\u7406\u903b\u8f91\n     */\n    @Override\n    public void handleReturnValue(@Nullable Object returnValue, MethodParameter returnType,\n            ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception {\n\n        if (returnValue instanceof CharSequence) {\n            // viewName \u5c31\u662f\u8fd4\u56de\u503c\n            String viewName = returnValue.toString();\n            mavContainer.setViewName(viewName);\n            if (isRedirectViewName(viewName)) {\n                // \u662f\u5426\u9700\u8981\u8df3\u8f6c\n                mavContainer.setRedirectModelScenario(true);\n            }\n        }\n        else if (returnValue != null) {\n            throw new UnsupportedOperationException(...);\n        }\n    }\n\n    /**\n     * \u5224\u65ad\u662f\u5426\u9700\u8981\u8df3\u8f6c\n     */\n    protected boolean isRedirectViewName(String viewName) {\n        // this.redirectPatterns \u9ed8\u8ba4\u4e3anull\uff0c\u53ef\u4ee5\u81ea\u884c\u8c03\u7528 setter \u65b9\u6cd5\u8bbe\u7f6e\n        return (PatternMatchUtils.simpleMatch(this.redirectPatterns, viewName) \n            // \u5339\u914d redirect: \u5f00\u5934\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u6211\u4eec\u8fd4\u56de "redirect:index"\uff0c\u5c31\u8868\u660e\u8be5\u7ed3\u679c\u9700\u8981\u8df3\u8f6c\n            || viewName.startsWith("redirect:"));\n    }\n\n}\n\n'})}),"\n",(0,t.jsxs)(n.p,{children:["\u8fd9\u4e2a\u7c7b\u6bd4\u8f83\u7b80\u5355\uff0c\u5173\u952e\u90e8\u5206\u5df2\u5728\u4ee3\u7801\u4e2d\u4f5c\u4e86\u6ce8\u91ca\uff0c\u8fd9\u91cc\u5c31\u4e0d\u591a\u8bf4\u4e86\u3002\u503c\u5f97\u4e00\u63d0\u7684\u662f\uff0c\u5728 ",(0,t.jsx)(n.code,{children:"handleReturnValue(xxx)"})," \u65b9\u6cd5\u4e2d\uff0cspringmvc \u5c06\u8fd4\u56de\u7684\u5b57\u7b26\u4e32\u8bbe\u7f6e\u4e3a ",(0,t.jsx)(n.code,{children:"viewName"})," \u9700\u8981\u6ce8\u610f\u4e0b\uff0c\u540e\u9762\u5728\u5904\u7406\u89c6\u56fe\u65f6\uff0c\u4f1a\u5229\u7528\u8fd9\u4e2a ",(0,t.jsx)(n.code,{children:"viewName"})," \u62ff\u5230\u5bf9\u5e94\u7684 ",(0,t.jsx)(n.code,{children:"View"}),"\u3002"]}),"\n",(0,t.jsx)(n.h4,{id:"\u83b7\u53d6-modelandview",children:"\u83b7\u53d6 ModelAndView"}),"\n",(0,t.jsxs)(n.p,{children:["\u8ba9\u6211\u4eec\u56de\u5230 ",(0,t.jsx)(n.code,{children:"RequestMappingHandlerAdapter#invokeHandlerMethod"})," \u65b9\u6cd5\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"@Nullable\nprotected ModelAndView invokeHandlerMethod(HttpServletRequest request,\n        HttpServletResponse response, HandlerMethod handlerMethod) throws Exception {\n    ServletWebRequest webRequest = new ServletWebRequest(request, response);\n    try {\n        ...\n        // \u6267\u884cController\u7684\u65b9\u6cd5\n        invocableMethod.invokeAndHandle(webRequest, mavContainer);\n        if (asyncManager.isConcurrentHandlingStarted()) {\n            return null;\n        }\n        // \u5904\u7406\u6267\u884c\u7ed3\u679c\uff0c\u4ece\u4e2d\u62ff\u5230 ModelAndView\n        return getModelAndView(mavContainer, modelFactory, webRequest);\n    }\n    finally {\n        webRequest.requestCompleted();\n    }\n}\n\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u6267\u884c\u5b8c ",(0,t.jsx)(n.code,{children:"invocableMethod.invokeAndHandle(webRequest, mavContainer)"})," \u65b9\u6cd5\u540e\u63a5\u7740\u5c31\u662f\u4ece\u6267\u884c\u7ed3\u679c\u4e2d\u62ff\u5230 ",(0,t.jsx)(n.code,{children:"ModelAndView"})," \u4e86\uff0c\u8fdb\u5165 ",(0,t.jsx)(n.code,{children:"RequestMappingHandlerAdapter#getModelAndView"})," \u65b9\u6cd5\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"private ModelAndView getModelAndView(ModelAndViewContainer mavContainer,\n        ModelFactory modelFactory, NativeWebRequest webRequest) throws Exception {\n    // \u8fd9\u4e2a ModelFactory\uff0c\u5c31\u662f\u524d\u9762\u83b7\u53d6\u7684 \u5305\u542b@ModelAttribute \u6ce8\u89e3\u7684\u65b9\u6cd5\n    modelFactory.updateModel(webRequest, mavContainer);\n    if (mavContainer.isRequestHandled()) {\n        return null;\n    }\n    ModelMap model = mavContainer.getModel();\n    // \u521b\u5efa\u89c6\u56fe\u5bf9\u8c61\uff0c\u628amavContainer.getViewName()\u4f20\u5165\u5230ModelAndView\u7684\u6784\u9020\u65b9\u6cd5\u4e2d\n    ModelAndView mav = new ModelAndView(mavContainer.getViewName(), \n            model, mavContainer.getStatus());\n    if (!mavContainer.isViewReference()) {\n        mav.setView((View) mavContainer.getView());\n    }\n    // \u5904\u7406\u91cd\u5b9a\u5411\u53c2\u6570\n    if (model instanceof RedirectAttributes) {\n        Map<String, ?> flashAttributes = ((RedirectAttributes) model).getFlashAttributes();\n        HttpServletRequest request = webRequest.getNativeRequest(HttpServletRequest.class);\n        if (request != null) {\n            RequestContextUtils.getOutputFlashMap(request).putAll(flashAttributes);\n        }\n    }\n    return mav;\n}\n\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u53ef\u4ee5\u770b\u5230\uff0c",(0,t.jsx)(n.code,{children:"ModelAndView"})," \u5c31\u662f\u4ece\u524d\u9762\u6267\u884c\u7ed3\u679c\u7684 ",(0,t.jsx)(n.code,{children:"viewName"})," \u5f97\u5230\u7684\u3002"]}),"\n",(0,t.jsxs)(n.p,{children:["\u81f3\u6b64\uff0c",(0,t.jsx)(n.code,{children:"AbstractHandlerMethodAdapter#handle"})," \u6267\u884c\u5b8c\u6bd5\u3002"]}),"\n",(0,t.jsxs)(n.h3,{id:"7-\u6267\u884c\u62e6\u622a\u5668handlerinterceptorposthandle",children:["7. \u6267\u884c\u62e6\u622a\u5668\uff1a",(0,t.jsx)(n.code,{children:"HandlerInterceptor#postHandle"})]}),"\n",(0,t.jsxs)(n.p,{children:["\u8ba9\u6211\u4eec\u518d\u56de\u5230 ",(0,t.jsx)(n.code,{children:"DispatcherServlet#doDispatch"})," \u65b9\u6cd5\uff1a"]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"DispatcherServlet#doDispatch"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"protected void doDispatch(HttpServletRequest request, HttpServletResponse response) throws Exception {\n    ...\n\n    try {\n        ...\n        try {\n            ...\n            // 4.\u901a\u8fc7\u4e0a\u9762\u83b7\u53d6\u5230\u7684handlerAdapter\u6765\u8c03\u7528handle\n            mv = ha.handle(processedRequest, response, mappedHandler.getHandler());\n            // 5.\u5982\u679c\u51fd\u6570\u8c03\u7528\u6ca1\u6709\u8fd4\u56de\u89c6\u56fe\u5219\u4f7f\u7528\u9ed8\u8ba4\u7684\n            applyDefaultViewName(processedRequest, mv);\n            // 6\\. \u6267\u884c\u62e6\u622a\u5668\uff0c\u8fd0\u884c HandlerInterceptor#postHandle \u65b9\u6cd5\n            mappedHandler.applyPostHandle(processedRequest, response, mv);\n        }\n        catch (...) {\n            ...\n        }\n        // 7\\. \u5904\u7406\u8fd4\u56de\u7ed3\u679c\uff0c\u5728\u8fd9\u4e2a\u65b9\u6cd5\u91cc\u4f1a\u6267\u884c HandlerInterceptor.afterCompletion\n        processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);\n    }\n    catch (...) {\n        ...\n    }\n}\n\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u6267\u884c\u5b8c ",(0,t.jsx)(n.code,{children:"handler"})," \u65b9\u6cd5\u540e\uff0c\u5c31\u5f00\u59cb\u6267\u884c\u62e6\u622a\u5668\u7684 ",(0,t.jsx)(n.code,{children:"HandlerInterceptor#postHandle"})," \u65b9\u6cd5\u4e86\uff1a"]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"HandlerExecutionChain#applyPostHandle"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"void applyPostHandle(HttpServletRequest request, HttpServletResponse response, \n        @NullableModelAndView mv) throws Exception {\n    HandlerInterceptor[] interceptors = getInterceptors();\n    if (!ObjectUtils.isEmpty(interceptors)) {\n        // \u904d\u5386\u6267\u884c postHandle(...) \u65b9\u6cd5\n        for (int i = interceptors.length - 1; i >= 0; i--) {\n            HandlerInterceptor interceptor = interceptors[i];\n            interceptor.postHandle(request, response, this.handler, mv);\n        }\n    }\n}\n\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u8fd9\u4e2a\u540c\u524d\u9762\u6267\u884c\u62e6\u622a\u5668\u65b9\u6cd5\u7c7b\u4f3c\uff0c\u8fd9\u91cc\u5c31\u4e0d\u8fc7\u591a\u5206\u6790\u4e86\u3002\u9700\u8981\u5f3a\u8c03\u7684\u662f\uff0c",(0,t.jsx)(n.code,{children:"HandlerInterceptor#postHandle"})," \u7684\u6267\u884c\u65f6\u673a\u662f",(0,t.jsxs)(n.strong,{children:["\u5728\u6267\u884c\u5b8c ",(0,t.jsx)(n.code,{children:"handler"})," \u65b9\u6cd5\u540e\u4e4b\u540e\uff0c\u5728\u89c6\u56fe\u89e3\u6790\u4e4b\u524d"]}),"\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u62e6\u622a\u5668\u7684\u8fd9\u4e2a\u65b9\u6cd5\u91cc\u5904\u7406\u4e00\u4e9b\u989d\u5916\u7684\u6e32\u67d3\u53c2\u6570\u3002"]}),"\n",(0,t.jsx)(n.p,{children:"\u9650\u4e8e\u7bc7\u5e45\uff0c\u672c\u6587\u5c31\u5148\u5230\u8fd9\u91cc\u4e86\uff0crequest \u6267\u884c\u7684\u540e\u7eed\u6d41\u7a0b\uff0c\u6211\u4eec\u4e0b\u7bc7\u6587\u7ae0\u518d\u5206\u6790\u3002"}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsxs)(n.em,{children:["\u672c\u6587\u539f\u6587\u94fe\u63a5\uff1a",(0,t.jsx)(n.a,{href:"https://my.oschina.net/funcy/blog/4741104",children:"https://my.oschina.net/funcy/blog/4741104"})," \uff0c\u9650\u4e8e\u4f5c\u8005\u4e2a\u4eba\u6c34\u5e73\uff0c\u6587\u4e2d\u96be\u514d\u6709\u9519\u8bef\u4e4b\u5904\uff0c\u6b22\u8fce\u6307\u6b63\uff01\u539f\u521b\u4e0d\u6613\uff0c\u5546\u4e1a\u8f6c\u8f7d\u8bf7\u8054\u7cfb\u4f5c\u8005\u83b7\u5f97\u6388\u6743\uff0c\u975e\u5546\u4e1a\u8f6c\u8f7d\u8bf7\u6ce8\u660e\u51fa\u5904\u3002"]})})]})}function u(e={}){const{wrapper:n}={...(0,l.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},88672:(e,n,r)=>{r.d(n,{Z:()=>s,a:()=>d});var t=r(50959);const l={},a=t.createContext(l);function d(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:d(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);