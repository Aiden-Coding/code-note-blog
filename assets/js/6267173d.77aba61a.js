"use strict";(self.webpackChunkcode_note_blog=self.webpackChunkcode_note_blog||[]).push([[3815],{22606:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>u,frontMatter:()=>o,metadata:()=>c,toc:()=>s});var r=t(11527),i=t(88672);const o={},l="\u53c2\u8003\u6587\u7ae0",c={id:"Spring\u5168\u5bb6\u6876/SpringCloudAlibaba\u6e90\u7801\u5206\u6790/SpringCloudSentinel\u6e90\u7801\u5206\u6790",title:"SpringCloudSentinel\u6e90\u7801\u5206\u6790",description:"\u4f5c\u8005 | \u4e00\u8d77\u64b8Java",source:"@site/docs/Spring\u5168\u5bb6\u6876/SpringCloudAlibaba\u6e90\u7801\u5206\u6790/SpringCloudSentinel\u6e90\u7801\u5206\u6790.md",sourceDirName:"Spring\u5168\u5bb6\u6876/SpringCloudAlibaba\u6e90\u7801\u5206\u6790",slug:"/Spring\u5168\u5bb6\u6876/SpringCloudAlibaba\u6e90\u7801\u5206\u6790/SpringCloudSentinel\u6e90\u7801\u5206\u6790",permalink:"/code-note-blog/docs/Spring\u5168\u5bb6\u6876/SpringCloudAlibaba\u6e90\u7801\u5206\u6790/SpringCloudSentinel\u6e90\u7801\u5206\u6790",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Spring\u5168\u5bb6\u6876/SpringCloudAlibaba\u6e90\u7801\u5206\u6790/SpringCloudSentinel\u6e90\u7801\u5206\u6790.md",tags:[],version:"current",frontMatter:{},sidebar:"spring",previous:{title:"SpringCloudSeata\u6e90\u7801\u5206\u6790",permalink:"/code-note-blog/docs/Spring\u5168\u5bb6\u6876/SpringCloudAlibaba\u6e90\u7801\u5206\u6790/SpringCloudSeata\u6e90\u7801\u5206\u6790"},next:{title:"SpringMVC\u5e38\u89c1\u6ce8\u89e3",permalink:"/code-note-blog/docs/Spring\u5168\u5bb6\u6876/SpringMVC/SpringMVC\u5e38\u89c1\u6ce8\u89e3"}},a={},s=[];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"\u4f5c\u8005 | \u4e00\u8d77\u64b8Java\n\u6765\u6e90 |\u4eca\u65e5\u5934\u6761"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"\u5b66\u4e60\u76ee\u6807"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Sentinel\u7684\u5de5\u4f5c\u539f\u7406\n",(0,r.jsx)(n.strong,{children:"\u7b2c1\u7ae0 \u9650\u6d41\u539f\u7406"}),"\n\u5728Sentinel\u4e2d\uff0c\u6240\u6709\u7684\u8d44\u6e90\u90fd\u5bf9\u5e94\u4e00\u4e2a\u8d44\u6e90\u540d\u79f0\u4ee5\u53ca\u4e00\u4e2aEntry\u3002\u6bcf\u4e00\u4e2aentry\u53ef\u4ee5\u8868\u793a\u4e00\u4e2a\u8bf7\u6c42\u3002\u800cSentinel\u4e2d\uff0c\u4f1a\u9488\u5bf9\u5f53\u524d\u8bf7\u6c42\u57fa\u4e8e\u89c4\u5219\u7684\u5224\u65ad\u6765\u5b9e\u73b0\u6d41\u63a7\u7684\u63a7\u5236\uff0c\u539f\u7406\u5982\u4e0b\u56fe\u6240\u793a\u3002"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/1296c955070646bbc74310e726679bbabfe585.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201415Sentinel\u539f\u7406\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201415Sentinel\u539f\u7406\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"\u4e0a\u56fe\u4ec5\u4f5c\u4e3a\u8bbe\u8ba1\u601d\u60f3\u7684\u5c55\u793a\uff0c\u56fe\u4e2d Slot \u7684\u987a\u5e8f\u5df2\u548c\u6700\u65b0\u7248 Sentinel Slot Chain \u987a\u5e8f\u4e0d\u4e00\u81f4\n\u5f53\u4e00\u4e2a\u5916\u90e8\u8bf7\u6c42\u8fc7\u6765\u4e4b\u540e\uff0c\u4f1a\u521b\u5efa\u4e00\u4e2aEntry\uff0c\u800c\u521b\u5efaEntry\u7684\u540c\u65f6\uff0c\u4e5f\u4f1a\u521b\u5efa\u4e00\u7cfb\u5217\u7684slot \u7ec4\u6210\u4e00\u4e2a\u8d23\u4efb\u94fe\uff0c\u6bcf\u4e2aslot\u6709\u4e0d\u540c\u7684\u5de5\u4f5c\u804c\u8d23\u3002"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"NodeSelectorSlot \u8d1f\u8d23\u6536\u96c6\u8d44\u6e90\u7684\u8def\u5f84\uff0c\u5e76\u5c06\u8fd9\u4e9b\u8d44\u6e90\u7684\u8c03\u7528\u8def\u5f84\uff0c\u4ee5\u6811\u72b6\u7ed3\u6784\u5b58\u50a8\u8d77\u6765\uff0c\u7528\u4e8e\u6839\u636e\u8c03\u7528\u8def\u5f84\u6765\u9650\u6d41\u964d\u7ea7\uff1b"}),"\n",(0,r.jsx)(n.li,{children:"ClusterBuilderSlot \u5219\u7528\u4e8e\u5b58\u50a8\u8d44\u6e90\u7684\u7edf\u8ba1\u4fe1\u606f\u4ee5\u53ca\u8c03\u7528\u8005\u4fe1\u606f\uff0c\u4f8b\u5982\u8be5\u8d44\u6e90\u7684 RT, QPS,thread count \u7b49\u7b49\uff0c\u8fd9\u4e9b\u4fe1\u606f\u5c06\u7528\u4f5c\u4e3a\u591a\u7ef4\u5ea6\u9650\u6d41\uff0c\u964d\u7ea7\u7684\u4f9d\u636e\uff1b"}),"\n",(0,r.jsx)(n.li,{children:"StatisticSlot \u5219\u7528\u4e8e\u8bb0\u5f55\u3001\u7edf\u8ba1\u4e0d\u540c\u7eac\u5ea6\u7684 runtime \u6307\u6807\u76d1\u63a7\u4fe1\u606f\uff1b"}),"\n",(0,r.jsx)(n.li,{children:"FlowSlot \u5219\u7528\u4e8e\u6839\u636e\u9884\u8bbe\u7684\u9650\u6d41\u89c4\u5219\u4ee5\u53ca\u524d\u9762 slot \u7edf\u8ba1\u7684\u72b6\u6001\uff0c\u6765\u8fdb\u884c\u6d41\u91cf\u63a7\u5236\uff1b"}),"\n",(0,r.jsx)(n.li,{children:"AuthoritySlot \u5219\u6839\u636e\u914d\u7f6e\u7684\u9ed1\u767d\u540d\u5355\u548c\u8c03\u7528\u6765\u6e90\u4fe1\u606f\uff0c\u6765\u505a\u9ed1\u767d\u540d\u5355\u63a7\u5236\uff1b"}),"\n",(0,r.jsx)(n.li,{children:"DegradeSlot \u5219\u901a\u8fc7\u7edf\u8ba1\u4fe1\u606f\u4ee5\u53ca\u9884\u8bbe\u7684\u89c4\u5219\uff0c\u6765\u505a\u7194\u65ad\u964d\u7ea7\uff1b"}),"\n",(0,r.jsx)(n.li,{children:"SystemSlot \u5219\u901a\u8fc7\u7cfb\u7edf\u7684\u72b6\u6001\uff0c\u4f8b\u5982 load1 \u7b49\uff0c\u6765\u63a7\u5236\u603b\u7684\u5165\u53e3\u6d41\u91cf\uff1b"}),"\n",(0,r.jsx)(n.li,{children:"LogSlot \u5728\u51fa\u73b0\u9650\u6d41\u3001\u7194\u65ad\u3001\u7cfb\u7edf\u4fdd\u62a4\u65f6\u8d1f\u8d23\u8bb0\u5f55\u65e5\u5fd7"}),"\n",(0,r.jsx)(n.li,{children:"...\nSentinel \u5c06 ProcessorSlot \u4f5c\u4e3a SPI \u63a5\u53e3\u8fdb\u884c\u6269\u5c55\uff081.7.2 \u7248\u672c\u4ee5\u524d SlotChainBuilder \u4f5c\u4e3aSPI\uff09\uff0c\u4f7f\u5f97 Slot Chain \u5177\u5907\u4e86\u6269\u5c55\u7684\u80fd\u529b\u3002\u60a8\u53ef\u4ee5\u81ea\u884c\u52a0\u5165\u81ea\u5b9a\u4e49\u7684 slot \u5e76\u7f16\u6392 slot \u95f4\u7684\u987a\u5e8f\uff0c\u4ece\u800c\u53ef\u4ee5\u7ed9 Sentinel \u6dfb\u52a0\u81ea\u5b9a\u4e49\u7684\u529f\u80fd\u3002"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/d65c2688084bf5be06d3687ce8663cb1b7167b.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201415Sentinel\u539f\u7406\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201415Sentinel\u539f\u7406\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),(0,r.jsx)(n.strong,{children:"Spring Cloud \u96c6\u6210Sentinel\u7684\u539f\u7406"})]}),"\n",(0,r.jsx)(n.p,{children:"Spring Cloud \u4e2d\u96c6\u6210Sentinel\u9650\u6d41\uff0c\u662f\u57fa\u4e8e\u62e6\u622a\u5668\u6765\u5b9e\u73b0\uff0c\u5177\u4f53\u7684\u5b9e\u73b0\u8def\u5f84\u5982\u4e0b\u3002"}),"\n",(0,r.jsx)(n.p,{children:"SentinelWebAutoConfiguration\u2014\u2014>addInterceptors\u2014\u2014>SentinelWebInterceptor->AbstractSentinelInterceptor"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"public boolean preHandle(HttpServletRequest request, HttpServletResponseresponse, Object handler) throws Exception {  try {    String resourceName = this.getResourceName(request);    if (StringUtil.isEmpty(resourceName)) {      return true;   } else if (this.increaseReferece(request,this.baseWebMvcConfig.getRequestRefName(), 1) != 1) {      return true;   } else {      String origin = this.parseOrigin(request);      String contextName = this.getContextName(request);      ContextUtil.enter(contextName, origin);      Entry entry = SphU.entry(resourceName, 1, EntryType.IN);     request.setAttribute(this.baseWebMvcConfig.getRequestAttributeName(), entry);      return true;   } } catch (BlockException var12) {    BlockException e = var12;    try {      this.handleBlockException(request, response, e);   } finally {      ContextUtil.exit();   }    return false; }}\n"})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u8d44\u6e90\u8c03\u7528\u7684\u6d41\u91cf\u7c7b\u578b\uff0c\u662f\u5165\u53e3\u6d41\u91cf\uff08 EntryType.IN \uff09\u8fd8\u662f\u51fa\u53e3\u6d41\u91cf\uff08 EntryType.OUT \uff09\uff0c\u6ce8\u610f\u7cfb\u7edf\u89c4\u5219\u53ea\u5bf9 IN \u751f\u6548"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u7b2c2\u7ae0 SphU.entry"}),"\n\u4e0d\u7ba1\u662f\u96c6\u6210dubbo\u4e5f\u597d\uff0c\u8fd8\u662f\u96c6\u6210\u5230spring cloud\u4e2d\u4e5f\u597d\uff0c\u6700\u7ec8\u90fd\u662f\u8c03\u7528SphU.entry\u8fd9\u4e2a\u65b9\u6cd5\u6765\u8fdb\u884c\u9650\u6d41\u5224\u65ad\u7684\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u4eceSphU.entry\u8fd9\u4e2a\u65b9\u6cd5\u4e2d\u53bb\u4e86\u89e3\u5b83\u7684\u5b9e\u73b0\u539f\u7406\u3002"]}),"\n",(0,r.jsx)(n.p,{children:"\u4ee3\u7801\u4e2d\u6211\u4eec\u53ef\u80fd\u552f\u4e00\u7591\u60d1\u7684\uff0c\u4e5f\u662f\u6700\u5173\u952e\u7684\u4e00\u6b65\u662f SphU.entry(resource) \uff0c \u6211\u4eec\u4f20\u8fdb\u53bb\u4e86\u4e00\u4e2a\u8d44\u6e90\uff0c\u8fd9\u4e2a\u8d44\u6e90\u53ef\u7528\u662f\u65b9\u6cd5\u540d\uff0c\u53ef\u4ee5\u662f\u63a5\u53e3\uff0c\u90a3\u4e48\u4ed6\u5177\u4f53\u505a\u4e86\u4ec0\u4e48\u5462\uff1f\u8ba9\u6211\u4eec\u6765\u4e00\u6b65\u6b65\u63ed\u5f00\u4ed6\u7684\u795e\u79d8\u9762\u7eb1\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"public static Entry entry(String name) throws BlockException {    return Env.sph.entry(name, EntryType.OUT, 1, OBJECTS0);}public class Env {    public static final Sph sph = new CtSph();    ......//\u7701\u7565\u90e8\u5206\u4ee3\u7801}\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u4ece SphU.entry() \u65b9\u6cd5\u5f80\u4e0b\u6267\u884c\u4f1a\u8fdb\u5165\u5230 Sph.entry() \uff0cSph\u7684\u9ed8\u8ba4\u5b9e\u73b0\u7c7b\u662f CtSph,\u800c\u6700\u7ec8\u4f1a\u8fdb\u5165CtSph \u7684entry \u65b9\u6cd5\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"@Overridepublic Entry entry(String name, EntryType type, int count, Object... args) throws BlockException {\u3000\u3000 //\u5c01\u88c5\u4e86\u4e00\u4e2a\u8d44\u6e90\u5bf9\u8c61    StringResourceWrapper resource = new StringResourceWrapper(name, type);    return entry(resource, count, args);}\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u8fd9\u91cc\u7684\u4e3b\u8981\u6b65\u9aa4\u662f\u901a\u8fc7\u6211\u4eec\u7ed9\u5b9a\u7684\u8d44\u6e90\u53bb\u5c01\u88c5\u4e86\u4e00\u4e2a StringResourceWrapper \uff0c\u7136\u540e\u4f20\u5165\u81ea\u5df1\u7684\u91cd\u8f7d\u65b9\u6cd5\uff0c\u7ee7\u800c\u8c03\u7528 entryWithPriority(resourceWrapper, count, false, args)\uff1a"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"ResourceWrapper \u8868\u793asentinel\u7684\u8d44\u6e90\uff0c\u505a\u4e86\u5c01\u88c5"}),"\n",(0,r.jsx)(n.li,{children:"count\u8868\u793a\u672c\u6b21\u8bf7\u6c42\u7684\u5360\u7528\u7684\u5e76\u53d1\u6570\u91cf\uff0c\u9ed8\u8ba4\u662f1"}),"\n",(0,r.jsx)(n.li,{children:"prioritized\uff0c\u4f18\u5148\u7ea7"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'private Entry entryWithPriority(ResourceWrapper resourceWrapper, int count,boolean prioritized, Object... args)    throws BlockException {    //\u83b7\u53d6\u4e0a\u4e0b\u6587\u73af\u5883\uff0c\u5b58\u50a8\u5728ThreadLocal\u4e2d\uff0ccontext\u4e2d\u4f1a\u5b58\u50a8\u6574\u4e2a\u8c03\u7528\u94fe    Context context = ContextUtil.getContext();    //\u5982\u679c\u662f NullContext\uff0c\u90a3\u4e48\u8bf4\u660e context name \u8d85\u8fc7\u4e86 2000 \u4e2a\uff0c\u53c2\u89c1 ContextUtil#trueEnter    //\u8fd9\u4e2a\u65f6\u5019\uff0cSentinel \u4e0d\u518d\u63a5\u53d7\u5904\u7406\u65b0\u7684 context \u914d\u7f6e\uff0c\u4e5f\u5c31\u662f\u4e0d\u505a\u8fd9\u4e9b\u65b0\u7684\u63a5\u53e3\u7684\u7edf\u8ba1\u3001\u9650\u6d41\u7194\u65ad\u7b49    if (context instanceof NullContext) {        // The {@link NullContext} indicates that the amount of context has exceeded the threshold,        // so here init the entry only. No rule checking will be done.        return new CtEntry(resourceWrapper, null, context);    }    if (context == null) {//\u4f7f\u7528\u9ed8\u8ba4context        // \u751f\u6210Context\u7684\u90e8\u5206        context = InternalContextUtil.internalEnter(Constants.CONTEXT_DEFAULT_NAME);    }    // Global switch is close, no rule checking will do.    if (!Constants.ON) {//\u5168\u5c40\u9650\u6d41\u5f00\u5173\u662f\u5426\u5df2\u7ecf\u5f00\u542f\uff0c\u5982\u679c\u5173\u95ed\u4e86\uff0c\u5c31\u4e0d\u8fdb\u884c\u9650\u6d41\u89c4\u5219\u68c0\u67e5        return new CtEntry(resourceWrapper, null, context);    }    //\u8bbe\u8ba1\u6a21\u5f0f\u4e2d\u7684\u8d23\u4efb\u94fe\u6a21\u5f0f\u3002    //\u6784\u5efa\u4e00\u4e2aslot\u94fe\u8868    ProcessorSlot<Object> chain = lookProcessChain(resourceWrapper);    //\u6839\u636e lookProcessChain \u65b9\u6cd5\uff0c\u6211\u4eec\u77e5\u9053\uff0c\u5f53 resource \u8d85\u8fc7 Constants.MAX_SLOT_CHAIN_SIZE\uff0c    // \u4e5f\u5c31\u662f 6000 \u7684\u65f6\u5019\uff0cSentinel \u5f00\u59cb\u4e0d\u5904\u7406\u65b0\u7684\u8bf7\u6c42\uff0c\u8fd9\u4e48\u505a\u4e3b\u8981\u662f\u4e3a\u4e86 Sentinel \u7684\u6027\u80fd\u8003\u8651    if (chain == null) {        return new CtEntry(resourceWrapper, null, context);    }    //\u4e0b\u9762\u8fd9\u91cc\u624d\u771f\u6b63\u5f00\u59cb\uff0c\u751f\u6210\u4e2aentry    Entry e = new CtEntry(resourceWrapper, chain, context);    try {        //\u5f00\u59cb\u68c0\u6d4b\u9650\u6d41\u89c4\u5219        chain.entry(context, resourceWrapper, null, count, prioritized, args);    } catch (BlockException e1) {        e.exit(count, args); //\u88ab\u9650\u6d41\uff0c\u629b\u51fa\u5f02\u5e38\u3002        throw e1;    } catch (Throwable e1) {        // This should not happen, unless there are errors existing in Sentinel internal.        RecordLog.info("Sentinel unexpected exception", e1);    }    return e;//\u8fd4\u56de\u6b63\u5e38\u7684\u7ed3\u679c}\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u4ece\u4e0a\u9762\u7684\u4ee3\u7801\u6211\u4eec\u53ef\u4ee5\u77e5\u9053\uff0c\u8be5\u65b9\u6cd5\u4e2d\u4e3b\u8981\u662f\u83b7\u53d6\u5230\u4e86\u672c\u8d44\u6e90\u6240\u5bf9\u5e94\u7684\u8d44\u6e90\u5904\u7406\u94fe\uff0c\u4ece\u8d77\u547d\u540d lookProcessChain \u4e2d\u53d1\u73b0\uff0c\u5c31\u662f\u53bb\u83b7\u53d6\u5230\u4e00\u6761\u5904\u7406\u94fe\uff0c\u53bb\u6267\u884c\u8d44\u6e90\u7684\u6574\u5408\u5904\u7406\uff0c\u5f53\u7136\uff0c\u8fd9\u91cc\u5904\u4e8e\u9650\u6d41\u7684\u73af\u5883\u4e0b\uff0c\u90a3\u4e48\u8fd9\u4e2a\u5904\u7406\u94fe\u80af\u5b9a\u662f\u5bf9\u4e8e\u5f53\u524d\u73af\u5883\u4e0b\u8bf7\u6c42\u7684\u6d41\u91cf\u6574\u5408\u9650\u6d41\u76f8\u5173\u7684\u5904\u7406\u3002\u53ef\u4ee5\u5206\u4e3a\u4ee5\u4e0b\u51e0\u4e2a\u90e8\u5206\uff1a"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u5bf9\u53c2\u5168\u5c40\u914d\u7f6e\u9879\u505a\u68c0\u6d4b\uff0c\u5982\u679c\u4e0d\u7b26\u5408\u8981\u6c42\u5c31\u76f4\u63a5\u8fd4\u56de\u4e86\u4e00\u4e2aCtEntry\u5bf9\u8c61\uff0c\u4e0d\u4f1a\u518d\u8fdb\u884c\u540e\u9762\u7684\u9650\u6d41\u68c0\u6d4b\uff0c\u5426\u5219\u8fdb\u5165\u4e0b\u9762\u7684\u68c0\u6d4b\u6d41\u7a0b\u3002\u6839\u636e\u5305\u88c5\u8fc7\u7684\u8d44\u6e90\u5bf9\u8c61\u83b7\u53d6\u5bf9\u5e94\u7684SlotChain"}),"\n",(0,r.jsx)(n.li,{children:"\u6267\u884cSlotChain\u7684entry\u65b9\u6cd5\uff0c\u5982\u679cSlotChain\u7684entry\u65b9\u6cd5\u629b\u51fa\u4e86BlockException\uff0c\u5219\u5c06\u8be5\u5f02\u5e38\u7ee7\u7eed\u5411\u4e0a\u629b\u51fa\uff0c\u5982\u679cSlotChain\u7684entry\u65b9\u6cd5\u6b63\u5e38\u6267\u884c\u4e86\uff0c\u5219\u6700\u540e\u4f1a\u5c06\u8be5entry\u5bf9\u8c61\u8fd4\u56de"}),"\n",(0,r.jsxs)(n.li,{children:["\u5982\u679c\u4e0a\u5c42\u65b9\u6cd5\u6355\u83b7\u4e86BlockException\uff0c\u5219\u8bf4\u660e\u8bf7\u6c42\u88ab\u9650\u6d41\u4e86\uff0c\u5426\u5219\u8bf7\u6c42\u80fd\u6b63\u5e38\u6267\u884c\n",(0,r.jsx)(n.strong,{children:"2.1 \u521b\u5efaContext"}),"\nInternalContextUtil.internalEnter---\x3etrueEnter"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"protected static Context trueEnter(String name, String origin) {    //\u4eceThreadLocal\u4e2d\u83b7\u53d6\uff0c\u7b2c\u4e00\u6b21\u80af\u5b9a\u662fnull    Context context = contextHolder.get();    if (context == null) {        //\u8fd9\u91cc\u662f\u6839\u636eContext\u7684\u540d\u5b57\u83b7\u53d6Node        Map<String, DefaultNode> localCacheNameMap = contextNameNodeMap;        DefaultNode node = localCacheNameMap.get(name);        if (node == null) {            if (localCacheNameMap.size() > Constants.MAX_CONTEXT_NAME_SIZE) {                setNullContext();                return NULL_CONTEXT;            } else {                LOCK.lock();                try {                    node = contextNameNodeMap.get(name);                    if (node == null) {                        if (contextNameNodeMap.size() > Constants.MAX_CONTEXT_NAME_SIZE) {                            setNullContext();                            return NULL_CONTEXT;                        } else {                            //\u521b\u5efa\u4e2aEntranceNode                            node = new EntranceNode(new StringResourceWrapper(name, EntryType.IN), null);                            //\u52a0\u5165\u5168\u5c40\u7684\u8282\u70b9                            // Add entrance node.                            Constants.ROOT.addChild(node);//\u52a0\u5165map\u4e2d                            Map<String, DefaultNode> newMap = new HashMap<>(contextNameNodeMap.size() + 1);                            newMap.putAll(contextNameNodeMap);                            newMap.put(name, node);                            contextNameNodeMap = newMap;                        }                    }                } finally {                    LOCK.unlock();                }            }        }        context = new Context(node, name);        context.setOrigin(origin);        //\u653e\u5165ThreadLocal\u4e2d        contextHolder.set(context);    }    return context;}\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u8fd9\u91cc\u7684\u903b\u8f91\u8fd8\u662f\u6bd4\u8f83\u7b80\u5355\u7684"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u9996\u5148\u5728ThreadLocal\u83b7\u53d6\uff0c\u83b7\u53d6\u4e0d\u5230\u5c31\u521b\u5efa\uff0c\u4e0d\u7136\u5c31\u8fd4\u56de"}),"\n",(0,r.jsx)(n.li,{children:"\u7136\u540e\u518dMap\u4e2d\u6839\u636eContextName\u627e\u4e00\u4e2aNode"}),"\n",(0,r.jsx)(n.li,{children:"\u6ca1\u6709\u627e\u5230Node\u5c31\u52a0\u9501\u7684\u65b9\u5f0f\uff0c\u521b\u5efa\u4e00\u4e2aEntranceNode\uff0c\u7136\u540e\u653e\u5165Map\u4e2d"}),"\n",(0,r.jsx)(n.li,{children:"\u521b\u5efaContext\uff0c\u8bbe\u7f6enode\uff0cname\uff0corigin\uff0c\u518d\u653e\u5165ThreadLocal\u4e2d\n\u5230\u6b64Context\u5c31\u521b\u5efa\u5b8c\u6210"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["\u76ee\u524dContext\u5bf9\u8c61\u7684\u72b6\u6001\u5982\u4e0b\u56fe",(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/a114ee154527b7fcf24169d5291c7bac87ac93.png",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201415Sentinel\u539f\u7406\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201415Sentinel\u539f\u7406\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),(0,r.jsx)(n.strong,{children:"2.2 \u6784\u5efaslot\u94fe"}),"\n\u6784\u5efa\u4e00\u4e2aslot\u94fe\uff0c\u94fe\u8def\u7684\u7ec4\u6210\u4e3a"]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"DefaultProcessorSlotChain -> NodeSelectorSlot -> ClusterBuilderSlot -> LogSlot ->StatisticSlot -> AuthoritySlot -> SystemSlot -> ParamFlowSlot -> FlowSlot -> DegradeSlot"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"ProcessorSlot<Object> lookProcessChain(ResourceWrapper resourceWrapper) {    //\u53ef\u4ee5\u770b\u51fa\uff0cchain\u94fe\u6839\u636e\u8d44\u6e90\u6765\u4f5c\u4e3akey\uff0c\u4e0d\u540c\u7684\u8d44\u6e90\u80af\u5b9a\u662f\u4e0d\u540cchain\u94fe    ProcessorSlotChain chain = chainMap.get(resourceWrapper);    if (chain == null) {////\u8fd9\u91cc\u4e0espring(\u7f13\u5b58bean) dubbo(\u53cc\u91cd\u68c0\u67e5\u9501)\u4e2d\u5982\u51fa\u4e00\u8f99\uff0c\u91c7\u7528\u7f13\u5b58\u673a\u5236        synchronized (LOCK) {            chain = chainMap.get(resourceWrapper);            if (chain == null) {                //chainMap\u5927\u5c0f\u5927\u4e8e\u4e00\u4e2a\u503c\uff0c\u4e5f\u5c31\u662fentry\u6570\u91cf\u5927\u5c0f\u9650\u5236\u4e86\uff0c\u4e00\u4e2achain\u5bf9\u5e94\u4e00\u4e2aentry                if (chainMap.size() >= Constants.MAX_SLOT_CHAIN_SIZE) {                    return null;                }                //\u6784\u5efa\u4e00\u4e2aslot chain                chain = SlotChainProvider.newSlotChain();                //\u8fd9\u91cc\u7684\u903b\u8f91\u662f\uff0c\u65b0\u5efa\u4e00\u4e2aMap\u5927\u5c0f\u662foldMap+1                Map<ResourceWrapper, ProcessorSlotChain> newMap = new                    HashMap<ResourceWrapper, ProcessorSlotChain>(                    chainMap.size() + 1);                //\u7136\u540e\u5148\u6574\u4f53\u653e\u5165oldMap\uff0c\u518d\u653e\u65b0\u5efa\u7684chain                newMap.putAll(chainMap);                newMap.put(resourceWrapper, chain); //\u6dfb\u52a0\u5230newMap\uff0c \u8fd9\u91cc\u5e94\u8be5\u662f\u8003\u8651\u907f\u514d\u9891\u7e41\u6269\u5bb9                chainMap = newMap;            }        }    }    return chain;}\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u8fd9\u91cc\u7684\u4ee3\u7801\u5f88\u6e05\u6670\u53ef\u4ee5\u53d1\u73b0\uff0c\u9996\u5148\u4ece\u7f13\u5b58\u4e2d\u83b7\u53d6\u8be5\u5904\u7406\u94fe\uff0c\u800c\u7b2c\u4e00\u6b21\u8fdb\u6765\u80af\u5b9a\u662f\u6ca1\u6709\u7684\uff0c\u6240\u4ee5\u8fd9\u91cc\u4f1a\u8d70 SlotChainProvider \u53bb\u6784\u9020\u5904\u7406\u94fe\uff0c\u6784\u9020\u5b8c\u6210\u540e\u5c06\u8d77\u653e\u5165\u7f13\u5b58\u4ee5\u5907\u4e0b\u6b21\u4f7f\u7528\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'public static ProcessorSlotChain newSlotChain() {    if (slotChainBuilder != null) {        return slotChainBuilder.build();    }    // \u8fd9\u91cc\u901a\u8fc7spi\u673a\u5236\u53bb\u521b\u5efa\u5904\u7406\u94fe\uff0c\u5982\u679c\u60f3\u81ea\u5df1\u521b\u5efaslot\u7684\u8bdd\u53ea\u9700\u8981\u6309\u7167SPI\u673a\u5236\u5b9e\u73b0SlotChainBuilder\u63a5\u53e3\u5c31\u597d    //Sentinel\u9ed8\u8ba4\u7684\u94fe\u5728sentinel-core\u5305\u4e0b\u7684META-INF.services\u4e0b    slotChainBuilder = SpiLoader.loadFirstInstanceOrDefault(SlotChainBuilder.class, DefaultSlotChainBuilder.class);    if (slotChainBuilder == null) {        // Should not go through here.        RecordLog.warn("[SlotChainProvider] Wrong state when resolving slot chain builder, using default");        slotChainBuilder = new DefaultSlotChainBuilder();    } else {        RecordLog.info("[SlotChainProvider] Global slot chain builder resolved: "                       + slotChainBuilder.getClass().getCanonicalName());    }    return slotChainBuilder.build();}\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u8fd9\u4e2a\u65b9\u6cd5\u8fdb\u884c\u4e86\u591a\u6b21\u7684\u6821\u9a8c\uff0c\u786e\u4fddbuilder \u4e0d\u4e3a\u7a7a\uff0c\u7136\u540e\u901a\u8fc7\u5176\u53bb\u6784\u9020\u8fd9\u4e2a\u5904\u7406\u94fe\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"public class DefaultSlotChainBuilder implements SlotChainBuilder {    @Override    public ProcessorSlotChain build() {        ProcessorSlotChain chain = new DefaultProcessorSlotChain();        chain.addLast(new NodeSelectorSlot());        chain.addLast(new ClusterBuilderSlot());        chain.addLast(new LogSlot());        chain.addLast(new StatisticSlot());        chain.addLast(new SystemSlot());        chain.addLast(new AuthoritySlot());        chain.addLast(new FlowSlot());        chain.addLast(new DegradeSlot());        return chain;    }}\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u5230\u4e86\u8fd9\u91cc\u6211\u4eec\u7ec8\u4e8e\u53d1\u73b0\u4e86\u8fd9\u4e2a\u5904\u7406\u94fe\u7684\u7ec4\u6210\u60c5\u51b5\uff0c\u5b98\u7f51\u4e5f\u6709\u5bf9\u5176\u8fdb\u884c\u8bf4\u660e\uff0c\u6bd5\u7adf\u662fSentinel\u7684\u9650\u6d41\u6838\u5fc3\u7b97\u6cd5\u7684\u5b9e\u73b0\u8179\u5730\uff0c\u6211\u4eec\u770b\u4e00\u4e0b\u5b98\u7f51\u7684\u4ecb\u7ecd\uff1a"}),"\n",(0,r.jsx)(n.p,{children:"\u5728 Sentinel \u91cc\u9762\uff0c\u6240\u6709\u7684\u8d44\u6e90\u90fd\u5bf9\u5e94\u4e00\u4e2a\u8d44\u6e90\u540d\u79f0\uff08resourceName\uff09\uff0c\u6bcf\u6b21\u8d44\u6e90\u8c03\u7528\u90fd\u4f1a\u521b\u5efa\u4e00\u4e2a Entry \u5bf9\u8c61\u3002Entry \u53ef\u4ee5\u901a\u8fc7\u5bf9\u4e3b\u6d41\u6846\u67b6\u7684\u9002\u914d\u81ea\u52a8\u521b\u5efa\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u6ce8\u89e3\u7684\u65b9\u5f0f\u6216\u8c03\u7528 SphU API \u663e\u5f0f\u521b\u5efa\u3002Entry \u521b\u5efa\u7684\u65f6\u5019\uff0c\u540c\u65f6\u4e5f\u4f1a\u521b\u5efa\u4e00\u7cfb\u5217\u529f\u80fd\u63d2\u69fd\uff08slot chain\uff09\uff0c\u8fd9\u4e9b\u63d2\u69fd\u6709\u4e0d\u540c\u7684\u804c\u8d23\u3002\u5177\u4f53\u804c\u8d23\u5728\u4e0a\u9762\u5df2\u7ecf\u63d0\u5230\u4e86\u3002"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"\u6574\u4f53\u6d41\u7a0b"})}),"\n",(0,r.jsx)(n.p,{children:"\u6574\u4f53\u7684\u6267\u884c\u6d41\u7a0b\u5982\u4e0b\u3002"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"NodeSelectorSlot\uff1a\u4e3b\u8981\u7528\u4e8e\u6784\u5efa\u8c03\u7528\u94fe\u3002"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"ClusterBuilderSlot\uff1a\u7528\u4e8e\u96c6\u7fa4\u9650\u6d41\u3001\u7194\u65ad\u3002"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"LogSlot\uff1a\u7528\u4e8e\u8bb0\u5f55\u65e5\u5fd7\u3002"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"StatisticSlot\uff1a\u7528\u4e8e\u5b9e\u65f6\u6536\u96c6\u5b9e\u65f6\u6d88\u606f\u3002"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"AuthoritySlot\uff1a\u7528\u4e8e\u6743\u9650\u6821\u9a8c\u7684\u3002"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"SystemSlot\uff1a\u7528\u4e8e\u9a8c\u8bc1\u7cfb\u7edf\u7ea7\u522b\u7684\u89c4\u5219\u3002"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"FlowSlot\uff1a\u5b9e\u73b0\u9650\u6d41\u673a\u5236\u3002"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["DegradeSlot\uff1a\u5b9e\u73b0\u7194\u65ad\u673a\u5236\u3002\n",(0,r.jsx)(n.strong,{children:"2.3 \u521b\u5efaEntry"})]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"Entry e = new CtEntry(resourceWrapper, chain, context);"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"CtEntry(ResourceWrapper resourceWrapper, ProcessorSlot<Object> chain, Context context) {    super(resourceWrapper);    this.chain = chain;    this.context = context;    setUpEntryFor(context);}private void setUpEntryFor(Context context) {    // The entry should not be associated to NullContext.    if (context instanceof NullContext) {        return;    }    this.parent = context.getCurEntry();    if (parent != null) {        ((CtEntry) parent).child = this;    }    context.setCurEntry(this);}\n\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u5f53\u7b2c\u4e00\u6b21Entry\u751f\u6210\u7684\u65f6\u5019\uff0ccontext.getCurEntry\u5fc5\u5b9a\u662fNULL\uff0c\u90a3\u4e48\u76f4\u63a5\u6267\u884cContext.setCurEntry\u65b9\u6cd5"}),"\n",(0,r.jsxs)(n.p,{children:["\u7136\u540e\u8fd9\u4e2aContext\u7684\u72b6\u6001\u5982\u4e0b\u56fe  ",(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/57273a794d51cfc587c923de97943491e9da0b.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201415Sentinel\u539f\u7406\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201415Sentinel\u539f\u7406\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"\u518d\u6267\u884c\u4e00\u6b21\u65b0\u7684Sphu.entry\u540e\u4f1a\u518d\u6b21\u65b0\u5efa\u4e00\u4e2aEntry\uff0c\u8fd9\u4e2a\u65f6\u5019curEntry\u4e0d\u662fnull\uff0c\u90a3\u4e48\u6267\u884c((CtEntry)parent).child = this;"]}),"\n",(0,r.jsxs)(n.p,{children:["\u7ed3\u679c\u5982\u4e0b\u56fe",(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/c3c36f101ef031102dd270287bf7635e715229.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201415Sentinel\u539f\u7406\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201415Sentinel\u539f\u7406\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"\u53ef\u4ee5\u770b\u51fa\uff0c\u539f\u6765\u7684CtEntry\u88ab\u79fb\u51faContext\uff0c\u65b0\u5efa\u7684CtEntry\u548c\u65e7CtEntry\u901a\u8fc7\u5185\u90e8\u7684parent\u548cchild\u5f15\u7528\u76f8\u8fde"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"2.4 NodeSelectorSlot"}),"\n\u8fd9\u4e2a\u7c7b\u4e3b\u8981\u7528\u4e8e\u6784\u5efa\u8c03\u7528\u94fe\uff0c\u8fd9\u4e2a\u9700\u8981\u8bb2\u89e3\u4e00\u4e0b\uff0c\u5728\u540e\u7eed\u8fc7\u7a0b\u4e2d\u4f1a\u6bd4\u8f83\u5173\u952e\uff0c\u4ee3\u7801\u5982\u4e0b\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"@Overridepublic void entry(Context context, ResourceWrapper resourceWrapper, Object obj,                  int count, boolean prioritized, Object... args)    throws Throwable {    //\u8fd9\u91cc\u6709\u4e2a\u7f13\u5b58\uff0c\u6839\u636econtext\u7684\u540d\u5b57\u7f13\u5b58node    DefaultNode node = map.get(context.getName());    //\u53cc\u91cd\u68c0\u6d4b\uff0c\u7ebf\u7a0b\u5b89\u5168    if (node == null) {        synchronized (this) {            node = map.get(context.getName());            if (node == null) {                //\u8fd9\u91cc\u751f\u6210\u7684\u662fDefaultNode\u8282\u70b9                node = new DefaultNode(resourceWrapper, null);                //\u4e0b\u9762\u8fd9\u4e9b\u903b\u8f91\u662f\u653e\u5165map\u7684\u903b\u8f91\uff0c\u56e0\u4e3a\u540e\u671fmap\u6bd4\u8f83\u5927\uff0c\u6240\u4ee5\u8fd9\u6837\u653e\u5165\uff0c\u6027\u80fd\u4f1a\u9ad8\u4e00\u4e9b                HashMap<String, DefaultNode> cacheMap = new HashMap<String,DefaultNode>(map.size());                cacheMap.putAll(map);                cacheMap.put(context.getName(), node);                map = cacheMap;                // \u5173\u952e\u5728\u8fd9\uff0c\u8fd9\u662f\u4fee\u6539\u8c03\u7528\u94fe\u6811\u7684\u5730\u65b9                ((DefaultNode) context.getLastNode()).addChild(node);            }        }    }    //\u66ff\u6362context\u4e2d\u7684curEntry\u4e2d\u7684curNode    context.setCurNode(node);    fireEntry(context, resourceWrapper, node, count, prioritized, args);}\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u67e5\u8be2\u7f13\u5b58\u4e2d\u662f\u5426\u6709\u8fd9\u4e2anode\u8fd9\u91cc\u7684\u903b\u8f91\u4e5f\u5f88\u7b80\u5355"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u6839\u636eContextName\u67e5\u8be2\u7f13\u5b58\u662f\u5426\u6709\u8fd9\u4e2aNode"}),"\n",(0,r.jsx)(n.li,{children:"\u6ca1\u6709\u5c31\u751f\u6210\u8fd9\u4e2aDefaultNode\uff0c\u653e\u5165\u7f13\u5b58\uff0c\u7136\u540e\u6784\u9020\u8c03\u7528\u6811\u94fe"}),"\n",(0,r.jsx)(n.li,{children:"Context\u7684curEntry\u4e2d\u7684curnode\u8bbe\u7f6e\u4e3a\u8fd9\u4e2anode\n\u8fd9\u91cc\u6709\u51e0\u4e2a\u5bf9\u8c61\u8981\u5355\u72ec\u8bf4\u660e\uff1a"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"1\u3001context\uff1a\u8868\u793a\u4e0a\u4e0b\u6587\uff0c\u4e00\u4e2a\u7ebf\u7a0b\u5bf9\u5e94\u4e00\u4e2acontext\uff0c\u5176\u4e2d\u5305\u542b\u4e00\u4e9b\u5c5e\u6027\u5982\u4e0b"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"name\uff1a\u540d\u5b57"}),"\n",(0,r.jsx)(n.li,{children:"entranceNode\uff1a\u8c03\u7528\u94fe\u5165\u53e3"}),"\n",(0,r.jsx)(n.li,{children:"curEntry\uff1a\u5f53\u524dentry"}),"\n",(0,r.jsx)(n.li,{children:"origin\uff1a\u8c03\u7528\u8005\u6765\u6e90"}),"\n",(0,r.jsx)(n.li,{children:"async\uff1a\u5f02\u6b65\n2\u3001Node\uff1a \u8868\u793a\u4e00\u4e2a\u8282\u70b9\uff0c\u8fd9\u4e2a\u8282\u70b9\u4f1a\u4fdd\u5b58\u67d0\u4e2a\u8d44\u6e90\u7684\u5404\u4e2a\u5b9e\u65f6\u7edf\u8ba1\u6570\u636e\uff0c\u901a\u8fc7\u8bbf\u95ee\u67d0\u4e2a\u8282\u70b9\uff0c\u5c31\u53ef\u4ee5\u83b7\u5f97\u5bf9\u5e94\u8d44\u6e90\u7684\u5b9e\u65f6\u72b6\u6001\uff0c\u6839\u636e\u8fd9\u4e2a\u4fe1\u606f\u6765\u8fdb\u884c\u9650\u6d41\u548c\u964d\u7ea7\uff0c\u5b83\u6709\u51e0\u79cd\u8282\u70b9\u7c7b\u578b"}),"\n",(0,r.jsx)(n.li,{children:"StatisticNode\uff1a\u5b9e\u73b0\u4e86Node\u63a5\u53e3\uff0c\u5c01\u88c5\u4e86\u57fa\u7840\u7684\u6d41\u91cf\u7edf\u8ba1\u548c\u83b7\u53d6\u65b9\u6cd5"}),"\n",(0,r.jsx)(n.li,{children:"DefaultNode\uff1a\u9ed8\u8ba4\u8282\u70b9\uff0cNodeSelectorSlot\u4e2d\u521b\u5efa\u7684\u5c31\u662f\u8fd9\u4e2a\u8282\u70b9\uff1b\u4ee3\u8868\u540c\u4e2a\u8d44\u6e90\u5728\u4e0d\u540c\u4e0a\u4e0b\u6587\u4e2d\u5404\u81ea\u7684\u6d41\u91cf\u60c5\u51b5"}),"\n",(0,r.jsx)(n.li,{children:"ClusterNode\uff1a\u96c6\u7fa4\u8282\u70b9\uff0c\u4ee3\u8868\u540c\u4e2a\u8d44\u6e90\u5728\u4e0d\u540c\u4e0a\u4e0b\u6587\u4e2d\u603b\u4f53\u7684\u6d41\u91cf\u60c5\u51b5"}),"\n",(0,r.jsx)(n.li,{children:"EntranceNode\uff1a\u8be5\u8282\u70b9\u8868\u793a\u4e00\u68f5\u8c03\u7528\u94fe\u6811\u7684\u5165\u53e3\u8282\u70b9\uff0c\u901a\u8fc7\u4ed6\u53ef\u4ee5\u83b7\u53d6\u8c03\u7528\u94fe\u6811\u4e2d\u6240\u6709\u7684\u5b50\u8282\u70b9\uff1b\u6bcf\u4e2a\u4e0a\u4e0b\u6587\u90fd\u4f1a\u6709\u4e00\u4e2a\u5165\u53e3\u8282\u70b9\uff0c\u7528\u6765\u7edf\u8ba1\u5f53\u524d\u4e0a\u4e0b\u6587\u7684\u603b\u4f53\u6d41\u91cf\u60c5\u51b5"}),"\n",(0,r.jsxs)(n.li,{children:["OriginNode\uff1a\u662f\u4e00\u4e2aStatisticNode\u7c7b\u578b\u7684\u8282\u70b9\uff0c\u4ee3\u8868\u4e86\u540c\u4e2a\u8d44\u6e90\u8bf7\u6c42\u6765\u6e90\u7684\u6d41\u91cf\u60c5\u51b5\n",(0,r.jsx)(n.strong,{children:"2.5 StatisticSlot"}),"\n\u5728\u6574\u4e2aslot\u94fe\u8def\u4e2d\uff0c\u6bd4\u8f83\u91cd\u8981\u7684\uff0c\u5c31\u662f\u6d41\u91cf\u6570\u636e\u7edf\u8ba1\u4ee5\u53ca\u6d41\u91cf\u89c4\u5219\u68c0\u6d4b\u8fd9\u4e24\u4e2aslot\uff0c\u6211\u4eec\u5148\u6765\u5206\u6790\u4e00\u4e0bStatisticSlot\u8fd9\u4e2a\u5bf9\u8c61\u3002"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"StatisticSlot\u662f Sentinel \u7684\u6838\u5fc3\u529f\u80fd\u63d2\u69fd\u4e4b\u4e00\uff0c\u7528\u4e8e\u7edf\u8ba1\u5b9e\u65f6\u7684\u8c03\u7528\u6570\u636e\u3002"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"clusterNode\uff1a\u8d44\u6e90\u552f\u4e00\u6807\u8bc6\u7684 ClusterNode \u7684 runtime \u7edf\u8ba1"}),"\n",(0,r.jsx)(n.li,{children:"origin\uff1a\u6839\u636e\u6765\u81ea\u4e0d\u540c\u8c03\u7528\u8005\u7684\u7edf\u8ba1\u4fe1\u606f"}),"\n",(0,r.jsx)(n.li,{children:"defaultnode: \u6839\u636e\u4e0a\u4e0b\u6587\u6761\u76ee\u540d\u79f0\u548c\u8d44\u6e90 ID \u7684 runtime \u7edf\u8ba1"}),"\n",(0,r.jsx)(n.li,{children:"\u5165\u53e3\u7684\u7edf\u8ba1"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count,                  boolean prioritized, Object... args) throws Throwable {    try {        // \u5148\u4ea4\u7531\u540e\u7eed\u7684\u9650\u6d41&\u964d\u7ea7\u7b49processorSlot\u5904\u7406\uff0c\u7136\u540e\u6839\u636e\u5904\u7406\u7ed3\u679c\u8fdb\u884c\u7edf\u8ba1        // Sentinel\u8d23\u4efb\u94fe\u7684\u7cbe\u534e\uff08\u4e0d\u4f7f\u7528 for \u5faa\u73af\u904d\u5386\u8c03\u7528 ProcessorSlot \u7684\u539f\u56e0\uff09        fireEntry(context, resourceWrapper, node, count, prioritized, args);        //\u6267\u884c\u5230\u8fd9\u91cc\u8868\u793a\u901a\u8fc7\u68c0\u67e5\uff0c\u4e0d\u88ab\u9650\u6d41        // Request passed, add thread count and pass count.        node.increaseThreadNum(); //\u5f53\u524d\u8282\u70b9\u7684\u8bf7\u6c42\u7ebf\u7a0b\u6570\u52a01        node.addPassRequest(count);        //\u9488\u5bf9\u4e0d\u540c\u7c7b\u578b\u7684node\u8bb0\u5f55\u7ebf\u7a0b\u6570\u91cf\u548c\u8bf7\u6c42\u901a\u8fc7\u6570\u91cf\u7684\u7edf\u8ba1\u3002        if (context.getCurEntry().getOriginNode() != null) {            // Add count for origin node.            context.getCurEntry().getOriginNode().increaseThreadNum();            context.getCurEntry().getOriginNode().addPassRequest(count);        }        if (resourceWrapper.getEntryType() == EntryType.IN) {            // Add count for global inbound entry node for global statistics.            Constants.ENTRY_NODE.increaseThreadNum();            Constants.ENTRY_NODE.addPassRequest(count);        }        //\u53ef\u8c03\u7528 StatisticSlotCallbackRegistry#addEntryCallback \u9759\u6001\u65b9\u6cd5\u6ce8\u518cProcessorSlotEntryCallback        for (ProcessorSlotEntryCallback<DefaultNode> handler :             StatisticSlotCallbackRegistry.getEntryCallbacks()) {            handler.onPass(context, resourceWrapper, node, count, args);        }        //\u4f18\u5148\u7ea7\u7b49\u5f85\u5f02\u5e38\uff0c\u8fd9\u4e2a\u5728FlowRule\u4e2d\u4f1a\u6709\u6d89\u53ca\u5230\u3002    } catch (PriorityWaitException ex) {//\u589e\u52a0\u7ebf\u7a0b\u7edf\u8ba1        node.increaseThreadNum();        if (context.getCurEntry().getOriginNode() != null) {            // Add count for origin node.            context.getCurEntry().getOriginNode().increaseThreadNum();        }        if (resourceWrapper.getEntryType() == EntryType.IN) {            // Add count for global inbound entry node for global statistics.            Constants.ENTRY_NODE.increaseThreadNum();        }        // Handle pass event with registered entry callback handlers.        for (ProcessorSlotEntryCallback<DefaultNode> handler :             StatisticSlotCallbackRegistry.getEntryCallbacks()) {            handler.onPass(context, resourceWrapper, node, count, args);        }    } catch (BlockException e) {        // Blocked, set block exception to current entry.        context.getCurEntry().setBlockError(e); //\u8bbe\u7f6e\u9650\u6d41\u5f02\u5e38\u5230\u5f53\u524dentry\u4e2d        // Add block count.        node.increaseBlockQps(count); //\u589e\u52a0\u88ab\u9650\u6d41\u7684\u6570\u91cf        //\u6839\u636e\u4e0d\u540cNode\u7c7b\u578b\u589e\u52a0\u963b\u585e\u9650\u6d41\u7684\u6b21\u6570        if (context.getCurEntry().getOriginNode() != null) {            context.getCurEntry().getOriginNode().increaseBlockQps(count);        }        if (resourceWrapper.getEntryType() == EntryType.IN) {            // Add count for global inbound entry node for global statistics.            Constants.ENTRY_NODE.increaseBlockQps(count);        }        // Handle block event with registered entry callback handlers.        for (ProcessorSlotEntryCallback<DefaultNode> handler :             StatisticSlotCallbackRegistry.getEntryCallbacks()) {            handler.onBlocked(e, context, resourceWrapper, node, count, args);        }        throw e;    } catch (Throwable e) {        // Unexpected internal error, set error to current entry.        context.getCurEntry().setError(e);        throw e;    }}\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u4ee3\u7801\u5206\u6210\u4e86\u4e24\u90e8\u5206\uff0c\u7b2c\u4e00\u90e8\u5206\u662fentry\u65b9\u6cd5\uff0c\u8be5\u65b9\u6cd5\u9996\u5148\u4f1a\u89e6\u53d1\u540e\u7eedslot\u7684entry\u65b9\u6cd5\uff0c\u5373SystemSlot\u3001FlowSlot\u3001DegradeSlot\u7b49\u7684\u89c4\u5219\uff0c\u5982\u679c\u89c4\u5219\u4e0d\u901a\u8fc7\uff0c\u5c31\u4f1a\u629b\u51faBlockException\uff0c\u5219\u4f1a\u5728node\u4e2d\u7edf\u8ba1\u88abblock\u7684\u6570\u91cf\u3002\u53cd\u4e4b\u4f1a\u5728node\u4e2d\u7edf\u8ba1\u901a\u8fc7\u7684\u8bf7\u6c42\u6570\u548c\u7ebf\u7a0b\u6570\u7b49\u4fe1\u606f\u3002\u7b2c\u4e8c\u90e8\u5206\u662f\u5728exit\u65b9\u6cd5\u4e2d\uff0c\u5f53\u9000\u51fa\u8be5Entry\u5165\u53e3\u65f6\uff0c\u4f1a\u7edf\u8ba1rt\u7684\u65f6\u95f4\uff0c\u5e76\u51cf\u5c11\u7ebf\u7a0b\u6570\u3002"}),"\n",(0,r.jsx)(n.p,{children:"\u6211\u4eec\u53ef\u4ee5\u770b\u5230 node.addPassRequest() \u8fd9\u6bb5\u4ee3\u7801\u662f\u5728fireEntry\u6267\u884c\u4e4b\u540e\u6267\u884c\u7684\uff0c\u8fd9\u610f\u5473\u7740\uff0c\u5f53\u524d\u8bf7\u6c42\u901a\u8fc7\u4e86sentinel\u7684\u6d41\u63a7\u7b49\u89c4\u5219\uff0c\u6b64\u65f6\u9700\u8981\u5c06\u5f53\u6b21\u8bf7\u6c42\u8bb0\u5f55\u4e0b\u6765\uff0c\u4e5f\u5c31\u662f\u6267\u884c node.addPassRequest()\u8fd9\u884c\u4ee3\u7801\uff0c\u6211\u4eec\u8ddf\u8fdb\u53bb\u770b\u770b\uff1a"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"2.5.1 addPassRequest"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"@Overridepublic void addPassRequest(int count) {    // \u8c03\u7528\u7236\u7c7b\uff08StatisticNode\uff09\u6765\u8fdb\u884c\u7edf\u8ba1    super.addPassRequest(count);    // \u6839\u636eclusterNode \u6c47\u603b\u7edf\u8ba1\uff08\u80cc\u540e\u4e5f\u662f\u8c03\u7528\u7236\u7c7bStatisticNode\uff09    this.clusterNode.addPassRequest(count);}\n\u9996\u5148\u6211\u4eec\u77e5\u9053\u8fd9\u91cc\u7684node\u662f\u4e00\u4e2a DefaultNode \u5b9e\u4f8b\uff0c\u5728\u7b2c\u4e00\u4e2aNodeSelectorSlot \u7684entry\u65b9\u6cd5\u4e2d\u5bf9\u8d44\u6e90\u8fdb\u884c\u4e86\u5c01\u88c5\uff0c\u5c01\u88c5\u6210\u4e86\u4e00\u4e2aDefaultNode\u3002\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"DefaultNode\uff1a\u4fdd\u5b58\u7740\u67d0\u4e2aresource\u5728\u67d0\u4e2acontext\u4e2d\u7684\u5b9e\u65f6\u6307\u6807\uff0c\u6bcf\u4e2aDefaultNode\u90fd\u6307\u5411\u4e00\u4e2aClusterNode"}),"\n",(0,r.jsx)(n.li,{children:"ClusterNode\uff1a\u4fdd\u5b58\u7740\u67d0\u4e2aresource\u5728\u6240\u6709\u7684context\u4e2d\u5b9e\u65f6\u6307\u6807\u7684\u603b\u548c\uff0c\u540c\u6837\u7684resource\u4f1a\u5171\u4eab\u540c\u4e00\u4e2aClusterNode\uff0c\u4e0d\u7ba1\u4ed6\u5728\u54ea\u4e2acontext\u4e2d\n\u5206\u522b\u8c03\u7528\u4e24\u4e2a\u65f6\u95f4\u7a97\u53e3\u6765\u9012\u589e\u8bf7\u6c42\u6570\u91cf\u3002"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"\u5185\u90e8\u5b9e\u9645\u8c03\u7528\u7684\u662fArrayMetric\u6765\u8fdb\u884c\u8bf7\u6c42\u6570\u91cf\u7684\u7edf\u8ba1"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"//\u6309\u7167\u79d2\u6765\u7edf\u8ba1\uff0c\u5206\u6210\u4e24\u4e2a\u7a97\u53e3\uff0c\u6bcf\u4e2a\u7a97\u53e3500ms\uff0c\u7528\u6765\u7edf\u8ba1QPSprivate transient volatile Metric rollingCounterInSecond = new ArrayMetric(SampleCountProperty.SAMPLE_COUNT,        IntervalProperty.INTERVAL);//\u6309\u7167\u5206\u949f\u7edf\u8ba1\uff0c\u751f\u621060\u4e2a\u7a97\u53e3\uff0c\u6bcf\u4e2a\u7a97\u53e31000msprivate transient Metric rollingCounterInMinute = new ArrayMetric(60, 60 * 1000, false);public void addPassRequest(int count) {    rollingCounterInSecond.addPass(count);    rollingCounterInMinute.addPass(count);}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u8fd9\u91cc\u91c7\u7528\u7684\u662f\u6ed1\u52a8\u7a97\u53e3\u7684\u65b9\u5f0f\u6765\u8bb0\u5f55\u8bf7\u6c42\u7684\u6b21\u6570\u3002",(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/e4624bb214fd8020d1447098c8cde98a554e59.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201415Sentinel\u539f\u7406\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201415Sentinel\u539f\u7406\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"\u6574\u4e2a\u7c7b\u7684\u5173\u7cfb\u56fe\u5b9e\u9645\u4e0a\u662f\u6bd4\u8f83\u6e05\u6670\u7684\uff0cArrayMetric\u5b9e\u9645\u4e0a\u662f\u4e00\u4e2a\u5305\u88c5\u7c7b\uff0c\u5185\u90e8\u901a\u8fc7LeapArray\u6765\u5b9e\u73b0\u5177\u4f53\u7684\u7edf\u8ba1\u903b\u8f91\uff0c\u800cLeapArray\u4e2d\u7ef4\u62a4\u4e86\u591a\u4e2aWindowWrap\uff08\u6ed1\u52a8\u7a97\u53e3\uff09\uff0c\u800cWindowWrap\u4e2d\u91c7\u7528\u4e86MetricBucket\u6765\u8fdb\u884c\u6307\u6807\u6570\u636e\u7684\u7edf\u8ba1\u3002"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Metric: \u6307\u6807\u6536\u96c6\u7684\u63a5\u53e3\uff0c\u5b9a\u4e49\u6ed1\u52a8\u7a97\u53e3\u4e2d\u6210\u529f\u6570\u91cf\u3001\u5f02\u5e38\u6570\u91cf\u3001\u963b\u585e\u6570\u91cf\u3001TPS\u3001\u54cd\u5e94\u65f6\u95f4\u7b49\u6570\u636e"}),"\n",(0,r.jsx)(n.li,{children:"ArrayMetric \u6ed1\u52a8\u7a97\u53e3\u6838\u5fc3\u5b9e\u73b0\u7c7b"}),"\n",(0,r.jsx)(n.li,{children:"LeapArray"}),"\n",(0,r.jsx)(n.li,{children:"WindowWrap \u6bcf\u4e00\u4e2a\u6ed1\u52a8\u7a97\u53e3\u7684\u5305\u88c5\u7c7b\uff0c\u5185\u90e8\u7684\u6570\u636e\u7ed3\u6784\u91c7\u7528MetricBucket"}),"\n",(0,r.jsx)(n.li,{children:"MetricBucket\uff0c \u8868\u793a\u6307\u6807\u6876\uff0c\u5305\u542b\u963b\u585e\u6570\u91cf\u3001\u5f02\u5e38\u6570\u91cf\u3001\u6210\u529f\u6570\u3001\u54cd\u5e94\u65f6\u95f4\u7b49"}),"\n",(0,r.jsxs)(n.li,{children:["MetricEvent \u6307\u6807\u7c7b\u578b\uff0c\u901a\u8fc7\u6570\u3001\u963b\u585e\u6570\u3001\u5f02\u5e38\u6570\u3001\u6210\u529f\u6570\u7b49\n",(0,r.jsx)(n.strong,{children:"2.5.2 ArrayMetric.addPass"}),"\n\u7ee7\u7eed\u6cbf\u7740\u4ee3\u7801\u5f80\u4e0b\u770b\uff0c\u8fdb\u5165\u5230ArrayMetric.addPass\u65b9\u6cd5\u3002"]}),"\n",(0,r.jsx)(n.li,{children:"\u4eceLeapArray\u4e2d\u6839\u636e\u5f53\u524d\u65f6\u95f4\u70b9\u5f97\u5230\u5bf9\u5e94\u7684\u7a97\u53e3"}),"\n",(0,r.jsx)(n.li,{children:"\u8c03\u7528MetricBucket\u4e2d\u7684addPass\u65b9\u6cd5\uff0c\u589e\u52a0\u5f53\u524d\u7a97\u53e3\u4e2d\u7684\u7edf\u8ba1\u6b21\u6570"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"\u4ece\u4ee3\u7801\u4e2d\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c\u589e\u52a0\u6307\u6807\u8c03\u7528 addPass \u662f\u901a\u8fc7\u4e00\u4e2a\u53eb ArrayMetric \u7684\u7c7b\uff0c\u73b0\u5728\u6211\u4eec\u5728\u8fdb\u5165 ArrayMetric \u4e2d\u770b\u4e00\u4e0b\u3002\u5177\u4f53\u7684\u4ee3\u7801\u5982\u4e0b\u6240\u793a\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"private final LeapArray<MetricBucket> data;// SAMPLE_COUNT=2  INTERVAL=1000public ArrayMetric(int sampleCount, int intervalInMs) {  //\u8fd9\u4e24\u4e2a\u53c2\u6570\u8868\u793a\uff0c\u6ed1\u52a8\u7a97\u53e3\u7684\u5927\u5c0f\u662f2\u4e2a\uff0c\u6bcf\u4e00\u4e2a\u6ed1\u52a8\u7a97\u53e3\u7684\u65f6\u95f4\u5355\u4f4d\u662f500ms    this.data = new OccupiableBucketLeapArray(sampleCount, intervalInMs);}public void addPass(int count) {    WindowWrap<MetricBucket> wrap = data.currentWindow();    wrap.value().addPass(count);}\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u8fd9\u91cc\u7ec8\u4e8e\u51fa\u73b0\u4e86\u4e0e\u6ed1\u52a8\u7a97\u53e3\u6709\u90a3\u4e48\u70b9\u5173\u8054\u7684 window\u4e86\uff0cwindow\u4e0d\u5c31\u662f\u7a97\u6237\u561b\uff0c\u8fd9\u91cc\u901a\u8fc7 data \u6765\u83b7\u53d6\u5f53\u524d\u7a97\u53e3\u3002\u800c\u8fd9\u91cc\u7684\u7a97\u53e3\u5927\u5c0f\u4e3a sampleCount=2.\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u91cc\u662f\u901a\u8fc7 MetricBucket \u6765\u4fdd\u5b58\u5404\u9879\u6307\u6807\uff0c\u5176\u4e2d\u7ef4\u62a4\u4e86\u4e00\u4e2a\u7edf\u8ba1\u662f\u6570\u7ec4LongAdder[] counters \u6765\u4fdd\u5b58\uff0c\u800c WindowWrap\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6bcf\u4e00\u4e2a WindowWrap\u5bf9\u8c61\u7531\u4e09\u4e2a\u90e8\u5206\u7ec4\u6210\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"public class WindowWrap<T> {\u3000\u3000// \u65f6\u95f4\u7a97\u53e3\u7684\u957f\u5ea6    private final long windowLengthInMs;\u3000\u3000// \u65f6\u95f4\u7a97\u53e3\u7684\u5f00\u59cb\u65f6\u95f4\uff0c\u5355\u4f4d\u662f\u6beb\u79d2    private long windowStart;\u3000\u3000 //\u65f6\u95f4\u7a97\u53e3\u7684\u5185\u5bb9\uff0c\u5728 WindowWrap \u4e2d\u662f\u7528\u6cdb\u578b\u8868\u793a\u8fd9\u4e2a\u503c\u7684\uff0c\u4f46\u5b9e\u9645\u4e0a\u5c31\u662f MetricBucket \u7c7b    private T value;    //......\u7701\u7565\u90e8\u5206\u4ee3\u7801}\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u518d\u770b LeapArray \u8fd9\u4e2a\u7c7b\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"public abstract class LeapArray<T> {    // \u65f6\u95f4\u7a97\u53e3\u7684\u957f\u5ea6    protected int windowLength;    // \u91c7\u6837\u7a97\u53e3\u7684\u4e2a\u6570    protected int sampleCount;    // \u4ee5\u6beb\u79d2\u4e3a\u5355\u4f4d\u7684\u65f6\u95f4\u95f4\u9694    protected int intervalInMs;    // \u91c7\u6837\u7684\u65f6\u95f4\u7a97\u53e3\u6570\u7ec4    protected AtomicReferenceArray<WindowWrap<T>> array;    /**     * LeapArray\u5bf9\u8c61     * @param windowLength \u65f6\u95f4\u7a97\u53e3\u7684\u957f\u5ea6\uff0c\u5355\u4f4d\uff1a\u6beb\u79d2     * @param intervalInSec \u7edf\u8ba1\u7684\u95f4\u9694\uff0c\u5355\u4f4d\uff1a\u79d2     */    public LeapArray(int windowLength, int intervalInSec) {        this.windowLength = windowLength;        // \u65f6\u95f4\u7a97\u53e3\u7684\u91c7\u6837\u4e2a\u6570\uff0c\u9ed8\u8ba4\u4e3a2\u4e2a\u91c7\u6837\u7a97\u53e3        this.sampleCount = intervalInSec * 1000 / windowLength;        this.intervalInMs = intervalInSec * 1000;//\u5728\u4ee5\u79d2\u4e3a\u5355\u4f4d\u7684\u65f6\u95f4\u7a97\u53e3\u4e2d\uff0c\u4f1a\u521d\u59cb\u5316\u4e24\u4e2a\u957f\u5ea6\u7684\u6570\u7ec4\uff1a`AtomicReferenceArray<WindowWrap<T>>array`\uff0c\u8fd9\u4e2a\u6570\u7ec4\u8868\u793a\u6ed1\u52a8\u7a97\u53e3\u7684\u5927\u5c0f\u3002\u5176\u4e2d\uff0c\u6bcf\u4e2a\u7a97\u53e3\u4f1a\u5360\u7528500ms\u7684\u65f6\u95f4\u3002        this.array = new AtomicReferenceArray<WindowWrap<T>>(sampleCount);    }}\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u53ef\u4ee5\u5f88\u6e05\u6670\u7684\u770b\u51fa\u6765\u5728 LeapArray \u4e2d\u521b\u5efa\u4e86\u4e00\u4e2a AtomicReferenceArray \u6570\u7ec4\uff0c\u7528\u6765\u5bf9\u65f6\u95f4\u7a97\u53e3\u4e2d\u7684\u7edf\u8ba1\u503c\u8fdb\u884c\u91c7\u6837\u3002\u901a\u8fc7\u91c7\u6837\u7684\u7edf\u8ba1\u503c\u518d\u8ba1\u7b97\u51fa\u5e73\u5747\u503c\uff0c\u5c31\u662f\u6211\u4eec\u9700\u8981\u7684\u6700\u7ec8\u7684\u5b9e\u65f6\u6307\u6807\u7684\u503c\u4e86\u3002\u53ef\u4ee5\u770b\u5230\u6211\u5728\u4e0a\u9762\u7684\u4ee3\u7801\u4e2d\u901a\u8fc7\u6ce8\u91ca\uff0c\u6807\u660e\u4e86\u9ed8\u8ba4\u91c7\u6837\u7684\u65f6\u95f4\u7a97\u53e3\u7684\u4e2a\u6570\u662f2\u4e2a\uff0c\u8fd9\u4e2a\u503c\u662f\u600e\u4e48\u5f97\u5230\u7684\u5462\uff1f\u6211\u4eec\u56de\u5fc6\u4e00\u4e0b LeapArray \u5bf9\u8c61\u521b\u5efa\uff0c\u662f\u901a\u8fc7\u5728 StatisticNode \u4e2d\uff0cnew\u4e86\u4e00\u4e2a ArrayMetric\uff0c\u7136\u540e\u5c06\u53c2\u6570\u4e00\u8def\u5f80\u4e0a\u4f20\u9012\u540e\u521b\u5efa\u7684\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"private transient volatile Metric rollingCounterInSecond = new ArrayMetric(SampleCountProperty.SAMPLE_COUNT,IntervalProperty.INTERVAL);\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"2.5.3 currentWindow"}),"\n\u6211\u4eec\u8ddf\u8fdb\u83b7\u53d6\u5f53\u524d\u7a97\u53e3\u7684\u65b9\u6cd5 data.currentWindow() \u4e2d\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"@Overridepublic WindowWrap<Window> currentWindow(long time) {    .....//\u7701\u7565\u90e8\u5206\u4ee3\u7801    //\u8ba1\u7b97\u5f53\u524d\u65f6\u95f4\u5728\u6ed1\u52a8\u7a97\u53e3\u4e2d\u7684\u7d22\u5f15\uff0c\u8ba1\u7b97\u65b9\u5f0f\u6bd4\u8f83\u7b80\u5355\uff0c\u5f53\u524d\u65f6\u95f4\u9664\u4ee5\u5355\u4e2a\u65f6\u95f4\u7a97\u53e3\u7684\u65f6\u95f4\u957f\u5ea6\uff0c\u518d\u4ece\u6574\u4e2a\u65f6\u95f4\u7a97\u53e3\u957f\u5ea6\u8fdb\u884c\u53d6\u6a21\u3000\u3000 int idx = calculateTimeIdx(timeMillis);    //\u8ba1\u7b97\u5f53\u524d\u65f6\u95f4\u5728\u65f6\u95f4\u7a97\u53e3\u4e2d\u7684\u5f00\u59cb\u65f6\u95f4    long windowStart = calculateWindowStart(timeMillis);    // time\u6bcf\u589e\u52a0\u4e00\u4e2awindowLength\u7684\u957f\u5ea6\uff0ctimeId\u5c31\u4f1a\u589e\u52a01\uff0c\u65f6\u95f4\u7a97\u53e3\u5c31\u4f1a\u5f80\u524d\u6ed1\u52a8\u4e00\u4e2a        while (true) {        // \u4ece\u91c7\u6837\u6570\u7ec4\u4e2d\u6839\u636e\u7d22\u5f15\u83b7\u53d6\u7f13\u5b58\u7684\u65f6\u95f4\u7a97\u53e3        WindowWrap<Window> old = array.get(idx);        // array\u6570\u7ec4\u957f\u5ea6\u4e0d\u5b9c\u8fc7\u5927\uff0c\u5426\u5219old\u5f88\u591a\u60c5\u51b5\u4e0b\u90fd\u547d\u4e2d\u4e0d\u4e86\uff0c\u5c31\u4f1a\u521b\u5efa\u5f88\u591a\u4e2aWindowWrap\u5bf9\u8c61        //\u5982\u679c\u4e3a\u7a7a\uff0c\u8bf4\u660e\u6b64\u5904\u8fd8\u672a\u521d\u59cb\u5316        if (old == null) {            // \u5982\u679c\u6ca1\u6709\u83b7\u53d6\u5230\uff0c\u5219\u521b\u5efa\u4e00\u4e2a\u65b0\u7684            WindowWrap<Window> window = new WindowWrap<Window>(windowLength, currentWindowStart, new Window());            // \u901a\u8fc7CAS\u5c06\u65b0\u7a97\u53e3\u8bbe\u7f6e\u5230\u6570\u7ec4\u4e2d\u53bb            if (array.compareAndSet(idx, null, window)) {                // \u5982\u679c\u80fd\u8bbe\u7f6e\u6210\u529f\uff0c\u5219\u5c06\u8be5\u7a97\u53e3\u8fd4\u56de                return window;            } else {                // \u5426\u5219\u5f53\u524d\u7ebf\u7a0b\u8ba9\u51fa\u65f6\u95f4\u7247\uff0c\u7b49\u5f85                Thread.yield();            }        // \u5982\u679c\u5f53\u524d\u7a97\u53e3\u7684\u5f00\u59cb\u65f6\u95f4\u4e0eold\u7684\u5f00\u59cb\u65f6\u95f4\u76f8\u7b49\uff0c\u5219\u76f4\u63a5\u8fd4\u56deold\u7a97\u53e3        } else if (currentWindowStart == old.windowStart()) {            return old;        // \u5982\u679c\u5f53\u524d\u65f6\u95f4\u7a97\u53e3\u7684\u5f00\u59cb\u65f6\u95f4\u5df2\u7ecf\u8d85\u8fc7\u4e86old\u7a97\u53e3\u7684\u5f00\u59cb\u65f6\u95f4\uff0c\u5219\u653e\u5f03old\u7a97\u53e3        // \u5e76\u5c06time\u8bbe\u7f6e\u4e3a\u65b0\u7684\u65f6\u95f4\u7a97\u53e3\u7684\u5f00\u59cb\u65f6\u95f4\uff0c\u6b64\u65f6\u7a97\u53e3\u5411\u524d\u6ed1\u52a8        } else if (currentWindowStart > old.windowStart()) {            if (addLock.tryLock()) {                try {                    // if (old is deprecated) then [LOCK] resetTo currentTime.                    return resetWindowTo(old, currentWindowStart);                } finally {                    addLock.unlock();                }            } else {                Thread.yield();            }        // \u8fd9\u4e2a\u6761\u4ef6\u4e0d\u53ef\u80fd\u5b58\u5728        } else if (currentWindowStart < old.windowStart()) {            // Cannot go through here.            return new WindowWrap<Window>(windowLength, currentWindowStart, new Window());        }    }}\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u4ee3\u7801\u5f88\u957f\uff0c\u6211\u4eec\u9010\u6b65\u5c06\u5176\u5206\u89e3\uff0c\u6211\u4eec\u5b9e\u9645\u53ef\u4ee5\u628a\u4ed6\u5206\u6210\u4ee5\u4e0b\u51e0\u6b65\uff1a"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"\u6839\u636e\u5f53\u524d\u65f6\u95f4\uff0c\u7b97\u51fa\u8be5\u65f6\u95f4\u7684timeId\uff0c\u5e76\u6839\u636etimeId\u7b97\u51fa\u5f53\u524d\u7a97\u53e3\u5728\u91c7\u6837\u7a97\u53e3\u6570\u7ec4\u4e2d\u7684\u7d22\u5f15idx\u3002"}),"\n",(0,r.jsx)(n.li,{children:"\u6839\u636e\u5f53\u524d\u65f6\u95f4\u7b97\u51fa\u5f53\u524d\u7a97\u53e3\u7684\u5e94\u8be5\u5bf9\u5e94\u7684\u5f00\u59cb\u65f6\u95f4time\uff0c\u4ee5\u6beb\u79d2\u4e3a\u5355\u4f4d\u3002"}),"\n",(0,r.jsx)(n.li,{children:"\u6839\u636e\u7d22\u5f15idx\uff0c\u5728\u91c7\u6837\u7a97\u53e3\u6570\u7ec4\u4e2d\u53d6\u5f97\u4e00\u4e2a\u65f6\u95f4\u7a97\u53e3\u3002"}),"\n",(0,r.jsx)(n.li,{children:"\u5faa\u73af\u5224\u65ad\u76f4\u5230\u83b7\u53d6\u5230\u4e00\u4e2a\u5f53\u524d\u65f6\u95f4\u7a97\u53e3 old \u3002"}),"\n"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u5982\u679cold\u4e3a\u7a7a\uff0c\u5219\u521b\u5efa\u4e00\u4e2a\u65f6\u95f4\u7a97\u53e3\uff0c\u5e76\u5c06\u5b83\u63d2\u5165\u5230array\u7684\u7b2cidx\u4e2a\u4f4d\u7f6e\uff0carray\u4e0a\u9762\u5df2\u7ecf\u5206\u6790\u8fc7\u4e86\uff0c\u662f\u4e00\u4e2a AtomicReferenceArray\u3002"}),"\n",(0,r.jsx)(n.li,{children:"\u5982\u679c\u5f53\u524d\u7a97\u53e3\u7684\u5f00\u59cb\u65f6\u95f4time\u4e0eold\u7684\u5f00\u59cb\u65f6\u95f4\u76f8\u7b49\uff0c\u90a3\u4e48\u8bf4\u660eold\u5c31\u662f\u5f53\u524d\u65f6\u95f4\u7a97\u53e3\uff0c\u76f4\u63a5\u8fd4\u56deold\u3002"}),"\n",(0,r.jsx)(n.li,{children:"\u5982\u679c\u5f53\u524d\u7a97\u53e3\u7684\u5f00\u59cb\u65f6\u95f4time\u5927\u4e8eold\u7684\u5f00\u59cb\u65f6\u95f4\uff0c\u5219\u8bf4\u660eold\u7a97\u53e3\u5df2\u7ecf\u8fc7\u65f6\u4e86\uff0c\u5c06old\u7684\u5f00\u59cb\u65f6\u95f4\u66f4\u65b0\u4e3a\u6700\u65b0\u503c\uff1atime\uff0c\u8fdb\u5165\u4e0b\u4e00\u6b21\u5f97\u5faa\u73af\u518d\u5224\u65ad\u5f53\u524d\u7a97\u53e3\u7684\u5f00\u59cb\u65f6\u95f4time\u4e0eold\u7684\u5f00\u59cb\u65f6\u95f4\u76f8\u7b49\u7684\u65f6\u5019\u8fd4\u56de\u3002"}),"\n",(0,r.jsx)(n.li,{children:"\u5982\u679c\u5f53\u524d\u7a97\u53e3\u7684\u5f00\u59cb\u65f6\u95f4time\u5c0f\u4e8eold\u7684\u5f00\u59cb\u65f6\u95f4\uff0c\u5b9e\u9645\u4e0a\u8fd9\u79cd\u60c5\u51b5\u662f\u4e0d\u53ef\u80fd\u5b58\u5728\u7684\uff0c\u56e0\u4e3atime\u662f\u5f53\u524d\u65f6\u95f4\uff0cold\u662f\u8fc7\u53bb\u7684\u4e00\u4e2a\u65f6\u95f4\u3002\n\u53e6\u5916timeId\u662f\u4f1a\u968f\u7740\u65f6\u95f4\u7684\u589e\u957f\u800c\u589e\u52a0\uff0c\u5f53\u524d\u65f6\u95f4\u6bcf\u589e\u957f\u4e00\u4e2awindowLength\u7684\u957f\u5ea6\uff0ctimeId\u5c31\u52a01\u3002\u4f46\u662fidx\u4e0d\u4f1a\u589e\u957f\uff0c\u53ea\u4f1a\u57280\u548c1\u4e4b\u95f4\u53d8\u6362\uff0c\u56e0\u4e3aarray\u6570\u7ec4\u7684\u957f\u5ea6\u662f2\uff0c\u53ea\u6709\u4e24\u4e2a\u91c7\u6837\u65f6\u95f4\u7a97\u53e3\u3002\u81f3\u4e8e\u4e3a\u4ec0\u4e48\u9ed8\u8ba4\u53ea\u6709\u4e24\u4e2a\u91c7\u6837\u7a97\u53e3\uff0c\u4e2a\u4eba\u89c9\u5f97\u56e0\u4e3asentinel\u662f\u6bd4\u8f83\u8f7b\u91cf\u7684\u6846\u67b6\u3002\u65f6\u95f4\u7a97\u53e3\u4e2d\u4fdd\u5b58\u7740\u5f88\u591a\u7edf\u8ba1\u6570\u636e\uff0c\u5982\u679c\u65f6\u95f4\u7a97\u53e3\u8fc7\u591a\u7684\u8bdd\uff0c\u4e00\u65b9\u9762\u4f1a\u5360\u7528\u8fc7\u591a\u5185\u5b58\uff0c\u53e6\u4e00\u65b9\u9762\u65f6\u95f4\u7a97\u53e3\u8fc7\u591a\u5c31\u610f\u5473\u7740\u65f6\u95f4\u7a97\u53e3\u7684\u957f\u5ea6\u4f1a\u53d8\u5c0f\uff0c\u5982\u679c\u65f6\u95f4\u7a97\u53e3\u957f\u5ea6\u53d8\u5c0f\uff0c\u5c31\u4f1a\u5bfc\u81f4\u65f6\u95f4\u7a97\u53e3\u8fc7\u4e8e\u9891\u7e41\u7684\u6ed1\u52a8\u3002\u5148\u6765\u770b\u4e00\u4e0b\u5176\u4e2d\u7684\u7b2c\u4e00\u6b65\u53ca\u7b2c\u4e8c\u6b65\uff1a"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"private int calculateTimeIdx(/*@Valid*/ long timeMillis) {    // time\u6bcf\u589e\u52a0\u4e00\u4e2awindowLength\u7684\u957f\u5ea6\uff0ctimeId\u5c31\u4f1a\u589e\u52a01\uff0c\u65f6\u95f4\u7a97\u53e3\u5c31\u4f1a\u5f80\u524d\u6ed1\u52a8\u4e00\u4e2a    long timeId = timeMillis / windowLengthInMs;     // idx\u88ab\u5206\u6210[0,arrayLength-1]\u4e2d\u7684\u67d0\u4e00\u4e2a\u6570\uff0c\u4f5c\u4e3aarray\u6570\u7ec4\u4e2d\u7684\u7d22\u5f15    return (int)(timeId % array.length());}protected long calculateWindowStart(/*@Valid*/ long timeMillis) {    return timeMillis - timeMillis % windowLengthInMs;}\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u6839\u636e\u5f53\u524d\u65f6\u95f4\u9664\u4e8e windowLength \u5f97\u5230\u4e00\u4e2a timeId(\u76f8\u5dee500ms\u8ba1\u7b97\u51fa\u6765\u7684\u503c\u5c06\u662f\u4e00\u81f4\u7684),\u518d\u7528timeId\u8ddf\u53d6\u6837\u7a97\u53e3\u7684\u957f\u5ea6\u8fdb\u884c\u4e00\u4e2a\u53d6\u6a21\uff0c\u90a3\u4e48\u5979\u4e00\u5b9a\u4f1a\u843d\u5728 0\uff0c1\u4e24\u4e2a\u4f4d\u7f6e\u7684\u5176\u4e2d\u4e00\u4e2a\u3002\u7136\u540e\u6839\u636e\u5f53\u524d\u65f6\u95f4\u7b97\u51fa\u5f53\u524d\u7a97\u53e3\u7684\u5e94\u8be5\u5bf9\u5e94\u7684\u5f00\u59cb\u65f6\u95f4time\u3002\u7531\u4e8e\u521a\u521a\u5f00\u59cb\u7684\u65f6\u5019 array \u662f\u7a7a\u7684\uff0c\u90a3\u4e48\u5979\u83b7\u53d6\u5230\u7684old\u5e94\u5f53\u662fnull\uff0c\u90a3\u4e48\u4ed6\u4f1a\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u5b9e\u4f8b\uff0c\u6211\u4eec\u7528\u56fe\u770b\u4e00\u4e0b\u521d\u59cb\u5316\u7684 LeapArray\uff1a"}),"\n",(0,r.jsxs)(n.p,{children:["\u5bf9\u5e94\u4e0a\u9762 currentWindow \u65b9\u6cd5\u7684 4.1 \u6b65\u9aa4(\u5047\u8bbeidx=0)\uff1a",(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/95b0b64926eae4d2753986af9c978da9980da0.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201415Sentinel\u539f\u7406\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201415Sentinel\u539f\u7406\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"\u5f53\u83b7\u53d6\u5230\u7684\u662fnull,\u90a3\u4e48\u521d\u59cb\u7684\u65f6\u5019arrays\u6570\u7ec4\u4e2d\u53ea\u6709\u4e00\u4e2a\u7a97\u53e3(\u53ef\u80fd\u662f\u7b2c\u4e00\u4e2a(idx=0)\uff0c\u4e5f\u53ef\u80fd\u662f\u7b2c\u4e8c\u4e2a(idx=1))\uff0c\u6bcf\u4e2a\u65f6\u95f4\u7a97\u53e3\u7684\u957f\u5ea6\u662f500ms\uff0c\u8fd9\u5c31\u610f\u5473\u7740\u53ea\u8981\u5f53\u524d\u65f6\u95f4\u4e0e\u65f6\u95f4\u7a97\u53e3\u7684\u5dee\u503c\u5728500ms\u4e4b\u5185\uff0c\u65f6\u95f4\u7a97\u53e3\u5c31\u4e0d\u4f1a\u5411\u524d\u6ed1\u52a8\u3002\u4f8b\u5982\uff0c\u5047\u5982\u5f53\u524d\u65f6\u95f4\u8d70\u5230300\u6216\u8005500\u65f6\uff0c\u5f53\u524d\u65f6\u95f4\u7a97\u53e3\u4ecd\u7136\u662f\u76f8\u540c\u7684\u90a3\u4e2a\uff1a"]}),"\n",(0,r.jsxs)(n.p,{children:["\u5bf9\u5e94\u4e0a\u9762 currentWindow \u65b9\u6cd5\u7684 4.2 \u6b65\u9aa4\uff1a",(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/85c047336a2c2186bcc7737a4c28da852cb603.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201415Sentinel\u539f\u7406\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201415Sentinel\u539f\u7406\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"\u65f6\u95f4\u7ee7\u7eed\u5f80\u524d\u8d70\uff0c\u5f53\u8d85\u8fc7500ms\u65f6\uff0c\u65f6\u95f4\u7a97\u53e3\u5c31\u4f1a\u5411\u524d\u6ed1\u52a8\u5230\u4e0b\u4e00\u4e2a\uff0c\u8fd9\u65f6\u5c31\u4f1a\u66f4\u65b0\u5f53\u524d\u7a97\u53e3\u7684\u5f00\u59cb\u65f6\u95f4,\u65f6\u95f4\u7ee7\u7eed\u5f80\u524d\u8d70\uff0c\u53ea\u8981\u4e0d\u8d85\u8fc71000ms\uff0c\u5219\u5f53\u524d\u7a97\u53e3\u4e0d\u4f1a\u53d1\u751f\u53d8\u5316\uff0c\u5176\u4e2d\u4ee3\u7801\u5b9e\u73b0\u662f resetWindowTo \u65b9\u6cd5\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"protected WindowWrap<MetricBucket> resetWindowTo(WindowWrap<MetricBucket> w, long time) {    // Update the start time and reset value.    // \u91cd\u7f6ewindowStart    w.resetTo(time);    MetricBucket borrowBucket = borrowArray.getWindowValue(time);    if (borrowBucket != null) {        w.value().reset();        w.value().addPass((int)borrowBucket.pass());    } else {        w.value().reset();    }    return w;}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u5bf9\u5e94\u4e0a\u9762 currentWindow \u65b9\u6cd5\u7684 4.3 \u6b65\u9aa4",(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/03d6e3886f95f5768e05969d7eb8307c26f381.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201415Sentinel\u539f\u7406\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201415Sentinel\u539f\u7406\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"\u5f53\u65f6\u95f4\u7ee7\u7eed\u5f80\u524d\u8d70\uff0c\u5f53\u524d\u65f6\u95f4\u8d85\u8fc71000ms\u65f6\uff0c\u5c31\u4f1a\u518d\u6b21\u8fdb\u5165\u4e0b\u4e00\u4e2a\u65f6\u95f4\u7a97\u53e3\uff0c\u6b64\u65f6arrays\u6570\u7ec4\u4e2d\u7684\u7a97\u53e3\u5c06\u4f1a\u6709\u4e00\u4e2a\u5931\u6548\uff0c\u4f1a\u6709\u53e6\u4e00\u4e2a\u65b0\u7684\u7a97\u53e3\u8fdb\u884c\u66ff\u6362\uff1a",(0,r.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/241926a53c2a5b06938844199046d31e593d62.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201415Sentinel\u539f\u7406\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201415Sentinel\u539f\u7406\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"\u4ee5\u6b64\u7c7b\u63a8\u968f\u7740\u65f6\u95f4\u7684\u6d41\u901d\uff0c\u65f6\u95f4\u7a97\u53e3\u4e5f\u5728\u53d1\u751f\u53d8\u5316\uff0c\u5728\u5f53\u524d\u65f6\u95f4\u70b9\u4e2d\u8fdb\u5165\u7684\u8bf7\u6c42\uff0c\u4f1a\u88ab\u7edf\u8ba1\u5230\u5f53\u524d\u65f6\u95f4\u5bf9\u5e94\u7684\u65f6\u95f4\u7a97\u53e3\u4e2d\uff0c\u56de\u5230addpass \u65b9\u6cd5\u4e2d\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"public void addPass(int count) {    WindowWrap<MetricBucket> wrap = data.currentWindow();    wrap.value().addPass(count);}\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u83b7\u53d6\u5230\u7a97\u53e3\u4ee5\u540e\u4f1a\u8fdb\u5165\u5230 wrap.value().addPass(count); QPS\u7684\u589e\u52a0\u3002\u800c\u8fd9\u91cc\u7684 wrap.value() \u5f97\u5230\u7684\u662f\u4e4b\u524d\u63d0\u5230\u7684 MetricBucket \uff0c\u5728 Sentinel \u4e2dQPS\u76f8\u5173\u6570\u636e\u7684\u7edf\u8ba1\u7ed3\u679c\u662f\u7ef4\u62a4\u5728\u8fd9\u4e2a\u7c7b\u7684 LongAdder[] \u4e2d\uff0c\u6700\u7ec8\u7531\u8fd9\u4e2a\u6307\u6807\u6765\u4e0e\u6211\u4eec\u5b9e\u73b0\u8bbe\u7f6e\u597d\u7684\u89c4\u5219\u8fdb\u884c\u5339\u914d\uff0c\u67e5\u770b\u662f\u5426\u9650\u6d41\uff0c\u4e5f\u5c31\u662f StatisticSlot\u7684entry \u65b9\u6cd5\u4e2d\u7684 fireEntry(context, resourceWrapper, node, count, prioritized, args); \u90fd\u8981\u5148\u8fdb\u5165\u5230 FlowSlot\u7684entry\u65b9\u6cd5\u8fdb\u884c\u9650\u6d41\u8fc7\u6ee4\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count,                  boolean prioritized, Object... args) throws Throwable {    checkFlow(resourceWrapper, context, node, count, prioritized);    fireEntry(context, resourceWrapper, node, count, prioritized, args);}\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u53ef\u4ee5\u770b\u5230\u8fd9\u91cc\u6709\u4e2a\u5f88\u91cd\u8981\u7684\u65b9\u6cd5 checkFlow \uff0c\u8fdb\u53bb\u770b\u770b\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"public void checkFlow(Function<String, Collection<FlowRule>> ruleProvider, ResourceWrapper resource,                      Context context, DefaultNode node, int count, boolean prioritized) throws BlockException {    if (ruleProvider == null || resource == null) {        return;    }    Collection<FlowRule> rules = ruleProvider.apply(resource.getName());    if (rules != null) {        for (FlowRule rule : rules) {            if (!canPassCheck(rule, context, node, count, prioritized)) {                throw new FlowException(rule.getLimitApp(), rule);            }        }    }}\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u5230\u8fd9\u91cc\u4e00\u5207\u90fd\u5e94\u8be5\u6e05\u6670\u4e86\uff0c\u8fd9\u91cc\u62ff\u5230\u4e86\u6211\u4eec\u8bbe\u7f6e\u7684 FlowRule \u5faa\u73af\u5339\u914d\u8d44\u6e90\u8fdb\u884c\u9650\u6d41\u8fc7\u6ee4\u3002\u8fd9\u5c31\u662fSentinel \u80fd\u505a\u5230\u9650\u6d41\u7684\u539f\u56e0\u3002"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"2.6 FlowRuleSlot"}),"\n\u8fd9\u4e2a slot \u4e3b\u8981\u6839\u636e\u9884\u8bbe\u7684\u8d44\u6e90\u7684\u7edf\u8ba1\u4fe1\u606f\uff0c\u6309\u7167\u56fa\u5b9a\u7684\u6b21\u5e8f\uff0c\u4f9d\u6b21\u751f\u6548\u3002\u5982\u679c\u4e00\u4e2a\u8d44\u6e90\u5bf9\u5e94\u4e24\u6761\u6216\u8005\u591a\u6761\u6d41\u63a7\u89c4\u5219\uff0c\u5219\u4f1a\u6839\u636e\u5982\u4e0b\u6b21\u5e8f\u4f9d\u6b21\u68c0\u9a8c\uff0c\u76f4\u5230\u5168\u90e8\u901a\u8fc7\u6216\u8005\u6709\u4e00\u4e2a\u89c4\u5219\u751f\u6548\u4e3a\u6b62:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u6307\u5b9a\u5e94\u7528\u751f\u6548\u7684\u89c4\u5219\uff0c\u5373\u9488\u5bf9\u8c03\u7528\u65b9\u9650\u6d41\u7684\uff1b"}),"\n",(0,r.jsx)(n.li,{children:"\u8c03\u7528\u65b9\u4e3a other \u7684\u89c4\u5219\uff1b"}),"\n",(0,r.jsx)(n.li,{children:"\u8c03\u7528\u65b9\u4e3a default \u7684\u89c4\u5219\u3002"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"@Overridepublic void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count,                  boolean prioritized, Object... args) throws Throwable {    checkFlow(resourceWrapper, context, node, count, prioritized);    fireEntry(context, resourceWrapper, node, count, prioritized, args);}\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"2.6.1 checkFlow"}),"\n\u8fdb\u5165\u5230FlowRuleChecker.checkFlow\u65b9\u6cd5\u4e2d\u3002"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u6839\u636e\u8d44\u6e90\u540d\u79f0\uff0c\u627e\u5230\u9650\u6d41\u89c4\u5219\u5217\u8868"}),"\n",(0,r.jsx)(n.li,{children:"\u5982\u679c\u9650\u6d41\u89c4\u5219\u4e0d\u4e3a\u7a7a\uff0c\u5219\u904d\u5386\u89c4\u5219\uff0c\u8c03\u7528canPassCheck\u65b9\u6cd5\u8fdb\u884c\u6821\u9a8c\u3002"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"public void checkFlow(Function<String, Collection<FlowRule>> ruleProvider,ResourceWrapper resource,                      Context context, DefaultNode node, int count, boolean prioritized) throws BlockException {    if (ruleProvider == null || resource == null) {        return;    }    Collection<FlowRule> rules = ruleProvider.apply(resource.getName());    if (rules != null) {        for (FlowRule rule : rules) {            if (!canPassCheck(rule, context, node, count, prioritized)) {                throw new FlowException(rule.getLimitApp(), rule);            }        }    }}\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"2.6.2 canPassCheck"}),"\n\u5224\u65ad\u662f\u5426\u662f\u96c6\u7fa4\u9650\u6d41\u6a21\u5f0f\uff0c\u5982\u679c\u662f\uff0c\u5219\u8d70passClusterCheck\uff0c\u5426\u5219\uff0c\u8c03\u7528passLocalCheck\u65b9\u6cd5\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"public boolean canPassCheck(/*@NonNull*/ FlowRule rule, Context context,DefaultNode node, int acquireCount,                            boolean prioritized) {    String limitApp = rule.getLimitApp();    if (limitApp == null) {        return true;    }    if (rule.isClusterMode()) {        return passClusterCheck(rule, context, node, acquireCount, prioritized);    }    return passLocalCheck(rule, context, node, acquireCount, prioritized);}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"2.6.3 passLocalCheck"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"selectNodeByRequesterAndStrategy\uff0c\u6839\u636e\u8bf7\u6c42\u548c\u7b56\u7565\u6765\u83b7\u5f97Node"}),"\n",(0,r.jsx)(n.li,{children:"rule.getRater(), \u6839\u636e\u4e0d\u540c\u7684\u9650\u6d41\u63a7\u5236\u884c\u4e3a\u6765\uff0c\u8c03\u7528canPass\u8fdb\u884c\u6821\u9a8c\u3002"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"private static boolean passLocalCheck(FlowRule rule, Context context,DefaultNode node, int acquireCount,                                      boolean prioritized) {    Node selectedNode = selectNodeByRequesterAndStrategy(rule, context, node);    if (selectedNode == null) {        return true;    }    return rule.getRater().canPass(selectedNode, acquireCount, prioritized);}\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"2.6.4 DefaultController.canPass"}),"\n\u901a\u8fc7\u9ed8\u8ba4\u7684\u9650\u6d41\u884c\u4e3a\uff08\u76f4\u63a5\u62d2\u7edd\uff09\uff0c\u8fdb\u884c\u9650\u6d41\u5224\u65ad\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"@Overridepublic boolean canPass(Node node, int acquireCount, boolean prioritized) {    //\u5148\u6839\u636enode\u83b7\u53d6\u8d44\u6e90\u5f53\u524d\u7684\u4f7f\u7528\u6570\u91cf\uff0c\u8fd9\u91cc\u4f1a\u6839\u636eqps\u6216\u8005\u5e76\u53d1\u6570\u7b56\u7565\u6765\u83b7\u5f97\u76f8\u5173\u7684\u503c    int curCount = avgUsedTokens(node);    //\u5f53\u524d\u5df2\u4f7f\u7528\u7684\u8bf7\u6c42\u6570\u52a0\u4e0a\u672c\u6b21\u8bf7\u6c42\u7684\u6570\u91cf\u662f\u5426\u5927\u4e8e\u9608\u503c    if (curCount + acquireCount > count) {//\u5982\u679c\u4e3atrue\uff0c\u8bf4\u660e\u5e94\u8be5\u88ab\u9650\u6d41        // \u5982\u679c\u6b64\u8bf7\u6c42\u662f\u4e00\u4e2a\u9ad8\u4f18\u5148\u7ea7\u8bf7\u6c42\uff0c\u5e76\u4e14\u9650\u6d41\u7c7b\u578b\u4e3aqps\uff0c\u5219\u4e0d\u4f1a\u7acb\u5373\u5931\u8d25\uff0c\u800c\u662f\u53bb\u5360\u7528\u672a\u6765\u7684\u65f6\u95f4\u7a97\u53e3\uff0c\u7b49\u5230\u4e0b\u4e00\u4e2a\u65f6\u95f4\u7a97\u53e3\u901a\u8fc7\u8bf7\u6c42\u3002        if (prioritized && grade == RuleConstant.FLOW_GRADE_QPS) { //            long currentTime;            long waitInMs;            currentTime = TimeUtil.currentTimeMillis();            waitInMs = node.tryOccupyNext(currentTime, acquireCount, count);            if (waitInMs < OccupyTimeoutProperty.getOccupyTimeout()) {                node.addWaitingRequest(currentTime + waitInMs, acquireCount);                node.addOccupiedPass(acquireCount);                sleep(waitInMs);                // PriorityWaitException indicates that the request will pass after waiting for {@link @waitInMs}.                throw new PriorityWaitException(waitInMs);            }        }        return false;    }    return true;}\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u4e00\u65e6\u88ab\u62d2\u7edd\uff0c\u5219\u629b\u51fa FlowException \u5f02\u5e38\u3002"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"2.7 PriorityWait"}),"\n\u5728DefaultController.canPass\u4e2d\uff0c\u8c03\u7528\u5982\u4e0b\u4ee3\u7801\u53bb\u501f\u540e\u7eed\u7684\u7a97\u53e3"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"node.addWaitingRequest(currentTime + waitInMs, acquireCount);node.addOccupiedPass(acquireCount);\n"})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"addWaitingRequest -> ArrayMetric.addWaiting->OccupiableBucketLeapArray.addWaiting"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"borrowArray\uff0c\u5b83\u662f\u4e00\u4e2aFutureBucketLeapArray\u5bf9\u8c61\uff0c\u8fd9\u91cc\u5b9a\u4e49\u7684\u662f\u672a\u6765\u7684\u65f6\u95f4\u7a97\u53e3\uff0c\u7136\u540e\u83b7\u5f97\u672a\u6765\u65f6\u95f4\u7684\u7a97\u53e3\u53bb\u589e\u52a0\u8ba1\u6570"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"@Overridepublic void addWaiting(long time, int acquireCount) {    WindowWrap<MetricBucket> window = borrowArray.currentWindow(time);    window.value().add(MetricEvent.PASS, acquireCount);}\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u6700\u7ec8\uff0c\u5728StatisticSlot.entry\u4e2d\uff0c\u6355\u83b7\u5f02\u5e38"}),"\n",(0,r.jsx)(n.p,{children:"\u5982\u679c\u5b58\u5728\u4f18\u5148\u7ea7\u6bd4\u8f83\u9ad8\u7684\u4efb\u52a1\uff0c\u5e76\u4e14\u5f53\u524d\u7684\u8bf7\u6c42\u5df2\u7ecf\u8fbe\u5230\u9608\u503c\uff0c\u629b\u51fa\u8fd9\u4e2a\u5f02\u5e38\uff0c\u5b9e\u9645\u4e0a\u662f\u53bb\u5360\u7528\u672a\u6765\u7684\u4e00\u4e2a\u65f6\u95f4\u7a97\u53e3\u53bb\u8fdb\u884c\u8ba1\u6570\uff0c\u629b\u51fa\u8fd9\u4e2a\u5f02\u5e38\u4e4b\u540e\uff0c\u4f1a\u8fdb\u5165\u5230StatisticSlot\u4e2d\u8fdb\u884c\u6355\u83b7\u3002\u7136\u540e\u76f4\u63a5\u901a\u8fc7"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count,                  boolean prioritized, Object... args) throws Throwable {    try{        //...    } catch (PriorityWaitException ex) {        node.increaseThreadNum();        if (context.getCurEntry().getOriginNode() != null) {            // Add count for origin node.            context.getCurEntry().getOriginNode().increaseThreadNum();        }        if (resourceWrapper.getEntryType() == EntryType.IN) {            // Add count for global inbound entry node for global statistics.            Constants.ENTRY_NODE.increaseThreadNum();        }        // Handle pass event with registered entry callback handlers.        for (ProcessorSlotEntryCallback<DefaultNode> handler :             StatisticSlotCallbackRegistry.getEntryCallbacks()) {            handler.onPass(context, resourceWrapper, node, count, args);        }    }}\n"})}),"\n",(0,r.jsx)(n.h1,{id:"\u53c2\u8003\u6587\u7ae0",children:"\u53c2\u8003\u6587\u7ae0"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://lijunyi.xyz/docs/SpringCloud/SpringCloud.html#_2-2-x-%E5%88%86%E6%94%AF",children:"https://lijunyi.xyz/docs/SpringCloud/SpringCloud.html#_2-2-x-%E5%88%86%E6%94%AF"}),"\n",(0,r.jsx)(n.a,{href:"https://mp.weixin.qq.com/s/2jeovmj77O9Ux96v3A0NtA",children:"https://mp.weixin.qq.com/s/2jeovmj77O9Ux96v3A0NtA"}),"\n",(0,r.jsx)(n.a,{href:"https://juejin.cn/post/6931922457741770760",children:"https://juejin.cn/post/6931922457741770760"}),"\n",(0,r.jsx)(n.a,{href:"https://github.com/D2C-Cai/herring",children:"https://github.com/D2C-Cai/herring"}),"\n",(0,r.jsx)(n.a,{href:"http://c.biancheng.net/springcloud",children:"http://c.biancheng.net/springcloud"}),"\n",(0,r.jsx)(n.a,{href:"https://github.com/macrozheng/springcloud-learning",children:"https://github.com/macrozheng/springcloud-learning"})]})]})}function u(e={}){const{wrapper:n}={...(0,i.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},88672:(e,n,t)=>{t.d(n,{Z:()=>c,a:()=>l});var r=t(50959);const i={},o=r.createContext(i);function l(e){const n=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);