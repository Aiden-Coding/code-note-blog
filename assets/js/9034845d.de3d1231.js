"use strict";(self.webpackChunkcode_note_blog=self.webpackChunkcode_note_blog||[]).push([[9397],{9112:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>a,toc:()=>c});var t=n(11527),s=n(88672);const o={},i=void 0,a={id:"Spring\u5168\u5bb6\u6876/SpringCloudAlibaba\u6e90\u7801\u5206\u6790/SpringCloudRocketMQ\u6e90\u7801\u5206\u6790",title:"SpringCloudRocketMQ\u6e90\u7801\u5206\u6790",description:"\u4e00\u3001NameServer\u542f\u52a8",source:"@site/docs/Spring\u5168\u5bb6\u6876/SpringCloudAlibaba\u6e90\u7801\u5206\u6790/SpringCloudRocketMQ\u6e90\u7801\u5206\u6790.md",sourceDirName:"Spring\u5168\u5bb6\u6876/SpringCloudAlibaba\u6e90\u7801\u5206\u6790",slug:"/Spring\u5168\u5bb6\u6876/SpringCloudAlibaba\u6e90\u7801\u5206\u6790/SpringCloudRocketMQ\u6e90\u7801\u5206\u6790",permalink:"/code-note-blog/docs/Spring\u5168\u5bb6\u6876/SpringCloudAlibaba\u6e90\u7801\u5206\u6790/SpringCloudRocketMQ\u6e90\u7801\u5206\u6790",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Spring\u5168\u5bb6\u6876/SpringCloudAlibaba\u6e90\u7801\u5206\u6790/SpringCloudRocketMQ\u6e90\u7801\u5206\u6790.md",tags:[],version:"current",frontMatter:{},sidebar:"spring",previous:{title:"Nacos\u914d\u7f6e\u4e2d\u5fc3",permalink:"/code-note-blog/docs/Spring\u5168\u5bb6\u6876/SpringCloudAlibaba\u6e90\u7801\u5206\u6790/SpringCloudAlibabaNacos\u6e90\u7801\u5206\u6790\uff1a\u914d\u7f6e\u4e2d\u5fc3"},next:{title:"SpringCloudSeata\u6e90\u7801\u5206\u6790",permalink:"/code-note-blog/docs/Spring\u5168\u5bb6\u6876/SpringCloudAlibaba\u6e90\u7801\u5206\u6790/SpringCloudSeata\u6e90\u7801\u5206\u6790"}},l={},c=[{value:"\u4e00\u3001NameServer\u542f\u52a8",id:"\u4e00nameserver\u542f\u52a8",level:3},{value:"1.NamesrvController controller = createNamesrvController(args);",id:"1namesrvcontroller-controller--createnamesrvcontrollerargs",level:5},{value:"2.start(controller);",id:"2startcontroller",level:5},{value:"\u4e8c\u3001Broker\u542f\u52a8",id:"\u4e8cbroker\u542f\u52a8",level:3},{value:"1.createBrokerController(args)",id:"1createbrokercontrollerargs",level:5},{value:"2.start(BrokerController controller)",id:"2startbrokercontroller-controller",level:5},{value:"\u4e09\u3001Netty\u670d\u52a1\u6ce8\u518c\u6846\u67b6",id:"\u4e09netty\u670d\u52a1\u6ce8\u518c\u6846\u67b6",level:3},{value:"\u56db\u3001Broker\u5fc3\u8df3\u6ce8\u518c\u8fc7\u7a0b",id:"\u56dbbroker\u5fc3\u8df3\u6ce8\u518c\u8fc7\u7a0b",level:3},{value:"\u4e94\u3001Producer\u53d1\u9001\u6d88\u606f",id:"\u4e94producer\u53d1\u9001\u6d88\u606f",level:3},{value:"\u516d\u3001Consumer\u6d88\u8d39\u6d88\u606f",id:"\u516dconsumer\u6d88\u8d39\u6d88\u606f",level:3}];function d(e){const r={a:"a",code:"code",h1:"h1",h3:"h3",h5:"h5",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.h3,{id:"\u4e00nameserver\u542f\u52a8",children:"\u4e00\u3001NameServer\u542f\u52a8"}),"\n",(0,t.jsx)(r.p,{children:"\u6e90\u7801\u5165\u53e3\uff1aNamesrvStartup#main"}),"\n",(0,t.jsx)(r.h5,{id:"1namesrvcontroller-controller--createnamesrvcontrollerargs",children:"1.NamesrvController controller = createNamesrvController(args);"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"\u68c0\u6d4b\u547d\u4ee4\u884c\u53c2\u6570"}),"\n",(0,t.jsx)(r.li,{children:"\u521b\u5efa\u6838\u5fc3\u914d\u7f6e\u5bf9\u8c61\uff0cNamesrvConfig\u3001NettyServerConfig"}),"\n",(0,t.jsx)(r.li,{children:"\u89e3\u6790 -c \u3001-p\u53c2\u6570"}),"\n",(0,t.jsx)(r.li,{children:"\u68c0\u67e5RocketMQ_HOME\u73af\u5883\u53d8\u91cf"}),"\n",(0,t.jsx)(r.li,{children:"final NamesrvController controller = new NamesrvController(namesrvConfig, nettyServerConfig);\u521b\u5efacontroller"}),"\n",(0,t.jsx)(r.li,{children:"controller.getConfiguration().registerConfig(properties); \u6ce8\u518c\u6240\u6709\u914d\u7f6e\u4fe1\u606f"}),"\n"]}),"\n",(0,t.jsx)(r.h5,{id:"2startcontroller",children:"2.start(controller);"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:'controller.initialize()\uff1b \u6267\u884c\u521d\u59cb\u5316\n\u25cb this.kvConfigManager.load(); \u52a0\u8f7dKV\u914d\u7f6e\n\u25cb this.remotingServer = new NettyRemotingServer(this.nettyServerConfig, this.brokerHousekeepingService);\u521b\u5efaNettyServer\u7f51\u7edc\u5904\u7406\u5bf9\u8c61\n\u25cb this.remotingExecutor =Executors.newFixedThreadPool(nettyServerConfig.getServerWorkerThreads(), new ThreadFactoryImpl("RemotingExecutorThread_")); \u521b\u5efaNetty\u670d\u52a1\u5668\u5de5\u4f5c\u7ebf\u7a0b\u6c60\n\u25cb this.registerProcessor(); \u6ce8\u518cNameServer\u7684Processor \u6ce8\u518c\u5230RemotingServer\u4e2d\n\u25cb NamesrvController.this.routeInfoManager.scanNotActiveBroker() \u542f\u52a8\u5b9a\u65f6\u4efb\u52a1\uff0c\u79fb\u9664\u4e0d\u6d3b\u8dc3\u7684Broker\n\u25cb NamesrvController.this.kvConfigManager.printAllPeriodically() \u5b9a\u65f6\u6253\u5370KV\u914d\u7f6e\u4fe1\u606f'}),"\n",(0,t.jsx)(r.li,{children:"Runtime.getRuntime().addShutdownHook \u6ce8\u518c\u5173\u95ed\u94a9\u5b50\uff0c\u5728\u5173\u95ed\u670d\u52a1\u65f6\u91ca\u653e\u8d44\u6e90"}),"\n",(0,t.jsx)(r.li,{children:"controller.start()\uff1b \u542f\u52a8controller"}),"\n"]}),"\n",(0,t.jsx)(r.p,{children:"NameServer\u7684\u4f5c\u7528\u4e3b\u8981\u6709\u4e24\u4e2a\uff1a\n1.\u7ef4\u62a4broker\u7684\u670d\u52a1\u5730\u5740\u4fe1\u606f\uff0c\u5e76\u8fdb\u884c\u66f4\u65b0\n2.\u7ed9Producer\u3001consumer\u63d0\u4f9bBroker\u7684\u670d\u52a1\u5217\u8868"}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/3245844-46ca880d83fb583b.png",alt:""})}),"\n",(0,t.jsx)(r.p,{children:"image.png"}),"\n",(0,t.jsx)(r.h3,{id:"\u4e8cbroker\u542f\u52a8",children:"\u4e8c\u3001Broker\u542f\u52a8"}),"\n",(0,t.jsx)(r.p,{children:"\u6e90\u7801\u5165\u53e3\uff1aBrokerstartup#main"}),"\n",(0,t.jsx)(r.h5,{id:"1createbrokercontrollerargs",children:"1.createBrokerController(args)"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"\u6784\u5efa\u56db\u4e2a\u6838\u5fc3\u914d\u7f6e\u5bf9\u8c61\uff1aBrokerConfig\u3001NettyServerConfig\u3001NettyClientConfig\u3001MessageStoreConfig"}),"\n",(0,t.jsx)(r.li,{children:"BrokerConfig\u53ea\u89e3\u6790 -c\u53c2\u6570"}),"\n",(0,t.jsx)(r.li,{children:"RocketMq_HOME\u73af\u5883\u53d8\u91cf\u68c0\u67e5"}),"\n",(0,t.jsx)(r.li,{children:"RemotingUtil.string2SocketAddress(addr) \u5c06namesrvAddr\u5730\u5740\u8fdb\u884c\u62c6\u5206"}),"\n",(0,t.jsx)(r.li,{children:"messageStoreConfig.getBrokerRole() \u901a\u8fc7BrokerId\u5224\u65ad\u4e3b\u4ece\uff1amasterId=0\uff0cDeldger\u96c6\u7fa4\u7684\u6240\u6709Broker\u8282\u70b9ID\u90fd\u662f-1"}),"\n",(0,t.jsx)(r.li,{children:"\u89e3\u6790 -p\u3001-m\u53c2\u6570\uff0c\u5e76\u5c06\u89e3\u6790\u7684\u53c2\u6570\u6dfb\u52a0\u5230\u56db\u4e2a\u6838\u5fc3\u914d\u7f6e\u5bf9\u8c61\u4e2d"}),"\n",(0,t.jsx)(r.li,{children:"BrokerController controller = new BrokerController \u521b\u5efabrokerController\uff0c\u5c06\u56db\u4e2a\u6838\u5fc3\u914d\u7f6e\u7c7b\u4f20\u5165"}),"\n",(0,t.jsx)(r.li,{children:"controller.getConfiguration().registerConfig(properties); \u91cd\u65b0\u6ce8\u518c\uff08\u66f4\u65b0\uff09\u914d\u7f6e"}),"\n",(0,t.jsx)(r.li,{children:"controller.initialize(); \u521d\u59cb\u5316controller\n\u25cb \u52a0\u8f7d\u78c1\u76d8\u4e0a\u7684\u914d\u7f6e\u6587\u4ef6\uff1atopicConfigManager\u3001consumerOffsetManager\u3001subscriptionGroupManager\u3001consumerFilterManager\n\u25cb this.messageStore =new DefaultMessageStore() \u6784\u5efa\u6d88\u606f\u5b58\u50a8\u7ec4\u4ef6\n\u25cb this.messageStore.load() \u52a0\u8f7d\u78c1\u76d8\u6587\u4ef6\n\u25cb this.remotingServer = new NettyRemotingServer \u6784\u5efaNetty\u7f51\u7edc\u7ec4\u4ef6\n\u25cb this.fastRemotingServer = new NettyRemotingServer \u8fd9\u4e2afastRemotingServer\u4e0eRemotingServer\u529f\u80fd\u57fa\u672c\u5dee\u4e0d\u591a\uff0c\u5904\u7406VIP\u7aef\u53e3\u8bf7\u6c42\n\u25cb \u540e\u9762\u5c31\u662f\u521d\u59cb\u5316\u4e00\u4e9b\u7ebf\u7a0b\u6c60\n\u25cb this.registerProcessor(); broker\u6ce8\u518c\u4e00\u4e9bProcessor\u5904\u7406\u65b9\u6cd5"}),"\n",(0,t.jsx)(r.li,{children:"Runtime.getRuntime().addShutdownHook \u6ce8\u518c\u5173\u95ed\u94a9\u5b50"}),"\n"]}),"\n",(0,t.jsx)(r.h5,{id:"2startbrokercontroller-controller",children:"2.start(BrokerController controller)"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"this.messageStore.start(); \u8fd9\u91cc\u542f\u52a8\u670d\u52a1\u4e3b\u8981\u662f\u4e3a\u4e86\u5c06CommitLog\u7684\u5199\u5165\u4e8b\u4ef6\u5206\u53d1\u7ed9ComsumeQueue\u548cIndexFile"}),"\n",(0,t.jsx)(r.li,{children:"\u542f\u52a8\u4e24\u4e2aNetty\u670d\u52a1\uff1aremotingServer\u3001fastRemotingServer"}),"\n",(0,t.jsx)(r.li,{children:"this.fileWatchService.start(); \u6587\u4ef6\u76d1\u542c\u670d\u52a1"}),"\n",(0,t.jsx)(r.li,{children:"this.brokerOuterAPI.start(); brokerOuterAPI\u53ef\u4ee5\u7406\u89e3\u4e3a\u4e00\u4e2aNetty\u5ba2\u6237\u7aef\uff0c\u5f80\u5916\u53d1\u8bf7\u6c42\u7684\u7ec4\u4ef6\uff0c\u4f8b\u5982\u53d1\u9001\u5fc3\u8df3"}),"\n",(0,t.jsx)(r.li,{children:"this.pullRequestHoldService.start(); \u957f\u8f6e\u8be2\u8bf7\u6c42\u6682\u505c\u670d\u52a1"}),"\n",(0,t.jsx)(r.li,{children:"this.filterServerManager.start(); \u4f7f\u7528filter\u8fdb\u884c\u8fc7\u6ee4"}),"\n",(0,t.jsx)(r.li,{children:"BrokerController.this.registerBrokerAll() Broker\u6838\u5fc3\u7684\u5fc3\u8df3\u6ce8\u518c\u4efb\u52a1,\u4e3b\u8981\u4f5c\u7528\u5c31\u662f\u5c06broker\u6ce8\u518c\u5230Namesrv\u4e2d"}),"\n"]}),"\n",(0,t.jsxs)(r.p,{children:["broker\u7684\u6838\u5fc3\u4f5c\u7528\uff1a\n",(0,t.jsx)(r.strong,{children:"1.\u4f5c\u4e3aclient\u65f6\uff0c\u5411nameServer\u53d1\u9001\u5fc3\u8df3\u4fe1\u606f\u3001\u53d1\u8d77\u4e8b\u52a1\u7684\u72b6\u6001\u68c0\u67e5"}),"\n",(0,t.jsx)(r.strong,{children:"2.\u4f5c\u4e3a\u670d\u52a1\u7aef\u65f6\uff0c\u7528\u4e8e\u5b58\u50a8\u6d88\u606f\u3001\u54cd\u5e94consumer\u7aef\u7684\u8bf7\u6c42"})]}),"\n",(0,t.jsx)(r.h3,{id:"\u4e09netty\u670d\u52a1\u6ce8\u518c\u6846\u67b6",children:"\u4e09\u3001Netty\u670d\u52a1\u6ce8\u518c\u6846\u67b6"}),"\n",(0,t.jsx)(r.h3,{id:"\u56dbbroker\u5fc3\u8df3\u6ce8\u518c\u8fc7\u7a0b",children:"\u56db\u3001Broker\u5fc3\u8df3\u6ce8\u518c\u8fc7\u7a0b"}),"\n",(0,t.jsx)(r.p,{children:"\u6e90\u7801\u5165\u53e3\uff1aBrokerController.this.registerBrokerAll(true, false, brokerConfig.isForceRegister())"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{children:"public synchronized void registerBrokerAll(final boolean checkOrderConfig, boolean oneway, boolean forceRegister) {\n    TopicConfigSerializeWrapper topicConfigWrapper = this.getTopicConfigManager().buildTopicConfigSerializeWrapper();\n\n    if (!PermName.isWriteable(this.getBrokerConfig().getBrokerPermission())\n        || !PermName.isReadable(this.getBrokerConfig().getBrokerPermission())) {\n        ConcurrentHashMap<String, TopicConfig> topicConfigTable = new ConcurrentHashMap<String, TopicConfig>();\n        for (TopicConfig topicConfig : topicConfigWrapper.getTopicConfigTable().values()) {\n            TopicConfig tmp =\n                new TopicConfig(topicConfig.getTopicName(), topicConfig.getReadQueueNums(), topicConfig.getWriteQueueNums(),\n                                this.brokerConfig.getBrokerPermission());\n            topicConfigTable.put(topicConfig.getTopicName(), tmp);\n        }\n        topicConfigWrapper.setTopicConfigTable(topicConfigTable);\n    }\n    //\u8fd9\u91cc\u624d\u662f\u6bd4\u8f83\u5173\u952e\u7684\u5730\u65b9\u3002\u5148\u5224\u65ad\u662f\u5426\u9700\u8981\u6ce8\u518c\uff0c\u7136\u540e\u8c03\u7528doRegisterBrokerAll\u65b9\u6cd5\u771f\u6b63\u53bb\u6ce8\u518c\u3002\n    if (forceRegister || needRegister(this.brokerConfig.getBrokerClusterName(),\n                                      this.getBrokerAddr(),\n                                      this.brokerConfig.getBrokerName(),\n                                      this.brokerConfig.getBrokerId(),\n                                      this.brokerConfig.getRegisterBrokerTimeoutMills())) {\n        doRegisterBrokerAll(checkOrderConfig, oneway, topicConfigWrapper);\n    }\n}\n\n"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{children:"// Broker\u6ce8\u518c\u6700\u6838\u5fc3\u7684\u90e8\u5206\nprivate void doRegisterBrokerAll(boolean checkOrderConfig, boolean oneway,\n                                 TopicConfigSerializeWrapper topicConfigWrapper) {\n    // \u6ce8\u518cbroker\u65b9\u6cd5\n    List<RegisterBrokerResult> registerBrokerResultList = this.brokerOuterAPI.registerBrokerAll(\n        this.brokerConfig.getBrokerClusterName(),\n        this.getBrokerAddr(),\n        this.brokerConfig.getBrokerName(),\n        this.brokerConfig.getBrokerId(),\n        this.getHAServerAddr(),\n        topicConfigWrapper,\n        this.filterServerManager.buildNewFilterServerList(),\n        oneway,\n        this.brokerConfig.getRegisterBrokerTimeoutMills(),\n        this.brokerConfig.isCompressedRegister());\n\n    if (registerBrokerResultList.size() > 0) {\n        RegisterBrokerResult registerBrokerResult = registerBrokerResultList.get(0);\n        if (registerBrokerResult != null) {\n            //\u6ce8\u518c\u5b8c\u4fdd\u5b58\u4e3b\u4ece\u8282\u70b9\u7684\u5730\u5740\n            if (this.updateMasterHAServerAddrPeriodically && registerBrokerResult.getHaServerAddr() != null) {\n                this.messageStore.updateHaMasterAddress(registerBrokerResult.getHaServerAddr());\n            }\n\n            this.slaveSynchronize.setMasterAddr(registerBrokerResult.getMasterAddr());\n\n            if (checkOrderConfig) {\n                this.getTopicConfigManager().updateOrderTopicConfig(registerBrokerResult.getKvTable());\n            }\n        }\n    }\n}\n\n"})}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{children:'public List<RegisterBrokerResult> registerBrokerAll(\n    final String clusterName,\n    final String brokerAddr,\n    final String brokerName,\n    final long brokerId,\n    final String haServerAddr,\n    final TopicConfigSerializeWrapper topicConfigWrapper,\n    final List<String> filterServerList,\n    final boolean oneway,\n    final int timeoutMills,\n    final boolean compressed) {\n    //\u4f7f\u7528CopyOnWriteArrayList\u63d0\u5347\u5e76\u53d1\u5b89\u5168\u6027\n    final List<RegisterBrokerResult> registerBrokerResultList = new CopyOnWriteArrayList<>();\n    // \u83b7\u53d6\u6240\u6709nameServer\u7684\u5730\u5740\u4fe1\u606f\n    List<String> nameServerAddressList = this.remotingClient.getNameServerAddressList();\n    if (nameServerAddressList != null && nameServerAddressList.size() > 0) {\n\n        final RegisterBrokerRequestHeader requestHeader = new RegisterBrokerRequestHeader();\n        requestHeader.setBrokerAddr(brokerAddr);\n        requestHeader.setBrokerId(brokerId);\n        requestHeader.setBrokerName(brokerName);\n        requestHeader.setClusterName(clusterName);\n        requestHeader.setHaServerAddr(haServerAddr);\n        requestHeader.setCompressed(compressed);\n\n        RegisterBrokerBody requestBody = new RegisterBrokerBody();\n        requestBody.setTopicConfigSerializeWrapper(topicConfigWrapper);\n        requestBody.setFilterServerList(filterServerList);\n        final byte[] body = requestBody.encode(compressed);\n        final int bodyCrc32 = UtilAll.crc32(body);\n        requestHeader.setBodyCrc32(bodyCrc32);\n        //\u901a\u8fc7CountDownLatch\uff0c\u4fdd\u8bc1\u5728\u6240\u6709NameServer\u4e0a\u5b8c\u6210\u6ce8\u518c\u540e\u518d\u4e00\u8d77\u7ed3\u675f\u3002\n        final CountDownLatch countDownLatch = new CountDownLatch(nameServerAddressList.size());\n        for (final String namesrvAddr : nameServerAddressList) {\n            brokerOuterExecutor.execute(new Runnable() {\n                @Override\n                public void run() {\n                    try {\n                        RegisterBrokerResult result = registerBroker(namesrvAddr, oneway, timeoutMills, requestHeader, body);\n                        if (result != null) {\n                            registerBrokerResultList.add(result);\n                        }\n\n                        log.info("register broker[{}]to name server {} OK", brokerId, namesrvAddr);\n                    } catch (Exception e) {\n                        log.warn("registerBroker Exception, {}", namesrvAddr, e);\n                    } finally {\n                        countDownLatch.countDown();\n                    }\n                }\n            });\n        }\n\n        try {\n            countDownLatch.await(timeoutMills, TimeUnit.MILLISECONDS);\n        } catch (InterruptedException e) {\n        }\n    }\n\n    return registerBrokerResultList;\n}\n\n'})}),"\n",(0,t.jsx)(r.p,{children:"NameServer\u5904\u7406\u8bf7\u6c42\uff1a"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{children:'//NameServer\u5904\u7406\u8bf7\u6c42\u7684\u6838\u5fc3\u4ee3\u7801\n@Override\n    public RemotingCommand processRequest(ChannelHandlerContext ctx,\n                                          RemotingCommand request) throws RemotingCommandException {\n\n    if (ctx != null) {\n        log.debug("receive request, {} {} {}",\n                  request.getCode(),\n                  RemotingHelper.parseChannelRemoteAddr(ctx.channel()),\n                  request);\n    }\n\n    switch (request.getCode()) {\n        case RequestCode.PUT_KV_CONFIG:\n            return this.putKVConfig(ctx, request);\n        case RequestCode.GET_KV_CONFIG:\n            return this.getKVConfig(ctx, request);\n        case RequestCode.DELETE_KV_CONFIG:\n            return this.deleteKVConfig(ctx, request);\n        case RequestCode.QUERY_DATA_VERSION:\n            return queryBrokerTopicConfig(ctx, request);\n        case RequestCode.REGISTER_BROKER: //Broker\u6ce8\u518c\u8bf7\u6c42\u5904\u7406\u3002\u7248\u672c\u9ed8\u8ba4\u662f\u5f53\u524d\u6846\u67b6\u7248\u672c\n            Version brokerVersion = MQVersion.value2Version(request.getVersion());\n            if (brokerVersion.ordinal() >= MQVersion.Version.V3_0_11.ordinal()) {\n                return this.registerBrokerWithFilterServer(ctx, request); //\u5f53\u524d\u7248\u672c\n            } else {\n                return this.registerBroker(ctx, request);\n            }\n        case RequestCode.UNREGISTER_BROKER:\n            return this.unregisterBroker(ctx, request);\n        case RequestCode.GET_ROUTEINFO_BY_TOPIC:\n            return this.getRouteInfoByTopic(ctx, request);\n        case RequestCode.GET_BROKER_CLUSTER_INFO:\n            return this.getBrokerClusterInfo(ctx, request);\n        case RequestCode.WIPE_WRITE_PERM_OF_BROKER:\n            return this.wipeWritePermOfBroker(ctx, request);\n        case RequestCode.GET_ALL_TOPIC_LIST_FROM_NAMESERVER:\n            return getAllTopicListFromNameserver(ctx, request);\n        case RequestCode.DELETE_TOPIC_IN_NAMESRV:\n            return deleteTopicInNamesrv(ctx, request);\n        case RequestCode.GET_KVLIST_BY_NAMESPACE:\n            return this.getKVListByNamespace(ctx, request);\n        case RequestCode.GET_TOPICS_BY_CLUSTER:\n            return this.getTopicsByCluster(ctx, request);\n        case RequestCode.GET_SYSTEM_TOPIC_LIST_FROM_NS:\n            return this.getSystemTopicListFromNs(ctx, request);\n        case RequestCode.GET_UNIT_TOPIC_LIST:\n            return this.getUnitTopicList(ctx, request);\n        case RequestCode.GET_HAS_UNIT_SUB_TOPIC_LIST:\n            return this.getHasUnitSubTopicList(ctx, request);\n        case RequestCode.GET_HAS_UNIT_SUB_UNUNIT_TOPIC_LIST:\n            return this.getHasUnitSubUnUnitTopicList(ctx, request);\n        case RequestCode.UPDATE_NAMESRV_CONFIG:\n            return this.updateConfig(ctx, request);\n        case RequestCode.GET_NAMESRV_CONFIG:\n            return this.getConfig(ctx, request);\n        default:\n            break;\n    }\n    return null;\n}\n\n'})}),"\n",(0,t.jsx)(r.p,{children:"\u5b9e\u9645\u5c31\u662f\u5c06broker\u4fe1\u606f\u6ce8\u518c\u5230routeInfo\u4e2d\uff1a"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{children:'public RemotingCommand registerBrokerWithFilterServer(ChannelHandlerContext ctx, RemotingCommand request)\n    throws RemotingCommandException {\n    final RemotingCommand response = RemotingCommand.createResponseCommand(RegisterBrokerResponseHeader.class);\n    final RegisterBrokerResponseHeader responseHeader = (RegisterBrokerResponseHeader) response.readCustomHeader();\n    final RegisterBrokerRequestHeader requestHeader =\n        (RegisterBrokerRequestHeader) request.decodeCommandCustomHeader(RegisterBrokerRequestHeader.class);\n\n    if (!checksum(ctx, request, requestHeader)) {\n        response.setCode(ResponseCode.SYSTEM_ERROR);\n        response.setRemark("crc32 not match");\n        return response;\n    }\n\n    RegisterBrokerBody registerBrokerBody = new RegisterBrokerBody();\n\n    if (request.getBody() != null) {\n        try {\n            registerBrokerBody = RegisterBrokerBody.decode(request.getBody(), requestHeader.isCompressed());\n        } catch (Exception e) {\n            throw new RemotingCommandException("Failed to decode RegisterBrokerBody", e);\n        }\n    } else {\n        registerBrokerBody.getTopicConfigSerializeWrapper().getDataVersion().setCounter(new AtomicLong(0));\n        registerBrokerBody.getTopicConfigSerializeWrapper().getDataVersion().setTimestamp(0);\n    }\n    //routeInfoManager\u5c31\u662f\u7ba1\u7406\u8def\u7531\u4fe1\u606f\u7684\u6838\u5fc3\u7ec4\u4ef6\u3002\n    RegisterBrokerResult result = this.namesrvController.getRouteInfoManager().registerBroker(\n        requestHeader.getClusterName(),\n        requestHeader.getBrokerAddr(),\n        requestHeader.getBrokerName(),\n        requestHeader.getBrokerId(),\n        requestHeader.getHaServerAddr(),\n        registerBrokerBody.getTopicConfigSerializeWrapper(),\n        registerBrokerBody.getFilterServerList(),\n        ctx.channel());\n\n    responseHeader.setHaServerAddr(result.getHaServerAddr());\n    responseHeader.setMasterAddr(result.getMasterAddr());\n\n    byte[] jsonValue = this.namesrvController.getKvConfigManager().getKVListByNamespace(NamesrvUtil.NAMESPACE_ORDER_TOPIC_CONFIG);\n    response.setBody(jsonValue);\n\n    response.setCode(ResponseCode.SUCCESS);\n    response.setRemark(null);\n    return response;\n}\n\n'})}),"\n",(0,t.jsx)(r.h3,{id:"\u4e94producer\u53d1\u9001\u6d88\u606f",children:"\u4e94\u3001Producer\u53d1\u9001\u6d88\u606f"}),"\n",(0,t.jsx)(r.p,{children:"\u6e90\u7801\u5165\u53e3\uff1aDefaultMQProducer#start\n1.this.defaultMQProducerImpl.start(); \u751f\u4ea7\u7aef\u542f\u52a8"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{children:'public void start(final boolean startFactory) throws MQClientException {\n    switch (this.serviceState) {\n        case CREATE_JUST:\n            // \u9ed8\u8ba4\u5c31\u662fCREATE_JUST\n            this.serviceState = ServiceState.START_FAILED;\n\n            this.checkConfig();\n            //\u4fee\u6539\u5f53\u524d\u7684instanceName\u4e3a\u5f53\u524d\u8fdb\u7a0bID\n            if (!this.defaultMQProducer.getProducerGroup().equals(MixAll.CLIENT_INNER_PRODUCER_GROUP)) {\n                this.defaultMQProducer.changeInstanceNameToPID();\n            }\n            //\u5ba2\u6237\u7aef\u6838\u5fc3\u7684MQ\u5ba2\u6237\u7aef\u5de5\u5382 \u5bf9\u4e8e\u4e8b\u52a1\u6d88\u606f\u53d1\u9001\u8005\uff0c\u5728\u8fd9\u91cc\u9762\u4f1a\u5b8c\u6210\u4e8b\u52a1\u6d88\u606f\u7684\u53d1\u9001\u8005\u7684\u670d\u52a1\u6ce8\u518c\n            this.mQClientFactory = MQClientManager.getInstance().getOrCreateMQClientInstance(this.defaultMQProducer, rpcHook);\n            //\u6ce8\u518cMQ\u5ba2\u6237\u7aef\u5de5\u5382\u793a\u4f8b\n            boolean registerOK = mQClientFactory.registerProducer(this.defaultMQProducer.getProducerGroup(), this);\n            if (!registerOK) {\n                this.serviceState = ServiceState.CREATE_JUST;\n                throw new MQClientException("The producer group[" + this.defaultMQProducer.getProducerGroup()\n                                            + "] has been created before, specify another name please." + FAQUrl.suggestTodo(FAQUrl.GROUP_NAME_DUPLICATE_URL),\n                                            null);\n            }\n\n            this.topicPublishInfoTable.put(this.defaultMQProducer.getCreateTopicKey(), new TopicPublishInfo());\n            //\u542f\u52a8\u793a\u4f8b --\u6240\u6709\u5ba2\u6237\u7aef\u7ec4\u4ef6\u90fd\u4ea4\u7531mQClientFactory\u542f\u52a8\n            if (startFactory) {\n                mQClientFactory.start();\n            }\n\n            log.info("the producer [{}] start OK. sendMessageWithVIPChannel={}", this.defaultMQProducer.getProducerGroup(),\n                     this.defaultMQProducer.isSendMessageWithVIPChannel());\n            this.serviceState = ServiceState.RUNNING;\n            break;\n        case RUNNING:\n        case START_FAILED:\n        case SHUTDOWN_ALREADY:\n            throw new MQClientException("The producer service state not OK, maybe started once, "\n                                        + this.serviceState\n                                        + FAQUrl.suggestTodo(FAQUrl.CLIENT_SERVICE_NOT_OK),\n                                        null);\n        default:\n            break;\n    }\n    // \u5411\u6240\u6709\u7684broker\u53d1\u9001\u5fc3\u8df3\n    this.mQClientFactory.sendHeartbeatToAllBrokerWithLock();\n\n    this.startScheduledTask();\n\n}\n\n'})}),"\n",(0,t.jsx)(r.h3,{id:"\u516dconsumer\u6d88\u8d39\u6d88\u606f",children:"\u516d\u3001Consumer\u6d88\u8d39\u6d88\u606f"}),"\n",(0,t.jsx)(r.p,{children:"\u6d88\u8d39\u7aef\u5165\u53e3\uff1aDefaultMQPushConsumer#start\nthis.defaultMQPushConsumerImpl.start();"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{children:'public synchronized void start() throws MQClientException {\n    switch (this.serviceState) {\n        case CREATE_JUST:\n            log.info("the consumer [{}] start beginning. messageModel={}, isUnitMode={}", this.defaultMQPushConsumer.getConsumerGroup(),\n                     this.defaultMQPushConsumer.getMessageModel(), this.defaultMQPushConsumer.isUnitMode());\n            this.serviceState = ServiceState.START_FAILED;\n\n            this.checkConfig();\n\n            this.copySubscription();\n\n            if (this.defaultMQPushConsumer.getMessageModel() == MessageModel.CLUSTERING) {\n                this.defaultMQPushConsumer.changeInstanceNameToPID();\n            }\n            //\u5ba2\u6237\u7aef\u793a\u4f8b\u5de5\u5382\uff0c\u751f\u4ea7\u8005\u4e5f\u662f\u4ea4\u7531\u8fd9\u4e2a\u5de5\u5382\u542f\u52a8\u7684\u3002\n            this.mQClientFactory = MQClientManager.getInstance().getOrCreateMQClientInstance(this.defaultMQPushConsumer, this.rpcHook);\n            //\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\n            this.rebalanceImpl.setConsumerGroup(this.defaultMQPushConsumer.getConsumerGroup());\n            this.rebalanceImpl.setMessageModel(this.defaultMQPushConsumer.getMessageModel());\n            this.rebalanceImpl.setAllocateMessageQueueStrategy(this.defaultMQPushConsumer.getAllocateMessageQueueStrategy());\n            this.rebalanceImpl.setmQClientFactory(this.mQClientFactory);\n\n            this.pullAPIWrapper = new PullAPIWrapper(\n                mQClientFactory,\n                this.defaultMQPushConsumer.getConsumerGroup(), isUnitMode());\n            this.pullAPIWrapper.registerFilterMessageHook(filterMessageHookList);\n\n            if (this.defaultMQPushConsumer.getOffsetStore() != null) {\n                this.offsetStore = this.defaultMQPushConsumer.getOffsetStore();\n            } else {\n                //\u4ece\u8fd9\u91cc\u53ef\u4ee5\u770b\u51fa\uff0c\u5e7f\u64ad\u6a21\u5f0f\u4e0e\u96c6\u7fa4\u6a21\u5f0f\u7684\u6700\u672c\u8d28\u533a\u522b\u5c31\u662foffset\u5b58\u50a8\u7684\u5730\u65b9\u4e0d\u4e00\u6837\u3002\n                switch (this.defaultMQPushConsumer.getMessageModel()) {\n                        //\u5e7f\u64ad\u6a21\u5f0f\u662f\u5728\u6d88\u8d39\u8005\u672c\u5730\u5b58\u50a8offset\n                    case BROADCASTING:\n                        this.offsetStore = new LocalFileOffsetStore(this.mQClientFactory, this.defaultMQPushConsumer.getConsumerGroup());\n                        break;\n                        //\u96c6\u7fa4\u6a21\u5f0f\u662f\u5728Broker\u8fdc\u7aef\u5b58\u50a8offset\n                    case CLUSTERING:\n                        this.offsetStore = new RemoteBrokerOffsetStore(this.mQClientFactory, this.defaultMQPushConsumer.getConsumerGroup());\n                        break;\n                    default:\n                        break;\n                }\n                this.defaultMQPushConsumer.setOffsetStore(this.offsetStore);\n            }\n            this.offsetStore.load();\n            //\u987a\u5e8f\u6d88\u8d39\u76d1\u542c\u521b\u5efaConsumeMessageOrderlyService\n            if (this.getMessageListenerInner() instanceof MessageListenerOrderly) {\n                this.consumeOrderly = true;\n                this.consumeMessageService =\n                    new ConsumeMessageOrderlyService(this, (MessageListenerOrderly) this.getMessageListenerInner());\n                //\u5e76\u53d1\u6d88\u8d39\u76d1\u542c\u521b\u5efaConsumeMessageConcurrentlyService\n            } else if (this.getMessageListenerInner() instanceof MessageListenerConcurrently) {\n               this.consumeOrderly = false;\n               this.consumeMessageService =\n               new ConsumeMessageConcurrentlyService(this, (MessageListenerConcurrently) this.getMessageListenerInner());\n            }\n\n           this.consumeMessageService.start();\n           //\u6ce8\u518c\u6d88\u8d39\u8005\u3002\u4e0e\u751f\u4ea7\u8005\u7c7b\u4f3c\uff0c\u5ba2\u6237\u7aef\u53ea\u8981\u6309\u8981\u6c42\u6ce8\u518c\u5373\u53ef\uff0c\u540e\u7eed\u4f1a\u968fmQClientFactory\u4e00\u8d77\u542f\u52a8\u3002\n           boolean registerOK = mQClientFactory.registerConsumer(this.defaultMQPushConsumer.getConsumerGroup(), this);\n           if (!registerOK) {\n               this.serviceState = ServiceState.CREATE_JUST;\n               this.consumeMessageService.shutdown(defaultMQPushConsumer.getAwaitTerminationMillisWhenShutdown());\n               throw new MQClientException("The consumer group[" + this.defaultMQPushConsumer.getConsumerGroup()\n               + "] has been created before, specify another name please." + FAQUrl.suggestTodo(FAQUrl.GROUP_NAME_DUPLICATE_URL),\n               null);\n           }\n\n           mQClientFactory.start();\n           log.info("the consumer [{}] start OK.", this.defaultMQPushConsumer.getConsumerGroup());\n           this.serviceState = ServiceState.RUNNING;\n           break;\n           case RUNNING:\n           case START_FAILED:\n           case SHUTDOWN_ALREADY:\n            throw new MQClientException("The PushConsumer service state not OK, maybe started once, "\n                + this.serviceState\n                + FAQUrl.suggestTodo(FAQUrl.CLIENT_SERVICE_NOT_OK),null);\n           default:\n                break;\n           }\n\n               this.updateTopicSubscribeInfoWhenSubscriptionChanged();\n               this.mQClientFactory.checkClientInBroker();\n               this.mQClientFactory.sendHeartbeatToAllBrokerWithLock();\n               this.mQClientFactory.rebalanceImmediately();\n           }\n\n'})}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.strong,{children:"1\u3001consumer\u7aef\u7684\u6d88\u8d39\u6a21\u5f0f\uff1a"}),"\n\u25cf \u96c6\u7fa4\u6a21\u5f0f\uff1a\u96c6\u7fa4\u6a21\u5f0f\u4e0b\u6bcf\u4e2aconsumer\u90fd\u4f1a\u5206\u914d\u4e0d\u540c\u7684\u6d88\u606f\n\u25cf \u5e7f\u64ad\u6a21\u5f0f\uff1a\u5e7f\u64ad\u6a21\u5f0f\u4e0b\u6bcf\u4e2a\u6d88\u606f\u90fd\u63a8\u9001\u7ed9\u6240\u6709consumer\n",(0,t.jsx)(r.strong,{children:"2\u3001\u5173\u4e8eoffset\u5b58\u50a8\uff1a"}),"\n\u25cf \u5e7f\u64ad\u6a21\u5f0f\uff1athis.offsetStore = new LocalFileOffsetStore(); \u5b58\u50a8\u5728\u6bcf\u4e2aconsumer\u4e2d\n\u25cf \u96c6\u7fa4\u6a21\u5f0f\uff1athis.offsetStore = new RemoteBrokerOffsetStore(); \u5b58\u50a8\u5728broker\u7aef"]}),"\n",(0,t.jsxs)(r.p,{children:["\u4f5c\u8005\uff1a\u67ab\u53f6\u7ea2\u82b1\n\u94fe\u63a5\uff1a",(0,t.jsx)(r.a,{href:"https://www.jianshu.com/p/8dd4cfeae39d",children:"https://www.jianshu.com/p/8dd4cfeae39d"}),"\n\u6765\u6e90\uff1a\u7b80\u4e66\n\u8457\u4f5c\u6743\u5f52\u4f5c\u8005\u6240\u6709\u3002\u5546\u4e1a\u8f6c\u8f7d\u8bf7\u8054\u7cfb\u4f5c\u8005\u83b7\u5f97\u6388\u6743\uff0c\u975e\u5546\u4e1a\u8f6c\u8f7d\u8bf7\u6ce8\u660e\u51fa\u5904\u3002"]}),"\n",(0,t.jsx)(r.h1,{id:"\u53c2\u8003\u6587\u7ae0",children:"\u53c2\u8003\u6587\u7ae0"}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.a,{href:"https://lijunyi.xyz/docs/SpringCloud/SpringCloud.html#_2-2-x-%E5%88%86%E6%94%AF",children:"https://lijunyi.xyz/docs/SpringCloud/SpringCloud.html#_2-2-x-%E5%88%86%E6%94%AF"}),"\n",(0,t.jsx)(r.a,{href:"https://mp.weixin.qq.com/s/2jeovmj77O9Ux96v3A0NtA",children:"https://mp.weixin.qq.com/s/2jeovmj77O9Ux96v3A0NtA"}),"\n",(0,t.jsx)(r.a,{href:"https://juejin.cn/post/6931922457741770760",children:"https://juejin.cn/post/6931922457741770760"}),"\n",(0,t.jsx)(r.a,{href:"https://github.com/D2C-Cai/herring",children:"https://github.com/D2C-Cai/herring"}),"\n",(0,t.jsx)(r.a,{href:"http://c.biancheng.net/springcloud",children:"http://c.biancheng.net/springcloud"}),"\n",(0,t.jsx)(r.a,{href:"https://github.com/macrozheng/springcloud-learning",children:"https://github.com/macrozheng/springcloud-learning"})]})]})}function u(e={}){const{wrapper:r}={...(0,s.a)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},88672:(e,r,n)=>{n.d(r,{Z:()=>a,a:()=>i});var t=n(50959);const s={},o=t.createContext(s);function i(e){const r=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),t.createElement(o.Provider,{value:r},e.children)}}}]);