"use strict";(self.webpackChunkcode_note_blog=self.webpackChunkcode_note_blog||[]).push([[5833],{21982:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>t,default:()=>j,frontMatter:()=>i,metadata:()=>l,toc:()=>a});var s=r(11527),c=r(88672);const i={},t=void 0,l={id:"Spring\u5168\u5bb6\u6876/Spring\u6e90\u7801\u5206\u6790/Spring\u91cd\u8981\u673a\u5236\u63a2\u79d8/Spring\u63a2\u79d8\u4e4b\u5faa\u73af\u4f9d\u8d56\u7684\u89e3\u51b3\uff08\u4e8c\uff09\uff1a\u6e90\u7801\u5206\u6790",title:"Spring\u63a2\u79d8\u4e4b\u5faa\u73af\u4f9d\u8d56\u7684\u89e3\u51b3\uff08\u4e8c\uff09\uff1a\u6e90\u7801\u5206\u6790",description:"\u5728 spring \u63a2\u79d8\u4e4b\u5faa\u73af\u4f9d\u8d56\uff08\u4e00\uff09\uff1a\u7406\u8bba\u57fa\u77f3\u4e00\u6587\u4e2d \uff0c\u6211\u4eec\u63d0\u5230 spring \u89e3\u51b3\u5faa\u73af\u4f9d\u8d56\u7684\u6d41\u7a0b\u5982\u4e0b:",source:"@site/docs/Spring\u5168\u5bb6\u6876/Spring\u6e90\u7801\u5206\u6790/Spring\u91cd\u8981\u673a\u5236\u63a2\u79d8/Spring\u63a2\u79d8\u4e4b\u5faa\u73af\u4f9d\u8d56\u7684\u89e3\u51b3\uff08\u4e8c\uff09\uff1a\u6e90\u7801\u5206\u6790.md",sourceDirName:"Spring\u5168\u5bb6\u6876/Spring\u6e90\u7801\u5206\u6790/Spring\u91cd\u8981\u673a\u5236\u63a2\u79d8",slug:"/Spring\u5168\u5bb6\u6876/Spring\u6e90\u7801\u5206\u6790/Spring\u91cd\u8981\u673a\u5236\u63a2\u79d8/Spring\u63a2\u79d8\u4e4b\u5faa\u73af\u4f9d\u8d56\u7684\u89e3\u51b3\uff08\u4e8c\uff09\uff1a\u6e90\u7801\u5206\u6790",permalink:"/code-note-blog/docs/Spring\u5168\u5bb6\u6876/Spring\u6e90\u7801\u5206\u6790/Spring\u91cd\u8981\u673a\u5236\u63a2\u79d8/Spring\u63a2\u79d8\u4e4b\u5faa\u73af\u4f9d\u8d56\u7684\u89e3\u51b3\uff08\u4e8c\uff09\uff1a\u6e90\u7801\u5206\u6790",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Spring\u5168\u5bb6\u6876/Spring\u6e90\u7801\u5206\u6790/Spring\u91cd\u8981\u673a\u5236\u63a2\u79d8/Spring\u63a2\u79d8\u4e4b\u5faa\u73af\u4f9d\u8d56\u7684\u89e3\u51b3\uff08\u4e8c\uff09\uff1a\u6e90\u7801\u5206\u6790.md",tags:[],version:"current",frontMatter:{},sidebar:"spring",previous:{title:"Spring\u63a2\u79d8\u4e4b\u76d1\u542c\u5668\u6ce8\u89e3EventListener",permalink:"/code-note-blog/docs/Spring\u5168\u5bb6\u6876/Spring\u6e90\u7801\u5206\u6790/Spring\u91cd\u8981\u673a\u5236\u63a2\u79d8/Spring\u63a2\u79d8\u4e4b\u76d1\u542c\u5668\u6ce8\u89e3EventListener"},next:{title:"Spring\u63a2\u79d8\u4e4b\u5faa\u73af\u4f9d\u8d56\u7684\u89e3\u51b3\uff08\u4e00\uff09\uff1a\u7406\u8bba\u57fa\u77f3",permalink:"/code-note-blog/docs/Spring\u5168\u5bb6\u6876/Spring\u6e90\u7801\u5206\u6790/Spring\u91cd\u8981\u673a\u5236\u63a2\u79d8/Spring\u63a2\u79d8\u4e4b\u5faa\u73af\u4f9d\u8d56\u7684\u89e3\u51b3\uff08\u4e00\uff09\uff1a\u7406\u8bba\u57fa\u77f3"}},d={},a=[{value:"1. \u51c6\u5907 demo",id:"1-\u51c6\u5907-demo",level:3},{value:"2. \u7b2c\u4e00\u6b21\u8c03\u7528 <code>AbstractBeanFactory#getBean(String)</code>\uff1a\u83b7\u53d6 <code>service1</code>",id:"2-\u7b2c\u4e00\u6b21\u8c03\u7528-abstractbeanfactorygetbeanstring\u83b7\u53d6-service1",level:3},{value:"2.1 <code>AbstractBeanFactory#doGetBean</code>",id:"21-abstractbeanfactorydogetbean",level:3},{value:"2.2 <code>DefaultSingletonBeanRegistry#getSingleton(String, boolean)</code>",id:"22-defaultsingletonbeanregistrygetsingletonstring-boolean",level:4},{value:"2.3 <code>DefaultSingletonBeanRegistry#getSingleton(String, ObjectFactory&lt;?&gt;)</code>",id:"23-defaultsingletonbeanregistrygetsingletonstring-objectfactory",level:4},{value:"2.4 <code>AbstractAutowireCapableBeanFactory#doCreateBean</code>",id:"24-abstractautowirecapablebeanfactorydocreatebean",level:4},{value:"3. \u7b2c\u4e8c\u6b21\u8c03\u7528 <code>AbstractBeanFactory#getBean(String)</code>\uff1a\u83b7\u53d6 <code>service2</code>",id:"3-\u7b2c\u4e8c\u6b21\u8c03\u7528-abstractbeanfactorygetbeanstring\u83b7\u53d6-service2",level:3},{value:"3.1 <code>AbstractBeanFactory#doGetBean</code>",id:"31-abstractbeanfactorydogetbean",level:4},{value:"3.2 <code>DefaultSingletonBeanRegistry#getSingleton(String, boolean)</code>",id:"32-defaultsingletonbeanregistrygetsingletonstring-boolean",level:4},{value:"3.3 <code>DefaultSingletonBeanRegistry#getSingleton(String, ObjectFactory&lt;?&gt;)</code>",id:"33-defaultsingletonbeanregistrygetsingletonstring-objectfactory",level:4},{value:"3.4 <code>AbstractAutowireCapableBeanFactory#doCreateBean</code>",id:"34-abstractautowirecapablebeanfactorydocreatebean",level:4},{value:"4. \u7b2c\u4e09\u6b21\u8c03\u7528 <code>AbstractBeanFactory#getBean(String)</code>\uff1a\u518d\u6b21\u83b7\u53d6 <code>service1</code>",id:"4-\u7b2c\u4e09\u6b21\u8c03\u7528-abstractbeanfactorygetbeanstring\u518d\u6b21\u83b7\u53d6-service1",level:3},{value:"4.1 <code>AbstractBeanFactory#doGetBean</code>",id:"41-abstractbeanfactorydogetbean",level:4},{value:"4.2 <code>DefaultSingletonBeanRegistry#getSingleton(String, boolean)</code>",id:"42-defaultsingletonbeanregistrygetsingletonstring-boolean",level:4},{value:"4.3 \u518d\u6b21\u56de\u5230 <code>AbstractBeanFactory#doGetBean</code>",id:"43-\u518d\u6b21\u56de\u5230-abstractbeanfactorydogetbean",level:4},{value:"5 \u7ee7\u7eed <code>service2</code> \u7684\u83b7\u53d6\u6d41\u7a0b",id:"5-\u7ee7\u7eed-service2-\u7684\u83b7\u53d6\u6d41\u7a0b",level:3},{value:"5.1 \u56de\u5230 <code>AbstractAutowireCapableBeanFactory#doCreateBean</code>",id:"51-\u56de\u5230-abstractautowirecapablebeanfactorydocreatebean",level:4},{value:"5.2 \u56de\u5230 <code>DefaultSingletonBeanRegistry#getSingleton(String, ObjectFactory&lt;?&gt;)</code>",id:"52-\u56de\u5230-defaultsingletonbeanregistrygetsingletonstring-objectfactory",level:4},{value:"6 \u7ee7\u7eed <code>service1</code> \u7684\u83b7\u53d6\u6d41\u7a0b",id:"6-\u7ee7\u7eed-service1-\u7684\u83b7\u53d6\u6d41\u7a0b",level:3},{value:"6.1 \u56de\u5230 <code>AbstractAutowireCapableBeanFactory#doCreateBean</code>",id:"61-\u56de\u5230-abstractautowirecapablebeanfactorydocreatebean",level:4},{value:"6.2 \u56de\u5230 <code>DefaultSingletonBeanRegistry#getSingleton(String, ObjectFactory&lt;?&gt;)</code>",id:"62-\u56de\u5230-defaultsingletonbeanregistrygetsingletonstring-objectfactory",level:4},{value:"4. \u603b\u7ed3",id:"4-\u603b\u7ed3",level:3}];function o(e){const n={a:"a",blockquote:"blockquote",code:"code",em:"em",h3:"h3",h4:"h4",hr:"hr",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,c.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:["\u5728 ",(0,s.jsx)(n.a,{href:"https://my.oschina.net/funcy/blog/4659555",title:"spring\u63a2\u79d8\u4e4b\u5faa\u73af\u4f9d\u8d56\uff08\u4e00\uff09\uff1a\u7406\u8bba\u57fa\u77f3",children:"spring \u63a2\u79d8\u4e4b\u5faa\u73af\u4f9d\u8d56\uff08\u4e00\uff09\uff1a\u7406\u8bba\u57fa\u77f3"}),"\u4e00\u6587\u4e2d \uff0c\u6211\u4eec\u63d0\u5230 spring \u89e3\u51b3\u5faa\u73af\u4f9d\u8d56\u7684\u6d41\u7a0b\u5982\u4e0b:"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-dc325a87b321e4c246a1b2f14169821a75a.png",alt:""})}),"\n",(0,s.jsxs)(n.p,{children:["\u4e3a\u4e86\u80fd\u8ba9\u4ee5\u4e0a\u6d41\u7a0b\u80fd\u987a\u5229\u8fdb\u884c\uff0cspring \u4e2d\u53c8\u63d0\u4f9b\u4e86 5 \u4e2a\u6570\u636e\u7ed3\u6784\u6765\u4fdd\u5b58\u6d41\u7a0b\u4e2d\u4ea7\u751f\u7684\u5173\u952e\u4fe1\u606f\uff0c\u8fd9 5 \u4e2a\u6570\u636e\u7ed3\u6784\u5982\u4e0b\uff08\u4e0b\u6587\u5c06\u8fd9 5 \u4e2a\u6570\u636e\u7ed3\u6784\u79f0\u4e3a ",(0,s.jsx)(n.strong,{children:"5 \u5927\u7ed3\u6784"}),"\uff09\uff1a"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u7ed3\u6784"}),(0,s.jsx)(n.th,{children:"\u8bf4\u660e"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonObjects"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.strong,{children:"\u4e00\u7ea7\u7f13\u5b58"}),"\uff0c\u7c7b\u578b\u4e3a ",(0,s.jsx)(n.code,{children:"ConcurrentHashMap<String, Object>"}),"\uff0c\u4f4d\u4e8e ",(0,s.jsx)(n.code,{children:"DefaultSingletonBeanRegistry"})," \u7c7b\u4e2d\uff0c",(0,s.jsx)(n.code,{children:"key"})," \u4e3a ",(0,s.jsx)(n.code,{children:"beanName"}),"\uff0c",(0,s.jsx)(n.code,{children:"value"})," \u662f\u5b8c\u6574\u7684 ",(0,s.jsx)(n.code,{children:"spring bean"}),"\uff0c\u5373\u5b8c\u6210\u5c5e\u6027\u6ce8\u5165\u3001\u521d\u59cb\u5316\u7684 bean\uff0c\u5982\u679c bean \u9700\u8981 aop\uff0c\u5b58\u50a8\u7684\u5c31\u662f\u4ee3\u7406\u5bf9\u8c61"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlySingletonObjects"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.strong,{children:"\u4e8c\u7ea7\u7f13\u5b58"}),"\uff0c\u7c7b\u578b\u4e3a ",(0,s.jsx)(n.code,{children:"HashMap<String, Object>"}),"\uff0c\u4f4d\u4e8e ",(0,s.jsx)(n.code,{children:"DefaultSingletonBeanRegistry"})," \u7c7b\u4e2d\uff0c",(0,s.jsx)(n.code,{children:"key"})," \u4e3a ",(0,s.jsx)(n.code,{children:"beanName"}),"\uff0c",(0,s.jsx)(n.code,{children:"value"})," \u662f\u5b9e\u4f8b\u5316\u5b8c\u6210\uff0c\u4f46\u672a\u8fdb\u884c\u4f9d\u8d56\u6ce8\u5165\u7684 ",(0,s.jsx)(n.code,{children:"bean"}),"\uff0c",(0,s.jsxs)(n.strong,{children:["\u5982\u679c ",(0,s.jsx)(n.code,{children:"bean"})," \u9700\u8981 ",(0,s.jsx)(n.code,{children:"aop"}),"\uff0c\u8fd9\u91cc\u5b58\u50a8\u7684\u5c31\u662f\u4ee3\u7406\u5bf9\u8c61\uff0c\u53ea\u4e0d\u8fc7\u4ee3\u7406\u5bf9\u8c61\u6240\u6301\u6709\u7684\u539f\u59cb\u5bf9\u8c61\u5e76\u672a\u8fdb\u884c\u4f9d\u8d56\u6ce8\u5165"]})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonFactories"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.strong,{children:"\u4e09\u7ea7\u7f13\u5b58"}),"\uff0c\u7c7b\u578b\u4e3a ",(0,s.jsx)(n.code,{children:"HashMap<String, ObjectFactory>"}),"\uff0c\u4f4d\u4e8e ",(0,s.jsx)(n.code,{children:"DefaultSingletonBeanRegistry"})," \u7c7b\u4e2d\uff0c",(0,s.jsx)(n.code,{children:"key"})," \u4e3a ",(0,s.jsx)(n.code,{children:"beanName"}),"\uff0c",(0,s.jsx)(n.code,{children:"value"})," \u5b58\u50a8\u7684\u662f\u4e00\u4e2a ",(0,s.jsx)(n.code,{children:"lambda"})," \u8868\u8fbe\u5f0f\uff1a",(0,s.jsx)(n.code,{children:"() -> getEarlyBeanReference(beanName, mbd, bean)"}),"\uff0c",(0,s.jsx)(n.code,{children:"getEarlyBeanReference(xxx)"})," \u4e2d\u7684 ",(0,s.jsx)(n.code,{children:"bean"})," \u662f\u521a\u521b\u5efa\u5b8c\u6210\u7684 ",(0,s.jsx)(n.code,{children:"java bean"}),"\uff0c\u6ca1\u6709\u8fdb\u884c spring \u4f9d\u8d56\u6ce8\u5165\uff0c\u4e5f\u6ca1\u8fdb\u884c aop"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})}),(0,s.jsxs)(n.td,{children:["\u7c7b\u578b\u4e3a ",(0,s.jsx)(n.code,{children:"SetFromMap<String>"}),"\uff0c\u4f4d\u4e8e ",(0,s.jsx)(n.code,{children:"DefaultSingletonBeanRegistry"}),"\uff0c\u521b\u5efa\u65b9\u5f0f\u4e3a ",(0,s.jsx)(n.code,{children:"Collections.newSetFromMap(new ConcurrentHashMap<>(16))"}),"\uff0c\u8868\u660e\u8fd9\u662f\u4e2a\u7531 ",(0,s.jsx)(n.code,{children:"ConcurrentHashMap"})," \u5b9e\u73b0\u7684 set\uff0c\u5b58\u50a8\u7684\u662f\u6b63\u5728\u521b\u5efa\u4e2d\u7684\u5bf9\u8c61\uff0c\u53ef\u4ee5",(0,s.jsx)(n.strong,{children:"\u7528\u6765\u5224\u65ad\u5f53\u524d\u5bf9\u8c61\u662f\u5426\u5728\u521b\u5efa\u4e2d"})]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlyProxyReferences"})}),(0,s.jsxs)(n.td,{children:["\u7c7b\u578b\u4e3a ",(0,s.jsx)(n.code,{children:"ConcurrentHashMap<Object, Object>"}),"\uff0c\u4f4d\u4e8e ",(0,s.jsx)(n.code,{children:"AbstractAutoProxyCreator"}),"\uff0c\u5b58\u50a8\u7684\u662f\u63d0\u524d\u8fdb\u884c aop \u7684\u5bf9\u8c61\uff0c\u53ef\u4ee5",(0,s.jsx)(n.strong,{children:"\u7528\u6765\u5224\u65ad bean \u662f\u5426\u8fdb\u884c\u8fc7 aop\uff0c\u4fdd\u8bc1\u6bcf\u4e2a\u5bf9\u8c61\u53ea\u8fdb\u884c\u4e00\u6b21 aop"})]})]})]})]}),"\n",(0,s.jsx)(n.p,{children:"\u4e86\u89e3\u4e86\u8fd9\u4e9b\u4e4b\u540e\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6b63\u5f0f\u5f00\u59cb\u8fdb\u884c\u6e90\u7801\u5206\u6790\u4e86\u3002"}),"\n",(0,s.jsx)(n.h3,{id:"1-\u51c6\u5907-demo",children:"1. \u51c6\u5907 demo"}),"\n",(0,s.jsxs)(n.p,{children:["\u672c\u6587\u4e2d\u7684\u793a\u4f8b demo \u4f4d\u4e8e ",(0,s.jsx)(n.a,{href:"https://gitee.com/funcy/spring-framework/tree/v5.2.2.RELEASE_learn/spring-learn/src/main/java/org/springframework/learn/explore/demo03",title:"gitee.com/funcy",children:"gitee.com/funcy"}),"\uff0c\u8fd9\u91cc\u4ec5\u7ed9\u51fa\u5173\u952e\u4ee3\u7801\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"\u51c6\u5907\u4e24\u4e2a service\uff1aservice1\uff0cservice2\uff0c\u8fd9\u4e24\u4e2a service \u91cc\u90fd\u6709\u4e00\u4e2a\u4ee3\u7406\u65b9\u6cd5\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'@Service\npublic class Service1 {\n\n    @Autowired\n    private Service2 service2;\n\n    public Service1() {\n        System.out.println("\u8c03\u7528service1\u7684\u6784\u9020\u65b9\u6cd5");\n    }\n\n    /**\n     * \u6807\u6ce8 @AopAnnotation \u4e86\uff0c\u8868\u660e\u8fd9\u4e2a\u65b9\u6cd5\u8981\u88ab\u4ee3\u7406\n     */\n    @AopAnnotation\n    public void printAutowired() {\n        System.out.println("Service1 Autowired:" + service2.getClass());\n    }\n\n    @Override\n    public String toString() {\n        return "Service1:" + getClass();\n    }\n}\n\n@Component\npublic class Service2 {\n\n    @Autowired\n    private Service1 service1;\n\n    public Service2() {\n        System.out.println("\u8c03\u7528service2\u7684\u6784\u9020\u65b9\u6cd5");\n    }\n\n    /**\n     * \u6807\u6ce8 @AopAnnotation \u4e86\uff0c\u8868\u660e\u8fd9\u4e2a\u65b9\u6cd5\u8981\u88ab\u4ee3\u7406\n     */\n    @AopAnnotation\n    public void printAutowired() {\n        System.out.println("Service2 Autowired:" + service1.getClass());\n    }\n\n    @Override\n    public String toString() {\n        return "Service2:" + this.getClass();\n    }\n}\n\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u8fd9\u91cc\u662f\u4e3b\u7c7b\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'public class Demo03Main {\n\n    public static void main(String[] args) {\n        ApplicationContext context = \n                new AnnotationConfigApplicationContext(AopAnnotationConfig.class);\n        Object obj1 = context.getBean("service1");\n        Object obj2 = context.getBean("service2");\n        ((Service1)obj1).printAutowired();\n        ((Service2)obj2).printAutowired();\n    }\n}\n\n'})}),"\n",(0,s.jsxs)(n.p,{children:["\u5728 ",(0,s.jsx)(n.code,{children:"Service1"})," \u4e2d\uff0c\u9700\u8981\u6ce8\u5165\u5c5e\u6027 ",(0,s.jsx)(n.code,{children:"service2"}),"\uff0c\u5728\u5728 ",(0,s.jsx)(n.code,{children:"Service2"})," \u4e2d\uff0c\u9700\u8981\u6ce8\u5165\u5c5e\u6027 ",(0,s.jsx)(n.code,{children:"service1"}),"\uff0c\u4e14 ",(0,s.jsx)(n.code,{children:"Service1"}),"\u3001",(0,s.jsx)(n.code,{children:"Service2"})," \u90fd\u9700\u8981\u8fdb\u884c\u4ee3\u7406\uff0c\u6700\u7ec8 ",(0,s.jsx)(n.code,{children:"main()"})," \u65b9\u6cd5\u6267\u884c\u7ed3\u679c\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"\u8c03\u7528service1\u7684\u6784\u9020\u65b9\u6cd5\n\u8c03\u7528service2\u7684\u6784\u9020\u65b9\u6cd5\nDisconnected from the target VM, address: 'localhost:55518', transport: 'socket'\nConnected to the target VM, address: '127.0.0.1:55507', transport: 'socket'\n@Around: before execute...\nService1 Autowired:class org.springframework.learn.explore.demo03.Service2$$EnhancerBySpringCGLIB$$e7e367ab\n@Around: after execute...\n@Around: before execute...\nService2 Autowired:class org.springframework.learn.explore.demo03.Service1$$EnhancerBySpringCGLIB$$d447df08\n@Around: after execute...\n\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u5f97\u5230\u7684 obj1\u3001obj2 \u5206\u522b\u4e3a"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-201844d13a7b489d1a18a8218d6440d6068.png",alt:""})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-3781280ce3f4da91504b0665ebfd3aed05b.png",alt:""})}),"\n",(0,s.jsx)(n.p,{children:"\u5206\u6790\u5185\u5bb9\uff0c\u4e0d\u96be\u5f97\u51fa\u5982\u4e0b\u7ed3\u8bba\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"service1"})," \u4e0e ",(0,s.jsx)(n.code,{children:"service2"})," \u7684 ",(0,s.jsx)(n.code,{children:"printAutowired()"})," \u65b9\u6cd5\u90fd\u8f93\u51fa\u4e86\u5207\u9762\u65b9\u6cd5\u7684\u5185\u5bb9\uff0c\u8868\u660e\u4e24\u8005\u90fd\u4ee3\u7406\u6210\u529f\u4e86\uff1b"]}),"\n",(0,s.jsxs)(n.li,{children:["\u4ece\u5bb9\u5668\u4e2d\u83b7\u53d6\u7684\u7684 ",(0,s.jsx)(n.code,{children:"service1"})," \u4e0e ",(0,s.jsx)(n.code,{children:"service2"})," \u90fd\u662f\u4ee3\u7406\u5bf9\u8c61\uff1b"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"service1"})," \u7684\u4ee3\u7406\u5bf9\u8c61\u6301\u6709 ",(0,s.jsx)(n.code,{children:"service1"})," \u7684\u539f\u59cb\u5bf9\u8c61\uff0c",(0,s.jsx)(n.code,{children:"service2"})," \u7684\u4ee3\u7406\u5bf9\u8c61\u6301\u6709 ",(0,s.jsx)(n.code,{children:"service2"})," \u7684\u539f\u59cb\u5bf9\u8c61\uff1b"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"service1"})," \u7684\u539f\u59cb\u5bf9\u8c61\u4e2d\u6ce8\u5165\u7684 ",(0,s.jsx)(n.code,{children:"service2"})," \u4e3a\u4ee3\u7406\u5bf9\u8c61\uff0c",(0,s.jsx)(n.code,{children:"service2"})," \u7684\u539f\u59cb\u5bf9\u8c61\u4e2d\u6ce8\u5165\u7684 ",(0,s.jsx)(n.code,{children:"service1"})," \u4e3a\u4ee3\u7406\u5bf9\u8c61\u3002"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c31\u4ece\u6e90\u7801\u5206\u6790\uff0c\u770b spring \u662f\u5982\u4f55\u4e00\u6b65\u6b65\u8fd0\u884c\uff0c\u6700\u7ec8\u5f97\u5230\u8fd9\u4e2a\u7ed3\u679c\u7684\u3002"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"service1"})," \u4e0e ",(0,s.jsx)(n.code,{children:"service2"})," \u7684\u4ee3\u7406\u5bf9\u8c61\u662f\u7531 ",(0,s.jsx)(n.code,{children:"cglib"})," \u4ee3\u7406\u4ea7\u751f\u7684\uff0c\u8fd9\u90e8\u5206\u5185\u5bb9\u4e0e\u672c\u6587\u65e0\u5173\uff0c\u5c31\u4e0d\u5206\u6790\u4e86\u3002"]}),"\n"]}),"\n",(0,s.jsxs)(n.h3,{id:"2-\u7b2c\u4e00\u6b21\u8c03\u7528-abstractbeanfactorygetbeanstring\u83b7\u53d6-service1",children:["2. \u7b2c\u4e00\u6b21\u8c03\u7528 ",(0,s.jsx)(n.code,{children:"AbstractBeanFactory#getBean(String)"}),"\uff1a\u83b7\u53d6 ",(0,s.jsx)(n.code,{children:"service1"})]}),"\n",(0,s.jsxs)(n.p,{children:["spring bean \u7684\u521b\u5efa\u3001\u4f9d\u8d56\u6ce8\u5165\u6d41\u7a0b\u662f\u4ece ",(0,s.jsx)(n.code,{children:"AbstractBeanFactory#getBean(String)"})," \u65b9\u6cd5\u5f00\u59cb\uff0c\u8fd9\u4e00\u70b9\u53ef\u53c2\u8003 ",(0,s.jsx)(n.a,{href:"https://my.oschina.net/funcy/blog/4658230",children:"spring \u542f\u52a8\u6d41\u7a0b\u4e4b\u5b8c\u6210 BeanFactory \u7684\u521d\u59cb\u5316"}),"\uff0c\u6211\u4eec\u7684\u6e90\u7801\u5206\u6790\u4e5f\u4ece\u8fd9\u4e2a\u65b9\u6cd5\u5165\u624b\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"\u672c\u6587\u4e00\u5f00\u59cb\uff0c\u5c31\u63d0\u5230\u4e86 spring \u4e3a\u89e3\u51b3\u5faa\u73af\u4f9d\u8d56\u7684 5 \u5927\u7ed3\u6784\uff0c\u8fd9\u91cc\u5c55\u793a\u5982\u4e0b\uff1a"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u7ed3\u6784"}),(0,s.jsx)(n.th,{children:"\u5185\u5bb9"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonObjects"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlySingletonObjects"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonFactories"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlyProxyReferences"})}),(0,s.jsx)(n.td,{})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["\u4e00\u5f00\u59cb\uff0c5 \u5927\u7ed3\u6784\u4e2d\u5173\u4e8e ",(0,s.jsx)(n.code,{children:"service1"})," \u4e0e ",(0,s.jsx)(n.code,{children:"service2"})," \u7684\u4ec0\u4e48\u6570\u636e\u90fd\u6ca1\u6709 \uff0c\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u4e00\u8fb9\u5206\u6790\u4ee3\u7801\uff0c\u4e00\u8fb9\u5173\u6ce8\u8fd9\u51e0\u4e2a\u7ed3\u6784\u4e2d\u7684\u5185\u5bb9\u3002"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["\u4e8b\u5b9e\u4e0a\uff0c5 \u5927\u7ed3\u6784\u662f\u6709\u5185\u5bb9\u7684\uff0c\u90a3\u662f spring \u5185\u90e8\u63d0\u4f9b\u7684\u4e00\u4e9b bean\uff0c\u4f46\u7531\u4e8e\u6211\u4eec\u53ea\u5173\u6ce8 ",(0,s.jsx)(n.code,{children:"service1"})," \u4e0e ",(0,s.jsx)(n.code,{children:"service2"})," \u76f8\u5173\u7684\u5185\u5bb9\uff0c\u56e0\u6b64\u8fd9\u91cc\u4e0d\u5c55\u793a\u3002"]}),"\n"]}),"\n",(0,s.jsxs)(n.h3,{id:"21-abstractbeanfactorydogetbean",children:["2.1 ",(0,s.jsx)(n.code,{children:"AbstractBeanFactory#doGetBean"})]}),"\n",(0,s.jsxs)(n.p,{children:["\u83b7\u53d6 ",(0,s.jsx)(n.code,{children:"service1"})," \u7684\u4ee3\u7801\u5728 ",(0,s.jsx)(n.code,{children:"AbstractBeanFactory#getBean(String)"}),"\uff0c\u4f46\u771f\u6b63\u7684\u83b7\u53d6\u64cd\u4f5c\u5374\u662f\u5728 ",(0,s.jsx)(n.code,{children:"AbstractBeanFactory#doGetBean"})," \u4e2d\uff0c\u8c03\u7528\u94fe\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"|-AbstractBeanFactory#getBean(String)\n |-AbstractBeanFactory#doGetBean\n\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u4ee3\u7801\u5982\u4e0b\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"    protected <T> T doGetBean(final String name, @Nullable final Class<T> requiredType,\n            @Nullable final Object[] args, boolean typeCheckOnly) throws BeansException {\n\n        ...\n        // 1\\. \u68c0\u67e5\u662f\u5426\u5df2\u521d\u59cb\u5316\uff0c\u8fd9\u91cc\u4f1a\u628abeanName\u653e\u5165singletonsCurrentlyInCreation\u4e2d\n        Object sharedInstance = getSingleton(beanName);\n        ...\n        // \u5982\u679c\u662f\u5355\u4f8b\u7684\n        if (mbd.isSingleton()) {\n            // 2\\. getSingleton(): \u521b\u5efa\u5bf9\u8c61\uff0c\u5220\u9664\u4e8c\u3001\u4e09\u7ea7\u7f13\u5b58\n            sharedInstance = getSingleton(beanName, () -> {\n                try {\n                    // \u6267\u884c\u521b\u5efa Bean\n                    return createBean(beanName, mbd, args);\n                }\n                catch (BeansException ex) {\n                    destroySingleton(beanName);\n                    throw ex;\n                }\n            });\n            // \u8fd9\u91cc\u5982\u679c\u662f\u666e\u901aBean \u7684\u8bdd\uff0c\u76f4\u63a5\u8fd4\u56de\uff0c\u5982\u679c\u662f FactoryBean \u7684\u8bdd\uff0c\n            // \u8fd4\u56de\u5b83\u521b\u5efa\u7684\u90a3\u4e2a\u5b9e\u4f8b\u5bf9\u8c61\n            bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);\n        }\n        ...\n    }\n\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u4ee5\u4e0a\u4ee3\u7801\u7ecf\u8fc7\u4e86\u7cbe\u7b80\uff0c\u6211\u4eec\u53ea\u4fdd\u7559\u4e86\u4e3b\u8981\u6d41\u7a0b\uff08\u540e\u7eed\u5206\u6790\u4e2d\uff0c\u4e5f\u4f1a\u7cbe\u7b80\u4ee3\u7801\uff0c\u53ea\u4fdd\u7559\u4e3b\u8981\u6d41\u7a0b\uff0c\u7701\u7565\u65e0\u5173\u4ee3\u7801\uff09\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u6709\u4e24\u4e2a\u5730\u65b9\u9700\u8981\u5206\u6790\uff1a"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"getSingleton(beanName)"}),"\uff1a\u83b7\u53d6\u5bf9\u8c61\uff0c\u53ea\u4ece\u4e09\u4e2a\u7f13\u5b58\u4e2d\u83b7\u53d6\uff1b"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"getSingleton(beanName, () -> { ... })"}),"\uff1a\u83b7\u53d6\u5bf9\u8c61\uff0c\u521b\u5efa\u4f1a\u5728\u8fd9\u91cc\u521b\u5efa\u3002"]}),"\n"]}),"\n",(0,s.jsxs)(n.h4,{id:"22-defaultsingletonbeanregistrygetsingletonstring-boolean",children:["2.2 ",(0,s.jsx)(n.code,{children:"DefaultSingletonBeanRegistry#getSingleton(String, boolean)"})]}),"\n",(0,s.jsxs)(n.p,{children:["\u6211\u4eec\u5148\u6765\u770b\u770b ",(0,s.jsx)(n.code,{children:"getSingleton(beanName)"}),"\uff0c\u8c03\u7528\u94fe\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"|-AbstractBeanFactory#getBean(String)\n |-AbstractBeanFactory#doGetBean\n  |-DefaultSingletonBeanRegistry#getSingleton(String)\n   |-DefaultSingletonBeanRegistry#getSingleton(String, boolean)\n\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u76f4\u63a5\u770b\u4ee3\u7801\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"/*\n * beanName: \u4f20\u5165\u7684\u503c\u4e3a service1\n * allowEarlyReference\uff1a\u4f20\u5165\u7684\u503c\u4e3a true\n */\nprotected Object getSingleton(String beanName, boolean allowEarlyReference) {\n    // 1\\. \u4ece\u4e00\u7ea7\u7f13\u5b58\u4e2d\u83b7\u53d6\uff0c\u8fd9\u91cc\u662f\u83b7\u53d6\u4e0d\u5230\n    Object singletonObject = this.singletonObjects.get(beanName);\n    // 2\\. isSingletonCurrentlyInCreation(...) \u5224\u65adservice1\u662f\u5426\u5728\u521b\u5efa\u4e2d\uff0c\u8fd4\u56de false\n    if (singletonObject == null && isSingletonCurrentlyInCreation(beanName)) {\n        // \u7701\u7565\u4e0b\u9762\u7684\u4ee3\u7801\n        ...\n    }\n    return singletonObject;\n}\n\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u5bf9\u4e0a\u8ff0\u4ee3\u7801\u5206\u6790\u5982\u4e0b\uff1a"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u4ece\u4e09\u7ea7\u7f13\u5b58\u4e2d\u83b7\u53d6\uff0c\u6b64\u65f6 ",(0,s.jsx)(n.code,{children:"singletonObjects"})," \u91cc\u5e76\u6ca1\u6709 ",(0,s.jsx)(n.code,{children:"service1"}),"\uff0c\u83b7\u53d6\u4e0d\u5230\uff1b"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u7ee7\u7eed\uff0c\u5224\u65ad ",(0,s.jsx)(n.code,{children:"service1"})," \u662f\u5426\u5728\u521b\u5efa\u4e2d\uff0c\u5224\u65ad\u65b9\u5f0f\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"public boolean isSingletonCurrentlyInCreation(String beanName) {\n    return this.singletonsCurrentlyInCreation.contains(beanName);\n}\n\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u663e\u7136\uff0c",(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})," \u662f\u6ca1\u6709 ",(0,s.jsx)(n.code,{children:"service1"})," \u7684\uff0c\u8fd9\u91cc\u4e5f\u8fd4\u56de false."]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"DefaultSingletonBeanRegistry#getSingleton(String, boolean)"})," \u8fd0\u884c\u5230\u8fd9\u91cc\u5c31\u8fd4\u56de\u4e86\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u91cc\u4e0b\u9762\u7684\u8fd4\u56de\u6211\u4eec\u5c31\u5148\u4e0d\u5206\u6790\u4e86\u3002"]}),"\n",(0,s.jsxs)(n.h4,{id:"23-defaultsingletonbeanregistrygetsingletonstring-objectfactory",children:["2.3 ",(0,s.jsx)(n.code,{children:"DefaultSingletonBeanRegistry#getSingleton(String, ObjectFactory<?>)"})]}),"\n",(0,s.jsxs)(n.p,{children:["\u8ba9\u6211\u4eec\u56de\u5230 ",(0,s.jsx)(n.code,{children:"AbstractBeanFactory#doGetBean"}),"\uff0c\u63a5\u7740\u5206\u6790 ",(0,s.jsx)(n.code,{children:"getSingleton(beanName, () -> { ... })"}),"\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'    /**\n     * beanName\uff1a\u4f20\u5165\u7684\u662fservice1\n     * singletonFactory\uff1a\u4f20\u5165\u7684\u662flambda\u8868\u8fbe\u5f0f\uff0c\u503c\u4e3a\n     *           () -> {\n     *               try {\n     *                   // \u8fd9\u91cc\u5c31\u662f\u521b\u5efabean\u7684\u6d41\u7a0b\n     *                   return createBean(beanName, mbd, args);\n     *               }\n     *               catch (BeansException ex) {\n     *                   destroySingleton(beanName);\n     *                   throw ex;\n     *               }\n     *           }\n     */\n    public Object getSingleton(String beanName, ObjectFactory<?> singletonFactory) {\n        Assert.notNull(beanName, "Bean name must not be null");\n        synchronized (this.singletonObjects) {\n            // \u518d\u6b21\u5224\u65adbean\u662f\u5426\u5df2\u5b58\u5728\n            Object singletonObject = this.singletonObjects.get(beanName);\n            if (singletonObject == null) {\n                // 1\\. \u5224\u65ad\u5f53\u524d\u6b63\u5728\u5b9e\u4f8b\u5316\u7684bean\u662f\u5426\u5b58\u5728\u6b63\u5728\u521b\u5efa\u4e2d\n                // \u8fd9\u4e2a\u65b9\u6cd5\u4f1abeanName\u6dfb\u52a0\u5230 singletonsCurrentlyInCreation \u4e2d\n                beforeSingletonCreation(beanName);\n                try {\n                    // 2\\. \u5728\u8fd9\u91cc\u8fdb\u884cbean\u7684\u521b\u5efa\n                    singletonObject = singletonFactory.getObject();\n                }\n                catch (...) {\n                    ...\n                }\n                ...\n            }\n            return singletonObject;\n        }\n    }\n\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u6309\u7167\u4ee3\u7801\u4e2d\u7684\u6ce8\u91ca\u5185\u5bb9\uff0c\u6211\u4eec\u5206\u6790\u4e3b\u8981\u6b65\u9aa4\uff1a"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u5224\u65ad\u5f53\u524d\u6b63\u5728\u5b9e\u4f8b\u5316\u7684 bean \u662f\u5426\u5b58\u5728\u6b63\u5728\u521b\u5efa\u4e2d\uff0c\u5c31\u662f\u5224\u65ad\u5f53\u524d\u5bf9\u8c61\u662f\u5426\u5728 ",(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})," \u4e2d\uff0c\u5982\u679c\u5b58\u5728\u5219\u629b\u51fa\u5f02\u5e38\uff0c\u4e0d\u5b58\u5728\u5219\u6dfb\u52a0\u5230 ",(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})," \u4e2d\uff1b"]}),"\n",(0,s.jsx)(n.p,{children:"\u8fd0\u884c\u5b8c\u4e4b\u540e\u8fd9\u4e00\u884c\u4ee3\u7801\u540e\uff0c5 \u5927\u7ed3\u6784\u4e2d\u7684\u5185\u5bb9\u5982\u4e0b\uff1a"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u7ed3\u6784"}),(0,s.jsx)(n.th,{children:"\u5185\u5bb9"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonObjects"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlySingletonObjects"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonFactories"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})}),(0,s.jsx)(n.td,{children:"service1"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlyProxyReferences"})}),(0,s.jsx)(n.td,{})]})]})]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u8fdb\u884c bean \u7684\u521b\u5efa\u8fc7\u7a0b\uff0c",(0,s.jsx)(n.code,{children:"singletonFactory.getObject()"})," \u8fd0\u884c\u7684\u5b9e\u9645\u4e0a\u662f\u4f20\u5165\u7684 lambda \u8868\u8fbe\u5f0f\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"() -> {\n    try {\n        // \u6267\u884c\u521b\u5efa Bean\n        return createBean(beanName, mbd, args);\n    }\n    catch (BeansException ex) {\n        destroySingleton(beanName);\n        throw ex;\n    }\n}\n\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u4e5f\u5c31\u662f ",(0,s.jsx)(n.code,{children:"AbstractAutowireCapableBeanFactory#createBean(String, RootBeanDefinition, Object[])"}),"\uff0c\u8fd9 \u4e2a\u65b9\u6cd5\u662f\u63a5\u4e0b\u6765\u5206\u6790\u7684\u91cd\u70b9\uff1b"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.h4,{id:"24-abstractautowirecapablebeanfactorydocreatebean",children:["2.4 ",(0,s.jsx)(n.code,{children:"AbstractAutowireCapableBeanFactory#doCreateBean"})]}),"\n",(0,s.jsxs)(n.p,{children:["\u4ece\u4ee3\u7801\u4e0a\u6765\u770b\uff0c",(0,s.jsx)(n.code,{children:"AbstractAutowireCapableBeanFactory#createBean(String, RootBeanDefinition, Object[])"})," \u5e76\u6ca1\u6709\u505a\u4ec0\u4e48\u5b9e\u8d28\u6027\u5185\u5bb9\uff0c\u6211\u4eec\u5c31\u76f4\u63a5\u6765\u5230 ",(0,s.jsx)(n.code,{children:"AbstractAutowireCapableBeanFactory#doCreateBean"})," \u4e86\uff0c\u8fd9\u5176\u4e2d\u7ecf\u5386\u7684\u5343\u5c71\u4e07\u6c34\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"|-AbstractBeanFactory#getBean(String)\n |-AbstractBeanFactory#doGetBean\n  |-DefaultSingletonBeanRegistry#getSingleton(String, ObjectFactory<?>)\n   |-AbstractAutowireCapableBeanFactory#createBean(String, RootBeanDefinition, Object[])\n    |-AbstractAutowireCapableBeanFactory#doCreateBean\n\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"AbstractAutowireCapableBeanFactory#doCreateBean"})," \u5185\u5bb9\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'protected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, \n        final @Nullable Object[] args) throws BeanCreationException {\n\n    BeanWrapper instanceWrapper = null;\n    if (instanceWrapper == null) {\n        // 1\\. \u5b9e\u4f8b\u5316 Bean\uff0c\u8c03\u7528java\u53cd\u5c04\u8fdb\u884c\u5b9e\u4f8b\u5316\n        instanceWrapper = createBeanInstance(beanName, mbd, args);\n    }\n    //bean\u5b9e\u4f8b\n    final Object bean = instanceWrapper.getWrappedInstance();\n    //bean\u7c7b\u578b\n    Class<?> beanType = instanceWrapper.getWrappedClass();\n    if (beanType != NullBean.class) {\n        mbd.resolvedTargetType = beanType;\n    }\n\n    synchronized (mbd.postProcessingLock) {\n        if (!mbd.postProcessed) {\n            try {\n                // \u8c03\u7528 AutowiredAnnotationBeanPostProcessor#postProcessMergedBeanDefinition \u65b9\u6cd5\n                // 2\\. \u83b7\u53d6\u9700\u8981\u6ce8\u5165\u7684\u5c5e\u6027\u4e0e\u65b9\u6cd5\uff08\u6807\u6ce8 @Autowired \u6ce8\u89e3\uff09\n                applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);\n            }\n            catch (Throwable ex) {\n                throw new BeanCreationException(mbd.getResourceDescription(), beanName,\n                        "Post-processing of merged bean definition failed", ex);\n            }\n            mbd.postProcessed = true;\n        }\n    }\n    // \u89e3\u51b3\u5faa\u73af\u4f9d\u8d56\u95ee\u9898, \u662f\u5426\u5141\u8bb8\u5faa\u73af\u4f9d\u8d56, allowCircularReferences\u9ed8\u8ba4\u4e3atrue\uff0c\u53ef\u4ee5\u5173\u95ed\n    boolean earlySingletonExposure = (mbd.isSingleton() && this.allowCircularReferences &&\n            isSingletonCurrentlyInCreation(beanName));\n    if (earlySingletonExposure) {\n        // 3\\. \u5c06 bean \u6dfb\u52a0\u5230 singletonFactories\n        addSingletonFactory(beanName, () -> getEarlyBeanReference(beanName, mbd, bean));\n    }\n\n    Object exposedObject = bean;\n    try {\n        // 4\\. \u5c5e\u6027\u6ce8\u5165\uff0c\u53d1\u73b0\u9700\u8981\u6ce8\u5165 service2\uff0c\u7136\u540e\u518d\u8c03\u7528 getBean("service2")\n        populateBean(beanName, mbd, instanceWrapper);\n        ...\n    }\n    catch (Throwable ex) {\n        ...\n    }\n}\n\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u8fd9\u4e2a\u65b9\u6cd5\u8fdb\u884c\u7684\u6b65\u9aa4\u5982\u4e0b\uff1a"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u5b9e\u4f8b\u5316 Bean\uff0c\u8c03\u7528 java \u53cd\u5c04\u8fdb\u884c\u5b9e\u4f8b\u5316\uff0c\u8fd9\u4e2a\u5c31\u4e0d\u591a\u8bf4\u4e86\uff0c\u5b9e\u4f8b\u5316\u540e\u7684 ",(0,s.jsx)(n.code,{children:"service1"})," \u5982\u4e0b\uff0c\u53ef\u4ee5\u770b\u5230 ",(0,s.jsx)(n.code,{children:"service2"})," \u8fd8\u662f ",(0,s.jsx)(n.code,{children:"null"}),"\uff08\u8868\u660e\u672a\u8fdb\u884c\u5c5e\u6027\u6ce8\u5165\uff09\uff1a"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-8b2f5fdf0efd6beb7f62d4f35f5c5562b83.png",alt:""})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u83b7\u53d6\u9700\u8981\u6ce8\u5165\u7684\u5c5e\u6027\u4e0e\u65b9\u6cd5\uff0c",(0,s.jsx)(n.strong,{children:"\u5fc5\u987b\u5728\u539f\u59cb\u5bf9\u8c61\u4e2d\u624d\u80fd\u83b7\u53d6\u5230\uff0c\u4ee3\u7406\u5bf9\u8c61\u662f\u83b7\u53d6\u4e0d\u5230\u7684"}),"\uff0c\u67e5\u627e ",(0,s.jsx)(n.code,{children:"@Autowired"})," \u7684 ",(0,s.jsx)(n.code,{children:"beanPostProcessor"})," \u662f ",(0,s.jsx)(n.code,{children:"AutowiredAnnotationBeanPostProcessor"}),"\uff1b"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u5c06 bean \u6dfb\u52a0\u5230 ",(0,s.jsx)(n.code,{children:"singletonFactories"})," \u4e2d\uff0c\u6dfb\u52a0\u8fc7\u7a0b\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'protected void addSingletonFactory(String beanName, ObjectFactory<?> singletonFactory) {\n    Assert.notNull(singletonFactory, "Singleton factory must not be null");\n    synchronized (this.singletonObjects) {\n        // \u5982\u679c\u5355\u4f8b\u6c60\u5f53\u4e2d\u4e0d\u5b58\u5728\u624d\u4f1aadd\n        if (!this.singletonObjects.containsKey(beanName)) {\n            // \u628a\u5de5\u5382\u5bf9\u8c61put\u5230singletonFactories\n            this.singletonFactories.put(beanName, singletonFactory);\n            // \u5220\u9664\u4e8c\u7ea7\u7f13\u5b58\u4e2d\u7684\u5bf9\u8c61\n            this.earlySingletonObjects.remove(beanName);\n            this.registeredSingletons.add(beanName);\n        }\n    }\n}\n\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u52a0\u5165\u7684\u5bf9\u8c61\u4e3a"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-3d9a56a0d655fe1e95d8857095fb46aa71a.png",alt:""})}),"\n",(0,s.jsx)(n.p,{children:"\u6b64\u65f6\u90a3 5 \u4e2a\u7ed3\u6784\u4e2d\u7684\u5185\u5bb9\u5982\u4e0b\uff1a"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u7ed3\u6784"}),(0,s.jsx)(n.th,{children:"\u5185\u5bb9"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonObjects"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlySingletonObjects"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonFactories"})}),(0,s.jsx)(n.td,{children:"lambda(service1)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})}),(0,s.jsx)(n.td,{children:"service1"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlyProxyReferences"})}),(0,s.jsx)(n.td,{})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"lambda(service1)"})," \u5b9e\u9645\u5185\u5bb9\u4e3a ",(0,s.jsx)(n.code,{children:"() -> getEarlyBeanReference(beanName, mbd, bean)"}),"\uff0c\u8fd9\u4e2a ",(0,s.jsx)(n.code,{children:"lambda"})," \u8868\u8fbe\u5f0f\u6240\u505a\u7684\u5c31\u662f\u8fdb\u884c aop \u64cd\u4f5c\uff0c\u5177\u4f53\u5185\u5bb9\u7b49\u8fd0\u884c\u7684\u65f6\u5019\u6211\u4eec\u518d\u5206\u6790\u3002"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u5c5e\u6027\u6ce8\u5165\uff0c\u5728\u7b2c 2 \u6b65\u4e2d\uff0cspring \u627e\u5230 ",(0,s.jsx)(n.code,{children:"service1"})," \u9700\u8981\u6ce8\u5165\u5bf9\u8c61\u6709 ",(0,s.jsx)(n.code,{children:"service2"}),"\uff0c\u8fd9\u91cc\u4f1a\u518d\u8c03\u7528 ",(0,s.jsx)(n.code,{children:'beanFactory.getBean("service2")'})," \u8fdb\u5165 ",(0,s.jsx)(n.code,{children:"service2"})," \u7684\u751f\u547d\u5468\u671f\uff0c\u8fd9\u53c8\u56de\u5230\u4e86 ",(0,s.jsx)(n.code,{children:"AbstractBeanFactory#getBean(String)"})," \u65b9\u6cd5\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:["\u4ece ",(0,s.jsx)(n.code,{children:"populateBean(xxx)"})," \u5230 ",(0,s.jsx)(n.code,{children:"getBean(xxx)"})," \u7684\u6b65\u9aa4\u76f8\u5f53\u591a\uff0c\u8c03\u7528\u94fe\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"|-AbstractBeanFactory#getBean(String)\n |-AbstractBeanFactory#doGetBean\n  |-DefaultSingletonBeanRegistry#getSingleton(String, ObjectFactory<?>)\n   |-AbstractAutowireCapableBeanFactory#createBean(String, RootBeanDefinition, Object[])\n    |-AbstractAutowireCapableBeanFactory#doCreateBean\n     // \u8fd9\u91cc\u8fdb\u884c\u4f9d\u8d56\u6ce8\u5165\n     |-AbstractAutowireCapableBeanFactory#populateBean\n      |-AutowiredAnnotationBeanPostProcessor#postProcessProperties\n       |-InjectionMetadata#inject\n        |-AutowiredAnnotationBeanPostProcessor.AutowiredFieldElement#inject\n         |-DefaultListableBeanFactory#resolveDependency\n          |-DefaultListableBeanFactory#doResolveDependency\n           |-DependencyDescriptor#resolveCandidate\n            |-AbstractBeanFactory#getBean(String)\n\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u770b\u4e00\u773c ",(0,s.jsx)(n.code,{children:"DependencyDescriptor#resolveCandidate"}),"\uff0c\u8c03\u7528\u7684\u6b63\u662f ",(0,s.jsx)(n.code,{children:"beanFactory.getBean(String)"})," \u65b9\u6cd5\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"public Object resolveCandidate(String beanName, Class<?> requiredType, BeanFactory beanFactory)\n        throws BeansException {\n    return beanFactory.getBean(beanName);\n}\n\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["\u5230\u4e86\u8fd9\u91cc\uff0c",(0,s.jsx)(n.code,{children:"service1"})," \u7684\u83b7\u53d6\u6d41\u7a0b\u5c31\u5148\u505c\u4e00\u4e0b\uff0c\u56e0\u4e3a ",(0,s.jsx)(n.code,{children:"service1"})," \u8981\u6ce8\u5165 ",(0,s.jsx)(n.code,{children:"service2"}),"\uff0c\u63a5\u4e0b\u6765\u5c31\u5f00\u59cb\u83b7\u53d6 ",(0,s.jsx)(n.code,{children:"service2"})," \u7684\u6d41\u7a0b\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"\u672c\u5c0f\u8282\u7ed3\u675f\u65f6\uff0c5 \u5927\u7ed3\u6784\u4e2d\u7684\u5185\u5bb9\u5982\u4e0b\uff1a"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u7ed3\u6784"}),(0,s.jsx)(n.th,{children:"\u5185\u5bb9"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonObjects"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlySingletonObjects"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonFactories"})}),(0,s.jsx)(n.td,{children:"lambda(service1)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})}),(0,s.jsx)(n.td,{children:"service1"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlyProxyReferences"})}),(0,s.jsx)(n.td,{})]})]})]}),"\n",(0,s.jsxs)(n.h3,{id:"3-\u7b2c\u4e8c\u6b21\u8c03\u7528-abstractbeanfactorygetbeanstring\u83b7\u53d6-service2",children:["3. \u7b2c\u4e8c\u6b21\u8c03\u7528 ",(0,s.jsx)(n.code,{children:"AbstractBeanFactory#getBean(String)"}),"\uff1a\u83b7\u53d6 ",(0,s.jsx)(n.code,{children:"service2"})]}),"\n",(0,s.jsxs)(n.h4,{id:"31-abstractbeanfactorydogetbean",children:["3.1 ",(0,s.jsx)(n.code,{children:"AbstractBeanFactory#doGetBean"})]}),"\n",(0,s.jsxs)(n.p,{children:["\u8fd9\u4e00\u6b65\u8ddf\u83b7\u53d6 ",(0,s.jsx)(n.code,{children:"service1"})," \u7684\u6d41\u7a0b\u57fa\u672c\u4e00\u81f4\uff0c\u4e0d\u540c\u7684\u662f ",(0,s.jsx)(n.code,{children:"beanName"})," \u662f ",(0,s.jsx)(n.code,{children:"service2"}),"\uff0c\u4e0d\u518d\u5206\u6790\u3002"]}),"\n",(0,s.jsxs)(n.h4,{id:"32-defaultsingletonbeanregistrygetsingletonstring-boolean",children:["3.2 ",(0,s.jsx)(n.code,{children:"DefaultSingletonBeanRegistry#getSingleton(String, boolean)"})]}),"\n",(0,s.jsxs)(n.p,{children:["\u8fd9\u4e00\u6b65\u8ddf\u83b7\u53d6 ",(0,s.jsx)(n.code,{children:"service1"})," \u7684\u6d41\u7a0b\u57fa\u672c\u4e00\u81f4\uff0c\u4e0d\u540c\u7684\u662f ",(0,s.jsx)(n.code,{children:"beanName"})," \u662f ",(0,s.jsx)(n.code,{children:"service2"}),"\uff0c\u4e0d\u518d\u5206\u6790\u3002"]}),"\n",(0,s.jsxs)(n.h4,{id:"33-defaultsingletonbeanregistrygetsingletonstring-objectfactory",children:["3.3 ",(0,s.jsx)(n.code,{children:"DefaultSingletonBeanRegistry#getSingleton(String, ObjectFactory<?>)"})]}),"\n",(0,s.jsxs)(n.p,{children:["\u8fd9\u4e00\u6b65\u8ddf\u83b7\u53d6 ",(0,s.jsx)(n.code,{children:"service1"})," \u7684\u6d41\u7a0b\u57fa\u672c\u4e00\u81f4\uff0c\u4e0d\u540c\u7684\u662f ",(0,s.jsx)(n.code,{children:"beanName"})," \u662f ",(0,s.jsx)(n.code,{children:"service2"}),"\uff0c\u5177\u4f53\u5185\u5bb9\u4e0d\u518d\u5206\u6790\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"service2"})," \u4f1a\u5728\u8fd9\u4e00\u6b65\u52a0\u5165 \u5230 ",(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})," \u7ed3\u6784\u4e2d\uff0c\u8fd9\u4e00\u6b65\u4e4b\u540e\uff0c5 \u5927\u7ed3\u6784\u4e2d\u7684\u5185\u5bb9\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u7ed3\u6784"}),(0,s.jsx)(n.th,{children:"\u5185\u5bb9"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonObjects"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlySingletonObjects"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonFactories"})}),(0,s.jsx)(n.td,{children:"lambda(service1)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})}),(0,s.jsx)(n.td,{children:"service1, service2"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlyProxyReferences"})}),(0,s.jsx)(n.td,{})]})]})]}),"\n",(0,s.jsxs)(n.h4,{id:"34-abstractautowirecapablebeanfactorydocreatebean",children:["3.4 ",(0,s.jsx)(n.code,{children:"AbstractAutowireCapableBeanFactory#doCreateBean"})]}),"\n",(0,s.jsxs)(n.p,{children:["\u8fd9\u4e00\u6b65\u8ddf\u83b7\u53d6 ",(0,s.jsx)(n.code,{children:"service1"})," \u7684\u6d41\u7a0b\u57fa\u672c\u4e00\u81f4\uff0c\u8bf4\u660e\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u5bf9\u8c61\u521b\u5efa\uff0c\u8fd9\u91cc\u4f1a\u521b\u5efa ",(0,s.jsx)(n.code,{children:"service2"}),"\uff0c\u521b\u5efa\u5b8c\u6210\u540e\u7684\u5bf9\u8c61\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-393811afa91cc1ff696b02ce6d683c97640.png",alt:""})}),"\n",(0,s.jsxs)(n.p,{children:["\u540c\u6837\u7684\uff0c",(0,s.jsx)(n.code,{children:"service2"})," \u4e2d\u7684\u5c5e\u6027 ",(0,s.jsx)(n.code,{children:"service1"})," \u4e5f\u4e3a ",(0,s.jsx)(n.code,{children:"null"}),"\uff1b"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u83b7\u53d6\u9700\u8981\u6ce8\u5165\u7684\u5c5e\u6027\u4e0e\u65b9\u6cd5\uff0c",(0,s.jsx)(n.code,{children:"service2"})," \u7684\u5c5e\u6027 ",(0,s.jsx)(n.code,{children:"service1"})," \u4f1a\u88ab\u627e\u5230\uff0c\u56e0\u4e3a\u8be5\u5c5e\u6027\u6807\u6ce8\u6709 ",(0,s.jsx)(n.code,{children:"@Autowired"})," \u6ce8\u89e3\uff1b"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u5c06 bean \u6dfb\u52a0\u5230 ",(0,s.jsx)(n.code,{children:"singletonFactories"})," \u4e2d\uff0c\u8fd9\u4e00\u6b65\u4e4b\u540e\uff0c5 \u4e2a\u7ed3\u6784\u4e2d\u7684\u5185\u5bb9\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u7ed3\u6784"}),(0,s.jsx)(n.th,{children:"\u5185\u5bb9"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonObjects"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlySingletonObjects"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonFactories"})}),(0,s.jsx)(n.td,{children:"lambda(service1), lambda(service2)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})}),(0,s.jsx)(n.td,{children:"service1, service2"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlyProxyReferences"})}),(0,s.jsx)(n.td,{})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["\u8fd9\u4e00\u6b65\u7684\u5173\u952e\u5728\u4e8e\uff0c",(0,s.jsx)(n.code,{children:"service2"})," \u6dfb\u52a0\u5230\u4e09\u7ea7\u7f13\u5b58\u4e2d\u4e86\uff1b"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u5c5e\u6027\u6ce8\u5165\uff0c\u5728\u7b2c 2 \u6b65\u4e2d\uff0cspring \u627e\u5230 ",(0,s.jsx)(n.code,{children:"service2"})," \u9700\u8981\u6ce8\u5165\u5bf9\u8c61\u6709 ",(0,s.jsx)(n.code,{children:"service1"}),"\uff0c\u8fd9\u91cc\u4f1a\u518d\u8c03\u7528 ",(0,s.jsx)(n.code,{children:'getBean("service2")'})," \u65b9\u6cd5\uff0c\u53c8\u56de\u5230\u4e86 ",(0,s.jsx)(n.code,{children:"AbstractBeanFactory#getBean(String)"})," \u65b9\u6cd5\u4e86\u3002"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["\u5230\u4e86\u8fd9\u91cc\uff0c",(0,s.jsx)(n.code,{children:"service2"})," \u7684\u83b7\u53d6\u6d41\u7a0b\u4e5f\u8981\u5148\u505c\u4e00\u4e0b\u4e86\uff0c\u56e0\u4e3a ",(0,s.jsx)(n.code,{children:"service2"})," \u8981\u6ce8\u5165 ",(0,s.jsx)(n.code,{children:"service1"}),"\uff0c\u63a5\u4e0b\u6765\u53c8\u8981\u5f00\u59cb\u83b7\u53d6 ",(0,s.jsx)(n.code,{children:"service1"})," \u7684\u6d41\u7a0b\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"\u672c\u5c0f\u8282\u7ed3\u675f\u65f6\uff0c5 \u4e2a\u7ed3\u6784\u4e2d\u7684\u5185\u5bb9\u5982\u4e0b\uff1a"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u7ed3\u6784"}),(0,s.jsx)(n.th,{children:"\u5185\u5bb9"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonObjects"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlySingletonObjects"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonFactories"})}),(0,s.jsx)(n.td,{children:"lambda(service1), lambda(service2)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})}),(0,s.jsx)(n.td,{children:"service1, service2"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlyProxyReferences"})}),(0,s.jsx)(n.td,{})]})]})]}),"\n",(0,s.jsxs)(n.h3,{id:"4-\u7b2c\u4e09\u6b21\u8c03\u7528-abstractbeanfactorygetbeanstring\u518d\u6b21\u83b7\u53d6-service1",children:["4. \u7b2c\u4e09\u6b21\u8c03\u7528 ",(0,s.jsx)(n.code,{children:"AbstractBeanFactory#getBean(String)"}),"\uff1a\u518d\u6b21\u83b7\u53d6 ",(0,s.jsx)(n.code,{children:"service1"})]}),"\n",(0,s.jsxs)(n.h4,{id:"41-abstractbeanfactorydogetbean",children:["4.1 ",(0,s.jsx)(n.code,{children:"AbstractBeanFactory#doGetBean"})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"AbstractBeanFactory#doGetBean"})," \u4ee3\u7801\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"    protected <T> T doGetBean(final String name, @Nullable final Class<T> requiredType,\n            @Nullable final Object[] args, boolean typeCheckOnly) throws BeansException {\n\n        ...\n        // 1\\. \u68c0\u67e5\u662f\u5426\u5df2\u521d\u59cb\u5316\uff0c\u8fd9\u91cc\u4f1a\u628abeanName\u653e\u5165singletonsCurrentlyInCreation\u4e2d\n        Object sharedInstance = getSingleton(beanName);\n        ...\n}\n\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u5728\u8fd0\u884c\u5230 ",(0,s.jsx)(n.code,{children:"Object sharedInstance = getSingleton(beanName)"})," \u524d\uff0c",(0,s.jsx)(n.code,{children:"AbstractBeanFactory#doGetBean"})," \u7684\u8fd0\u884c\u6d41\u7a0b\u4e0e\u524d\u9762\u4e24\u5c0f\u8282\u65e0\u533a\u522b\uff0c\u5728 ",(0,s.jsx)(n.code,{children:"Object sharedInstance = getSingleton(beanName)"})," \u91cc\u5c31\u6709\u4e86\u53d8\u5316\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u770b\u770b ",(0,s.jsx)(n.code,{children:"getSingleton(beanName)"})," \u7684\u6267\u884c\u3002"]}),"\n",(0,s.jsxs)(n.h4,{id:"42-defaultsingletonbeanregistrygetsingletonstring-boolean",children:["4.2 ",(0,s.jsx)(n.code,{children:"DefaultSingletonBeanRegistry#getSingleton(String, boolean)"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"/*\n * beanName: \u4f20\u5165\u7684\u503c\u4e3a service1\n * allowEarlyReference\uff1a\u4f20\u5165\u7684\u503c\u4e3a true\n */\nprotected Object getSingleton(String beanName, boolean allowEarlyReference) {\n    // 1\\. \u4ece\u4e00\u7ea7\u7f13\u5b58\u4e2d\u83b7\u53d6\uff0c\u8fd9\u91cc\u662f\u83b7\u53d6\u4e0d\u5230\n    Object singletonObject = this.singletonObjects.get(beanName);\n    // 2\\. isSingletonCurrentlyInCreation(...) \u5224\u65adservice1\u662f\u5426\u5728\u521b\u5efa\u4e2d\uff0c\u8fd4\u56de true\n    if (singletonObject == null && isSingletonCurrentlyInCreation(beanName)) {\n            synchronized (this.singletonObjects) {\n                // 3\\. \u4ece\u4e8c\u7ea7\u7f13\u5b58\u4e2d\u83b7\u53d6\uff0c\u8fd9\u91cc\u4e5f\u83b7\u53d6\u4e0d\u5230\n                singletonObject = this.earlySingletonObjects.get(beanName);\n                // 4\\. \u4f20\u5165\u7684allowEarlyReference\u662ftrue\uff0c\u7ee7\u7eed\u6267\u884c\u91cc\u9762\u7684\u5185\u5bb9\n                if (singletonObject == null && allowEarlyReference) {\n                    // 5\\. \u4ece\u4e09\u7ea7\u7f13\u5b58\u4e2d\u83b7\u53d6\uff0c\u80fd\u83b7\u53d6\u5230\n                    ObjectFactory<?> singletonFactory = this.singletonFactories.get(beanName);\n                    if (singletonFactory != null) {\n                        // 6\\. \u8c03\u7528 singletonFactory.getObject()\n                        // \u6700\u7ec8\u8c03\u7528\u7684\u662f AbstractAutowireCapableBeanFactory.getEarlyBeanReference \u65b9\u6cd5\n                        singletonObject = singletonFactory.getObject();\n                        // 7\\. \u5904\u7406\u7f13\u5b58\n                        // \u653e\u5230\u4e8c\u7ea7\u7f13\u5b58\u4e2d\n                        this.earlySingletonObjects.put(beanName, singletonObject);\n                        // \u4ece\u4e09\u7ea7\u7f13\u5b58\u4e2d\u6e05\u9664\n                        this.singletonFactories.remove(beanName);\n                    }\n                }\n            }\n    }\n    return singletonObject;\n}\n\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u5728\u5206\u6790\u4ee3\u7801\u524d\uff0c\u5148\u6765\u770b\u770b\u6b64\u65f6 5 \u5927\u7ed3\u6784\u4e2d\u7684\u5185\u5bb9\uff1a"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u7ed3\u6784"}),(0,s.jsx)(n.th,{children:"\u5185\u5bb9"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonObjects"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlySingletonObjects"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonFactories"})}),(0,s.jsx)(n.td,{children:"lambda(service1), lambda(service2)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})}),(0,s.jsx)(n.td,{children:"service1, service2"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlyProxyReferences"})}),(0,s.jsx)(n.td,{})]})]})]}),"\n",(0,s.jsx)(n.p,{children:"\u5bf9\u7167\u7740\u4e0a\u9762\u7684\u5185\u5bb9\uff0c\u5206\u6790\u5982\u4e0b\uff1a"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u4ece\u4e00\u7ea7\u7f13\u5b58\u4e2d\u83b7\u53d6\uff0c\u5bf9\u7167\u7740 5 \u4e2a\u7ed3\u6784\u4e2d\u7684\u5185\u5bb9\uff0c\u83b7\u53d6\u4e0d\u5230\uff0c\u8fd4\u56de ",(0,s.jsx)(n.code,{children:"null"}),";"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"isSingletonCurrentlyInCreation(...)"})," \u5224\u65ad ",(0,s.jsx)(n.code,{children:"service1"})," \u662f\u5426\u5728\u521b\u5efa\u4e2d\uff0c\u5bf9\u7167\u7740 5 \u4e2a\u7ed3\u6784\u4e2d\u7684\u5185\u5bb9\uff0c",(0,s.jsx)(n.code,{children:"service1"})," \u5728 ",(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})," \u4e2d\uff0c\u8fd4\u56de true\uff0c\u7ee7\u7eed\u4e0b\u9762\u7684\u6d41\u7a0b\uff0c",(0,s.jsxs)(n.strong,{children:["\u8fd9\u662f\u4e0e\u7b2c\u4e00\u6b21\u83b7\u53d6 ",(0,s.jsx)(n.code,{children:"service1"})," \u7684\u4e0d\u540c\u4e4b\u5904"]}),"\uff1b"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u7ee7\u7eed\u4ece\u4e8c\u7ea7\u7f13\u5b58\u4e2d\u83b7\u53d6\uff0c\u5bf9\u7167\u7740 5 \u4e2a\u7ed3\u6784\u4e2d\u7684\u5185\u5bb9\uff0c",(0,s.jsx)(n.code,{children:"service1"})," \u4e0d\u5728 ",(0,s.jsx)(n.code,{children:"earlySingletonObjects"}),"\uff0c\u4f9d\u7136\u8fd4\u56de ",(0,s.jsx)(n.code,{children:"null"}),"\uff1b"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"allowEarlyReference"})," \u662f\u4f20\u5165\u7684\u53c2\u6570\uff0c\u4e3a ",(0,s.jsx)(n.code,{children:"true"}),"\uff0c\u7ee7\u7eed\u6267\u884c \u4e0b\u9762\u7684\u4ee3\u7801\uff1b"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u7ee7\u7eed\u4ece\u4ece\u4e09\u7ea7\u7f13\u5b58\u4e2d\u83b7\u53d6\uff0c\u5bf9\u7167\u7740 5 \u4e2a\u7ed3\u6784\u4e2d\u7684\u5185\u5bb9\uff0c",(0,s.jsx)(n.code,{children:"service1"})," \u5728 ",(0,s.jsx)(n.code,{children:"singletonFactories"})," \u4e2d\uff0c\u8fd9\u91cc\u80fd\u83b7\u53d6\u5230\uff0c\u8fd4\u56de\u7684\u7ed3\u679c\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-57677e20855580e5bc2f5163d87ecfda7d2.png",alt:""})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u8c03\u7528 ",(0,s.jsx)(n.code,{children:"singletonFactory.getObject()"})," \u65b9\u6cd5\uff0c\u5f53\u521d\u6211\u4eec\u4f20\u5165 ",(0,s.jsx)(n.code,{children:"singletonFactories"})," \u7684\u8fd8\u662f\u4e2a lambda \u8868\u8fbe\u5f0f\uff1a",(0,s.jsx)(n.code,{children:"() -> getEarlyBeanReference(beanName, mbd, bean)"}),"\uff0c\u8c03\u7528 ",(0,s.jsx)(n.code,{children:"singletonFactory.getObject()"})," \u6700\u7ec8\u8c03\u7528\u7684\u5c31\u662f ",(0,s.jsx)(n.code,{children:"AbstractAutowireCapableBeanFactory#getEarlyBeanReference"}),"\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"protected Object getEarlyBeanReference(String beanName, RootBeanDefinition mbd, Object bean) {\n    Object exposedObject = bean;\n    if (!mbd.isSynthetic() && hasInstantiationAwareBeanPostProcessors()) {\n        for (BeanPostProcessor bp : getBeanPostProcessors()) {\n            if (bp instanceof SmartInstantiationAwareBeanPostProcessor) {\n                // \u8c03\u7528\u540e\u7f6e\u5904\u7406\u5668\uff0c\u8fd9\u91cc\u5b8c\u6210\u4e86aop\u64cd\u4f5c\n                SmartInstantiationAwareBeanPostProcessor ibp = \n                      (SmartInstantiationAwareBeanPostProcessor) bp;\n                // \u8c03\u7528 `AbstractAutoProxyCreator#getEarlyBeanReference`\uff0c\u63d0\u524d\u8fdb\u884c aop\n                exposedObject = ibp.getEarlyBeanReference(exposedObject, beanName);\n            }\n        }\n    }\n    return exposedObject;\n}\n\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u6211\u4eec\u8ddf\u8fdb ",(0,s.jsx)(n.code,{children:"AbstractAutoProxyCreator#getEarlyBeanReference"})," \u65b9\u6cd5\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"public Object getEarlyBeanReference(Object bean, String beanName) {\n    Object cacheKey = getCacheKey(bean.getClass(), beanName);\n    this.earlyProxyReferences.put(cacheKey, bean);\n    // \u8fd9\u91cc\u751f\u6210\u4ee3\u7406\u5bf9\u8c61\n    return wrapIfNecessary(bean, beanName, cacheKey);\n}\n\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u5173\u4e8e aop \u7684\u6d41\u7a0b\uff0c\u53ef\u53c2\u8003 ",(0,s.jsx)(n.a,{href:"https://my.oschina.net/funcy/blog/4687961",children:"spring aop \u4e4b AnnotationAwareAspectJAutoProxyCreator \u5206\u6790\uff08\u4e0b\uff09"}),"\uff0c\u8fd9\u91cc\u5c31\u4e0d\u518d\u5206\u6790\u4e86\u3002\u6267\u884c\u5b8c ",(0,s.jsx)(n.code,{children:"AbstractAutoProxyCreator#getEarlyBeanReference"})," \u4e4b\u540e\uff0c5 \u4e2a\u7ed3\u6784\u4e2d\u7684\u5185\u5bb9\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u7ed3\u6784"}),(0,s.jsx)(n.th,{children:"\u5185\u5bb9"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonObjects"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlySingletonObjects"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonFactories"})}),(0,s.jsx)(n.td,{children:"lambda(service1), lambda(service2)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})}),(0,s.jsx)(n.td,{children:"service1, service2"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlyProxyReferences"})}),(0,s.jsx)(n.td,{children:"service1"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["\u8ba9\u6211\u4eec\u518d\u56de\u5230 ",(0,s.jsx)(n.code,{children:"getSingleton"})," \u65b9\u6cd5\uff0c\u6267\u884c\u5b8c ",(0,s.jsx)(n.code,{children:"singletonFactory.getObject()"})," \u540e\uff0c\u5f97\u5230\u7684 ",(0,s.jsx)(n.code,{children:"singletonObject"})," \u4e3a"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-cf72a8ff3d91c3d2a4e300741ba7f0268e6.png",alt:""})}),"\n",(0,s.jsxs)(n.p,{children:["\u8fd9\u662f\u4e00\u4e2a\u4ee3\u7406\u5bf9\u8c61\uff0c\u5e76\u4e14 ",(0,s.jsx)(n.code,{children:"service2"})," \u4e3a ",(0,s.jsx)(n.code,{children:"null"}),"\u3002"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"\u63a5\u4e0b\u6765\u5c31\u662f\u5904\u7406\u7f13\u5b58\u4e86\uff0c\u4e00\u4e9b map \u7684 put \u4e0e remove \u64cd\u4f5c\uff0c\u5c31\u4e0d\u591a\u8bf4\u4e86\u3002"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"DefaultSingletonBeanRegistry#getSingleton(String, boolean)"})," \u65b9\u6cd5\u6267\u884c\u5b8c\u6210\u540e\uff0c5 \u4e2a\u7ed3\u6784\u4e2d\u7684\u5185\u5bb9\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u7ed3\u6784"}),(0,s.jsx)(n.th,{children:"\u5185\u5bb9"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonObjects"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlySingletonObjects"})}),(0,s.jsx)(n.td,{children:"service1"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonFactories"})}),(0,s.jsx)(n.td,{children:"lambda(service2)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})}),(0,s.jsx)(n.td,{children:"service1, service2"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlyProxyReferences"})}),(0,s.jsx)(n.td,{children:"service1"})]})]})]}),"\n",(0,s.jsxs)(n.h4,{id:"43-\u518d\u6b21\u56de\u5230-abstractbeanfactorydogetbean",children:["4.3 \u518d\u6b21\u56de\u5230 ",(0,s.jsx)(n.code,{children:"AbstractBeanFactory#doGetBean"})]}),"\n",(0,s.jsxs)(n.p,{children:["\u6267\u884c\u5b8c ",(0,s.jsx)(n.code,{children:"DefaultSingletonBeanRegistry#getSingleton(String, boolean)"})," \u540e\uff0c\u6211\u4eec\u518d\u56de\u5230 ",(0,s.jsx)(n.code,{children:"AbstractBeanFactory#doGetBean"}),"\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"protected <T> T doGetBean(final String name, @Nullable final Class<T> requiredType,\n        @Nullable final Object[] args, boolean typeCheckOnly) throws BeansException {\n    ...\n\n    // \u68c0\u67e5\u662f\u5426\u5df2\u521d\u59cb\u5316\n    Object sharedInstance = getSingleton(beanName);\n\n    // 1\\. \u8fd9\u6b21\u80fd\u83b7\u53d6\u5230\u5bf9\u8c61\uff0cif \u91cc\u9762\u7684\u4ee3\u7801\u4f1a\u6267\u884c\n    if (sharedInstance != null && args == null) {\n        // 2\\. \u8fd9\u91cc\u5982\u679c\u662f\u666e\u901aBean \u7684\u8bdd\uff0c\u76f4\u63a5\u8fd4\u56de\uff0c\u5982\u679c\u662f FactoryBean \u7684\u8bdd\uff0c\u8fd4\u56de\u5b83\u521b\u5efa\u7684\u90a3\u4e2a\u5b9e\u4f8b\u5bf9\u8c61\n        // \u8fd9\u91cc\u7684bean\u662fservice1\u7684\u4ee3\u7406\u5bf9\u8c61\n        bean = getObjectForBeanInstance(sharedInstance, name, beanName, null);\n    } else {\n        // \u8fd9\u91cc\u7684\u4ee3\u7801\u4e0d\u4f1a\u6267\u884c\u5230\uff0c\u5c31\u4e0d\u5206\u6790\u4e86\n        ...\n    }\n\n    // \u5904\u7406bean\u7684\u8f6c\u6362\u64cd\u4f5c\uff0c\u8fd9\u91cc\u8fd4\u56defalse\uff0c\u4e0d\u4f1a\u6267\u884c\u5230\n    if (requiredType != null && !requiredType.isInstance(bean)) {\n    ...\n    }\n\n    // 3\\. \u8fd4\u56de\u4ece`getSingleton(beanName)`\u5f97\u5230\u7684\u5bf9\u8c61\n    return bean;\n\n}\n\n"})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"\u8fd9\u6b21\u80fd\u83b7\u53d6\u5230\u5bf9\u8c61\uff0cif \u91cc\u9762\u7684\u4ee3\u7801\u4f1a\u6267\u884c\uff1b"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"service1"})," \u4e0d\u662f ",(0,s.jsx)(n.code,{children:"FactoryBean"}),"\uff0c\u4e0e ",(0,s.jsx)(n.code,{children:"getSingleton(beanName)"})," \u5f97\u5230\u7684\u5bf9\u8c61\u662f\u540c\u4e00\u4e2a\u5bf9\u8c61\uff0c\u5185\u5bb9\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-0cd9c129bf2387d85a7bee4f4e135143f63.png",alt:""})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u8fd4\u56de\u4ece ",(0,s.jsx)(n.code,{children:"getSingleton(beanName)"})," \u5f97\u5230\u7684\u5bf9\u8c61\uff0c\u5728 ",(0,s.jsx)(n.code,{children:"getSingleton(beanName)"})," \u4e2d\u8fd4\u56de\u7684\u5bf9\u8c61\u4e0d\u4e3a\u7a7a\u540e\uff0c\u5c31\u4e0d\u518d\u6267\u884c bean \u7684\u521b\u5efa\u6d41\u7a0b\u4e86\uff0c\u6700\u7ec8\u8fd4\u56de\u7684\u662f\u7b2c 2 \u6b65\u4e2d\u5f97\u5230\u7684 bean \u4e86\u3002"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["\u5230\u4e86\u8fd9\u91cc\uff0c\u6211\u4eec\u7ec8\u4e8e\u83b7\u53d6\u5230\u4e86 ",(0,s.jsx)(n.code,{children:"service1"})," \u7684\u4ee3\u7406\u5bf9\u8c61\uff0c\u5c3d\u7ba1\u4ee3\u7406\u5bf9\u8c61\u5bf9\u5e94\u7684\u539f\u59cb\u5bf9\u8c61\u5e76\u6ca1\u6709\u5b8c\u6210\u4f9d\u8d56\u6ce8\u5165\uff0c\u4f46\u6211\u4eec\u4f9d\u7136\u53ef\u4ee5\u8fdb\u884c\u540e\u7eed\u7684\u6d41\u7a0b\uff0c\u5373\u83b7\u53d6\u5230 ",(0,s.jsx)(n.code,{children:"service1"})," \u7684\u4ee3\u7406\u5bf9\u8c61\u540e\uff0c",(0,s.jsx)(n.code,{children:"service2"})," \u5c31\u53ef\u4ee5\u8fdb\u884c\u4f9d\u8d56\u6ce8\u5165\uff0c\u7ee7\u7eed\u63a5\u4e0b\u6765\u7684\u6d41\u7a0b\u4e86\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"\u6700\u540e\uff0c\u6211\u4eec\u518d\u6765\u770b\u770b\u672c\u8282\u6267\u884c\u5b8c\u4e4b\u540e\uff0c5 \u5927\u7ed3\u6784\u4e2d\u7684\u5185\u5bb9\uff1a"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u7ed3\u6784"}),(0,s.jsx)(n.th,{children:"\u5185\u5bb9"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonObjects"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlySingletonObjects"})}),(0,s.jsx)(n.td,{children:"service1$$EnhancerBySpringCGLIB"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonFactories"})}),(0,s.jsx)(n.td,{children:"lambda(service2)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})}),(0,s.jsx)(n.td,{children:"service1, service2"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlyProxyReferences"})}),(0,s.jsx)(n.td,{children:"service1"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["\u83b7\u53d6\u5230 ",(0,s.jsx)(n.code,{children:"service1"})," \u540e\uff0c\u63a5\u4e0b\u6765\u5c31\u7ee7\u7eed ",(0,s.jsx)(n.code,{children:"service2"})," \u7684\u83b7\u53d6\u6d41\u7a0b\u4e86\u3002"]}),"\n",(0,s.jsxs)(n.h3,{id:"5-\u7ee7\u7eed-service2-\u7684\u83b7\u53d6\u6d41\u7a0b",children:["5 \u7ee7\u7eed ",(0,s.jsx)(n.code,{children:"service2"})," \u7684\u83b7\u53d6\u6d41\u7a0b"]}),"\n",(0,s.jsxs)(n.p,{children:["\u5728\u7b2c 3 \u8282\u4e2d\uff0c\u56e0\u4e3a ",(0,s.jsx)(n.code,{children:"service2"})," \u9700\u8981\u6ce8\u5165 ",(0,s.jsx)(n.code,{children:"service1"}),"\uff0c\u624d\u6709\u4e86\u7b2c 4 \u90e8\u5206\u7684\u518d\u6b21\u83b7\u53d6 ",(0,s.jsx)(n.code,{children:"service1"})," \u7684\u6d41\u7a0b\uff0c\u6700\u7ec8\u4e5f\u6210\u529f\u5730\u83b7\u53d6\u5230\u4e86 ",(0,s.jsx)(n.code,{children:"service1"})," \u7684\u4ee3\u7406\u5bf9\u8c61 ",(0,s.jsx)(n.code,{children:"service1$$EnhancerBySpringCGLIB"}),"\uff0c\u8fd9\u624d\u8ba9 ",(0,s.jsx)(n.code,{children:"service2"})," \u5f97\u4ee5\u5b8c\u6210\u4f9d\u8d56\u6ce8\u5165\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:["\u63a5\u4e0b\u6765\uff0c\u8ba9\u6211\u4eec\u5ef6\u7eed \u7b2c 3 \u8282 \u7684\u6d41\u7a0b\uff0c\u56de\u5230 ",(0,s.jsx)(n.code,{children:"AbstractAutowireCapableBeanFactory#doCreateBean"}),"\uff0c\u7ee7\u7eed ",(0,s.jsx)(n.code,{children:"service2"})," \u7684\u6d41\u7a0b\u3002"]}),"\n",(0,s.jsxs)(n.h4,{id:"51-\u56de\u5230-abstractautowirecapablebeanfactorydocreatebean",children:["5.1 \u56de\u5230 ",(0,s.jsx)(n.code,{children:"AbstractAutowireCapableBeanFactory#doCreateBean"})]}),"\n",(0,s.jsx)(n.p,{children:"\u4ee3\u7801\u5982\u4e0b\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"protected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, \n            final @Nullable Object[] args) throws BeanCreationException {\n\n        // \u4e0a\u9762\u7684\u4ee3\u7801\u5728 3.2 \u4e2d\u5df2\u7ecf\u5206\u6790\u8fc7\u4e86\uff0c\u5c31\u4e0d\u518d\u5206\u6790\u4e86\n        ...\n\n        Object exposedObject = bean;\n        try {\n            // 1\\. \u8d1f\u8d23\u5c5e\u6027\u88c5\u914d, \u4e5f\u5c31\u662f\u6211\u4eec\u5e38\u5e38\u8bf4\u7684\u4f9d\u8d56\u6ce8\u5165\n            populateBean(beanName, mbd, instanceWrapper);\n            // 2\\. \u521d\u59cb\u5316\uff0c\u5728\u8fd9\u91cc\u4f1a\u5904\u7406 aop \u64cd\u4f5c\n            exposedObject = initializeBean(beanName, exposedObject, mbd);\n        }\n        catch (Throwable ex) {\n            ...\n        }\n\n        //\u540c\u6837\u7684\uff0c\u5982\u679c\u5b58\u5728\u5faa\u73af\u4f9d\u8d56\n        if (earlySingletonExposure) {\n            // 3\\. \u4ece\u7f13\u5b58\u4e2d\u83b7\u53d6 beanName \u5bf9\u5e94\u7684bean\n            Object earlySingletonReference = getSingleton(beanName, false);\n            // 4\\. earlySingletonReference \u4e3a null\uff0cif \u91cc\u9762\u7684\u5185\u5bb9\u4e0d\u4f1a\u6267\u884c\n            if (earlySingletonReference != null) {\n                ...\n            }\n        }\n\n        // \u7701\u7565\u4e0d\u91cd\u8981\u7684\u4ee3\u7801\n        ...\n\n        return exposedObject;\n    }\n\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u4ee3\u7801\u8bf4\u660e\u5982\u4e0b\uff1a"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u5904\u7406\u4f9d\u8d56\u6ce8\u5165\uff0c\u5c31\u662f\u8fd9\u91cc\u89e6\u53d1\u4e86\u7b2c 4 \u90e8\u5206\u7684\u6d41\u7a0b\uff0c\u6267\u884c\u5b8c\u5f97\u5230\u7684 ",(0,s.jsx)(n.code,{children:"service2"})," \u5982\u4e0b\uff1a"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-b294a02be5431c0aa66e5f126a6c6abbb92.png",alt:""})}),"\n",(0,s.jsxs)(n.p,{children:["\u53ef\u4ee5\u770b\u5230\uff0c\u6b64\u65f6\u6ce8\u5165\u5230 ",(0,s.jsx)(n.code,{children:"service2"})," \u4e2d\u7684 ",(0,s.jsx)(n.code,{children:"service1"})," \u5c31\u662f\u4ee3\u7406\u5bf9\u8c61\u4e86\uff1b"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u521d\u59cb\u5316\uff0c\u5728\u8fd9\u91cc\u4f1a\u5904\u7406 aop \u64cd\u4f5c\uff0c\u6267\u884c aop \u7684\u65b9\u6cd5\u4e3a ",(0,s.jsx)(n.code,{children:"AbstractAutoProxyCreator#postProcessAfterInitialization"}),"\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"// \u4f20\u5165\u7684bean\u4e3aservice2\uff0cbeanName\u4e3a\u201cservice2\u201d\npublic Object postProcessAfterInitialization(@Nullable Object bean, String beanName) {\n    if (bean != null) {\n        Object cacheKey = getCacheKey(bean.getClass(), beanName);\n        // 1\\. earlyProxyReferences \u4e2d\u5e76\u6ca1\u6709 service2\uff0cif\u91cc\u7684\u4ee3\u7801\u4f1a\u6267\u884c\u5230\n        if (this.earlyProxyReferences.remove(cacheKey) != bean) {\n            // 2\\. \u5728\u8fd9\u91cc\u5904\u7406aop\u64cd\u4f5c\n            return wrapIfNecessary(bean, beanName, cacheKey);\n        }\n    }\n    return bean;\n}\n\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u4ee5\u4e0a\u4ee3\u7801\u5148\u4ece ",(0,s.jsx)(n.code,{children:"earlyProxyReferences"})," \u79fb\u51fa ",(0,s.jsx)(n.code,{children:"service2"}),"\uff0c\u7136\u540e\u518d\u4e0e\u4f20\u5165\u7684 bean \u505a\u6bd4\u8f83\uff0c\u5bf9\u7167\u7740 5 \u5927\u7ed3\u6784\u4e2d\u7684\u5185\u5bb9\uff0c\u6211\u4eec\u53d1\u73b0 ",(0,s.jsx)(n.code,{children:"service2"})," \u5e76\u4e0d\u5728 ",(0,s.jsx)(n.code,{children:"earlyProxyReferences"})," \u4e2d\uff1b"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u7ed3\u6784"}),(0,s.jsx)(n.th,{children:"\u5185\u5bb9"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonObjects"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlySingletonObjects"})}),(0,s.jsx)(n.td,{children:"service1$$EnhancerBySpringCGLIB"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonFactories"})}),(0,s.jsx)(n.td,{children:"lambda(service2)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})}),(0,s.jsx)(n.td,{children:"service1, service2"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlyProxyReferences"})}),(0,s.jsx)(n.td,{children:"service1"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["\u56e0\u6b64\uff0c\u8fd9\u91cc\u8fd4\u56de ",(0,s.jsx)(n.code,{children:"null"}),"\uff0c\u663e\u7136\u4e0d\u7b49\u4e8e\u4f20\u5165\u7684 bean\uff0c\u56e0\u6b64 if \u4e2d\u7684\u4ee3\u7801\u4f1a\u6267\u884c\uff0c",(0,s.jsx)(n.code,{children:"service2"})," \u8fdb\u884c aop\u3002\u6267\u884c\u5b8c\u8fd9\u4e00\u6b65\u540e\uff0c\u5f97\u5230\u7684 ",(0,s.jsx)(n.code,{children:"exposedObject"})," \u4e3a\uff1a"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-d62ebdbb71b76ada963a01c9b8c84b88b00.png",alt:""})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"service2"})," \u4e5f\u53d8\u6210\u4e86\u4ee3\u7406\u5bf9\u8c61\uff0c\u4e14\u5df2\u5b8c\u6210\u4e86\u4f9d\u8d56\u6ce8\u5165\u3002"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u4ece\u7f13\u5b58\u4e2d\u83b7\u53d6 beanName \u5bf9\u5e94\u7684 bean\uff0c\u6267\u884c\u7684\u662f ",(0,s.jsx)(n.code,{children:"DefaultSingletonBeanRegistry#getSingleton(String, boolean)"}),"\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"/**\n * beanName: service2\n * allowEarlyReference\uff1afalse\n */\nprotected Object getSingleton(String beanName, boolean allowEarlyReference) {\n    // 1\\. \u4ece\u4e00\u7ea7\u7f13\u5b58\u4e2d\u83b7\u53d6 service2\uff0c\u83b7\u53d6\u4e0d\u5230\uff0c\u8fd4\u56denull\n    Object singletonObject = this.singletonObjects.get(beanName);\n    // 2\\. \u5224\u65ad service2 \u662f\u5426\u5728\u521b\u5efa\u4e2d\uff0c\u8fd4\u56detrue\uff0c\u6267\u884cif\u4e2d\u7684\u4ee3\u7801\n    if (singletonObject == null && isSingletonCurrentlyInCreation(beanName)) {\n        synchronized (this.singletonObjects) {\n            // 3\\. \u4ece\u4e8c\u7ea7\u7f13\u5b58\u4e2d\u83b7\u53d6 service2\uff0c\u83b7\u53d6\u4e0d\u5230\uff0c\u8fd4\u56denull\n            singletonObject = this.earlySingletonObjects.get(beanName);\n            // 4\\. \u6b64\u65f6\u4f20\u5165\u7684 allowEarlyReference \u4e3afalse\uff0cif\u5757\u7684\u4ee3\u7801\u4e0d\u4f1a\u6267\u884c\n            if (singletonObject == null && allowEarlyReference) {\n                ...\n            }\n        }\n    }\n    return singletonObject;\n}\n\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u6211\u4eec\u8fd8\u662f\u6765\u770b \u4e00\u773c 5 \u5927\u7ed3\u6784\u4e2d\u7684\u5185\u5bb9\uff0c\u5bf9\u8fd9\u4e2a\u65b9\u6cd5\u7684\u6267\u884c\u5c31\u4e00\u76ee\u4e86\u7136\u4e86\uff1a"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u7ed3\u6784"}),(0,s.jsx)(n.th,{children:"\u5185\u5bb9"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonObjects"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlySingletonObjects"})}),(0,s.jsx)(n.td,{children:"service1$$EnhancerBySpringCGLIB"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonFactories"})}),(0,s.jsx)(n.td,{children:"lambda(service2)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})}),(0,s.jsx)(n.td,{children:"service1, service2"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlyProxyReferences"})}),(0,s.jsx)(n.td,{children:"service1"})]})]})]}),"\n",(0,s.jsx)(n.p,{children:"\u65b9\u6cd5\u7684\u6267\u884c\uff0c\u5728\u4ee3\u7801\u4e2d\u5df2\u7ecf\u6ce8\u91ca\u5f97\u5f88\u660e\u767d\u4e86\uff0c\u5c31\u591a\u8bf4\u4e86\uff1b"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u7b2c 3 \u6b65\u8fd4\u56de\u7684 ",(0,s.jsx)(n.code,{children:"earlySingletonReference"})," \u4e3a null\uff0cif \u91cc\u9762\u7684\u5185\u5bb9\u4e0d\u4f1a\u6267\u884c\u3002"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["\u5230\u8fd9\u91cc\uff0c\u5f97\u5230\u7684 ",(0,s.jsx)(n.code,{children:"service2"})," \u5c31\u8fd4\u56de\u4e86\u3002"]}),"\n",(0,s.jsxs)(n.h4,{id:"52-\u56de\u5230-defaultsingletonbeanregistrygetsingletonstring-objectfactory",children:["5.2 \u56de\u5230 ",(0,s.jsx)(n.code,{children:"DefaultSingletonBeanRegistry#getSingleton(String, ObjectFactory<?>)"})]}),"\n",(0,s.jsxs)(n.p,{children:["\u5f97\u5230 ",(0,s.jsx)(n.code,{children:"service2"})," \u7684 bean \u540e\uff0c\u6211\u4eec\u56de\u5230 ",(0,s.jsx)(n.code,{children:"DefaultSingletonBeanRegistry#getSingleton(String, ObjectFactory<?>)"}),"\uff0c\u7ee7\u7eed ",(0,s.jsx)(n.code,{children:"service2"})," \u7684\u6d41\u7a0b\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'public Object getSingleton(String beanName, ObjectFactory<?> singletonFactory) {\n    Assert.notNull(beanName, "Bean name must not be null");\n    synchronized (this.singletonObjects) {\n        ...\n            try {\n                // 1\\. \u5728\u8fd9\u91cc\u8fdb\u884cbean\u7684\u521b\u5efa\n                singletonObject = singletonFactory.getObject();\n                newSingleton = true;\n            }\n            catch (...) {\n                ...\n            }\n            finally {\n                ...\n                // 2\\. \u521b\u5efa\u5b8c\u6210\u540e\uff0c\u505a\u4e00\u4e9b\u68c0\u67e5\u64cd\u4f5c\n                // \u8fd9\u91cc\u4f1a\u628a service2 \u4ece singletonsCurrentlyInCreation \u79fb\u9664\n                afterSingletonCreation(beanName);\n            }\n            if (newSingleton) {\n                // 3\\. \u5c06\u8be5\u5bf9\u8c61\u6dfb\u52a0\u5230 beanFactory \u4e2d\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u4f1a\u5220\u9664\u4e8c\u4e09\u7ea7\u7f13\u5b58\n                addSingleton(beanName, singletonObject);\n            }\n        ...\n        return singletonObject;\n    }\n}\n\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u8bf4\u660e\u5982\u4e0b\uff1a"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u5386\u7ecf\u5343\u96be\u4e07\u9669\uff0c",(0,s.jsx)(n.code,{children:"singletonFactory.getObject()"})," \u7ec8\u4e8e\u6267\u884c\u5b8c\u4e86\uff0c\u5728\u8bf8\u591a\u66f2\u6298\u4e4b\u540e\uff0c\u6700\u7ec8\u8fd8\u662f\u5f97\u5230\u4e86 ",(0,s.jsx)(n.code,{children:"service2"})," \u7684\u4ee3\u7406\u5bf9\u8c61\uff1b"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"service2"})," \u521b\u5efa\u5b8c\u6210\u540e\uff0c\u5c31\u4f1a\u5c06\u5176\u4ece ",(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})," \u79fb\u9664\uff0c\u65b9\u6cd5\u6bd4\u8f83\u7b80\u5355\uff0c\u5c31\u4e0d\u591a\u8bf4\u4e86\uff0c\u8fd9\u4e00\u6b65\u5f97\u5230\u7684 5 \u5927\u7ed3\u6784\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u7ed3\u6784"}),(0,s.jsx)(n.th,{children:"\u5185\u5bb9"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonObjects"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlySingletonObjects"})}),(0,s.jsx)(n.td,{children:"service1$$EnhancerBySpringCGLIB"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonFactories"})}),(0,s.jsx)(n.td,{children:"lambda(service2)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})}),(0,s.jsx)(n.td,{children:"service1"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlyProxyReferences"})}),(0,s.jsx)(n.td,{children:"service1"})]})]})]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u63a5\u7740\uff0c\u5c31\u662f\u7f13\u5b58\u7684\u5904\u7406\uff0c\u65b9\u6cd5\u4e3a ",(0,s.jsx)(n.code,{children:"DefaultSingletonBeanRegistry#addSingleton"}),"\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"/*\n * beanName\uff1aservice2\n * singletonObject\uff1aservice2$$EnhancerBySpringCGLIB(service2\u7684\u4ee3\u7406\u5bf9\u8c61)\n */ \nprotected void addSingleton(String beanName, Object singletonObject) {\n    synchronized (this.singletonObjects) {\n        // \u5bf9\u4e09\u4e2a\u7f13\u5b58\u8fdb\u884cput\u3001remove\u64cd\u4f5c\uff0c\u6700\u7ec8\u53ea\u5728\u4e00\u7ea7\u7f13\u5b58\u4e2d\u6709\u8be5\u5bf9\u8c61\n        this.singletonObjects.put(beanName, singletonObject);\n        this.singletonFactories.remove(beanName);\n        this.earlySingletonObjects.remove(beanName);\n        this.registeredSingletons.add(beanName);\n    }\n}\n\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u65b9\u6cd5\u6bd4\u8f83\u7b80\u5355\uff0c\u5c31\u4e0d\u591a\u8bf4\u4e86\uff0c\u6700\u7ec8 5 \u5927\u7ed3\u6784\u4e3a\uff1a"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u7ed3\u6784"}),(0,s.jsx)(n.th,{children:"\u5185\u5bb9"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonObjects"})}),(0,s.jsx)(n.td,{children:"service2$$EnhancerBySpringCGLIB"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlySingletonObjects"})}),(0,s.jsx)(n.td,{children:"service1$$EnhancerBySpringCGLIB"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonFactories"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})}),(0,s.jsx)(n.td,{children:"service1"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlyProxyReferences"})}),(0,s.jsx)(n.td,{children:"service1"})]})]})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["\u5230\u6b64\uff0c",(0,s.jsx)(n.code,{children:"service2"})," \u83b7\u53d6\u5b8c\u6210\uff0c\u6700\u7ec8\u4fdd\u5b58\u5230 ",(0,s.jsx)(n.code,{children:"singletonObjects"})," \u4e2d\u7684 bean \u4e3a\uff1a"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-763dad35376ed1d88086c45f01ee9c4cedd.png",alt:""})}),"\n",(0,s.jsx)(n.p,{children:"\u672c\u8282\u7684\u6700\u540e\uff0c\u6211\u4eec\u4e5f\u6765\u770b\u4e0b 5 \u4e2a\u7ed3\u6784\u4e2d\u7684\u5185\u5bb9\uff1a"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u7ed3\u6784"}),(0,s.jsx)(n.th,{children:"\u5185\u5bb9"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonObjects"})}),(0,s.jsx)(n.td,{children:"service2$$EnhancerBySpringCGLIB"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlySingletonObjects"})}),(0,s.jsx)(n.td,{children:"service1$$EnhancerBySpringCGLIB"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonFactories"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})}),(0,s.jsx)(n.td,{children:"service1"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlyProxyReferences"})}),(0,s.jsx)(n.td,{children:"service1"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["\u81f3\u6b64\uff0c",(0,s.jsx)(n.code,{children:"service2"})," \u83b7\u53d6\u5b8c\u6210\uff0c\u63a5\u7740\u8ba9\u6211\u4eec\u7ee7\u7eed ",(0,s.jsx)(n.code,{children:"service1"})," \u7684\u83b7\u53d6\u6d41\u7a0b\u3002"]}),"\n",(0,s.jsxs)(n.h3,{id:"6-\u7ee7\u7eed-service1-\u7684\u83b7\u53d6\u6d41\u7a0b",children:["6 \u7ee7\u7eed ",(0,s.jsx)(n.code,{children:"service1"})," \u7684\u83b7\u53d6\u6d41\u7a0b"]}),"\n",(0,s.jsxs)(n.p,{children:["\u5728\u7b2c 2 \u8282\u4e2d\uff0c\u56e0\u4e3a ",(0,s.jsx)(n.code,{children:"servic1"})," \u9700\u8981\u6ce8\u5165 ",(0,s.jsx)(n.code,{children:"service2"}),"\uff0c\u624d\u6709\u4e86\u7b2c 3 \u8282\u83b7\u53d6 ",(0,s.jsx)(n.code,{children:"service2"})," \u7684\u6d41\u7a0b\uff0c\u7136\u540e\u53c8\u7ecf\u8fc7\u4e00\u7cfb\u5217\u7684\u64cd\u4f5c\u540e\uff0c\u6700\u7ec8\u5728\u7b2c 5 \u8282\u6210\u529f\u5730\u83b7\u53d6\u5230\u4e86 ",(0,s.jsx)(n.code,{children:"service2"})," \u7684\u4ee3\u7406\u5bf9\u8c61 ",(0,s.jsx)(n.code,{children:"service2$$EnhancerBySpringCGLIB"}),"\uff0c\u8fd9\u624d\u8ba9 ",(0,s.jsx)(n.code,{children:"service2"})," \u5f97\u4ee5\u5b8c\u6210\u4f9d\u8d56\u6ce8\u5165\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:["\u63a5\u4e0b\u6765\uff0c\u8ba9\u6211\u4eec\u5ef6\u7eed\u7b2c 2 \u8282\uff0c\u56de\u5230 ",(0,s.jsx)(n.code,{children:"AbstractAutowireCapableBeanFactory#doCreateBean"})," \u65b9\u6cd5\uff0c\u7ee7\u7eed ",(0,s.jsx)(n.code,{children:"service1"})," \u7684\u6d41\u7a0b\u3002"]}),"\n",(0,s.jsxs)(n.h4,{id:"61-\u56de\u5230-abstractautowirecapablebeanfactorydocreatebean",children:["6.1 \u56de\u5230 ",(0,s.jsx)(n.code,{children:"AbstractAutowireCapableBeanFactory#doCreateBean"})]}),"\n",(0,s.jsx)(n.p,{children:"\u4ee3\u7801\u5982\u4e0b\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"protected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, \n            final @Nullable Object[] args) throws BeanCreationException {\n\n        // \u4e0a\u9762\u7684\u4ee3\u7801\u5728 3.1 \u4e2d\u5df2\u7ecf\u5206\u6790\u8fc7\u4e86\uff0c\u5c31\u4e0d\u518d\u5206\u6790\u4e86\n        ...\n\n        Object exposedObject = bean;\n        try {\n            // 1\\. \u8d1f\u8d23\u5c5e\u6027\u88c5\u914d, \u4e5f\u5c31\u662f\u6211\u4eec\u5e38\u5e38\u8bf4\u7684\u4f9d\u8d56\u6ce8\u5165\n            populateBean(beanName, mbd, instanceWrapper);\n            // 2\\. \u521d\u59cb\u5316\uff0c\u5728\u8fd9\u91cc\u4f1a\u5904\u7406 aop \u64cd\u4f5c\n            exposedObject = initializeBean(beanName, exposedObject, mbd);\n        }\n        catch (Throwable ex) {\n            ...\n        }\n\n        //\u540c\u6837\u7684\uff0c\u5982\u679c\u5b58\u5728\u5faa\u73af\u4f9d\u8d56\n        if (earlySingletonExposure) {\n            // 3\\. \u4ece\u7f13\u5b58\u4e2d\u83b7\u53d6 beanName \u5bf9\u5e94\u7684bean\n            Object earlySingletonReference = getSingleton(beanName, false);\n            // 4\\. earlySingletonReference \u4e0d\u4e3a null\uff0cif \u91cc\u9762\u7684\u5185\u5bb9\u4f1a\u6267\u884c\n            if (earlySingletonReference != null) {\n                if (exposedObject == bean) {\n                    // 5\\. \u5c06\u8fd4\u56de\u7684\u5bf9\u8c61\u8d4b\u503c\u7ed9 exposedObject\uff0c\u8fd4\u56de\u5bf9\u8c61\u4e3a\u4ee3\u7406\u5bf9\u8c61\n                    exposedObject = earlySingletonReference;\n                }\n            }\n        }\n\n        // \u7701\u7565\u4e0d\u91cd\u8981\u7684\u4ee3\u7801\n        ...\n\n        return exposedObject;\n    }\n\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u4ee3\u7801\u8bf4\u660e\u5982\u4e0b\uff1a"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u5904\u7406\u4f9d\u8d56\u6ce8\u5165\uff0c\u5c31\u662f\u8fd9\u91cc\u89e6\u53d1\u4e86\u7b2c 3 \u8282\u7684\u6d41\u7a0b\uff0c\u6267\u884c\u5b8c\u5f97\u5230\u7684 ",(0,s.jsx)(n.code,{children:"service1"})," \u5982\u4e0b\uff1a"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-3883285be5904e056bc517d35bfd44c47a0.png",alt:""})}),"\n",(0,s.jsxs)(n.p,{children:["\u53ef\u4ee5\u770b\u5230\uff0c",(0,s.jsx)(n.code,{children:"service1"})," \u5df2\u7ecf\u5b8c\u6210\u4e86\u4f9d\u8d56\u6ce8\u5165\uff0c\u4e14\u6b64\u65f6\u6ce8\u5165\u5230 ",(0,s.jsx)(n.code,{children:"service1"})," \u4e2d\u7684 ",(0,s.jsx)(n.code,{children:"service2"})," \u5df2\u7ecf\u662f\u4ee3\u7406\u5bf9\u8c61\u4e86\uff0c\u4e0d\u8fc7 ",(0,s.jsx)(n.code,{children:"service1"})," \u6b64\u65f6\u8fd8\u662f\u539f\u59cb\u5bf9\u8c61\uff0c\u6211\u4eec\u7ee7\u7eed\u5f80\u4e0b\u770b\uff1b"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u521d\u59cb\u5316\uff0c\u5728\u8fd9\u91cc\u4f1a\u5904\u7406 aop \u64cd\u4f5c\uff0c\u6267\u884c aop \u7684\u65b9\u6cd5\u4e3a ",(0,s.jsx)(n.code,{children:"AbstractAutoProxyCreator#postProcessAfterInitialization"}),"\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"// \u4f20\u5165\u7684bean\u4e3aservice1\uff0cbeanName\u4e3a\u201cservice1\u201d\npublic Object postProcessAfterInitialization(@Nullable Object bean, String beanName) {\n    if (bean != null) {\n        Object cacheKey = getCacheKey(bean.getClass(), beanName);\n        // 1\\. earlyProxyReferences \u4e2d\u6709 service1\uff0cif\u91cc\u7684\u4ee3\u7801\u4e0d\u4f1a\u6267\u884c\u5230\n        if (this.earlyProxyReferences.remove(cacheKey) != bean) {\n            // 2\\. \u5728\u8fd9\u91cc\u5904\u7406aop\u64cd\u4f5c\uff0cservice1 \u5df2\u7ecf\u6267\u884c\u8fc7aop\u4e86\n            return wrapIfNecessary(bean, beanName, cacheKey);\n        }\n    }\n    return bean;\n}\n\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u4ee5\u4e0a\u4ee3\u7801\u5148\u4ece ",(0,s.jsx)(n.code,{children:"earlyProxyReferences"})," \u79fb\u51fa ",(0,s.jsx)(n.code,{children:"service1"}),"\uff0c\u7136\u540e\u518d\u4e0e\u4f20\u5165\u7684 bean \u505a\u6bd4\u8f83\uff0c\u5bf9\u7167\u7740 5 \u5927\u7ed3\u6784\u4e2d\u7684\u5185\u5bb9\uff0c\u6211\u4eec\u53d1\u73b0 ",(0,s.jsx)(n.code,{children:"service1"})," \u6b64\u65f6\u5c31\u5728 ",(0,s.jsx)(n.code,{children:"earlyProxyReferences"})," \u4e2d\uff1b"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u7ed3\u6784"}),(0,s.jsx)(n.th,{children:"\u5185\u5bb9"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonObjects"})}),(0,s.jsx)(n.td,{children:"service2$$EnhancerBySpringCGLIB"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlySingletonObjects"})}),(0,s.jsx)(n.td,{children:"service1$$EnhancerBySpringCGLIB"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonFactories"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})}),(0,s.jsx)(n.td,{children:"service1"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlyProxyReferences"})}),(0,s.jsx)(n.td,{children:"service1"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["\u56e0\u6b64\uff0c\u8fd9\u91cc\u4f1a\u8fd4\u56de ",(0,s.jsx)(n.code,{children:"service1"}),"\uff0cif \u4e2d\u7684\u4ee3\u7801\u4e0d\u4f1a\u6267\u884c\u3002\u6267\u884c\u5b8c\u8fd9\u4e00\u6b65\u540e\uff0c5 \u4e2a\u7ed3\u6784\u4e2d\u7684\u5185\u5bb9\u4e3a\uff1a"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u7ed3\u6784"}),(0,s.jsx)(n.th,{children:"\u5185\u5bb9"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonObjects"})}),(0,s.jsx)(n.td,{children:"service2$$EnhancerBySpringCGLIB"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlySingletonObjects"})}),(0,s.jsx)(n.td,{children:"service1$$EnhancerBySpringCGLIB"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonFactories"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})}),(0,s.jsx)(n.td,{children:"service1"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlyProxyReferences"})}),(0,s.jsx)(n.td,{})]})]})]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u4ece\u7f13\u5b58\u4e2d\u83b7\u53d6 beanName \u5bf9\u5e94\u7684 bean\uff0c\u6267\u884c\u7684\u662f ",(0,s.jsx)(n.code,{children:"DefaultSingletonBeanRegistry#getSingleton(String, boolean)"}),"\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"/**\n * beanName: service1\n * allowEarlyReference\uff1afalse\n */\nprotected Object getSingleton(String beanName, boolean allowEarlyReference) {\n    // 1\\. \u4ece\u4e00\u7ea7\u7f13\u5b58\u4e2d\u83b7\u53d6 service1\uff0c\u83b7\u53d6\u4e0d\u5230\uff0c\u8fd4\u56denull\n    Object singletonObject = this.singletonObjects.get(beanName);\n    // 2\\. \u5224\u65ad service1 \u662f\u5426\u5728\u521b\u5efa\u4e2d\uff0c\u8fd4\u56detrue\uff0c\u6267\u884cif\u4e2d\u7684\u4ee3\u7801\n    if (singletonObject == null && isSingletonCurrentlyInCreation(beanName)) {\n        synchronized (this.singletonObjects) {\n            // 3\\. \u4ece\u4e8c\u7ea7\u7f13\u5b58\u4e2d\u83b7\u53d6 service1\uff0c\u80fd\u83b7\u53d6\u5230\n            singletonObject = this.earlySingletonObjects.get(beanName);\n            // 4\\. singletonObject \u4e0d\u4e3anull\uff0cif\u5757\u7684\u4ee3\u7801\u4e0d\u4f1a\u6267\u884c\n            if (singletonObject == null && allowEarlyReference) {\n                ...\n            }\n        }\n    }\n    return singletonObject;\n}\n\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u6211\u4eec\u770b \u4e00\u773c 5 \u5927\u7ed3\u6784\u4e2d\u7684\u5185\u5bb9\uff0c\u5bf9\u8fd9\u4e2a\u65b9\u6cd5\u7684\u6267\u884c\u5c31\u4e00\u76ee\u4e86\u7136\u4e86\uff1a"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u7ed3\u6784"}),(0,s.jsx)(n.th,{children:"\u5185\u5bb9"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonObjects"})}),(0,s.jsx)(n.td,{children:"service2$$EnhancerBySpringCGLIB"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlySingletonObjects"})}),(0,s.jsx)(n.td,{children:"service1$$EnhancerBySpringCGLIB"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonFactories"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})}),(0,s.jsx)(n.td,{children:"service1"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlyProxyReferences"})}),(0,s.jsx)(n.td,{})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["\u65b9\u6cd5\u7684\u6267\u884c\uff0c\u5728\u4ee3\u7801\u4e2d\u5df2\u7ecf\u6ce8\u91ca\u5f97\u5f88\u660e\u767d\u4e86\uff0c\u5c31\u591a\u8bf4\u4e86\uff0c\u8fd9\u4e00\u6b65\u4f1a\u628a ",(0,s.jsx)(n.code,{children:"service1"})," \u7684\u4ee3\u7406\u5bf9\u8c61\u8fd4\u56de\uff1b"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u4e0a\u4e00\u6b65\u5f97\u5230\u7684 ",(0,s.jsx)(n.code,{children:"earlySingletonReference"})," \u4e3a"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-425636328820897c75890f01614d94fe9dd.png",alt:""})}),"\n",(0,s.jsx)(n.p,{children:"\u4ee3\u7406\u5bf9\u8c61\u5df2\u7ecf\u8fd4\u56de\u6765\u4e86\uff0c\u53ef\u4ee5\u7ee7\u7eed\u6267\u884c if \u5757\u7684\u4ee3\u7801\u4e86\uff1b"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["\u6700\u540e\u4e00\u6b65\u662f\u8d4b\u503c\u64cd\u4f5c\uff0c\u5c06\u8fd4\u56de\u7684\u5bf9\u8c61\u8d4b\u503c\u7ed9 ",(0,s.jsx)(n.code,{children:"exposedObject"}),"\uff0c\u7136\u540e\u8fd4\u56de ",(0,s.jsx)(n.code,{children:"exposedObject"}),"\uff0c\u6700\u7ec8\u8fd4\u56de\u7684\u5bf9\u8c61\u4e3a ",(0,s.jsx)(n.code,{children:"service1"})," \u7684\u4ee3\u7406\u5bf9\u8c61\u3002"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["\u5230\u4e86\u8fd9\u4e00\u6b65\uff0c",(0,s.jsx)(n.code,{children:"service1"})," \u7684\u4ee3\u7406\u5bf9\u8c61\u4e5f\u83b7\u53d6\u5b8c\u6210\u4e86\u3002"]}),"\n",(0,s.jsxs)(n.h4,{id:"62-\u56de\u5230-defaultsingletonbeanregistrygetsingletonstring-objectfactory",children:["6.2 \u56de\u5230 ",(0,s.jsx)(n.code,{children:"DefaultSingletonBeanRegistry#getSingleton(String, ObjectFactory<?>)"})]}),"\n",(0,s.jsx)(n.p,{children:"\u8fd9\u4e00\u6b65\u7684\u64cd\u4f5c\u662f\u6e05\u7406\u4e00\u4e9b\u7f13\u5b58\uff0c\u5c31\u4e0d\u518d\u5206\u6790\u4e86\uff0c\u6700\u7ec8 5 \u4e2a\u7ed3\u6784\u4e2d\u7684\u5185\u5bb9\u5982\u4e0b\uff1a"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u7ed3\u6784"}),(0,s.jsx)(n.th,{children:"\u5185\u5bb9"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonObjects"})}),(0,s.jsx)(n.td,{children:"service2$$EnhancerBySpringCGLIB,service1$$EnhancerBySpringCGLIB"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlySingletonObjects"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonFactories"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"singletonsCurrentlyInCreation"})}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"earlyProxyReferences"})}),(0,s.jsx)(n.td,{})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["\u901a\u8fc7\u8c03\u8bd5\uff0c\u67e5\u770b\u5f97\u5230 ",(0,s.jsx)(n.code,{children:"singletonObjects"})," \u4e2d\u5bf9\u8c61\u5982\u4e0b\uff1a"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"service1"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-b6ba35a7a701056ae55a8f9b2ef9345cac5.png",alt:""})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"service2"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-563d6e323ef8fc5e9fd02f7a938ddbac655.png",alt:""})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["\u53ef\u4ee5\u770b\u5230\uff0c",(0,s.jsx)(n.code,{children:"singletonObjects"})," \u4e2d\u4e24\u8005\u90fd\u662f\u4ee3\u7406\u5bf9\u8c61\uff0c\u5f7c\u6b64\u6ce8\u5165\u7684\uff0c\u4e5f\u662f\u4ee3\u7406\u5bf9\u8c61\uff0c\u5faa\u73af\u4f9d\u8d56\u5f97\u5230\u4e86\u89e3\u51b3\u3002"]}),"\n",(0,s.jsx)(n.h3,{id:"4-\u603b\u7ed3",children:"4. \u603b\u7ed3"}),"\n",(0,s.jsxs)(n.p,{children:["spring \u5faa\u73af\u4f9d\u8d56\u7684\u5206\u6790\u5230\u8fd9\u91cc\u5c31\u7ed3\u675f\u4e86\uff0c\u5faa\u73af\u4f9d\u8d56\u6709\u89e3\u7684\u6838\u5fc3\u5728\u4e8e",(0,s.jsx)(n.strong,{children:"\u5bf9\u8c61\u53ef\u4ee5\u63d0\u524d\u8fdb\u884c aop"}),"\uff0cspring \u6b63\u662f\u5229\u7528\u8fd9\u4e00\u70b9\uff0c\u518d\u914d\u5408 5 \u5927\u7ed3\u6784\u5b58\u50a8\u5fc5\u8981\u7684\u4fe1\u606f\uff0c\u4e00\u6b65\u6b65\u89e3\u51b3\u5faa\u73af\u4f9d\u8d56\u95ee\u9898\u3002"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsxs)(n.em,{children:["\u672c\u6587\u539f\u6587\u94fe\u63a5\uff1a",(0,s.jsx)(n.a,{href:"https://my.oschina.net/funcy/blog/4815992",children:"https://my.oschina.net/funcy/blog/4815992"})," \uff0c\u9650\u4e8e\u4f5c\u8005\u4e2a\u4eba\u6c34\u5e73\uff0c\u6587\u4e2d\u96be\u514d\u6709\u9519\u8bef\u4e4b\u5904\uff0c\u6b22\u8fce\u6307\u6b63\uff01\u539f\u521b\u4e0d\u6613\uff0c\u5546\u4e1a\u8f6c\u8f7d\u8bf7\u8054\u7cfb\u4f5c\u8005\u83b7\u5f97\u6388\u6743\uff0c\u975e\u5546\u4e1a\u8f6c\u8f7d\u8bf7\u6ce8\u660e\u51fa\u5904\u3002"]})})]})}function j(e={}){const{wrapper:n}={...(0,c.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},88672:(e,n,r)=>{r.d(n,{Z:()=>l,a:()=>t});var s=r(50959);const c={},i=s.createContext(c);function t(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:t(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);