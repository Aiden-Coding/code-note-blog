"use strict";(self.webpackChunkcode_note_blog=self.webpackChunkcode_note_blog||[]).push([[5922],{88573:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>s,toc:()=>l});var a=t(11527),r=t(88672);const o={},i="\u53c2\u8003\u6587\u7ae0",s={id:"Spring\u5168\u5bb6\u6876/SpringCloudAlibaba\u6e90\u7801\u5206\u6790/SpringCloudSeata\u6e90\u7801\u5206\u6790",title:"SpringCloudSeata\u6e90\u7801\u5206\u6790",description:"\u4f5c\u8005 | \u4e00\u8d77\u64b8Java",source:"@site/docs/Spring\u5168\u5bb6\u6876/SpringCloudAlibaba\u6e90\u7801\u5206\u6790/SpringCloudSeata\u6e90\u7801\u5206\u6790.md",sourceDirName:"Spring\u5168\u5bb6\u6876/SpringCloudAlibaba\u6e90\u7801\u5206\u6790",slug:"/Spring\u5168\u5bb6\u6876/SpringCloudAlibaba\u6e90\u7801\u5206\u6790/SpringCloudSeata\u6e90\u7801\u5206\u6790",permalink:"/code-note-blog/docs/Spring\u5168\u5bb6\u6876/SpringCloudAlibaba\u6e90\u7801\u5206\u6790/SpringCloudSeata\u6e90\u7801\u5206\u6790",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Spring\u5168\u5bb6\u6876/SpringCloudAlibaba\u6e90\u7801\u5206\u6790/SpringCloudSeata\u6e90\u7801\u5206\u6790.md",tags:[],version:"current",frontMatter:{},sidebar:"spring",previous:{title:"SpringCloudRocketMQ\u6e90\u7801\u5206\u6790",permalink:"/code-note-blog/docs/Spring\u5168\u5bb6\u6876/SpringCloudAlibaba\u6e90\u7801\u5206\u6790/SpringCloudRocketMQ\u6e90\u7801\u5206\u6790"},next:{title:"SpringCloudSentinel\u6e90\u7801\u5206\u6790",permalink:"/code-note-blog/docs/Spring\u5168\u5bb6\u6876/SpringCloudAlibaba\u6e90\u7801\u5206\u6790/SpringCloudSentinel\u6e90\u7801\u5206\u6790"}},c={},l=[];function d(e){const n={a:"a",code:"code",h1:"h1",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.a)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.p,{children:"\u4f5c\u8005 | \u4e00\u8d77\u64b8Java\n\u6765\u6e90 |\u4eca\u65e5\u5934\u6761"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"\u5b66\u4e60\u76ee\u6807"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Seata AT\u6a21\u5f0f\u6e90\u7801\u6d41\u7a0b\n",(0,a.jsx)(n.strong,{children:"\u7b2c1\u7ae0 AT\u6a21\u5f0f\u6d41\u7a0b"}),"\n",(0,a.jsx)(n.strong,{children:"1.1 \u601d\u7ef4\u6d41\u7a0b\u63a8\u5bfc"}),"\n\u4e0a\u6587\u4e2d\u5df2\u7ecf\u8bb2\u4e86AT\u6a21\u5f0f\u7684\u5927\u4f53\u539f\u7406\uff0c\u5728\u6e90\u7801\u4e2d\uff0c\u901a\u8fc7README\u4e5f\u80fd\u770b\u51fa\u6765AT\u6a21\u5f0f\u7684\u4f7f\u7528\uff0c\u90a3\u672c\u6587\u5c06\u4ece\u5e95\u5c42\u6e90\u7801\u5c42\u9762\u53bb\u5206\u6790AT\u6a21\u5f0f\u7684\u539f\u7406\uff0c\u5728\u5206\u6790\u539f\u7406\u4e4b\u524d\u54b1\u4eec\u5148\u6765\u770b\u4e09\u5e45\u56fe\uff0c\u7406\u89e3\u4e00\u4e0b\u4ed6\u7684\u5de5\u4f5c\u601d\u8def\u548c\u6a21\u5f0f\uff1a"]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["\u5148\u770b\u770b\u601d\u7ef4\u63a8\u5bfc\u56fe",(0,a.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/0388859932ccee17ed32246e2e5f4e0a88dee6.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0a\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0a\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"1.2 \u521d\u59cb\u5316\u6d41\u7a0b\u63a8\u5bfc\n",(0,a.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/f24e8bd05e84b683e3f3227490146155bf5b17.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0a\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0a\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"1.3 \u6267\u884c\u6d41\u7a0b\u63a8\u5bfc\n",(0,a.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/93dea0538eba8be5778699ea2af8f71c0e396c.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0a\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0a\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),(0,a.jsx)(n.strong,{children:"\u7b2c2\u7ae0 \u6e90\u7801\u5206\u6790"}),"\n",(0,a.jsx)(n.strong,{children:"2.1 SeataAutoConfiguration"}),"\n\u5bf9\u4e8eseata\u6e90\u7801\u7684\u7814\u7a76\u4e3b\u8981\u770bseata\u5982\u4f55\u62e6\u622a\u4e1a\u52a1SQL\u751f\u6210undo_log\u6570\u636e\uff0c\u5982\u4f55\u5728\u4e00\u9636\u6bb5\u5b8c\u6210\u540e\u63d0\u4ea4\u5168\u5c40\u4e8b\u52a1\uff0c\u5982\u4f55\u5728\u4e00\u9636\u6bb5\u4e1a\u52a1\u5931\u8d25\u540e\u901a\u8fc7undo_log\u56de\u6eda\u4e8b\u52a1\uff0c\u8fdb\u884c\u4e8b\u52a1\u8865\u507f\u3002"]}),"\n",(0,a.jsxs)(n.p,{children:["seata\u4e5f\u662f\u4e0espring\u6574\u5408\u4f7f\u7528\u7684\uff0c\u7ed3\u5408SpringBoot\uff0cseata\u4e5f\u662f\u505a\u4e86\u4e00\u4e9b\u81ea\u52a8\u914d\u7f6e",(0,a.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/719ef4a775ece0688c929227415e97f68f1c58.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0a\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0a\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"seata\u7684\u81ea\u52a8\u914d\u7f6e\u7c7b\u547d\u540d\u975e\u5e38\u7684\u76f4\u63a5\uff0c\u5c31\u53eb\u505a\uff1aSeataAutoConfiguration\uff0c\u6211\u4eec\u6253\u5f00\u8fd9\u4e2a\u7c7b"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'@ComponentScan(basePackages = "io.seata.spring.boot.autoconfigure.properties")@ConditionalOnProperty(prefix = StarterConstants.SEATA_PREFIX, name = "enabled", havingValue = "true", matchIfMissing = true)@Configuration@EnableConfigurationProperties({SeataProperties.class})public class SeataAutoConfiguration {    }\n'})}),"\n",(0,a.jsx)(n.p,{children:"\u9996\u5148\uff0c@ComponentScan\u626b\u63cf\u4e86\u4e00\u4e0bproperties\u5305\uff0c\u52a0\u8f7d\u4e86\u4e00\u5927\u5806\u7c7b\u4f3cSeataProperties\u7684Bean\u5bf9\u8c61\u3002"}),"\n",(0,a.jsx)(n.p,{children:"@ConditionalOnProperty\u5c06\u914d\u7f6e\u7c7b\u751f\u6548\u6761\u4ef6\u8bbe\u7f6e\u4e3aseata.enabled=true\uff0c\u9ed8\u8ba4\u503c\u662ftrue\uff0c\u6240\u4ee5\u53ef\u4ee5\u5f00\u5173\u5206\u5e03\u5f0f\u4e8b\u52a1\u529f\u80fd\uff08\u5728client\u7aef\u7684file.conf\u91cc\u9762\u53ef\u4ee5\u914d\u7f6e\uff09\u3002"}),"\n",(0,a.jsx)(n.p,{children:"@Configuration\u8868\u660e\uff0cSeataAutoConfiguration\u88ab\u5b9a\u4e49\u4e3a\u4e86spring\u7684\u914d\u7f6e\u7c7b\u3002"}),"\n",(0,a.jsx)(n.p,{children:"@EnableConfigurationProperties\u5c06\u914d\u7f6e\u5305\u8f6c\u6210\u4e86\u4e00\u4e2aSeataProperties\u7684Bean\u5bf9\u8c61\u6765\u4f7f\u7528\u3002"}),"\n",(0,a.jsx)(n.p,{children:"\u63a5\u4e0b\u6765\u9605\u8bfbSeataAutoConfiguration\u7684\u5185\u90e8\u4ee3\u7801"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'@Bean@DependsOn({BEAN_NAME_SPRING_APPLICATION_CONTEXT_PROVIDER, BEAN_NAME_FAILURE_HANDLER})@ConditionalOnMissingBean(GlobalTransactionScanner.class)public GlobalTransactionScanner globalTransactionScanner(SeataProperties seataProperties, FailureHandler failureHandler) {    if (LOGGER.isInfoEnabled()) {        LOGGER.info("Automatically configure Seata");    }    return new GlobalTransactionScanner(seataProperties.getApplicationId(), seataProperties.getTxServiceGroup(), failureHandler);}\n'})}),"\n",(0,a.jsx)(n.p,{children:"\u81ea\u52a8\u914d\u7f6e\u7684\u6838\u5fc3\u70b9\u843d\u5728\u4e86\u4e0b\u9762\u7684\u4e00\u4e2aBean\uff0cGlobalTransactionScanner\u3002"}),"\n",(0,a.jsx)(n.p,{children:"\u6211\u4eec\u770b\u5230\u6784\u9020\u8fd9\u4e2aBean\u975e\u5e38\u7684\u7b80\u5355\uff0c\u6784\u9020\u65b9\u6cd5\u53ea\u9700\u8981\u4e00\u4e2aapplicationId\u548ctxServiceGroup\u3002"}),"\n",(0,a.jsx)(n.p,{children:"applicationId: \u5c31\u662fspring.application.name=\u4f60\u5b9a\u4e49\u7684\u5f53\u524d\u5e94\u7528\u7684\u540d\u5b57\uff0c\u4f8b\u5982\uff1auserService"}),"\n",(0,a.jsx)(n.p,{children:"txServiceGroup: \u5c31\u662f\u4ee5applicationId \u52a0\u4e0a -seata-service-group\u547d\u540d\u7684\uff0c\u4f8b\u5982\uff1a\nuserService-seata-service-group\u3002\u5982\u679c\u7248\u672c\u8f83\u4f4e\u7684\u8bdd\uff0c\u90a3\u65f6\u5019\u53ef\u80fd\u8fd8\u4e0d\u53ebseata\u800c\u662ffescar\uff0c\u56e0\u6b64\u9ed8\u8ba4\u547d\u540d\u5c31\u662f\u4ee5fescar\u4e3a\u540e\u7f00\u3002"}),"\n",(0,a.jsx)(n.p,{children:"new\u4e86\u4e00\u4e2aGlobalTransactionScanner\u5bf9\u8c61\uff0cSeataAutoConfiguration\u8fd9\u4e2a\u81ea\u52a8\u914d\u7f6e\u7c7b\u7684\u4f5c\u7528\u5c31\u7ed3\u675f\u4e86\u3002SeataAutoConfiguration\u53ea\u662f\u505a\u4e86\u4e00\u4e2a\u542f\u52a8\u5f15\u5bfc\u7684\u4f5c\u7528\u3002"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"2.2 GlobalTransactionScanner"}),"\n\u65e2\u7136\u6838\u5fc3\u70b9\u843d\u5728GlobalTransactionScanner\u8fd9\u4e2a\u7c7b\uff0c\u6211\u4eec\u7ee7\u7eed\u5173\u6ce8\u5b83\u3002\u770b\u8fd9\u4e2a\u540d\u5b57\u5176\u5b9e\u5c31\u53ef\u4ee5\u731c\u6d4b\u5230\u4e00\u70b9\u5b83\u7684\u4f5c\u7528\uff0c\u626b\u63cf@GlobalTransactional\u8fd9\u4e2a\u6ce8\u89e3\uff0c\u5e76\u5bf9\u4ee3\u7406\u65b9\u6cd5\u8fdb\u884c\u62e6\u622a\u589e\u5f3a\u4e8b\u52a1\u7684\u529f\u80fd\u3002"]}),"\n",(0,a.jsxs)(n.p,{children:["\u8981\u4e86\u89e3\u8fd9\u4e2a\u7c7b\uff0c\u4e0d\u5f97\u4e0d\u5148\u9605\u8bfb\u4e00\u4e0b\u5b83\u7684UML\u56fe",(0,a.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/83cb3ed76073a33cb19242ffe542b615346d16.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0a\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0a\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"\u53ef\u4ee5\u770b\u5230\uff0cGlobalTransactionScanner\u4e3b\u8981\u67094\u4e2a\u70b9\u503c\u5f97\u5173\u6ce8\uff1a"]}),"\n",(0,a.jsx)(n.p,{children:"1\uff09ApplicationContextAware\u8868\u793a\u53ef\u4ee5\u62ff\u5230spring\u5bb9\u5668"}),"\n",(0,a.jsx)(n.p,{children:"2\uff09InitializingBean\u63a5\u53e3\uff0c\u8868\u8fbe\u4e86\u521d\u59cb\u5316\u7684\u65f6\u5019\u4f1a\u8fdb\u884c\u4e00\u4e9b\u64cd\u4f5c"}),"\n",(0,a.jsx)(n.p,{children:"3\uff09AbstractAutoProxyCreator\u8868\u793a\u5b83\u4f1a\u5bf9spring\u5bb9\u5668\u4e2d\u7684Bean\u8fdb\u884c\u5207\u9762\u589e\u5f3a\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u4e0a\u9762\u7684\u62e6\u622a\u4e8b\u52a1\u589e\u5f3a\u7684\u731c\u6d4b\u3002"}),"\n",(0,a.jsx)(n.p,{children:"4\uff09Disposable\u63a5\u53e3\uff0c\u8868\u8fbe\u4e86spring\u5bb9\u5668\u9500\u6bc1\u7684\u65f6\u5019\u4f1a\u8fdb\u884c\u4e00\u4e9b\u64cd\u4f5c"}),"\n",(0,a.jsx)(n.p,{children:"\u8fd9\u91cc\u6211\u4eec\u7a0d\u5fae\u5173\u6ce8\u4e00\u4e0b\u8fd94\u4e2a\u7684\u6267\u884c\u987a\u5e8f\uff1a"}),"\n",(0,a.jsx)(n.p,{children:"ApplicationContextAware -> InitializingBean -> AbstractAutoProxyCreator -> DisposableBean"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"2.3 InitializingBean"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'@Overridepublic void afterPropertiesSet() {    if (disableGlobalTransaction) {        if (LOGGER.isInfoEnabled()) {            LOGGER.info("Global transaction is disabled.");        }        return;    }    initClient();}\n'})}),"\n",(0,a.jsx)(n.p,{children:"\u521d\u59cb\u5316Seata\u7684Client\u7aef\u7684\u4e1c\u897f\uff0cClient\u7aef\u4e3b\u8981\u5305\u62ecTransactionManager\u548cResourceManager\u3002\u6216\u8bb8\u662f\u4e3a\u4e86\u7b80\u5316\u5427\uff0c\u5e76\u6ca1\u6709\u628ainitClient\u8fd9\u4ef6\u4e8b\u4eceGlobalTransactionScanner\u91cc\u9762\u72ec\u7acb\u51fa\u6765\u4e00\u4e2a\u7c7b\u3002"}),"\n",(0,a.jsx)(n.p,{children:"\u8ddf\u8fdbinitClient\u65b9\u6cd5"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"private void initClient() {    //init TM    TMClient.init(applicationId, txServiceGroup);       //init RM    RMClient.init(applicationId, txServiceGroup);      registerSpringShutdownHook();}\n"})}),"\n",(0,a.jsx)(n.p,{children:"initClient\u903b\u8f91\u5e76\u4e0d\u590d\u6742\uff0c\u5355\u7eaf\u8c03\u7528TMClient.init\u521d\u59cb\u5316TransactionManager\u7684RPC\u5ba2\u6237\u7aef\uff0cRMClient.init\u521d\u59cb\u5316ResourceManager\u7684RPC\u5ba2\u6237\u7aef\u3002seata\u7684RPC\u91c7\u7528netty\u6765\u5b9e\u73b0\uff0cseata\u5c01\u88c5\u7b80\u5316\u4e86\u4e00\u4e0b\u4f7f\u7528\u3002\u5e76\u6ce8\u518c\u4e86\u4e00\u4e2aSpring\u7684ShutdownHook\u94a9\u5b50\u51fd\u6570"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"2.3.1 TMClient\u521d\u59cb\u5316"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"@Overridepublic void init() {    timerExecutor.scheduleAtFixedRate(new Runnable() {        @Override        public void run() {            clientChannelManager.reconnect(getTransactionServiceGroup());        }    }, SCHEDULE_DELAY_MILLS, SCHEDULE_INTERVAL_MILLS, TimeUnit.MILLISECONDS);...}\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u542f\u52a8\u4e86\u4e00\u4e2a\u5b9a\u65f6\u5668\u4e0d\u65ad\u8fdb\u884c\u91cd\u8fde\u64cd\u4f5c\uff0c\u8c03\u7528\nclientChannelManager.reconnect\u65b9\u6cd5\u8fdb\u884c\u91cd\u8fde"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"void reconnect(String transactionServiceGroup) {    List<String> availList = null;    try {        availList = getAvailServerList(transactionServiceGroup);    } catch (Exception e) {       ...    }   ...    for (String serverAddress : availList) {        try {            acquireChannel(serverAddress);        } catch (Exception e) {            ...        }    }}\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u6839\u636etransactionServiceGroup\u83b7\u53d6seata-server\u7684ip\u5730\u5740\u5217\u8868\uff0c\u7136\u540e\u8fdb\u884c\u91cd\u8fde"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"private List<String> getAvailServerList(String transactionServiceGroup) throws Exception {    List<InetSocketAddress> availInetSocketAddressList = RegistryFactory.getInstance()        .lookup(transactionServiceGroup);    if (CollectionUtils.isEmpty(availInetSocketAddressList)) {        return Collections.emptyList();    }     return availInetSocketAddressList.stream()        .map(NetUtil::toStringAddress)        .collect(Collectors.toList());}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["RegistryFactory.getInstance().lookup(transactionServiceGroup);\u662f\u5bf9\u4e0d\u540c\u6ce8\u518c\u4e2d\u5fc3\u505a\u4e86\u9002\u914d\u7684\uff0c\u9ed8\u8ba4\u770b\u4e0bNacos\u5f62\u5f0f\u7684\u5b9e\u73b0",(0,a.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/745b802128d80980a6e082f91406451526cbb3.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0a\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0a\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"\u5148\u6839\u636e\u4e8b\u52a1\u5206\u7ec4\u627e\u5230\u5206\u7ec4\u6240\u5c5e\u7684server\u96c6\u7fa4\u540d\u79f0\uff0c\u8fd9\u91cc\u662fdefault\uff0c\u7136\u540e\u6839\u636e\u96c6\u7fa4\u540d\u79f0\u627e\u5230server\u5bf9\u5e94ip\u7aef\u53e3\u5730\u5740"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"@Overridepublic List<InetSocketAddress> lookup(String key) throws Exception {    //default    String clusterName = getServiceGroup(key);    if (clusterName == null) {        return null;    }    if (!LISTENER_SERVICE_MAP.containsKey(clusterName)) {        synchronized (LOCK_OBJ) {            if (!LISTENER_SERVICE_MAP.containsKey(clusterName)) {                List<String> clusters = new ArrayList<>();                clusters.add(clusterName);                List<Instance> firstAllInstances = getNamingInstance().getAllInstances(getServiceName(), getServiceGroup(), clusters);                if (null != firstAllInstances) {                    List<InetSocketAddress> newAddressList = firstAllInstances.stream()                        .filter(instance -> instance.isEnabled() && instance.isHealthy())                        .map(instance -> new InetSocketAddress(instance.getIp(), instance.getPort()))                        .collect(Collectors.toList());                    CLUSTER_ADDRESS_MAP.put(clusterName, newAddressList);                }                subscribe(clusterName, event -> {                    List<Instance> instances = ((NamingEvent) event).getInstances();                    if (null == instances && null != CLUSTER_ADDRESS_MAP.get(clusterName)) {                        CLUSTER_ADDRESS_MAP.remove(clusterName);                    } else if (!CollectionUtils.isEmpty(instances)) {                        List<InetSocketAddress> newAddressList = instances.stream()                            .filter(instance -> instance.isEnabled() && instance.isHealthy())                            .map(instance -> new InetSocketAddress(instance.getIp(), instance.getPort()))                            .collect(Collectors.toList());                        CLUSTER_ADDRESS_MAP.put(clusterName, newAddressList);                    }                });            }        }    }    return CLUSTER_ADDRESS_MAP.get(clusterName);}\n"})}),"\n",(0,a.jsx)(n.p,{children:"Seata-server\u7684IP\u5730\u5740\u5df2\u83b7\u53d6\u5230,\u7136\u540e\u8c03\u7528acquireChannel"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"Channel acquireChannel(String serverAddress) {    Channel channelToServer = channels.get(serverAddress);    if (channelToServer != null) {        channelToServer = getExistAliveChannel(channelToServer, serverAddress);        if (channelToServer != null) {            return channelToServer;        }    }...    channelLocks.putIfAbsent(serverAddress, new Object());    synchronized (channelLocks.get(serverAddress)) {        return doConnect(serverAddress);    }}\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u6700\u540e\u5c06\u83b7\u53d6\u5230\u7684seata-server\u7684IP\u5730\u5740\u653e\u5230Netty\u4e2d\u5c01\u88c5\uff0cTmClient\u5c31\u521d\u59cb\u5316\u5b8c\u6bd5"}),"\n",(0,a.jsx)(n.p,{children:"TmClient\u521d\u59cb\u5316\u603b\u7ed3\uff1a"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"\u542f\u52a8\u5b9a\u65f6\u5668\uff0c\u5c1d\u8bd5\u8fdb\u884c\u4e00\u6b21\u91cd\u8fdeseata-server"}),"\n",(0,a.jsx)(n.li,{children:"\u91cd\u8fde\u65f6\uff0c\u5148\u4ecenacos\uff08\u6216\u5219\u5176\u4ed6\u914d\u7f6e\uff09\u4e2d\u6839\u636e\u5206\u7ec4\u540d\u79f0(service_group)\u627e\u5230\u96c6\u7fa4\u540d\u79f0(cluster_name)"}),"\n",(0,a.jsx)(n.li,{children:"\u518d\u6839\u636e\u96c6\u7fa4\u540d\u79f0\u627e\u5230\u96c6\u7fa4ip\u7aef\u53e3\u5217\u8868"}),"\n",(0,a.jsxs)(n.li,{children:["\u4eceip\u5217\u8868\u4e2d\u9009\u62e9\u4e00\u4e2a\u7528netty\u8fdb\u884c\u8fde\u63a5\n",(0,a.jsx)(n.strong,{children:"2.3.2 RMClient\u521d\u59cb\u5316"})]}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"public static void init(String applicationId, String transactionServiceGroup) {    // \u83b7\u53d6\u5355\u4f8b\u5bf9\u8c61    RmRpcClient rmRpcClient = RmRpcClient.getInstance(applicationId, transactionServiceGroup);    // \u8bbe\u7f6eResourceManager\u7684\u5355\u4f8b\u5bf9\u8c61    rmRpcClient.setResourceManager(DefaultResourceManager.get());    // \u6dfb\u52a0\u76d1\u542c\u5668\uff0c\u76d1\u542cServer\u7aef\u7684\u6d88\u606f\u63a8\u9001    rmRpcClient.setClientMessageListener(new RmMessageListener(DefaultRMHandler.get()));    // \u521d\u59cb\u5316RPC    rmRpcClient.init();}\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u548cTMClient\u60f3\u6bd4\uff0cRMClient\u591a\u51fa\u4e86\u4e00\u4e2a\u76d1\u542cServer\u7aef\u6d88\u606f\u5e76\u5904\u7406\u7684\u673a\u5236\u3002\u4e5f\u5c31\u662f\u8bf4TM\u7684\u804c\u8d23\u66f4\u591a\u7684\u662f\u4e3b\u52a8\u4e0eServer\u7aef\u901a\u4fe1\uff0c\u6bd4\u5982\uff1a\u5168\u5c40\u4e8b\u52a1\u7684begin\u3001commit\u3001rollback\u7b49\u3002"}),"\n",(0,a.jsx)(n.p,{children:"\u800cRM\u9664\u4e86\u4e3b\u52a8\u64cd\u4f5c\u672c\u5730\u8d44\u6e90\u5916\uff0c\u8fd8\u4f1a\u56e0\u4e3a\u5168\u5c40\u4e8b\u52a1\u7684commit\u3001rollback\u7b49\u7684\u6d88\u606f\u63a8\u9001\uff0c\u4ece\u800c\u5bf9\u672c\u5730\u8d44\u6e90\u8fdb\u884c\u76f8\u5173\u64cd\u4f5c\u3002"}),"\n",(0,a.jsx)(n.p,{children:"\u8bbe\u7f6e\u8d44\u6e90\u7ba1\u7406\u5668resourceManager\uff0c\u8bbe\u7f6e\u6d88\u606f\u56de\u8c03\u76d1\u542c\u5668\u7528\u4e8e\u63a5\u6536TC\u5728\u4e8c\u9636\u6bb5\u53d1\u51fa\u7684\u63d0\u4ea4\u6216\u8005\u56de\u6eda\u8bf7\u6c42\uff0cSeata\u4e2d\u5bf9ResourceManager\uff0cAbstractRMHandler\u505a\u4e86SPI\u9002\u914d\uff0c\u4ee5ResouceManager\u4e3a\u4f8b\uff1a"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"public class DefaultResourceManager implements ResourceManager {    protected void initResourceManagers() {        //init all resource managers        List<ResourceManager> allResourceManagers = EnhancedServiceLoader.loadAll(ResourceManager.class);        if (CollectionUtils.isNotEmpty(allResourceManagers)) {            for (ResourceManager rm : allResourceManagers) {                resourceManagers.put(rm.getBranchType(), rm);            }        }    }}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u53ef\u4ee5\u770b\u5230\u521d\u59cb\u5316DefaultResouceManager\u65f6\u4f1a\u4f7f\u7528ClassLoader\u53bb\u52a0\u8f7d\u5bf9\u5e94Jar\u4e0b\u7684\u5b9e\u73b0\uff0c\u800c\u9ed8\u8ba4AT\u6a21\u5f0f\u4f7f\u7528\u7684\u5b9e\u73b0\u662f\u6570\u636e\u5e93\uff0c\u4e5f\u5c31\u662frm-datasource\u5305\u4e0b\u7684\u5b9e\u73b0\uff0c\u627e\u5b9e\u73b0\u7c7b\u8def\u5f84\u9700\u8981\u5b9a\u4f4d\u5230/resources/META-INF/\u6269\u5c55\u63a5\u53e3\u5168\u8def\u5f84\u53bb\u627e\uff0c\u5c31\u4f1a\u627e\u5230\u5bf9\u5e94\u7684\u5b9e\u73b0\u7c7b ",(0,a.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/84399f558194f3dce18275c72cb9a92219db25.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0a\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0a\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"ResourceManager\u5bf9\u5e94\u5b9e\u73b0\u7c7b\u5168\u8def\u5f84\nio.seata.rm.datasource.DataSourceManager\uff0c\u8be5\u7c7b\u4e2d\u6307\u5b9a\u4e86\u4e86\u63d0\u4ea4\u548c\u56de\u6eda\u7684\u65b9\u6cd5\uff0cDefaultRMHandler\u5bf9\u5e94\u5b9e\u73b0\u7c7b\u5168\u8def\u5f84io.seata.rm.RMHandlerAT\uff0c\u662f\u4e2a\u63a5\u6536server\u6d88\u606f\u5e76\u505a\u5bf9\u5e94\u63d0\u4ea4\u6216\u8005\u56de\u6eda\u64cd\u4f5c\u7684\u56de\u8c03\u5904\u7406\u7c7b\u3002"]}),"\n",(0,a.jsx)(n.p,{children:"RMClinet\u7684init()\u65b9\u6cd5\u4e0eTMClient\u57fa\u672c\u4e00\u81f4"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"2.3.3 \u603b\u7ed3"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Spring\u542f\u52a8\u65f6\uff0c\u521d\u59cb\u5316\u4e862\u4e2a\u5ba2\u6237\u7aefTmClient\u3001RmClient"}),"\n",(0,a.jsx)(n.li,{children:"TmClient\u4e0eseata-server\u901a\u8fc7Netty\u5efa\u7acb\u8fde\u63a5\u5e76\u53d1\u9001\u6d88\u606f"}),"\n",(0,a.jsx)(n.li,{children:"RmClient\u4e0eseata-server\u901a\u8fc7Netty\u5efa\u7acb\u8fde\u63a5\uff0c\u8d1f\u8d23\u63a5\u6536\u4e8c\u9636\u6bb5\u63d0\u4ea4\u3001\u56de\u6eda\u6d88\u606f\u5e76\u5728\u56de\u8c03\u5668(RmHandler)\u4e2d\u505a\u5904\u7406"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"\u4f5c\u8005 | \u4e00\u8d77\u64b8Java\n\u6765\u6e90 |\u4eca\u65e5\u5934\u6761"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"2.4 AbstractAutoProxyCreator"}),"\nGlobalTransactionScanner\u521d\u59cb\u5316\u5b8c\u4e86TM\u548cRM\u4ee5\u540e\uff0c\u6211\u4eec\u518d\u5173\u6ce8\u4e00\u4e0bAbstractAutoProxyCreator\uff0c\u81ea\u52a8\u4ee3\u7406\u3002"]}),"\n",(0,a.jsx)(n.p,{children:"\u81ea\u52a8\u4ee3\u7406\uff0c\u5b83\u4ee3\u7406\u5565\u4e1c\u897f\u5462\uff1f\u6216\u8005\u8bf4\u5b83\u7ed9spring\u4e2d\u7684Bean\u589e\u5f3a\u4e86\u4ec0\u4e48\u529f\u80fd\uff1f"}),"\n",(0,a.jsx)(n.p,{children:"GlobalTransactionScanner\u4e3b\u8981\u6269\u5c55\u4e86AbstractAutoProxyCreator\u7684wrapIfNecessary"}),"\n",(0,a.jsx)(n.p,{children:"\u4ee3\u7406\u589e\u5f3a\u7684\u524d\u7f6e\u5224\u65ad\u5904\u7406\uff0c\u8868\u793a\u662f\u5426\u8be5Bean\u9700\u8981\u589e\u5f3a\uff0c\u5982\u679c\u589e\u5f3a\u7684\u8bdd\u521b\u5efa\u4ee3\u7406\u7c7b"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"2.4.1 wrapIfNecessary"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"@Overrideprotected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) {    if (disableGlobalTransaction) {        return bean;    }    try {        synchronized (PROXYED_SET) {            // \u76f8\u540cBean\u6392\u91cd            if (PROXYED_SET.contains(beanName)) {                return bean;            }             interceptor = null;            // \u5224\u65ad\u662f\u5426\u5f00\u542fTCC\u6a21\u5f0f            if (TCCBeanParserUtils.isTccAutoProxy(bean, beanName, applicationContext)) {                // TCC\u5b9e\u73b0\u7684\u62e6\u622a\u5668                interceptor = new TccActionInterceptor(TCCBeanParserUtils.getRemotingDesc(beanName));            } else {                Class<?> serviceInterface = SpringProxyUtils.findTargetClass(bean);                Class<?>[] interfacesIfJdk = SpringProxyUtils.findInterfaces(bean);                 // \u5224\u65ad\u662f\u5426\u5b58\u5728@GlobalTransactional\u6216\u8005@GlobalLock\u6ce8\u89e3                if (!existsAnnotation(new Class[]{serviceInterface})                    && !existsAnnotation(interfacesIfJdk)) {                    return bean;                }                 if (interceptor == null) {                    // \u975eTCC\u7684\u62e6\u622a\u5668                    if (globalTransactionalInterceptor == null) {                        globalTransactionalInterceptor = new GlobalTransactionalInterceptor(failureHandlerHook);                        ConfigurationCache.addConfigListener(                            ConfigurationKeys.DISABLE_GLOBAL_TRANSACTION,                            (ConfigurationChangeListener)globalTransactionalInterceptor);                    }                    interceptor = globalTransactionalInterceptor;                }            }            // \u5224\u65ad\u5f53\u524dBean\u662f\u5426\u5df2\u7ecf\u662fspring\u7684\u4ee3\u7406\u7c7b\u4e86            if (!AopUtils.isAopProxy(bean)) {                // \u5982\u679c\u8fd8\u4e0d\u662f\uff0c\u90a3\u4e48\u8d70\u4e00\u8f6espring\u7684\u4ee3\u7406\u8fc7\u7a0b\u5373\u53ef                bean = super.wrapIfNecessary(bean, beanName, cacheKey);            } else {                // \u5982\u679c\u662f\u4e00\u4e2aspring\u7684\u4ee3\u7406\u7c7b\uff0c\u90a3\u4e48\u53cd\u5c04\u83b7\u53d6\u4ee3\u7406\u7c7b\u4e2d\u5df2\u7ecf\u5b58\u5728\u7684\u62e6\u622a\u5668\u96c6\u5408\uff0c\u7136\u540e\u6dfb\u52a0\u5230\u8be5\u96c6\u5408\u5f53\u4e2d                AdvisedSupport advised = SpringProxyUtils.getAdvisedSupport(bean);                Advisor[] advisor = buildAdvisors(beanName, getAdvicesAndAdvisorsForBean(null, null, null));                for (Advisor avr : advisor) {                    advised.addAdvisor(0, avr);                }            }             PROXYED_SET.add(beanName);            return bean;        }    } catch (Exception exx) {}}\n"})}),"\n",(0,a.jsx)(n.p,{children:"wrapIfNecessary\u65b9\u6cd5\u8f83\u957f\u6211\u4eec\u5206\u6b65\u9aa4\u770b\u770b"}),"\n",(0,a.jsx)(n.p,{children:"1\uff09isTccAutoProxy\u5224\u65ad\u662f\u5426\u5f00\u542ftcc\u6a21\u5f0f\uff0c\u5f00\u542f\u7684\u8bdd\u9009\u62e9\u4e86TccActionInterceptor\u62e6\u622a\u5668\uff0c\u975etcc\u6a21\u5f0f\u9009\u62e9\nGlobalTransactionalInterceptor\u62e6\u622a\u5668\uff0c\u9ed8\u8ba4\u4e0d\u5f00\u542f"}),"\n",(0,a.jsx)(n.p,{children:"2\uff09existAnnotation\u5224\u65ad\u5f53\u524dBean\u662f\u5426\u6709\u7c7b\u6216\u8005\u63a5\u53e3\u7684\u65b9\u6cd5\u5b58\u5728@GlobalTransactional\u6216\u8005@GlobalLock\u6ce8\u89e3\uff0c\u5982\u679c\u6ca1\u6709\u5219\u76f4\u63a5\u8fd4\u56de"}),"\n",(0,a.jsx)(n.p,{children:"3\uff09isAopProxy\u65b9\u6cd5\u662f\u5224\u65ad\u5f53\u524d\u7684Bean\u662f\u5426\u5df2\u7ecf\u662fspring\u7684\u4ee3\u7406\u7c7b\u4e86\uff0c\u65e0\u8bba\u662fJDK\u52a8\u6001\u4ee3\u7406\u8fd8\u662fCglib\u7c7b\u4ee3\u7406\u3002\u5982\u679c\u662f\u666e\u901a\u7684Bean\uff0c\u8d70\u539f\u6709\u7684\u751f\u6210\u4ee3\u7406\u903b\u8f91\u5373\u53ef\uff0c\u5982\u679c\u5df2\u7ecf\u662f\u4ee3\u7406\u7c7b\uff0c\u90a3\u4e48\u8981\u901a\u8fc7\u53cd\u5c04\u83b7\u53d6\u4ee3\u7406\u5bf9\u8c61\u5185\u7684\u62e6\u622a\u5668\u96c6\u5408\u4e5f\u53eb\u505aAdvisor\uff0c\u76f4\u63a5\u6dfb\u52a0\u5230\u8be5\u96c6\u5408\u5f53\u4e2d\u3002"}),"\n",(0,a.jsx)(n.p,{children:"wrapIfNecessary\u7684\u65b9\u6cd5\u5e76\u4e0d\u590d\u6742\uff0c\u4f46\u662f\u5982\u679c\u5bf9\u4ee3\u7406\u4e0d\u662f\u5f88\u719f\u6089\u6216\u8bb8\u5bf9\u7ec6\u8282\u70b9\u4f1a\u6709\u4e9b\u56f0\u60d1\u3002"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"2.4.1.1 AT\u4e00\u9636\u6bb5\u5f00\u542f\u5168\u5c40\u4e8b\u52a1"})}),"\n",(0,a.jsx)(n.p,{children:"\u5728\u9700\u8981\u8fdb\u884c\u5168\u5c40\u4e8b\u52a1\u7ba1\u7406\u7684\u63a5\u53e3\u4e0a\uff0c\u4f1a\u52a0@GlobalTransactional\u6ce8\u89e3\uff0c\u8fd9\u4e2a\u6ce8\u89e3\u4f1a\u53c8\u4e00\u4e2a\u5bf9\u5e94\u7684\u62e6\u622a\u5668\u8fdb\u884c\u62e6\u622a\nGlobalTransactionalInterceptor\uff0cinvoke\u5c31\u662f\u62e6\u622a\u65b9\u6cd5"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"@Overridepublic Object invoke(final MethodInvocation methodInvocation) throws Throwable {    Class<?> targetClass =        methodInvocation.getThis() != null ? AopUtils.getTargetClass(methodInvocation.getThis()) : null;    Method specificMethod = ClassUtils.getMostSpecificMethod(methodInvocation.getMethod(), targetClass);    if (specificMethod != null && !specificMethod.getDeclaringClass().equals(Object.class)) {        final Method method = BridgeMethodResolver.findBridgedMethod(specificMethod);        //\u83b7\u53d6\u65b9\u6cd5\u4e0a\u7684\u5168\u5c40\u4e8b\u52a1\u6ce8\u89e3        final GlobalTransactional globalTransactionalAnnotation =            getAnnotation(method, targetClass, GlobalTransactional.class);        //\u83b7\u53d6\u65b9\u6cd5\u4e0a\u7684\u5168\u5c40\u9501\u6ce8\u89e3        final GlobalLock globalLockAnnotation = getAnnotation(method, targetClass, GlobalLock.class);        boolean localDisable = disable || (degradeCheck && degradeNum >= degradeCheckAllowTimes);        if (!localDisable) {            //\u5982\u679c\u65b9\u6cd5\u4e0a\u6709\u5168\u5c40\u4e8b\u52a1\u6ce8\u89e3\uff0c\u8c03\u7528handleGlobalTransaction\u5f00\u542f\u5168\u5c40\u4e8b\u52a1            if (globalTransactionalAnnotation != null) {                return handleGlobalTransaction(methodInvocation, globalTransactionalAnnotation);            //\u5982\u679c\u65b9\u6cd5\u4e0a\u6709\u5168\u5c40\u9501\u6ce8\u89e3\uff0c\u8c03\u7528handleGlobalLock\u5f00\u542f\u5168\u5c40\u9501            } else if (globalLockAnnotation != null) {                return handleGlobalLock(methodInvocation);            }        }    }    //\u5982\u679c\u5565\u90fd\u6ca1\u6709\uff0c\u6309\u666e\u901a\u65b9\u6cd5\u6267\u884c\uff0c\u63d0\u5347\u6027\u80fd    return methodInvocation.proceed();}\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u5728handleGlobalTransaction\u65b9\u6cd5\u4e2d\u8c03\u7528\u4e86\ntransactionalTemplate.execute\u65b9\u6cd5"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"// 2\\. \u5f00\u542f\u5168\u5c40\u4e8b\u52a1beginTransactionbeginTransaction(txInfo, tx); Object rs = null;try {     // \u6267\u884c\u4e1a\u52a1\u65b9\u6cd5business.execute()    rs = business.execute(); } catch (Throwable ex) {     // 3.\u51fa\u73b0\u5f02\u5e38\u6267\u884ccompleteTransactionAfterThrowing\u56de\u6eda    completeTransactionAfterThrowing(txInfo, tx, ex);    throw ex;} // 4\\. \u6ca1\u6709\u5f02\u5e38\u63d0\u4ea4\u4e8b\u52a1commitTransactioncommitTransaction(tx);\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u5f00\u542f\u5168\u5c40\u4e8b\u52a1\u6700\u7ec8\u8c03\u7528\nio.seata.tm.api.DefaultGlobalTransaction#begin(int, java.lang.String)\u65b9\u6cd5"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'@Overridepublic void begin(int timeout, String name) throws TransactionException {    //\u6b64\u5904\u7684\u89d2\u8272\u5224\u65ad\u6709\u5173\u952e\u7684\u4f5c\u7528//\u8868\u660e\u5f53\u524d\u662f\u5168\u5c40\u4e8b\u52a1\u7684\u53d1\u8d77\u8005\uff08Launcher\uff09\u8fd8\u662f\u53c2\u4e0e\u8005\uff08Participant\uff09//\u5982\u679c\u5728\u5206\u5e03\u5f0f\u4e8b\u52a1\u7684\u4e0b\u6e38\u7cfb\u7edf\u65b9\u6cd5\u4e2d\u4e5f\u52a0\u4e0aGlobalTransactional\u6ce8\u89e3//\u90a3\u4e48\u5b83\u7684\u89d2\u8272\u5c31\u662fParticipant\uff0c\u5373\u4f1a\u5ffd\u7565\u540e\u9762\u7684begin\u5c31\u9000\u51fa\u4e86    //\u800c\u5224\u65ad\u662f\u53d1\u8d77\u8005\uff08Launcher\uff09\u8fd8\u662f\u53c2\u4e0e\u8005\uff08Participant\uff09\u662f\u6839\u636e\u5f53\u524d\u4e0a\u4e0b\u6587\u662f\u5426\u5df2\u5b58\u5728XID\u6765\u5224\u65ad    //\u6ca1\u6709XID\u7684\u5c31\u662fLauncher\uff0c\u5df2\u7ecf\u5b58\u5728XID\u7684\u5c31\u662fParticipant    if (role != GlobalTransactionRole.Launcher) {        assertXIDNotNull();        if (LOGGER.isDebugEnabled()) {            LOGGER.debug("Ignore Begin(): just involved in global transaction [{}]", xid);        }        return;    }    assertXIDNull();    if (RootContext.getXID() != null) {        throw new IllegalStateException();    }    xid = transactionManager.begin(null, null, name, timeout);    status = GlobalStatus.Begin;    RootContext.bind(xid);    if (LOGGER.isInfoEnabled()) {        LOGGER.info("Begin new global transaction [{}]", xid);    } }\n'})}),"\n",(0,a.jsx)(n.p,{children:"\u8bf7\u6c42seata-server\u83b7\u53d6\u5168\u5c40\u4e8b\u52a1XID"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'@Overridepublic String begin(String applicationId, String transactionServiceGroup, String name, int timeout)    throws TransactionException {    GlobalBeginRequest request = new GlobalBeginRequest();    request.setTransactionName(name);    request.setTimeout(timeout);    //\u8ddf\u8fdb    GlobalBeginResponse response = (GlobalBeginResponse) syncCall(request);    if (response.getResultCode() == ResultCode.Failed) {        throw new TmTransactionException(TransactionExceptionCode.BeginFailed, response.getMsg());    }    return response.getXid();}\nprivate AbstractTransactionResponse syncCall(AbstractTransactionRequest request) throws TransactionException {    try {        //TMClient\u5c01\u88c5\u7684Netty\u5bf9\u8c61        return (AbstractTransactionResponse) TmNettyRemotingClient.getInstance().sendSyncRequest(request);    } catch (TimeoutException toe) {        throw new TmTransactionException(TransactionExceptionCode.IO, "RPC timeout", toe);    }}\n'})}),"\n",(0,a.jsx)(n.p,{children:"\u5c06XID\u7ed1\u5b9a\u5728RootContext\u4e2d\uff0c\u7531\u6b64\u53ef\u4ee5\u770b\u51fa\u5168\u5c40\u4e8b\u52a1\u662f\u7531TM\u53d1\u8d77\u7684\uff0cTM\u53d1\u8d77\u5168\u5c40\u4e8b\u52a1\u8bf7\u6c42\u7ed9seata-server\u670d\u52a1\uff0cseata-server\u670d\u52a1\u63a5\u53d7\u5230\u8bf7\u6c42\u540e\u5904\u7406\uff08\u4ee5\u4e0b\u662fseata\u670d\u52a1\u4ee3\u7801\uff09\uff1a"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'@Overrideprotected void doGlobalBegin(GlobalBeginRequest request, GlobalBeginResponse response, RpcContext rpcContext)    throws TransactionException {    //\u8fdb\u5165begin    response.setXid(core.begin(rpcContext.getApplicationId(), rpcContext.getTransactionServiceGroup(),                               request.getTransactionName(), request.getTimeout()));    if (LOGGER.isInfoEnabled()) {        LOGGER.info("Begin new global transaction applicationId: {},transactionServiceGroup: {}, transactionName: {},timeout:{},xid:{}",                    rpcContext.getApplicationId(), rpcContext.getTransactionServiceGroup(), request.getTransactionName(), request.getTimeout(), response.getXid());    }}\n'})}),"\n",(0,a.jsx)(n.p,{children:"io.seata.server.coordinator.DefaultCoordinator#doGlobalBegin\u65b9\u6cd5\u63a5\u53d7\u5ba2\u6237\u7aef\u5f00\u542f\u5168\u5c40\u4e8b\u52a1\u7684\u8bf7\u6c42\uff0c\u8c03\u7528io.seata.server.coordinator.DefaultCore#begin\u5f00\u542f\u5168\u5c40\u4e8b\u52a1"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"@Overridepublic String begin(String applicationId, String transactionServiceGroup, String name, int timeout)    throws TransactionException {    GlobalSession session = GlobalSession.createGlobalSession(applicationId, transactionServiceGroup, name,                                                              timeout);    MDC.put(RootContext.MDC_KEY_XID, session.getXid());    session.addSessionLifecycleListener(SessionHolder.getRootSessionManager());//\u5f00\u542f\u4f1a\u8bdd    session.begin();     // transaction start event    eventBus.post(new GlobalTransactionEvent(session.getTransactionId(), GlobalTransactionEvent.ROLE_TC,                                             session.getTransactionName(), applicationId, transactionServiceGroup, session.getBeginTime(), null, session.getStatus()));     return session.getXid();}\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u901a\u8fc7\u5f53\u524d\u4f1a\u8bdd\u5f00\u542f"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"@Overridepublic void begin() throws TransactionException {    this.status = GlobalStatus.Begin;    this.beginTime = System.currentTimeMillis();    this.active = true;    for (SessionLifecycleListener lifecycleListener : lifecycleListeners) {        lifecycleListener.onBegin(this);    }}\n"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/e7c784186f75581eba83325a0fc4708602dadf.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"})}),"\n",(0,a.jsx)(n.p,{children:"\u8c03\u7528\nio.seata.server.session.AbstractSessionManager#onBegin\u65b9\u6cd5\uff0c\u53c8\u8c03\u7528io.seata.server.storage.db.session.DataBaseSessionManager#addGlobalSession\u65b9\u6cd5"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'@Overridepublic void addGlobalSession(GlobalSession session) throws TransactionException {    if (StringUtils.isBlank(taskName)) {        //\u8fdb\u5165        boolean ret = transactionStoreManager.writeSession(LogOperation.GLOBAL_ADD, session);        if (!ret) {            throw new StoreException("addGlobalSession failed.");        }    } else {        boolean ret = transactionStoreManager.writeSession(LogOperation.GLOBAL_UPDATE, session);        if (!ret) {            throw new StoreException("addGlobalSession failed.");        }    }}\n'})}),"\n",(0,a.jsx)(n.p,{children:"\u8fd9\u91cc\u5f80\u6570\u636e\u5e93\u91cc\u5199\u5165\u6570\u636e"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'@Overridepublic boolean writeSession(LogOperation logOperation, SessionStorable session) {    if (LogOperation.GLOBAL_ADD.equals(logOperation)) {        return logStore.insertGlobalTransactionDO(SessionConverter.convertGlobalTransactionDO(session));    } else if (LogOperation.GLOBAL_UPDATE.equals(logOperation)) {        return logStore.updateGlobalTransactionDO(SessionConverter.convertGlobalTransactionDO(session));    } else if (LogOperation.GLOBAL_REMOVE.equals(logOperation)) {        return logStore.deleteGlobalTransactionDO(SessionConverter.convertGlobalTransactionDO(session));    } else if (LogOperation.BRANCH_ADD.equals(logOperation)) {        return logStore.insertBranchTransactionDO(SessionConverter.convertBranchTransactionDO(session));    } else if (LogOperation.BRANCH_UPDATE.equals(logOperation)) {        return logStore.updateBranchTransactionDO(SessionConverter.convertBranchTransactionDO(session));    } else if (LogOperation.BRANCH_REMOVE.equals(logOperation)) {        return logStore.deleteBranchTransactionDO(SessionConverter.convertBranchTransactionDO(session));    } else {        throw new StoreException("Unknown LogOperation:" + logOperation.name());    }}\n'})}),"\n",(0,a.jsx)(n.p,{children:"\u8fd9\u91cc\u5411seata\u5e93global_tab\u63d2\u5165\u6570\u636e\uff0c\u5230\u6b64\u5168\u5c40\u4e8b\u52a1\u5df2\u5f00\u542f"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"2.4.1.2 AT\u4e00\u9636\u6bb5\u6267\u884c\u4e1a\u52a1SQL"}),"\n\u5168\u5c40\u4e8b\u52a1\u5df2\u5f00\u542f\uff0c\u4e0b\u9762\u9700\u8981\u6267\u884c\u4e1a\u52a1SQL\uff0c\u751f\u6210undo_log\u6570\u636e\uff0c\u5168\u5c40\u4e8b\u52a1\u62e6\u622a\u6210\u529f\u540e\u6700\u7ec8\u8fd8\u662f\u6267\u884c\u4e86\u4e1a\u52a1\u65b9\u6cd5\u7684\uff0c\u4f46\u662f\u7531\u4e8eSeata\u5bf9\u6570\u636e\u6e90\u505a\u4e86\u4ee3\u7406\uff0c\u6240\u4ee5sql\u89e3\u6790\u4e0eundo_log\u5165\u5e93\u64cd\u4f5c\u662f\u5728\u6570\u636e\u6e90\u4ee3\u7406\u4e2d\u6267\u884c\u7684\uff0c\u4ee3\u7406\u5c31\u662fSeata\u5bf9DataSource\uff0cConnection\uff0cStatement\u505a\u7684\u4ee3\u7406\u5c01\u88c5\u7c7b"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'/*** \u6784\u9020datasource\u4ee3\u7406\u5bf9\u8c61\uff0c\u66ff\u6362\u539f\u6765\u7684\u7684datasource*/@Primary@Bean("dataSource")public DataSourceProxy dataSourceProxy(DataSource druidDataSource){    return new DataSourceProxy(druidDataSource);}\n'})}),"\n",(0,a.jsxs)(n.p,{children:["\u9879\u76ee\u4e2d\u4f7f\u7528\u7684\u6570\u636e\u6e90\u5747\u7528seata\u7684DataSourceProxy\u4ee3\u66ff",(0,a.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/c8a7a189816e282015a950bfd3c13b7d859974.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"\u6700\u7ec8\u5bf9Sql\u8fdb\u884c\u89e3\u6790\u64cd\u4f5c\uff0c\u53d1\u751f\u5728StatementProxy\u7c7b\u4e2d"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"@Overridepublic boolean execute(String sql) throws SQLException {    this.targetSQL = sql;    return ExecuteTemplate.execute(this, (statement, args) -> statement.execute((String) args[0]), sql);}\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"public static <T, S extends Statement> T execute(List<SQLRecognizer> sqlRecognizers,                                                     StatementProxy<S> statementProxy,                                                     StatementCallback<T, S> statementCallback,                                                     Object... args) throws SQLException {         if (!RootContext.requireGlobalLock() && !StringUtils.equals(BranchType.AT.name(), RootContext.getBranchType())) {            //\u4e0d\u662f\u5168\u5c40\u4e8b\u52a1\u7684\u76f4\u63a5\u6267\u884c\uff0c\u63d0\u5347\u6027\u80fd            return statementCallback.execute(statementProxy.getTargetStatement(), args);        }         String dbType = statementProxy.getConnectionProxy().getDbType();        if (CollectionUtils.isEmpty(sqlRecognizers)) {            sqlRecognizers = SQLVisitorFactory.get(                    statementProxy.getTargetSQL(),                    dbType);        }        Executor<T> executor;        if (CollectionUtils.isEmpty(sqlRecognizers)) {            executor = new PlainExecutor<>(statementProxy, statementCallback);        } else {            if (sqlRecognizers.size() == 1) {                SQLRecognizer sqlRecognizer = sqlRecognizers.get(0);                //\u4e0d\u540cSQL\u7c7b\u578b\uff0c\u4e0d\u540c\u5904\u7406                switch (sqlRecognizer.getSQLType()) {                    case INSERT:                        executor = EnhancedServiceLoader.load(InsertExecutor.class, dbType,                                new Class[]{StatementProxy.class, StatementCallback.class, SQLRecognizer.class},                                new Object[]{statementProxy, statementCallback, sqlRecognizer});                        break;                    case UPDATE:                        executor = new UpdateExecutor<>(statementProxy, statementCallback, sqlRecognizer);                        break;                    case DELETE:                        executor = new DeleteExecutor<>(statementProxy, statementCallback, sqlRecognizer);                        break;                    case SELECT_FOR_UPDATE:                        executor = new SelectForUpdateExecutor<>(statementProxy, statementCallback, sqlRecognizer);                        break;                    default:                        executor = new PlainExecutor<>(statementProxy, statementCallback);                        break;                }            } else {                executor = new MultiExecutor<>(statementProxy, statementCallback, sqlRecognizers);            }        }        T rs;        try {            //\u6267\u884cSQL            rs = executor.execute(args);        } catch (Throwable ex) {            if (!(ex instanceof SQLException)) {                // Turn other exception into SQLException                ex = new SQLException(ex);            }            throw (SQLException) ex;        }        return rs;    }\n"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"\u5148\u5224\u65ad\u662f\u5426\u5f00\u542f\u4e86\u5168\u5c40\u4e8b\u52a1\uff0c\u5982\u679c\u6ca1\u6709\uff0c\u4e0d\u8d70\u4ee3\u7406\uff0c\u4e0d\u89e3\u6790sql\uff0c\u63d0\u5347\u6027\u80fd"}),"\n",(0,a.jsx)(n.li,{children:"\u8c03\u7528SQLVisitorFactory\u5bf9\u76ee\u6807sql\u8fdb\u884c\u89e3\u6790"}),"\n",(0,a.jsx)(n.li,{children:"\u9488\u5bf9\u7279\u5b9a\u7c7b\u578bsql\u64cd\u4f5c(INSERT,UPDATE,DELETE,SELECT_FOR_UPDATE)\u7b49\u8fdb\u884c\u7279\u6b8a\u89e3\u6790"}),"\n",(0,a.jsx)(n.li,{children:"\u6267\u884csql\u5e76\u8fd4\u56de\u7ed3\u679c\n\u4e0d\u540c\u7c7b\u578b\u7684SQL\u5904\u7406\u65b9\u6cd5\u4e0d\u4e00\u6837\uff0c\u8fd9\u91cc\u4ee5insert\u4e3a\u4f8b"}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/b1eb1b610beb647b230995f19ecbb4bbc98602.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"insert\u4f7f\u7528\u7684\u662fInsertExecutor.execute\u65b9\u6cd5\uff0c\u4f46\u5176\u5b9e\u6700\u7ec8\u8fd8\u662f\u4f7f\u7528\nio.seata.rm.datasource.exec.BaseTransactionalExecutor#execute\u65b9\u6cd5"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"@Overridepublic T execute(Object... args) throws Throwable {    if (RootContext.inGlobalTransaction()) {        String xid = RootContext.getXID();        statementProxy.getConnectionProxy().bind(xid);    }     statementProxy.getConnectionProxy().setGlobalLockRequire(RootContext.requireGlobalLock());    return doExecute(args);}\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u5c06\u4e0a\u4e0b\u6587\u4e2d\u7684xid\u7ed1\u5b9a\u5230\u4e86statementProxy\u4e2d\uff0c\u5e76\u8c03\u7528\u4e86doExecute\u65b9\u6cd5\uff0c\u770b\u4e0bAbstractDMLBaseExecutor\u4e2d\u7684doExecute\u65b9\u6cd5"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"@Overridepublic T doExecute(Object... args) throws Throwable {    AbstractConnectionProxy connectionProxy = statementProxy.getConnectionProxy();    if (connectionProxy.getAutoCommit()) {        return executeAutoCommitTrue(args);    } else {        return executeAutoCommitFalse(args);    }}\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u65b9\u6cd5\u4e2d\u8c03\u7528\u4e86\nexecuteAutoCommitTrue/executeAutoCommitFalse"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"protected T executeAutoCommitTrue(Object[] args) throws Throwable {    ConnectionProxy connectionProxy = statementProxy.getConnectionProxy();    try {        connectionProxy.setAutoCommit(false);        return new LockRetryPolicy(connectionProxy).execute(() -> {            T result = executeAutoCommitFalse(args);            connectionProxy.commit();            return result;        });    } catch (Exception e) {        ...    } finally {        connectionProxy.getContext().reset();        connectionProxy.setAutoCommit(true);    }}\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u4f46\u4ed4\u7ec6\u53d1\u73b0\uff0c\u6700\u7ec8\u90fd\u662f\u8c03\u7528executeAutoCommitFalse\u65b9\u6cd5"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'protected T executeAutoCommitFalse(Object[] args) throws Exception {    //\u8ddf\u5165getTableMeta\u65b9\u6cd5    if (!JdbcConstants.MYSQL.equalsIgnoreCase(getDbType()) && getTableMeta().getPrimaryKeyOnlyName().size() > 1)    {        throw new NotSupportYetException("multi pk only support mysql!");    }    //\u83b7\u53d6beforeImage    TableRecords beforeImage = beforeImage();    //\u6267\u884c\u4e1a\u52a1sql    T result = statementCallback.execute(statementProxy.getTargetStatement(), args);    //\u83b7\u53d6afterImage    TableRecords afterImage = afterImage(beforeImage);    //\u4fdd\u5b58image    prepareUndoLog(beforeImage, afterImage);    return result;}\n'})}),"\n",(0,a.jsx)(n.p,{children:"\u83b7\u53d6beforeImage"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"//tableMeta\u91cc\u9762\u5305\u542b\u8868\u540d\u3001\u5217\u3001\u7d22\u5f15\u7b49\u6570\u636eprotected TableMeta getTableMeta(String tableName) {    if (tableMeta != null) {        return tableMeta;    }    ConnectionProxy connectionProxy = statementProxy.getConnectionProxy();    tableMeta = TableMetaCacheFactory.getTableMetaCache(connectionProxy.getDbType())        .getTableMeta(connectionProxy.getTargetConnection(), tableName, connectionProxy.getDataSourceProxy().getResourceId());    return tableMeta;}\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u6267\u884c\u4e1a\u52a1sql\u8fd8\u662f\u4f7f\u7528\ncom.alibaba.druid.pool.DruidPooledPreparedStatement#execute\u65b9\u6cd5\u6267\u884c"}),"\n",(0,a.jsxs)(n.p,{children:["\u83b7\u53d6afterImage",(0,a.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/540ff5c254dde029bed208247025e97bd1f497.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"\u5728\u63d0\u4ea4\u4e8b\u52a1\u65f6\uff0c\u63d2\u5165undo_log\u65e5\u5fd7"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"protected T executeAutoCommitTrue(Object[] args) throws Throwable {    ConnectionProxy connectionProxy = statementProxy.getConnectionProxy();    try {        connectionProxy.setAutoCommit(false);        return new LockRetryPolicy(connectionProxy).execute(() -> {            T result = executeAutoCommitFalse(args);            //\u8ddf\u5165            connectionProxy.commit();            return result;        });    } catch (Exception e) {        ...    } finally {        connectionProxy.getContext().reset();        connectionProxy.setAutoCommit(true);    }}\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"public void commit() throws SQLException {    try {        LOCK_RETRY_POLICY.execute(() -> {            //\u8ddf\u5165            doCommit();            return null;        });    } catch (SQLException e) {        throw e;    } catch (Exception e) {        throw new SQLException(e);    }}\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"private void doCommit() throws SQLException {    if (context.inGlobalTransaction()) {        //\u8ddf\u5165        processGlobalTransactionCommit();    } else if (context.isGlobalLockRequire()) {        processLocalCommitWithGlobalLocks();    } else {        targetConnection.commit();    }}\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"private void processGlobalTransactionCommit() throws SQLException {    try {        //\u5411seata-server\u6ce8\u518c\u5206\u652f\u4fe1\u606f        register();    } catch (TransactionException e) {        recognizeLockKeyConflictException(e, context.buildLockKeys());    }    try {        //\u63d0\u4ea4\u4e8b\u52a1\u4e4b\u524d\uff0c\u63d2\u5165undo_log,\u8ddf\u5165flushUndoLogs        UndoLogManagerFactory.getUndoLogManager(this.getDbType()).flushUndoLogs(this);        targetConnection.commit();    } catch (Throwable ex) {       ...    }    if (IS_REPORT_SUCCESS_ENABLE) {        report(true);    }    context.reset();}\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"public void flushUndoLogs(ConnectionProxy cp) throws SQLException {    ConnectionContext connectionContext = cp.getContext();    if (!connectionContext.hasUndoLog()) {        return;    }     String xid = connectionContext.getXid();    long branchId = connectionContext.getBranchId();     ...//\u8be5\u65b9\u6cd5\u63d2\u5165undo_log    insertUndoLogWithNormal(xid, branchId, buildContext(parser.getName()), undoLogContent,                            cp.getTargetConnection());}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["\u5728\u8be5\u65b9\u6cd5\u4e2d\u6ce8\u518c\u5206\u652f\u4e8b\u52a1",(0,a.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/92309a950c73829078a3170c585fc58fb03b0d.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"\u63d0\u4ea4\u4e8b\u52a1\uff0c\u5411seata-server\u6ce8\u518c\u5206\u652f\u4fe1\u606f\uff0cseata-server\u63a5\u6536\u5230\u8bf7\u6c42\uff08seata\u6e90\u7801\uff09",(0,a.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/c116df5929a1116e61e683298e14b953450bb7.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"})]}),"\n",(0,a.jsx)(n.p,{children:"io.seata.server.coordinator.DefaultCoordinator#doBranchRegister\u65b9\u6cd5"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"public Long branchRegister(BranchType branchType, String resourceId, String clientId, String xid,                           String applicationData, String lockKeys) throws TransactionException {    GlobalSession globalSession = assertGlobalSessionNotNull(xid, false);    return SessionHolder.lockAndExecute(globalSession, () -> {        ...        try {            //\u8fdb\u884c\u6ce8\u518c            globalSession.addBranch(branchSession);        } catch (RuntimeException ex) {            ...        }        ...        return branchSession.getBranchId();    });}\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"@Overridepublic void addBranch(BranchSession branchSession) throws TransactionException {    for (SessionLifecycleListener lifecycleListener : lifecycleListeners) {        //\u8ddf\u5165onAddBranch\uff0c\u9009\u62e9AbstractSessionManager        lifecycleListener.onAddBranch(this, branchSession);    }    branchSession.setStatus(BranchStatus.Registered);    add(branchSession);}\n"})}),"\n",(0,a.jsx)(n.p,{children:"io.seata.server.storage.db.session.DataBaseSessionManager#addBranchSession\u65b9\u6cd5"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"@Overridepublic void onAddBranch(GlobalSession globalSession, BranchSession branchSession) throws TransactionException {    //\u8ddf\u5165\uff0c\u9009\u62e9DataBaseSessionManager    addBranchSession(globalSession, branchSession);}\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'@Overridepublic void addBranchSession(GlobalSession globalSession, BranchSession session) throws TransactionException {    if (StringUtils.isNotBlank(taskName)) {        return;    }    //\u8ddf\u5165    boolean ret = transactionStoreManager.writeSession(LogOperation.BRANCH_ADD, session);    if (!ret) {        throw new StoreException("addBranchSession failed.");    }}\n'})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'@Overridepublic boolean writeSession(LogOperation logOperation, SessionStorable session) {    if (LogOperation.GLOBAL_ADD.equals(logOperation)) {        return logStore.insertGlobalTransactionDO(SessionConverter.convertGlobalTransactionDO(session));    } else if (LogOperation.GLOBAL_UPDATE.equals(logOperation)) {        return logStore.updateGlobalTransactionDO(SessionConverter.convertGlobalTransactionDO(session));    } else if (LogOperation.GLOBAL_REMOVE.equals(logOperation)) {        return logStore.deleteGlobalTransactionDO(SessionConverter.convertGlobalTransactionDO(session));    } else if (LogOperation.BRANCH_ADD.equals(logOperation)) {        return logStore.insertBranchTransactionDO(SessionConverter.convertBranchTransactionDO(session));    } else if (LogOperation.BRANCH_UPDATE.equals(logOperation)) {        return logStore.updateBranchTransactionDO(SessionConverter.convertBranchTransactionDO(session));    } else if (LogOperation.BRANCH_REMOVE.equals(logOperation)) {        return logStore.deleteBranchTransactionDO(SessionConverter.convertBranchTransactionDO(session));    } else {        throw new StoreException("Unknown LogOperation:" + logOperation.name());    }}\n'})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"@Overridepublic boolean insertBranchTransactionDO(BranchTransactionDO branchTransactionDO) {    String sql = LogStoreSqlsFactory.getLogStoreSqls(dbType).getInsertBranchTransactionSQL(branchTable);    Connection conn = null;    PreparedStatement ps = null;    try {        int index = 1;        conn = logStoreDataSource.getConnection();        conn.setAutoCommit(true);        ps = conn.prepareStatement(sql);        ps.setString(index++, branchTransactionDO.getXid());        ps.setLong(index++, branchTransactionDO.getTransactionId());        ps.setLong(index++, branchTransactionDO.getBranchId());        ps.setString(index++, branchTransactionDO.getResourceGroupId());        ps.setString(index++, branchTransactionDO.getResourceId());        ps.setString(index++, branchTransactionDO.getBranchType());        ps.setInt(index++, branchTransactionDO.getStatus());        ps.setString(index++, branchTransactionDO.getClientId());        ps.setString(index++, branchTransactionDO.getApplicationData());        return ps.executeUpdate() > 0;    } catch (SQLException e) {        throw new StoreException(e);    } finally {        IOUtil.close(ps, conn);    }}\n"})}),"\n",(0,a.jsx)(n.p,{children:"Seata-server\u6dfb\u52a0\u5206\u652f\u4fe1\u606f\u5b8c\u6210\uff0c\u5230\u8fd9\u91cc\uff0c\u4e00\u9636\u6bb5\u7ed3\u675f\uff0c\u4e1a\u52a1\u6570\u636e\uff0cundo_log\uff0c\u5206\u652f\u4fe1\u606f\u90fd\u5df2\u7ecf\u5199\u5165\u6570\u636e\u5e93"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"2.4.1.3 AT\u4e8c\u9636\u6bb5\u63d0\u4ea4"}),"\n\u56de\u5230handleGlobalTransaction\u65b9\u6cd5\u4e2d\uff0c\u8c03\u7528\u4e86\ntransactionalTemplate.execute\u65b9\u6cd5"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"// 2\\. \u5f00\u542f\u5168\u5c40\u4e8b\u52a1beginTransactionbeginTransaction(txInfo, tx); Object rs = null;try {     // \u6267\u884c\u4e1a\u52a1\u65b9\u6cd5business.execute()    rs = business.execute(); } catch (Throwable ex) {     //\u4e0a\u9762\u662f\u4e00\u9636\u6bb5    //\u4e0b\u9762\u662f\u4e8c\u9636\u6bb5    // 3.\u51fa\u73b0\u5f02\u5e38\u6267\u884ccompleteTransactionAfterThrowing\u56de\u6eda    completeTransactionAfterThrowing(txInfo, tx, ex);    throw ex;} // 4\\. \u6ca1\u6709\u5f02\u5e38\u63d0\u4ea4\u4e8b\u52a1commitTransactioncommitTransaction(tx);\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u4e8c\u9636\u6bb5\u63d0\u4ea4"}),"\n",(0,a.jsx)(n.p,{children:"commitTransaction(tx);\u8ddf\u8fdb"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"private void commitTransaction(GlobalTransaction tx) throws TransactionalExecutor.ExecutionException {    try {        triggerBeforeCommit();        //\u8ddf\u5165        tx.commit();        triggerAfterCommit();    } catch (TransactionException txe) {        // 4.1 Failed to commit        throw new TransactionalExecutor.ExecutionException(tx, txe,                                                           TransactionalExecutor.Code.CommitFailure);    }}\n"})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/61b35980530bd17bff9025f1112baa9e3e93e5.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"@Overridepublic GlobalStatus commit(String xid) throws TransactionException {    GlobalCommitRequest globalCommit = new GlobalCommitRequest();    globalCommit.setXid(xid);    //\u8ddf\u5165syncCall    GlobalCommitResponse response = (GlobalCommitResponse) syncCall(globalCommit);    return response.getGlobalStatus();}\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'private AbstractTransactionResponse syncCall(AbstractTransactionRequest request) throws TransactionException {    try {        return (AbstractTransactionResponse) TmNettyRemotingClient.getInstance().sendSyncRequest(request);    } catch (TimeoutException toe) {        throw new TmTransactionException(TransactionExceptionCode.IO, "RPC timeout", toe);    }}\n'})}),"\n",(0,a.jsx)(n.p,{children:"\u6700\u7ec8\u901a\u8fc7TM\u8bf7\u6c42seata-server\uff0cSeata-server\u63a5\u6536\u5230\u5168\u5c40\u63d0\u4ea4\u8bf7\u6c42\uff08seata\u6e90\u7801\uff09"}),"\n",(0,a.jsx)(n.p,{children:"DefaultCoordinator\u4e2d"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"@Overrideprotected void doGlobalCommit(GlobalCommitRequest request, GlobalCommitResponse response, RpcContext rpcContext)    throws TransactionException {    MDC.put(RootContext.MDC_KEY_XID, request.getXid());    //\u8ddf\u5165commit    response.setGlobalStatus(core.commit(request.getXid()));}\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/185262d74acd3a723a7770d5771c19fa9fa5cf.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),(0,a.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/51249f8944b29b9ffc82897a818cb4c33ed06a.png",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),(0,a.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/14a2f2b58ad3f11be518376d5e6f68cc678af9.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"\nSeata-server\u63a5\u6536\u5230\u5ba2\u6237\u7aef\u5168\u5c40\u63d0\u4ea4\u8bf7\u6c42\u540e\uff0c\u5148\u56de\u8c03\u5ba2\u6237\u7aef\uff0c\u5220\u9664undo_log\uff0cseata\u5728\u5220\u9664\u5206\u652f\u53ca\u5168\u5c40\u4e8b\u52a1"]}),"\n",(0,a.jsxs)(n.p,{children:["\u4e4b\u524d\u8bf4\u8fc7RMClient\u5728\u521d\u59cb\u5316\u65f6\uff0c\u8bbe\u7f6e\u8d44\u6e90\u7ba1\u7406\u5668resourceManager\uff0c\u8bbe\u7f6e\u6d88\u606f\u56de\u8c03\u76d1\u542c\u5668\u7528\u4e8e\u63a5\u6536TC\u5728\u4e8c\u9636\u6bb5\u53d1\u51fa\u7684\u63d0\u4ea4\u6216\u8005\u56de\u6eda\u8bf7\u6c42",(0,a.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/884c07085b1230a1aab1883d691532ccf6b79c.png",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"Seata-server\u5220\u9664\u5206\u652f\u6570\u636e\u53ca\u5168\u5c40\u4e8b\u52a1\u6570\u636e"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'@Overridepublic void removeBranch(BranchSession branchSession) throws TransactionException {    // do not unlock if global status in (Committing, CommitRetrying, AsyncCommitting),    // because it\'s already unlocked in \'DefaultCore.commit()\'    if (status != Committing && status != CommitRetrying && status != AsyncCommitting) {        if (!branchSession.unlock()) {            throw new TransactionException("Unlock branch lock failed, xid = " + this.xid + ", branchId = " + branchSession.getBranchId());        }    }    for (SessionLifecycleListener lifecycleListener : lifecycleListeners) {        //\u8ddf\u5165        lifecycleListener.onRemoveBranch(this, branchSession);    }    remove(branchSession);}\n'})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'private void writeSession(LogOperation logOperation, SessionStorable sessionStorable) throws TransactionException {    if (!transactionStoreManager.writeSession(logOperation, sessionStorable)) {        if (LogOperation.GLOBAL_ADD.equals(logOperation)) {            throw new GlobalTransactionException(TransactionExceptionCode.FailedWriteSession,                                                 "Fail to store global session");        } else if (LogOperation.GLOBAL_UPDATE.equals(logOperation)) {            throw new GlobalTransactionException(TransactionExceptionCode.FailedWriteSession,                                                 "Fail to update global session");        } else if (LogOperation.GLOBAL_REMOVE.equals(logOperation)) {            throw new GlobalTransactionException(TransactionExceptionCode.FailedWriteSession,                                                 "Fail to remove global session");        } else if (LogOperation.BRANCH_ADD.equals(logOperation)) {            throw new BranchTransactionException(TransactionExceptionCode.FailedWriteSession,                                                 "Fail to store branch session");        } else if (LogOperation.BRANCH_UPDATE.equals(logOperation)) {            throw new BranchTransactionException(TransactionExceptionCode.FailedWriteSession,                                                 "Fail to update branch session");        } else if (LogOperation.BRANCH_REMOVE.equals(logOperation)) {            throw new BranchTransactionException(TransactionExceptionCode.FailedWriteSession,                                                 "Fail to remove branch session");        } else {            throw new BranchTransactionException(TransactionExceptionCode.FailedWriteSession,                                                 "Unknown LogOperation:" + logOperation.name());        }    }}\n'})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"public static void endCommitted(GlobalSession globalSession) throws TransactionException {    globalSession.changeStatus(GlobalStatus.Committed);    //\u5220\u9664\u5168\u5c40\u4e8b\u52a1    globalSession.end();}\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u5ba2\u6237\u7aef\u5220\u9664undo_log\u6570\u636e"}),"\n",(0,a.jsx)(n.p,{children:"\u5728\u63a5\u6536\u63d0\u4ea4\u91cc\u9762"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'protected void doBranchCommit(BranchCommitRequest request, BranchCommitResponse response)    throws TransactionException {    String xid = request.getXid();    long branchId = request.getBranchId();    String resourceId = request.getResourceId();    String applicationData = request.getApplicationData();    if (LOGGER.isInfoEnabled()) {        LOGGER.info("Branch committing: " + xid + " " + branchId + " " + resourceId + " " + applicationData);    }    //\u8ddf\u5165    BranchStatus status = getResourceManager().branchCommit(request.getBranchType(), xid, branchId, resourceId,                                                            applicationData);    response.setXid(xid);    response.setBranchId(branchId);    response.setBranchStatus(status);    if (LOGGER.isInfoEnabled()) {        LOGGER.info("Branch commit result: " + status);    } }\n'})}),"\n",(0,a.jsx)(n.p,{children:"getResourceManager\u83b7\u53d6\u7684\u5c31\u662fRMClient\u521d\u59cb\u5316\u65f6\u8bbe\u7f6e\u7684\u8d44\u6e90\u7ba1\u7406\u5668DataSourceManager"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"public BranchStatus branchCommit(BranchType branchType, String xid, long branchId, String resourceId,                                 String applicationData) throws TransactionException {    return asyncWorker.branchCommit(branchType, xid, branchId, resourceId, applicationData);}\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'@Overridepublic BranchStatus branchCommit(BranchType branchType, String xid, long branchId, String resourceId,                                 String applicationData) throws TransactionException {    if (!ASYNC_COMMIT_BUFFER.offer(new Phase2Context(branchType, xid, branchId, resourceId, applicationData))) {        LOGGER.warn("Async commit buffer is FULL. Rejected branch [{}/{}] will be handled by housekeeping later.", branchId, xid);    }    return BranchStatus.PhaseTwo_Committed;}\n'})}),"\n",(0,a.jsx)(n.p,{children:"\u8fd9\u8fb9\u53ea\u662f\u5f80\u4e00\u4e2aASYNC_COMMIT_BUFFER\u7f13\u51b2List\u4e2d\u65b0\u589e\u4e86\u4e00\u4e2a\u4e8c\u9636\u6bb5\u63d0\u4ea4\u7684context\uff0c\u4f46\u771f\u6b63\u63d0\u4ea4\u5728AsyncWorker\u7684init()\u65b9\u6cd5"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'public synchronized void init() {    LOGGER.info("Async Commit Buffer Limit: {}", ASYNC_COMMIT_BUFFER_LIMIT);    ScheduledExecutorService timerExecutor = new ScheduledThreadPoolExecutor(1, new NamedThreadFactory("AsyncWorker", 1, true));    timerExecutor.scheduleAtFixedRate(() -> {        try {//\u8ddf\u5165            doBranchCommits();         } catch (Throwable e) {            LOGGER.info("Failed at async committing ... {}", e.getMessage());         }    }, 10, 1000 * 1, TimeUnit.MILLISECONDS);}\n'})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/a730eb7781ec4bd3ad2578fb7855aa02d45fbc.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"\u5220\u9664Undo_log"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"\u4e8c\u9636\u6bb5\u56de\u6eda"})}),"\n",(0,a.jsx)(n.p,{children:"\u4e8c\u9636\u6bb5\u56de\u6edaseata-server\u7aef\u4ee3\u7801\u4e0e\u4e8c\u9636\u6bb5\u63d0\u4ea4\u7c7b\u4f3c\uff0c\u8fd9\u91cc\u7701\u7565"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"protected void doGlobalRollback(GlobalRollbackRequest request, GlobalRollbackResponse response,                                RpcContext rpcContext) throws TransactionException {    MDC.put(RootContext.MDC_KEY_XID, request.getXid());    //\u5168\u5c40\u56de\u6edasea\u4ed6\u63a5\u6536\u8bf7\u6c42    response.setGlobalStatus(core.rollback(request.getXid()));}\n"})}),"\n",(0,a.jsx)(n.p,{children:"\u4e3b\u8981\u770b\u56de\u6eda\u5ba2\u6237\u7aef\u5982\u4f55\u8fdb\u884c\u4e8b\u52a1\u8865\u507f"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"@Overridepublic BranchRollbackResponse handle(BranchRollbackRequest request) {    BranchRollbackResponse response = new BranchRollbackResponse();    exceptionHandleTemplate(new AbstractCallback<BranchRollbackRequest, BranchRollbackResponse>() {        @Override        public void execute(BranchRollbackRequest request, BranchRollbackResponse response)            throws TransactionException {            //\u8ddf\u5165            doBranchRollback(request, response);        }    }, request, response);    return response;}\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'public BranchStatus branchRollback(BranchType branchType, String xid, long branchId, String resourceId,                                   String applicationData) throws TransactionException {    DataSourceProxy dataSourceProxy = get(resourceId);    if (dataSourceProxy == null) {        throw new ShouldNeverHappenException();    }    try {        UndoLogManagerFactory.getUndoLogManager(dataSourceProxy.getDbType()).undo(dataSourceProxy, xid, branchId);    } catch (TransactionException te) {        StackTraceLogger.info(LOGGER, te,                              "branchRollback failed. branchType:[{}], xid:[{}], branchId:[{}], resourceId:[{}], applicationData:[{}]. reason:[{}]",                              new Object[]{branchType, xid, branchId, resourceId, applicationData, te.getMessage()});        if (te.getCode() == TransactionExceptionCode.BranchRollbackFailed_Unretriable) {            return BranchStatus.PhaseTwo_RollbackFailed_Unretryable;        } else {            return BranchStatus.PhaseTwo_RollbackFailed_Retryable;        }    }    return BranchStatus.PhaseTwo_Rollbacked; }\n'})}),"\n",(0,a.jsxs)(n.p,{children:["\u6700\u7ec8\u56de\u6eda\u65b9\u6cd5\u8c03\u7528\u7684\u662fUndoLogManager.undo(dataSourceProxy, xid, branchId);",(0,a.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/4842a0701546824cf2720855d8310a1274c576.jpg",alt:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud Alibaba\u7cfb\u5217\u2014\u201417Seata AT\u6a21\u5f0f\u6e90\u7801\u5206\u6790\uff08\u4e0b\uff09-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"\u5224\u65adundolog\u662f\u5426\u5b58\u5728\uff0c\u5b58\u5728\u5219\u5220\u9664\u5bf9\u5e94undolog\uff0c\u5e76\u4e00\u8d77\u63d0\u4ea4\uff0c\u5230\u6b64seata\u7684AT\u6a21\u5f0f\u6e90\u7801\u89e3\u6790\u5b8c\u6bd5\u3002"]}),"\n",(0,a.jsx)(n.h1,{id:"\u53c2\u8003\u6587\u7ae0",children:"\u53c2\u8003\u6587\u7ae0"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.a,{href:"https://lijunyi.xyz/docs/SpringCloud/SpringCloud.html#_2-2-x-%E5%88%86%E6%94%AF",children:"https://lijunyi.xyz/docs/SpringCloud/SpringCloud.html#_2-2-x-%E5%88%86%E6%94%AF"}),"\n",(0,a.jsx)(n.a,{href:"https://mp.weixin.qq.com/s/2jeovmj77O9Ux96v3A0NtA",children:"https://mp.weixin.qq.com/s/2jeovmj77O9Ux96v3A0NtA"}),"\n",(0,a.jsx)(n.a,{href:"https://juejin.cn/post/6931922457741770760",children:"https://juejin.cn/post/6931922457741770760"}),"\n",(0,a.jsx)(n.a,{href:"https://github.com/D2C-Cai/herring",children:"https://github.com/D2C-Cai/herring"}),"\n",(0,a.jsx)(n.a,{href:"http://c.biancheng.net/springcloud",children:"http://c.biancheng.net/springcloud"}),"\n",(0,a.jsx)(n.a,{href:"https://github.com/macrozheng/springcloud-learning",children:"https://github.com/macrozheng/springcloud-learning"})]})]})}function p(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},88672:(e,n,t)=>{t.d(n,{Z:()=>s,a:()=>i});var a=t(50959);const r={},o=a.createContext(r);function i(e){const n=a.useContext(o);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),a.createElement(o.Provider,{value:n},e.children)}}}]);