"use strict";(self.webpackChunkcode_note_blog=self.webpackChunkcode_note_blog||[]).push([[179],{58954:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>c,contentTitle:()=>s,default:()=>h,frontMatter:()=>r,metadata:()=>o,toc:()=>d});var a=i(11527),t=i(88672);const r={},s=void 0,o={id:"Spring\u5168\u5bb6\u6876/Spring\u6e90\u7801\u5206\u6790/Spring\u542f\u52a8\u6d41\u7a0b/Spring\u542f\u52a8\u6d41\u7a0b\uff08\u4e09\uff09\uff1a\u5305\u7684\u626b\u63cf\u6d41\u7a0b",title:"Spring\u542f\u52a8\u6d41\u7a0b\uff08\u4e09\uff09\uff1a\u5305\u7684\u626b\u63cf\u6d41\u7a0b",description:"\u5728 applicationContext \u7684\u521b\u5efa\u4e2d\uff0c\u6211\u4eec\u5206\u6790\u4e86 applicationContext \u7684\u521b\u5efa\u8fc7\u7a0b\uff0c\u5728\u672c\u6587\u4e2d\uff0c\u6211\u4eec\u5c06\u5206\u6790 spring \u662f\u5982\u4f55\u8fdb\u884c\u5305\u626b\u63cf\u7684\u3002",source:"@site/docs/Spring\u5168\u5bb6\u6876/Spring\u6e90\u7801\u5206\u6790/Spring\u542f\u52a8\u6d41\u7a0b/Spring\u542f\u52a8\u6d41\u7a0b\uff08\u4e09\uff09\uff1a\u5305\u7684\u626b\u63cf\u6d41\u7a0b.md",sourceDirName:"Spring\u5168\u5bb6\u6876/Spring\u6e90\u7801\u5206\u6790/Spring\u542f\u52a8\u6d41\u7a0b",slug:"/Spring\u5168\u5bb6\u6876/Spring\u6e90\u7801\u5206\u6790/Spring\u542f\u52a8\u6d41\u7a0b/Spring\u542f\u52a8\u6d41\u7a0b\uff08\u4e09\uff09\uff1a\u5305\u7684\u626b\u63cf\u6d41\u7a0b",permalink:"/code-note-blog/docs/Spring\u5168\u5bb6\u6876/Spring\u6e90\u7801\u5206\u6790/Spring\u542f\u52a8\u6d41\u7a0b/Spring\u542f\u52a8\u6d41\u7a0b\uff08\u4e09\uff09\uff1a\u5305\u7684\u626b\u63cf\u6d41\u7a0b",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Spring\u5168\u5bb6\u6876/Spring\u6e90\u7801\u5206\u6790/Spring\u542f\u52a8\u6d41\u7a0b/Spring\u542f\u52a8\u6d41\u7a0b\uff08\u4e09\uff09\uff1a\u5305\u7684\u626b\u63cf\u6d41\u7a0b.md",tags:[],version:"current",frontMatter:{},sidebar:"spring",previous:{title:"Spring\u542f\u52a8\u6d41\u7a0b\uff08\u4e03\uff09\uff1a\u56fd\u9645\u5316\u4e0e\u4e8b\u4ef6\u5904\u7406",permalink:"/code-note-blog/docs/Spring\u5168\u5bb6\u6876/Spring\u6e90\u7801\u5206\u6790/Spring\u542f\u52a8\u6d41\u7a0b/Spring\u542f\u52a8\u6d41\u7a0b\uff08\u4e03\uff09\uff1a\u56fd\u9645\u5316\u4e0e\u4e8b\u4ef6\u5904\u7406"},next:{title:"Spring\u542f\u52a8\u6d41\u7a0b\uff08\u5341\uff09\uff1a\u542f\u52a8\u5b8c\u6210\u7684\u5904\u7406",permalink:"/code-note-blog/docs/Spring\u5168\u5bb6\u6876/Spring\u6e90\u7801\u5206\u6790/Spring\u542f\u52a8\u6d41\u7a0b/Spring\u542f\u52a8\u6d41\u7a0b\uff08\u5341\uff09\uff1a\u542f\u52a8\u5b8c\u6210\u7684\u5904\u7406"}},c={},d=[{value:"1. \u6839\u636e\u5305\u8def\u5f84\u5f97\u5230 BeanDefinition",id:"1-\u6839\u636e\u5305\u8def\u5f84\u5f97\u5230-beandefinition",level:3},{value:"1.1 \u6839\u636e basePackage \u5f97\u5230\u5305\u626b\u63cf\u8def\u5f84",id:"11-\u6839\u636e-basepackage-\u5f97\u5230\u5305\u626b\u63cf\u8def\u5f84",level:4},{value:"1.2 \u626b\u63cf\u5305\u8def\u5f84",id:"12-\u626b\u63cf\u5305\u8def\u5f84",level:4},{value:"1.3 \u5c06 Resource \u8f6c\u5316\u4e3a BeanDefinition",id:"13-\u5c06-resource-\u8f6c\u5316\u4e3a-beandefinition",level:4},{value:"1. \u4ece Resource \u5f97\u5230 MetadataReader",id:"1-\u4ece-resource-\u5f97\u5230-metadatareader",level:5},{value:"2. <code>isCandidateComponent(MetadataReader)</code>\uff1a\u5224\u65ad\u662f\u5426\u9700\u8981\u5b9e\u4f8b\u5316\u4e3a spring bean",id:"2-iscandidatecomponentmetadatareader\u5224\u65ad\u662f\u5426\u9700\u8981\u5b9e\u4f8b\u5316\u4e3a-spring-bean",level:5},{value:"3. \u4ece <code>MetadataReader</code> \u5f97\u5230 <code>ScannedGenericBeanDefinition</code>",id:"3-\u4ece-metadatareader-\u5f97\u5230-scannedgenericbeandefinition",level:5},{value:"2. \u4e30\u5bcc beanDefinition \u4fe1\u606f",id:"2-\u4e30\u5bcc-beandefinition-\u4fe1\u606f",level:3},{value:"3.<code> registerBeanDefinition(definitionHolder, this.registry)</code>: \u6dfb\u52a0 BeanDefinition \u5230 beanFactory",id:"3-registerbeandefinitiondefinitionholder-thisregistry-\u6dfb\u52a0-beandefinition-\u5230-beanfactory",level:3},{value:"4. \u603b\u7ed3",id:"4-\u603b\u7ed3",level:3}];function l(n){const e={a:"a",blockquote:"blockquote",code:"code",em:"em",h3:"h3",h4:"h4",h5:"h5",hr:"hr",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.a)(),...n.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(e.p,{children:(0,a.jsx)(e.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-3ed1cf4bd6fc2ef3f569376093a6462987d.png",alt:""})}),"\n",(0,a.jsxs)(e.p,{children:["\u5728 ",(0,a.jsx)(e.a,{href:"https://my.oschina.net/funcy/blog/4608767",children:"applicationContext \u7684\u521b\u5efa"}),"\u4e2d\uff0c\u6211\u4eec\u5206\u6790\u4e86 ",(0,a.jsx)(e.code,{children:"applicationContext"})," \u7684\u521b\u5efa\u8fc7\u7a0b\uff0c\u5728\u672c\u6587\u4e2d\uff0c\u6211\u4eec\u5c06\u5206\u6790 spring \u662f\u5982\u4f55\u8fdb\u884c\u5305\u626b\u63cf\u7684\u3002"]}),"\n",(0,a.jsxs)(e.p,{children:["\u4f9d\u65e7\u662f ",(0,a.jsx)(e.code,{children:"AnnotationConfigApplicationContext"})," \u7684\u6784\u9020\u65b9\u6cd5\uff1a"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"public AnnotationConfigApplicationContext(String... basePackages) {\n    this();\n    //\u5bf9\u4f20\u5165\u7684\u5305\u8fdb\u884c\u626b\u63cf\uff0c\u626b\u63cf\u5b8c\u6210\u540e\uff0c\u4f1a\u5f97\u5230\u4e00\u4e2a BeanDefinition \u7684\u96c6\u5408\n    scan(basePackages);\n    refresh();\n}\n\n"})}),"\n",(0,a.jsxs)(e.p,{children:["\u8fd9\u6b21\u6211\u4eec\u5c06\u76ee\u5149\u653e\u5728 ",(0,a.jsx)(e.code,{children:"scan(basePackages);"})," \u4e0a\uff0c\u8fdb\u5165\u8be5\u65b9\u6cd5\uff1a"]}),"\n",(0,a.jsxs)(e.blockquote,{children:["\n",(0,a.jsx)(e.p,{children:"AnnotationConfigApplicationContext#scan"}),"\n"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:'public void scan(String... basePackages) {\n     Assert.notEmpty(basePackages, "At least one base package must be specified");\n     // \u8fd9\u91cc\u7684scanner\u5bf9\u8c61\u5c31\u662f\u5728this()\u4e2d\u521b\u5efa\u7684\n     this.scanner.scan(basePackages);\n}\n\n'})}),"\n",(0,a.jsxs)(e.p,{children:["\u8fd9\u4e2a\u65b9\u6cd5\u5173\u952e\u4ee3\u7801\u662f ",(0,a.jsx)(e.code,{children:"this.scanner.scan(basePackages);"}),"\uff0c\u8fd9\u4e2a ",(0,a.jsx)(e.code,{children:"scanner"})," \u5c31\u662f\u5728 ",(0,a.jsx)(e.code,{children:"this()"})," \u4e2d\u521b\u5efa\u7684\u5bf9\u8c61\uff1a"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"public AnnotationConfigApplicationContext() {\n    this.reader = new AnnotatedBeanDefinitionReader(this);\n    // scanner \u5c31\u662f\u5728\u8fd9\u91cc\u521b\u5efa\u7684\n    this.scanner = new ClassPathBeanDefinitionScanner(this);\n}\n\n"})}),"\n",(0,a.jsx)(e.p,{children:"\u7ee7\u7eed\u8ffd\u8e2a\uff0c\u8fd9\u91cc\u6211\u4eec\u5bf9\u4e0d\u91cd\u8981\u7684\u65b9\u6cd5\u4ec5\u7ed9\u51fa\u8c03\u7528\u94fe\uff0c\u91cd\u70b9\u5173\u6ce8\u626b\u63cf\u5305\u7684\u8fc7\u7a0b\uff1a"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"AnnotationConfigApplicationContext#AnnotationConfigApplicationContext(String...)\n |-AnnotationConfigApplicationContext#scan\n  |-ClassPathBeanDefinitionScanner#scan\n   |-ClassPathBeanDefinitionScanner#doScan\n\n"})}),"\n",(0,a.jsxs)(e.p,{children:[(0,a.jsx)(e.code,{children:"ClassPathBeanDefinitionScanner#doScan"})," \u4ee3\u7801\u5982\u4e0b\uff1a"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:'protected Set<BeanDefinitionHolder> doScan(String... basePackages) {\n    Assert.notEmpty(basePackages, "At least one base package must be specified");\n    Set<BeanDefinitionHolder> beanDefinitions = new LinkedHashSet<>();\n    //\u904d\u5386\u9700\u8981\u626b\u63cf\u7684\u5305\u8def\u5f84\n    for (String basePackage : basePackages) {\n        //\u83b7\u53d6\u6240\u6709\u7b26\u5408\u6761\u4ef6\u7684BeanDefinition\n        Set<BeanDefinition> candidates = findCandidateComponents(basePackage);\n        for (BeanDefinition candidate : candidates) {\n            //\u7ed1\u5b9aBeanDefinition\u4e0eScope\n            ScopeMetadata scopeMetadata = this.scopeMetadataResolver.resolveScopeMetadata(candidate);\n            candidate.setScope(scopeMetadata.getScopeName());\n            //\u67e5\u770b\u662f\u5426\u914d\u7f6e\u7c7b\u662f\u5426\u6307\u5b9abean\u7684\u540d\u79f0\uff0c\u5982\u6ca1\u6307\u5b9a\u5219\u4f7f\u7528\u7c7b\u540d\u9996\u5b57\u6bcd\u5c0f\u5199\n            String beanName = this.beanNameGenerator.generateBeanName(candidate, this.registry);\n            //\u4e0b\u9762\u4e24\u4e2aif\u662f\u5904\u7406lazy\u3001Autowire\u3001DependencyOn\u3001initMethod\u3001enforceInitMethod\u3001destroyMethod\u3001\n            // enforceDestroyMethod\u3001Primary\u3001Role\u3001Description\u8fd9\u4e9b\u903b\u8f91\u7684\n            if (candidate instanceof AbstractBeanDefinition) {\n                postProcessBeanDefinition((AbstractBeanDefinition) candidate, beanName);\n            }\n            if (candidate instanceof AnnotatedBeanDefinition) {\n                AnnotationConfigUtils.processCommonDefinitionAnnotations(\n                        (AnnotatedBeanDefinition) candidate);\n            }\n            //\u68c0\u67e5bean\u662f\u5426\u5b58\u5728\n            if (checkCandidate(beanName, candidate)) {\n                //\u53c8\u5305\u88c5\u4e86\u4e00\u5c42\n                BeanDefinitionHolder definitionHolder = new BeanDefinitionHolder(candidate, beanName);\n                //\u68c0\u67e5scope\u662f\u5426\u521b\u5efa\uff0c\u5982\u672a\u521b\u5efa\u5219\u8fdb\u884c\u521b\u5efa\n                definitionHolder = AnnotationConfigUtils.applyScopedProxyMode(\n                        scopeMetadata, definitionHolder, this.registry);\n                beanDefinitions.add(definitionHolder);\n                //\u6ce8\u518c beanDefinition\n                registerBeanDefinition(definitionHolder, this.registry);\n            }\n        }\n    }\n    return beanDefinitions;\n}\n\n'})}),"\n",(0,a.jsx)(e.p,{children:"\u8fd9\u6bb5\u4ee3\u7801\u5b8c\u6210\u7684\u529f\u80fd\u5f88\u660e\u4e86\uff0c\u5927\u4f53\u4e0a\u505a\u4e86\u4ee5\u4e0b\u51e0\u4ef6\u4e8b\uff1a"}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsx)(e.li,{children:"\u6839\u636e\u5305\u8def\u5f84\uff0c\u5f97\u5230\u7b26\u5408\u6761\u4ef6\u7684 BeanDefinition"}),"\n",(0,a.jsx)(e.li,{children:"\u904d\u5386 BeanDefinition\uff0c\u8fdb\u4e00\u6b65\u4e30\u5bcc beanDefinition \u4fe1\u606f"}),"\n",(0,a.jsx)(e.li,{children:"\u5c06 BeanDefinition \u6dfb\u52a0\u5230 beanFactory"}),"\n"]}),"\n",(0,a.jsxs)(e.blockquote,{children:["\n",(0,a.jsxs)(e.p,{children:["BeanDefinition \u4e5f\u662f spring \u7684\u91cd\u8981\u7ec4\u4ef6\u4e4b\u4e00\uff0c\u5173\u4e8e BeanDefinition \u7684\u5206\u6790\uff0c\u53ef\u53c2\u8003 ",(0,a.jsx)(e.a,{href:"https://my.oschina.net/funcy/blog/4597536",title:"spring\u7ec4\u4ef6\u4e4bBeanDefinition",children:"spring \u7ec4\u4ef6\u4e4b BeanDefinition"}),"\u3002"]}),"\n"]}),"\n",(0,a.jsx)(e.p,{children:"\u63a5\u4e0b\u6765\u6211\u4eec\u4e3b\u8981\u5206\u6790\u8fd9\u4e09\u4e2a\u7684\u64cd\u4f5c\u3002"}),"\n",(0,a.jsx)(e.h3,{id:"1-\u6839\u636e\u5305\u8def\u5f84\u5f97\u5230-beandefinition",children:"1. \u6839\u636e\u5305\u8def\u5f84\u5f97\u5230 BeanDefinition"}),"\n",(0,a.jsxs)(e.p,{children:["\u8fd9\u4e00\u6b65\u4e3b\u8981\u53d1\u751f\u5728 ",(0,a.jsx)(e.code,{children:"Set<BeanDefinition> candidates = findCandidateComponents(basePackage);"}),"\uff0c\u6211\u4eec\u8ddf\u8fdb\u53bb\u770b\u770b\u4ee3\u7801\u7684\u6267\u884c\uff0c\u8fd9\u91cc\u4f9d\u65e7\u5bf9\u4e0d\u91cd\u8981\u4ee3\u7801\u7ed9\u51fa\u8c03\u7528\u94fe\uff0c\u8be5\u65b9\u6cd5\u7684\u8c03\u7528\u5982\u4e0b\uff1a"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"AnnotationConfigApplicationContext#AnnotationConfigApplicationContext(String...)\n |-AnnotationConfigApplicationContext#scan\n  |-ClassPathBeanDefinitionScanner#scan\n   |-ClassPathBeanDefinitionScanner#doScan\n    |-ClassPathScanningCandidateComponentProvider#findCandidateComponents\n     |-ClassPathScanningCandidateComponentProvider#scanCandidateComponents\n\n"})}),"\n",(0,a.jsxs)(e.p,{children:["\u6700\u7ec8\u8c03\u7528\u5230\u4e86 ",(0,a.jsx)(e.code,{children:"ClassPathScanningCandidateComponentProvider#scanCandidateComponents"}),"\uff0c\u4ee3\u7801\u5982\u4e0b (\u6709\u5220\u51cf)\uff1a"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"private Set<BeanDefinition> scanCandidateComponents(String basePackage) {\n    Set<BeanDefinition> candidates = new LinkedHashSet<>();\n    //\u7ec4\u88c5\u626b\u63cf\u8def\u5f84\uff08\u7ec4\u88c5\u5b8c\u6210\u540e\u662f\u8fd9\u79cd\u683c\u5f0f\uff1aclasspath*:org/springframework/learn/demo01/**/*.class\uff09\n    String packageSearchPath = ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX +\n            resolveBasePackage(basePackage) + '/' + this.resourcePattern;\n    //\u6839\u636e\u8def\u5f84\u83b7\u53d6\u8d44\u6e90\u5bf9\u8c61\uff0c\u5373\u626b\u63cf\u51fa\u8be5\u8def\u5f84\u4e0b\u7684\u7684\u6240\u6709class\u6587\u4ef6\uff0c\u5f97\u5230 Resource\n    Resource[] resources = getResourcePatternResolver().getResources(packageSearchPath);\n    for (Resource resource : resources) {\n        if (resource.isReadable()) {\n            //\u6839\u636e\u8d44\u6e90\u5bf9\u8c61\u83b7\u53d6\u8d44\u6e90\u5bf9\u8c61\u7684MetadataReader\n            MetadataReader metadataReader = getMetadataReaderFactory().getMetadataReader(resource);\n            // \u8fd9\u91cc\u505a\u4e86\u4e24\u4ef6\u4e8b\uff1a\n            // 1\\. \u662f\u5426\u9700\u8981\u521d\u59cb\u5316\u4e3aspring bean\uff0c\u5373\u662f\u5426\u6709 @Component\u3001@Service\u7b49\u6ce8\u89e3\n            // 2\\. \u67e5\u770b\u914d\u7f6e\u7c7b\u662f\u5426\u6709@Conditional\u4e00\u7cfb\u5217\u7684\u6ce8\u89e3\uff0c\u7136\u540e\u662f\u5426\u6ee1\u8db3\u6ce8\u518cBean\u7684\u6761\u4ef6\n            if (isCandidateComponent(metadataReader)) {\n                ScannedGenericBeanDefinition sbd = new ScannedGenericBeanDefinition(metadataReader);\n                sbd.setResource(resource);\n                sbd.setSource(resource);\n                if (isCandidateComponent(sbd)) {\n                    candidates.add(sbd);\n                }\n            }\n        }\n    }\n    return candidates;\n}\n\n"})}),"\n",(0,a.jsx)(e.p,{children:"\u53ef\u4ee5\u770b\u5230\uff0c\u4ee5\u4e0a\u4ee3\u7801\u505a\u4e86\u4e09\u4ef6\u4e8b\uff1a"}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsx)(e.li,{children:"\u6839\u636e\u4f20\u5165\u7684 basePackage \u5f97\u5230\u626b\u63cf\u8def\u5f84"}),"\n",(0,a.jsx)(e.li,{children:"\u6839\u636e\u626b\u63cf\u8def\u5f84\u5f97\u5230\u8be5\u8def\u5f84\u4e0b\u7684\u6240\u6709 class \u6587\u4ef6\u5bf9\u5e94\u7684 Resource"}),"\n",(0,a.jsx)(e.li,{children:"\u5c06 Resource \u8f6c\u5316\u4e3a beanDefinition"}),"\n"]}),"\n",(0,a.jsx)(e.p,{children:"\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u4ee5\u4e0a\u4ee3\u7801\u8fdb\u884c\u5206\u6790\u3002"}),"\n",(0,a.jsx)(e.h4,{id:"11-\u6839\u636e-basepackage-\u5f97\u5230\u5305\u626b\u63cf\u8def\u5f84",children:"1.1 \u6839\u636e basePackage \u5f97\u5230\u5305\u626b\u63cf\u8def\u5f84"}),"\n",(0,a.jsxs)(e.p,{children:["\u8fd9\u4e00\u6b65\u6ca1\u5565\u597d\u5206\u6790\uff0c\u5c31\u662f\u4e00\u4e2a\u5b57\u7b26\u4e32\u7684\u62fc\u63a5\u4e0e\u66ff\u6362\uff0c\u5c06\u4f20\u5165\u7684 ",(0,a.jsx)(e.code,{children:"org.springframework.learn.demo01"})," \u8f6c\u6362\u4e3a ",(0,a.jsx)(e.code,{children:"classpath*:org/springframework/learn/demo01/**/*.class"}),"\uff0c\u76f8\u5173\u4ee3\u7801\u5c31\u4e00\u884c\uff1a"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"String packageSearchPath = ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX +\n        resolveBasePackage(basePackage) + '/' + this.resourcePattern;\n\n"})}),"\n",(0,a.jsx)(e.h4,{id:"12-\u626b\u63cf\u5305\u8def\u5f84",children:"1.2 \u626b\u63cf\u5305\u8def\u5f84"}),"\n",(0,a.jsxs)(e.p,{children:["\u5f97\u5230\u5305\u626b\u63cf\u8def\u5f84\u540e\uff0c\u63a5\u4e0b\u6765\u5c31\u662f\u8fdb\u884c\u626b\u63cf\u4e86\u3002spring \u5728\u626b\u63cf\u65f6\uff0c\u4f1a\u628a\u626b\u63cf\u8def\u5f84\u4e0b\u7684\u6240\u6709 class \u6587\u4ef6\u626b\u63cf\u51fa\u6765\uff0c\u7136\u540e\u5c01\u88c5\u6210 ",(0,a.jsx)(e.code,{children:"Resource"}),"\uff0c\u4ee3\u7801\u5982\u4e0b"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"Resource[] resources = getResourcePatternResolver().getResources(packageSearchPath);\n\n"})}),"\n",(0,a.jsx)(e.p,{children:"\u8ddf\u8fdb\u4ee3\u7801\uff0c\u540c\u6837\u5730\uff0c\u6211\u4eec\u5bf9\u4e0d\u91cd\u8981\u7684\u65b9\u6cd5\uff0c\u4f9d\u65e7\u53ea\u7ed9\u51fa\u65b9\u6cd5\u8c03\u7528\uff1a"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"AnnotationConfigApplicationContext#AnnotationConfigApplicationContext(String...)\n |-AnnotationConfigApplicationContext#scan\n  |-ClassPathBeanDefinitionScanner#scan\n   |-ClassPathBeanDefinitionScanner#doScan\n    |-ClassPathScanningCandidateComponentProvider#findCandidateComponents\n     |-ClassPathScanningCandidateComponentProvider#scanCandidateComponents\n      |- GenericApplicationContext#getResources\n       |-AbstractApplicationContext#getResources\n        |-PathMatchingResourcePatternResolver#getResources\n         |-PathMatchingResourcePatternResolver#findPathMatchingResources\n\n"})}),"\n",(0,a.jsxs)(e.p,{children:["\u6211\u4eec\u5c06\u4ee3\u7801\u805a\u96c6\u4e8e ",(0,a.jsx)(e.code,{children:"PathMatchingResourcePatternResolver#findPathMatchingResources"}),":"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:'protected Resource[] findPathMatchingResources(String locationPattern) throws IOException {\n    // \u4f20\u5165\u7684 locationPattern \u662f classpath*:org/springframework/learn/demo01/**/*.class\n    // rootDirPath \u662f classpath*:org/springframework/learn/demo01/\n    String rootDirPath = determineRootDir(locationPattern);\n\n    // subPattern \u662f **/*.class\n    String subPattern = locationPattern.substring(rootDirPath.length());\n\n    // \u8fd9\u91cc\u8fd4\u56de\u7684 Resource \u662f rootDirPath \u7684\u7edd\u5bf9\u8def\u5f84(\u7528url\u8868\u793a)\n    // URL [file:/xxx/spring-learn/build/classes/java/main/org/springframework/learn/demo01/]\n    Resource[] rootDirResources = getResources(rootDirPath);\n\n    Set<Resource> result = new LinkedHashSet<>(16);\n    for (Resource rootDirResource : rootDirResources) {\n        rootDirResource = resolveRootDirResource(rootDirResource);\n        URL rootDirUrl = rootDirResource.getURL();\n        if (equinoxResolveMethod != null && rootDirUrl.getProtocol().startsWith("bundle")) {\n            URL resolvedUrl = (URL) ReflectionUtils.invokeMethod(equinoxResolveMethod, null, rootDirUrl);\n            if (resolvedUrl != null) {\n                rootDirUrl = resolvedUrl;\n            }\n            rootDirResource = new UrlResource(rootDirUrl);\n        }\n        // \u5904\u7406 vfs \u8d44\u6e90\u67e5\u627e\n        if (rootDirUrl.getProtocol().startsWith(ResourceUtils.URL_PROTOCOL_VFS)) {\n            result.addAll(VfsResourceMatchingDelegate\n                    .findMatchingResources(rootDirUrl, subPattern, getPathMatcher()));\n        }\n        // \u5904\u7406jar\u5305\u6587\u4ef6\u67e5\u627e\n        else if (ResourceUtils.isJarURL(rootDirUrl) || isJarResource(rootDirResource)) {\n            result.addAll(doFindPathMatchingJarResources(rootDirResource, rootDirUrl, subPattern));\n        }\n        // \u5904\u7406\u6587\u4ef6\u8def\u5f84\u4e0b\u7684\u6587\u4ef6\u67e5\u627e\n        else {\n            result.addAll(doFindPathMatchingFileResources(rootDirResource, subPattern));\n        }\n    }\n    return result.toArray(new Resource[0]);\n}\n\n'})}),"\n",(0,a.jsx)(e.p,{children:"\u901a\u8fc7\u5206\u6790\uff0c\u53d1\u73b0\u8be5\u7c7b\u7684\u5904\u7406\u8fc7\u7a0b\u5982\u4e0b\uff1a"}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsx)(e.li,{children:"\u901a\u8fc7\u4f20\u5165\u7684 locationPattern \u5f97\u5230\u8be5 pattern \u4e0b\u7684 url \u7edd\u5bf9\u8def\u5f84\uff0c\u5c01\u88c5\u4e3a Resource"}),"\n",(0,a.jsx)(e.li,{children:"\u904d\u5386\u8fd4\u56de\u7684\u8def\u5f84\uff0c\u67e5\u627e class \u6587\u4ef6\uff0c\u5c01\u88c5\u4e3a Resource"}),"\n"]}),"\n",(0,a.jsx)(e.p,{children:"\u6211\u4eec\u6765\u770b\u770b spring \u662f\u5982\u4f55\u5c06 pattrn \u8f6c\u6362\u4e3a url \u8def\u5f84\u7684\uff0c\u6211\u4eec\u8ddf\u8fdb\u4ee3\u7801\uff1a"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"|-PathMatchingResourcePatternResolver#getResources\n |-PathMatchingResourcePatternResolver#findAllClassPathResources\n  |-PathMatchingResourcePatternResolver#doFindAllClassPathResources\n\n"})}),"\n",(0,a.jsxs)(e.p,{children:["\u6700\u7ec8\u4ee3\u7801\u5230\u4e86 ",(0,a.jsx)(e.code,{children:"PathMatchingResourcePatternResolver#doFindAllClassPathResources"}),":"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:'protected Set<Resource> doFindAllClassPathResources(String path) throws IOException {\n    Set<Resource> result = new LinkedHashSet<>(16);\n    ClassLoader cl = getClassLoader();\n    // path\u5bf9\u5e94\u7684url\n    Enumeration<URL> resourceUrls = (cl != null ? cl.getResources(path) : \n            ClassLoader.getSystemResources(path));\n    while (resourceUrls.hasMoreElements()) {\n        URL url = resourceUrls.nextElement();\n        // \u5c06url\u8f6c\u6362\u4e3aResource\uff0c\u5e76\u6dfb\u52a0\u5230\u7ed3\u679c\u4e2d\n        result.add(convertClassLoaderURL(url));\n    }\n    if ("".equals(path)) {\n        addAllClassLoaderJarRoots(cl, result);\n    }\n    return result;\n}\n\n// \u5c06url\u8f6c\u6362\u4e3aResource\nprotected Resource convertClassLoaderURL(URL url) {\n    return new UrlResource(url);\n}\n\n'})}),"\n",(0,a.jsxs)(e.p,{children:["\u6b64\u65f6\u4f20\u5165\u7684 ",(0,a.jsx)(e.code,{children:"path"})," \u4e3a ",(0,a.jsx)(e.code,{children:"org/springframework/learn/demo01/"}),"\uff0c\u4ece\u4ee3\u7801\u53ef\u77e5\uff0c\u6700\u7ec8\u8c03\u7528\u4e86 java \u7684 ",(0,a.jsx)(e.code,{children:"ClassLoader"})," \u65b9\u6cd5\u6765\u83b7\u53d6 path \u5bf9\u5e94\u7684 url\uff0c\u7136\u540e\u5c06 url \u8f6c\u6362\u4e3a ",(0,a.jsx)(e.code,{children:"Resource"})," \u6dfb\u52a0\u5230\u7ed3\u679c\u96c6\u4e2d\u5e76\u8fd4\u56de\u3002"]}),"\n",(0,a.jsxs)(e.p,{children:["\u62ff\u5230\u7c7b\u7684\u7edd\u5bf9\u8def\u5f84\u4e4b\u540e\uff0c\u63a5\u4e0b\u5c31\u662f\u5bf9\u8def\u5f84\u8fdb\u884c\u904d\u5386\uff0c\u62ff\u5230 class \u6587\u4ef6\u4e86\u3002\u8ba9\u6211\u4eec\u518d\u56de\u5230 ",(0,a.jsx)(e.code,{children:"PathMatchingResourcePatternResolver#findPathMatchingResources"}),"\uff0cspring \u626b\u63cf\u65f6\uff0c\u4f1a\u6839\u636e\u4f20\u5165\u7684 url \u7c7b\u578b\uff0c\u5171\u626b\u63cf 3 \u4e2a\u5730\u65b9\uff1a"]}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsx)(e.li,{children:"vfs"}),"\n",(0,a.jsx)(e.li,{children:"jar \u5305"}),"\n",(0,a.jsx)(e.li,{children:"\u6587\u4ef6\u8def\u5f84"}),"\n"]}),"\n",(0,a.jsxs)(e.p,{children:[(0,a.jsx)(e.code,{children:"vfs"}),' \u6ce8\u91ca\u4e0a\u8bf4\u662f "URL protocol for a general JBoss VFS resource"\uff0c\u5373\u901a\u7528 JBoss VFS \u8d44\u6e90\u7684 URL \u534f\u8bae\uff0c\u8fd9\u91cc\u4e0d\u6df1\u7a76\u3002\u5982\u679c\u9879\u76ee\u4e2d\u5f15\u5165\u4e86 jar \u5305\u4e14\u9700\u8981\u626b\u63cf jar \u4e2d\u7684\u8def\u5f84\uff0c\u5c31\u4f1a\u4f7f\u7528 jar \u5305\u626b\u63cf\u65b9\u5f0f\u8fdb\u884c class \u6587\u4ef6\u67e5\u627e\uff0c\u7531\u4e8e\u8c03\u8bd5\u65f6\uff0c',(0,a.jsx)(e.code,{children:"demo01"})," \u662f\u4f7f\u7528\u6587\u4ef6\u65b9\u5f0f\u626b\u63cf\u7684\uff0c\u8fd9\u91cc\u5c31\u91cd\u70b9\u5206\u6790\u6587\u4ef6\u626b\u63cf\u65b9\u5f0f\uff0c\u81f3\u4e8e jar \u662f\u5982\u4f55\u626b\u63cf\u7684\uff0c\u6709\u5174\u8da3\u7684\u5c0f\u4f19\u4f34\u53ef\u81ea\u884c\u7814\u7a76\u4e0b\u3002"]}),"\n",(0,a.jsxs)(e.p,{children:["\u6211\u4eec\u8ddf\u8fdb ",(0,a.jsx)(e.code,{children:"findPathMatchingResources"})," \u65b9\u6cd5\uff1a"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"|-PathMatchingResourcePatternResolver#findPathMatchingResources\n |-PathMatchingResourcePatternResolver#doFindPathMatchingFileResources\n  |-PathMatchingResourcePatternResolver#doFindMatchingFileSystemResources\n\n"})}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"protected Set<Resource> doFindMatchingFileSystemResources(File rootDir, \n            String subPattern) throws IOException {\n    // \u8fd9\u91cc\u8fdb\u884c\u6587\u4ef6\u67e5\u627e\n    Set<File> matchingFiles = retrieveMatchingFiles(rootDir, subPattern);\n    Set<Resource> result = new LinkedHashSet<>(matchingFiles.size());\n    for (File file : matchingFiles) {\n        result.add(new FileSystemResource(file));\n    }\n    return result;\n}\n\n"})}),"\n",(0,a.jsxs)(e.p,{children:["\u5728 ",(0,a.jsx)(e.code,{children:"PathMatchingResourcePatternResolver#doFindMatchingFileSystemResources"})," \u4e2d\uff0cspring \u5c06\u626b\u63cf\u5230\u7684 File \u8f6c\u6362\u4e3a ",(0,a.jsx)(e.code,{children:"FileSystemResource"})," \u4fdd\u5b58\uff0c\u8fd9\u662f\u6211\u4eec\u9047\u5230\u7684\u7b2c\u4e8c\u4e2a ",(0,a.jsx)(e.code,{children:"Resource"})," \u7c7b\u578b\u4e86 (\u524d\u9762\u4e3a ",(0,a.jsx)(e.code,{children:"UrlResource"}),"\uff0c\u8fd9\u91cc\u4e3a ",(0,a.jsx)(e.code,{children:"FileSystemResource"}),")."]}),"\n",(0,a.jsxs)(e.p,{children:["\u63a5\u4e0b\u6211\u4eec\u91cd\u70b9\u5173\u6ce8 ",(0,a.jsx)(e.code,{children:"Set<File> matchingFiles = retrieveMatchingFiles(rootDir, subPattern);"}),"\uff0c\u770b\u770b spring \u662f\u5982\u4f55\u5b8c\u6210\u6587\u4ef6\u67e5\u627e\u7684\uff1a"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"|-PathMatchingResourcePatternResolver#findPathMatchingResources\n |-PathMatchingResourcePatternResolver#doFindPathMatchingFileResources\n  |-PathMatchingResourcePatternResolver#doFindMatchingFileSystemResources\n   |-PathMatchingResourcePatternResolver#retrieveMatchingFiles\n    |-PathMatchingResourcePatternResolver#doRetrieveMatchingFiles\n\n"})}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:'protected void doRetrieveMatchingFiles(String fullPattern, File dir, Set<File> result) \n        throws IOException {\n    for (File content : listDirectory(dir)) {\n        String currPath = StringUtils.replace(content.getAbsolutePath(), File.separator, "/");\n        if (content.isDirectory() && getPathMatcher().matchStart(fullPattern, currPath + "/")) {\n            if (!content.canRead()) {\n            }\n            else {\n                // \u5982\u679c\u662f\u6587\u4ef6\u5939\uff0c\u9012\u5f52\u8c03\u7528\n                doRetrieveMatchingFiles(fullPattern, content, result);\n            }\n        }\n        // \u5982\u679c\u662f\u6587\u4ef6\u4e14\u6587\u4ef6\u8def\u5f84\n        if (getPathMatcher().match(fullPattern, currPath)) {\n            result.add(content);\n        }\n    }\n}\n\n'})}),"\n",(0,a.jsx)(e.p,{children:"\u4ee5\u4e0a\u4ee3\u7801\u6bd4\u8f83\u7b80\u5355\uff0c\u4e0e\u6211\u4eec\u5e73\u5e38\u904d\u5386\u6587\u4ef6\u7684\u65b9\u5f0f\u662f\u4e00\u6837\u7684\u3002"}),"\n",(0,a.jsxs)(e.p,{children:["\u503c\u5f97\u4e00\u63d0\u7684\u662f\uff0c",(0,a.jsx)(e.code,{children:"getPathMatcher().match(fullPattern, currPath)"})," \u6700\u7ec8\u8c03\u7528\u5230\u7684\u662f ",(0,a.jsx)(e.code,{children:"AntPathMatcher#doMatch"}),"\uff0c\u8fd9\u662f\u4e00\u4e2a ant \u98ce\u683c\u7684\u8def\u5f84\u5339\u914d\u9a8c\u8bc1\uff0c\u5373\u8def\u5f84\u4e2d\u5e26\u6709 ",(0,a.jsx)(e.code,{children:"*"}),"\uff0c\u5982\u4f20\u5165\u7684 pattern \u662f ",(0,a.jsx)(e.code,{children:"/xxx/spring-framework/spring-learn/build/classes/java/main/org/springframework/learn/demo01/**/*.class"}),"\uff0c\u8868\u793a\u5339\u914d ",(0,a.jsx)(e.code,{children:"/xxx/spring-framework/spring-learn/build/classes/java/main/org/springframework/learn/demo01/"})," \u53ca\u5176\u5b50\u6587\u4ef6\u5939\u4e0b\u6240\u6709\u4ee5",(0,a.jsx)(e.code,{children:".class"})," \u6587\u4ef6\u7ed3\u5c3e\u7684\u6587\u4ef6\uff0c\u5f53\u524d\u4f20\u5165\u7684 path \u662f ",(0,a.jsx)(e.code,{children:"/xxx/spring-framework/spring-learn/build/classes/java/main/org/springframework/learn/demo01/BeanObj2.class"}),"\uff0c\u663e\u7136\u5339\u914d\u3002\u5173\u4e8e ",(0,a.jsx)(e.code,{children:"AntPathMatcher#doMatch"})," \u65b9\u6cd5\u662f\u5982\u4f55\u8fdb\u884c\u5339\u914d\u7684\uff0c\u8fd9\u91cc\u5c31\u4e0d\u8fdb\u884c\u5c55\u5f00\u4e86\u3002"]}),"\n",(0,a.jsx)(e.p,{children:"\u7ecf\u8fc7\u4e86\u4ee5\u4e0a\u6b65\u9aa4\uff0c\u6211\u4eec\u7ec8\u4e8e\u5f97\u5230\u4e86 class \u6587\u4ef6\u5bf9\u5e94\u7684 Resource \u4e86."}),"\n",(0,a.jsx)(e.h4,{id:"13-\u5c06-resource-\u8f6c\u5316\u4e3a-beandefinition",children:"1.3 \u5c06 Resource \u8f6c\u5316\u4e3a BeanDefinition"}),"\n",(0,a.jsx)(e.p,{children:"\u5c06 Resource \u8f6c\u5316\u4e3a BeanDefinition\uff0c\u4ee3\u7801\u662f"}),"\n",(0,a.jsxs)(e.blockquote,{children:["\n",(0,a.jsx)(e.p,{children:"ClassPathScanningCandidateComponentProvider#scanCandidateComponents"}),"\n"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"// \u4ece resource \u5f97\u5230 MetadataReader\nMetadataReader metadataReader = getMetadataReaderFactory().getMetadataReader(resource);\n\n// \u8fd9\u91cc\u505a\u4e86\u4e24\u4ef6\u4e8b\uff1a\n// 1\\. \u662f\u5426\u9700\u8981\u521d\u59cb\u5316\u4e3aspring bean\uff0c\u5373\u662f\u5426\u6709 @Component\u3001@Service\u7b49\u6ce8\u89e3\n// 2\\. \u67e5\u770b\u914d\u7f6e\u7c7b\u662f\u5426\u6709@Conditional\u4e00\u7cfb\u5217\u7684\u6ce8\u89e3\uff0c\u7136\u540e\u662f\u5426\u6ee1\u8db3\u6ce8\u518cBean\u7684\u6761\u4ef6\nif (isCandidateComponent(metadataReader)) {\n    // \u5c06 metadataReader \u8f6c\u6362\u4e3a ScannedGenericBeanDefinition\uff0c\u8fd9\u4e5f\u662fBeanDefinition\u5bb6\u65cf\u4e2d\u7684\u4e00\u5458\n    ScannedGenericBeanDefinition sbd = new ScannedGenericBeanDefinition(metadataReader);\n    ...\n}\n\n"})}),"\n",(0,a.jsx)(e.h5,{id:"1-\u4ece-resource-\u5f97\u5230-metadatareader",children:"1. \u4ece Resource \u5f97\u5230 MetadataReader"}),"\n",(0,a.jsxs)(e.p,{children:["\u6211\u4eec\u8ffd\u8e2a\u4e0b ",(0,a.jsx)(e.code,{children:"MetadataReader"})," \u7684\u83b7\u53d6\uff1a"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"|-ClassPathScanningCandidateComponentProvider#scanCandidateComponents\n |-CachingMetadataReaderFactory#getMetadataReader\n  |-SimpleMetadataReaderFactory#getMetadataReader(Resource)\n   |-SimpleMetadataReader#SimpleMetadataReader\n\n"})}),"\n",(0,a.jsxs)(e.p,{children:["\u4ee3\u7801\u6700\u7ec8\u8fd0\u884c\u5230\u4e86 ",(0,a.jsx)(e.code,{children:"SimpleMetadataReader"})," \u7684\u6784\u9020\u65b9\u6cd5:"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"SimpleMetadataReader(Resource resource, @Nullable ClassLoader classLoader) throws IOException {\n    SimpleAnnotationMetadataReadingVisitor visitor \n        = new SimpleAnnotationMetadataReadingVisitor(classLoader);\n    // \u8fd9\u91cc\u53d1\u751f\u4e86class\u6587\u4ef6\u7684\u8bfb\u53d6\u4e0e\u89e3\u6790\n    getClassReader(resource).accept(visitor, PARSING_OPTIONS);\n    this.resource = resource;\n    this.annotationMetadata = visitor.getMetadata();\n}\n\n"})}),"\n",(0,a.jsxs)(e.p,{children:["\u518d\u8fdb\u4e00\u6b65\u8ffd\u8e2a\uff0c\u53d1\u73b0 class \u6587\u4ef6\u7684\u8bfb\u53d6\u4e0e\u89e3\u6790\u53d1\u751f\u5728 ",(0,a.jsx)(e.code,{children:"ClassReader"})," \u7c7b\uff1a"]}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)(e.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-595687d3a766ffaacf69f31216a5b09f9d5.png",alt:""})}),"\n",(0,a.jsx)(e.p,{children:"\u8fd9\u4e2a\u7c7b\u4f7f\u7528 asm \u6765\u8bfb\u53d6 class \u6587\u4ef6\uff0c\u4ee3\u7801\u6bd4\u8f83\u590d\u6742\uff0c\u5c31\u4e0d\u6df1\u7a76\u4e86\u3002"}),"\n",(0,a.jsxs)(e.p,{children:["\u4e00\u76f4\u4ee5\u6765\uff0c\u6211\u90fd\u4ee5\u4e3a spring \u662f\u901a\u8fc7\u53cd\u5c04\u6765\u83b7\u53d6\u7c7b\u4fe1\u606f\u7684\uff0c\u5230\u8fd9\u91cc\u624d\u77e5\u9053\uff0c",(0,a.jsx)(e.strong,{children:"\u539f\u6765 spring \u662f\u901a\u8fc7 asm \u76f4\u63a5\u8bfb\u53d6 class \u6587\u4ef6\u6765\u83b7\u53d6\u7c7b\u7684\u4fe1\u606f\u7684"})," \u3002"]}),"\n",(0,a.jsxs)(e.p,{children:["\u6700\u540e\u6211\u4eec\u6765\u770b\u4e0b\u5f97\u5230\u7684 ",(0,a.jsx)(e.code,{children:"MetadataReader"})," \u7684\u7ed3\u679c\uff1a"]}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)(e.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-9df07587a3a8191231da87fe21d80052357.png",alt:""})}),"\n",(0,a.jsxs)(e.p,{children:["\u8fd9\u91cc\u91cd\u70b9\u5173\u6ce8 ",(0,a.jsx)(e.code,{children:"annotations"})," \u5c5e\u6027\uff0c\u91cc\u9762\u6709\u4e00\u4e2a ",(0,a.jsx)(e.code,{children:"annotations"})," \u548c ",(0,a.jsx)(e.code,{children:"mappings"}),"\uff0c",(0,a.jsx)(e.code,{children:"annotations"})," \u5185\u5bb9\u4e3a ",(0,a.jsx)(e.code,{children:"@Service"}),"\uff0c",(0,a.jsx)(e.code,{children:"mappings"})," \u662f\u4e00\u4e2a\u6570\u7ec4\uff0c\u5185\u5bb9\u4e3a"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"0-@Service\n1-@Component\n2-@Index\n\n"})}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)(e.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-f5c7e8768b92b7a4303c4e1beb58863fe03.png",alt:""})}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)(e.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-38b493e0b4b7b73dda5f06f371b66f16d3e.png",alt:""})}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)(e.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-930a4e6844efd3f9f52c6d3f4e13a200337.png",alt:""})}),"\n",(0,a.jsxs)(e.p,{children:[(0,a.jsx)(e.code,{children:"annotations"})," \u672c\u4eba\u731c\u6d4b\u662f ",(0,a.jsx)(e.code,{children:"BeanObj1"})," \u4e0a\u7684\u6ce8\u89e3\uff1a"]}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)(e.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-77271c438dde39f2bc905aa9f2cf9fb73d8.png",alt:""})}),"\n",(0,a.jsxs)(e.p,{children:["\u81f3\u4e8e ",(0,a.jsx)(e.code,{children:"mappings"})," \u662f\u5565\uff0c\u6211\u4e0d\u597d\u731c\u6d4b\uff0c\u4e0d\u8fc7\u4e5f\u53ef\u4ee5\u4ece\u6ce8\u89e3\u4e2d\u53d1\u73b0\u4e00\u4e9b\u7aef\u502a\uff1a"]}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)(e.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-f31efb6252beb2108dc0ce93d482666f8d0.png",alt:""})}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)(e.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-a8ce5d11b4b02907f0ff497c6369a1c1dde.png",alt:""})}),"\n",(0,a.jsxs)(e.p,{children:[(0,a.jsx)(e.code,{children:"@Service"})," \u4e0a\u6709 ",(0,a.jsx)(e.code,{children:"@Component"})," \u6ce8\u89e3\uff0c",(0,a.jsx)(e.code,{children:"@Component"})," \u4e0a\u6709 ",(0,a.jsx)(e.code,{children:"@Indexed"}),"\uff0c\u800c\u8fd9\u4e09\u8005\u90fd\u51fa\u73b0\u5728\u4e86 ",(0,a.jsx)(e.code,{children:"mappings"})," \u4e2d\uff0c\u8fd9\u770b\u7740\u50cf\u662f\u4e13\u95e8\u7528\u6765\u4fdd\u5b58\u62ff\u6ce8\u89e3\u4e4b\u4e0a\u7684\u6ce8\u89e3\u7684\uff1f\u4e0d\u7ea0\u7ed3\u8fd9\u4e2a\u4e86\uff0c\u6682\u4e14\u5c31\u5f53\u4f5c\u662f\u8fd9\u529f\u80fd\u5427\uff01",(0,a.jsxs)(e.strong,{children:["\u6ce8\u610f\uff1a",(0,a.jsx)(e.code,{children:"mappings"})," \u91cc\u9762\u7684\u5185\u5bb9\u5f88\u91cd\u8981\uff0c\u540e\u9762\u4f1a\u7528\u6765\uff01"]})]}),"\n",(0,a.jsxs)(e.h5,{id:"2-iscandidatecomponentmetadatareader\u5224\u65ad\u662f\u5426\u9700\u8981\u5b9e\u4f8b\u5316\u4e3a-spring-bean",children:["2. ",(0,a.jsx)(e.code,{children:"isCandidateComponent(MetadataReader)"}),"\uff1a\u5224\u65ad\u662f\u5426\u9700\u8981\u5b9e\u4f8b\u5316\u4e3a spring bean"]}),"\n",(0,a.jsxs)(e.p,{children:["\u5728\u4e0a\u4e00\u6b65\u4e2d\uff0c\u6211\u4eec\u5f97\u5230\u4e86 basePackage \u4e0b",(0,a.jsx)(e.strong,{children:"\u6240\u6709\u7c7b"}),"\u7684 ",(0,a.jsx)(e.code,{children:"MetadataReader"})," \u63cf\u8ff0\u6587\u4ef6\uff0c\u6ce8\u610f\u8fd9\u91cc\u662f",(0,a.jsx)(e.strong,{children:"\u6240\u6709\u7c7b"}),"\uff0c\u4f46\u8fd9\u4e9b\u7c7b\u662f\u4e0d\u662f\u90fd\u8981\u8f6c\u6210 ",(0,a.jsx)(e.code,{children:"spring bean"}),"\uff0c\u6258\u7ba1\u5230 spring \u5bb9\u5668\u5462\uff1f\u8fd9\u5c31\u662f ",(0,a.jsx)(e.code,{children:"isCandidateComponent(MetadataReader)"})," \u7684\u529f\u80fd\u4e86\u3002\u5e9f\u8bdd\u5c11\u8bf4\uff0c\u4e0a\u4ee3\u7801\uff1a"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"protected boolean isCandidateComponent(MetadataReader metadataReader) throws IOException {\n    // \u7701\u7565\u90e8\u5206\u4ee3\u7801\n    for (TypeFilter tf : this.includeFilters) {\n        // \u8fd9\u91cc\u5224\u65ad\u662f\u5426\u9700\u8981\u6258\u7ba1\u5230spring\u5bb9\u5668\n        if (tf.match(metadataReader, getMetadataReaderFactory())) {\n            // \u5224\u65ad\u662f\u5426\u6709@Conditional\u4e00\u7cfb\u5217\u7684\u6ce8\u89e3\n            return isConditionMatch(metadataReader);\n        }\n    }\n    return false;\n}\n\n"})}),"\n",(0,a.jsx)(e.p,{children:"\u8fd9\u6bb5\u4e3b\u8981\u662f\u505a\u4e86\u4e24\u4e2a\u5224\u65ad\uff1a"}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:"\u662f\u5426\u9700\u8981\u4e3a spring bean"}),"\n",(0,a.jsxs)(e.li,{children:["\u662f\u5426\u6709 ",(0,a.jsx)(e.code,{children:"@Conditional"})," \u7b49\u4e00\u7cfb\u5217\u7684\u6ce8\u89e3"]}),"\n"]}),"\n",(0,a.jsx)(e.p,{children:"\u8fd9\u91cc\u6211\u4eec\u5148\u6765\u770b\u7b2c\u4e00\u4e2a\u5224\u65ad\u3002"}),"\n",(0,a.jsxs)(e.p,{children:["\u5728 spring \u4e2d\uff0c\u6807\u660e spring bean \u7684\u6ce8\u89e3\u6709\u5f88\u591a\uff0c\u50cf ",(0,a.jsx)(e.code,{children:"@Component"}),"\u3001",(0,a.jsx)(e.code,{children:"@Repository"}),"\u3001",(0,a.jsx)(e.code,{children:"@Service"}),"\u3001",(0,a.jsx)(e.code,{children:"@Controller"}),"\u3001",(0,a.jsx)(e.code,{children:"@Configuration"}),"\uff0c\u751a\u81f3\u662f\u4f60\u81ea\u5df1\u5199\u7684\u6ce8\u89e3\u7c7b\uff0c\u53ea\u8981\u4e0a\u9762\u6807\u4e86\u8fd9\u4e9b\u6ce8\u89e3\uff0c\u50cf"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"@Target(ElementType.TYPE)\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n// \u6dfb\u52a0 @Component \u6216 @Service \u6216 @Repository \u7b49\u5176\u4e2d\u4e4b\u4e00\n@Component\npublic @interface MySpringBean {\n    ...\n}\n\n"})}),"\n",(0,a.jsxs)(e.p,{children:["\u90fd\u80fd\u88ab spring \u8bc6\u522b\u3002\u5982\u679c\u662f spring \u63d0\u4f9b\u7684\u6ce8\u89e3\uff08",(0,a.jsx)(e.code,{children:"@Component"}),"\u3001",(0,a.jsx)(e.code,{children:"@Repository"})," \u7b49\uff09\uff0c\u5728\u5224\u65ad\u662f\u4e0d\u662f spring bean \u65f6\uff0c\u53ea\u9700\u8981\u505a\u7c7b\u4f3c"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"if(annotation == Component.class || annotation == Repository.class) {\n    ...\n}\n\n"})}),"\n",(0,a.jsxs)(e.p,{children:["\u7684\u5224\u65ad\u5c31\u884c\u4e86\u3002\u4f46\u5bf9\u4e8e\u81ea\u5b9a\u4e49\u7684\u6ce8\u89e3 ",(0,a.jsx)(e.code,{children:"@MySpringBean"}),"\uff0cspring \u662f\u600e\u4e48\u77e5\u9053\u8fd9\u662f spring bean \u5462\uff1f\u5728\u6211\u4eec\u5b9a\u4e49 ",(0,a.jsx)(e.code,{children:"@MySpringBean"})," \u65f6\uff0c\u4e00\u5b9a\u8981\u5728\u7c7b\u4e0a\u6dfb\u52a0 ",(0,a.jsx)(e.code,{children:"@Component"})," \u6216 ",(0,a.jsx)(e.code,{children:"@Service"})," \u6216 ",(0,a.jsx)(e.code,{children:"@Repository"})," \u7b49\u5176\u4e2d\u4e4b\u4e00\u624d\u80fd\u88ab spring \u8bc6\u522b\uff0c\u8fd9\u5176\u4e2d\u6709\u4ec0\u4e48\u7384\u673a\u5462\uff1f\u6211\u4eec\u8ddf\u8fdb\u4ee3\u7801 ",(0,a.jsx)(e.code,{children:"AbstractTypeHierarchyTraversingFilter#match(MetadataReader, MetadataReaderFactory)"}),"\uff0c\u8fd9\u91cc\u6211\u4eec\u5bf9\u4e0d\u91cd\u8981\u7684\u4ee3\u7801\u4f9d\u65e7\u53ea\u7ed9\u51fa\u8c03\u7528\u94fe\uff1a"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"|-ClassPathScanningCandidateComponentProvider#isCandidateComponent(MetadataReader)\n |-AbstractTypeHierarchyTraversingFilter#match(MetadataReader, MetadataReaderFactory)\n  |-AnnotationTypeFilter#matchSelf\n\n"})}),"\n",(0,a.jsxs)(e.p,{children:["\u4ee3\u7801\u6700\u7ec8\u5230\u4e86 ",(0,a.jsx)(e.code,{children:"AnnotationTypeFilter#matchSelf"}),":"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"@Override\nprotected boolean matchSelf(MetadataReader metadataReader) {\n    AnnotationMetadata metadata = metadataReader.getAnnotationMetadata();\n    // \u8fd9\u91cc\u7684annotationType\u5c31\u662f @Component\n    return metadata.hasAnnotation(this.annotationType.getName()) ||\n        (this.considerMetaAnnotations && metadata.hasMetaAnnotation(this.annotationType.getName()));\n}\n\n"})}),"\n",(0,a.jsx)(e.p,{children:"\u5173\u952e\u5c31\u5728\u8fd9\u4e86\uff1a"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"metadata.hasAnnotation(this.annotationType.getName())\n\u4e0e\nthis.considerMetaAnnotations && metadata.hasMetaAnnotation(this.annotationType.getName())\n\n"})}),"\n",(0,a.jsxs)(e.p,{children:["\u6211\u4eec\u5148\u770b ",(0,a.jsx)(e.code,{children:"metadata.hasAnnotation(this.annotationType.getName())"})," \u7684\u6bd4\u8f83\uff1a"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"// AnnotationMetadata#hasAnnotation\ndefault boolean hasAnnotation(String annotationName) {\n    return getAnnotations().isDirectlyPresent(annotationName);\n}\n\n"})}),"\n",(0,a.jsxs)(e.p,{children:["\u8fd9\u91cc\u7684 ",(0,a.jsx)(e.code,{children:"getAnnotations()"})," \u5f97\u5230\u7684\u7ed3\u679c\u662f"]}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)(e.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-3e46b2ece5ddb2328342a469dc7dd554d9e.png",alt:""})}),"\n",(0,a.jsx)(e.p,{children:"mappings \u91cc\u7684\u5185\u5bb9\u662f"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"0-@Service\n1-@Component\n2-@Index\n\n"})}),"\n",(0,a.jsxs)(e.p,{children:["\u8fd9\u5176\u5b9e\u5c31\u662f\u6211\u4eec\u524d\u9762\u5f97\u5230\u7684 ",(0,a.jsx)(e.code,{children:"MetadataReader"})," \u91cc\u7684\u5185\u5bb9\uff01"]}),"\n",(0,a.jsxs)(e.p,{children:["\u518d\u8ffd\u8e2a\u4e0b\u53bb\uff0c\u53d1\u73b0 ",(0,a.jsx)(e.code,{children:"isDirectlyPresent"})," \u5c31\u662f\u5224\u65ad ",(0,a.jsx)(e.code,{children:"annotations"})," \u4e0e ",(0,a.jsx)(e.code,{children:"mappings"})," \u91cc\u6709\u6ca1\u6709\u51fa\u73b0 ",(0,a.jsx)(e.code,{children:"@Component"}),":"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"private boolean isPresent(Object requiredType, boolean directOnly) {\n    // \u5224\u65ad annotations \u91cc\u6709\u6ca1\u6709\u51fa\u73b0 @Component\n    for (MergedAnnotation<?> annotation : this.annotations) {\n        Class<? extends Annotation> type = annotation.getType();\n        if (type == requiredType || type.getName().equals(requiredType)) {\n            return true;\n        }\n    }\n    if (!directOnly) {\n        // \u5224\u65ad mappings \u91cc\u6709\u6ca1\u6709\u51fa\u73b0 @Component\n        for (AnnotationTypeMappings mappings : this.mappings) {\n            for (int i = 1; i < mappings.size(); i++) {\n                AnnotationTypeMapping mapping = mappings.get(i);\n                if (isMappingForType(mapping, requiredType)) {\n                    return true;\n                }\n            }\n        }\n    }\n    return false;\n}\n\n"})}),"\n",(0,a.jsxs)(e.p,{children:["\u63a5\u7740\u6211\u4eec\u518d\u6765\u770b ",(0,a.jsx)(e.code,{children:"this.considerMetaAnnotations && metadata.hasMetaAnnotation(this.annotationType.getName())"}),"\uff0c\u67e5\u770b\u8c03\u7528\uff1a"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"|-AnnotationTypeFilter#matchSelf\n |-AnnotationMetadata#hasMetaAnnotation\n  |-MergedAnnotationsCollection#get(String, Predicate)\n   |-MergedAnnotationsCollection#get(String, Predicate, MergedAnnotationSelector)\n    |-MergedAnnotationsCollection#find\n\n"})}),"\n",(0,a.jsxs)(e.p,{children:["\u6700\u7ec8\u7684\u67e5\u627e\u65b9\u6cd5\u5728 ",(0,a.jsx)(e.code,{children:"MergedAnnotationsCollection#find"}),":"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"private <A extends Annotation> MergedAnnotation<A> find(Object requiredType,\n        @Nullable Predicate<? super MergedAnnotation<A>> predicate,\n        @Nullable MergedAnnotationSelector<A> selector) {\n\n    MergedAnnotation<A> result = null;\n    for (int i = 0; i < this.annotations.length; i++) {\n        MergedAnnotation<?> root = this.annotations[i];\n        AnnotationTypeMappings mappings = this.mappings[i];\n        // mappings \u904d\u5386 mappings\n        for (int mappingIndex = 0; mappingIndex < mappings.size(); mappingIndex++) {\n            AnnotationTypeMapping mapping = mappings.get(mappingIndex);\n            if (!isMappingForType(mapping, requiredType)) {\n                continue;\n            }\n            // \u5230\u8fd9\u91cc\uff0c\u5c31\u662f\u627e\u5230\u4e86 @Component \u6ce8\u89e3\n            MergedAnnotation<A> candidate = (mappingIndex == 0\n                ? (MergedAnnotation<A>) root\n                : TypeMappedAnnotation.createIfPossible(mapping, root, IntrospectionFailureLogger.INFO));\n            if (candidate != null && (predicate == null || predicate.test(candidate))) {\n                if (selector.isBestCandidate(candidate)) {\n                    return candidate;\n                }\n                result = (result != null ? selector.select(result, candidate) : candidate);\n            }\n        }\n    }\n    return result;\n}\n\n"})}),"\n",(0,a.jsxs)(e.p,{children:["\u53ef\u4ee5\u770b\u5230\uff0c\u67e5\u627e\u65b9\u5f0f\u8ddf\u4e0a\u9762\u7684 ",(0,a.jsx)(e.code,{children:"metadata.hasAnnotation(this.annotationType.getName())"})," \u9ad8\u5ea6\u76f8\u4f3c\u3002"]}),"\n",(0,a.jsxs)(e.p,{children:["\u4ee5\u4e0a\u5c31\u662f spring \u7528\u6765\u5224\u65ad\u662f\u5426\u5305\u542b ",(0,a.jsx)(e.code,{children:"@Service"}),"\u3001",(0,a.jsx)(e.code,{children:"@Component"})," \u7b49\u6ce8\u89e3\u7684\u903b\u8f91\u4e86\u3002"]}),"\n",(0,a.jsxs)(e.p,{children:["\u5728 ",(0,a.jsx)(e.code,{children:"java"})," \u4e2d\uff0c\u6ce8\u89e3\u662f\u4e0d\u80fd\u7ee7\u627f\u7684\uff0c\u5982"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"@Target({ElementType.TYPE, ElementType.METHOD})\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\npublic @interface Base {\n\n}\n\n@Target({ElementType.TYPE, ElementType.METHOD})\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\npublic @interface Child extends  Base {\n\n}\n\n"})}),"\n",(0,a.jsxs)(e.p,{children:["\u4ee5\u4e0a\u8bed\u6cd5\u5728 java \u4e2d\u4e0d\u88ab\u5141\u8bb8\u7684\uff0cspring \u5c31\u662f\u91c7\u7528\u8fd9\u89e3\u6790",(0,a.jsx)(e.code,{children:"\u6ce8\u89e3\u7684\u6ce8\u89e3"}),"\u7684\u65b9\u5f0f\uff0c\u5b9e\u73b0\u4e86\u7c7b\u4f3c\u4e8e\u7ee7\u627f\u7684\u529f\u80fd\u3002"]}),"\n",(0,a.jsxs)(e.p,{children:["\u63a5\u7740\u6211\u4eec\u518d\u6765\u770b ",(0,a.jsx)(e.code,{children:"ClassPathScanningCandidateComponentProvider#isConditionMatch"})," \u65b9\u6cd5\u3002\u5b9e\u9645\u4e0a\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u662f\u7528\u6765\u5224\u65ad\u7c7b\u662f\u5426\u542b\u6709 ",(0,a.jsx)(e.code,{children:"@Conditional"})," \u6ce8\u89e3\u7684\uff0c\u6ee1\u8db3\u6761\u4ef6\u5219\u4f1a\u8bc6\u522b\u4e3a spring bean\uff0c\u4ee3\u7801\u6700\u7ec8\u8c03\u7528\u5230\u4e86 ",(0,a.jsx)(e.code,{children:"ConditionEvaluator#shouldSkip(AnnotatedTypeMetadata, ConfigurationCondition.ConfigurationPhase)"}),":"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"public boolean shouldSkip(@Nullable AnnotatedTypeMetadata metadata, @Nullable ConfigurationPhase phase) {\n    // \u7701\u7565\u4e86\u4e00\u4e9b\u4ee3\u7801\n\n    // \u5f97\u5230 condition \u5bf9\u8c61\n    List<Condition> conditions = new ArrayList<>();\n        for (String[] conditionClasses : getConditionClasses(metadata)) {\n            for (String conditionClass : conditionClasses) {\n                Condition condition = getCondition(conditionClass, this.context.getClassLoader());\n                conditions.add(condition);\n            }\n        }\n    }\n\n    AnnotationAwareOrderComparator.sort(conditions);\n    // \u904d\u5386\uff0c\u5224\u65ad condition \u6761\u4ef6\u662f\u5426\u6210\u7acb\n    for (Condition condition : conditions) {\n        ConfigurationPhase requiredPhase = null;\n        if (condition instanceof ConfigurationCondition) {\n            requiredPhase = ((ConfigurationCondition) condition).getConfigurationPhase();\n        }\n        if ((requiredPhase == null || requiredPhase == phase) \n                // \u5224\u65ad condition \u6761\u4ef6\u662f\u5426\u6210\u7acb\uff0c\u4e00\u4e2a\u6761\u4ef6\u6ee1\u8db3\u5c31\u8fd4\u56detrue\n                && !condition.matches(this.context, metadata)) {\n            return true;\n        }\n    }\n\n    return false;\n}\n\n// \u901a\u8fc7\u53cd\u5c04\u83b7\u53d6 Condition \u5bf9\u8c61\nprivate Condition getCondition(String conditionClassName, @Nullable ClassLoader classloader) {\n    Class<?> conditionClass = ClassUtils.resolveClassName(conditionClassName, classloader);\n    return (Condition) BeanUtils.instantiateClass(conditionClass);\n}\n\n"})}),"\n",(0,a.jsx)(e.p,{children:"\u8fd9\u91cc\u505a\u4e86\u4e24\u4ef6\u4e8b\uff1a"}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsx)(e.li,{children:"\u83b7\u53d6 condition \u5bf9\u8c61"}),"\n",(0,a.jsxs)(e.li,{children:["\u904d\u5386 condition \u5bf9\u8c61\uff0c\u8c03\u7528 ",(0,a.jsx)(e.code,{children:"condition.matches()"})," \u65b9\u6cd5\uff0c\u5224\u65ad\u6761\u4ef6\u662f\u5426\u6210\u7acb"]}),"\n"]}),"\n",(0,a.jsxs)(e.h5,{id:"3-\u4ece-metadatareader-\u5f97\u5230-scannedgenericbeandefinition",children:["3. \u4ece ",(0,a.jsx)(e.code,{children:"MetadataReader"})," \u5f97\u5230 ",(0,a.jsx)(e.code,{children:"ScannedGenericBeanDefinition"})]}),"\n",(0,a.jsxs)(e.p,{children:["\u8fd9\u91cc\u4ec5\u662f\u505a\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u8d4b\u503c\uff0c\u770b\u4e0b ",(0,a.jsx)(e.code,{children:"ScannedGenericBeanDefinition"})," \u7684\u6784\u9020\u65b9\u6cd5\u5c31\u660e\u767d\u4e86\uff1a"]}),"\n",(0,a.jsxs)(e.blockquote,{children:["\n",(0,a.jsx)(e.p,{children:"ScannedGenericBeanDefinition#ScannedGenericBeanDefinition"}),"\n"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:'public ScannedGenericBeanDefinition(MetadataReader metadataReader) {\n    Assert.notNull(metadataReader, "MetadataReader must not be null");\n    this.metadata = metadataReader.getAnnotationMetadata();\n    setBeanClassName(this.metadata.getClassName());\n}\n\n'})}),"\n",(0,a.jsx)(e.p,{children:"\u4ee3\u7801\u6bd4\u8f83\u7b80\u5355\uff0c\u5c31\u4e0d\u591a\u505a\u5206\u6790\u4e86\u3002"}),"\n",(0,a.jsx)(e.h3,{id:"2-\u4e30\u5bcc-beandefinition-\u4fe1\u606f",children:"2. \u4e30\u5bcc beanDefinition \u4fe1\u606f"}),"\n",(0,a.jsxs)(e.p,{children:["\u5386\u7ecf\u5343\u96be\u4e07\u9669\uff0c\u7ec8\u4e8e\u5f97\u5230\u4e86 ",(0,a.jsx)(e.code,{children:"beanDefinition"}),"\uff0c\u4f46\u6b64\u65f6 ",(0,a.jsx)(e.code,{children:"beanDefinition"})," \u5e76\u4e0d\u4e30\u5bcc\uff0c\u63a5\u4e0b\u6765\u5c31\u662f\u8fdb\u4e00\u6b65\u6269\u5c55 ",(0,a.jsx)(e.code,{children:"beanDefinition"})," \u7684\u4fe1\u606f\u4e86\u3002\u8fd9\u4e9b\u4fe1\u606f\u5305\u62ec ",(0,a.jsx)(e.code,{children:"bean\u7684\u540d\u79f0"}),"\u3001",(0,a.jsx)(e.code,{children:"bean\u7684\u4f5c\u7528\u57df"}),"\u3001",(0,a.jsx)(e.code,{children:"@Lazy"})," \u6ce8\u89e3\u3001",(0,a.jsx)(e.code,{children:"@Primary"})," \u6ce8\u89e3\u3001",(0,a.jsx)(e.code,{children:"@DependsOn"})," \u6ce8\u89e3\u7b49\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:'public abstract class AnnotationConfigUtils {\n\n    ...\n\n    /**\n     * \u8fdb\u4e00\u6b65\u4e30\u5bcc BeanDefinition\n     */\n    static void processCommonDefinitionAnnotations(AnnotatedBeanDefinition abd, \n            AnnotatedTypeMetadata metadata) {\n        // \u5904\u7406 @Lazy\n        AnnotationAttributes lazy = attributesFor(metadata, Lazy.class);\n        if (lazy != null) {\n            abd.setLazyInit(lazy.getBoolean("value"));\n        }\n        else if (abd.getMetadata() != metadata) {\n            lazy = attributesFor(abd.getMetadata(), Lazy.class);\n            if (lazy != null) {\n                abd.setLazyInit(lazy.getBoolean("value"));\n            }\n        }\n        // \u5904\u7406 @Primary\n        if (metadata.isAnnotated(Primary.class.getName())) {\n            abd.setPrimary(true);\n        }\n        // \u5904\u7406 @DependsOn\n        AnnotationAttributes dependsOn = attributesFor(metadata, DependsOn.class);\n        if (dependsOn != null) {\n            abd.setDependsOn(dependsOn.getStringArray("value"));\n        }\n        // \u5904\u7406 @Role\n        AnnotationAttributes role = attributesFor(metadata, Role.class);\n        if (role != null) {\n            abd.setRole(role.getNumber("value").intValue());\n        }\n        // \u5904\u7406 @Description\n        AnnotationAttributes description = attributesFor(metadata, Description.class);\n        if (description != null) {\n            abd.setDescription(description.getString("value"));\n        }\n    }\n}\n\n'})}),"\n",(0,a.jsxs)(e.h3,{id:"3-registerbeandefinitiondefinitionholder-thisregistry-\u6dfb\u52a0-beandefinition-\u5230-beanfactory",children:["3.",(0,a.jsx)(e.code,{children:" registerBeanDefinition(definitionHolder, this.registry)"}),": \u6dfb\u52a0 BeanDefinition \u5230 beanFactory"]}),"\n",(0,a.jsxs)(e.p,{children:["\u5c06 ",(0,a.jsx)(e.code,{children:"BeanDefinition"})," \u5230 ",(0,a.jsx)(e.code,{children:"beanFactory"})," \u7684\u64cd\u4f5c\u6bd4\u8f83\u7b80\u5355\uff0c\u5173\u952e\u7684\u4ee3\u7801\u5982\u4e0b\uff1a"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"|-ClassPathBeanDefinitionScanner#registerBeanDefinition\n |-BeanDefinitionReaderUtils#registerBeanDefinition\n  |-GenericApplicationContext#registerBeanDefinition\n   |-DefaultListableBeanFactory#registerBeanDefinition\n\n"})}),"\n",(0,a.jsxs)(e.blockquote,{children:["\n",(0,a.jsx)(e.p,{children:"DefaultListableBeanFactory#registerBeanDefinition"}),"\n"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"this.beanDefinitionMap.put(beanName, beanDefinition);\n\n"})}),"\n",(0,a.jsxs)(e.p,{children:["\u4ece ",(0,a.jsx)(e.code,{children:"ClassPathBeanDefinitionScanner#registerBeanDefinition"})," \u5230 ",(0,a.jsx)(e.code,{children:"DefaultListableBeanFactory#registerBeanDefinition"}),"\uff0c\u8fd9\u5176\u4e2d\u867d\u7136\u7ecf\u5386\u4e86\u4e00\u4e9b\u5f2f\u5f2f\u7ed5\u7ed5\uff0c\u4f46\u4f9d\u65e7\u4e0d\u59a8\u788d\u6211\u4eec\u627e\u5230\u5173\u952e\u7684\u4ee3\u7801\u3002"]}),"\n",(0,a.jsxs)(e.p,{children:["\u5230\u6b64\uff0c\u78c1\u76d8\u4e0a\u7684 class \u6587\u4ef6\uff0c\u7ecf\u8fc7 spring \u626b\u63cf\uff0c\u7ec8\u4e8e\u53d8\u6210\u4e86 ",(0,a.jsx)(e.code,{children:"BeanDefinition"}),"\uff0c\u4fdd\u5b58\u5728 ",(0,a.jsx)(e.code,{children:"BeanFactory"})," \u4e2d\u4e86\u3002"]}),"\n",(0,a.jsx)(e.h3,{id:"4-\u603b\u7ed3",children:"4. \u603b\u7ed3"}),"\n",(0,a.jsxs)(e.p,{children:["\u672c\u6587\u6bd4\u8f83\u957f\uff0c\u4e3b\u8981\u5206\u6790\u4e86 spring \u626b\u63cf\u5305\u8def\u5f84\u5f97\u5230 ",(0,a.jsx)(e.code,{children:"beanDefinition"})," \u7684\u8fc7\u7a0b\uff0c\u4e3b\u8981\u6d41\u7a0b\u5982\u4e0b\uff1a"]}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsxs)(e.li,{children:["\u6839\u636e\u5305\u540d\u5f97\u5230\u8def\u5f84 ",(0,a.jsx)(e.code,{children:"Resource"}),"\uff1b"]}),"\n",(0,a.jsxs)(e.li,{children:["\u6839\u636e\u8def\u5f84 ",(0,a.jsx)(e.code,{children:"Resouce"})," \u5f97\u5230\u8be5\u8def\u5f84\u4e0b\u6240\u6709 class \u6587\u4ef6\u7684 ",(0,a.jsx)(e.code,{children:"Resouce"}),"\uff1b"]}),"\n",(0,a.jsxs)(e.li,{children:["\u6839\u636e class \u6587\u4ef6\u7684 ",(0,a.jsx)(e.code,{children:"Resouce"})," \u901a\u8fc7 asm \u89e3\u6790\u5f97\u5230 ",(0,a.jsx)(e.code,{children:"MetadataReader"}),"\uff0c\u6ce8\u610f\uff1a\u8fd9\u91cc\u7684 ",(0,a.jsx)(e.code,{children:"MetadataReader"})," \u8fd8\u662f\u6240\u6709 class \u6587\u4ef6\u7684 ",(0,a.jsx)(e.code,{children:"MetadataReader"}),"\uff1b"]}),"\n",(0,a.jsxs)(e.li,{children:["\u4ece ",(0,a.jsx)(e.code,{children:"MetadataReader"})," \u4e2d\u627e\u5230\u9700\u8981 spring \u6258\u7ba1\u7684 ",(0,a.jsx)(e.code,{children:"MetadataReader"}),"\uff0c\u5c06\u5176\u8f6c\u5316\u4e3a ",(0,a.jsx)(e.code,{children:"ScannedGenericBeanDefinition"}),"\uff0c",(0,a.jsx)(e.code,{children:"ScannedGenericBeanDefinition"})," \u4e3a ",(0,a.jsx)(e.code,{children:"BeanDefinition"})," \u7684\u5b50\u7c7b\uff1b"]}),"\n",(0,a.jsxs)(e.li,{children:["\u8fdb\u4e00\u6b65\u4e30\u5bcc ",(0,a.jsx)(e.code,{children:"ScannedGenericBeanDefinition"})," \u7684\u4fe1\u606f\uff1b"]}),"\n",(0,a.jsxs)(e.li,{children:["\u5c06\u4e0a\u9762\u5f97\u5230\u7684 ",(0,a.jsx)(e.code,{children:"BeanDefinition"})," \u6dfb\u52a0\u5230 ",(0,a.jsx)(e.code,{children:"BeanFactory"})," \u4e2d"]}),"\n"]}),"\n",(0,a.jsxs)(e.p,{children:["\u81f3\u6b64\uff0c\u5305\u540d\u8f6c\u6362\u4e3a ",(0,a.jsx)(e.code,{children:"BeanDefinition"})," \u5b8c\u6210\u3002"]}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)(e.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-f8ff2e4071ba3941e2a0664f6e478b78961.png",alt:""})}),"\n",(0,a.jsx)(e.p,{children:"\u672c\u6587\u8fd8\u6709\u4e24\u4e2a\u503c\u5f97\u6ce8\u610f\u7684\u5730\u65b9\uff1a"}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsx)(e.li,{children:"spring \u5728\u83b7\u53d6\u7c7b\u4e0a\u7684\u6ce8\u89e3\u65f6\uff0c\u4e0d\u662f\u901a\u8fc7\u53cd\u5c04\uff0c\u800c\u662f\u4f7f\u7528 asm \u76f4\u63a5\u89e3\u6790 class \u6587\u4ef6\uff0c\u7136\u540e\u518d\u83b7\u53d6\u7c7b\u4e0a\u7684\u6ce8\u89e3\u7684"}),"\n",(0,a.jsxs)(e.li,{children:["\u5728\u5904\u7406\u6ce8\u89e3\u65f6\uff0cspring \u901a\u8fc7\u89e3\u6790 \u201c\u6ce8\u89e3\u7684\u6ce8\u89e3\u201d \u5b9e\u73b0\u4e86\u4e00\u5957\u7c7b\u4f3c\u4e8e\u6ce8\u89e3\u7ee7\u627f\u7684\u65b9\u5f0f\uff0c\u8fd9\u4e5f\u662f spring \u80fd\u8bc6\u522b ",(0,a.jsx)(e.code,{children:"@Component"}),"\u3001",(0,a.jsx)(e.code,{children:"@Service"})," \u751a\u81f3\u662f\u5f00\u53d1\u8005\u81ea\u5b9a\u4e49\u6ce8\u89e3\u7684\u539f\u56e0\u3002"]}),"\n"]}),"\n",(0,a.jsxs)(e.p,{children:["\u5f97\u5230\u4e86 ",(0,a.jsx)(e.code,{children:"BeanDefinition"})," \u540e\uff0c\u63a5\u7740\u5c31\u662f spring \u5bb9\u5668\u7684\u521d\u59cb\u5316\u4e86\uff0c\u6211\u4eec\u4e0b\u7bc7\u6587\u7ae0\u518d\u89c1\u3002"]}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsxs)(e.em,{children:["\u672c\u6587\u539f\u6587\u94fe\u63a5\uff1a",(0,a.jsx)(e.a,{href:"https://my.oschina.net/funcy/blog/4614071",children:"https://my.oschina.net/funcy/blog/4614071"})," \uff0c\u9650\u4e8e\u4f5c\u8005\u4e2a\u4eba\u6c34\u5e73\uff0c\u6587\u4e2d\u96be\u514d\u6709\u9519\u8bef\u4e4b\u5904\uff0c\u6b22\u8fce\u6307\u6b63\uff01\u539f\u521b\u4e0d\u6613\uff0c\u5546\u4e1a\u8f6c\u8f7d\u8bf7\u8054\u7cfb\u4f5c\u8005\u83b7\u5f97\u6388\u6743\uff0c\u975e\u5546\u4e1a\u8f6c\u8f7d\u8bf7\u6ce8\u660e\u51fa\u5904\u3002"]})})]})}function h(n={}){const{wrapper:e}={...(0,t.a)(),...n.components};return e?(0,a.jsx)(e,{...n,children:(0,a.jsx)(l,{...n})}):l(n)}},88672:(n,e,i)=>{i.d(e,{Z:()=>o,a:()=>s});var a=i(50959);const t={},r=a.createContext(t);function s(n){const e=a.useContext(r);return a.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:s(n.components),a.createElement(r.Provider,{value:e},n.children)}}}]);