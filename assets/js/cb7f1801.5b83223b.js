"use strict";(self.webpackChunkcode_note_blog=self.webpackChunkcode_note_blog||[]).push([[3591],{22762:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>s,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>l,toc:()=>c});var i=t(11527),a=t(88672);const r={},o=void 0,l={id:"Java/concurrency/Java\u5e76\u53d1\u6307\u5357\uff1aJMM\u4e2d\u7684final\u5173\u952e\u5b57\u89e3\u6790",title:"Java\u5e76\u53d1\u6307\u5357\uff1aJMM\u4e2d\u7684final\u5173\u952e\u5b57\u89e3\u6790",description:"\u672c\u6587\u8f6c\u8f7d\u81ea\u4e92\u8054\u7f51\uff0c\u4fb5\u5220",source:"@site/docs/Java/concurrency/Java\u5e76\u53d1\u6307\u5357\uff1aJMM\u4e2d\u7684final\u5173\u952e\u5b57\u89e3\u6790.md",sourceDirName:"Java/concurrency",slug:"/Java/concurrency/Java\u5e76\u53d1\u6307\u5357\uff1aJMM\u4e2d\u7684final\u5173\u952e\u5b57\u89e3\u6790",permalink:"/code-note-blog/docs/Java/concurrency/Java\u5e76\u53d1\u6307\u5357\uff1aJMM\u4e2d\u7684final\u5173\u952e\u5b57\u89e3\u6790",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Java/concurrency/Java\u5e76\u53d1\u6307\u5357\uff1aJMM\u4e2d\u7684final\u5173\u952e\u5b57\u89e3\u6790.md",tags:[],version:"current",frontMatter:{},sidebar:"java",previous:{title:"Java\u5e76\u53d1\u6307\u5357\uff1aJava\u4e2d\u7684HashMap\u548cConcurrentHashMap\u5168\u89e3\u6790",permalink:"/code-note-blog/docs/Java/concurrency/Java\u5e76\u53d1\u6307\u5357\uff1aJava\u4e2d\u7684HashMap\u548cConcurrentHashMap\u5168\u89e3\u6790"},next:{title:"Java\u5e76\u53d1\u6307\u5357\uff1aJUC\u7684\u6838\u5fc3\u7c7bAQS\u8be6\u89e3",permalink:"/code-note-blog/docs/Java/concurrency/Java\u5e76\u53d1\u6307\u5357\uff1aJUC\u7684\u6838\u5fc3\u7c7bAQS\u8be6\u89e3"}},s={},c=[{value:"\u4e00\u3001properly constructed / this\u5bf9\u8c61\u9038\u51fa",id:"\u4e00properly-constructed--this\u5bf9\u8c61\u9038\u51fa",level:2},{value:"\u4e8c\u3001\u5bf9\u8c61\u7684\u5b89\u5168\u53d1\u5e03",id:"\u4e8c\u5bf9\u8c61\u7684\u5b89\u5168\u53d1\u5e03",level:2},{value:"\u4e09\u3001 final \u5173\u952e\u5b57\u7684\u5185\u5b58\u8bed\u4e49",id:"\u4e09-final-\u5173\u952e\u5b57\u7684\u5185\u5b58\u8bed\u4e49",level:2},{value:"\u56db\u3001HotSpot VM\u4e2d\u5bf9final\u5185\u5b58\u8bed\u4e49\u7684\u5b9e\u73b0",id:"\u56dbhotspot-vm\u4e2d\u5bf9final\u5185\u5b58\u8bed\u4e49\u7684\u5b9e\u73b0",level:2}];function d(n){const e={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,a.a)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"\u672c\u6587\u8f6c\u8f7d\u81ea\u4e92\u8054\u7f51\uff0c\u4fb5\u5220"})}),"\n",(0,i.jsx)(e.p,{children:"\u672c\u7cfb\u5217\u6587\u7ae0\u5c06\u6574\u7406\u5230\u6211\u5728GitHub\u4e0a\u7684\u300aJava\u9762\u8bd5\u6307\u5357\u300b\u4ed3\u5e93\uff0c\u66f4\u591a\u7cbe\u5f69\u5185\u5bb9\u8bf7\u5230\u6211\u7684\u4ed3\u5e93\u91cc\u67e5\u770b"}),"\n",(0,i.jsxs)(e.blockquote,{children:["\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.a,{href:"https://github.com/h2pl/Java-Tutorial",children:"https://github.com/h2pl/Java-Tutorial"})}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"\u559c\u6b22\u7684\u8bdd\u9ebb\u70e6\u70b9\u4e0bStar\u54c8"}),"\n",(0,i.jsx)(e.p,{children:"\u6587\u7ae0\u9996\u53d1\u4e8e\u6211\u7684\u4e2a\u4eba\u535a\u5ba2\uff1a"}),"\n",(0,i.jsxs)(e.blockquote,{children:["\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.a,{href:"http://www.how2playlife.com",children:"www.how2playlife.com"})}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"\u672c\u6587\u662f\u5fae\u4fe1\u516c\u4f17\u53f7\u3010Java\u6280\u672f\u6c5f\u6e56\u3011\u7684\u300aJava\u5e76\u53d1\u6307\u5357\u300b\u5176\u4e2d\u4e00\u7bc7\uff0c\u672c\u6587\u5927\u90e8\u5206\u5185\u5bb9\u6765\u6e90\u4e8e\u7f51\u7edc\uff0c\u4e3a\u4e86\u628a\u672c\u6587\u4e3b\u9898\u8bb2\u5f97\u6e05\u6670\u900f\u5f7b\uff0c\u4e5f\u6574\u5408\u4e86\u5f88\u591a\u6211\u8ba4\u4e3a\u4e0d\u9519\u7684\u6280\u672f\u535a\u5ba2\u5185\u5bb9\uff0c\u5f15\u7528\u5176\u4e2d\u4e86\u4e00\u4e9b\u6bd4\u8f83\u597d\u7684\u535a\u5ba2\u6587\u7ae0\uff0c\u5982\u6709\u4fb5\u6743\uff0c\u8bf7\u8054\u7cfb\u4f5c\u8005\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u8be5\u7cfb\u5217\u535a\u6587\u4f1a\u544a\u8bc9\u4f60\u5982\u4f55\u5168\u9762\u6df1\u5165\u5730\u5b66\u4e60Java\u5e76\u53d1\u6280\u672f\uff0c\u4eceJava\u591a\u7ebf\u7a0b\u57fa\u7840\uff0c\u518d\u5230\u5e76\u53d1\u7f16\u7a0b\u7684\u57fa\u7840\u77e5\u8bc6\uff0c\u4eceJava\u5e76\u53d1\u5305\u7684\u5165\u95e8\u548c\u5b9e\u6218\uff0c\u518d\u5230JUC\u7684\u6e90\u7801\u5256\u6790\uff0c\u4e00\u6b65\u6b65\u5730\u5b66\u4e60Java\u5e76\u53d1\u7f16\u7a0b\uff0c\u5e76\u4e0a\u624b\u8fdb\u884c\u5b9e\u6218\uff0c\u4ee5\u4fbf\u8ba9\u4f60\u66f4\u5b8c\u6574\u5730\u4e86\u89e3\u6574\u4e2aJava\u5e76\u53d1\u7f16\u7a0b\u77e5\u8bc6\u4f53\u7cfb\uff0c\u5f62\u6210\u81ea\u5df1\u7684\u77e5\u8bc6\u6846\u67b6\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u4e3a\u4e86\u66f4\u597d\u5730\u603b\u7ed3\u548c\u68c0\u9a8c\u4f60\u7684\u5b66\u4e60\u6210\u679c\uff0c\u672c\u7cfb\u5217\u6587\u7ae0\u4e5f\u4f1a\u63d0\u4f9b\u4e00\u4e9b\u5bf9\u5e94\u7684\u9762\u8bd5\u9898\u4ee5\u53ca\u53c2\u8003\u7b54\u6848\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u5982\u679c\u5bf9\u672c\u7cfb\u5217\u6587\u7ae0\u6709\u4ec0\u4e48\u5efa\u8bae\uff0c\u6216\u8005\u662f\u6709\u4ec0\u4e48\u7591\u95ee\u7684\u8bdd\uff0c\u4e5f\u53ef\u4ee5\u5173\u6ce8\u516c\u4f17\u53f7\u3010Java\u6280\u672f\u6c5f\u6e56\u3011\u8054\u7cfb\u4f5c\u8005\uff0c\u6b22\u8fce\u4f60\u53c2\u4e0e\u672c\u7cfb\u5217\u535a\u6587\u7684\u521b\u4f5c\u548c\u4fee\u8ba2\u3002"}),"\n",(0,i.jsx)(e.h2,{id:"\u4e00properly-constructed--this\u5bf9\u8c61\u9038\u51fa",children:"\u4e00\u3001properly constructed / this\u5bf9\u8c61\u9038\u51fa"}),"\n",(0,i.jsx)(e.p,{children:"\u5728\u5f00\u59cb\u8bb2\u4e4b\u524dfinal\u4e4b\u524d\uff0c\u5148\u4e86\u89e3\u4e00\u4e2a\u6982\u5ff5\uff0c\u53eb\u505a \u201cproperly constructed\u201d\u3002\u5176\u542b\u4e49\u662f\uff1a\u5728\u6784\u9020\u5668\u521b\u5efa\u5bf9\u8c61\u7684\u8fc7\u7a0b\u4e2d\uff0c\u6b63\u5728\u88ab\u521b\u5efa\u7684\u5bf9\u8c61\u7684\u5f15\u7528\u6ca1\u6709\u53d1\u751f \u201c\u9038\u51fa(escape)\u201d \u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"public Test {\nprivate final int x;\nprivate int y;\nprivate static Test instance;\n\n\tpublic Test(int x, int y) {\n\t\tthis.x = x;\n\t\tthis.y = y;\n\t\tinstance = this;\n\t}\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u5728\u6784\u9020\u5668\u4e2d\u628a\u6b63\u5728\u521b\u5efa\u7684\u5bf9\u8c61\u8d4b\u503c\u7ed9\u4e86\u4e00\u4e2a\u9759\u6001\u53d8\u91cfinstance\uff0c\u8fd9\u79cd\u884c\u4e3a\u5c31\u53eb\u201c\u9038\u51fa\u201d\u3002"}),"\n",(0,i.jsx)(e.h2,{id:"\u4e8c\u5bf9\u8c61\u7684\u5b89\u5168\u53d1\u5e03",children:"\u4e8c\u3001\u5bf9\u8c61\u7684\u5b89\u5168\u53d1\u5e03"}),"\n",(0,i.jsx)(e.p,{children:"\u6240\u8c13\u5bf9\u8c61\u7684\u5b89\u5168\u53d1\u5e03\uff0c\u610f\u601d\u5c31\u662f\u6784\u5efa\u4e00\u4e2a\u88ab\u5b8c\u6574\u521d\u59cb\u5316\u7684\u5bf9\u8c61\uff0c\u9632\u6b62\u4e00\u4e2a\u672a\u5b8c\u5168\u521d\u59cb\u5316\u7684\u5bf9\u8c61\u88ab\u8bbf\u95ee\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u770b\u4e0b\u9762\u7684\u4f8b\u5b50\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"public class Test {\nstatic MyObj obj;\n\n\tstatic class MyObj {\n\t\tint a, b, c, d;\n\t\tMyObj() {\n\t\t\ta = 1;\n\t\t\tb = 1;\n\t\t\tc = 1;\n\t\t\td = 1;\n\t\t}\n\t}\n\t\n\t// Thread 1\n\tpublic static void init() {\n\t\tobj = new MyObj();\n\t}\n\t\n\t// Thread 2\n\tpublic static void f() {\n\t\tif (obj == null) return;\n\t\tif (obj != null) {\n\t\t\tSystem.out.println(obj.a + obj.b + obj.c + obj.d);\n\t\t}\n\t}\n\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u4e0a\u8ff0\u4ee3\u7801\u4e2d\uff0cThread 2 \u6253\u5370\u51fa\u7684\u6570\u5c06\u4f1a\u662f\u51e0\u5462\uff1f\u4e8b\u5b9e\u4e0a\uff0c\u53ef\u80fd\u662f0, 1, 2, 3, 4 \u4e2d\u7684\u4efb\u610f\u4e00\u4e2a\u503c\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u5982\u679c\u6253\u5370\u51fa\u7684\u6570\u4e0d\u662f4\uff0c\u90a3\u4e48\u5c31\u8bf4\u660e\u7ebf\u7a0b2\u8bfb\u5230\u4e86\u672a\u5b8c\u5168\u521d\u59cb\u5316\u7684MyObj\u5bf9\u8c61\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u4e3a\u4ec0\u4e48\u4f1a\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\u5462\uff1f\u662f\u56e0\u4e3a obj = new MyObj() \u8fd9\u4e2a\u64cd\u4f5c\u5e95\u5c42\u5b9e\u9645\u4e0a\u5206\u4e3a\u4ee5\u4e0b3\u4e2a\u6b65\u9aa4\uff1a"}),"\n",(0,i.jsx)(e.p,{children:"\u5728\u5806\u4e0a\u7ed9MyObj\u5bf9\u8c61\u5206\u914d\u7a7a\u95f4\uff0c\u5bf9\u8c61\u7684\u5b57\u6bb5\u7f6e\u4e3a\u9ed8\u8ba4\u503c\n\u6267\u884c\u6784\u9020\u5668\u4e2d\u7684\u521d\u59cb\u5316\u8bed\u53e5\u8fdb\u884c\u521d\u59cb\u5316\n\u5c06\u5806\u4e0a\u7684MyObj\u5bf9\u8c61\u7684\u5f15\u7528\u8d4b\u503c\u7ed9obj\n\u5176\u4e2d\uff0c\u6b65\u9aa42\u548c3\u662f\u53ef\u80fd\u53d1\u751f\u91cd\u6392\u5e8f\u7684 (StoreStore\u91cd\u6392\u5e8f)\uff0c\u56e0\u6b64\u5c31Thread 2\u5c31\u53ef\u80fd\u770b\u5230 obj != null\uff0c\u4f46\u662fa,b,c,d\u8fd8\u6ca1\u5168\u90e8\u8d4b\u503c\u5b8c\u6210\u7684\u60c5\u51b5\uff0c\u4e5f\u5c31\u662f Thread 1 \u4e0d\u5b89\u5168\u7684\u53d1\u5e03\u4e86 MyObj \u5bf9\u8c61\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u6269\u5c55\u4e00\u4e0b\uff0c\u5728\u5b9e\u73b0\u5355\u4f8b\u6a21\u5f0f\u65f6\uff0c\u4f1a\u4ec0\u4e48\u8981double checked\u4e14\u52a0\u4e0avolatile\uff0c\u6b63\u662f\u8fd9\u4e2a\u539f\u56e0\uff0c\u9632\u6b62\u4e0d\u5b89\u5168\u7684\u53d1\u5e03\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u7b14\u8005\u5728 x86 \u5e73\u53f0\u7684 HotSpot \u865a\u62df\u673a\u4e2d\u4f7f\u7528 jcstress \u5de5\u5177\u5bf9\u4e0d\u5b89\u5168\u53d1\u5e03\u73b0\u8c61\u8fdb\u884c\u4e86\u6d4b\u8bd5\uff0c\u53d1\u73b0\u7c7b\u4f3c\u4e8e\u4e0a\u8ff0\u7684\u4ee3\u7801\u5728 x86 \u5e73\u53f0\u7684 HotSpot \u865a\u62df\u673a\u4e2d\u5e76\u4e0d\u4f1a\u51fa\u73b0\u4e3a\u5b8c\u5168\u521d\u59cb\u5316\u7684\u60c5\u51b5\uff0c\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\u5c31\u8bf4\u660e\uff0cx86 \u5e73\u53f0\u7684 HotSpot \u865a\u62df\u673a\u5b9e\u73b0\u4e2d\uff0c\u7f16\u8bd1\u5668\u6ca1\u6709\u5bf9\u4e0a\u8ff0\u6b65\u9aa42\u548c3\u8fdb\u884c\u91cd\u6392\u5e8f\uff0c\u800cx86\u7684\u5185\u5b58\u6a21\u578b\u53c8\u4fdd\u8bc1\u4e86x86\u4e0d\u4f1a\u53d1\u751fStoreStore\u91cd\u6392\u5e8f\uff0c\u56e0\u6b64\u4e0a\u8ff0\u6b65\u9aa42\u548c3\u4e0d\u4f1a\u53d1\u751f\u91cd\u6392\u5e8f\uff0c\u8fdb\u800c\u59cb\u7ec8\u53ef\u4ee5\u8bfb\u5230\u5b8c\u5168\u521d\u59cb\u5316\u8fc7\u7684\u5bf9\u8c61\u3002\u4f46\u662f\uff0c\u5728\u5176\u4ed6\u786c\u4ef6\u5e73\u53f0\u6216\u5176\u4ed6JVM\u4e2d\u5c31\u672a\u5fc5\u5982\u6b64\u4e86\u3002 \u6211\u4eec\u7684Java\u4ee3\u7801\u4e0d\u5e94\u8be5\u57fa\u4e8e\u7279\u5b9a\u786c\u4ef6\u5e73\u53f0\u6216\u865a\u62df\u673a\u5b9e\u73b0\u4e4b\u4e0a\uff0c\u800c\u662f\u5e94\u8be5\u9075\u5faaJLS\u548cJMM\u7684\u89c4\u8303\uff01"}),"\n",(0,i.jsx)(e.h2,{id:"\u4e09-final-\u5173\u952e\u5b57\u7684\u5185\u5b58\u8bed\u4e49",children:"\u4e09\u3001 final \u5173\u952e\u5b57\u7684\u5185\u5b58\u8bed\u4e49"}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsx)(e.li,{children:"\u53ef\u89c1\u6027\n\u6458\u81ea[1]\uff1a"}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"The values for an object\u2019s final fields are set in its constructor. Assuming the object is constructed \u201ccorrectly\u201d, once an object is constructed, the values assigned to the final fields in the constructor will be visible to all other threads without synchronization. In addition, the visible values for any other object or array referenced by those final fields will be at least as up-to-date as the final fields."}),"\n",(0,i.jsx)(e.p,{children:"\u5728JMM\u4e2d\u89c4\u5b9a\uff0c\u5982\u679c\u6211\u4eec\u5728\u6784\u9020\u5668\u4e2d\u5bf9final\u5b57\u6bb5\u8fdb\u884c\u521d\u59cb\u5316\uff0c\u5e76\u4e14\u6784\u9020\u5668\u4e2d\u6ca1\u6709\u53d1\u751fthis\u5bf9\u8c61\u7684\u9038\u51fa\uff0c\u90a3\u4e48\u65e0\u9700\u4efb\u4f55\u540c\u6b65\u63aa\u65bd\uff0c\u5373\u53ef\u786e\u4fdd\u5176\u4ed6\u7ebf\u7a0b\u53ef\u4ee5\u770b\u5230\u6784\u9020\u5668\u4e2d\u521d\u59cb\u5316\u7ed9final\u5b57\u6bb5\u7684\u503c\u3002\u6b64\u5916\uff0c\u5982\u679c\u8fd9\u4e2afinal\u5b57\u6bb5\u662f\u4e00\u4e2a\u5f15\u7528\u7c7b\u578b\uff0c\u90a3\u4e48\u53ef\u4ee5\u786e\u4fdd\u8be5\u5f15\u7528\u7c7b\u578b\u5bf9\u8c61\u5f15\u7528\u5230\u7684\u5bf9\u8c61\u6216\u6570\u7ec4\u7684\u5185\u5bb9\u90fd\u662f\u81f3\u5c11\u548cfinal\u5b57\u6bb5\u4e00\u6837\u65b0\u7684\u503c\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u8fd9\u91cc\u7684\u201c\u81f3\u5c11\u548cfinal\u5b57\u6bb5\u4e00\u6837\u65b0\u7684\u503c\u201d\uff0c\u610f\u601d\u4e5f\u5c31\u662f up to date as of the end of the object\u2019s constructor ([1])\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u5bf9\u4e8e\u5f15\u7528\u7c7b\u578b\u7684final\u53d8\u91cf\uff0c\u5176\u4ed6\u7ebf\u7a0b\u81f3\u5c11\u80fd\u591f\u8bfb\u5230\u6784\u9020\u5668\u7ed3\u675f\u65f6\uff0c\u8fd9\u4e2afinal\u7c7b\u578b\u5f15\u7528\u53d8\u91cf\u7684\u6210\u5458\u7684\u72b6\u6001\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u5b9e\u9645\u4e0a\uff0cfinal \u5173\u952e\u5b57\u5bf9\u53ef\u89c1\u6027\u7684\u5f71\u54cd\u5728Java\u8bed\u8a00\u89c4\u8303\u7684 17.5.1. Semantics of final Fields \u4e00\u8282\u4e5f\u4f5c\u51fa\u4e86\u6b63\u5f0f\u89c4\u8303\u3002\u9488\u5bf9final\u5173\u952e\u5b57\uff0c\u5f15\u5165\u4e86\u4e24\u4e2a\u504f\u5e8f\u5173\u7cfb\u2014\u2014Dereference Chain\u548cMemory Chain\uff0c\u501f\u52a9\u8fd9\u4e24\u4e2a\u504f\u5e8f\u5173\u7cfb\uff0c\u53ef\u4ee5\u5728\u4e0d\u540c\u7ebf\u7a0b\u4e4b\u95f4\u7684 w ww \u548c r 2 r2r2 \u64cd\u4f5c\u4e4b\u95f4\u5efa\u7acb happens before \u5173\u7cfb\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a"}),"\n",(0,i.jsx)(e.p,{children:"\u800c happens before \u5173\u7cfb\u53c8\u9690\u542b\u7740\u53ef\u89c1\u6027\uff0c\u6240\u4ee5 w ww \u5199\u7684\u5185\u5bb9\u5bf9\u4e8e r 2 r2r2 \u662f\u53ef\u89c1\u7684\u3002\u7ed3\u5408\u4e0a\u56fe w ww \u5230 r 2 r2r2 \u7684\u5173\u7cfb\u94fe\uff0c\u6211\u4eec\u4e5f\u4e0d\u96be\u7406\u89e3\u4e3a\u4ec0\u4e48\u4e4b\u524d\u8bf4 \u201c\u5bf9\u4e8e\u5f15\u7528\u7c7b\u578b\u7684final\u53d8\u91cf\uff0c\u5176\u4ed6\u7ebf\u7a0b\u81f3\u5c11\u80fd\u591f\u8bfb\u5230\u6784\u9020\u5668\u7ed3\u675f\u65f6\uff0c\u8fd9\u4e2afinal\u7c7b\u578b\u5f15\u7528\u53d8\u91cf\u7684\u6210\u5458\u7684\u72b6\u6001\u201d \u4e86\uff0c\u501f\u52a9\u4e0a\u8ff0\u5173\u7cfb\u540c\u6837\u53ef\u4ee5\u5efa\u7acb\u4fee\u6539final\u5b57\u6bb5\u6210\u5458 \u548c \u8bfb\u53d6final\u5b57\u6bb5\u6210\u5458\u4e4b\u95f4\u7684happens before \u5173\u7cfb\u3002"}),"\n",(0,i.jsxs)(e.ol,{start:"2",children:["\n",(0,i.jsx)(e.li,{children:"\u6709\u5e8f\u6027"}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"\u6ce8\u610f\uff1a\u91cd\u6392\u5e8f\u662f\u9488\u5bf9\u5355\u4e2a\u7ebf\u7a0b\uff08\u5355\u4e2aCPU\uff09\u800c\u8a00\u7684\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u4ee5\u4e0b\u6458\u81ea\u6587\u6863 [2]\uff1a"}),"\n",(0,i.jsx)(e.p,{children:"Loads and Stores of final fields act as \u201cnormal\u201d accesses with respect to locks and volatiles, but impose two additional reordering rules:"}),"\n",(0,i.jsx)(e.p,{children:"\u5bf9final\u5b57\u6bb5\u7684load\u548cstore\u64cd\u4f5c\u548c\u5bf9\u666e\u901a\u5b57\u6bb5\u7684load\u548cstore\u64cd\u4f5c\u51e0\u4e4e\u4e00\u6837\uff0c\u53ea\u4e0d\u8fc7\u9488\u5bf9final\u5b57\u6bb5\u5b58\u5728\u4e0b\u9762\u4e24\u6761\u989d\u5916\u7684\u91cd\u6392\u5e8f\u89c4\u5219\uff1a"}),"\n",(0,i.jsx)(e.p,{children:"\u89c4\u52191"}),"\n",(0,i.jsx)(e.p,{children:"\u3010\u2460 A store of a final field\u3011 (inside a constructor) and, \u3010\u2461 if the field is a reference, any store that this final can reference\u3011, cannot be reordered with \u3010\u2462 a subsequent store (outside that constructor) of the reference to the object holding that field into a variable accessible to other threads\u3011. For example, you cannot reorder\nx.finalField = v; ... ; sharedRef = x;"}),"\n",(0,i.jsx)(e.p,{children:"This comes into play for example when inlining constructors, where \u201c...\u201d spans the logical end of the constructor. You cannot move stores of finals within constructors down below a store outside of the constructor that might make the object visible to other threads. (As seen below, this may also require issuing a barrier). Similarly, you cannot reorder either of the first two with the third assignment in:\nv.afield = 1; x.finalField = v; ... ; sharedRef = x;"}),"\n",(0,i.jsx)(e.p,{children:"\u76f4\u63a5\u770b\u4e0a\u9762\u7684\u8bdd\u6709\u70b9\u96be\u61c2\uff0c\u4e0b\u9762\u4e3e\u4e00\u4e2a\u4f8b\u5b50\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:'class Apple {\nprivate String color;\n\n\tpublic Apple(String color) { this.color = color; }\n}\n\npublic class Test {\nstatic Test instance;\nfinal int a;\nfinal Apple apple;\n\n\tpublic Test() { \n\t\ta = 10;\n\t\tapple = new Apple("red"); \n\t}\n\t\n\tpublic static void init() {\n\t\tinstance = new Test();\n\t}\n}\n'})}),"\n",(0,i.jsx)(e.p,{children:"\u5176\u5b9e\uff0c x.finalField = v; ... ; sharedRef = x; \u4e2d\u7684 x \u5728\u6784\u9020\u5668\u4e2d\u53ef\u4ee5\u7406\u89e3\u4e3a this\uff0c\u5728 init() \u65b9\u6cd5\u4e2d\u53ef\u4ee5\u7406\u89e3\u4e3anew Test() \u8fd4\u56de\u7684\u5bf9\u8c61\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u4e0a\u8ff0\u82f1\u6587\u6587\u6863\u4e2d\uff1a"}),"\n",(0,i.jsx)(e.p,{children:"\u64cd\u4f5c\u2460\u662f\u5728\u6784\u9020\u5668\u4e2d\u5bf9final\u5b57\u6bb5 (\u57fa\u672c\u7c7b\u578b\u548c\u5f15\u7528\u7c7b\u578b) \u7684\u8d4b\u503c\u64cd\u4f5c\uff0c\u5bf9\u5e94a = 10\uff0c\u5b83\u4e0d\u80fd\u548c\u64cd\u4f5c\u2462\u8fdb\u884c\u91cd\u6392\u5e8f\n\u64cd\u4f5c\u2461\u4e5f\u662f\u6307\u6784\u9020\u5668\u4e2d\u7684\u64cd\u4f5c\uff0c\u5728\u2460\u7684\u57fa\u7840\u4e0a\uff0c\u5982\u679cfinal\u5b57\u6bb5\u662f\u4e00\u4e2a\u5f15\u7528\u7c7b\u578b\uff0c\u90a3\u4e48\u6240\u6709\u8fd9\u4e2afinal\u5b57\u6bb5\u5f15\u7528\u5230\u7684store\u64cd\u4f5c\uff0c\u90fd\u4e0d\u80fd\u548c\u64cd\u4f5c\u2462\u91cd\u6392\u5e8f\u3002\u4f8b\u5982\u4e0a\u9762\u4ee3\u7801\u4e2d\u7684 apple \u5c31\u662f\u4e00\u4e2a final \u7c7b\u578b\u5e94\u7528\u53d8\u91cf\uff0c\u90a3\u4e48\u901a\u8fc7apple\u53ef\u4ee5\u5f15\u7528\u5230color\uff0c\u5219\u5bf9apple.color\u7684\u8d4b\u503c\u64cd\u4f5c\u4e0d\u80fd\u548c\u2462\u8fdb\u884c\u91cd\u6392\u5e8f\u3002\n\u64cd\u4f5c\u2462\u662f\u5728\u6784\u9020\u5668\u5916\uff0c\u5c06\u5305\u542bfinal\u5b57\u6bb5\u7684\u5bf9\u8c61\u8d4b\u503c\u7ed9\u4e00\u4e2a\u5176\u4ed6\u7ebf\u7a0b\u53ef\u4ee5\u8bbf\u95ee\u5230\u7684\u53d8\u91cf\u3002\u5728\u4e0a\u8ff0\u4ee3\u7801\u4e2d\uff0c\u4e5f\u5c31\u5bf9\u5e94init()\u65b9\u6cd5\u4e2d\u7684instance = new Test()\uff0c\u56e0\u4e3anew Test()\u5bf9\u8c61\u5305\u542bfinal\u5b57\u6bb5a\uff0c\u4e14\u5b57\u6bb5instance\u53ef\u4ee5\u88ab\u5176\u4ed6\u7ebf\u7a0b\u8bbf\u95ee\u5230\u3002\n\u5b9e\u73b0\u8fd9\u4e00\u6761\u91cd\u6392\u5e8f\u89c4\u5219\u53ef\u4ee5\u901a\u8fc7\u5728\u6784\u9020\u5668\u7ed3\u675f\u4f4d\u7f6e\u63d2\u5165StoreStore\u5c4f\u969c\u6765\u5b9e\u73b0\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u89c4\u52192\nThe initial load (i.e., the very first encounter by a thread) of a final field cannot be reordered with the initial load of the reference to the object containing the final field. This comes into play in:\nx = sharedRef; ... ; i = x.finalField;\nA compiler would never reorder these since they are dependent, but there can be consequences of this rule on some processors."}),"\n",(0,i.jsx)(e.p,{children:"\u518d\u770b\u4e2a\u4f8b\u5b50\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"public class Test {\nstatic Test instance;\nfinal int a;\n\n\tpublic Test() { a = 10; }\n\t\n\tpublic static void init() {\n\t\tinstance = new Test();\n\t}\n\t\n\tpublic static void read() {\n\t\tif (obj != null) {\n\t\t\tSystem.out.println(obj.a);\n\t\t}\n\t}\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u8fd9\u6761\u89c4\u5219\u7684\u610f\u601d\u662f\uff0c\u901a\u8fc7\u5bf9\u8c61\u8bbf\u95ee\u5176final\u5b57\u6bb5(obj.a)\u8fd9\u4e00\u64cd\u4f5c \u548c \u8be5\u64cd\u4f5c\u4e4b\u524d\u7b2c\u4e00\u6b21\u8bbf\u95ee\u8be5\u5bf9\u8c61\u7684\u64cd\u4f5c (if (obj != null)\u4e2d\u8bfb\u53d6obj\u7684\u64cd\u4f5c) \u662f\u4e0d\u80fd\u91cd\u6392\u5e8f\u7684\u3002"}),"\n",(0,i.jsx)(e.p,{children:"Java\u7f16\u8bd1\u5668\u4e0d\u4f1a\u5bf9\u4e0d\u4f1a\u5bf9\u4e0a\u8ff0\u4e24\u4e2a\u64cd\u4f5c\u8fdb\u884c\u91cd\u6392\u5e8f\uff0c\u56e0\u4e3a\u5bf9\u7f16\u8bd1\u5668\u6765\u8bf4\u8fd9\u4e24\u4e2a\u64cd\u4f5c(load(x)\u548cload(x.field))\u4e4b\u95f4\u5b58\u5728\u4f9d\u8d56\u3002\u4f46\u662f\u5bf9\u4e8e\u5904\u7406\u5668\u6765\u8bf4\uff0c\u5b83\u4fe9\u90fd\u662fload\u64cd\u4f5c\uff0c\u6240\u4ee5\u5728\u5141\u8bb8LoadLoad\u91cd\u6392\u5e8f\u7684\u5904\u7406\u5668\u4e0a\uff0c\u8fd9\u4e24\u4e2a\u64cd\u4f5c\u662f\u53ef\u80fd\u88ab\u91cd\u6392\u5e8f\u7684\uff0c\u6b64\u65f6\u5c31\u9700\u8981\u52a0\u4e0aLoadLoad\u5c4f\u969c\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u603b\u7ed3\nfinal\u5b57\u6bb5\u7684\u91cd\u6392\u5e8f\u89c4\u5219\u603b\u7ed3\u5982\u4e0b\uff1a"}),"\n",(0,i.jsx)(e.p,{children:"\u6784\u9020\u5668\u5185final\u5b57\u6bb5\u7684\u5199 \u548c \u6784\u9020\u5668\u5916\u5c06\u5305\u542b\u8be5final\u5b57\u6bb5\u7684\u5bf9\u8c61\u8d4b\u503c\u7ed9\u4e00\u4e2a\u5176\u4ed6\u7ebf\u7a0b\u80fd\u8bbf\u95ee\u5230\u7684\u53d8\u91cf \u8fd9\u4e24\u4e2a\u64cd\u4f5c\u4e0d\u80fd\u91cd\u6392\u5e8f\n\u52a0\u5165final\u5b57\u6bb5\u662f\u4e00\u4e2a\u5f15\u7528\u7c7b\u578b\uff0c\u90a3\u4e48\u6784\u9020\u5668\u5185\u5bf9\u8be5final\u5f15\u7528\u7c7b\u578b\u5b57\u6bb5\u7684\u6210\u5458\u7684\u5199 \u548c \u6784\u9020\u5668\u5916\u5c06\u5305\u542b\u8be5final\u5b57\u6bb5\u7684\u5bf9\u8c61\u8d4b\u503c\u7ed9\u4e00\u4e2a\u5176\u4ed6\u7ebf\u7a0b\u80fd\u8bbf\u95ee\u5230\u7684\u53d8\u91cf \u8fd9\u4e24\u4e2a\u64cd\u4f5c\u4e4b\u95f4\u4e0d\u80fd\u91cd\u6392\u5e8f\n\u6784\u9020\u5668\u5916\uff0c\u5bf9\u4e8e\u5305\u542bfinal\u5b57\u6bb5\u7684\u5bf9\u8c61\u7684\u8bfb \u548c \u5bf9final\u5b57\u6bb5\u7684\u6210\u5458\u7684\u8bfb \u4e0d\u80fd\u91cd\u6392\u5e8f"}),"\n",(0,i.jsx)(e.h2,{id:"\u56dbhotspot-vm\u4e2d\u5bf9final\u5185\u5b58\u8bed\u4e49\u7684\u5b9e\u73b0",children:"\u56db\u3001HotSpot VM\u4e2d\u5bf9final\u5185\u5b58\u8bed\u4e49\u7684\u5b9e\u73b0"}),"\n",(0,i.jsx)(e.p,{children:"[3] \u5728HotSpot\u6e90\u7801\u7684 parse1.cpp \u4e2d\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"//------------------------------do_exits---------------------------------------\nvoid Parse::do_exits() {\n// ...\nif (method()->is_initializer() &&\n(wrote_final() ||\nPPC64_ONLY(wrote_volatile() ||)\n(AlwaysSafeConstructors && wrote_fields()))) {\n_exits.insert_mem_bar(Op_MemBarRelease, alloc_with_final());\n// ...\ndo_exists() \u51fd\u6570\u5728\u6784\u9020\u5668\u9000\u51fa\u65f6\u4f1a\u6267\u884c\uff0c\u663e\u7136\u5b83\u4f1a\u4f7f\u7528 wrote_final() \u5224\u65ad\u6784\u9020\u5668\u5185\u662f\u4e0d\u662f\u5b58\u5728final\u7c7b\u578b\u7684\u5199\uff0c\u5982\u679c\u662f\u7684\u8bdd\uff0c\u5219\u63d2\u5165\u4e00\u4e2a\u5185\u5b58\u5c4f\u969c Op_MemBarRelease\uff0c\u8fd9\u4e2a\u5c4f\u969c\u5b9e\u9645\u4e0a\u5bf9\u5e94 LoadStore \u548c StoreStore\u3002\u63d2\u5165 LoadStore \u5c4f\u969c\u662f\u4e3a\u4e86\u7167\u987e\u8fd9\u6837\u4e00\u79cd\u7279\u6b8a\u60c5\u51b5\uff1afinal \u5b57\u6bb5\u7684\u503c\u4f9d\u8d56\u4e8e\u53e6\u5916\u7684\u5b57\u6bb5\u3002\u4f8b\u5982x.finalField = x.normalField + 1; ...; sharedRef = x;\uff0c\u8fd9\u91cc\u63d2\u5165LoadStore \u5c31\u662f\u4e3a\u4e86\u9632\u6b62\u5bf9 x.normalField \u7684\u8bfb\u64cd\u4f5c\u548csharedRef = x \u53d1\u751f\u91cd\u6392\u5e8f\u3002\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u603b\u7ed3\nfinal\u5173\u952e\u5b57\u7684\u5185\u5b58\u8bed\u4e49\u76f8\u8f83\u4e8evolatile\u7b49\u5173\u952e\u5b57\u8fd8\u662f\u5f88\u96be\u7406\u89e3\u7684\uff0c\u4ee5\u4e0a\u7684\u5185\u5bb9\u5982\u6709\u8868\u8ff0\u4e0d\u6070\u5f53\u4e4b\u5904\u8fd8\u8bf7\u6307\u6b63\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u603b\u7ed3\nfinal\u5173\u952e\u5b57\u7684\u5185\u5b58\u8bed\u4e49\u76f8\u8f83\u4e8evolatile\u7b49\u5173\u952e\u5b57\u8fd8\u662f\u5f88\u96be\u7406\u89e3\u7684\uff0c\u4ee5\u4e0a\u7684\u5185\u5bb9\u5982\u6709\u8868\u8ff0\u4e0d\u6070\u5f53\u4e4b\u5904\u8fd8\u8bf7\u6307\u6b63\u3002"}),"\n",(0,i.jsx)(e.h1,{id:"\u53c2\u8003\u6587\u732e",children:"\u53c2\u8003\u6587\u732e"}),"\n",(0,i.jsx)(e.p,{children:"Java Concurrency in Practice"}),"\n",(0,i.jsx)(e.p,{children:"JSR 133 (Java Memory Model) FAQ"}),"\n",(0,i.jsx)(e.p,{children:"Java Concurrency in Practice"}),"\n",(0,i.jsx)(e.p,{children:"The JSR-133 Cookbook for Compiler Writers\nIntel\xae 64 and IA-32 ArchitecturesvSoftware Developer\u2019s Manual Volume 3A: System Programming Guide, Part 1"})]})}function h(n={}){const{wrapper:e}={...(0,a.a)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(d,{...n})}):d(n)}},88672:(n,e,t)=>{t.d(e,{Z:()=>l,a:()=>o});var i=t(50959);const a={},r=i.createContext(a);function o(n){const e=i.useContext(r);return i.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function l(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(a):n.components||a:o(n.components),i.createElement(r.Provider,{value:e},n.children)}}}]);