"use strict";(self.webpackChunkcode_note_blog=self.webpackChunkcode_note_blog||[]).push([[4225],{91718:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>a,metadata:()=>s,toc:()=>c});var t=r(11527),i=r(88672);const a={},o="\u53c2\u8003\u6587\u7ae0",s={id:"Spring\u5168\u5bb6\u6876/SpringCloud\u6e90\u7801\u5206\u6790/SpringCloudRibbon\u6e90\u7801\u5206\u6790",title:"SpringCloudRibbon\u6e90\u7801\u5206\u6790",description:"\u5b66\u4e60\u76ee\u6807",source:"@site/docs/Spring\u5168\u5bb6\u6876/SpringCloud\u6e90\u7801\u5206\u6790/SpringCloudRibbon\u6e90\u7801\u5206\u6790.md",sourceDirName:"Spring\u5168\u5bb6\u6876/SpringCloud\u6e90\u7801\u5206\u6790",slug:"/Spring\u5168\u5bb6\u6876/SpringCloud\u6e90\u7801\u5206\u6790/SpringCloudRibbon\u6e90\u7801\u5206\u6790",permalink:"/code-note-blog/docs/Spring\u5168\u5bb6\u6876/SpringCloud\u6e90\u7801\u5206\u6790/SpringCloudRibbon\u6e90\u7801\u5206\u6790",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Spring\u5168\u5bb6\u6876/SpringCloud\u6e90\u7801\u5206\u6790/SpringCloudRibbon\u6e90\u7801\u5206\u6790.md",tags:[],version:"current",frontMatter:{},sidebar:"spring",previous:{title:"SpringCloudOpenFeign\u6e90\u7801\u5206\u6790",permalink:"/code-note-blog/docs/Spring\u5168\u5bb6\u6876/SpringCloud\u6e90\u7801\u5206\u6790/SpringCloudOpenFeign\u6e90\u7801\u5206\u6790"},next:{title:"SpringCloudAlibaba\u6982\u89c8",permalink:"/code-note-blog/docs/Spring\u5168\u5bb6\u6876/SpringCloudAlibaba/SpringCloudAlibaba\u6982\u89c8"}},l={},c=[];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"\u5b66\u4e60\u76ee\u6807"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"\u63a8\u5bfcRibbon\u7684\u6838\u5fc3\u6d41\u7a0b"}),"\n",(0,t.jsx)(n.li,{children:"\u624b\u5199\u4e00\u4e2a\u7b80\u6613\u7248\u7684Ribbon"}),"\n",(0,t.jsxs)(n.li,{children:["\u901a\u8fc7\u6e90\u7801\u9a8c\u8bc1\u63a8\u5bfc\u7684\u6d41\u7a0b\n",(0,t.jsx)(n.strong,{children:"\u7b2c1\u7ae0 \u6838\u5fc3\u6d41\u7a0b\u63a8\u5bfc"}),"\n\u5176\u5b9eRibbon\u7684\u6838\u5fc3\u6d41\u7a0b\u5f88\u7b80\u5355\uff0c\u6211\u4eec\u5728\u4f7f\u7528\u8fc7\u7a0b\u4e2d\u65e0\u975e\u5c31\u662f\u5f15\u5165\u4e86\u4e00\u4e2aspring-cloud-starter-netflix-ribbon\u7684jar\u5305\uff0c\u7136\u540e\u5728\u7a0b\u5e8f\u542f\u52a8\u7684\u65f6\u5019\u6ce8\u5165\u4e86\u4e00\u4e2aRestTemplate\u5bf9\u8c61\uff0c\u5728\u8be5\u5bf9\u8c61\u4e0a\u9762\u589e\u52a0\u4e86\u4e00\u4e2a@LoadBalanced\u6ce8\u89e3\uff0c\u7136\u540e\u5728\u901a\u8fc7RestTemplate\u5bf9\u8c61\u53bb\u8c03\u7528URL\u7684\u65f6\u5019\u5c31\u80fd\u6839\u636e\u4e0d\u540c\u7684\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u53bb\u8c03\u4e0d\u540c\u7684\u670d\u52a1\uff0c\u90a3\u8fd9\u4e2a\u6ce8\u89e3\uff0c\u6216\u8005\u8bf4\u8fd9\u4e2ajar\u5305\u5230\u5e95\u505a\u4e86\u4ec0\u4e48\u4e8b\u60c5\u5462\uff1f"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"\u9996\u5148\u6211\u4eec\u8981\u660e\u767d\uff0cspring-cloud-starter-netflix-ribbon\u8fd9\u4e2ajar\u5305\u4ece\u540d\u5b57\u4e0a\u6765\u770b\u5c31\u77e5\u9053\uff0c\u5b83\u662f\u57fa\u4e8estarter\u7ec4\u4ef6\u7684\uff0c\u90a3\u5b83\u80af\u5b9a\u662f\u4f9d\u636espringboot\u7684\u81ea\u52a8\u88c5\u914d\u539f\u7406\uff0c\u5728\u5bb9\u5668\u542f\u52a8\u7684\u65f6\u5019\u63d0\u4f9b\u4e86\u4e00\u4e2a\u81ea\u52a8\u914d\u7f6e\u7c7b\uff0c\u5c06\u6211\u4eec\u6240\u9700\u8981\u7528\u7684\u5bf9\u8c61\u6ce8\u5165\u5230IoC\u5bb9\u5668\u91cc\u9762\u53bb\u4e86\uff0c\u8fd9\u70b9\u6bcb\u5eb8\u7f6e\u7591\u3002"}),"\n",(0,t.jsx)(n.p,{children:"\u7136\u540e\u5f53\u8981\u7528RestTemplate\u5bf9\u8c61\u53bb\u8bf7\u6c42\u76ee\u6807\u670d\u52a1\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u65f6\u5019\uff0c\u6211\u4eec\u80af\u5b9a\u662f\u8981\u7528\u771f\u5b9e\u7684IP\u548c\u7aef\u53e3\u6765\u66ff\u6362\u670d\u52a1\u540d\u3002\u8fd9\u4e00\u6b65\u5176\u5b9e\u5c31\u662f\u6838\u5fc3\u6b65\u9aa4\uff0c\u5b83\u8981\u600e\u4e48\u505a\u5462\uff1f\u600e\u4e48\u5728\u771f\u6b63\u8bf7\u6c42\u4e4b\u524d\u5c06\u5730\u5740\u548c\u7aef\u53e3\u72f8\u732b\u6362\u592a\u5b50\u6362\u6210\u771f\u5b9e\u7684\u5462\uff1f"}),"\n",(0,t.jsx)(n.p,{children:"\u5728\u6211\u4eec\u65e5\u5e38\u5f00\u53d1\u4e2d\uff0c\u6211\u4eec\u5e94\u8be5\u77e5\u9053\uff0c\u6709\u4e00\u4e2a\u8fc7\u6ee4\u5668\u548c\u4e00\u4e2a\u62e6\u622a\u5668\u5176\u5b9e\u53ef\u4ee5\u505a\u5230\u8fd9\u4e2a\u64cd\u4f5c\uff0c\u5bf9\u5427\uff0c\u6240\u4ee5\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f\u5728\u83b7\u53d6RestTemplate\u5bf9\u8c61\u7684\u65f6\u5019\uff0c\u5c06\u8be5\u5bf9\u8c61\u91cc\u9762\u6dfb\u52a0\u4e86\u4e00\u4e2a\u62e6\u622a\u5668\uff0c\u5f53RestTemplate\u5bf9\u8c61\u6267\u884c\u67d0\u4e2a\u65b9\u6cd5\u7684\u65f6\u5019\uff0c\u90fd\u4f1a\u53bb\u62e6\u622a\u5668\u91cc\u9762\u6267\u884c\u4e00\u904d\u3002\u7136\u540e\u5c31\u5b8c\u4e8b\u4e86\u3002"}),"\n",(0,t.jsxs)(n.p,{children:["\u5177\u4f53\u7684\u6d41\u7a0b\u56fe\u63a8\u5bfc\u5982\u4e0b\uff1a",(0,t.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/1790fb324161913dd79098940f8102d652cd86.jpg",alt:"SpringCloud\u7cfb\u5217\u2014Ribbon\u6e90\u7801\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud\u7cfb\u5217\u2014Ribbon\u6e90\u7801\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),(0,t.jsx)(n.strong,{children:"\u7b2c2\u7ae0 \u7b80\u6613\u7248Ribbon\u5b9e\u73b0"}),"\n\u6839\u636e\u4e0a\u9762\u7684\u63a8\u5bfc\u8fc7\u7a0b\uff0c\u6211\u4eec\u63a5\u4e0b\u6765\u6765\u5b9e\u73b0\u4e00\u4e2a\u7b80\u6613\u7248\u7684Ribbon\u3002"]}),"\n",(0,t.jsx)(n.p,{children:"\u5177\u4f53\u7684\u6b65\u9aa4\u6211\u4eec\u8981\u6709\u6e05\u6670\u7684\u601d\u8def\uff1a"}),"\n",(0,t.jsx)(n.p,{children:"1.\u9996\u5148\u8981\u5b9e\u73b0\u4e00\u4e2astarter\u7ec4\u4ef6\uff0c\u96c6\u6210\u6211\u4eecspringboot\uff0c\u8ba9springboot\u5728\u542f\u52a8\u7684\u65f6\u5019\u53ef\u4ee5\u62ff\u5230\u76f8\u5e94\u7684RestTemplate\u7684bean\u5bf9\u8c61\u3002\u521b\u5efa\u4e00\u4e2aMaven\u7684quickstart\u9879\u76ee"}),"\n",(0,t.jsx)(n.p,{children:"2.\u7136\u540e\u5f15\u5305"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'<?xml version="1.0" encoding="UTF-8"?>\n\n<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">\n  <modelVersion>4.0.0</modelVersion>\n\n  <groupId>com.example</groupId>\n  myribbon-spring-cloud-starter\n  <version>1.0-SNAPSHOT</version>\n\n  <name>myribbon-spring-cloud-starter</name>\n  \x3c!-- FIXME change it to the project\'s website --\x3e\n  <url>http://www.example.com</url>\n\n  <properties>\n    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>\n    <maven.compiler.source>1.8</maven.compiler.source>\n    <maven.compiler.target>1.8</maven.compiler.target>\n    <spring-boot.version>2.3.2.RELEASE</spring-boot.version>\n  </properties>\n\n  \x3c!-- RestTemplate\u5fc5\u987b\u8981\u7528\u5230SpringMVC --\x3e\n  <dependencies>\n    <dependency>\n      <groupId>org.springframework.boot</groupId>\n      spring-boot-starter-web\n      <version>${spring-boot.version}</version>\n    </dependency>\n\n    <dependency>\n      <groupId>org.springframework.boot</groupId>\n      spring-boot-starter-test\n      <version>${spring-boot.version}</version>\n    </dependency>\n\n    \x3c!-- \u8fd9\u4e2a\u5305\u91cc\u9762\u96c6\u6210\u4e86\u4e00\u4e9b\u6838\u5fc3\u63a5\u53e3 --\x3e\n    <dependency>\n      <groupId>org.springframework.cloud</groupId>\n      spring-cloud-commons\n      <version>2.2.6.RELEASE</version>\n    </dependency>\n  </dependencies>\n\n  <build>\n    <pluginManagement>\x3c!-- lock down plugins versions to avoid using Maven defaults (may be moved to parent pom) --\x3e\n      <plugins>\n        \x3c!-- clean lifecycle, see https://maven.apache.org/ref/current/maven-core/lifecycles.html#clean_Lifecycle --\x3e\n        <plugin>\n          maven-clean-plugin\n          <version>3.1.0</version>\n        </plugin>\n        \x3c!-- default lifecycle, jar packaging: see https://maven.apache.org/ref/current/maven-core/default-bindings.html#Plugin_bindings_for_jar_packaging --\x3e\n        <plugin>\n          maven-resources-plugin\n          <version>3.0.2</version>\n        </plugin>\n        <plugin>\n          maven-compiler-plugin\n          <version>3.8.0</version>\n        </plugin>\n        <plugin>\n          maven-surefire-plugin\n          <version>2.22.1</version>\n        </plugin>\n        <plugin>\n          maven-jar-plugin\n          <version>3.0.2</version>\n        </plugin>\n        <plugin>\n          maven-install-plugin\n          <version>2.5.2</version>\n        </plugin>\n        <plugin>\n          maven-deploy-plugin\n          <version>2.8.2</version>\n        </plugin>\n        \x3c!-- site lifecycle, see https://maven.apache.org/ref/current/maven-core/lifecycles.html#site_Lifecycle --\x3e\n        <plugin>\n          maven-site-plugin\n          <version>3.7.1</version>\n        </plugin>\n        <plugin>\n          maven-project-info-reports-plugin\n          <version>3.0.0</version>\n        </plugin>\n      </plugins>\n    </pluginManagement>\n  </build>\n</project>\n'})}),"\n",(0,t.jsx)(n.p,{children:"3.\u521b\u5efa\u914d\u7f6e\u7c7b"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"@Configuration\npublic class MyRibbonAutoConfiguration {\n    //\u7b80\u6613\u7248\u7684Ribbon\u662f\u9760\u8fd9\u4e2a\u7c7b\u53bb\u5b8c\u6210\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u4ee5\u53ca\u771f\u5b9e\u7684ip\u548c\u7aef\u53e3\u66ff\u6362\u7684\n    @Bean\n    public LoadBalancerClient loadBalancerClient(){\n        return new MyLoadBalancerClient();\n    }\n    //\u6536\u96c6\u6240\u6709\u5e26MyLoadBalanced\u6ce8\u89e3\u7684RestTemplate\u5bf9\u8c61\n    @MyLoadBalanced\n    @Autowired(required = false)\n    private List<RestTemplate> restTemplates = Collections.emptyList();\n    @Bean\n    @ConditionalOnMissingBean\n    public LoadBalancerRequestFactory loadBalancerRequestFactory(\n            LoadBalancerClient loadBalancerClient) {\n        return new LoadBalancerRequestFactory(loadBalancerClient);\n    }\n    //\u8fd9\u5c31\u662f\u6838\u5fc3\u7684\u62e6\u622a\u5668\n    @Bean\n    public MyLoadBalancerInterceptor myLoadBalancerInterceptor(\n            LoadBalancerClient loadBalancerClient,\n            LoadBalancerRequestFactory requestFactory){\n        return new MyLoadBalancerInterceptor(loadBalancerClient,requestFactory);\n    }\n    //\u6536\u96c6\u5230\u7684RestTemplate\u5bf9\u8c61\uff0c\u5728\u8fd9\u91cc\u90fd\u4f1a\u914d\u7f6e\u4e00\u4e2a\u62e6\u622a\u5668\n    @Bean\n    public SmartInitializingSingleton smartInitializingSingleton(\n            final MyLoadBalancerInterceptor myLoadBalancerInterceptor){\n        return ()->{\n            for (RestTemplate restTemplate : MyRibbonAutoConfiguration.this.restTemplates) {\n                List<ClientHttpRequestInterceptor> list = new ArrayList<>(\n                        restTemplate.getInterceptors());\n                list.add(myLoadBalancerInterceptor);\n                restTemplate.setInterceptors(list);\n            }\n        };\n    }\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"4.\u521b\u5efaMyLoadBalancerClient"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'public class MyLoadBalancerClient implements LoadBalancerClient {\n    @Autowired\n    AbstractEnvironment environment;\n    //1.\u5728\u62e6\u622a\u5668\u91cc\u9762\u4f1a\u8c03\u7528\u8fd9\u4e2a\u65b9\u6cd5\n    @Override\n    public <T> T execute(String serviceId, LoadBalancerRequest<T> request) throws IOException {\n        ServiceInstance server = this.choose(serviceId);\n        return execute(serviceId, server, request);\n    }\t\n    //3.\u771f\u6b63\u6267\u884cHttp\u8bf7\u6c42\n    @Override\n    public <T> T execute(String serviceId, ServiceInstance serviceInstance, LoadBalancerRequest<T> request) throws IOException {\n        T returnVal = null;\n        try {\n            returnVal = request.apply(serviceInstance);\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n        return returnVal;\n    } \n\t//4.\u8fd9\u4e00\u6b65\u5c31\u662f\u7528\u771f\u5b9e\u7684ip\u548cport\u66ff\u6362\u670d\u52a1\u540d\n    @Override\n    public URI reconstructURI(ServiceInstance instance, URI original) {\n        String host = instance.getHost();\n        int port = instance.getPort();\n        if (host.equals(original.getHost())\n                && port == original.getPort()\n                ) {\n            return original;\n        }\n        try {\n            StringBuilder sb = new StringBuilder();\n            sb.append("http").append("://");\n            if (!Strings.isNullOrEmpty(original.getRawUserInfo())) {\n                sb.append(original.getRawUserInfo()).append("@");\n            }\n            sb.append(host);\n            if (port >= 0) {\n                sb.append(":").append(port);\n            }\n            sb.append(original.getRawPath());\n            if (!Strings.isNullOrEmpty(original.getRawQuery())) {\n                sb.append("?").append(original.getRawQuery());\n            }\n            if (!Strings.isNullOrEmpty(original.getRawFragment())) {\n                sb.append("#").append(original.getRawFragment());\n            }\n            URI newURI = new URI(sb.toString());\n            return newURI;\n        }catch (URISyntaxException e){\n            throw new RuntimeException(e);\n        }\n    }\n    //2.\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u5728\u8fd9\u4e00\u6b65\u8fdb\u884c\u670d\u52a1\u7684ip\u548c\u7aef\u53e3\u9009\u62e9\uff0c\u6211\u8fd9\u91cc\u7528\u7684\u662f\u968f\u673a\u7b97\u6cd5\n    @Override\n    public ServiceInstance choose(String serviceId) {\n        Server instance = new Server(serviceId,null,"127.0.0.1",8080);\n        String sr = environment.getProperty(serviceId+".ribbon.listOfServers");\n        if (!StringUtils.isEmpty(sr)){\n            String[] arr = sr.split(",",-1);\n            Random selector = new Random();\n            int next = selector.nextInt(arr.length);\n            String a = arr[next];\n            String[] srr = a.split(":",-1);\n            instance.setHost(srr[0]);\n            instance.setPort(Integer.parseInt(srr[1]));\n        }\n        return instance;\n    }\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"5.\u62e6\u622a\u5668\u7684\u903b\u8f91\u5176\u5b9e\u5f88\u7b80\u5355\uff0c\u5c31\u662f\u5728\u771f\u6b63\u53d1\u9001http\u8bf7\u6c42\u4e4b\u524d\u5148\u6765\u6267\u884c\u6211\u7684\u903b\u8f91"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"public class MyLoadBalancerInterceptor implements ClientHttpRequestInterceptor {\n    private LoadBalancerClient loadBalancerClient;\n    private LoadBalancerRequestFactory requestFactory;\n    public MyLoadBalancerInterceptor(LoadBalancerClient loadBalancerClient,\n                                   LoadBalancerRequestFactory requestFactory) {\n        this.loadBalancerClient = loadBalancerClient;\n        this.requestFactory = requestFactory;\n    }\n    @Override\n    public ClientHttpResponse intercept(HttpRequest request, byte[] body, ClientHttpRequestExecution execution) throws IOException {\n        final URI originalUri = request.getURI();\n        String serviceName = originalUri.getHost();\n        return this.loadBalancerClient.execute(serviceName,\n                this.requestFactory.createRequest(request, body, execution));\n    }\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"6.\u5b9a\u4e49\u81ea\u5df1\u7684\u6ce8\u89e3"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"@Target({ ElementType.FIELD, ElementType.PARAMETER, ElementType.METHOD })\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Inherited\n@Qualifier\npublic @interface MyLoadBalanced {\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"7.\u5b9a\u4e49\u4e00\u4e2a\u81ea\u5df1\u7684Server\u5b9e\u4f53\u7c7b"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"public class Server implements ServiceInstance {\n    private String serviceId;\n    private String instanceId;\n    private String host;\n    private int port;\n    public Server(String serviceId, String instanceId, String host, int port) {\n        this.serviceId = serviceId;\n        this.instanceId = instanceId;\n        this.host = host;\n        this.port = port;\n    }\n    public Server() {\n    }\n    public void setServiceId(String serviceId) {\n        this.serviceId = serviceId;\n    }\n    public void setInstanceId(String instanceId) {\n        this.instanceId = instanceId;\n    }\n    public void setHost(String host) {\n        this.host = host;\n    }\n    public void setPort(int port) {\n        this.port = port;\n    }\n    @Override\n    public String getInstanceId() {\n        return null;\n    }\n    @Override\n    public String getServiceId() {\n        return null;\n    }\n    @Override\n    public String getHost() {\n        return host;\n    }\n    @Override\n    public int getPort() {\n        return port;\n    }\n    @Override\n    public boolean isSecure() {\n        return false;\n    }\n    @Override\n    public URI getUri() {\n        return null;\n    }\n    @Override\n    public Map<String, String> getMetadata() {\n        return null;\n    }\n    @Override\n    public String getScheme() {\n        return null;\n    }\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"8.\u5199spring.factories\u6587\u4ef6"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"org.springframework.boot.autoconfigure.EnableAutoConfiguration=\\\n    com.example.config.MyRibbonAutoConfiguration\n"})}),"\n",(0,t.jsx)(n.p,{children:"9.\u6253\u6210jar\u5305\uff0c\u6d4b\u8bd5\uff0c\u6d4b\u8bd5\u7684\u65f6\u5019\uff0c\u9700\u8981\u52a0\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"<serverName>.ribbon.listOfServers=127.0.0.1:2223,127.0.0.1:2222\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"\u7b2c3\u7ae0 \u6e90\u7801\u9a8c\u8bc1"}),"\n",(0,t.jsx)(n.strong,{children:"3.1 @LoadBalanced"}),"\n\u4ece\u4e0a\u8282\u8bfe\u7684\u4ee3\u7801\u770b\uff0c\u6211\u4eec\u53ea\u662f\u5728RestTemplate\u4e0a\u9762\u52a0\u4e86\u4e00\u4e2a@LoadBalance,\u5c31\u53ef\u4ee5\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\u4e86\uff0c\u53ef\u662f\u6211\u4eec\u70b9\u51fb\u8fdb\u5165@LoadBalance\u770b\u4e86\u4e00\u4e0b\uff0c\u5728\u8fd9\u4e2a\u6ce8\u89e3\u91cc\u9762\u6709\u4e00\u4e2a@Qualifier\u6ce8\u89e3\u3002\u8be5\u6ce8\u89e3\u9650\u5b9a\u54ea\u4e2abean\u5e94\u8be5\u88ab\u81ea\u52a8\u6ce8\u5165\u3002\u5f53Spring\u65e0\u6cd5\u5224\u65ad\u51fa\u54ea\u4e2abean\u5e94\u8be5\u88ab\u6ce8\u5165\u65f6\uff0c@Qualifier\u6ce8\u89e3\u6709\u52a9\u4e8e\u6d88\u9664\u6b67\u4e49bean\u7684\u81ea\u52a8\u6ce8\u5165\uff0c\u4f8b\u5b50\u89c1\u4ee3\u7801\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"/**\n * Annotation to mark a RestTemplate or WebClient bean to be configured to use a\n * LoadBalancerClient.\n * @author Spencer Gibb\n */\n@Target({ ElementType.FIELD, ElementType.PARAMETER, ElementType.METHOD })\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Inherited\n@Qualifier\npublic @interface LoadBalanced {\n\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u4ece\u6ce8\u91ca\u4e2d\u53ef\u4ee5\u77e5\u9053\uff0c\u8fd9\u4e2a\u6ce8\u89e3\u662f\u7528\u6765\u7ed9RestTemplate\u505a\u6807\u8bb0\uff0c\u4ee5\u4f7f\u7528\u8d1f\u8f7d\u5747\u8861\u5ba2\u6237\u7aef\uff08LoadBalancerClient\uff09\u6765\u914d\u7f6e\u5b83\u3002\u6240\u4ee5\uff0c\u6211\u4eec\u5728\u751f\u6210\u7684RestTemplate\u7684bean\u4e0a\u6dfb\u52a0\u8fd9\u4e48\u4e00\u4e2a\u6ce8\u89e3\uff0c\u8fd9\u4e2abean\u5c31\u4f1a\u914d\u7f6eLoadBalancerClient\u3002"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"3.2 LoadBalancerClient"}),"\n\u90a3\u4e48\uff0c\u5c31\u518d\u770b\u4e0bLoadBalancerClient\u7684\u4ee3\u7801\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"public interface LoadBalancerClient extends ServiceInstanceChooser {\n\t<T> T execute(String serviceId, LoadBalancerRequest<T> request) throws IOException;\n\t<T> T execute(String serviceId, ServiceInstance serviceInstance,\n\t\t\tLoadBalancerRequest<T> request) throws IOException;\n\tURI reconstructURI(ServiceInstance instance, URI original);\n}\npublic interface ServiceInstanceChooser {\n\tServiceInstance choose(String serviceId);\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"LoadBalancerClient\u662f\u4e00\u4e2a\u63a5\u53e3\uff0c\u91cc\u9762\u6709\u4e09\u4e2a\u65b9\u6cd5\u3002"}),"\n",(0,t.jsxs)(n.p,{children:["ServiceInstance choose(String serviceId);\u4ece\u65b9\u6cd5\u540d\u4e0a\u5c31\u53ef\u4ee5\u770b\u51fa\uff0c\u662f\u6839\u636e\u4f20\u5165\u7684serviceId\uff08\u670d\u52a1\u540d\uff09\uff0c\u4ece\u8d1f\u8f7d\u5747\u8861\u5668\u4e2d\u9009\u62e9\u4e00\u4e2a\u670d\u52a1\u5b9e\u4f8b\uff0c\u670d\u52a1\u5b9e\u4f8b\u901a\u8fc7ServiceInstance\u7c7b\u6765\u8868\u793a\u3002\nexecute\u65b9\u6cd5\uff0c\u4f7f\u7528\u4ece\u8d1f\u8f7d\u5747\u8861\u5668\u4e2d\u9009\u62e9\u7684\u670d\u52a1\u5b9e\u4f8b\u6765\u6267\u884c\u8bf7\u6c42\u5185\u5bb9\u3002\nURI reconstructURI(ServiceInstance instance, URI original);\u65b9\u6cd5\uff0c\u662f\u91cd\u65b0\u6784\u5efa\u4e00\u4e2aURI\u7684\uff0c\u8fd8\u8bb0\u5f97\u6211\u4eec\u5728\u4ee3\u7801\u4e2d\uff0c\u901a\u8fc7RestTemplate\u8bf7\u6c42\u670d\u52a1\u65f6\uff0c\u5199\u7684\u662f\u670d\u52a1\u540d\u5427\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u5c31\u4f1a\u628a\u8fd9\u4e2a\u8bf7\u6c42\u7684URI\u8fdb\u884c\u8f6c\u6362\uff0c\u8fd4\u56dehost+port\uff0c\u901a\u8fc7host+port\u7684\u5f62\u5f0f\u53bb\u8bf7\u6c42\u670d\u52a1\u3002\n",(0,t.jsx)(n.strong,{children:"3.3 \u81ea\u52a8\u88c5\u914d"}),"\n\u5f53springboot\u542f\u52a8\u4e4b\u540e\uff0c\u4f1a\u901a\u8fc7\u81ea\u52a8\u88c5\u914d\u81ea\u52a8\u53bb\nspring-cloud-netflix-ribbon\u8fd9\u4e2ajar\u5305\u7684META-INF\u76ee\u5f55\u627espring.factories\u6587\u4ef6\uff0c\u5e76\u4e14\u5c06RibbonAutoConfiguration\u914d\u7f6e\u7c7b\u8fdb\u884c\u6ce8\u5165\u3002\u800c\u5728RibbonAutoConfiguration\u914d\u7f6e\u7c7b\u4e2d\u56e0\u4e3a\u5b58\u5728@AutoConfigureBefore\u6ce8\u89e3\uff0c\u6240\u4ee5\u53c8\u4f1a\u52a0\u8f7dLoadBalancerAutoConfiguration\u914d\u7f6e\u7c7b\u3002\u5728LoadBalancerAutoConfiguration\u7c7b\u4e2d\uff0cspring\u5bb9\u5668\u4f1a\u5c06\u6240\u6709\u88ab@LoadBalance\u6ce8\u89e3\u4fee\u9970\u7684bean\u6ce8\u5165\u5230IOC\u5bb9\u5668\u4e2d"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"@LoadBalanced\n@Autowired(required = false)\nprivate List<RestTemplate> restTemplates = Collections.emptyList();\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u540c\u65f6\uff0c\u5728LoadBalancerAutoConfiguration\u914d\u7f6e\u7c7b\u4e2d\u8fd8\u4f1a\u4e3a\u6bcf\u4e2aRestTemplate\u5b9e\u4f8b\u6dfb\u52a0LoadBalancerInterceptor\u62e6\u622a\u5668\u3002"}),"\n",(0,t.jsx)(n.p,{children:"\u5728RibbonAutoConfiguration\u7c7b\u4e2d\u6ce8\u5165\u4e86LoadBalancerClient\u63a5\u53e3\u7684\u5b9e\u73b0\u7c7bRibbonLoadBalancerClient"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"@Bean\n@ConditionalOnMissingBean(LoadBalancerClient.class)\npublic LoadBalancerClient loadBalancerClient() {\n    return new RibbonLoadBalancerClient(springClientFactory());\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"3.4 \u62e6\u622a\u5668"}),"\n\u7531\u4e8e\u5728\u81ea\u52a8\u914d\u7f6e\u7c7b\u4e2d\uff0c\u5bf9restTemplate\u5b9e\u4f8b\u6dfb\u52a0\u4e86LoadBalancerInterceptor\u62e6\u622a\u5668\uff0c\u6240\u4ee5\uff0c\u5f53\u7528restTemplate\u53d1\u9001http\u8bf7\u6c42\u65f6\uff0c\u5c31\u4f1a\u6267\u884c\u8fd9\u4e2a\u62e6\u622a\u5668\u7684intercept\u65b9\u6cd5\u3002"]}),"\n",(0,t.jsx)(n.p,{children:"intercept\u65b9\u6cd5\u4e2d\uff0c\u4f1a\u6839\u636erequest.getURI()\uff0c\u83b7\u53d6\u8bf7\u6c42\u7684uri\uff0c\u518d\u83b7\u53d6host\uff0c\u6211\u4eec\u5728\u53d1\u9001http\u8bf7\u6c42\u7684\u65f6\u5019\uff0c\u662f\u7528\u7684\u670d\u52a1\u540d\u4f5c\u4e3ahost\uff0c\u6240\u4ee5\uff0c\u8fd9\u91cc\u5c31\u4f1a\u62ff\u5230\u670d\u52a1\u540d\uff0c\u518d\u8c03\u7528\u5177\u4f53LoadBalancerClient\u5b9e\u4f8b\u7684execute\u65b9\u6cd5\uff0c\u53d1\u9001\u8bf7\u6c42\u3002"}),"\n",(0,t.jsx)(n.p,{children:"LoadBalancerClient\u7684\u5b9e\u73b0\u7c7b\u4e3aRibbonLoadBalancerClient\uff0c\u6700\u7ec8\u7684\u8d1f\u8f7d\u5747\u8861\u8bf7\u6c42\u7531\u5b83\u6765\u6267\u884c\uff0c\u6240\u4ee5\uff0c\u8fd8\u9700\u8981\u518d\u68b3\u7406\u4e0bRibbonLoadBalancerClient\u7684\u903b\u8f91\u3002"}),"\n",(0,t.jsx)(n.p,{children:"\u5148\u770b\u4e0bRibbonLoadBalancerClient\u4e2d\u7684execute\u65b9\u6cd5\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'public <T> T execute(String serviceId, LoadBalancerRequest<T> request, Object hint)\n    throws IOException {\n    ILoadBalancer loadBalancer = getLoadBalancer(serviceId);\n    Server server = getServer(loadBalancer, hint);\n    if (server == null) {\n        throw new IllegalStateException("No instances available for " + serviceId);\n    }\n    RibbonServer ribbonServer = new RibbonServer(serviceId, server,\n                                                 isSecure(server, serviceId),\n                                                 serverIntrospector(serviceId).getMetadata(server));\n\n    return execute(serviceId, ribbonServer, request);\n}\n\n@Override\npublic <T> T execute(String serviceId, ServiceInstance serviceInstance,\n                     LoadBalancerRequest<T> request) throws IOException {\n    Server server = null;\n    if (serviceInstance instanceof RibbonServer) {\n        server = ((RibbonServer) serviceInstance).getServer();\n    }\n    if (server == null) {\n        throw new IllegalStateException("No instances available for " + serviceId);\n    }\n\n    RibbonLoadBalancerContext context = this.clientFactory\n        .getLoadBalancerContext(serviceId);\n    RibbonStatsRecorder statsRecorder = new RibbonStatsRecorder(context, server);\n    try {\n        T returnVal = request.apply(serviceInstance);\n        statsRecorder.recordStats(returnVal);\n        return returnVal;\n    }\n    // catch IOException and rethrow so RestTemplate behaves correctly\n    catch (IOException ex) {\n        statsRecorder.recordStats(ex);\n        throw ex;\n    }\n    catch (Exception ex) {\n        statsRecorder.recordStats(ex);\n        ReflectionUtils.rethrowRuntimeException(ex);\n    }\n    return null;\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"\u670d\u52a1\u540d\u4f5c\u4e3aserviceId\u5b57\u6bb5\u4f20\u8fdb\u6765\uff0c\u5148\u901a\u8fc7getLoadBalancer\u83b7\u53d6loadBalancer\uff0c\u518d\u6839\u636eloadBalancer\u83b7\u53d6server\uff0c\u4e0b\u9762\u662fgetServer\u7684\u4ee3\u7801\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"protected Server getServer(ILoadBalancer loadBalancer, Object hint) {\n    if (loadBalancer == null) {\n        return null;\n    }\n    // Use 'default' on a null hint, or just pass it on?\n    return loadBalancer.chooseServer(hint != null ? hint : \"default\");\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u5982\u679cloadBalancer\u4e3a\u7a7a\uff0c\u5c31\u76f4\u63a5\u8fd4\u56de\u7a7a\uff0c\u5426\u5219\u5c31\u8c03\u7528loadBalancer\u7684chooseServer\u65b9\u6cd5\uff0c\u83b7\u53d6\u76f8\u5e94\u7684server\u3002"}),"\n",(0,t.jsx)(n.p,{children:"\u770b\u4e00\u4e0bILoadBalancer\u662f\u4e00\u4e2a\u63a5\u53e3\uff0c\u91cc\u9762\u58f0\u660e\u4e86\u4e00\u7cfb\u5217\u8d1f\u8f7d\u5747\u8861\u5b9e\u73b0\u7684\u65b9\u6cd5\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"public interface ILoadBalancer {\n\tpublic void addServers(List<Server> newServers);\n\tpublic Server chooseServer(Object key);\n\tpublic void markServerDown(Server server);\n\t@Deprecated\n\tpublic List<Server> getServerList(boolean availableOnly);\n    public List<Server> getReachableServers();\n\tpublic List<Server> getAllServers();\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u8fd9\u4e9b\u65b9\u6cd5\u540d\u6bd4\u8f83\u76f4\u89c2\uff0c\u5f88\u5bb9\u6613\u5c31\u80fd\u731c\u51fa\u662f\u5e72\u5565\u7684\uff0caddServers\u662f\u7528\u6765\u6dfb\u52a0\u4e00\u4e2aserver\u96c6\u5408\uff0cchooseServer\u662f\u9009\u62e9\u4e00\u4e2aserver\uff0cmarkServerDown\u7528\u6765\u6807\u8bb0\u67d0\u4e2a\u670d\u52a1\u4e0b\u7ebf\uff0cgetReachableServers\u83b7\u53d6\u53ef\u7528\u7684Server\u96c6\u5408\uff0cgetAllServers\u662f\u83b7\u53d6\u6240\u6709\u7684server\u96c6\u5408\u3002\nILoadBalancer\u6709\u5f88\u591a\u5b9e\u73b0\uff0c\u90a3\u5177\u4f53\u662f\u7528\u7684\u54ea\u4e2a\u7c7b\u5462\uff0c\u5728RibbonAutoConfiguration\u7c7b\u4e2d\u6ce8\u5165SpringClientFactory\uff0c\u901a\u8fc7RibbonClientConfiguration\u7c7b\u770b\u5230\uff0c\u8fd9\u4e2a\u914d\u7f6e\u7c7b\u5728\u521d\u59cb\u5316\u7684\u65f6\u5019\uff0c\u8fd4\u56de\u4e86ZoneAwareLoadBalancer\u4f5c\u4e3a\u8d1f\u8f7d\u5747\u8861\u5668\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"@Bean\n@ConditionalOnMissingBean\npublic ILoadBalancer ribbonLoadBalancer(IClientConfig config,\n                                        ServerList<Server> serverList, ServerListFilter<Server> serverListFilter,\n                                        IRule rule, IPing ping, ServerListUpdater serverListUpdater) {\n    if (this.propertiesFactory.isSet(ILoadBalancer.class, name)) {\n        return this.propertiesFactory.get(ILoadBalancer.class, config, name);\n    }\n    return new ZoneAwareLoadBalancer<>(config, rule, ping, serverList,\n                                       serverListFilter, serverListUpdater);\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"3.5 ZoneAwareLoadBalancer"}),"\nZoneAwareLoadBalancer\u4ece\u540d\u5b57\u4e2d\u53ef\u4ee5\u770b\u51fa\u6765\uff0c\u8fd9\u4e2a\u8d1f\u8f7d\u5747\u8861\u5668\u548czone\u662f\u6709\u5173\u7cfb\u7684\u3002\u4e0b\u9762\u770b\u4e0bZoneAwareLoadBalancer\u4e2d\u7684chooseServer\u65b9\u6cd5\uff1a"]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"eureka\u63d0\u4f9b\u4e86region\u548czone\u4e24\u4e2a\u6982\u5ff5\u6765\u8fdb\u884c\u5206\u533a\uff0c\u8fd9\u4e24\u4e2a\u6982\u5ff5\u5747\u6765\u81ea\u4e8e\u4e9a\u9a6c\u900a\u7684AWS\uff1a\nregion\uff1a\u53ef\u4ee5\u7b80\u5355\u7406\u89e3\u4e3a\u5730\u7406\u4e0a\u7684\u5206\u533a\uff0c\u6bd4\u5982\u4e9a\u6d32\u5730\u533a\uff0c\u6216\u8005\u534e\u5317\u5730\u533a\uff0c\u518d\u6216\u8005\u5317\u4eac\u7b49\u7b49\uff0c\u6ca1\u6709\u5177\u4f53\u5927\u5c0f\u7684\u9650\u5236\u3002\u6839\u636e\u9879\u76ee\u5177\u4f53\u7684\u60c5\u51b5\uff0c\u53ef\u4ee5\u81ea\u884c\u5408\u7406\u5212\u5206region\u3002\nzone\uff1a\u53ef\u4ee5\u7b80\u5355\u7406\u89e3\u4e3aregion\u5185\u7684\u5177\u4f53\u673a\u623f\uff0c\u6bd4\u5982\u8bf4region\u5212\u5206\u4e3a\u5317\u4eac\uff0c\u7136\u540e\u5317\u4eac\u6709\u4e24\u4e2a\u673a\u623f\uff0c\u5c31\u53ef\u4ee5\u5728\u6b64region\u4e4b\u4e0b\u5212\u5206\u51fazone1,zone2\u4e24\u4e2azone\u3002"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'@Override\npublic Server chooseServer(Object key) {\n    //\u53ea\u6709\u5f53\u8d1f\u8f7d\u5747\u8861\u5668\u4e2d\u7ef4\u62a4\u7684\u5b9e\u4f8b\u6240\u5c5e\u7684Zone\u533a\u57df\u7684\u4e2a\u6570\u5927\u4e8e1\u7684\u65f6\u5019\u624d\u4f1a\u6267\u884c\u9009\u62e9\u7b56\u7565\n    //\u5426\u5219\u8fd8\u662f\u4f7f\u7528\u7236\u7c7b\u7684\u5b9e\u73b0\n    if (!ENABLED.get() || getLoadBalancerStats().getAvailableZones().size() <= 1) {\n        logger.debug("Zone aware logic disabled or there is only one zone");\n        return super.chooseServer(key);\n    }\n    Server server = null;\n    try {\n        LoadBalancerStats lbStats = getLoadBalancerStats();\n        //\u4e3a\u5f53\u524d\u8d1f\u8f7d\u5747\u8861\u5668\u4e2d\u7684\u6240\u6709Zone\u533a\u57df\u5206\u522b\u521b\u5efa\u5feb\u7167\uff0c\u4fdd\u5b58\u5728zoneSnapshot\u4e2d\uff0c\u8fd9\u4e9b\u5feb\u7167\u4e2d\u7684\u6570\u636e\u7528\u4e8e\u540e\u7eed\u7684\u7b97\u6cd5\n        Map<String, ZoneSnapshot> zoneSnapshot = ZoneAvoidanceRule.createSnapshot(lbStats);\n        logger.debug("Zone snapshots: {}", zoneSnapshot);\n        if (triggeringLoad == null) {\n            triggeringLoad = DynamicPropertyFactory.getInstance().getDoubleProperty(\n                "ZoneAwareNIWSDiscoveryLoadBalancer." + this.getName() + ".triggeringLoadPerServerThreshold", 0.2d);\n        }\n\n        if (triggeringBlackoutPercentage == null) {\n            triggeringBlackoutPercentage = DynamicPropertyFactory.getInstance().getDoubleProperty(\n                "ZoneAwareNIWSDiscoveryLoadBalancer." + this.getName() + ".avoidZoneWithBlackoutPercetage", 0.99999d);\n        }\n        //\u83b7\u5f97\u53ef\u7528Zone\u533a\u57df\u7684\u96c6\u5408\uff0cgetAvailableZones\u4f1a\u901a\u8fc7zoneSnapshot\u5b9e\u73b0\u53ef\u7528\u533a\u57df\u6311\u9009\n        Set<String> availableZones = ZoneAvoidanceRule.getAvailableZones(zoneSnapshot, triggeringLoad.get(), triggeringBlackoutPercentage.get());\n        logger.debug("Available zones: {}", availableZones);\n        if (availableZones != null &&  availableZones.size() < zoneSnapshot.keySet().size()) {\n            //\u968f\u673a\u9009\u62e9\u4e00\u4e2aZone\u533a\u57df\n            String zone = ZoneAvoidanceRule.randomChooseZone(zoneSnapshot, availableZones);\n            logger.debug("Zone chosen: {}", zone);\n            if (zone != null) {\n                //\u83b7\u5f97\u5bf9\u5e94\u533a\u57df\u7684\u8d1f\u8f7d\u5747\u8861\u5668\n                BaseLoadBalancer zoneLoadBalancer = getLoadBalancer(zone);\n                //\u9009\u62e9\u5177\u4f53\u7684\u670d\u52a1\u5b9e\u4f8b\n                //\u5728chooseServer\u4e2d\u5c06\u4f1a\u4f7f\u7528IRule\u63a5\u53e3\u7684choose\u51fd\u6570\u6765\u9009\u62e9\u5177\u4f53\u670d\u52a1\u5b9e\u4f8b\u3002\u5728\u8fd9\u91cc\uff0cIRule\u63a5\u53e3\u7684\u5b9e\u73b0\u4f1a\u5b9e\u73b0ZoneAvoidanceRule\u6765\u6311\u9009\u5177\u4f53\u7684\u670d\u52a1\u5b9e\u4f8b\u3002\n                server = zoneLoadBalancer.chooseServer(key);\n            }\n        }\n    } catch (Exception e) {\n        logger.error("Error choosing server using zone aware logic for load balancer={}", name, e);\n    }\n    if (server != null) {\n        return server;\n    } else {\n        logger.debug("Zone avoidance logic is not invoked.");\n        return super.chooseServer(key);\n    }\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"\u8fd9\u4e2a\u65b9\u6cd5\u4f1a\u6839\u636eserver\u7684zone\u548c\u53ef\u7528\u6027\u6765\u9009\u62e9\u5177\u4f53\u7684\u5b9e\u4f8b\uff0c\u8fd4\u56de\u4e00\u4e2aServer\u5bf9\u8c61\u3002"}),"\n",(0,t.jsx)(n.p,{children:"\u8fd9\u4e2a\u7c7b\u91cc\u9762\u7684\u51e0\u4e2a\u65b9\u6cd5\uff1a"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"setServerListForZones : \u8fd9\u4e2a\u57fa\u4e8eZone\u8fdb\u884c\u670d\u52a1\u5212\u5206"}),"\n",(0,t.jsx)(n.li,{children:"chooseServer\u8fd9\u91cc\u4e5f\u662f\u4e3b\u8981\u8ddfzone\u6709\u5173\u7684\u8ba1\u7b97\uff0c\u5f53\u7136\u9ed8\u8ba4\u7684Zone\u53ea\u6709\u4e00\u4e2a\uff0c\u6240\u4ee5\u76f4\u63a5\u662f\u8c03\u7528\u7684\u7236\u7c7b\u7684chooseServer\uff08key)"}),"\n",(0,t.jsx)(n.li,{children:"getLoadBalancer(String zone) \u57fa\u4e8ezone\u53bb\u83b7\u53d6LoadBalancer"}),"\n",(0,t.jsx)(n.li,{children:"setRule(IRule rule) \u4e3a\u6bcf\u4e2a\u8d1f\u8f7d\u5747\u8861\u5668\u8bbe\u7f6e\u89c4\u5219\u3002\n\u8fd9\u91cc\u53ef\u4ee5\u770b\u5230\uff0c\u5176\u5b9e\u8fd9\u4e2a\u4e3b\u8981\u662f\u9488\u5bf9Zone\u505a\u4e86\u4e00\u4e9b\u5206\u7c7b\u5904\u7406\uff0c\u5c31\u662f\u5c06\u539f\u6765\u5c5e\u4e8e\u540c\u4e00\u670d\u52a1\u7684\u670d\u52a1\u5b9e\u4f8b\uff0c\u518d\u6839\u636e\u5730\u533a\u8fdb\u884c\u5212\u5206\u3002\u8fd9\u4e5f\u662f\u4e3a\u4e86\u80fd\u591f\u5feb\u901f\u54cd\u5e94\u800c\u8bbe\u7f6e\u7684\u3002"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"3.5.1 DynamicServerListLoadBalancer"})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"ZoneAwareLoadBalancer\u7684\u7236\u7c7b"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"\u8fd9\u4e2a\u7c7b\u6309\u7167\u540d\u79f0\u6765\u8bf4\u5c31\u662f\u52a8\u6001\u52a0\u8f7d\u670d\u52a1\u5217\u8868\u4f7f\u7528\u7684\u3002\u5176\u4e2d\u6709\u51e0\u4e2a\u6bd4\u8f83\u91cd\u8981\u7684\u65b9\u6cd5"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"updateListOfServers:\u670d\u52a1\u5217\u8868\u5e76\u66f4\u65b0\u672c\u5730\u7f13\u5b58\u7684\u670d\u52a1\u5217\u8868"}),"\n",(0,t.jsx)(n.li,{children:"enableAndInitLearnNewServersFeature:\u5f00\u542f\u670d\u52a1\u5217\u8868\u66f4\u65b0\u5b9a\u65f6\u4efb\u52a1"}),"\n",(0,t.jsx)(n.li,{children:"\u5f00\u542f\u76d1\u542c:@Monitor"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"DynamicServerListLoadBalancer\u7684\u6838\u5fc3\u5c31\u662f\u83b7\u53d6\u670d\u52a1\u5217\u8868\uff0c\u5728Eureka\u4e2d\u9ed8\u8ba4\u662f\u901a\u8fc7DomainExtractingServerList\u6765\u83b7\u53d6\uff0c\u8fd9\u4e2a\u7c7b\u662f\u5728org.springframework.cloud.netflix.ribbon.eureka.EurekaRibbonClientConfiguration#ribbonServerList\uff0c\u8fd9\u91cc\u6ca1\u6709\u96c6\u6210Eureka\uff0c\u6682\u65f6\u4e0d\u8bb2"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"3.5.2 BaseLoadBalancer"})}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"DynamicServerListLoadBalancer\u7684\u7236\u7c7b"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"\u6838\u5fc3\u9ed8\u8ba4\u503c"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u9ed8\u8ba4\u7684\u8d1f\u8f7d\u5747\u8861\u7b56\u7565RoundRobinRule"}),"\n",(0,t.jsx)(n.li,{children:"\u9ed8\u8ba4\u7684Ping\u7b56\u7565SerialPingStrategy"}),"\n",(0,t.jsx)(n.li,{children:"\u6240\u6709\u670d\u52a1\u5b9e\u4f8b\u5bb9\u5668\uff1aallServerList"}),"\n",(0,t.jsxs)(n.li,{children:["\u5728\u7ebf\u670d\u52a1\u5b9e\u4f8b\u5bb9\u5668\uff1aupServerList\n",(0,t.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/b2db0bc66c3045288a762907ff72e01883bf20.jpg",alt:"SpringCloud\u7cfb\u5217\u2014Ribbon\u6e90\u7801\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud\u7cfb\u5217\u2014Ribbon\u6e90\u7801\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"\u4ece\u5b50\u7c7b\u6784\u9020\u4e2d\u5c06\u5bf9\u5e94\u7684\u8d1f\u8f7d\u5747\u8861\u89c4\u5219\uff0cping\u7b56\u7565\uff0cping\u7b49\u4f20\u9012\u8fc7\u6765"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"ping\u505a\u4e86\u4e9b\u4ec0\u4e48\uff1f"})}),"\n",(0,t.jsxs)(n.p,{children:["PingTask\u4f5c\u4e3a\u4e00\u4e2a\u7ebf\u7a0b\u4efb\u52a1\uff0c\u5c31\u662f\u5b9a\u671f\u68c0\u67e5\u670d\u52a1\u662f\u5426\u90fd\u5b58\u6d3b\uff0c\u8ddfServerListUpdater\u670d\u52a1\u66f4\u65b0\u673a\u5236\u4e0d\u51b2\u7a81\u3002\u8fd9\u662fribbon\u81ea\u5df1\u7ef4\u62a4\u7684\u4e00\u5957\u670d\u52a1\u68c0\u6d4b\u673a\u5236\uff0c\u4e3b\u8981\u662f\u4e3a\u4e86\u964d\u4f4e\u8bbf\u95ee\u5931\u8d25\u7684\u6982\u7387\u3002\u9ed8\u8ba4\u5728\u4f7f\u7528eureka\u65f6\uff0cping\u662f\u4f7f\u7528\u7684\u662fNIWSDiscoveryPing\u6765\u5b8c\u6210\u670d\u52a1\u4fdd\u6d3b\u68c0\u6d4b\u3002\u7531eureka \u548c ServerListUpdater\u6765\u5237\u65b0\u670d\u52a1\u5217\u8868\u3002",(0,t.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/27db4c518aa7c100d427761832a9fa19fa8f04.jpg",alt:"SpringCloud\u7cfb\u5217\u2014Ribbon\u6e90\u7801\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud\u7cfb\u5217\u2014Ribbon\u6e90\u7801\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"\u8fd9\u91cc\u6709\u4e2a\u5e38\u7528\u7684\u5b9a\u65f6\u4efb\u52a1\u5feb\u901f\u9000\u51fa\u7684\u65b9\u6cd5\uff0c\u6211\u89c9\u5f97\u5728\u6211\u4eec\u81ea\u5df1\u5199\u7684\u65f6\u5019\u4e5f\u53ef\u4ee5\u4f7f\u7528\u3002"]}),"\n",(0,t.jsxs)(n.p,{children:["\u5c31\u662f\u5728\u540c\u4e00\u4e2a\u5b9a\u65f6\u4efb\u52a1\u5982\u679c\u6267\u884c\u65f6\u95f4\u8d85\u8fc7\u4e86\u5b9a\u65f6\u5468\u671f\uff0c\u90a3\u4e48\u4e0b\u4e00\u4e2a\u5b9a\u65f6\u4efb\u52a1\u53d1\u73b0\u4e0a\u4e00\u4e2a\u5b9a\u65f6\u4efb\u52a1\u8fd8\u6ca1\u6709\u6267\u884c\u5b8c\u65f6\uff0c\u5c31\u5148\u53d6\u6d88\u3002",(0,t.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/f2d669b11f17530d2e62603d45949e934a5931.jpg",alt:"SpringCloud\u7cfb\u5217\u2014Ribbon\u6e90\u7801\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud\u7cfb\u5217\u2014Ribbon\u6e90\u7801\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"\u8fd9\u91cc\u4e5f\u7528\u4e86\u5f88\u591a\u9501\u673a\u5236\uff0c\u6bd4\u5982\u6240\u6709\u670d\u52a1\u5b9e\u4f8b\u5230\u4e00\u4e2a\u65b0\u7684\u5bf9\u8c61\u65f6\u4f7f\u7528\u7684\u662f\u8bfb\u9501\uff0c\u5c31\u662f\u544a\u8bc9allServers\u73b0\u5728\u53ea\u80fd\u8bfb\u4e0d\u80fd\u5199\u3002",(0,t.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/711c81e67b2c1cd3fb91005f53ea1e1352ad9a.png",alt:"SpringCloud\u7cfb\u5217\u2014Ribbon\u6e90\u7801\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud\u7cfb\u5217\u2014Ribbon\u6e90\u7801\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"\u5728\u53d1\u9001ping\u540e\uff0c\u5c06\u68c0\u6d4b\u901a\u8fc7\u7684\u670d\u52a1\u653e\u5165newUpList\u4e2d\uff0c\u6700\u540e\u901a\u8fc7\u5199\u9501\uff0c\u5c06upServerList\u9501\u4f4f\u3002"]}),"\n",(0,t.jsxs)(n.p,{children:["\u8fd9\u91cc\u5c31\u662f\u53ea\u80fd\u6709\u4e00\u4e2a\u5199\uff0c\u4e14\u4e0d\u80fd\u8bfb\u3002",(0,t.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/047543857174aa1130b0747d1d149ffd6d5632.jpg",alt:"SpringCloud\u7cfb\u5217\u2014Ribbon\u6e90\u7801\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud\u7cfb\u5217\u2014Ribbon\u6e90\u7801\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"\u4e0a\u9762\u662fping\u5728\u68c0\u6d4b\u8fc7\u7a0b\u4e2d\u5173\u4e8e\u8bfb\u5199\u9501\u548c\u539f\u5b50\u7c7b\u7684\u4f7f\u7528\u3002"]}),"\n",(0,t.jsx)(n.p,{children:"\u4e3b\u8981\u6d41\u7a0b\u5c31\u662f\uff1a"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"\u8bfb\u53d6\u5168\u90e8\u670d\u52a1\u5b9e\u4f8b\u5217\u8868"}),"\n",(0,t.jsx)(n.li,{children:"\u68c0\u6d4b\u670d\u52a1\u5b9e\u4f8b\u662f\u5426\u5b58\u6d3bpingServers"}),"\n",(0,t.jsx)(n.li,{children:"\u5c06\u670d\u52a1\u72b6\u6001\u53d1\u751f\u6539\u53d8\u7684\u653e\u5165changedServers"}),"\n",(0,t.jsx)(n.li,{children:"\u5c06\u670d\u52a1\u5728\u7ebf\u7684\u653e\u5165newUpList"}),"\n",(0,t.jsx)(n.li,{children:"\u5c06newUpList\u8d4b\u503c\u5230upServerList \u5728\u7ebf\u670d\u52a1\u5b9e\u4f8b\u5217\u8868\u4e2d"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"\u8fd9\u91cc\u9762pingServers\u5c31\u662f\u68c0\u67e5\u5fc3\u8df3\u7684"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"BaseLoadBalancer\u7684\u5176\u4ed6\u529f\u80fd\u7b80\u8ff0"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"\u5bf9allServerList\u548cupServerList\u7684\u8bfb\u5199\u9501\u65b9\u6cd5"}),"\n",(0,t.jsx)(n.li,{children:"\u63d0\u4f9b\u5bf9allServerList\u548cupServerList\u7684\u589e\u5220\u6539\u529f\u80fd"}),"\n",(0,t.jsx)(n.li,{children:"\u63d0\u4f9b\u4e86PingTask\uff08ping\u7684\u5b9a\u65f6\u4efb\u52a1\uff09\uff0cPinger\uff08ping\u7684\u6267\u884c\u5668\uff09"}),"\n",(0,t.jsx)(n.li,{children:"\u57fa\u4e8e\u8d1f\u8f7d\u5747\u8861\u7b56\u7565\u9009\u62e9\u670d\u52a1rule.choose(key)"}),"\n",(0,t.jsxs)(n.li,{children:["\u63d0\u4f9b\u9ed8\u8ba4\u7684ping\u7b56\u7565SerialPingStrategy\n",(0,t.jsx)(n.strong,{children:"3.6 LoadBalancerRequest"}),"\n\u901a\u8fc7ZoneAwareLoadBalancer\u9009\u62e9\u5177\u4f53\u7684Server\u4e4b\u540e\uff0c\u518d\u5305\u88c5\u6210RibbonServer\u5bf9\u8c61\uff0c\u4e4b\u524d\u8fd4\u56de\u7684server\u662f\u8be5\u5bf9\u8c61\u4e2d\u7684\u4e00\u4e2a\u5b57\u6bb5\uff0c\u9664\u6b64\u4e4b\u5916\uff0c\u8fd8\u6709\u670d\u52a1\u540dserviceId\uff0c\u662f\u5426\u9700\u8981\u4f7f\u7528https\u7b49\u4fe1\u606f\u3002\u6700\u540e\uff0c\u901a\u8fc7LoadBalancerRequest\u7684apply\u65b9\u6cd5\uff0c\u5411\u5177\u4f53\u7684server\u53d1\u8bf7\u6c42\uff0c\u4ece\u800c\u5b9e\u73b0\u4e86\u8d1f\u8f7d\u5747\u8861\u3002"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"\u4e0b\u9762\u662fapply\u65b9\u6cd5\u7684\u5b9a\u4e49\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"public interface LoadBalancerRequest<T> {\n    T apply(ServiceInstance instance) throws Exception;\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u5728\u8bf7\u6c42\u65f6\uff0c\u4f20\u5165\u7684ribbonServer\u5bf9\u8c61\uff0c\u88ab\u5f53\u6210ServiceInstance\u7c7b\u578b\u7684\u5bf9\u8c61\u8fdb\u884c\u63a5\u6536\u3002ServiceInstance\u662f\u4e00\u4e2a\u63a5\u53e3\uff0c\u5b9a\u4e49\u4e86\u670d\u52a1\u6cbb\u7406\u7cfb\u7edf\u4e2d\uff0c\u6bcf\u4e2a\u5b9e\u4f8b\u9700\u8981\u63d0\u4f9b\u7684\u4fe1\u606f\uff0c\u6bd4\u5982serviceId\uff0chost\uff0cport\u7b49\u3002"}),"\n",(0,t.jsx)(n.p,{children:"LoadBalancerRequest\u662f\u4e00\u4e2a\u63a5\u53e3\uff0c\u6700\u7ec8\u4f1a\u901a\u8fc7\u5b9e\u73b0\u7c7b\u7684apply\u65b9\u6cd5\u53bb\u6267\u884c\uff0c\u5b9e\u73b0\u7c7b\u662f\u5728LoadBalancerInterceptor\u4e2d\u8c03\u7528RibbonLoadBalancerClient\u7684execute\u65b9\u6cd5\u65f6\uff0c\u4f20\u8fdb\u6765\u7684\u4e00\u4e2a\u533f\u540d\u7c7b\uff0c\u53ef\u4ee5\u901a\u8fc7\u67e5\u770bLoadBalancerInterceptor\u7684\u4ee3\u7801\u770b\u5230\u3002"}),"\n",(0,t.jsx)(n.p,{children:"\u521b\u5efaLoadBalancerRequest\u533f\u540d\u7c7b\u7684\u65f6\u5019\uff0c\u5c31\u91cd\u5199\u4e86apply\u65b9\u6cd5\uff0capply\u65b9\u6cd5\u4e2d\uff0c\u8fd8\u65b0\u5efa\u4e86\u4e00\u4e2aServiceRequestWrapper\u7684\u5185\u90e8\u7c7b\uff0c\u8fd9\u4e2a\u7c7b\u4e2d\uff0c\u5c31\u91cd\u5199\u4e86getURI\u65b9\u6cd5\uff0cgetURI\u65b9\u6cd5\u4f1a\u8c03\u7528loadBalancer\u7684reconstructURI\u65b9\u6cd5\u6765\u6784\u5efauri\u3002"}),"\n",(0,t.jsx)(n.p,{children:"\u770b\u5230\u8fd9\u91cc\uff0c\u5df2\u7ecf\u53ef\u4ee5\u5927\u4f53\u77e5\u9053Ribbon\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\u7684\u6d41\u7a0b\u4e86\uff0c\u6211\u4eec\u5728RestTemplate\u4e0a\u6dfb\u52a0\u6ce8\u89e3\uff0c\u5c31\u4f1a\u6709LoadBalancerClient\u7684\u5bf9\u8c61\u6765\u914d\u7f6e\u5b83\uff0c\u4e5f\u5c31\u662fRibbonLoadBalancerClient\u3002\u540c\u65f6\uff0c\nLoadBalancerAutoConfiguration\u4f1a\u8fdb\u884c\u914d\u7f6e\uff0c\u521b\u5efa\u4e00\u4e2aLoadBalancerInterceptor\uff0c\u5e76\u4e14\u62ff\u5230\u6211\u4eec\u58f0\u660e\u7684\u6240\u6709restTemplate\uff0c\u5728\u8fd9\u4e9brestTemplate\u4e2d\u6dfb\u52a0LoadBalancerInterceptor\u62e6\u622a\u5668\u3002"}),"\n",(0,t.jsx)(n.p,{children:"\u5f53\u901a\u8fc7restTemplate\u53d1\u9001\u8bf7\u6c42\u65f6\uff0c\u5c31\u4f1a\u7ecf\u8fc7\u8fd9\u4e2a\u62e6\u622a\u5668\uff0c\u5728\u62e6\u622a\u5668\u4e2d\uff0c\u5c31\u4f1a\u8c03\u7528RibbonLoadBalancerClient\u4e2d\u7684\u65b9\u6cd5\uff0c\u83b7\u53d6\u5230\u6839\u636e\u670d\u52a1\u540d\uff0c\u901a\u8fc7\u8d1f\u8f7d\u5747\u8861\u65b9\u6cd5\u83b7\u53d6\u5230\u670d\u52a1\u5b9e\u4f8b\uff0c\u7136\u540e\u53bb\u8bf7\u6c42\u8fd9\u4e2a\u5b9e\u4f8b\u3002"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"3.7 \u83b7\u53d6\u670d\u52a1\u5217\u8868"}),"\n\u4e0a\u9762\u8bf4\u7684\u8fd9\u4e9b\uff0c\u662f\u5982\u4f55\u5bf9\u8bf7\u6c42\u8fdb\u884c\u8d1f\u8f7d\u5747\u8861\u7684\uff0c\u4f46\u662f\u8fd8\u6709\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u8bf7\u6c42\u7684\u5b9e\u4f8b\uff0c\u662f\u4eceEureka Server\u4e0a\u83b7\u53d6\u5230\u7684\uff0c\u90a3\u8fd9\u4e2a\u5b9e\u4f8b\u5217\u8868\u662f\u5982\u4f55\u83b7\u53d6\u7684\u5462\uff1f\u600e\u4e48\u4fdd\u8bc1\u8fd9\u4e2a\u5b9e\u4f8b\u5217\u8868\u4e2d\u7684\u5b9e\u4f8b\u662f\u53ef\u7528\u7684\u5462\uff1f"]}),"\n",(0,t.jsxs)(n.p,{children:["\u5728RibbonLoadBalancerClient\u9009\u62e9\u5b9e\u4f8b\u7684\u65f6\u5019\uff0c\u662f\u901a\u8fc7ILoadBalancer\u7684\u5b9e\u73b0\u7c7b\u6839\u636e\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u9009\u62e9\u670d\u52a1\u5b9e\u4f8b\u7684\uff0c\u4e5f\u5c31\u662fZoneAwareLoadBalancer\u7684chooseServer\u4e2d\u7684\u903b\u8f91\uff0c\u90a3\u5c31\u5728\u8fd9\u91cc\u627e\u7ebf\u7d22\u3002\u67e5\u770bZoneAwareLoadBalancer\u7684\u7ee7\u627f\u5173\u7cfb\uff0c\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u56fe\u6240\u793a\u3002",(0,t.jsx)(n.img,{src:"https://java-tutorial.oss-cn-shanghai.aliyuncs.com/425d8ff567d9ac6171f6036dab1726a7da04a3.jpg",alt:"SpringCloud\u7cfb\u5217\u2014Ribbon\u6e90\u7801\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a",title:"SpringCloud\u7cfb\u5217\u2014Ribbon\u6e90\u7801\u5206\u6790-\u5f00\u6e90\u57fa\u7840\u8f6f\u4ef6\u793e\u533a"}),"\u53ef\u4ee5\u770b\u5230\uff0c\u6700\u4e0a\u9762\u662fILoadBalancer\u63a5\u53e3\uff0cAbstractLoadBalancer\u7c7b\u7ee7\u627f\u4e86\u8fd9\u4e2a\u63a5\u53e3\uff0cBaseLoadBalancer\u7ee7\u627f\u4e86AbstractLoadBalancer\u7c7b\uff0c\nDynamicServerListLoadBalancer\u7ee7\u627f\u4e86BaseLoadBalancer\uff0cZoneAwareLoadBalancer\u7ee7\u627f\u4e86DynamicServerListLoadBalancer\u3002"]}),"\n",(0,t.jsx)(n.p,{children:"ILoadBalancer\u63a5\u53e3\u7684\u4ee3\u7801\u5df2\u7ecf\u770b\u8fc7\u4e86\uff0c\u73b0\u5728\u770b\u4e0bAbstractLoadBalancer\u7684\u4ee3\u7801\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"public abstract class AbstractLoadBalancer implements ILoadBalancer {\n    public enum ServerGroup{\n        ALL,\n        STATUS_UP,\n        STATUS_NOT_UP        \n    }    \n    /**\n     * delegate to {@link #chooseServer(Object)} with parameter null.\n     */\n    public Server chooseServer() {\n    \treturn chooseServer(null);\n    }\n    /**\n     * List of servers that this Loadbalancer knows about\n     * \n     * @param serverGroup Servers grouped by status, e.g., {@link ServerGroup#STATUS_UP}\n     */\n    public abstract List<Server> getServerList(ServerGroup serverGroup);\n    /**\n     * Obtain LoadBalancer related Statistics\n     */\n    public abstract LoadBalancerStats getLoadBalancerStats();    \n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u8fd9\u662f\u4e00\u4e2a\u62bd\u8c61\u7c7b\uff0c\u91cc\u9762\u52a0\u4e86\u4e00\u4e2a\u679a\u4e3e\uff0c\u589e\u52a0\u4e86\u4e24\u4e2a\u62bd\u8c61\u65b9\u6cd5\u3002\u5b9a\u4e49\u7684chooseServer\u65b9\u6cd5\u3002"}),"\n",(0,t.jsx)(n.p,{children:"\u4e0b\u9762\u518d\u770bBaseLoadBalancer\u7c7b\uff0cBaseLoadBalancer\u7c7b\u5c31\u7b97\u662f\u8d1f\u8f7d\u5747\u8861\u5668\u7684\u4e00\u4e2a\u57fa\u7840\u5b9e\u73b0\u7c7b\uff0c\u5728\u91cc\u9762\u53ef\u4ee5\u770b\u5230\u5b9a\u4e49\u4e86\u4e24\u4e2alist\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'@Monitor(name = PREFIX + "AllServerList", type = DataSourceType.INFORMATIONAL)\nprotected volatile List<Server> allServerList = Collections\n    .synchronizedList(new ArrayList<Server>());\n@Monitor(name = PREFIX + "UpServerList", type = DataSourceType.INFORMATIONAL)\nprotected volatile List<Server> upServerList = Collections\n    .synchronizedList(new ArrayList<Server>());\n'})}),"\n",(0,t.jsx)(n.p,{children:"\u4ece\u540d\u5b57\u4e0a\u770b\uff0c\u8fd9\u5c31\u662f\u7ef4\u62a4\u6240\u6709\u670d\u52a1\u7684\u5b9e\u4f8b\u5217\u8868\uff0c\u548c\u7ef4\u62a4\u72b6\u6001\u4e3aup\u7684\u5b9e\u4f8b\u5217\u8868\u3002\n\u800c\u4e14\u8fd8\u53ef\u4ee5\u770b\u5230BaseLoadBalancer\u4e2d\u5b9e\u73b0\u7684ILoadBalancer\u63a5\u53e3\u4e2d\u7684\u65b9\u6cd5\uff0c\u6bd4\u5982\u4e0b\u9762\u8fd9\u4e24\u4e2a\uff0c\u83b7\u53d6\u53ef\u7528\u7684\u670d\u52a1\u5217\u8868\uff0c\u5c31\u4f1a\u628aupServerList\u8fd4\u56de\uff0c\u83b7\u53d6\u6240\u6709\u7684\u670d\u52a1\u5217\u8868\uff0c\u5c31\u4f1a\u628aallServerList\u8fd4\u56de\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"@Override\npublic List<Server> getReachableServers() {\n    return Collections.unmodifiableList(upServerList);\n}\n@Override\npublic List<Server> getAllServers() {\n    return Collections.unmodifiableList(allServerList);\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u63a5\u4e0b\u6765\uff0c\u518d\u770bDynamicServerListLoadBalancer\u7c7b\u3002\u4ece\u7c7b\u5934\u4e0a\u7684\u6ce8\u91ca\u53ef\u4ee5\u77e5\u9053\uff0c\u8fd9\u4e2a\u7c7b\u53ef\u4ee5\u52a8\u6001\u7684\u83b7\u53d6\u670d\u52a1\u5217\u8868\uff0c\u5e76\u4e14\u5229\u7528filter\u5bf9\u670d\u52a1\u5217\u8868\u8fdb\u884c\u8fc7\u6ee4\u3002"}),"\n",(0,t.jsx)(n.p,{children:"\u5728DynamicServerListLoadBalancer\u7c7b\u4e2d\uff0c\u80fd\u770b\u5230\u5b9a\u4e49\u4e86\u4e00\u4e2aServerList\u7c7b\u578b\u7684serverListImpl\u5b57\u6bb5\uff0cServerList\u662f\u4e00\u4e2a\u63a5\u53e3\uff0c\u91cc\u9762\u6709\u4e24\u4e2a\u65b9\u6cd5\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"public interface ServerList<T extends Server> {\n    public List<T> getInitialListOfServers();\n    /**\n     * Return updated list of servers. This is called say every 30 secs\n     * (configurable) by the Loadbalancer's Ping cycle\n     * \n     */\n    public List<T> getUpdatedListOfServers();   \n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"getInitialListOfServers\u662f\u83b7\u53d6\u521d\u59cb\u5316\u7684\u670d\u52a1\u5217\u8868\u3002\ngetUpdatedListOfServers\u662f\u83b7\u53d6\u66f4\u65b0\u7684\u670d\u52a1\u5217\u8868\u3002\nServerList\u6709\u591a\u4e2a\u5b9e\u73b0\u7c7b\uff0c\u5177\u4f53\u7528\u7684\u54ea\u4e2a\u5462\uff0c\u53ef\u4ee5\u5728\nEurekaRibbonClientConfiguration\u7c7b\u4e2d\u627e\u5230\uff0c\u8fd9\u662fRibbon\u548cEureka\u7ed3\u5408\u7684\u81ea\u52a8\u914d\u7f6e\u7c7b\uff0c\u4f46\u662f\u76ee\u524d\u6211\u4eec\u6ca1\u6709\u6574\u5408Eureka\uff0c\u662f\u901a\u8fc7\u914d\u7f6e\u6587\u4ef6\u914d\u7f6e\uff0c\u6240\u4ee5\u4f1a\u8d70ConfigurationBasedServerList\u7c7b\u3002"}),"\n",(0,t.jsx)(n.h1,{id:"\u53c2\u8003\u6587\u7ae0",children:"\u53c2\u8003\u6587\u7ae0"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.a,{href:"https://lijunyi.xyz/docs/SpringCloud/SpringCloud.html#_2-2-x-%E5%88%86%E6%94%AF",children:"https://lijunyi.xyz/docs/SpringCloud/SpringCloud.html#_2-2-x-%E5%88%86%E6%94%AF"}),"\n",(0,t.jsx)(n.a,{href:"https://mp.weixin.qq.com/s/2jeovmj77O9Ux96v3A0NtA",children:"https://mp.weixin.qq.com/s/2jeovmj77O9Ux96v3A0NtA"}),"\n",(0,t.jsx)(n.a,{href:"https://juejin.cn/post/6931922457741770760",children:"https://juejin.cn/post/6931922457741770760"}),"\n",(0,t.jsx)(n.a,{href:"https://github.com/D2C-Cai/herring",children:"https://github.com/D2C-Cai/herring"}),"\n",(0,t.jsx)(n.a,{href:"http://c.biancheng.net/springcloud",children:"http://c.biancheng.net/springcloud"}),"\n",(0,t.jsx)(n.a,{href:"https://github.com/macrozheng/springcloud-learning",children:"https://github.com/macrozheng/springcloud-learning"})]})]})}function p(e={}){const{wrapper:n}={...(0,i.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},88672:(e,n,r)=>{r.d(n,{Z:()=>s,a:()=>o});var t=r(50959);const i={},a=t.createContext(i);function o(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);