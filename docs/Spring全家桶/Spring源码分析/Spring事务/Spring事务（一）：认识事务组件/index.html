<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Spring全家桶/Spring源码分析/Spring事务/Spring事务（一）：认识事务组件" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.0">
<title data-rh="true">Spring事务（一）：认识事务组件 | Tommy</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aiden-coding.github.io/code-note-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://aiden-coding.github.io/code-note-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（一）：认识事务组件"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Spring事务（一）：认识事务组件 | Tommy"><meta data-rh="true" name="description" content="前面分析完了 spring aop 相关功能后，本文将来分析 spring aop 的一个应用 —— 事务管理。"><meta data-rh="true" property="og:description" content="前面分析完了 spring aop 相关功能后，本文将来分析 spring aop 的一个应用 —— 事务管理。"><link data-rh="true" rel="icon" href="/code-note-blog/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（一）：认识事务组件"><link data-rh="true" rel="alternate" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（一）：认识事务组件" hreflang="en"><link data-rh="true" rel="alternate" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（一）：认识事务组件" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/code-note-blog/blog/rss.xml" title="Tommy RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/code-note-blog/blog/atom.xml" title="Tommy Atom Feed"><link rel="stylesheet" href="/code-note-blog/assets/css/styles.dd5372db.css">
<script src="/code-note-blog/assets/js/runtime~main.f999fb27.js" defer="defer"></script>
<script src="/code-note-blog/assets/js/main.a0bfbaed.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_XYiV" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/code-note-blog/"><b class="navbar__title text--truncate">Tommy</b></a><a class="navbar__item navbar__link" href="/code-note-blog/docs/Java/basic/抽象类和接口">java</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/JavaWeb/走进JavaWeb技术世界：JavaWeb的由来和基础知识">javaweb</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/cache/探索Redis设计与实现：连接底层与表面的数据结构robj">cache</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/backend/后端技术杂谈：白话虚拟化技术">backend</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/cs/algorithms/剑指offer">cs</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/database/重新学习MySQL数据库：『浅入浅出』MySQL和InnoDB">database</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/distributed/basic/分布式系统理论基础 ：CAP">distributed</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/interview/BATJ-Experience/面阿里,终获offer">interview</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/mq/kafka/消息队列kafka详解：如何实现死信队列">mq</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/code-note-blog/docs/Spring全家桶/Spring/第一个Spring应用">spring</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/mianshi/collection">面试</a><a href="https://aiden-coding.github.io/code-note-blog/SpringCloud%E7%AC%AC3%E5%AD%A32024.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="toggle_XbAW colorModeToggle_r5NY"><button class="clean-btn toggleButton_Jx0n toggleButtonDisabled_zYO7" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_FjAw"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_qmEt"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_wJfS"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_LABv"><div class="docsWrapper_pdvB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_Jioa" type="button"></button><div class="docRoot_qx_v"><aside class="theme-doc-sidebar-container docSidebarContainer_NHKT"><div class="sidebarViewport_uyYB"><div class="sidebar_SZG4"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_VP_k"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/Spring/第一个Spring应用">Spring</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：初探SpringIOC核心流程">Spring源码分析</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：初探SpringIOC核心流程">Spring源码剖析：初探SpringIOC核心流程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：懒加载的单例Bean获取过程分析">Spring源码剖析：懒加载的单例Bean获取过程分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：AOP实现原理详解">Spring源码剖析：AOP实现原理详解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：JDK和cglib动态代理原理详解">Spring源码剖析：JDK和cglib动态代理原理详解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：Spring事务概述">Spring源码剖析：Spring事务概述</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：Spring事务源码剖析">Spring源码剖析：Spring事务源码剖析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：SpringAOP概述">Spring源码剖析：SpringAOP概述</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：SpringIOC容器的加载过程">Spring源码剖析：SpringIOC容器的加载过程</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring启动流程/Spring启动流程（八）：完成BeanFactory的初始化">Spring启动流程</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（二）：事务的执行流程">Spring事务</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（二）：事务的执行流程">Spring事务（二）：事务的执行流程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（六）：事务的隔离级别与传播方式的处理04">Spring事务（六）：事务的隔离级别与传播方式的处理04</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（三）：事务的隔离级别与传播方式的处理01">Spring事务（三）：事务的隔离级别与传播方式的处理01</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（四）：事务的隔离级别与传播方式的处理02">Spring事务（四）：事务的隔离级别与传播方式的处理02</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（五）：事务的隔离级别与传播方式的处理03">Spring事务（五）：事务的隔离级别与传播方式的处理03</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（一）：认识事务组件">Spring事务（一）：认识事务组件</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring重要机制探秘/ConfigurationClassPostProcessor（二）：处理@Bean注解">Spring重要机制探秘</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring组件分析/Spring组件之ApplicationContext">Spring组件分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/SpringAOP/AnnotationAwareAspectJAutoProxyCreator分析（上）">SpringAOP</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringBoot/给你一份SpringBoot知识清单">SpringBoot</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBoot启动流程（四）：启动IOC容器">SpringBoot源码解析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloud/SpringCloudConsul">SpringCloud</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudConfig源码分析">SpringCloud源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba/SpringCloudAlibaba概览">SpringCloudAlibaba</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba源码分析/SpringCloudAlibabaNacos源码分析：服务发现">SpringCloudAlibaba源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringMVC/SpringMVC常见注解">SpringMVC</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/请求执行流程（二）之执行Handler方法">SpringMVC源码分析</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_SejT"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_j3Yw"><div class="docItemContainer_XOSC"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_F6gm" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/code-note-blog/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YCxa"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Spring源码分析</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Spring事务</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Spring事务（一）：认识事务组件</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ToOY theme-doc-toc-mobile tocMobile_suYB"><button type="button" class="clean-btn tocCollapsibleButton_VzP_">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Spring事务（一）：认识事务组件</h1></header><p>前面分析完了 spring aop 相关功能后，本文将来分析 spring aop 的一个应用 —— 事务管理。</p>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="1-从两个-demo-讲起">1. 从两个 demo 讲起<a href="#1-从两个-demo-讲起" class="hash-link" aria-label="Direct link to 1. 从两个 demo 讲起" title="Direct link to 1. 从两个 demo 讲起">​</a></h3>
<p>在正式分析前，我们先来思考下，如果让我们自己来基于 spring aop 来设计一套事务处理机制，该如何实现呢？如果没有 spring，我们的事务处理代码一般长这样：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public void fun() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 开启事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 业务处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        xxx();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 提交事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch(Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 回滚事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rollback();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw e;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>从上面的代码来看，像开启事务、提交事务、回滚事务，都跟业务代码无关，这些可以使用 spring aop 来实现，因此就有了下面两个 demo.</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="demo01基于-around-注解实现事务">demo01：基于 <code>@Around</code> 注解实现事务<a href="#demo01基于-around-注解实现事务" class="hash-link" aria-label="Direct link to demo01基于-around-注解实现事务" title="Direct link to demo01基于-around-注解实现事务">​</a></h4>
<p>咱们可以使用 <code>@Around</code> 注解来操作，代码如下：</p>
<ol>
<li>定义一个注解：<code>@MyTransactional</code></li>
</ol>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Target({ElementType.TYPE, ElementType.METHOD})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Inherited</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Documented</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface MyTransactional {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>定义 aop 操作</li>
</ol>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Aspect</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyAopAspectj {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Pointcut(&quot;@annotation(org.springframework.learn.tx.demo02.MyTransactional)&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void testAop(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Around(&quot;testAop()&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object around(ProceedingJoinPoint p) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;执行前，开启事务....&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object o = p.proceed();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;执行完成，提交事务....&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return o;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;出现了异常，根据异常类型回滚事务....&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw e;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;执行后....&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>config，进行一些必要的配置</li>
</ol>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ComponentScan(&quot;org.springframework.learn.tx.demo02&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableAspectJAutoProxy(proxyTargetClass = true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class TxDemo02Config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>添加一个 service 类，其中一个方法上有 <code>@MyTransactional</code> 注解</li>
</ol>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class TxTestService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @MyTransactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void test01() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;执行test01方法&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void test02() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;执行test02方法&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>主类</li>
</ol>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class TxDemo02Main {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AnnotationConfigApplicationContext applicationContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                = new AnnotationConfigApplicationContext(TxDemo02Config.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TxTestService service = applicationContext.getBean(TxTestService.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;-------------------&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        service.test01();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;-------------------&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        service.test02();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>运行，结果如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">-------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">执行前，开启事务....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">执行test01方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">执行完成，提交事务....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">执行后....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">执行test02方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个 demo 中，我们使用 <code>@Around</code> 注解来拦截业务代码执行前后的情况，可以看到，<code>@Around</code> 注解可以在代码运行前后甚至是出现异常时处理一些额外的操作。</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="demo02自定义-advisor-实现事务">demo02：自定义 <code>advisor</code> 实现事务<a href="#demo02自定义-advisor-实现事务" class="hash-link" aria-label="Direct link to demo02自定义-advisor-实现事务" title="Direct link to demo02自定义-advisor-实现事务">​</a></h4>
<p>让我们回忆下 spring aop 对 <code>@Around</code> 注解的处理，  实际上 <code>@Around</code> 最终会封装为 <code>InstantiationModelAwarePointcutAdvisorImpl</code> 对象，后面的处理就跟 <code>@Around</code> 无关了，<code>@Around</code> 到 <code>InstantiationModelAwarePointcutAdvisorImpl</code> 对象的过程，可参考 <a href="https://my.oschina.net/funcy/blog/4678817" target="_blank" rel="noopener noreferrer">spring aop 之 AnnotationAwareAspectJAutoProxyCreator 分析（上）</a>.</p>
<p><code>InstantiationModelAwarePointcutAdvisorImpl</code> 是个什么东西呢？这是个 <code>advisor</code>，具体来说就是可用于方法的增强。关于 spring aop 是如何找到能应用于当前方法的 <code>advisor</code> 的，可参考 <a href="https://my.oschina.net/funcy/blog/4687961" target="_blank" rel="noopener noreferrer">spring aop 之 AnnotationAwareAspectJAutoProxyCreator 分析（下）</a>。</p>
<p>通过以上分析，给我们提供了另一个思路：我们可以实现 <code>advisor</code> 接口，定制化自己的逻辑，代码如下：</p>
<ol>
<li>准备 <code>advice</code></li>
</ol>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 这个advice就是advisor的一个属性，切面逻辑在这里处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyAdvice implements MethodInterceptor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object invoke(MethodInvocation invocation) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;执行前，开启事务....&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object val = invocation.proceed();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;执行完成，提交事务....&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return val;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;出现了异常，根据异常类型回滚事务....&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw e;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;执行后....&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>准备 <code>pointcut</code></li>
</ol>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 切点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 判断哪些方法能用于该advisor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyPointcut extends StaticMethodMatcherPointcut {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 匹配方法，有 @MyTransactional 的类或方法就返回true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean matches(Method method, Class&lt;?&gt; targetClass) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null != AnnotationUtils.getAnnotation(method, MyTransactional.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                || null != AnnotationUtils.getAnnotation(targetClass, MyTransactional.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>准备 <code>advisor</code></li>
</ol>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * advisor 可看作是 advice 与 pointcut 的包装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyAdvisor extends AbstractBeanFactoryPointcutAdvisor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final long serialVersionUID = 2651364800145442305L;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private MyPointcut pointcut;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public MyAdvisor() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.pointcut = new MyPointcut();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.setAdvice(new MyAdvice());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Pointcut getPointcut() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.pointcut;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上是不同于注解的实现方式，接下来的代码就与注解一样了。</p>
<ol>
<li>准备一个注解：<code>@MyTransactional</code></li>
</ol>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Target({ElementType.TYPE, ElementType.METHOD})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Inherited</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Documented</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface MyTransactional {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>处理项目配置</li>
</ol>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ComponentScan(&quot;org.springframework.learn.tx.demo01&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableAspectJAutoProxy(proxyTargetClass = true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class TxDemo01Config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>准备一个 service</li>
</ol>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class TxTestService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @MyTransactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void test01() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;执行test01方法&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void test02() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;执行test02方法&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>主类</li>
</ol>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class TxDemo01Main {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AnnotationConfigApplicationContext applicationContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                = new AnnotationConfigApplicationContext(TxDemo01Config.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TxTestService service = applicationContext.getBean(TxTestService.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;-------------------&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        service.test01();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;-------------------&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        service.test02();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>运行，结果如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">-------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">执行前，开启事务....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">执行test01方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">执行完成，提交事务....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">执行后....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">执行test02方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="2-使用-spring-事务管理">2. 使用 spring 事务管理<a href="#2-使用-spring-事务管理" class="hash-link" aria-label="Direct link to 2. 使用 spring 事务管理" title="Direct link to 2. 使用 spring 事务管理">​</a></h3>
<p>有了前面的两个小 demo 作为开胃菜，对于 spring 事务处理想必你已有了一个清晰的认识，spring 在处理事务时，使用的就是第二种方式，即往自定义一个 <code>advisor</code> 添加到 spring 容器中。关于 spring 实现任务的具体细节，我们待会分析，这里我们再上一个 demo，体验下我们平时是怎么使用事务的。</p>
<p>为了进行数据库连接，我们需要引入数据库连接池，这里我们使用的是 mysql，需要在 <code>spring-learn.gradle</code> 中添加依赖：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">optional(&quot;mysql:mysql-connector-java:5.1.48&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接着就是代码了。</p>
<ol>
<li>配置类</li>
</ol>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ComponentScan(&quot;org.springframework.learn.tx.demo03&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableTransactionManagement(proxyTargetClass = true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class TxDemo01Config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 生成数据源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataSource dataSource() throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Driver driver = new com.mysql.jdbc.Driver();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String url = &quot;jdbc:mysql://localhost:3306/test&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String username = &quot;root&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String password = &quot;123&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new SimpleDriverDataSource(driver, url, username, password);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 生成jdbcTemplate，后面就是用这个类来处理数据库的操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param dataSource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public JdbcTemplate jdbcTemplate(DataSource dataSource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new JdbcTemplate(dataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 事务管理器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param dataSource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataSourceTransactionManager transactionManager(DataSource dataSource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new DataSourceTransactionManager(dataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>数据库操作类</li>
</ol>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class UserService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private JdbcTemplate jdbcTemplate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 数据库插入操作，使用 @Transactional 开启事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional(rollbackFor = Exception.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int insert() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sql = &quot;insert into `user`(`login_name`, `nick`, `create_time`, `update_time`)&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                + &quot;values (?, ?, ?, ?)&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int result = jdbcTemplate.update(sql, &quot;test&quot;, &quot;test&quot;, new Date(), new Date());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //throw new RuntimeException(&quot;抛出个异常&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>主类</li>
</ol>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class TxDemo01Main {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AnnotationConfigApplicationContext applicationContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                = new AnnotationConfigApplicationContext(TxDemo01Config.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        UserService userService = applicationContext.getBean(UserService.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        userService.insert();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>demo 中，<code>DataSource</code> 使用 spring 自带的 <code>SimpleDriverDataSource</code>，<code>orm</code> 框架也是 spring 提供的 <code>jdbcTemplate</code>，使用的 <code>user</code> 表 sql 如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE `user` (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT &#x27;主键id&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `login_name` varchar(32) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;登录名&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `nick` varchar(32) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;昵称&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `create_time` datetime DEFAULT NULL COMMENT &#x27;创建时间&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  `update_time` datetime DEFAULT NULL COMMENT &#x27;更新时间&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PRIMARY KEY (`id`),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  KEY `create_time` (`create_time`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4 COMMENT=&#x27;用户表&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>执行结果如下：</p>
<p>第一次不抛出异常，数据库结果：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-30bbe23a8e0491d1f59378469ad04703e03.png" alt="" class="img_kGBN"></p>
<p>第二次抛出异常，数据库结果：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-edf98369ccef9735d83813cef7af7ea1dcd.png" alt="" class="img_kGBN"></p>
<p>第三次不抛出异常，数据库结果：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-fab4169dbec7661f27bba203c5e77232f65.png" alt="" class="img_kGBN"></p>
<p>可以看到，第二次抛出异常时，数据正常回滚了。</p>
<p>我们再来分析下这个 demo，跟事务有关的代码有三处：</p>
<ul>
<li><code>@EnableTransactionManagement(proxyTargetClass = true)</code>：启用事务</li>
<li><code>DataSourceTransactionManager</code>：事务管理器</li>
<li><code>@Transactional</code>：指定开启事务的方法</li>
</ul>
<p>类比于 aop 的 <code>@EnableAspectJAutoProxy</code>，<code>@EnableTransactionManagement</code> 是启动事务的入口，接着我们就从这个注解入手，分析 spring 事务的启用流程。</p>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="3-enabletransactionmanagement-注解">3. <code>@EnableTransactionManagement</code> 注解<a href="#3-enabletransactionmanagement-注解" class="hash-link" aria-label="Direct link to 3-enabletransactionmanagement-注解" title="Direct link to 3-enabletransactionmanagement-注解">​</a></h3>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Target(ElementType.TYPE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Documented</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Import(TransactionManagementConfigurationSelector.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface EnableTransactionManagement {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 学完aop后，想必对这个属性已经很熟悉</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * true: 表示强制使用cglib代理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * false：如果目标类实现了接口，则使用jdk动态代理，否则使用cglib代理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 仅在 mode 为 PROXY 下生效</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean proxyTargetClass() default false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * advice模式，使用代理，还是使用 aspectJ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AdviceMode mode() default AdviceMode.PROXY;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 执行顺序，当一个代理对象有多个增强时，按什么样的顺序来执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int order() default Ordered.LOWEST_PRECEDENCE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个注解本身没什么，就三个属性，注释已经很明确了，我们关键还是看这个注解引入的类：<code>TransactionManagementConfigurationSelector</code>：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class TransactionManagementConfigurationSelector extends </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AdviceModeImportSelector&lt;EnableTransactionManagement&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected String[] selectImports(AdviceMode adviceMode) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        switch (adviceMode) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            case PROXY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 基于代理的事务管理，会引入两个类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return new String[] {AutoProxyRegistrar.class.getName(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ProxyTransactionManagementConfiguration.class.getName()};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            case ASPECTJ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 基于aspectJ的事务管理，会引入这个类，本文不分析</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return new String[] {determineTransactionAspectClass()};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 省略其他</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>基于代理的事务管理，会引入两个类：<code>AutoProxyRegistrar</code>、<code>ProxyTransactionManagementConfiguration</code>，接下来我们就来分析这两个类。</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="31-autoproxyregistrar">3.1 <code>AutoProxyRegistrar</code><a href="#31-autoproxyregistrar" class="hash-link" aria-label="Direct link to 31-autoproxyregistrar" title="Direct link to 31-autoproxyregistrar">​</a></h4>
<p>从名字上来看，<code>AutoProxyRegistrar</code> 是一个注册器，还记 得前面 aop 的注册器 <code>AspectJAutoProxyRegistrar</code> 吗，两者一样的套路！</p>
<p>我们来看看里面究竟做了啥：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class AutoProxyRegistrar implements ImportBeanDefinitionRegistrar {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Log logger = LogFactory.getLog(getClass());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            BeanDefinitionRegistry registry) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean candidateFound = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Set&lt;String&gt; annTypes = importingClassMetadata.getAnnotationTypes();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String annType : annTypes) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            AnnotationAttributes candidate = AnnotationConfigUtils</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .attributesFor(importingClassMetadata, annType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (candidate == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object mode = candidate.get(&quot;mode&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object proxyTargetClass = candidate.get(&quot;proxyTargetClass&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 满足if条件的，就是 @EnableTransactionManagement 注解</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (mode != null &amp;&amp; proxyTargetClass != null &amp;&amp; AdviceMode.class == mode.getClass() &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Boolean.class == proxyTargetClass.getClass()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                candidateFound = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (mode == AdviceMode.PROXY) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 注册操作，最终注册了 InfrastructureAdvisorAutoProxyCreator 类，接下来会继续分析</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    AopConfigUtils.registerAutoProxyCreatorIfNecessary(registry);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if ((Boolean) proxyTargetClass) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // 使用cglib代理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        AopConfigUtils.forceAutoProxyCreatorToUseClassProxying(registry);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!candidateFound &amp;&amp; logger.isInfoEnabled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String name = getClass().getSimpleName();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.info(...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这行代码关键的就只有 if 里的几行，先说下 if 条件：<code>mode != null &amp;&amp; proxyTargetClass != null &amp;&amp; AdviceMode.class == mode.getClass() &amp;&amp;Boolean.class == proxyTargetClass.getClass()</code>，通过上面的对 <code>@EnableTransactionManagement</code>，这说的就是它了；对于 <code>mode == AdviceMode.PROXY</code>，继续调用 <code>AopConfigUtils.registerAutoProxyCreatorIfNecessary(registry)</code>（关于这个方法的调用，我们接下来会继续分析）；然后处理 <code>proxyTargetClass</code>，这个属性的作用与 <code>@EnableAspectJAutoProxy</code> 中的 <code>proxyTargetClass</code> 一致，也是可以强制使用 cglib 代理。</p>
<p>接着我们来分析下 <code>AopConfigUtils.registerAutoProxyCreatorIfNecessary(registry)</code> 的过程，跟进代码：</p>
<blockquote>
<p>AopConfigUtils</p>
</blockquote>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">    @Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static BeanDefinition registerAutoProxyCreatorIfNecessary(BeanDefinitionRegistry registry) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 继续往下看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return registerAutoProxyCreatorIfNecessary(registry, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static BeanDefinition registerAutoProxyCreatorIfNecessary(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            BeanDefinitionRegistry registry, @Nullable Object source) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 传入 InfrastructureAdvisorAutoProxyCreator 类，继续调用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return registerOrEscalateApcAsRequired(InfrastructureAdvisorAutoProxyCreator.class, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            registry, source);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>看到这里，是不是有种深深的熟悉感？aop 中的 <code>AspectJAnnotationAutoProxyCreator</code> 也 是这么注册的！进入 <code>AopConfigUtils#registerOrEscalateApcAsRequired</code> 方法：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">// AopConfigUtils 可注册的类都在这里了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private static final List&lt;Class&lt;?&gt;&gt; APC_PRIORITY_LIST = new ArrayList&lt;&gt;(3);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    APC_PRIORITY_LIST.add(InfrastructureAdvisorAutoProxyCreator.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    APC_PRIORITY_LIST.add(AspectJAwareAdvisorAutoProxyCreator.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    APC_PRIORITY_LIST.add(AnnotationAwareAspectJAutoProxyCreator.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 注册操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private static BeanDefinition registerOrEscalateApcAsRequired(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt; cls, BeanDefinitionRegistry registry, @Nullable Object source) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Assert.notNull(registry, &quot;BeanDefinitionRegistry must not be null&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //如果已存在这个bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (registry.containsBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        BeanDefinition apcDefinition = registry.getBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //判断优先级，如果优先级较高则替换原先的bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!cls.getName().equals(apcDefinition.getBeanClassName())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int currentPriority = findPriorityForClass(apcDefinition.getBeanClassName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int requiredPriority = findPriorityForClass(cls);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 已存在类 的优先级 小于正在注册的，则使用正在注册的，已存在的三个类的优先级为</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 0: InfrastructureAdvisorAutoProxyCreator(处理事务)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 1: AspectJAwareAdvisorAutoProxyCreator(处理基于xml的aop)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2: AnnotationAwareAspectJAutoProxyCreator(处理基于注解的aop)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (currentPriority &lt; requiredPriority) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                apcDefinition.setBeanClassName(cls.getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //注册XxxAutoProxyCreator到容器中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RootBeanDefinition beanDefinition = new RootBeanDefinition(cls);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    beanDefinition.setSource(source);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    beanDefinition.getPropertyValues().add(&quot;order&quot;, Ordered.HIGHEST_PRECEDENCE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    registry.registerBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME, beanDefinition);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return beanDefinition;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 查找注册类的优先级</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private static int findPriorityForClass(@Nullable String className) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 0; i &lt; APC_PRIORITY_LIST.size(); i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt; clazz = APC_PRIORITY_LIST.get(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (clazz.getName().equals(className)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw new IllegalArgumentException(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;Class name [&quot; + className + &quot;] is not a known auto-proxy creator class&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>AopConfigUtils</code> 可注册的类有有三个：</p>
<ul>
<li><code>InfrastructureAdvisorAutoProxyCreator</code>：处理事务</li>
<li><code>AspectJAwareAdvisorAutoProxyCreator</code>：处理基于 xml 的 aop</li>
<li><code>AnnotationAwareAspectJAutoProxyCreator</code>：处理基于注解的 aop</li>
</ul>
<p>这三者的优先级为 <code>AnnotationAwareAspectJAutoProxyCreator</code> &gt; <code>AspectJAwareAdvisorAutoProxyCreator</code> &gt; <code>InfrastructureAdvisorAutoProxyCreator</code>，注入时，会判断注入类的优先级，优先级高的最终会被注入到 spring 容器中。这样就导致了一个问题：<strong>如果项目中同时开启了 aop (<code>@EnableAspectJAutoProxy</code>) 与事务 (<code>@EnableTransactionManagement</code>)，那么最终注入到容器的将是 <code>AnnotationAwareAspectJAutoProxyCreator</code>，这也就是说，<code>AnnotationAwareAspectJAutoProxyCreator</code> 也能处理事务！</strong> 这句话非常关键，它意味着事务的处理过程，实际上就包含在前面分析的 aop 的过程中了！</p>
<p>我们也来看看 <code>InfrastructureAdvisorAutoProxyCreator</code>：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">// 继承了 AbstractAdvisorAutoProxyCreator，这个类非常关键</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class InfrastructureAdvisorAutoProxyCreator extends AbstractAdvisorAutoProxyCreator {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ConfigurableListableBeanFactory beanFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void initBeanFactory(ConfigurableListableBeanFactory beanFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super.initBeanFactory(beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.beanFactory = beanFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected boolean isEligibleAdvisorBean(String beanName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (this.beanFactory != null &amp;&amp; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.beanFactory.containsBeanDefinition(beanName) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &amp;&amp;  this.beanFactory.getBeanDefinition(beanName).getRole() </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                == BeanDefinition.ROLE_INFRASTRUCTURE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>InfrastructureAdvisorAutoProxyCreator</code> 其实并没有做什么与 aop 相关的事，但它继承了一个关键的类：<code>AbstractAdvisorAutoProxyCreator</code>，这个类可是大有来头：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-2881f63ac07afc5095c449ddb9a0df2bb55.png" alt="" class="img_kGBN"></p>
<p>从继承关系来看，这个类继承了 <code>AbstractAutoProxyCreator</code>，而 <code>AbstractAutoProxyCreator</code> 正 是我们在 - <a href="https://my.oschina.net/funcy/blog/4678817" target="_blank" rel="noopener noreferrer">spring aop 之 AnnotationAwareAspectJAutoProxyCreator 分析（上）</a> 与 <a href="https://my.oschina.net/funcy/blog/4687961" target="_blank" rel="noopener noreferrer">spring aop 之 AnnotationAwareAspectJAutoProxyCreator 分析（下）</a>中重点分析的、代理对象的产生所在！</p>
<p>我们再来看下 <code>AnnotationAwareAspectJAutoProxyCreator</code>、<code>AspectJAwareAdvisorAutoProxyCreator</code> 、<code>InfrastructureAdvisorAutoProxyCreator</code> 这三者的关系：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-acd72335503eeb686abe81d930b45f1f3f0.png" alt="" class="img_kGBN"></p>
<p>可以看到，<code>AspectJAwareAdvisorAutoProxyCreator</code> 、<code>InfrastructureAdvisorAutoProxyCreator</code> 都继承了 <code>AbstractAdvisorAutoProxyCreator</code>，<code>AnnotationAwareAspectJAutoProxyCreator</code> 又继承了 <code>AspectJAwareAdvisorAutoProxyCreator</code>。</p>
<p>通过以上分析，<code>AutoProxyRegistrar</code> 最终向 spring 容器注册了 <code>InfrastructureAdvisorAutoProxyCreator</code>(<code>aop</code> 未启用的情况下)，如果启用了 <code>aop</code>，则会注册 <code>AspectJAwareAdvisorAutoProxyCreator</code>(基于 <code>xml</code> 的 <code>aop</code>) 或 <code>AnnotationAwareAspectJAutoProxyCreator</code>(基于 <code>annotation</code> 的 <code>aop</code>)。</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="32-proxytransactionmanagementconfiguration">3.2 <code>ProxyTransactionManagementConfiguration</code><a href="#32-proxytransactionmanagementconfiguration" class="hash-link" aria-label="Direct link to 32-proxytransactionmanagementconfiguration" title="Direct link to 32-proxytransactionmanagementconfiguration">​</a></h4>
<p>接下来我们来看看 <code>ProxyTransactionManagementConfiguration</code> 类。名字上来看，这是个配置类：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration(proxyBeanMethods = false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ProxyTransactionManagementConfiguration </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        extends AbstractTransactionManagementConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 读取Spring的 @Transactional 注解，并将相应的事务属性公开给Spring的事务基础结构</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public TransactionAttributeSource transactionAttributeSource() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new AnnotationTransactionAttributeSource();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * TransactionInterceptor继承了Advice，这个类是个advice，用来处理事务的执行操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param transactionAttributeSource：来自于上面的 transactionAttributeSource() 方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public TransactionInterceptor transactionInterceptor(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TransactionAttributeSource transactionAttributeSource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TransactionInterceptor interceptor = new TransactionInterceptor();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 设置事务属性处理对象，就是用来处理 @Transactional 注解 的读取</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        interceptor.setTransactionAttributeSource(transactionAttributeSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.txManager != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            interceptor.setTransactionManager(this.txManager);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return interceptor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 事务增强器.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param transactionAttributeSource：来自于上面的 transactionAttributeSource() 方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param transactionInterceptor：来自于上面的 transactionInterceptor(...) 方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean(name = TransactionManagementConfigUtils.TRANSACTION_ADVISOR_BEAN_NAME)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public BeanFactoryTransactionAttributeSourceAdvisor transactionAdvisor(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TransactionAttributeSource transactionAttributeSource,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TransactionInterceptor transactionInterceptor) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        BeanFactoryTransactionAttributeSourceAdvisor advisor </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                = new BeanFactoryTransactionAttributeSourceAdvisor();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 事务属性类，用来保存 @Transactional 的属性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        advisor.setTransactionAttributeSource(transactionAttributeSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 配置advice，在advice里处理事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        advisor.setAdvice(transactionInterceptor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.enableTx != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            advisor.setOrder(this.enableTx.&lt;Integer&gt;getNumber(&quot;order&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return advisor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可以看到这个类引入了一 些 <code>bean</code>：</p>
<ul>
<li><code>transactionAttributeSource</code>：类型为 <code>AnnotationTransactionAttributeSource</code>，用来解析 <code>@Transactional</code> 注解；</li>
<li><code>transactionInterceptor</code>：类型为 <code>TransactionInterceptor</code>，<code>Advice</code> 的子类，处理事务的逻辑在这个类里；</li>
<li><code>transactionAdvisor</code>：类型为 <code>BeanFactoryTransactionAttributeSourceAdvisor</code>，这是个 <code>Advisor</code>，用来处理切面逻辑，内部集成了上面两个对象：<code>transactionAttributeSource</code> 与 <code>transactionInterceptor</code>；</li>
</ul>
<p><code>ProxyTransactionManagementConfiguration</code> 继承了 <code>AbstractTransactionManagementConfiguration</code>，而 <code>AbstractTransactionManagementConfiguration</code> 中也引入了一些 <code>bean</code>：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractTransactionManagementConfiguration implements ImportAware {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected AnnotationAttributes enableTx;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 保存事务管理器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected TransactionManager txManager;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 来自于 ImportAware 接口的方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setImportMetadata(AnnotationMetadata importMetadata) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.enableTx = AnnotationAttributes.fromMap(importMetadata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .getAnnotationAttributes(EnableTransactionManagement.class.getName(), false));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.enableTx == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalArgumentException(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &quot;@EnableTransactionManagement is not present on importing class &quot; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    + importMetadata.getClassName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 配置事务管理器.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 注入spring容器中所有的 TransactionManagementConfigurer 对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * TransactionManagementConfigurer就只有一个方法：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  TransactionManager annotationDrivenTransactionManager()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 这个方法用来返回一个事务管理器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired(required = false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void setConfigurers(Collection&lt;TransactionManagementConfigurer&gt; configurers) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(configurers)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (configurers.size() &gt; 1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalStateException(&quot;Only one TransactionManagementConfigurer may exist&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TransactionManagementConfigurer configurer = configurers.iterator().next();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.txManager = configurer.annotationDrivenTransactionManager();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 处理事件监听，用来处理 @TransactionalEventListener 注解的方法.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean(name = TransactionManagementConfigUtils.TRANSACTIONAL_EVENT_LISTENER_FACTORY_BEAN_NAME)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static TransactionalEventListenerFactory transactionalEventListenerFactory() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new TransactionalEventListenerFactory();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><code>void setConfigurers(Collection&lt;TransactionManagementConfigurer&gt; configurers)</code>：注入 <code>TransactionManagementConfigurer</code> 对象，具体作用已在代码注释中说明；</li>
<li><code>TransactionalEventListenerFactory</code>：类型为 <code>TransactionalEventListenerFactory</code>，用来处理事务事件（主要是 <code>@TransactionalEventListener</code> 注解的方法，关于这部分的内容，本文就不展开了）。</li>
</ul>
<p>好了，有了这些对象后，spring 就可以进行事务处理了，这些我们留到下篇文章再分析。</p>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="4-总结">4. 总结<a href="#4-总结" class="hash-link" aria-label="Direct link to 4. 总结" title="Direct link to 4. 总结">​</a></h3>
<p>本文先是从两个 demo 入手，示范了如果是由我们自己开发一个基于 spring aop 的事务管理功能是如何进行的，接着又用一个 demo 示范了如何使用 spring 提供的事务管理功能，然后就具体分析了 spring 事务启用注解 <code>@EnableTransactionManagement</code> 的功能。</p>
<p><code>@EnableTransactionManagement</code> 是 spring 中用来启用事务管理功能的，在 <code>AdviceMode</code> 为 <code>proxy</code> 模式下，该注解向 spring 中引入了两个类：<code>AutoProxyRegistrar</code>、<code>ProxyTransactionManagementConfiguration</code>，作用如下：</p>
<ul>
<li>
<p><code>AutoProxyRegistrar</code>：<code>aop</code> 未启用的情况下，会向 spring 容器中注册 <code>InfrastructureAdvisorAutoProxyCreator</code>；如果启用了 <code>aop</code>，则会注册 <code>AspectJAwareAdvisorAutoProxyCreator</code>(基于 <code>xml</code> 的 <code>aop</code>) 或 <code>AnnotationAwareAspectJAutoProxyCreator</code>(基于 <code>annotation</code> 的 <code>aop</code>)。这三个类都是 <code>AbstractAdvisorAutoProxyCreator</code> 的子类，用来生成代理对象。</p>
</li>
<li>
<p><code>ProxyTransactionManagementConfiguration</code>：这是一个配置类，通过带有 <code>@Bean</code> 注解的方法向容器中引入了一系列的 bean，用来处理事务逻辑，对这些 bean，本文只需大概了解即可。</p>
</li>
</ul>
<p>本文就先到这里了，下篇文章继续分析事务处理机制。</p>
<hr>
<p><em>本文原文链接：<a href="https://my.oschina.net/funcy/blog/4773454" target="_blank" rel="noopener noreferrer">https://my.oschina.net/funcy/blog/4773454</a> ，限于作者个人水平，文中难免有错误之处，欢迎指正！原创不易，商业转载请联系作者获得授权，非商业转载请注明出处。</em></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（一）：认识事务组件.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_EYjg" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_eevz"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（五）：事务的隔离级别与传播方式的处理03"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Spring事务（五）：事务的隔离级别与传播方式的处理03</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring重要机制探秘/ConfigurationClassPostProcessor（二）：处理@Bean注解"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">ConfigurationClassPostProcessor（二）：处理@Bean注解</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_lc2k thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-从两个-demo-讲起" class="table-of-contents__link toc-highlight">1. 从两个 demo 讲起</a></li><li><a href="#2-使用-spring-事务管理" class="table-of-contents__link toc-highlight">2. 使用 spring 事务管理</a></li><li><a href="#3-enabletransactionmanagement-注解" class="table-of-contents__link toc-highlight">3. <code>@EnableTransactionManagement</code> 注解</a></li><li><a href="#4-总结" class="table-of-contents__link toc-highlight">4. 总结</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/code-note-blog/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/code-note-blog/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>