<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Spring全家桶/Spring源码分析/Spring事务/Spring事务（四）：事务的隔离级别与传播方式的处理02" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.0">
<title data-rh="true">Spring事务（四）：事务的隔离级别与传播方式的处理02 | Tommy</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aiden-coding.github.io/code-note-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://aiden-coding.github.io/code-note-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（四）：事务的隔离级别与传播方式的处理02"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Spring事务（四）：事务的隔离级别与传播方式的处理02 | Tommy"><meta data-rh="true" name="description" content="本文是《事务的隔离级别与传播方式的处理》分析的第 2 篇，接上文，我们继续。"><meta data-rh="true" property="og:description" content="本文是《事务的隔离级别与传播方式的处理》分析的第 2 篇，接上文，我们继续。"><link data-rh="true" rel="icon" href="/code-note-blog/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（四）：事务的隔离级别与传播方式的处理02"><link data-rh="true" rel="alternate" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（四）：事务的隔离级别与传播方式的处理02" hreflang="en"><link data-rh="true" rel="alternate" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（四）：事务的隔离级别与传播方式的处理02" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/code-note-blog/blog/rss.xml" title="Tommy RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/code-note-blog/blog/atom.xml" title="Tommy Atom Feed"><link rel="stylesheet" href="/code-note-blog/assets/css/styles.dd5372db.css">
<script src="/code-note-blog/assets/js/runtime~main.f999fb27.js" defer="defer"></script>
<script src="/code-note-blog/assets/js/main.a0bfbaed.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_XYiV" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/code-note-blog/"><b class="navbar__title text--truncate">Tommy</b></a><a class="navbar__item navbar__link" href="/code-note-blog/docs/Java/basic/抽象类和接口">java</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/JavaWeb/走进JavaWeb技术世界：JavaWeb的由来和基础知识">javaweb</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/cache/探索Redis设计与实现：连接底层与表面的数据结构robj">cache</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/backend/后端技术杂谈：白话虚拟化技术">backend</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/cs/algorithms/剑指offer">cs</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/database/重新学习MySQL数据库：『浅入浅出』MySQL和InnoDB">database</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/distributed/basic/分布式系统理论基础 ：CAP">distributed</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/interview/BATJ-Experience/面阿里,终获offer">interview</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/mq/kafka/消息队列kafka详解：如何实现死信队列">mq</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/code-note-blog/docs/Spring全家桶/Spring/第一个Spring应用">spring</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/mianshi/collection">面试</a><a href="https://aiden-coding.github.io/code-note-blog/SpringCloud%E7%AC%AC3%E5%AD%A32024.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="toggle_XbAW colorModeToggle_r5NY"><button class="clean-btn toggleButton_Jx0n toggleButtonDisabled_zYO7" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_FjAw"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_qmEt"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_wJfS"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_LABv"><div class="docsWrapper_pdvB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_Jioa" type="button"></button><div class="docRoot_qx_v"><aside class="theme-doc-sidebar-container docSidebarContainer_NHKT"><div class="sidebarViewport_uyYB"><div class="sidebar_SZG4"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_VP_k"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/Spring/第一个Spring应用">Spring</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：初探SpringIOC核心流程">Spring源码分析</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：初探SpringIOC核心流程">Spring源码剖析：初探SpringIOC核心流程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：懒加载的单例Bean获取过程分析">Spring源码剖析：懒加载的单例Bean获取过程分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：AOP实现原理详解">Spring源码剖析：AOP实现原理详解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：JDK和cglib动态代理原理详解">Spring源码剖析：JDK和cglib动态代理原理详解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：Spring事务概述">Spring源码剖析：Spring事务概述</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：Spring事务源码剖析">Spring源码剖析：Spring事务源码剖析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：SpringAOP概述">Spring源码剖析：SpringAOP概述</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：SpringIOC容器的加载过程">Spring源码剖析：SpringIOC容器的加载过程</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring启动流程/Spring启动流程（八）：完成BeanFactory的初始化">Spring启动流程</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（二）：事务的执行流程">Spring事务</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（二）：事务的执行流程">Spring事务（二）：事务的执行流程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（六）：事务的隔离级别与传播方式的处理04">Spring事务（六）：事务的隔离级别与传播方式的处理04</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（三）：事务的隔离级别与传播方式的处理01">Spring事务（三）：事务的隔离级别与传播方式的处理01</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（四）：事务的隔离级别与传播方式的处理02">Spring事务（四）：事务的隔离级别与传播方式的处理02</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（五）：事务的隔离级别与传播方式的处理03">Spring事务（五）：事务的隔离级别与传播方式的处理03</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（一）：认识事务组件">Spring事务（一）：认识事务组件</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring重要机制探秘/ConfigurationClassPostProcessor（二）：处理@Bean注解">Spring重要机制探秘</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring组件分析/Spring组件之ApplicationContext">Spring组件分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/SpringAOP/AnnotationAwareAspectJAutoProxyCreator分析（上）">SpringAOP</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringBoot/给你一份SpringBoot知识清单">SpringBoot</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBoot启动流程（四）：启动IOC容器">SpringBoot源码解析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloud/SpringCloudConsul">SpringCloud</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudConfig源码分析">SpringCloud源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba/SpringCloudAlibaba概览">SpringCloudAlibaba</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba源码分析/SpringCloudAlibabaNacos源码分析：服务发现">SpringCloudAlibaba源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringMVC/SpringMVC常见注解">SpringMVC</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/请求执行流程（二）之执行Handler方法">SpringMVC源码分析</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_SejT"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_j3Yw"><div class="docItemContainer_XOSC"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_F6gm" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/code-note-blog/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YCxa"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Spring源码分析</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Spring事务</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Spring事务（四）：事务的隔离级别与传播方式的处理02</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ToOY theme-doc-toc-mobile tocMobile_suYB"><button type="button" class="clean-btn tocCollapsibleButton_VzP_">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Spring事务（四）：事务的隔离级别与传播方式的处理02</h1></header><p>本文是《事务的隔离级别与传播方式的处理》分析的第 2 篇，接上文，我们继续。</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="35-获取事务信息">3.5 获取事务信息<a href="#35-获取事务信息" class="hash-link" aria-label="Direct link to 3.5 获取事务信息" title="Direct link to 3.5 获取事务信息">​</a></h4>
<p>事务的信息会在 <code>TransactionAspectSupport#createTransactionIfNecessary</code> 方法中获取，这个方法非常重要，前面介绍隔离级别、传播方式都会在这个方法里处理。该方法代码如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected TransactionInfo createTransactionIfNecessary(@Nullable PlatformTransactionManager tm,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Nullable TransactionAttribute txAttr, final String joinpointIdentification) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 如果未指定名称，则将方法名当做事务名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (txAttr != null &amp;&amp; txAttr.getName() == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        txAttr = new DelegatingTransactionAttribute(txAttr) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public String getName() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return joinpointIdentification;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TransactionStatus status = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (txAttr != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (tm != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 获取事务状态，如果当前没有事务，可能会创建事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            status = tm.getTransaction(txAttr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 准备事务信息，就是将前面得到的信息封装成 TransactionInfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return prepareTransactionInfo(tm, txAttr, joinpointIdentification, status);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个方法主要是两个操作：</p>
<ol>
<li>获取事务状态</li>
<li>准备事务信息</li>
</ol>
<p>先来看下获取事务状态的流程，方法为 <code>AbstractPlatformTransactionManager#getTransaction</code>：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public final TransactionStatus getTransaction(@Nullable TransactionDefinition definition)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TransactionDefinition def = (definition != null ? </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            definition : TransactionDefinition.withDefaults());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 获取事务对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object transaction = doGetTransaction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean debugEnabled = logger.isDebugEnabled();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 是否存在事务，存在则返回</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (isExistingTransaction(transaction)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return handleExistingTransaction(def, transaction, debugEnabled);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 运行到了这里，表明当前没有事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 检查超时时间的设置是否合理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (def.getTimeout() &lt; TransactionDefinition.TIMEOUT_DEFAULT) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new InvalidTimeoutException(&quot;Invalid transaction timeout&quot;, def.getTimeout());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // PROPAGATION_MANDATORY：必须在事务中运行，这里没有事务，直接抛异常</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // No existing transaction found -&gt; check propagation behavior to find out how to proceed.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_MANDATORY) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalTransactionStateException(...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 挂起当前事务，创建新事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else if (def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRED ||</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW ||</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // suspend(...) 传入null：如果有同步事务，则挂起同步事务，否则什么也不做</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SuspendedResourcesHolder suspendedResources = suspend(null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 创建事务对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DefaultTransactionStatus status = newTransactionStatus(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    def, transaction, true, newSynchronization, debugEnabled, suspendedResources);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 启动事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            doBegin(transaction, def);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 设置 TransactionSynchronizationManager 的属性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            prepareSynchronization(status, def);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return status;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        catch (RuntimeException | Error ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            resume(null, suspendedResources);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw ex;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return prepareTransactionStatus(def, null, true, newSynchronization, debugEnabled, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个方法有点长，我们慢慢分析。</p>
<h5 class="anchor anchorWithStickyNavbar_HWLp" id="1-dogettransaction获取事务对象">1. <code>doGetTransaction(...)</code>：获取事务对象<a href="#1-dogettransaction获取事务对象" class="hash-link" aria-label="Direct link to 1-dogettransaction获取事务对象" title="Direct link to 1-dogettransaction获取事务对象">​</a></h5>
<p>获取事务对象的方法为 <code>DataSourceTransactionManager#doGetTransaction</code>：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected Object doGetTransaction() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DataSourceTransactionObject txObject = new DataSourceTransactionObject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    txObject.setSavepointAllowed(isNestedTransactionAllowed());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 获取连接信息，obtainDataSource()：获取数据源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConnectionHolder conHolder = </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (ConnectionHolder) TransactionSynchronizationManager.getResource(obtainDataSource());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    txObject.setConnectionHolder(conHolder, false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return txObject;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里有两个操作：</p>
<ol>
<li>获取数据源</li>
<li>获取 <code>ConnectionHolder</code></li>
</ol>
<p>我们先来看看数据源是如何获取的：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSourceTransactionManager extends AbstractPlatformTransactionManager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        implements ResourceTransactionManager, InitializingBean {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private DataSource dataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 构造方法传入了数据源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataSourceTransactionManager(DataSource dataSource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        setDataSource(dataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        afterPropertiesSet();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 设置数据源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setDataSource(@Nullable DataSource dataSource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (dataSource instanceof TransactionAwareDataSourceProxy) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.dataSource = ((TransactionAwareDataSourceProxy) dataSource)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .getTargetDataSource();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.dataSource = dataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataSource getDataSource() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.dataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 获取数据源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected DataSource obtainDataSource() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DataSource dataSource = getDataSource();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assert.state(dataSource != null, &quot;No DataSource set&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return dataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>obtainDataSource()</code> 实际上是调用了 <code>getDataSource()</code> 方法，返回的是 <code>dataSource</code> 成员变量，而 <code>dataSource</code> 又是在 <code>DataSourceTransactionManager</code> 的构造方法里传入的，因此，得到的结论是，这里获取的数据源就是我们在设置 <code>DataSourceTransactionManager</code> 时传入的：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class TxDemo03Config {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 生成数据源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataSource dataSource() throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Driver driver = new com.mysql.jdbc.Driver();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String url = &quot;jdbc:mysql://localhost:3306/test&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String username = &quot;root&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String password = &quot;123&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new SimpleDriverDataSource(driver, url, username, password);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 事务管理器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param dataSource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataSourceTransactionManager transactionManager(DataSource dataSource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new DataSourceTransactionManager(dataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>而这个数据源，正是 <code>SimpleDriverDataSource</code>.</p>
<p>我们再来看看 <code>ConnectionHolder</code> 的获取，该方法为 <code>TransactionSynchronizationManager#getResource</code> ，代码如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">// 用 ThreadLocal 来存放  ConnectionHolder 信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private static final ThreadLocal&lt;Map&lt;Object, Object&gt;&gt; resources =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new NamedThreadLocal&lt;&gt;(&quot;Transactional resources&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 获取 ConnectionHolder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static Object getResource(Object key) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 包装下传入的 key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object actualKey = TransactionSynchronizationUtils.unwrapResourceIfNecessary(key);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 在这里获取连接信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object value = doGetResource(actualKey);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 具体的获取操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private static Object doGetResource(Object actualKey) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 从ThreadLocal中获取</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Map&lt;Object, Object&gt; map = resources.get();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (map == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object value = map.get(actualKey);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (value instanceof ResourceHolder &amp;&amp; ((ResourceHolder) value).isVoid()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        map.remove(actualKey);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (map.isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            resources.remove();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        value = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>从代码来看，<code>TransactionSynchronizationManager</code> 持有一个 <code>ThreadLocal</code> 的实例，其中存放了一个 <code>Map</code>，该 <code>Map</code> 的 <code>key</code> 为 <code>datasource</code>，<code>value</code> 为 <code>ConnectionHolder</code>.</p>
<p>那么这个 <code>ConnectionHolder</code> 是什么呢？可以简单地将其理解为 <code>Connection</code>(数据库连接) 的包装类，其中最重要的属性就是 <code>Connection</code> 了：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-d8c4ae3884177f485fbb95d1828fdb39ae2.png" alt="" class="img_kGBN"></p>
<p>好了，到这里就把 <code>doGetTransaction(xxx)</code> 方法分析完了，再来看看这个方法返回的结果：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-0944429e31a6c0b67e121674202dd5ec0fd.png" alt="" class="img_kGBN"></p>
<h5 class="anchor anchorWithStickyNavbar_HWLp" id="2-isexistingtransaction是否存在事务">2. <code>isExistingTransaction(...)</code>：是否存在事务<a href="#2-isexistingtransaction是否存在事务" class="hash-link" aria-label="Direct link to 2-isexistingtransaction是否存在事务" title="Direct link to 2-isexistingtransaction是否存在事务">​</a></h5>
<p>获取到事务对象 <code>DataSourceTransactionObject</code> 后，接下来就是判断是否存在事务了，判断方法在 <code>DataSourceTransactionManager#isExistingTransaction</code>，代码如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected boolean isExistingTransaction(Object transaction) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DataSourceTransactionObject txObject = (DataSourceTransactionObject) transaction;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (txObject.hasConnectionHolder() </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &amp;&amp; txObject.getConnectionHolder().isTransactionActive());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>ConnectionHolder</code> 中有一个成员变量 <code>transactionActive</code>，它表明当前 <code>ConnectionHolder</code> 的事务是否处于激活状态，<code>isExistingTransaction(...)</code> 方法主要是根据它来判断当前事务对象是否存在事务的。</p>
<h5 class="anchor anchorWithStickyNavbar_HWLp" id="3-处理已存在的事务handleexistingtransaction">3. 处理已存在的事务：<code>handleExistingTransaction(...)</code><a href="#3-处理已存在的事务handleexistingtransaction" class="hash-link" aria-label="Direct link to 3-处理已存在的事务handleexistingtransaction" title="Direct link to 3-处理已存在的事务handleexistingtransaction">​</a></h5>
<p>这里我们来看看如果当前存在事务，spring 是怎么处理的，处理已存在事务的方法为 <code>AbstractPlatformTransactionManager#handleExistingTransaction</code>，代码如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">private TransactionStatus handleExistingTransaction(TransactionDefinition definition, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object transaction, boolean debugEnabled) throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 当传播方式为【不使用事务】时，抛出异常</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NEVER) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalTransactionStateException(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Existing transaction found for transaction marked with propagation &#x27;never&#x27;&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 当传播方式为【不支持事务】时，挂起当前事务，然后在无事务的状态中运行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NOT_SUPPORTED) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1\. suspend()：挂起事务操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object suspendedResources = suspend(transaction);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return prepareTransactionStatus(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                definition, null, false, newSynchronization, debugEnabled, suspendedResources);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 当传播方式为【在新的事务中运行】时，挂起当前事务，然后启动新的事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 挂起事务操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SuspendedResourcesHolder suspendedResources = suspend(transaction);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DefaultTransactionStatus status = newTransactionStatus(definition, transaction, true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    newSynchronization, debugEnabled, suspendedResources);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2\. doBegin()：启动新的事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            doBegin(transaction, definition);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            prepareSynchronization(status, definition);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return status;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        catch (RuntimeException | Error beginEx) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            resumeAfterBeginException(transaction, suspendedResources, beginEx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw beginEx;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 当传播方式为【嵌套执行】时， 设置事务的保存点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 存在事务，将该事务标注保存点，形成嵌套事务。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 嵌套事务中的子事务出现异常不会影响到父事务保存点之前的操作。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!isNestedTransactionAllowed()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new NestedTransactionNotSupportedException(...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3\. createAndHoldSavepoint(...)：创建保存点，回滚时只回滚到该保存点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (useSavepointForNestedTransaction()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DefaultTransactionStatus status = prepareTransactionStatus(definition, transaction,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    false, false, debugEnabled, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            status.createAndHoldSavepoint();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return status;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DefaultTransactionStatus status = newTransactionStatus(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    definition, transaction, true, newSynchronization, debugEnabled, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 如果不支持保存点，就启动新的事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            doBegin(transaction, definition);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            prepareSynchronization(status, definition);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return status;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (isValidateExistingTransaction()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理验证操作，不作分析</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return prepareTransactionStatus(definition, transaction, false, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            newSynchronization, debugEnabled, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可以看到，这个方法里就处理了事务的隔离级别的逻辑，相关的代码已经作了注释，这里就不多说了，不过这里有几个方法需要特别提出：</p>
<ol>
<li><code>suspend()</code>：挂起事务操作</li>
<li><code>doBegin()</code>：启动新的事务</li>
<li><code>createAndHoldSavepoint(...)</code>：创建保存点，回滚时只回滚到该保存点</li>
</ol>
<p>这几个操作包含了事务处理操作，后面我们再统一分析。</p>
<h5 class="anchor anchorWithStickyNavbar_HWLp" id="4-继续-abstractplatformtransactionmanagergettransaction">4. 继续 <code>AbstractPlatformTransactionManager#getTransaction</code><a href="#4-继续-abstractplatformtransactionmanagergettransaction" class="hash-link" aria-label="Direct link to 4-继续-abstractplatformtransactionmanagergettransaction" title="Direct link to 4-继续-abstractplatformtransactionmanagergettransaction">​</a></h5>
<p>让我们再回到 <code>AbstractPlatformTransactionManager#getTransaction</code> 方法，继续剩下的流程：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public final TransactionStatus getTransaction(@Nullable TransactionDefinition definition)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throws TransactionException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 前面已经分析过 了，省略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 运行到了这里，表明当前没有事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 检查超时时间的设置是否合理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (def.getTimeout() &lt; TransactionDefinition.TIMEOUT_DEFAULT) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new InvalidTimeoutException(&quot;Invalid transaction timeout&quot;, def.getTimeout());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // PROPAGATION_MANDATORY：必须在事务中运行，这里没有事务，直接抛异常</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_MANDATORY) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalTransactionStateException(...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 挂起当前事务，创建新事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else if (def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRED ||</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW ||</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // suspend(...) 传入null：如果有同步事务，则挂起同步事务，否则什么也不做</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SuspendedResourcesHolder suspendedResources = suspend(null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 创建事务对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DefaultTransactionStatus status = newTransactionStatus(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    def, transaction, true, newSynchronization, debugEnabled, suspendedResources);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 启动事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            doBegin(transaction, def);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 设置 TransactionSynchronizationManager 的属性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            prepareSynchronization(status, def);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return status;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        catch (RuntimeException | Error ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            resume(null, suspendedResources);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw ex;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return prepareTransactionStatus(def, null, true, newSynchronization, debugEnabled, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>handleExistingTransaction(...)</code> 方法的功能是<strong>当事务存在时，那些个传播类型要怎么处理</strong>，<code>getTransaction(...)</code> 方法余下部分的功能是，<strong>当事务存在时，那些个传播类型又要怎么处理</strong>。可以看到，这里面依然还是有 <code>suspend(...)</code>、<code>doBegin(...)</code> 等方法，这些个方法我们一会也统一分析。</p>
<h5 class="anchor anchorWithStickyNavbar_HWLp" id="5-准备返回结果preparetransactionstatus">5. 准备返回结果：<code>prepareTransactionStatus(...)</code><a href="#5-准备返回结果preparetransactionstatus" class="hash-link" aria-label="Direct link to 5-准备返回结果preparetransactionstatus" title="Direct link to 5-准备返回结果preparetransactionstatus">​</a></h5>
<p><code>handleExistingTransaction(...)</code> 方法与 <code>getTransaction(...)</code> 方法在处理返回结果时，都使用了 <code>prepareTransactionStatus(...)</code> 方法：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">// `handleExistingTransaction(...)`方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return prepareTransactionStatus(definition, transaction, false, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            newSynchronization, debugEnabled, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// `getTransaction(...)`方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return prepareTransactionStatus(def, null, true, newSynchronization, debugEnabled, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们来分析下这个方法是做了啥，进入 <code>AbstractPlatformTransactionManager#prepareTransactionStatus</code>：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected final DefaultTransactionStatus prepareTransactionStatus(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TransactionDefinition definition, @Nullable Object transaction, boolean newTransaction,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean newSynchronization, boolean debug, @Nullable Object suspendedResources) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 创建了一个 DefaultTransactionStatus 对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DefaultTransactionStatus status = newTransactionStatus(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            definition, transaction, newTransaction, newSynchronization, debug, suspendedResources);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 准备 Synchronization</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prepareSynchronization(status, definition);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return status;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *创建一个 TransactionStatus 实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected DefaultTransactionStatus newTransactionStatus(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TransactionDefinition definition, @Nullable Object transaction, boolean newTransaction,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean newSynchronization, boolean debug, @Nullable Object suspendedResources) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean actualNewSynchronization = newSynchronization &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            !TransactionSynchronizationManager.isSynchronizationActive();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 调用 DefaultTransactionStatus 的构造方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new DefaultTransactionStatus(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            transaction, newTransaction, actualNewSynchronization,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            definition.isReadOnly(), debug, suspendedResources);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>所以这个方法主要就是为了创建 <code>DefaultTransactionStatus</code> 对象！我们来看下这一步的运行结果：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-a491ee7ca22238b2d9c698c55ae9dd6d005.png" alt="" class="img_kGBN"></p>
<h5 class="anchor anchorWithStickyNavbar_HWLp" id="6-准备事务信息transactionaspectsupportpreparetransactioninfo">6. 准备事务信息：<code>TransactionAspectSupport#prepareTransactionInfo</code><a href="#6-准备事务信息transactionaspectsupportpreparetransactioninfo" class="hash-link" aria-label="Direct link to 6-准备事务信息transactionaspectsupportpreparetransactioninfo" title="Direct link to 6-准备事务信息transactionaspectsupportpreparetransactioninfo">​</a></h5>
<p>回到 <code>TransactionAspectSupport#createTransactionIfNecessary</code> 方法：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected TransactionInfo createTransactionIfNecessary(@Nullable PlatformTransactionManager tm,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Nullable TransactionAttribute txAttr, final String joinpointIdentification) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TransactionStatus status = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (txAttr != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (tm != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 获取事务状态，如果当前没有事务，可能会创建事务</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            status = tm.getTransaction(txAttr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 准备事务信息，就是将前面得到的信息封装成 TransactionInfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return prepareTransactionInfo(tm, txAttr, joinpointIdentification, status);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>前面分析了那么多，只是得到了 <code>TransactionStatus</code>，我们再接再厉，继续分析准备事务信息的方法 <code>prepareTransactionInfo(...)</code>：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected TransactionInfo prepareTransactionInfo(@Nullable PlatformTransactionManager tm,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Nullable TransactionAttribute txAttr, String joinpointIdentification,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Nullable TransactionStatus status) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TransactionInfo txInfo = new TransactionInfo(tm, txAttr, joinpointIdentification);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (txAttr != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        txInfo.newTransactionStatus(status);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 省略log的打印</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 与线程绑定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    txInfo.bindToThread();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return txInfo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>嗯，同 <code>prepareTransactionStatus(...)</code> 类似，这个方法也是创建了一个 <code>TransactionInfo</code> 对象，并且将 <code>TransactionInfo</code> 与当前线程绑定，绑定的代码如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class TransactionAspectSupport implements BeanFactoryAware, InitializingBean {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 存放当前使用的事物信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ThreadLocal&lt;TransactionInfo&gt; transactionInfoHolder =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new NamedThreadLocal&lt;&gt;(&quot;Current aspect-driven transaction&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 重置为旧的事务信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void cleanupTransactionInfo(@Nullable TransactionInfo txInfo) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (txInfo != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            txInfo.restoreThreadLocalStatus();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * TransactionInfo: 保存事务信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected static final class TransactionInfo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 当前的事务状态对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private TransactionStatus transactionStatus;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 旧的事务信息（也就是挂起的事务信息）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private TransactionInfo oldTransactionInfo;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         * 将事务信息绑定到当前线程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private void bindToThread() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 拿到旧的事务信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.oldTransactionInfo = transactionInfoHolder.get();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 设置成最新的事务信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            transactionInfoHolder.set(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         * 事务完成后，会将旧的事务信息绑定到当前线程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private void restoreThreadLocalStatus() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 设置为旧的事务信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            transactionInfoHolder.set(this.oldTransactionInfo);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>TransactionAspectSupport</code> 中有一个 <code>ThreadLocal</code>，用来存放当前的 <code>TransactionInfo</code> 对象，进行线程绑定时，会先拿到旧的事务信息，保存在 <code>TransactionInfo</code> 的成员变量 <code>oldTransactionInfo</code> 中，然后将新的 <code>TransactionInfo</code> 放入 <code>ThreadLocal</code> 中；当事务执行完成后，会从 <code>TransactionInfo</code> 的成员变量 <code>oldTransactionInfo</code> 中拿到旧的事务信息，再将旧的事务信息放入 <code>ThreadLocal</code> 中，这就完成了事务 &quot;旧 - 新 - 旧&quot; 的切换.</p>
<p>这一步得到的 <code>TransactionInfo</code> 如下：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-ab882613ce67ba3bf7afcbd2eab01c6cf27.png" alt="" class="img_kGBN"></p>
<p>对于 <code>TransactionInfo</code> 的结构，这里作一些说明：</p>
<ul>
<li>类型是 <code>TransactionAspectSupport.TransactionInfo</code>，是 <code>TransactionAspectSupport</code> 的一个内部类，封装了事务的一些信息</li>
<li><code>transactionManager</code>: 事务管理器，就是我们设置的 <code>DataSourceTransactionManager</code></li>
<li><code>transactionAttribute</code>: 事务属性值，用来保存 <code>@Transactional</code> 注解的属性值</li>
<li><code>joinpointIdentification</code>: 方法的全限定名（格式为：&quot;包名。类型。方法名&quot;）</li>
<li><code>transactionStatus</code>: 从名称上看，是记录事务的状态，实际这个对象不仅记录了事务的状态，包括的重大功能如下：<!-- -->
<ul>
<li><code>complete</code>: 事务的完成状态</li>
<li><code>connectionHolder</code>: 当前持有的数据库连接</li>
<li><code>suspendedResources</code>: 挂起的数据库连接，当需要恢复挂起的事务时，可以能过该对象拿到挂起的数据库连接</li>
</ul>
</li>
<li><code>oldTransactionInfo</code>: 上一个事务（也就是挂起的事务）的信息，执行完当前事务后，会恢复到上一个事务的执行</li>
</ul>
<p>一不小心又写了这么长了，本文就先分析到这里了，<code>suspend(...)</code>、<code>doBegin(...)</code> 等方法下篇再分析吧。</p>
<hr>
<p><em>本文原文链接：<a href="https://my.oschina.net/funcy/blog/4947799" target="_blank" rel="noopener noreferrer">https://my.oschina.net/funcy/blog/4947799</a> ，限于作者个人水平，文中难免有错误之处，欢迎指正！原创不易，商业转载请联系作者获得授权，非商业转载请注明出处。</em></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（四）：事务的隔离级别与传播方式的处理02.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_EYjg" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_eevz"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（三）：事务的隔离级别与传播方式的处理01"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Spring事务（三）：事务的隔离级别与传播方式的处理01</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（五）：事务的隔离级别与传播方式的处理03"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Spring事务（五）：事务的隔离级别与传播方式的处理03</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_lc2k thin-scrollbar theme-doc-toc-desktop"></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/code-note-blog/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/code-note-blog/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>