<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Spring全家桶/Spring源码分析/Spring重要机制探秘/Spring探秘之循环依赖的解决（二）：源码分析" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.0">
<title data-rh="true">Spring探秘之循环依赖的解决（二）：源码分析 | Tommy</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aiden-coding.github.io/code-note-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://aiden-coding.github.io/code-note-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring重要机制探秘/Spring探秘之循环依赖的解决（二）：源码分析"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Spring探秘之循环依赖的解决（二）：源码分析 | Tommy"><meta data-rh="true" name="description" content="在 spring 探秘之循环依赖（一）：理论基石一文中 ，我们提到 spring 解决循环依赖的流程如下:"><meta data-rh="true" property="og:description" content="在 spring 探秘之循环依赖（一）：理论基石一文中 ，我们提到 spring 解决循环依赖的流程如下:"><link data-rh="true" rel="icon" href="/code-note-blog/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring重要机制探秘/Spring探秘之循环依赖的解决（二）：源码分析"><link data-rh="true" rel="alternate" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring重要机制探秘/Spring探秘之循环依赖的解决（二）：源码分析" hreflang="en"><link data-rh="true" rel="alternate" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring重要机制探秘/Spring探秘之循环依赖的解决（二）：源码分析" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/code-note-blog/blog/rss.xml" title="Tommy RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/code-note-blog/blog/atom.xml" title="Tommy Atom Feed"><link rel="stylesheet" href="/code-note-blog/assets/css/styles.dd5372db.css">
<script src="/code-note-blog/assets/js/runtime~main.f999fb27.js" defer="defer"></script>
<script src="/code-note-blog/assets/js/main.a0bfbaed.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_XYiV" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/code-note-blog/"><b class="navbar__title text--truncate">Tommy</b></a><a class="navbar__item navbar__link" href="/code-note-blog/docs/Java/basic/抽象类和接口">java</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/JavaWeb/走进JavaWeb技术世界：JavaWeb的由来和基础知识">javaweb</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/cache/探索Redis设计与实现：连接底层与表面的数据结构robj">cache</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/backend/后端技术杂谈：白话虚拟化技术">backend</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/cs/algorithms/剑指offer">cs</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/database/重新学习MySQL数据库：『浅入浅出』MySQL和InnoDB">database</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/distributed/basic/分布式系统理论基础 ：CAP">distributed</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/interview/BATJ-Experience/面阿里,终获offer">interview</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/mq/kafka/消息队列kafka详解：如何实现死信队列">mq</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/code-note-blog/docs/Spring全家桶/Spring/第一个Spring应用">spring</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/mianshi/collection">面试</a><a href="https://aiden-coding.github.io/code-note-blog/SpringCloud%E7%AC%AC3%E5%AD%A32024.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="toggle_XbAW colorModeToggle_r5NY"><button class="clean-btn toggleButton_Jx0n toggleButtonDisabled_zYO7" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_FjAw"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_qmEt"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_wJfS"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_LABv"><div class="docsWrapper_pdvB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_Jioa" type="button"></button><div class="docRoot_qx_v"><aside class="theme-doc-sidebar-container docSidebarContainer_NHKT"><div class="sidebarViewport_uyYB"><div class="sidebar_SZG4"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_VP_k"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/Spring/第一个Spring应用">Spring</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：初探SpringIOC核心流程">Spring源码分析</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：初探SpringIOC核心流程">Spring源码剖析：初探SpringIOC核心流程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：懒加载的单例Bean获取过程分析">Spring源码剖析：懒加载的单例Bean获取过程分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：AOP实现原理详解">Spring源码剖析：AOP实现原理详解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：JDK和cglib动态代理原理详解">Spring源码剖析：JDK和cglib动态代理原理详解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：Spring事务概述">Spring源码剖析：Spring事务概述</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：Spring事务源码剖析">Spring源码剖析：Spring事务源码剖析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：SpringAOP概述">Spring源码剖析：SpringAOP概述</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：SpringIOC容器的加载过程">Spring源码剖析：SpringIOC容器的加载过程</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring启动流程/Spring启动流程（八）：完成BeanFactory的初始化">Spring启动流程</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（二）：事务的执行流程">Spring事务</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring重要机制探秘/ConfigurationClassPostProcessor（二）：处理@Bean注解">Spring重要机制探秘</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring重要机制探秘/ConfigurationClassPostProcessor（二）：处理@Bean注解">ConfigurationClassPostProcessor（二）：处理@Bean注解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring重要机制探秘/ConfigurationClassPostProcessor（三）：处理@Import注解">ConfigurationClassPostProcessor（三）：处理@Import注解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring重要机制探秘/ConfigurationClassPostProcessor（四）：处理@Conditional注解">ConfigurationClassPostProcessor（四）：处理@Conditional注解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring重要机制探秘/ConfigurationClassPostProcessor（一）：处理@ComponentScan注解">ConfigurationClassPostProcessor（一）：处理@ComponentScan注解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring重要机制探秘/Spring探秘之监听器注解EventListener">Spring探秘之监听器注解EventListener</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring重要机制探秘/Spring探秘之循环依赖的解决（二）：源码分析">Spring探秘之循环依赖的解决（二）：源码分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring重要机制探秘/Spring探秘之循环依赖的解决（一）：理论基石">Spring探秘之循环依赖的解决（一）：理论基石</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring重要机制探秘/Spring探秘之组合注解的处理">Spring探秘之组合注解的处理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring重要机制探秘/Spring探秘之AOP的执行顺序">Spring探秘之AOP的执行顺序</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring重要机制探秘/Spring探秘之Spring事件机制">Spring探秘之Spring事件机制</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring组件分析/Spring组件之ApplicationContext">Spring组件分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/SpringAOP/AnnotationAwareAspectJAutoProxyCreator分析（上）">SpringAOP</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringBoot/给你一份SpringBoot知识清单">SpringBoot</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBoot启动流程（四）：启动IOC容器">SpringBoot源码解析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloud/SpringCloudConsul">SpringCloud</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudConfig源码分析">SpringCloud源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba/SpringCloudAlibaba概览">SpringCloudAlibaba</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba源码分析/SpringCloudAlibabaNacos源码分析：服务发现">SpringCloudAlibaba源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringMVC/SpringMVC常见注解">SpringMVC</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/请求执行流程（二）之执行Handler方法">SpringMVC源码分析</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_SejT"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_j3Yw"><div class="docItemContainer_XOSC"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_F6gm" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/code-note-blog/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YCxa"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Spring源码分析</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Spring重要机制探秘</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Spring探秘之循环依赖的解决（二）：源码分析</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ToOY theme-doc-toc-mobile tocMobile_suYB"><button type="button" class="clean-btn tocCollapsibleButton_VzP_">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Spring探秘之循环依赖的解决（二）：源码分析</h1></header><p>在 <a href="https://my.oschina.net/funcy/blog/4659555" target="_blank" rel="noopener noreferrer" title="spring探秘之循环依赖（一）：理论基石">spring 探秘之循环依赖（一）：理论基石</a>一文中 ，我们提到 spring 解决循环依赖的流程如下:</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-dc325a87b321e4c246a1b2f14169821a75a.png" alt="" class="img_kGBN"></p>
<p>为了能让以上流程能顺利进行，spring 中又提供了 5 个数据结构来保存流程中产生的关键信息，这 5 个数据结构如下（下文将这 5 个数据结构称为 <strong>5 大结构</strong>）：</p>
<table><thead><tr><th>结构</th><th>说明</th></tr></thead><tbody><tr><td><code>singletonObjects</code></td><td><strong>一级缓存</strong>，类型为 <code>ConcurrentHashMap&lt;String, Object&gt;</code>，位于 <code>DefaultSingletonBeanRegistry</code> 类中，<code>key</code> 为 <code>beanName</code>，<code>value</code> 是完整的 <code>spring bean</code>，即完成属性注入、初始化的 bean，如果 bean 需要 aop，存储的就是代理对象</td></tr><tr><td><code>earlySingletonObjects</code></td><td><strong>二级缓存</strong>，类型为 <code>HashMap&lt;String, Object&gt;</code>，位于 <code>DefaultSingletonBeanRegistry</code> 类中，<code>key</code> 为 <code>beanName</code>，<code>value</code> 是实例化完成，但未进行依赖注入的 <code>bean</code>，<strong>如果 <code>bean</code> 需要 <code>aop</code>，这里存储的就是代理对象，只不过代理对象所持有的原始对象并未进行依赖注入</strong></td></tr><tr><td><code>singletonFactories</code></td><td><strong>三级缓存</strong>，类型为 <code>HashMap&lt;String, ObjectFactory&gt;</code>，位于 <code>DefaultSingletonBeanRegistry</code> 类中，<code>key</code> 为 <code>beanName</code>，<code>value</code> 存储的是一个 <code>lambda</code> 表达式：<code>() -&gt; getEarlyBeanReference(beanName, mbd, bean)</code>，<code>getEarlyBeanReference(xxx)</code> 中的 <code>bean</code> 是刚创建完成的 <code>java bean</code>，没有进行 spring 依赖注入，也没进行 aop</td></tr><tr><td><code>singletonsCurrentlyInCreation</code></td><td>类型为 <code>SetFromMap&lt;String&gt;</code>，位于 <code>DefaultSingletonBeanRegistry</code>，创建方式为 <code>Collections.newSetFromMap(new ConcurrentHashMap&lt;&gt;(16))</code>，表明这是个由 <code>ConcurrentHashMap</code> 实现的 set，存储的是正在创建中的对象，可以<strong>用来判断当前对象是否在创建中</strong></td></tr><tr><td><code>earlyProxyReferences</code></td><td>类型为 <code>ConcurrentHashMap&lt;Object, Object&gt;</code>，位于 <code>AbstractAutoProxyCreator</code>，存储的是提前进行 aop 的对象，可以<strong>用来判断 bean 是否进行过 aop，保证每个对象只进行一次 aop</strong></td></tr></tbody></table>
<p>了解了这些之后，接下来我们就正式开始进行源码分析了。</p>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="1-准备-demo">1. 准备 demo<a href="#1-准备-demo" class="hash-link" aria-label="Direct link to 1. 准备 demo" title="Direct link to 1. 准备 demo">​</a></h3>
<p>本文中的示例 demo 位于 <a href="https://gitee.com/funcy/spring-framework/tree/v5.2.2.RELEASE_learn/spring-learn/src/main/java/org/springframework/learn/explore/demo03" target="_blank" rel="noopener noreferrer" title="gitee.com/funcy">gitee.com/funcy</a>，这里仅给出关键代码。</p>
<p>准备两个 service：service1，service2，这两个 service 里都有一个代理方法：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Service1 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Service2 service2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Service1() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;调用service1的构造方法&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 标注 @AopAnnotation 了，表明这个方法要被代理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @AopAnnotation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void printAutowired() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;Service1 Autowired:&quot; + service2.getClass());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String toString() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;Service1:&quot; + getClass();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Service2 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Service1 service1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Service2() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;调用service2的构造方法&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 标注 @AopAnnotation 了，表明这个方法要被代理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @AopAnnotation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void printAutowired() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;Service2 Autowired:&quot; + service1.getClass());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String toString() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;Service2:&quot; + this.getClass();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里是主类：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class Demo03Main {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ApplicationContext context = </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new AnnotationConfigApplicationContext(AopAnnotationConfig.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object obj1 = context.getBean(&quot;service1&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object obj2 = context.getBean(&quot;service2&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ((Service1)obj1).printAutowired();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ((Service2)obj2).printAutowired();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在 <code>Service1</code> 中，需要注入属性 <code>service2</code>，在在 <code>Service2</code> 中，需要注入属性 <code>service1</code>，且 <code>Service1</code>、<code>Service2</code> 都需要进行代理，最终 <code>main()</code> 方法执行结果如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">调用service1的构造方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">调用service2的构造方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disconnected from the target VM, address: &#x27;localhost:55518&#x27;, transport: &#x27;socket&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connected to the target VM, address: &#x27;127.0.0.1:55507&#x27;, transport: &#x27;socket&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Around: before execute...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Service1 Autowired:class org.springframework.learn.explore.demo03.Service2$$EnhancerBySpringCGLIB$$e7e367ab</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Around: after execute...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Around: before execute...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Service2 Autowired:class org.springframework.learn.explore.demo03.Service1$$EnhancerBySpringCGLIB$$d447df08</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Around: after execute...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>得到的 obj1、obj2 分别为</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-201844d13a7b489d1a18a8218d6440d6068.png" alt="" class="img_kGBN"></p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-3781280ce3f4da91504b0665ebfd3aed05b.png" alt="" class="img_kGBN"></p>
<p>分析内容，不难得出如下结论：</p>
<ul>
<li><code>service1</code> 与 <code>service2</code> 的 <code>printAutowired()</code> 方法都输出了切面方法的内容，表明两者都代理成功了；</li>
<li>从容器中获取的的 <code>service1</code> 与 <code>service2</code> 都是代理对象；</li>
<li><code>service1</code> 的代理对象持有 <code>service1</code> 的原始对象，<code>service2</code> 的代理对象持有 <code>service2</code> 的原始对象；</li>
<li><code>service1</code> 的原始对象中注入的 <code>service2</code> 为代理对象，<code>service2</code> 的原始对象中注入的 <code>service1</code> 为代理对象。</li>
</ul>
<p>接下来，我们就从源码分析，看 spring 是如何一步步运行，最终得到这个结果的。</p>
<blockquote>
<p><code>service1</code> 与 <code>service2</code> 的代理对象是由 <code>cglib</code> 代理产生的，这部分内容与本文无关，就不分析了。</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="2-第一次调用-abstractbeanfactorygetbeanstring获取-service1">2. 第一次调用 <code>AbstractBeanFactory#getBean(String)</code>：获取 <code>service1</code><a href="#2-第一次调用-abstractbeanfactorygetbeanstring获取-service1" class="hash-link" aria-label="Direct link to 2-第一次调用-abstractbeanfactorygetbeanstring获取-service1" title="Direct link to 2-第一次调用-abstractbeanfactorygetbeanstring获取-service1">​</a></h3>
<p>spring bean 的创建、依赖注入流程是从 <code>AbstractBeanFactory#getBean(String)</code> 方法开始，这一点可参考 <a href="https://my.oschina.net/funcy/blog/4658230" target="_blank" rel="noopener noreferrer">spring 启动流程之完成 BeanFactory 的初始化</a>，我们的源码分析也从这个方法入手。</p>
<p>本文一开始，就提到了 spring 为解决循环依赖的 5 大结构，这里展示如下：</p>
<table><thead><tr><th>结构</th><th>内容</th></tr></thead><tbody><tr><td><code>singletonObjects</code></td><td></td></tr><tr><td><code>earlySingletonObjects</code></td><td></td></tr><tr><td><code>singletonFactories</code></td><td></td></tr><tr><td><code>singletonsCurrentlyInCreation</code></td><td></td></tr><tr><td><code>earlyProxyReferences</code></td><td></td></tr></tbody></table>
<p>一开始，5 大结构中关于 <code>service1</code> 与 <code>service2</code> 的什么数据都没有 ，接下来，我们一边分析代码，一边关注这几个结构中的内容。</p>
<blockquote>
<p>事实上，5 大结构是有内容的，那是 spring 内部提供的一些 bean，但由于我们只关注 <code>service1</code> 与 <code>service2</code> 相关的内容，因此这里不展示。</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="21-abstractbeanfactorydogetbean">2.1 <code>AbstractBeanFactory#doGetBean</code><a href="#21-abstractbeanfactorydogetbean" class="hash-link" aria-label="Direct link to 21-abstractbeanfactorydogetbean" title="Direct link to 21-abstractbeanfactorydogetbean">​</a></h3>
<p>获取 <code>service1</code> 的代码在 <code>AbstractBeanFactory#getBean(String)</code>，但真正的获取操作却是在 <code>AbstractBeanFactory#doGetBean</code> 中，调用链如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">|-AbstractBeanFactory#getBean(String)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> |-AbstractBeanFactory#doGetBean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>代码如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">    protected &lt;T&gt; T doGetBean(final String name, @Nullable final Class&lt;T&gt; requiredType,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Nullable final Object[] args, boolean typeCheckOnly) throws BeansException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1\. 检查是否已初始化，这里会把beanName放入singletonsCurrentlyInCreation中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object sharedInstance = getSingleton(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 如果是单例的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (mbd.isSingleton()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2\. getSingleton(): 创建对象，删除二、三级缓存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sharedInstance = getSingleton(beanName, () -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 执行创建 Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return createBean(beanName, mbd, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                catch (BeansException ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    destroySingleton(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw ex;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 这里如果是普通Bean 的话，直接返回，如果是 FactoryBean 的话，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 返回它创建的那个实例对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上代码经过了精简，我们只保留了主要流程（后续分析中，也会精简代码，只保留主要流程，省略无关代码），这个方法有两个地方需要分析：</p>
<ol>
<li><code>getSingleton(beanName)</code>：获取对象，只从三个缓存中获取；</li>
<li><code>getSingleton(beanName, () -&gt; { ... })</code>：获取对象，创建会在这里创建。</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="22-defaultsingletonbeanregistrygetsingletonstring-boolean">2.2 <code>DefaultSingletonBeanRegistry#getSingleton(String, boolean)</code><a href="#22-defaultsingletonbeanregistrygetsingletonstring-boolean" class="hash-link" aria-label="Direct link to 22-defaultsingletonbeanregistrygetsingletonstring-boolean" title="Direct link to 22-defaultsingletonbeanregistrygetsingletonstring-boolean">​</a></h4>
<p>我们先来看看 <code>getSingleton(beanName)</code>，调用链如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">|-AbstractBeanFactory#getBean(String)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> |-AbstractBeanFactory#doGetBean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |-DefaultSingletonBeanRegistry#getSingleton(String)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |-DefaultSingletonBeanRegistry#getSingleton(String, boolean)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>直接看代码：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * beanName: 传入的值为 service1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * allowEarlyReference：传入的值为 true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected Object getSingleton(String beanName, boolean allowEarlyReference) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1\. 从一级缓存中获取，这里是获取不到</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object singletonObject = this.singletonObjects.get(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 2\. isSingletonCurrentlyInCreation(...) 判断service1是否在创建中，返回 false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (singletonObject == null &amp;&amp; isSingletonCurrentlyInCreation(beanName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 省略下面的代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return singletonObject;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>对上述代码分析如下：</p>
<ol>
<li>
<p>从三级缓存中获取，此时 <code>singletonObjects</code> 里并没有 <code>service1</code>，获取不到；</p>
</li>
<li>
<p>继续，判断 <code>service1</code> 是否在创建中，判断方式如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public boolean isSingletonCurrentlyInCreation(String beanName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return this.singletonsCurrentlyInCreation.contains(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>显然，<code>singletonsCurrentlyInCreation</code> 是没有 <code>service1</code> 的，这里也返回 false.</p>
</li>
</ol>
<p><code>DefaultSingletonBeanRegistry#getSingleton(String, boolean)</code> 运行到这里就返回了，这个方法里下面的返回我们就先不分析了。</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="23-defaultsingletonbeanregistrygetsingletonstring-objectfactory">2.3 <code>DefaultSingletonBeanRegistry#getSingleton(String, ObjectFactory&lt;?&gt;)</code><a href="#23-defaultsingletonbeanregistrygetsingletonstring-objectfactory" class="hash-link" aria-label="Direct link to 23-defaultsingletonbeanregistrygetsingletonstring-objectfactory" title="Direct link to 23-defaultsingletonbeanregistrygetsingletonstring-objectfactory">​</a></h4>
<p>让我们回到 <code>AbstractBeanFactory#doGetBean</code>，接着分析 <code>getSingleton(beanName, () -&gt; { ... })</code>，代码如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * beanName：传入的是service1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * singletonFactory：传入的是lambda表达式，值为</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *           () -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *               try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *                   // 这里就是创建bean的流程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *                   return createBean(beanName, mbd, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *               }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *               catch (BeansException ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *                   destroySingleton(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *                   throw ex;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *               }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assert.notNull(beanName, &quot;Bean name must not be null&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (this.singletonObjects) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 再次判断bean是否已存在</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object singletonObject = this.singletonObjects.get(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (singletonObject == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 1\. 判断当前正在实例化的bean是否存在正在创建中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 这个方法会beanName添加到 singletonsCurrentlyInCreation 中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                beforeSingletonCreation(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 2\. 在这里进行bean的创建</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    singletonObject = singletonFactory.getObject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                catch (...) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return singletonObject;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>按照代码中的注释内容，我们分析主要步骤：</p>
<ol>
<li>
<p>判断当前正在实例化的 bean 是否存在正在创建中，就是判断当前对象是否在 <code>singletonsCurrentlyInCreation</code> 中，如果存在则抛出异常，不存在则添加到 <code>singletonsCurrentlyInCreation</code> 中；</p>
<p>运行完之后这一行代码后，5 大结构中的内容如下：</p>
<table><thead><tr><th>结构</th><th>内容</th></tr></thead><tbody><tr><td><code>singletonObjects</code></td><td></td></tr><tr><td><code>earlySingletonObjects</code></td><td></td></tr><tr><td><code>singletonFactories</code></td><td></td></tr><tr><td><code>singletonsCurrentlyInCreation</code></td><td>service1</td></tr><tr><td><code>earlyProxyReferences</code></td><td></td></tr></tbody></table>
</li>
<li>
<p>进行 bean 的创建过程，<code>singletonFactory.getObject()</code> 运行的实际上是传入的 lambda 表达式：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">() -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 执行创建 Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return createBean(beanName, mbd, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catch (BeansException ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        destroySingleton(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw ex;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>也就是 <code>AbstractAutowireCapableBeanFactory#createBean(String, RootBeanDefinition, Object[])</code>，这 个方法是接下来分析的重点；</p>
</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="24-abstractautowirecapablebeanfactorydocreatebean">2.4 <code>AbstractAutowireCapableBeanFactory#doCreateBean</code><a href="#24-abstractautowirecapablebeanfactorydocreatebean" class="hash-link" aria-label="Direct link to 24-abstractautowirecapablebeanfactorydocreatebean" title="Direct link to 24-abstractautowirecapablebeanfactorydocreatebean">​</a></h4>
<p>从代码上来看，<code>AbstractAutowireCapableBeanFactory#createBean(String, RootBeanDefinition, Object[])</code> 并没有做什么实质性内容，我们就直接来到 <code>AbstractAutowireCapableBeanFactory#doCreateBean</code> 了，这其中经历的千山万水如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">|-AbstractBeanFactory#getBean(String)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> |-AbstractBeanFactory#doGetBean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |-DefaultSingletonBeanRegistry#getSingleton(String, ObjectFactory&lt;?&gt;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |-AbstractAutowireCapableBeanFactory#createBean(String, RootBeanDefinition, Object[])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-AbstractAutowireCapableBeanFactory#doCreateBean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>AbstractAutowireCapableBeanFactory#doCreateBean</code> 内容如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final @Nullable Object[] args) throws BeanCreationException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BeanWrapper instanceWrapper = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (instanceWrapper == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1\. 实例化 Bean，调用java反射进行实例化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        instanceWrapper = createBeanInstance(beanName, mbd, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //bean实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final Object bean = instanceWrapper.getWrappedInstance();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //bean类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (beanType != NullBean.class) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mbd.resolvedTargetType = beanType;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    synchronized (mbd.postProcessingLock) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!mbd.postProcessed) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 调用 AutowiredAnnotationBeanPostProcessor#postProcessMergedBeanDefinition 方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 2\. 获取需要注入的属性与方法（标注 @Autowired 注解）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new BeanCreationException(mbd.getResourceDescription(), beanName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &quot;Post-processing of merged bean definition failed&quot;, ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mbd.postProcessed = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 解决循环依赖问题, 是否允许循环依赖, allowCircularReferences默认为true，可以关闭</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean earlySingletonExposure = (mbd.isSingleton() &amp;&amp; this.allowCircularReferences &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            isSingletonCurrentlyInCreation(beanName));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (earlySingletonExposure) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3\. 将 bean 添加到 singletonFactories</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object exposedObject = bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4\. 属性注入，发现需要注入 service2，然后再调用 getBean(&quot;service2&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        populateBean(beanName, mbd, instanceWrapper);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个方法进行的步骤如下：</p>
<ol>
<li>
<p>实例化 Bean，调用 java 反射进行实例化，这个就不多说了，实例化后的 <code>service1</code> 如下，可以看到 <code>service2</code> 还是 <code>null</code>（表明未进行属性注入）：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-8b2f5fdf0efd6beb7f62d4f35f5c5562b83.png" alt="" class="img_kGBN"></p>
</li>
<li>
<p>获取需要注入的属性与方法，<strong>必须在原始对象中才能获取到，代理对象是获取不到的</strong>，查找 <code>@Autowired</code> 的 <code>beanPostProcessor</code> 是 <code>AutowiredAnnotationBeanPostProcessor</code>；</p>
</li>
<li>
<p>将 bean 添加到 <code>singletonFactories</code> 中，添加过程如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected void addSingletonFactory(String beanName, ObjectFactory&lt;?&gt; singletonFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Assert.notNull(singletonFactory, &quot;Singleton factory must not be null&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    synchronized (this.singletonObjects) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 如果单例池当中不存在才会add</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!this.singletonObjects.containsKey(beanName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 把工厂对象put到singletonFactories</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.singletonFactories.put(beanName, singletonFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 删除二级缓存中的对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.earlySingletonObjects.remove(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.registeredSingletons.add(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>加入的对象为</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-3d9a56a0d655fe1e95d8857095fb46aa71a.png" alt="" class="img_kGBN"></p>
<p>此时那 5 个结构中的内容如下：</p>
<table><thead><tr><th>结构</th><th>内容</th></tr></thead><tbody><tr><td><code>singletonObjects</code></td><td></td></tr><tr><td><code>earlySingletonObjects</code></td><td></td></tr><tr><td><code>singletonFactories</code></td><td>lambda(service1)</td></tr><tr><td><code>singletonsCurrentlyInCreation</code></td><td>service1</td></tr><tr><td><code>earlyProxyReferences</code></td><td></td></tr></tbody></table>
<p><code>lambda(service1)</code> 实际内容为 <code>() -&gt; getEarlyBeanReference(beanName, mbd, bean)</code>，这个 <code>lambda</code> 表达式所做的就是进行 aop 操作，具体内容等运行的时候我们再分析。</p>
</li>
<li>
<p>属性注入，在第 2 步中，spring 找到 <code>service1</code> 需要注入对象有 <code>service2</code>，这里会再调用 <code>beanFactory.getBean(&quot;service2&quot;)</code> 进入 <code>service2</code> 的生命周期，这又回到了 <code>AbstractBeanFactory#getBean(String)</code> 方法。</p>
<p>从 <code>populateBean(xxx)</code> 到 <code>getBean(xxx)</code> 的步骤相当多，调用链如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">|-AbstractBeanFactory#getBean(String)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> |-AbstractBeanFactory#doGetBean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |-DefaultSingletonBeanRegistry#getSingleton(String, ObjectFactory&lt;?&gt;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |-AbstractAutowireCapableBeanFactory#createBean(String, RootBeanDefinition, Object[])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-AbstractAutowireCapableBeanFactory#doCreateBean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     // 这里进行依赖注入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |-AbstractAutowireCapableBeanFactory#populateBean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |-AutowiredAnnotationBeanPostProcessor#postProcessProperties</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       |-InjectionMetadata#inject</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-AutowiredAnnotationBeanPostProcessor.AutowiredFieldElement#inject</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         |-DefaultListableBeanFactory#resolveDependency</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          |-DefaultListableBeanFactory#doResolveDependency</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           |-DependencyDescriptor#resolveCandidate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |-AbstractBeanFactory#getBean(String)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>看一眼 <code>DependencyDescriptor#resolveCandidate</code>，调用的正是 <code>beanFactory.getBean(String)</code> 方法：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public Object resolveCandidate(String beanName, Class&lt;?&gt; requiredType, BeanFactory beanFactory)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throws BeansException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return beanFactory.getBean(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ol>
<p>到了这里，<code>service1</code> 的获取流程就先停一下，因为 <code>service1</code> 要注入 <code>service2</code>，接下来就开始获取 <code>service2</code> 的流程。</p>
<p>本小节结束时，5 大结构中的内容如下：</p>
<table><thead><tr><th>结构</th><th>内容</th></tr></thead><tbody><tr><td><code>singletonObjects</code></td><td></td></tr><tr><td><code>earlySingletonObjects</code></td><td></td></tr><tr><td><code>singletonFactories</code></td><td>lambda(service1)</td></tr><tr><td><code>singletonsCurrentlyInCreation</code></td><td>service1</td></tr><tr><td><code>earlyProxyReferences</code></td><td></td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="3-第二次调用-abstractbeanfactorygetbeanstring获取-service2">3. 第二次调用 <code>AbstractBeanFactory#getBean(String)</code>：获取 <code>service2</code><a href="#3-第二次调用-abstractbeanfactorygetbeanstring获取-service2" class="hash-link" aria-label="Direct link to 3-第二次调用-abstractbeanfactorygetbeanstring获取-service2" title="Direct link to 3-第二次调用-abstractbeanfactorygetbeanstring获取-service2">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="31-abstractbeanfactorydogetbean">3.1 <code>AbstractBeanFactory#doGetBean</code><a href="#31-abstractbeanfactorydogetbean" class="hash-link" aria-label="Direct link to 31-abstractbeanfactorydogetbean" title="Direct link to 31-abstractbeanfactorydogetbean">​</a></h4>
<p>这一步跟获取 <code>service1</code> 的流程基本一致，不同的是 <code>beanName</code> 是 <code>service2</code>，不再分析。</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="32-defaultsingletonbeanregistrygetsingletonstring-boolean">3.2 <code>DefaultSingletonBeanRegistry#getSingleton(String, boolean)</code><a href="#32-defaultsingletonbeanregistrygetsingletonstring-boolean" class="hash-link" aria-label="Direct link to 32-defaultsingletonbeanregistrygetsingletonstring-boolean" title="Direct link to 32-defaultsingletonbeanregistrygetsingletonstring-boolean">​</a></h4>
<p>这一步跟获取 <code>service1</code> 的流程基本一致，不同的是 <code>beanName</code> 是 <code>service2</code>，不再分析。</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="33-defaultsingletonbeanregistrygetsingletonstring-objectfactory">3.3 <code>DefaultSingletonBeanRegistry#getSingleton(String, ObjectFactory&lt;?&gt;)</code><a href="#33-defaultsingletonbeanregistrygetsingletonstring-objectfactory" class="hash-link" aria-label="Direct link to 33-defaultsingletonbeanregistrygetsingletonstring-objectfactory" title="Direct link to 33-defaultsingletonbeanregistrygetsingletonstring-objectfactory">​</a></h4>
<p>这一步跟获取 <code>service1</code> 的流程基本一致，不同的是 <code>beanName</code> 是 <code>service2</code>，具体内容不再分析。</p>
<p><code>service2</code> 会在这一步加入 到 <code>singletonsCurrentlyInCreation</code> 结构中，这一步之后，5 大结构中的内容如下：</p>
<table><thead><tr><th>结构</th><th>内容</th></tr></thead><tbody><tr><td><code>singletonObjects</code></td><td></td></tr><tr><td><code>earlySingletonObjects</code></td><td></td></tr><tr><td><code>singletonFactories</code></td><td>lambda(service1)</td></tr><tr><td><code>singletonsCurrentlyInCreation</code></td><td>service1, service2</td></tr><tr><td><code>earlyProxyReferences</code></td><td></td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="34-abstractautowirecapablebeanfactorydocreatebean">3.4 <code>AbstractAutowireCapableBeanFactory#doCreateBean</code><a href="#34-abstractautowirecapablebeanfactorydocreatebean" class="hash-link" aria-label="Direct link to 34-abstractautowirecapablebeanfactorydocreatebean" title="Direct link to 34-abstractautowirecapablebeanfactorydocreatebean">​</a></h4>
<p>这一步跟获取 <code>service1</code> 的流程基本一致，说明如下：</p>
<ol>
<li>
<p>对象创建，这里会创建 <code>service2</code>，创建完成后的对象如下：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-393811afa91cc1ff696b02ce6d683c97640.png" alt="" class="img_kGBN"></p>
<p>同样的，<code>service2</code> 中的属性 <code>service1</code> 也为 <code>null</code>；</p>
</li>
<li>
<p>获取需要注入的属性与方法，<code>service2</code> 的属性 <code>service1</code> 会被找到，因为该属性标注有 <code>@Autowired</code> 注解；</p>
</li>
<li>
<p>将 bean 添加到 <code>singletonFactories</code> 中，这一步之后，5 个结构中的内容如下：</p>
<table><thead><tr><th>结构</th><th>内容</th></tr></thead><tbody><tr><td><code>singletonObjects</code></td><td></td></tr><tr><td><code>earlySingletonObjects</code></td><td></td></tr><tr><td><code>singletonFactories</code></td><td>lambda(service1), lambda(service2)</td></tr><tr><td><code>singletonsCurrentlyInCreation</code></td><td>service1, service2</td></tr><tr><td><code>earlyProxyReferences</code></td><td></td></tr></tbody></table>
<p>这一步的关键在于，<code>service2</code> 添加到三级缓存中了；</p>
</li>
<li>
<p>属性注入，在第 2 步中，spring 找到 <code>service2</code> 需要注入对象有 <code>service1</code>，这  里会再调用 <code>getBean(&quot;service2&quot;)</code> 方法，又回到了 <code>AbstractBeanFactory#getBean(String)</code> 方法了。</p>
</li>
</ol>
<p>到了这里，<code>service2</code> 的获取流程也要先停一下了，因为 <code>service2</code> 要注入 <code>service1</code>，接下来又要开始获取 <code>service1</code> 的流程。</p>
<p>本小节结束时，5 个结构中的内容如下：</p>
<table><thead><tr><th>结构</th><th>内容</th></tr></thead><tbody><tr><td><code>singletonObjects</code></td><td></td></tr><tr><td><code>earlySingletonObjects</code></td><td></td></tr><tr><td><code>singletonFactories</code></td><td>lambda(service1), lambda(service2)</td></tr><tr><td><code>singletonsCurrentlyInCreation</code></td><td>service1, service2</td></tr><tr><td><code>earlyProxyReferences</code></td><td></td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="4-第三次调用-abstractbeanfactorygetbeanstring再次获取-service1">4. 第三次调用 <code>AbstractBeanFactory#getBean(String)</code>：再次获取 <code>service1</code><a href="#4-第三次调用-abstractbeanfactorygetbeanstring再次获取-service1" class="hash-link" aria-label="Direct link to 4-第三次调用-abstractbeanfactorygetbeanstring再次获取-service1" title="Direct link to 4-第三次调用-abstractbeanfactorygetbeanstring再次获取-service1">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="41-abstractbeanfactorydogetbean">4.1 <code>AbstractBeanFactory#doGetBean</code><a href="#41-abstractbeanfactorydogetbean" class="hash-link" aria-label="Direct link to 41-abstractbeanfactorydogetbean" title="Direct link to 41-abstractbeanfactorydogetbean">​</a></h4>
<p><code>AbstractBeanFactory#doGetBean</code> 代码如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">    protected &lt;T&gt; T doGetBean(final String name, @Nullable final Class&lt;T&gt; requiredType,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Nullable final Object[] args, boolean typeCheckOnly) throws BeansException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1\. 检查是否已初始化，这里会把beanName放入singletonsCurrentlyInCreation中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object sharedInstance = getSingleton(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在运行到 <code>Object sharedInstance = getSingleton(beanName)</code> 前，<code>AbstractBeanFactory#doGetBean</code> 的运行流  程与前面两小节无区别，在 <code>Object sharedInstance = getSingleton(beanName)</code> 里就有了变化，接下来我们来看看 <code>getSingleton(beanName)</code> 的执行。</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="42-defaultsingletonbeanregistrygetsingletonstring-boolean">4.2 <code>DefaultSingletonBeanRegistry#getSingleton(String, boolean)</code><a href="#42-defaultsingletonbeanregistrygetsingletonstring-boolean" class="hash-link" aria-label="Direct link to 42-defaultsingletonbeanregistrygetsingletonstring-boolean" title="Direct link to 42-defaultsingletonbeanregistrygetsingletonstring-boolean">​</a></h4>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * beanName: 传入的值为 service1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * allowEarlyReference：传入的值为 true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected Object getSingleton(String beanName, boolean allowEarlyReference) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1\. 从一级缓存中获取，这里是获取不到</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object singletonObject = this.singletonObjects.get(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 2\. isSingletonCurrentlyInCreation(...) 判断service1是否在创建中  ，返回 true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (singletonObject == null &amp;&amp; isSingletonCurrentlyInCreation(beanName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            synchronized (this.singletonObjects) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 3\. 从二级缓存中获取，这里也获取不到</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                singletonObject = this.earlySingletonObjects.get(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 4\. 传入的allowEarlyReference是true，继续执行里面的内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (singletonObject == null &amp;&amp; allowEarlyReference) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 5\. 从三级缓存中获取，能获取到</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ObjectFactory&lt;?&gt; singletonFactory = this.singletonFactories.get(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (singletonFactory != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // 6\. 调用 singletonFactory.getObject()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // 最终调用的是 AbstractAutowireCapableBeanFactory.getEarlyBeanReference 方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        singletonObject = singletonFactory.getObject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // 7\. 处理缓存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // 放到二级缓存中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        this.earlySingletonObjects.put(beanName, singletonObject);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // 从三级缓存中清除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        this.singletonFactories.remove(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return singletonObject;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在分析代码前，先来看看此时 5 大结构中的内容：</p>
<table><thead><tr><th>结构</th><th>内容</th></tr></thead><tbody><tr><td><code>singletonObjects</code></td><td></td></tr><tr><td><code>earlySingletonObjects</code></td><td></td></tr><tr><td><code>singletonFactories</code></td><td>lambda(service1), lambda(service2)</td></tr><tr><td><code>singletonsCurrentlyInCreation</code></td><td>service1, service2</td></tr><tr><td><code>earlyProxyReferences</code></td><td></td></tr></tbody></table>
<p>对照着上面的内容，分析如下：</p>
<ol>
<li>
<p>从一级缓存中获取，对照着 5 个结构中的内容，获取不到，返回 <code>null</code>;</p>
</li>
<li>
<p><code>isSingletonCurrentlyInCreation(...)</code> 判断 <code>service1</code> 是否在创建中，对照着 5 个结构中的内容，<code>service1</code> 在 <code>singletonsCurrentlyInCreation</code> 中，返回 true，继续下面的流程，<strong>这是与第一次获取 <code>service1</code> 的不同之处</strong>；</p>
</li>
<li>
<p>继续从二级缓存中获取，对照着 5 个结构中的内容，<code>service1</code> 不在 <code>earlySingletonObjects</code>，依然返回 <code>null</code>；</p>
</li>
<li>
<p><code>allowEarlyReference</code> 是传入的参数，为 <code>true</code>，继续执行 下面的代码；</p>
</li>
<li>
<p>继续从从三级缓存中获取，对照着 5 个结构中的内容，<code>service1</code> 在 <code>singletonFactories</code> 中，这里能获取到，返回的结果如下：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-57677e20855580e5bc2f5163d87ecfda7d2.png" alt="" class="img_kGBN"></p>
</li>
<li>
<p>调用 <code>singletonFactory.getObject()</code> 方法，当初我们传入 <code>singletonFactories</code> 的还是个 lambda 表达式：<code>() -&gt; getEarlyBeanReference(beanName, mbd, bean)</code>，调用 <code>singletonFactory.getObject()</code> 最终调用的就是 <code>AbstractAutowireCapableBeanFactory#getEarlyBeanReference</code>：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected Object getEarlyBeanReference(String beanName, RootBeanDefinition mbd, Object bean) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object exposedObject = bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (BeanPostProcessor bp : getBeanPostProcessors()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (bp instanceof SmartInstantiationAwareBeanPostProcessor) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 调用后置处理器，这里完成了aop操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                SmartInstantiationAwareBeanPostProcessor ibp = </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      (SmartInstantiationAwareBeanPostProcessor) bp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 调用 `AbstractAutoProxyCreator#getEarlyBeanReference`，提前进行 aop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                exposedObject = ibp.getEarlyBeanReference(exposedObject, beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return exposedObject;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们跟进 <code>AbstractAutoProxyCreator#getEarlyBeanReference</code> 方法：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public Object getEarlyBeanReference(Object bean, String beanName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object cacheKey = getCacheKey(bean.getClass(), beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.earlyProxyReferences.put(cacheKey, bean);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 这里生成代理对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return wrapIfNecessary(bean, beanName, cacheKey);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>关于 aop 的流程，可参考 <a href="https://my.oschina.net/funcy/blog/4687961" target="_blank" rel="noopener noreferrer">spring aop 之 AnnotationAwareAspectJAutoProxyCreator 分析（下）</a>，这里就不再分析了。执行完 <code>AbstractAutoProxyCreator#getEarlyBeanReference</code> 之后，5 个结构中的内容如下：</p>
<table><thead><tr><th>结构</th><th>内容</th></tr></thead><tbody><tr><td><code>singletonObjects</code></td><td></td></tr><tr><td><code>earlySingletonObjects</code></td><td></td></tr><tr><td><code>singletonFactories</code></td><td>lambda(service1), lambda(service2)</td></tr><tr><td><code>singletonsCurrentlyInCreation</code></td><td>service1, service2</td></tr><tr><td><code>earlyProxyReferences</code></td><td>service1</td></tr></tbody></table>
<p>让我们再回到 <code>getSingleton</code> 方法，执行完 <code>singletonFactory.getObject()</code> 后，得到的 <code>singletonObject</code> 为</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-cf72a8ff3d91c3d2a4e300741ba7f0268e6.png" alt="" class="img_kGBN"></p>
<p>这是一个代理对象，并且 <code>service2</code> 为 <code>null</code>。</p>
</li>
<li>
<p>接下来就是处理缓存了，一些 map 的 put 与 remove 操作，就不多说了。</p>
</li>
</ol>
<p><code>DefaultSingletonBeanRegistry#getSingleton(String, boolean)</code> 方法执行完成后，5 个结构中的内容如下：</p>
<table><thead><tr><th>结构</th><th>内容</th></tr></thead><tbody><tr><td><code>singletonObjects</code></td><td></td></tr><tr><td><code>earlySingletonObjects</code></td><td>service1</td></tr><tr><td><code>singletonFactories</code></td><td>lambda(service2)</td></tr><tr><td><code>singletonsCurrentlyInCreation</code></td><td>service1, service2</td></tr><tr><td><code>earlyProxyReferences</code></td><td>service1</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="43-再次回到-abstractbeanfactorydogetbean">4.3 再次回到 <code>AbstractBeanFactory#doGetBean</code><a href="#43-再次回到-abstractbeanfactorydogetbean" class="hash-link" aria-label="Direct link to 43-再次回到-abstractbeanfactorydogetbean" title="Direct link to 43-再次回到-abstractbeanfactorydogetbean">​</a></h4>
<p>执行完 <code>DefaultSingletonBeanRegistry#getSingleton(String, boolean)</code> 后，我们再回到 <code>AbstractBeanFactory#doGetBean</code>：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected &lt;T&gt; T doGetBean(final String name, @Nullable final Class&lt;T&gt; requiredType,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Nullable final Object[] args, boolean typeCheckOnly) throws BeansException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 检查是否已初始化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object sharedInstance = getSingleton(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1\. 这次能获取到对象，if 里面的代码会执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (sharedInstance != null &amp;&amp; args == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2\. 这里如果是普通Bean 的话，直接返回，如果是 FactoryBean 的话，返回它创建的那个实例对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 这里的bean是service1的代理对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bean = getObjectForBeanInstance(sharedInstance, name, beanName, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 这里的代码不会执行到，就不分析了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 处理bean的转换操作，这里返回false，不会执行到</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (requiredType != null &amp;&amp; !requiredType.isInstance(bean)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 3\. 返回从`getSingleton(beanName)`得到的对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>
<p>这次能获取到对象，if 里面的代码会执行；</p>
</li>
<li>
<p><code>service1</code> 不是 <code>FactoryBean</code>，与 <code>getSingleton(beanName)</code> 得到的对象是同一个对象，内容如下：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-0cd9c129bf2387d85a7bee4f4e135143f63.png" alt="" class="img_kGBN"></p>
</li>
<li>
<p>返回从 <code>getSingleton(beanName)</code> 得到的对象，在 <code>getSingleton(beanName)</code> 中返回的对象不为空后，就不再执行 bean 的创建流程了，最终返回的是第 2 步中得到的 bean 了。</p>
</li>
</ol>
<p>到了这里，我们终于获取到了 <code>service1</code> 的代理对象，尽管代理对象对应的原始对象并没有完成依赖注入，但我们依然可以进行后续的流程，即获取到 <code>service1</code> 的代理对象后，<code>service2</code> 就可以进行依赖注入，继续接下来的流程了。</p>
<p>最后，我们再来看看本节执行完之后，5 大结构中的内容：</p>
<table><thead><tr><th>结构</th><th>内容</th></tr></thead><tbody><tr><td><code>singletonObjects</code></td><td></td></tr><tr><td><code>earlySingletonObjects</code></td><td>service1$$EnhancerBySpringCGLIB</td></tr><tr><td><code>singletonFactories</code></td><td>lambda(service2)</td></tr><tr><td><code>singletonsCurrentlyInCreation</code></td><td>service1, service2</td></tr><tr><td><code>earlyProxyReferences</code></td><td>service1</td></tr></tbody></table>
<p>获取到 <code>service1</code> 后，接下来就继续 <code>service2</code> 的获取流程了。</p>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="5-继续-service2-的获取流程">5 继续 <code>service2</code> 的获取流程<a href="#5-继续-service2-的获取流程" class="hash-link" aria-label="Direct link to 5-继续-service2-的获取流程" title="Direct link to 5-继续-service2-的获取流程">​</a></h3>
<p>在第 3 节中，因为 <code>service2</code> 需要注入 <code>service1</code>，才有了第 4 部分的再次获取 <code>service1</code> 的流程，最终也成功地 获取到了 <code>service1</code> 的代理对象 <code>service1$$EnhancerBySpringCGLIB</code>，这才让 <code>service2</code> 得以完成依赖注入。</p>
<p>接下来，让我们延续 第 3 节 的流程，回到 <code>AbstractAutowireCapableBeanFactory#doCreateBean</code>，继续 <code>service2</code> 的流程。</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="51-回到-abstractautowirecapablebeanfactorydocreatebean">5.1 回到 <code>AbstractAutowireCapableBeanFactory#doCreateBean</code><a href="#51-回到-abstractautowirecapablebeanfactorydocreatebean" class="hash-link" aria-label="Direct link to 51-回到-abstractautowirecapablebeanfactorydocreatebean" title="Direct link to 51-回到-abstractautowirecapablebeanfactorydocreatebean">​</a></h4>
<p>代码如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            final @Nullable Object[] args) throws BeanCreationException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 上面的代码在 3.2 中已经分析过了，就不再分析了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object exposedObject = bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 1\. 负责属性装配, 也就是我们常常说的依赖注入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            populateBean(beanName, mbd, instanceWrapper);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2\. 初始化，在这里会处理 aop 操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //同样的，如果存在循环依赖</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (earlySingletonExposure) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 3\. 从缓存中获取 beanName 对应的bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object earlySingletonReference = getSingleton(beanName, false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 4\. earlySingletonReference 为 null，if 里面的内容不会执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (earlySingletonReference != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 省略不重要的代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return exposedObject;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>代码说明如下：</p>
<ol>
<li>
<p>处理依赖注入，就是这里触发了第 4 部分的流程，执行完得到的 <code>service2</code> 如下：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-b294a02be5431c0aa66e5f126a6c6abbb92.png" alt="" class="img_kGBN"></p>
<p>可以看到，此时注入到 <code>service2</code> 中的 <code>service1</code> 就是代理对象了；</p>
</li>
<li>
<p>初始化，在这里会处理 aop 操作，执行 aop 的方法为 <code>AbstractAutoProxyCreator#postProcessAfterInitialization</code>，代码如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">// 传入的bean为service2，beanName为“service2”</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Object postProcessAfterInitialization(@Nullable Object bean, String beanName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (bean != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object cacheKey = getCacheKey(bean.getClass(), beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1\. earlyProxyReferences 中并没有 service2，if里的代码会执行到</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.earlyProxyReferences.remove(cacheKey) != bean) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2\. 在这里处理aop操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return wrapIfNecessary(bean, beanName, cacheKey);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上代码先从 <code>earlyProxyReferences</code> 移出 <code>service2</code>，然后再与传入的 bean 做比较，对照着 5 大结构中的内容，我们发现 <code>service2</code> 并不在 <code>earlyProxyReferences</code> 中；</p>
<table><thead><tr><th>结构</th><th>内容</th></tr></thead><tbody><tr><td><code>singletonObjects</code></td><td></td></tr><tr><td><code>earlySingletonObjects</code></td><td>service1$$EnhancerBySpringCGLIB</td></tr><tr><td><code>singletonFactories</code></td><td>lambda(service2)</td></tr><tr><td><code>singletonsCurrentlyInCreation</code></td><td>service1, service2</td></tr><tr><td><code>earlyProxyReferences</code></td><td>service1</td></tr></tbody></table>
<p>因此，这里返回 <code>null</code>，显然不等于传入的 bean，因此 if 中的代码会执行，<code>service2</code> 进行 aop。执行完这一步后，得到的 <code>exposedObject</code> 为：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-d62ebdbb71b76ada963a01c9b8c84b88b00.png" alt="" class="img_kGBN"></p>
<p><code>service2</code> 也变成了代理对象，且已完成了依赖注入。</p>
</li>
<li>
<p>从缓存中获取 beanName 对应的 bean，执行的是 <code>DefaultSingletonBeanRegistry#getSingleton(String, boolean)</code>，代码如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * beanName: service2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * allowEarlyReference：false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected Object getSingleton(String beanName, boolean allowEarlyReference) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1\. 从一级缓存中获取 service2，获取不到，返回null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object singletonObject = this.singletonObjects.get(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 2\. 判断 service2 是否在创建中，返回true，执行if中的代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (singletonObject == null &amp;&amp; isSingletonCurrentlyInCreation(beanName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (this.singletonObjects) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 3\. 从二级缓存中获取 service2，获取不到，返回null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            singletonObject = this.earlySingletonObjects.get(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 4\. 此时传入的 allowEarlyReference 为false，if块的代码不会执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (singletonObject == null &amp;&amp; allowEarlyReference) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return singletonObject;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们还是来看 一眼 5 大结构中的内容，对这个方法的执行就一目了然了：</p>
<table><thead><tr><th>结构</th><th>内容</th></tr></thead><tbody><tr><td><code>singletonObjects</code></td><td></td></tr><tr><td><code>earlySingletonObjects</code></td><td>service1$$EnhancerBySpringCGLIB</td></tr><tr><td><code>singletonFactories</code></td><td>lambda(service2)</td></tr><tr><td><code>singletonsCurrentlyInCreation</code></td><td>service1, service2</td></tr><tr><td><code>earlyProxyReferences</code></td><td>service1</td></tr></tbody></table>
<p>方法的执行，在代码中已经注释得很明白了，就多说了；</p>
</li>
<li>
<p>第 3 步返回的 <code>earlySingletonReference</code> 为 null，if 里面的内容不会执行。</p>
</li>
</ol>
<p>到这里，得到的 <code>service2</code> 就返回了。</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="52-回到-defaultsingletonbeanregistrygetsingletonstring-objectfactory">5.2 回到 <code>DefaultSingletonBeanRegistry#getSingleton(String, ObjectFactory&lt;?&gt;)</code><a href="#52-回到-defaultsingletonbeanregistrygetsingletonstring-objectfactory" class="hash-link" aria-label="Direct link to 52-回到-defaultsingletonbeanregistrygetsingletonstring-objectfactory" title="Direct link to 52-回到-defaultsingletonbeanregistrygetsingletonstring-objectfactory">​</a></h4>
<p>得到 <code>service2</code> 的 bean 后，我们回到 <code>DefaultSingletonBeanRegistry#getSingleton(String, ObjectFactory&lt;?&gt;)</code>，继续 <code>service2</code> 的流程，代码如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public Object getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Assert.notNull(beanName, &quot;Bean name must not be null&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    synchronized (this.singletonObjects) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 1\. 在这里进行bean的创建</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                singletonObject = singletonFactory.getObject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                newSingleton = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            catch (...) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 2\. 创建完成后，做一些检查操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 这里会把 service2 从 singletonsCurrentlyInCreation 移除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                afterSingletonCreation(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (newSingleton) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 3\. 将该对象添加到 beanFactory 中，这个方法会删除二三级缓存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                addSingleton(beanName, singletonObject);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return singletonObject;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>说明如下：</p>
<ol>
<li>
<p>历经千难万险，<code>singletonFactory.getObject()</code> 终于执行完了，在诸多曲折之后，最终还是得到了 <code>service2</code> 的代理对象；</p>
</li>
<li>
<p><code>service2</code> 创建完成后，就会将其从 <code>singletonsCurrentlyInCreation</code> 移除，方法比较简单，就不多说了，这一步得到的 5 大结构如下：</p>
<table><thead><tr><th>结构</th><th>内容</th></tr></thead><tbody><tr><td><code>singletonObjects</code></td><td></td></tr><tr><td><code>earlySingletonObjects</code></td><td>service1$$EnhancerBySpringCGLIB</td></tr><tr><td><code>singletonFactories</code></td><td>lambda(service2)</td></tr><tr><td><code>singletonsCurrentlyInCreation</code></td><td>service1</td></tr><tr><td><code>earlyProxyReferences</code></td><td>service1</td></tr></tbody></table>
</li>
<li>
<p>接着，就是缓存的处理，方法为 <code>DefaultSingletonBeanRegistry#addSingleton</code>：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * beanName：service2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * singletonObject：service2$$EnhancerBySpringCGLIB(service2的代理对象)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected void addSingleton(String beanName, Object singletonObject) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    synchronized (this.singletonObjects) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 对三个缓存进行put、remove操作，最终只在一级缓存  中有该对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.singletonObjects.put(beanName, singletonObject);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.singletonFactories.remove(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.earlySingletonObjects.remove(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.registeredSingletons.add(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>方法比较简单，就不多说了，最终 5 大结构为：</p>
<table><thead><tr><th>结构</th><th>内容</th></tr></thead><tbody><tr><td><code>singletonObjects</code></td><td>service2$$EnhancerBySpringCGLIB</td></tr><tr><td><code>earlySingletonObjects</code></td><td>service1$$EnhancerBySpringCGLIB</td></tr><tr><td><code>singletonFactories</code></td><td></td></tr><tr><td><code>singletonsCurrentlyInCreation</code></td><td>service1</td></tr><tr><td><code>earlyProxyReferences</code></td><td>service1</td></tr></tbody></table>
</li>
</ol>
<p>到此，<code>service2</code> 获取完成，最终保存到 <code>singletonObjects</code> 中的 bean 为：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-763dad35376ed1d88086c45f01ee9c4cedd.png" alt="" class="img_kGBN"></p>
<p>本节的最后，我们也来看下 5 个结构中的内容：</p>
<table><thead><tr><th>结构</th><th>内容</th></tr></thead><tbody><tr><td><code>singletonObjects</code></td><td>service2$$EnhancerBySpringCGLIB</td></tr><tr><td><code>earlySingletonObjects</code></td><td>service1$$EnhancerBySpringCGLIB</td></tr><tr><td><code>singletonFactories</code></td><td></td></tr><tr><td><code>singletonsCurrentlyInCreation</code></td><td>service1</td></tr><tr><td><code>earlyProxyReferences</code></td><td>service1</td></tr></tbody></table>
<p>至此，<code>service2</code> 获取完成，接着让我们继续 <code>service1</code> 的获取流程。</p>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="6-继续-service1-的获取流程">6 继续 <code>service1</code> 的获取流程<a href="#6-继续-service1-的获取流程" class="hash-link" aria-label="Direct link to 6-继续-service1-的获取流程" title="Direct link to 6-继续-service1-的获取流程">​</a></h3>
<p>在第 2 节中，因为 <code>servic1</code> 需要注入 <code>service2</code>，才有了第 3 节获取 <code>service2</code> 的流程，然后又经过一系列的操作后，最终在第 5 节成功地获取到了 <code>service2</code> 的代理对象 <code>service2$$EnhancerBySpringCGLIB</code>，这才让 <code>service2</code> 得以完成依赖注入。</p>
<p>接下来，让我们延续第 2 节，回到 <code>AbstractAutowireCapableBeanFactory#doCreateBean</code> 方法，继续 <code>service1</code> 的流程。</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="61-回到-abstractautowirecapablebeanfactorydocreatebean">6.1 回到 <code>AbstractAutowireCapableBeanFactory#doCreateBean</code><a href="#61-回到-abstractautowirecapablebeanfactorydocreatebean" class="hash-link" aria-label="Direct link to 61-回到-abstractautowirecapablebeanfactorydocreatebean" title="Direct link to 61-回到-abstractautowirecapablebeanfactorydocreatebean">​</a></h4>
<p>代码如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            final @Nullable Object[] args) throws BeanCreationException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 上面的代码在 3.1 中已经分析过了，就不再分析了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object exposedObject = bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 1\. 负责属性装配, 也就是我们常常说的依赖注入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            populateBean(beanName, mbd, instanceWrapper);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2\. 初 始化，在这里会处理 aop 操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //同样的，如果存在循环依赖</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (earlySingletonExposure) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 3\. 从缓存中获取 beanName 对应的bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object earlySingletonReference = getSingleton(beanName, false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 4\. earlySingletonReference 不为 null，if 里面的内容会执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (earlySingletonReference != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (exposedObject == bean) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 5\. 将返回的对象赋值给 exposedObject，返回对象为代理对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    exposedObject = earlySingletonReference;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 省略不重要的代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return exposedObject;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>代码说明如下：</p>
<ol>
<li>
<p>处理依赖注入，就是这里触发了第 3 节的流程，执行完得到的 <code>service1</code> 如下：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-3883285be5904e056bc517d35bfd44c47a0.png" alt="" class="img_kGBN"></p>
<p>可以看到，<code>service1</code> 已经完成了依赖注入，且此时注入到 <code>service1</code> 中的 <code>service2</code> 已经是代理对象了，不过 <code>service1</code> 此时还是原始对象，我们继续往下看；</p>
</li>
<li>
<p>初始化，在这里会处理 aop 操作，执行 aop 的方法为 <code>AbstractAutoProxyCreator#postProcessAfterInitialization</code>，代码如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">// 传入的bean为service1，beanName为“service1”</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Object postProcessAfterInitialization(@Nullable Object bean, String beanName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (bean != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object cacheKey = getCacheKey(bean.getClass(), beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1\. earlyProxyReferences 中有 service1，if里的代码不会执行到</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.earlyProxyReferences.remove(cacheKey) != bean) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2\. 在这里处理aop操作，service1 已经执行过aop了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return wrapIfNecessary(bean, beanName, cacheKey);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上代码先从 <code>earlyProxyReferences</code> 移出 <code>service1</code>，然后再与传入的 bean 做比较，对照着 5 大结构中的内容，我们发现 <code>service1</code> 此时就在 <code>earlyProxyReferences</code> 中；</p>
<table><thead><tr><th>结构</th><th>内容</th></tr></thead><tbody><tr><td><code>singletonObjects</code></td><td>service2$$EnhancerBySpringCGLIB</td></tr><tr><td><code>earlySingletonObjects</code></td><td>service1$$EnhancerBySpringCGLIB</td></tr><tr><td><code>singletonFactories</code></td><td></td></tr><tr><td><code>singletonsCurrentlyInCreation</code></td><td>service1</td></tr><tr><td><code>earlyProxyReferences</code></td><td>service1</td></tr></tbody></table>
<p>因此，这里会返回 <code>service1</code>，if 中的代码不会执行。执行完这一步后，5 个结构中的内容为：</p>
<table><thead><tr><th>结构</th><th>内容</th></tr></thead><tbody><tr><td><code>singletonObjects</code></td><td>service2$$EnhancerBySpringCGLIB</td></tr><tr><td><code>earlySingletonObjects</code></td><td>service1$$EnhancerBySpringCGLIB</td></tr><tr><td><code>singletonFactories</code></td><td></td></tr><tr><td><code>singletonsCurrentlyInCreation</code></td><td>service1</td></tr><tr><td><code>earlyProxyReferences</code></td><td></td></tr></tbody></table>
</li>
<li>
<p>从缓存中获取 beanName 对应的 bean，执行的是 <code>DefaultSingletonBeanRegistry#getSingleton(String, boolean)</code>，代码如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * beanName: service1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * allowEarlyReference：false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected Object getSingleton(String beanName, boolean allowEarlyReference) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1\. 从一级缓存中获取 service1，获取不到，返回null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object singletonObject = this.singletonObjects.get(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 2\. 判断 service1 是否在创建中，返回true，执行if中的代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (singletonObject == null &amp;&amp; isSingletonCurrentlyInCreation(beanName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (this.singletonObjects) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 3\. 从二级缓存中获取 service1，能获取到</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            singletonObject = this.earlySingletonObjects.get(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 4\. singletonObject 不为null，if块的代码不会执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (singletonObject == null &amp;&amp; allowEarlyReference) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return singletonObject;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们看 一眼 5 大结构中的内容，对这个方法的执行就一目了然了：</p>
<table><thead><tr><th>结构</th><th>内容</th></tr></thead><tbody><tr><td><code>singletonObjects</code></td><td>service2$$EnhancerBySpringCGLIB</td></tr><tr><td><code>earlySingletonObjects</code></td><td>service1$$EnhancerBySpringCGLIB</td></tr><tr><td><code>singletonFactories</code></td><td></td></tr><tr><td><code>singletonsCurrentlyInCreation</code></td><td>service1</td></tr><tr><td><code>earlyProxyReferences</code></td><td></td></tr></tbody></table>
<p>方法的执行，在代码中已经注释得很明白了，就多说了，这一步会把 <code>service1</code> 的代理对象返回；</p>
</li>
<li>
<p>上一步得到的 <code>earlySingletonReference</code> 为</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-425636328820897c75890f01614d94fe9dd.png" alt="" class="img_kGBN"></p>
<p>代理对象已经返回来了，可以继续执行 if 块的代码了；</p>
</li>
<li>
<p>最后一步是赋值操作，将返回的对象赋值给 <code>exposedObject</code>，然后返回 <code>exposedObject</code>，最终返回的对象为 <code>service1</code> 的代理对象。</p>
</li>
</ol>
<p>到了这一步，<code>service1</code> 的代理对象也获取完成了。</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="62-回到-defaultsingletonbeanregistrygetsingletonstring-objectfactory">6.2 回到 <code>DefaultSingletonBeanRegistry#getSingleton(String, ObjectFactory&lt;?&gt;)</code><a href="#62-回到-defaultsingletonbeanregistrygetsingletonstring-objectfactory" class="hash-link" aria-label="Direct link to 62-回到-defaultsingletonbeanregistrygetsingletonstring-objectfactory" title="Direct link to 62-回到-defaultsingletonbeanregistrygetsingletonstring-objectfactory">​</a></h4>
<p>这一步的操作是清理一些缓存，就不再分析了，最终 5 个结构中的内容如下：</p>
<table><thead><tr><th>结构</th><th>内容</th></tr></thead><tbody><tr><td><code>singletonObjects</code></td><td>service2$$EnhancerBySpringCGLIB,service1$$EnhancerBySpringCGLIB</td></tr><tr><td><code>earlySingletonObjects</code></td><td></td></tr><tr><td><code>singletonFactories</code></td><td></td></tr><tr><td><code>singletonsCurrentlyInCreation</code></td><td></td></tr><tr><td><code>earlyProxyReferences</code></td><td></td></tr></tbody></table>
<p>通过调试，查看得到 <code>singletonObjects</code> 中对象如下：</p>
<ol>
<li>
<p>service1</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-b6ba35a7a701056ae55a8f9b2ef9345cac5.png" alt="" class="img_kGBN"></p>
</li>
<li>
<p>service2</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-563d6e323ef8fc5e9fd02f7a938ddbac655.png" alt="" class="img_kGBN"></p>
</li>
</ol>
<p>可以看到，<code>singletonObjects</code> 中两者都是代理对象，彼此注入的，也是代理对象，循环依赖得到了解决。</p>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="4-总结">4. 总结<a href="#4-总结" class="hash-link" aria-label="Direct link to 4. 总结" title="Direct link to 4. 总结">​</a></h3>
<p>spring 循环依赖的分析到这里就结束了，循环依赖有解的核心在于<strong>对象可以提前进行 aop</strong>，spring 正是利用这一点，再配合 5 大结构存储必要的信息，一步步解决循环依赖问题。</p>
<hr>
<p><em>本文原文链接：<a href="https://my.oschina.net/funcy/blog/4815992" target="_blank" rel="noopener noreferrer">https://my.oschina.net/funcy/blog/4815992</a> ，限于作者个人水平，文中难免有错误之处，欢迎指正！原创不易，商业转载请联系作者获得授权，非商业转载请注明出处。</em></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Spring全家桶/Spring源码分析/Spring重要机制探秘/Spring探秘之循环依赖的解决（二）：源码分析.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_EYjg" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_eevz"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring重要机制探秘/Spring探秘之监听器注解EventListener"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Spring探秘之监听器注解EventListener</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring重要机制探秘/Spring探秘之循环依赖的解决（一）：理论基石"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Spring探秘之循环依赖的解决（一）：理论基石</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_lc2k thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-准备-demo" class="table-of-contents__link toc-highlight">1. 准备 demo</a></li><li><a href="#2-第一次调用-abstractbeanfactorygetbeanstring获取-service1" class="table-of-contents__link toc-highlight">2. 第一次调用 <code>AbstractBeanFactory#getBean(String)</code>：获取 <code>service1</code></a></li><li><a href="#21-abstractbeanfactorydogetbean" class="table-of-contents__link toc-highlight">2.1 <code>AbstractBeanFactory#doGetBean</code></a></li><li><a href="#3-第二次调用-abstractbeanfactorygetbeanstring获取-service2" class="table-of-contents__link toc-highlight">3. 第二次调用 <code>AbstractBeanFactory#getBean(String)</code>：获取 <code>service2</code></a></li><li><a href="#4-第三次调用-abstractbeanfactorygetbeanstring再次获取-service1" class="table-of-contents__link toc-highlight">4. 第三次调用 <code>AbstractBeanFactory#getBean(String)</code>：再次获取 <code>service1</code></a></li><li><a href="#5-继续-service2-的获取流程" class="table-of-contents__link toc-highlight">5 继续 <code>service2</code> 的获取流程</a></li><li><a href="#6-继续-service1-的获取流程" class="table-of-contents__link toc-highlight">6 继续 <code>service1</code> 的获取流程</a></li><li><a href="#4-总结" class="table-of-contents__link toc-highlight">4. 总结</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/code-note-blog/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/code-note-blog/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>