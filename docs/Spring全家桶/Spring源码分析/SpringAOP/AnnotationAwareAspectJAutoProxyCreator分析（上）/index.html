<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Spring全家桶/Spring源码分析/SpringAOP/AnnotationAwareAspectJAutoProxyCreator分析（上）" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.0">
<title data-rh="true">AnnotationAwareAspectJAutoProxyCreator分析（上） | Tommy</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aiden-coding.github.io/code-note-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://aiden-coding.github.io/code-note-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/Spring源码分析/SpringAOP/AnnotationAwareAspectJAutoProxyCreator分析（上）"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="AnnotationAwareAspectJAutoProxyCreator分析（上） | Tommy"><meta data-rh="true" name="description" content="在上一篇文章的分析中，我们介绍了使用 @EnableAspectJAutoProxy 开启用 spring aop 功能，而 @EnableAspectJAutoProxy 最终向 spring 中引入了一个类：AnnotationAwareAspectJAutoProxyCreator，本文就从该类入手，进 一步分析 spring aop 功能。"><meta data-rh="true" property="og:description" content="在上一篇文章的分析中，我们介绍了使用 @EnableAspectJAutoProxy 开启用 spring aop 功能，而 @EnableAspectJAutoProxy 最终向 spring 中引入了一个类：AnnotationAwareAspectJAutoProxyCreator，本文就从该类入手，进 一步分析 spring aop 功能。"><link data-rh="true" rel="icon" href="/code-note-blog/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/Spring源码分析/SpringAOP/AnnotationAwareAspectJAutoProxyCreator分析（上）"><link data-rh="true" rel="alternate" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/Spring源码分析/SpringAOP/AnnotationAwareAspectJAutoProxyCreator分析（上）" hreflang="en"><link data-rh="true" rel="alternate" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/Spring源码分析/SpringAOP/AnnotationAwareAspectJAutoProxyCreator分析（上）" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/code-note-blog/blog/rss.xml" title="Tommy RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/code-note-blog/blog/atom.xml" title="Tommy Atom Feed"><link rel="stylesheet" href="/code-note-blog/assets/css/styles.dd5372db.css">
<script src="/code-note-blog/assets/js/runtime~main.f999fb27.js" defer="defer"></script>
<script src="/code-note-blog/assets/js/main.a0bfbaed.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_XYiV" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/code-note-blog/"><b class="navbar__title text--truncate">Tommy</b></a><a class="navbar__item navbar__link" href="/code-note-blog/docs/Java/basic/抽象类和接口">java</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/JavaWeb/走进JavaWeb技术世界：JavaWeb的由来和基础知识">javaweb</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/cache/探索Redis设计与实现：连接底层与表面的数据结构robj">cache</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/backend/后端技术杂谈：白话虚拟化技术">backend</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/cs/algorithms/剑指offer">cs</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/database/重新学习MySQL数据库：『浅入浅出』MySQL和InnoDB">database</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/distributed/basic/分布式系统理论基础 ：CAP">distributed</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/interview/BATJ-Experience/面阿里,终获offer">interview</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/mq/kafka/消息队列kafka详解：如何实现死信队列">mq</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/code-note-blog/docs/Spring全家桶/Spring/第一个Spring应用">spring</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/mianshi/collection">面试</a><a href="https://aiden-coding.github.io/code-note-blog/SpringCloud%E7%AC%AC3%E5%AD%A32024.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="toggle_XbAW colorModeToggle_r5NY"><button class="clean-btn toggleButton_Jx0n toggleButtonDisabled_zYO7" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_FjAw"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_qmEt"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_wJfS"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_LABv"><div class="docsWrapper_pdvB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_Jioa" type="button"></button><div class="docRoot_qx_v"><aside class="theme-doc-sidebar-container docSidebarContainer_NHKT"><div class="sidebarViewport_uyYB"><div class="sidebar_SZG4"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_VP_k"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/Spring/第一个Spring应用">Spring</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：初探SpringIOC核心流程">Spring源码分析</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：初探SpringIOC核心流程">Spring源码剖析：初探SpringIOC核心流程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：懒加载的单例Bean获取过程分析">Spring源码剖析：懒加载的单例Bean获取过程分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：AOP实现原理详解">Spring源码剖析：AOP实现原理详解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：JDK和cglib动态代理原理详解">Spring源码剖析：JDK和cglib动态代理原理详解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：Spring事务概述">Spring源码剖析：Spring事务概述</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：Spring事务源码剖析">Spring源码剖析：Spring事务源码剖析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：SpringAOP概述">Spring源码剖析：SpringAOP概述</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：SpringIOC容器的加载过程">Spring源码剖析：SpringIOC容器的加载过程</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring启动流程/Spring启动流程（八）：完成BeanFactory的初始化">Spring启动流程</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（二）：事务的执行流程">Spring事务</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring重要机制探秘/ConfigurationClassPostProcessor（二）：处理@Bean注解">Spring重要机制探秘</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring组件分析/Spring组件之ApplicationContext">Spring组件分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/SpringAOP/AnnotationAwareAspectJAutoProxyCreator分析（上）">SpringAOP</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/SpringAOP/AnnotationAwareAspectJAutoProxyCreator分析（上）">AnnotationAwareAspectJAutoProxyCreator分析（上）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/SpringAOP/AnnotationAwareAspectJAutoProxyCreator分析（下）">AnnotationAwareAspectJAutoProxyCreator分析（下）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/SpringAOP/AOP示例demo及@EnableAspectJAutoProxy">AOP示例demo及@EnableAspectJAutoProxy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/SpringAOP/SpringAop（六）：aop总结">SpringAop（六）：aop总结</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/SpringAOP/SpringAop（四）：jdk动态代理">SpringAop（四）：jdk动态代理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/SpringAOP/SpringAop（五）：cglib代理">SpringAop（五）：cglib代理</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringBoot/给你一份SpringBoot知识清单">SpringBoot</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBoot启动流程（四）：启动IOC容器">SpringBoot源码解析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloud/SpringCloudConsul">SpringCloud</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudConfig源码分析">SpringCloud源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba/SpringCloudAlibaba概览">SpringCloudAlibaba</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba源码分析/SpringCloudAlibabaNacos源码分析：服务发现">SpringCloudAlibaba源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringMVC/SpringMVC常见注解">SpringMVC</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/请求执行流程（二）之执行Handler方法">SpringMVC源码分析</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_SejT"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_j3Yw"><div class="docItemContainer_XOSC"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_F6gm" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/code-note-blog/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YCxa"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Spring源码分析</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">SpringAOP</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">AnnotationAwareAspectJAutoProxyCreator分析（上）</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ToOY theme-doc-toc-mobile tocMobile_suYB"><button type="button" class="clean-btn tocCollapsibleButton_VzP_">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>AnnotationAwareAspectJAutoProxyCreator分析（上）</h1></header><p>在<a href="https://my.oschina.net/funcy/blog/4678093" target="_blank" rel="noopener noreferrer" title="上一篇文章">上一篇文章</a>的分析中，我们介绍了使用 <code>@EnableAspectJAutoProxy</code> 开启用 spring aop 功能，而 <code>@EnableAspectJAutoProxy</code> 最终向 spring 中引入了一个类：<code>AnnotationAwareAspectJAutoProxyCreator</code>，本文就从该类入手，进 一步分析 spring aop 功能。</p>
<p>首先我们来看看这个类的继承关系：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-53b639dcaacb2480e9098a046407a80a574.png" alt="" class="img_kGBN"></p>
<p>从继承关系上来看，<code>AnnotationAwareAspectJAutoProxyCreator</code> 是一个 <code>BeanPostProcessor</code>，结合前面的分析，spring <code>BeanPostProcessor</code> 的执行是在 spring bean 初始化前后，这里我们通过断点调试的方式验证下。</p>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="1-调试查看代理对象的产生">1. 调试查看代理对象的产生<a href="#1-调试查看代理对象的产生" class="hash-link" aria-label="Direct link to 1. 调试查看代理对象的产生" title="Direct link to 1. 调试查看代理对象的产生">​</a></h3>
<p>我们将断点打在 <code>AbstractAutowireCapableBeanFactory#initializeBean(String, Object, RootBeanDefinition)</code> 方法上，然后在 debug 模式下运行：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-449fe5a3456350ae0d9854c1c13f4a59a80.png" alt="" class="img_kGBN"></p>
<p>此时的 <code>wrappedBean</code> 的类型还是 <code>AopBean1</code>，继续往下，当运行完 <code>applyBeanPostProcessorsAfterInitialization</code> 后，<code>wrappedBean</code> 的类型就变了样：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-8b791334bf1873c652a265db9ab1d0e1441.png" alt="" class="img_kGBN"></p>
<p>表现上看还是 <code>AopBean1</code>，但前面出现了 <code>$Poxy19</code> 字样，且多了一个属性：<code>JdkDynamicAopProxy</code>，这表明该动态是 jdk 动态代理生成的对象。</p>
<p>再看看 <code>AopBean2</code> 运行到此处的变化：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-4fc5d03af4298f55d69e5c619cd72df1ff0.png" alt="" class="img_kGBN"></p>
<p>可以看到，类名中出现了 <code>SpringCGLIB</code> 字样，这表示该对象是由 spring cglib 代理生成的。</p>
<p>从以上调试结果来看，spring 是在 <code>AnnotationAwareAspectJAutoProxyCreator#postProcessAfterInitialization</code> 中完成对象代理的。</p>
<p>实际上，<code>AnnotationAwareAspectJAutoProxyCreator</code> 中并未实现 <code>postProcessAfterInitialization</code> 方法，<code>AnnotationAwareAspectJAutoProxyCreator</code> 的 <code>postProcessAfterInitialization</code> 方法继承自 <code>AbstractAutoProxyCreator#postProcessAfterInitialization</code>，因此 spring 对象代理的实际完成是在 <code>AbstractAutoProxyCreator#postProcessAfterInitialization</code> 中。</p>
<p><code>AnnotationAwareAspectJAutoProxyCreator</code> 是 <code>BeanPostProcessor</code> 的子类，spring 在 bean 的初始化前后会调用 <code>BeanPostProcessor#postProcessBeforeInitialization</code> 与 <code>BeanPostProcessor#postProcessAfterInitialization</code> 方法，我们将从源码上看看 <code>AnnotationAwareAspectJAutoProxyCreator</code> 在 bean 的初始前后是如何完成 aop 操作。</p>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="2-abstractautoproxycreatorpostprocessbeforeinitialization-方法">2. <code>AbstractAutoProxyCreator#postProcessBeforeInitialization</code> 方法<a href="#2-abstractautoproxycreatorpostprocessbeforeinitialization-方法" class="hash-link" aria-label="Direct link to 2-abstractautoproxycreatorpostprocessbeforeinitialization-方法" title="Direct link to 2-abstractautoproxycreatorpostprocessbeforeinitialization-方法">​</a></h3>
<p>代理对象的生成虽然是在 <code>BeanPostProcessor#postProcessAfterInitialization</code> 方法，但正所谓 “做戏做全套”，本文我们先分析 <code>AbstractAutoProxyCreator#postProcessBeforeInitialization</code> 方法，看看这个方法做了些什么，至于 <code>AbstractAutoProxyCreator#postProcessAfterInitialization</code> 方法，将留到下一篇文章分析。</p>
<p><code>AnnotationAwareAspectJAutoProxyCreator</code> 的 <code>postProcessBeforeInitialization</code> 方法继承自 <code>AbstractAutoProxyCreator</code>，<code>AbstractAutoProxyCreator#postProcessBeforeInitialization</code> 方法如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public Object postProcessBeforeInstantiation(Class&lt;?&gt; beanClass, String beanName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object cacheKey = getCacheKey(beanClass, beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!StringUtils.hasLength(beanName) || !this.targetSourcedBeans.contains(beanName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.advisedBeans.containsKey(cacheKey)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //1\. 加载所有增强</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (isInfrastructureClass(beanClass) || shouldSkip(beanClass, beanName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 2\. 如果有自定义的TargetSource，则运行下面的方法来创建代理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TargetSource targetSource = getCustomTargetSource(beanClass, beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (targetSource != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.hasLength(beanName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.targetSourcedBeans.add(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(beanClass, beanName, targetSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object proxy = createProxy(beanClass, beanName, specificInterceptors, targetSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.proxyTypes.put(cacheKey, proxy.getClass());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return proxy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个方法主要功能就是加载项目中的增强方法，处理代码如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">if (isInfrastructureClass(beanClass) || shouldSkip(beanClass, beanName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这段代码包含两个方法：<code>isInfrastructureClass(beanClass)</code> 与 <code>shouldSkip(beanClass, beanName)</code>，先来看 <code>isInfrastructureClass(beanClass)</code></p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="21-isinfrastructureclassbeanclass-方法">2.1 <code>isInfrastructureClass(beanClass)</code> 方法<a href="#21-isinfrastructureclassbeanclass-方法" class="hash-link" aria-label="Direct link to 21-isinfrastructureclassbeanclass-方法" title="Direct link to 21-isinfrastructureclassbeanclass-方法">​</a></h4>
<blockquote>
<p>AnnotationAwareAspectJAutoProxyCreator#isInfrastructureClass</p>
</blockquote>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected boolean isInfrastructureClass(Class&lt;?&gt; beanClass) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     // 判断当前类是否为 Advice/Pointcut/Advisor/AopInfrastructureBean 的子类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     return (super.isInfrastructureClass(beanClass) ||</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 判断当前beanClass是否为切面：包含有@Aspect注解， 且不由ajc编译</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         (this.aspectJAdvisorFactory != null &amp;&amp; this.aspectJAdvisorFactory.isAspect(beanClass)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上代码就两行，功能注释得很清楚了，简单来说就是判断是否为 aop 自身相关的类，如果是 aop 自身相关的类，就不进行切面操作了。</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="22-shouldskipbeanclass-beanname-方法">2.2 <code>shouldSkip(beanClass, beanName)</code> 方法<a href="#22-shouldskipbeanclass-beanname-方法" class="hash-link" aria-label="Direct link to 22-shouldskipbeanclass-beanname-方法" title="Direct link to 22-shouldskipbeanclass-beanname-方法">​</a></h4>
<p>接着，我们来看 <code>shouldSkip(beanClass, beanName)</code> 方法：</p>
<blockquote>
<p>AspectJAwareAdvisorAutoProxyCreator#shouldSkip</p>
</blockquote>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected boolean shouldSkip(Class&lt;?&gt; beanClass, String beanName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //查找所有标识了@Aspect注解的类，这个方法很重要 ，下面会继续分析</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;Advisor&gt; candidateAdvisors = findCandidateAdvisors();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (Advisor advisor : candidateAdvisors) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 如果当前 advisor 为 AspectJPointcutAdvisor 的实例且 AspectName 为 beanName，返回true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (advisor instanceof AspectJPointcutAdvisor &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ((AspectJPointcutAdvisor) advisor).getAspectName().equals(beanName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 调用父类的方法，判断当前 bean 是否为 OriginalInstance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return super.shouldSkip(beanClass, beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个方法会先查找所有标识了 <code>@Aspect</code> 注解的类，然后做一些判断，其中 <code>findCandidateAdvisors</code> 很关键，我们来看看这个方法：</p>
<blockquote>
<p>AnnotationAwareAspectJAutoProxyCreator#findCandidateAdvisors</p>
</blockquote>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected List&lt;Advisor&gt; findCandidateAdvisors() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 调用父类的方法，查找当前beanFactory中的Advisor bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;Advisor&gt; advisors = super.findCandidateAdvisors();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (this.aspectJAdvisorsBuilder != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 将包含 @Aspect 注解的类构建为 Advisor，这句是关键</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        advisors.addAll(this.aspectJAdvisorsBuilder.buildAspectJAdvisors());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return advisors;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>首先来看下 <code>super.findCandidateAdvisors()</code> 方法，也就是 <code>AbstractAdvisorAutoProxyCreator#findCandidateAdvisors</code>:</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected List&lt;Advisor&gt; findCandidateAdvisors() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Assert.state(this.advisorRetrievalHelper != null, &quot;No BeanFactoryAdvisorRetrievalHelper available&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return this.advisorRetrievalHelper.findAdvisorBeans();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个调用了 <code>BeanFactoryAdvisorRetrievalHelper#findAdvisorBeans</code>，继续下去：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public List&lt;Advisor&gt; findAdvisorBeans() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String[] advisorNames = this.cachedAdvisorBeanNames;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (advisorNames == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1\. 查找当前beanFactory中所有 Advisor 的 bean class</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        advisorNames = BeanFactoryUtils.beanNamesForTypeIncludingAncestors(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.beanFactory, Advisor.class, true, false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.cachedAdvisorBeanNames = advisorNames;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;Advisor&gt; advisors = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (String name : advisorNames) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2\. 从spring中获取 bean class 对应的 bean，将其放入advisors中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            advisors.add(this.beanFactory.getBean(name, Advisor.class));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return advisors;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上代码做了两件事：</p>
<ol>
<li>查找当前 beanFactory 中所有 Advisor 的 bean class，Advisor 可以是用户实现 Advisor 相关接口，也可以是 xml 指定的</li>
<li>从 spring 中获取 bean class 对应的 bean，将其放入 advisors 中</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="23-aspectjadvisorsbuilderbuildaspectjadvisors-方法">2.3 <code>aspectJAdvisorsBuilder.buildAspectJAdvisors()</code> 方法<a href="#23-aspectjadvisorsbuilderbuildaspectjadvisors-方法" class="hash-link" aria-label="Direct link to 23-aspectjadvisorsbuilderbuildaspectjadvisors-方法" title="Direct link to 23-aspectjadvisorsbuilderbuildaspectjadvisors-方法">​</a></h4>
<p>接着我们再回过头来看看 <code>aspectJAdvisorsBuilder.buildAspectJAdvisors())</code> 方法 ：</p>
<blockquote>
<p>BeanFactoryAspectJAdvisorsBuilder#buildAspectJAdvisors</p>
</blockquote>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public List&lt;Advisor&gt; buildAspectJAdvisors() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;String&gt; aspectNames = this.aspectBeanNames;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 只有在第一次运行时，才会成立</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (aspectNames == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (this) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            aspectNames = this.aspectBeanNames;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (aspectNames == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;Advisor&gt; advisors = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                aspectNames = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //1\. 获取所有Bean名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String[] beanNames = BeanFactoryUtils.beanNamesForTypeIncludingAncestors(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        this.beanFactory, Object.class, true, false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (String beanName : beanNames) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    //2\. 判断Bean的Class上是否标识@Aspect注解</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (this.advisorFactory.isAspect(beanType)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        aspectNames.add(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        AspectMetadata amd = new AspectMetadata(beanType, beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (amd.getAjType().getPerClause().getKind() == PerClauseKind.SINGLETON) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // 创建factory对象，这个对象里包含了beanFactory与@Aspect的beanName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            MetadataAwareAspectInstanceFactory factory =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                new BeanFactoryAspectInstanceFactory(this.beanFactory, beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // 3\. 解析所有的增强方法, 这个方法是重点的重点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            List&lt;Advisor&gt; classAdvisors = this.advisorFactory.getAdvisors(factory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            if (this.beanFactory.isSingleton(beanName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                //将解析的Bean名称及类上的增强缓存起来,每个Bean只解析一次</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                this.advisorsCache.put(beanName, classAdvisors);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 对属性赋值，之后就不会再运行了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.aspectBeanNames = aspectNames;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return advisors;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (aspectNames.isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Collections.emptyList();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;Advisor&gt; advisors = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (String aspectName : aspectNames) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //从缓存中获取当前Bean的切面实例，如果不为空，则指明当前Bean的Class标识了@Aspect，且有切面方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Advisor&gt; cachedAdvisors = this.advisorsCache.get(aspectName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (cachedAdvisors != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            advisors.addAll(cachedAdvisors);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            MetadataAwareAspectInstanceFactory factory = this.aspectFactoryCache.get(aspectName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            advisors.addAll(this.advisorFactory.getAdvisors(factory));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return advisors;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>方法虽然有点长，不过只做了 3 件事：</p>
<ol>
<li>获取所有 beanName：<code>BeanFactoryUtils.beanNamesForTypeIncludingAncestors</code></li>
<li>找出所有标记 Aspect 注解的类：<code>advisorFactory.isAspect(beanType)</code></li>
<li>对标记 Aspect 的类提取增强器：<code>this.advisorFactory.getAdvisors(factory)</code></li>
</ol>
<p>这里我们重点分析第 3 点，看看 <code>Advisors</code> 是如何构建的。</p>
<blockquote>
<p>ReflectiveAspectJAdvisorFactory#getAdvisors</p>
</blockquote>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public List&lt;Advisor&gt; getAdvisors(MetadataAwareAspectInstanceFactory aspectInstanceFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //获取Aspect类、类名称、并校验</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // aspectInstanceFactory 里包含beanFactory与 @Aspect 的 beanName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class&lt;?&gt; aspectClass = aspectInstanceFactory.getAspectMetadata().getAspectClass();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String aspectName = aspectInstanceFactory.getAspectMetadata().getAspectName();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //校验类的合法性相关</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    validate(aspectClass);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MetadataAwareAspectInstanceFactory lazySingletonAspectInstanceFactory =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  new LazySingletonAspectInstanceFactoryDecorator(aspectInstanceFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;Advisor&gt; advisors = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 获取这个类除去 @Pointcut 外的所有方法，看下面的分析</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (Method method : getAdvisorMethods(aspectClass)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 生成增强实例，这个 方法是重点，看后面的分析</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 注意 advisors.size()，这个指定了advisor的顺序，由于获取之后会个添加</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // 操作，因此这个值是递增且是不重复的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Advisor advisor = getAdvisor(method, lazySingletonAspectInstanceFactory, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    advisors.size(), aspectName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          if (advisor != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              // 添加 advisors 列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              advisors.add(advisor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 如果需要增强且配置了延迟增强,则在第一个位置添加同步实例化增强方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!advisors.isEmpty() &amp;&amp; lazySingletonAspectInstanceFactory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .getAspectMetadata().isLazilyInstantiated()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Advisor instantiationAdvisor = new SyntheticInstantiationAdvisor(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    lazySingletonAspectInstanceFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        advisors.add(0, instantiationAdvisor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 获取属性中配置DeclareParents注解的增强</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (Field field : aspectClass.getDeclaredFields()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Advisor advisor = getDeclareParentsAdvisor(field);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (advisor != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              advisors.add(advisor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return advisors;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 获取指定类除@Pointcut外的所有方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private List&lt;Method&gt; getAdvisorMethods(Class&lt;?&gt; aspectClass) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final List&lt;Method&gt; methods = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 递归操作 ：排除@Pointcut标识的方法，获取当前类的的方法、来自接口的默认方法，再对父类进行同样的操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 最终结果：除@Pointcut标识之外的所有方法，得到的方法集合包括：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1\. 继承自父类的方法，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 2\. 来自自接口的默认的方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 3\. 不包含继承自Object的方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ReflectionUtils.doWithMethods(aspectClass, method -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (AnnotationUtils.getAnnotation(method, Pointcut.class) == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            methods.add(method);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }, ReflectionUtils.USER_DECLARED_METHODS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //对得到的所有方法排序，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //如果方法标识了切面注解，则按@Around, @Before, @After, @AfterReturning, @AfterThrowing的顺序排序</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //如果没有标识这些注解，则按方法名称的字符串排序,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //有注解的方法排在无注解的方法之前</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //最后的排序应该是这样的Around, Before, After, AfterReturning, AfterThrowing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    methods.sort(METHOD_COMPARATOR);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return methods;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上方法主要做了两件事：</p>
<ol>
<li>获取当前类除 <code>@Pointcut</code> 外的所有增强方法，包括继承自父类的方法，继承自 Object 的方法，以及来自接口的默认方法</li>
<li>遍历得到的方法，从符合条件的方法得到 Advisor 实例，保存到集合中</li>
</ol>
<p>关于第一步，上面的代码已经分析了，主要是根据反射来进行的，就不再深入了，这里我们来看第二步，该操作是在 <code>ReflectiveAspectJAdvisorFactory#getAdvisor</code> 方法中：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * declarationOrderInAspect：指定了Advisor的顺序，来源于 AdvisorMethods 的排序，上面已分析</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Advisor getAdvisor(Method candidateAdviceMethod, MetadataAwareAspectInstanceFactory </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        aspectInstanceFactory, int declarationOrderInAspect, String aspectName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //再次校验类的合法性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    validate(aspectInstanceFactory.getAspectMetadata().getAspectClass());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //切点表达式的包装类里面包含这些东西：@Around(&quot;testAop()&quot;) 里的 testAop()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AspectJExpressionPointcut expressionPointcut = getPointcut(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            candidateAdviceMethod, aspectInstanceFactory.getAspectMetadata().getAspectClass());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (expressionPointcut == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //根据方法、切点、AOP实例工厂、类名、序号生成切面实例，下面我们先来看看是如何实例化的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new InstantiationModelAwarePointcutAdvisorImpl(expressionPointcut, candidateAdviceMethod,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               this, aspectInstanceFactory, declarationOrderInAspect, aspectName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 处理切点表达式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private AspectJExpressionPointcut getPointcut(Method candidateAdviceMethod, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               Class&lt;?&gt; candidateAspectClass) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 查询方法上的切面注解，根据注解生成相应类型的AspectJAnnotation,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 在调用AspectJAnnotation的构造函数的同时，根据注解value或pointcut属性得到切点表达式，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 有argNames则设置参数名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AspectJAnnotation&lt;?&gt; aspectJAnnotation =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               AbstractAspectJAdvisorFactory.findAspectJAnnotationOnMethod(candidateAdviceMethod);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 过滤那些不含@Before, @Around, @After, @AfterReturning, @AfterThrowing注解的方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (aspectJAnnotation == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //生成带表达式的切面切入点，设置其切入点表达式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AspectJExpressionPointcut ajexp =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               new AspectJExpressionPointcut(candidateAspectClass, new String[0], new Class&lt;?&gt;[0]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ajexp.setExpression(aspectJAnnotation.getPointcutExpression());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (this.beanFactory != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ajexp.setBeanFactory(this.beanFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ajexp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>Advisor</code> 实例化过程如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public InstantiationModelAwarePointcutAdvisorImpl(AspectJExpressionPointcut declaredPointcut,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Method aspectJAdviceMethod, AspectJAdvisorFactory aspectJAdvisorFactory,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MetadataAwareAspectInstanceFactory aspectInstanceFactory,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int declarationOrder, String aspectName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 处理属性设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.declaredPointcut = declaredPointcut;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.declaringClass = aspectJAdviceMethod.getDeclaringClass();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.methodName = aspectJAdviceMethod.getName();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.parameterTypes = aspectJAdviceMethod.getParameterTypes();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.aspectJAdviceMethod = aspectJAdviceMethod;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.aspectJAdvisorFactory = aspectJAdvisorFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.aspectInstanceFactory = aspectInstanceFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.declarationOrder = declarationOrder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.aspectName = aspectName;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (aspectInstanceFactory.getAspectMetadata().isLazilyInstantiated()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.pointcut = this.declaredPointcut;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.lazy = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //初始化对应的增强器，这里是重点</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.instantiatedAdvice = instantiateAdvice(this.declaredPointcut);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 实例化过程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private Advice instantiateAdvice(AspectJExpressionPointcut pointcut) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // getAdvice: 处理 Advice 实例化操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Advice advice = this.aspectJAdvisorFactory.getAdvice(this.aspectJAdviceMethod, pointcut,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.aspectInstanceFactory, this.declarationOrder, this.aspectName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (advice != null ? advice : EMPTY_ADVICE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这段代码清晰明了，主要是实例化 <code>Advisor</code>，所谓的实例化，就  是往 <code>Advisor</code> 对象里设置了一些属性。这里 <code>instantiatedAdvice</code> 属性需要特别说明一下，这个属性封装了切面方法，也就是增强的内容。</p>
<ul>
<li>切面方法 (切面具体的执行代码) 封装为 <code>Advice</code>；</li>
<li><code>Advice</code> 是 <code>Advisor</code> 的一个属性。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="24-实例化-advice">2.4 实例化 <code>Advice</code><a href="#24-实例化-advice" class="hash-link" aria-label="Direct link to 24-实例化-advice" title="Direct link to 24-实例化-advice">​</a></h4>
<p>接下来看看 <code>Advice</code> 的流程：</p>
<blockquote>
<p>ReflectiveAspectJAdvisorFactory#getAdvice</p>
</blockquote>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Advice getAdvice(Method candidateAdviceMethod, AspectJExpressionPointcut expressionPointcut,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MetadataAwareAspectInstanceFactory aspectInstanceFactory,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int declarationOrder, String aspectName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class&lt;?&gt; candidateAspectClass = aspectInstanceFactory.getAspectMetadata().getAspectClass();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //又是一次校验</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    validate(candidateAspectClass);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AspectJAnnotation&lt;?&gt; aspectJAnnotation =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            AbstractAspectJAdvisorFactory.findAspectJAnnotationOnMethod(candidateAdviceMethod);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (aspectJAnnotation == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!isAspect(candidateAspectClass)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new AopConfigException(...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AbstractAspectJAdvice springAdvice;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 根据注解类型生成不同的通知实例，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 对应的注解就是 @Before, @Around, @After, @AfterReturning, @AfterThrowing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    switch (aspectJAnnotation.getAnnotationType()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case AtPointcut:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case AtAround:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            springAdvice = new AspectJAroundAdvice(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    candidateAdviceMethod, expressionPointcut, aspectInstanceFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case AtBefore:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            springAdvice = new AspectJMethodBeforeAdvice(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    candidateAdviceMethod, expressionPointcut, aspectInstanceFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case AtAfter:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            springAdvice = new AspectJAfterAdvice(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    candidateAdviceMethod, expressionPointcut, aspectInstanceFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case AtAfterReturning:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            springAdvice = new AspectJAfterReturningAdvice(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    candidateAdviceMethod, expressionPointcut, aspectInstanceFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            AfterReturning afterReturningAnnotation = (AfterReturning) aspectJAnnotation.getAnnotation();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.hasText(afterReturningAnnotation.returning())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                springAdvice.setReturningName(afterReturningAnnotation.returning());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case AtAfterThrowing:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            springAdvice = new AspectJAfterThrowingAdvice(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   candidateAdviceMethod, expressionPointcut, aspectInstanceFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            AfterThrowing afterThrowingAnnotation = (AfterThrowing) aspectJAnnotation.getAnnotation();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.hasText(afterThrowingAnnotation.throwing())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                springAdvice.setThrowingName(afterThrowingAnnotation.throwing());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new UnsupportedOperationException(...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //设置通知方法所属的类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    springAdvice.setAspectName(aspectName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //设置通知的序号,同一个类中有多个切面注解标识的方法时,按上方说的排序规则来排序，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //其序号就是此方法在列表中的序号，第一个就是0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    springAdvice.setDeclarationOrder(declarationOrder);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //获取通知方法的所有参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String[] argNames = this.parameterNameDiscoverer.getParameterNames(candidateAdviceMethod);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //将通知方法上的参数设置到通知中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (argNames != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        springAdvice.setArgumentNamesFromStringArray(argNames);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //计算参数绑定工作，此方法详解请接着往下看</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    springAdvice.calculateArgumentBindings();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return springAdvice;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们知道，切面注解标识的方法第一个参数要求是 <code>JoinPoint</code>，如果是 <code>@Around</code> 注解，则第一个参数可以是 <code>ProceedingJoinPoint</code>，计算参数绑定就是来验证参数类型的。</p>
<p>对于不同的通知，spring 会封装成不同的 <code>advice</code>，这里先来看看 <code>advice</code> 的继承 结构：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-671bd92a16642a059ff722ec42c8ea7ef28.png" alt="" class="img_kGBN"></p>
<p>关于 <code>advice</code>，后面在分析切面的执行时会详细分析，这里只需知道 “不同的切面类型，最终会封装为不同的 advice” 即可。</p>
<p>再来看看 spring 计算参数绑定的流程：</p>
<blockquote>
<p>AbstractAspectJAdvice</p>
</blockquote>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 处理参数绑定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public final synchronized void calculateArgumentBindings() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (this.argumentsIntrospected || this.parameterTypes.length == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int numUnboundArgs = this.parameterTypes.length;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class&lt;?&gt;[] parameterTypes = this.aspectJAdviceMethod.getParameterTypes();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //切面注解标识的方法第一个参数要求是JoinPoint,或StaticPart，若是@Around注解则也可以是ProceedingJoinPoint</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (maybeBindJoinPoint(parameterTypes[0]) || maybeBindProceedingJoinPoint(parameterTypes[0]) ||</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            maybeBindJoinPointStaticPart(parameterTypes[0])) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        numUnboundArgs--;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (numUnboundArgs &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //绑定属性其他属性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bindArgumentsByName(numUnboundArgs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.argumentsIntrospected = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上代码验证了切面注解标识的方法第一个参数的类型，此外，如果在方法中定义了多个方法，spring 还会进一步进行参数绑定：</p>
<blockquote>
<p>AbstractAspectJAdvice</p>
</blockquote>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * 绑定属性其他属性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private void bindArgumentsByName(int numArgumentsExpectingToBind) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (this.argumentNames == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //获取方法参数的名称</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.argumentNames = createParameterNameDiscoverer()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .getParameterNames(this.aspectJAdviceMethod);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (this.argumentNames != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 继续绑定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bindExplicitArguments(numArgumentsExpectingToBind);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 针对 @AfterReturning 与 @AfterThrowing 注解，进一步处理其参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private void bindExplicitArguments(int numArgumentsLeftToBind) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Assert.state(this.argumentNames != null, &quot;No argument names available&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //此属性用来存储方法未绑定的参数名称，及参数的序号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.argumentBindings = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int numExpectedArgumentNames = this.aspectJAdviceMethod.getParameterCount();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (this.argumentNames.length != numExpectedArgumentNames) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // argumentIndexOffset代表第一个未绑定参数的顺序</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int argumentIndexOffset = this.parameterTypes.length - numArgumentsLeftToBind;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = argumentIndexOffset; i &lt; this.argumentNames.length; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //存储未绑定的参数名称及其顺序的映射关系</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.argumentBindings.put(this.argumentNames[i], i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 如果是@AfterReturning注解的returningName 有值，验证，解析，同时得到定义返回值的类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (this.returningName != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!this.argumentBindings.containsKey(this.returningName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalStateException(...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Integer index = this.argumentBindings.get(this.returningName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.discoveredReturningType = this.aspectJAdviceMethod.getParameterTypes()[index];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.discoveredReturningGenericType = this.aspectJAdviceMethod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .getGenericParameterTypes()[index];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 如果是@AfterThrowing注解的throwingName 有值，验证，解析，同时得到抛出异常的类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (this.throwingName != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!this.argumentBindings.containsKey(this.throwingName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalStateException(...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Integer index = this.argumentBindings.get(this.throwingName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.discoveredThrowingType = this.aspectJAdviceMethod.getParameterTypes()[index];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configurePointcutParameters(this.argumentNames, argumentIndexOffset);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *  这一步仅是将前面未处理过的参数做一个保存，记录到 pontcut 中，待后续再做处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private void configurePointcutParameters(String[] argumentNames, int argumentIndexOffset) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int numParametersToRemove = argumentIndexOffset;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (this.returningName != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        numParametersToRemove++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (this.throwingName != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        numParametersToRemove++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String[] pointcutParameterNames = new String[argumentNames.length - numParametersToRemove];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class&lt;?&gt;[] pointcutParameterTypes = new Class&lt;?&gt;[pointcutParameterNames.length];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class&lt;?&gt;[] methodParameterTypes = this.aspectJAdviceMethod.getParameterTypes();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int index = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 0; i &lt; argumentNames.length; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (i &lt; argumentIndexOffset) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (argumentNames[i].equals(this.returningName) ||</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            argumentNames[i].equals(this.throwingName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pointcutParameterNames[index] = argumentNames[i];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pointcutParameterTypes[index] = methodParameterTypes[i];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        index++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //剩余的未绑定的参数会赋值给AspectJExpressionPointcut(表达式形式的切入点)的属性，以备后续使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.pointcut.setParameterNames(pointcutParameterNames);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.pointcut.setParameterTypes(pointcutParameterTypes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="3-总结">3. 总结<a href="#3-总结" class="hash-link" aria-label="Direct link to 3. 总结" title="Direct link to 3. 总结">​</a></h3>
<p>本文主要是分析了 <code>AnnotationAwareAspectJAutoProxyCreator#postProcessBeforeInitialization</code> 方法，也就是 <code>AbstractAutoProxyCreator#postProcessBeforeInitialization</code> 方法，在该方法的运行过程中，主要是将 <code>@Aspect</code> 类封装成一个个 <code>Advisor</code>，封装步骤如下：</p>
<ol>
<li>找到项目中标注了 <code>@Aspect</code> 的类；</li>
<li>遍历上一步得到的类，通过反射得到该类的方法，包括父接口的默认方法、父类的方法但不包括 Object 类的方法；</li>
<li>从上述方法中，找到标注了 <code>@Around</code>, <code>@Before</code>, <code>@After</code>, <code>@AfterReturning</code>, <code>@AfterThrowing</code> 等的方法，将其封装为 <code>Advisor</code> 对象。</li>
</ol>
<p>关于 <code>Advisor</code>，其中有个重要属性为 <code>Advice</code>，这个属性就是切面方法的具体内容。关于 <code>Advice</code>，在后面分析切面的执行时会详细分析。</p>
<hr>
<p><em>本文原文链接：<a href="https://my.oschina.net/funcy/blog/4678817" target="_blank" rel="noopener noreferrer">https://my.oschina.net/funcy/blog/4678817</a> ，限于作者个人水平，文中难免有错误之处，欢迎指正！原创不易，商业转载请联系作者获得授权，非商业转载请注明出处。</em></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Spring全家桶/Spring源码分析/SpringAOP/AnnotationAwareAspectJAutoProxyCreator分析（上）.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_EYjg" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_eevz"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring组件分析/Spring组件之BeanPostProcessor"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Spring组件之BeanPostProcessor</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/SpringAOP/AnnotationAwareAspectJAutoProxyCreator分析（下）"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">AnnotationAwareAspectJAutoProxyCreator分析（下）</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_lc2k thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-调试查看代理对象的产生" class="table-of-contents__link toc-highlight">1. 调试查看代理对象的产生</a></li><li><a href="#2-abstractautoproxycreatorpostprocessbeforeinitialization-方法" class="table-of-contents__link toc-highlight">2. <code>AbstractAutoProxyCreator#postProcessBeforeInitialization</code> 方法</a></li><li><a href="#3-总结" class="table-of-contents__link toc-highlight">3. 总结</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/code-note-blog/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/code-note-blog/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>