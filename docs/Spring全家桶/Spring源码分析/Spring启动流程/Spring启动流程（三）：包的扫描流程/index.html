<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Spring全家桶/Spring源码分析/Spring启动流程/Spring启动流程（三）：包的扫描流程" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.0">
<title data-rh="true">Spring启动流程（三）：包的扫描流程 | Tommy</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aiden-coding.github.io/code-note-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://aiden-coding.github.io/code-note-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring启动流程/Spring启动流程（三）：包的扫描流程"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Spring启动流程（三）：包的扫描流程 | Tommy"><meta data-rh="true" name="description" content="在 applicationContext 的创建中，我们分析了 applicationContext 的创建过程，在本文中，我们将分析 spring 是如何进行包扫描的。"><meta data-rh="true" property="og:description" content="在 applicationContext 的创建中，我们分析了 applicationContext 的创建过程，在本文中，我们将分析 spring 是如何进行包扫描的。"><link data-rh="true" rel="icon" href="/code-note-blog/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring启动流程/Spring启动流程（三）：包的扫描流程"><link data-rh="true" rel="alternate" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring启动流程/Spring启动流程（三）：包的扫描流程" hreflang="en"><link data-rh="true" rel="alternate" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring启动流程/Spring启动流程（三）：包的扫描流程" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/code-note-blog/blog/rss.xml" title="Tommy RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/code-note-blog/blog/atom.xml" title="Tommy Atom Feed"><link rel="stylesheet" href="/code-note-blog/assets/css/styles.dd5372db.css">
<script src="/code-note-blog/assets/js/runtime~main.f999fb27.js" defer="defer"></script>
<script src="/code-note-blog/assets/js/main.a0bfbaed.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_XYiV" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/code-note-blog/"><b class="navbar__title text--truncate">Tommy</b></a><a class="navbar__item navbar__link" href="/code-note-blog/docs/Java/basic/抽象类和接口">java</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/JavaWeb/走进JavaWeb技术世界：JavaWeb的由来和基础知识">javaweb</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/cache/探索Redis设计与实现：连接底层与表面的数据结构robj">cache</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/backend/后端技术杂谈：白话虚拟化技术">backend</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/cs/algorithms/剑指offer">cs</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/database/重新学习MySQL数据库：『浅入浅出』MySQL和InnoDB">database</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/distributed/basic/分布式系统理论基础 ：CAP">distributed</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/interview/BATJ-Experience/面阿里,终获offer">interview</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/mq/kafka/消息队列kafka详解：如何实现死信队列">mq</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/code-note-blog/docs/Spring全家桶/Spring/第一个Spring应用">spring</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/mianshi/collection">面试</a><a href="https://aiden-coding.github.io/code-note-blog/SpringCloud%E7%AC%AC3%E5%AD%A32024.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="toggle_XbAW colorModeToggle_r5NY"><button class="clean-btn toggleButton_Jx0n toggleButtonDisabled_zYO7" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_FjAw"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_qmEt"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_wJfS"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_LABv"><div class="docsWrapper_pdvB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_Jioa" type="button"></button><div class="docRoot_qx_v"><aside class="theme-doc-sidebar-container docSidebarContainer_NHKT"><div class="sidebarViewport_uyYB"><div class="sidebar_SZG4"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_VP_k"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/Spring/第一个Spring应用">Spring</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：初探SpringIOC核心流程">Spring源码分析</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：初探SpringIOC核心流程">Spring源码剖析：初探SpringIOC核心流程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：懒加载的单例Bean获取过程分析">Spring源码剖析：懒加载的单例Bean获取过程分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：AOP实现原理详解">Spring源码剖析：AOP实现原理详解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：JDK和cglib动态代理原理详解">Spring源码剖析：JDK和cglib动态代理原理详解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：Spring事务概述">Spring源码剖析：Spring事务概述</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：Spring事务源码剖析">Spring源码剖析：Spring事务源码剖析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：SpringAOP概述">Spring源码剖析：SpringAOP概述</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：SpringIOC容器的加载过程">Spring源码剖析：SpringIOC容器的加载过程</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring启动流程/Spring启动流程（八）：完成BeanFactory的初始化">Spring启动流程</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring启动流程/Spring启动流程（八）：完成BeanFactory的初始化">Spring启动流程（八）：完成BeanFactory的初始化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring启动流程/Spring启动流程（二）：ApplicationContext的创建">Spring启动流程（二）：ApplicationContext的创建</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring启动流程/Spring启动流程（九）：单例bean的创建">Spring启动流程（九）：单例bean的创建</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring启动流程/Spring启动流程（六）：注册BeanPostProcessor">Spring启动流程（六）：注册BeanPostProcessor</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring启动流程/Spring启动流程（七）：国际化与事件处理">Spring启动流程（七）：国际化与事件处理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring启动流程/Spring启动流程（三）：包的扫描流程">Spring启动流程（三）：包的扫描流程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring启动流程/Spring启动流程（十）：启动完成的处理">Spring启动流程（十）：启动完成的处理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring启动流程/Spring启动流程（十一）：启动流程总结">Spring启动流程（十一）：启动流程总结</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring启动流程/Spring启动流程（四）：启动前的准备工作">Spring启动流程（四）：启动前的准备工作</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring启动流程/Spring启动流程（五）：执行BeanFactoryPostProcessor">Spring启动流程（五）：执行BeanFactoryPostProcessor</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring启动流程/Spring启动流程（一）：启动流程概览">Spring启动流程（一）：启动流程概览</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring事务/Spring事务（二）：事务的执行流程">Spring事务</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring重要机制探秘/ConfigurationClassPostProcessor（二）：处理@Bean注解">Spring重要机制探秘</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring组件分析/Spring组件之ApplicationContext">Spring组件分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/SpringAOP/AnnotationAwareAspectJAutoProxyCreator分析（上）">SpringAOP</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringBoot/给你一份SpringBoot知识清单">SpringBoot</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBoot启动流程（四）：启动IOC容器">SpringBoot源码解析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloud/SpringCloudConsul">SpringCloud</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudConfig源码分析">SpringCloud源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba/SpringCloudAlibaba概览">SpringCloudAlibaba</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba源码分析/SpringCloudAlibabaNacos源码分析：服务发现">SpringCloudAlibaba源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringMVC/SpringMVC常见注解">SpringMVC</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/请求执行流程（二）之执行Handler方法">SpringMVC源码分析</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_SejT"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_j3Yw"><div class="docItemContainer_XOSC"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_F6gm" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/code-note-blog/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YCxa"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Spring源码分析</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Spring启动流程</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Spring启动流程（三）：包的扫描流程</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ToOY theme-doc-toc-mobile tocMobile_suYB"><button type="button" class="clean-btn tocCollapsibleButton_VzP_">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Spring启动流程（三）：包的扫描流程</h1></header><p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-3ed1cf4bd6fc2ef3f569376093a6462987d.png" alt="" class="img_kGBN"></p>
<p>在 <a href="https://my.oschina.net/funcy/blog/4608767" target="_blank" rel="noopener noreferrer">applicationContext 的创建</a>中，我们分析了 <code>applicationContext</code> 的创建过程，在本文中，我们将分析 spring 是如何进行包扫描的。</p>
<p>依旧是 <code>AnnotationConfigApplicationContext</code> 的构造方法：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public AnnotationConfigApplicationContext(String... basePackages) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //对传入的包进行扫描，扫描完成后，会得到一个 BeanDefinition 的集合</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scan(basePackages);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    refresh();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这次我们将目光放在 <code>scan(basePackages);</code> 上，进入该方法：</p>
<blockquote>
<p>AnnotationConfigApplicationContext#scan</p>
</blockquote>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public void scan(String... basePackages) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     Assert.notEmpty(basePackages, &quot;At least one base package must be specified&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     // 这里的scanner对象就是在this()中创建的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     this.scanner.scan(basePackages);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个方法关键代码是 <code>this.scanner.scan(basePackages);</code>，这个 <code>scanner</code> 就是在 <code>this()</code> 中创建的对象：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public AnnotationConfigApplicationContext() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.reader = new AnnotatedBeanDefinitionReader(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // scanner 就是在这里创建的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.scanner = new ClassPathBeanDefinitionScanner(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>继续追踪，这里我们对不重要的方法仅给出调用链，重点关注扫描包的过程：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">AnnotationConfigApplicationContext#AnnotationConfigApplicationContext(String...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> |-AnnotationConfigApplicationContext#scan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |-ClassPathBeanDefinitionScanner#scan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |-ClassPathBeanDefinitionScanner#doScan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>ClassPathBeanDefinitionScanner#doScan</code> 代码如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected Set&lt;BeanDefinitionHolder&gt; doScan(String... basePackages) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Assert.notEmpty(basePackages, &quot;At least one base package must be specified&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Set&lt;BeanDefinitionHolder&gt; beanDefinitions = new LinkedHashSet&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //遍历需要扫描的包路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (String basePackage : basePackages) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //获取所有符合条件的BeanDefinition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Set&lt;BeanDefinition&gt; candidates = findCandidateComponents(basePackage);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (BeanDefinition candidate : candidates) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //绑定BeanDefinition与Scope</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ScopeMetadata scopeMetadata = this.scopeMetadataResolver.resolveScopeMetadata(candidate);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            candidate.setScope(scopeMetadata.getScopeName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //查看是否配置类是否指定bean的名称，如没指定则使用类名首字母小写</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String beanName = this.beanNameGenerator.generateBeanName(candidate, this.registry);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //下面两个if是处理lazy、Autowire、DependencyOn、initMethod、enforceInitMethod、destroyMethod、</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // enforceDestroyMethod、Primary、Role、Description这些逻辑的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (candidate instanceof AbstractBeanDefinition) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                postProcessBeanDefinition((AbstractBeanDefinition) candidate, beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (candidate instanceof AnnotatedBeanDefinition) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                AnnotationConfigUtils.processCommonDefinitionAnnotations(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        (AnnotatedBeanDefinition) candidate);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //检查bean是否存在</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (checkCandidate(beanName, candidate)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //又包装了一层</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                BeanDefinitionHolder definitionHolder = new BeanDefinitionHolder(candidate, beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //检查scope是否创建，如未创建则进行创建</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                definitionHolder = AnnotationConfigUtils.applyScopedProxyMode(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        scopeMetadata, definitionHolder, this.registry);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                beanDefinitions.add(definitionHolder);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //注册 beanDefinition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                registerBeanDefinition(definitionHolder, this.registry);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return beanDefinitions;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这段代码完成的功能很明了，大体上做了以下几件事：</p>
<ol>
<li>根据包路径，得到符合条件的 BeanDefinition</li>
<li>遍历 BeanDefinition，进一步丰富 beanDefinition 信息</li>
<li>将 BeanDefinition 添加到 beanFactory</li>
</ol>
<blockquote>
<p>BeanDefinition 也是 spring 的重要组件之一，关于 BeanDefinition 的分析，可参考 <a href="https://my.oschina.net/funcy/blog/4597536" target="_blank" rel="noopener noreferrer" title="spring组件之BeanDefinition">spring 组件之 BeanDefinition</a>。</p>
</blockquote>
<p>接下来我们主要分析这三个的操作。</p>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="1-根据包路径得到-beandefinition">1. 根据包路径得到 BeanDefinition<a href="#1-根据包路径得到-beandefinition" class="hash-link" aria-label="Direct link to 1. 根据包路径得到 BeanDefinition" title="Direct link to 1. 根据包路径得到 BeanDefinition">​</a></h3>
<p>这一步主要发生在 <code>Set&lt;BeanDefinition&gt; candidates = findCandidateComponents(basePackage);</code>，我们跟进去看看代码的执行，这里依旧对不重要代码给出调用链，该方法的调用如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">AnnotationConfigApplicationContext#AnnotationConfigApplicationContext(String...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> |-AnnotationConfigApplicationContext#scan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |-ClassPathBeanDefinitionScanner#scan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |-ClassPathBeanDefinitionScanner#doScan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-ClassPathScanningCandidateComponentProvider#findCandidateComponents</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |-ClassPathScanningCandidateComponentProvider#scanCandidateComponents</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最终调用到了 <code>ClassPathScanningCandidateComponentProvider#scanCandidateComponents</code>，代码如下 (有删减)：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">private Set&lt;BeanDefinition&gt; scanCandidateComponents(String basePackage) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Set&lt;BeanDefinition&gt; candidates = new LinkedHashSet&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //组装扫描路径（组装完成后是这种格式：classpath*:org/springframework/learn/demo01/**/*.class）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String packageSearchPath = ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            resolveBasePackage(basePackage) + &#x27;/&#x27; + this.resourcePattern;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //根据路径获取资源对象，即扫描出该路径下的的所有class文件，得到 Resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Resource[] resources = getResourcePatternResolver().getResources(packageSearchPath);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (Resource resource : resources) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (resource.isReadable()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //根据资源对象获取资源对象的MetadataReader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            MetadataReader metadataReader = getMetadataReaderFactory().getMetadataReader(resource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 这里做了两件事：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 1\. 是否需要初始化为spring bean，即是否有 @Component、@Service等注解</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2\. 查看配置类是否有@Conditional一系列的注解，然后是否满足注册Bean的条件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (isCandidateComponent(metadataReader)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ScannedGenericBeanDefinition sbd = new ScannedGenericBeanDefinition(metadataReader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sbd.setResource(resource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sbd.setSource(resource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (isCandidateComponent(sbd)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    candidates.add(sbd);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return candidates;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可以看到，以上代码做了三件事：</p>
<ol>
<li>根据传入的 basePackage 得到扫描路径</li>
<li>根据扫描路径得到该路径下的所有 class 文件对应的 Resource</li>
<li>将 Resource 转化为 beanDefinition</li>
</ol>
<p>接下来我们就以上代码进行分析。</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="11-根据-basepackage-得到包扫描路径">1.1 根据 basePackage 得到包扫描路径<a href="#11-根据-basepackage-得到包扫描路径" class="hash-link" aria-label="Direct link to 1.1 根据 basePackage 得到包扫描路径" title="Direct link to 1.1 根据 basePackage 得到包扫描路径">​</a></h4>
<p>这一步没啥好分析，就是一个字符串的拼接与替换，将传入的 <code>org.springframework.learn.demo01</code> 转换为 <code>classpath*:org/springframework/learn/demo01/**/*.class</code>，相关代码就一行：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">String packageSearchPath = ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        resolveBasePackage(basePackage) + &#x27;/&#x27; + this.resourcePattern;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="12-扫描包路径">1.2 扫描包路径<a href="#12-扫描包路径" class="hash-link" aria-label="Direct link to 1.2 扫描包路径" title="Direct link to 1.2 扫描包路径">​</a></h4>
<p>得到包扫描路径后，接下来就是进行扫描了。spring 在扫描时，会把扫描路径下的所有 class 文件扫描出来，然后封装成 <code>Resource</code>，代码如下</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">Resource[] resources = getResourcePatternResolver().getResources(packageSearchPath);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>跟进代码，同样地，我们对不重要的方法，依旧只给出方法调用：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">AnnotationConfigApplicationContext#AnnotationConfigApplicationContext(String...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> |-AnnotationConfigApplicationContext#scan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |-ClassPathBeanDefinitionScanner#scan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |-ClassPathBeanDefinitionScanner#doScan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-ClassPathScanningCandidateComponentProvider#findCandidateComponents</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |-ClassPathScanningCandidateComponentProvider#scanCandidateComponents</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      |- GenericApplicationContext#getResources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       |-AbstractApplicationContext#getResources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |-PathMatchingResourcePatternResolver#getResources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         |-PathMatchingResourcePatternResolver#findPathMatchingResources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们将代码聚集于 <code>PathMatchingResourcePatternResolver#findPathMatchingResources</code>:</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected Resource[] findPathMatchingResources(String locationPattern) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 传入的 locationPattern 是 classpath*:org/springframework/learn/demo01/**/*.class</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // rootDirPath 是 classpath*:org/springframework/learn/demo01/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String rootDirPath = determineRootDir(locationPattern);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // subPattern 是 **/*.class</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String subPattern = locationPattern.substring(rootDirPath.length());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 这里返回的 Resource 是 rootDirPath 的绝对路径(用url表示)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // URL [file:/xxx/spring-learn/build/classes/java/main/org/springframework/learn/demo01/]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Resource[] rootDirResources = getResources(rootDirPath);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Set&lt;Resource&gt; result = new LinkedHashSet&lt;&gt;(16);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (Resource rootDirResource : rootDirResources) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rootDirResource = resolveRootDirResource(rootDirResource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        URL rootDirUrl = rootDirResource.getURL();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (equinoxResolveMethod != null &amp;&amp; rootDirUrl.getProtocol().startsWith(&quot;bundle&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            URL resolvedUrl = (URL) ReflectionUtils.invokeMethod(equinoxResolveMethod, null, rootDirUrl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (resolvedUrl != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                rootDirUrl = resolvedUrl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            rootDirResource = new UrlResource(rootDirUrl);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理 vfs 资源查找</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (rootDirUrl.getProtocol().startsWith(ResourceUtils.URL_PROTOCOL_VFS)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.addAll(VfsResourceMatchingDelegate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .findMatchingResources(rootDirUrl, subPattern, getPathMatcher()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理jar包文件查找</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else if (ResourceUtils.isJarURL(rootDirUrl) || isJarResource(rootDirResource)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.addAll(doFindPathMatchingJarResources(rootDirResource, rootDirUrl, subPattern));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理文件路径下的文件查找</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.addAll(doFindPathMatchingFileResources(rootDirResource, subPattern));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return result.toArray(new Resource[0]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>通过分析，发现该类的处理过程如下：</p>
<ol>
<li>通过传入的 locationPattern 得到该 pattern 下的 url 绝对路径，封装为 Resource</li>
<li>遍历返回的路径，查找 class 文件，封装为 Resource</li>
</ol>
<p>我们来看看 spring 是如何将 pattrn 转 换为 url 路径的，我们跟进代码：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">|-PathMatchingResourcePatternResolver#getResources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> |-PathMatchingResourcePatternResolver#findAllClassPathResources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |-PathMatchingResourcePatternResolver#doFindAllClassPathResources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最终代码到了 <code>PathMatchingResourcePatternResolver#doFindAllClassPathResources</code>:</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected Set&lt;Resource&gt; doFindAllClassPathResources(String path) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Set&lt;Resource&gt; result = new LinkedHashSet&lt;&gt;(16);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClassLoader cl = getClassLoader();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // path对应的url</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Enumeration&lt;URL&gt; resourceUrls = (cl != null ? cl.getResources(path) : </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ClassLoader.getSystemResources(path));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (resourceUrls.hasMoreElements()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        URL url = resourceUrls.nextElement();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 将url转换为Resource，并添加到结果中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        result.add(convertClassLoaderURL(url));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (&quot;&quot;.equals(path)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addAllClassLoaderJarRoots(cl, result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 将url转换为Resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected Resource convertClassLoaderURL(URL url) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new UrlResource(url);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>此时传入的 <code>path</code> 为 <code>org/springframework/learn/demo01/</code>，从代码可知，最终调用了 java 的 <code>ClassLoader</code> 方法来获取 path 对应的 url，然后将 url 转换为 <code>Resource</code> 添加到结果集中并返回。</p>
<p>拿到类的绝对路径之后，接下就是对路径进行遍历，拿到 class 文件了。让我们再回到 <code>PathMatchingResourcePatternResolver#findPathMatchingResources</code>，spring 扫描时，会根据传入的 url 类型，共扫描 3 个地方：</p>
<ol>
<li>vfs</li>
<li>jar 包</li>
<li>文件路径</li>
</ol>
<p><code>vfs</code> 注释上说是 &quot;URL protocol for a general JBoss VFS resource&quot;，即通用 JBoss VFS 资源的 URL 协议，这里不深究。如果项目中引入了 jar 包且需要扫描 jar 中的路径，就会使用 jar 包扫描方式进行 class 文件查找，由于调试时，<code>demo01</code> 是使用文件方式扫描的，这里就重点分析文件扫描方式，至于 jar 是如何扫描的，有兴趣的小伙伴可自行研究下。</p>
<p>我们跟进 <code>findPathMatchingResources</code> 方法：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">|-PathMatchingResourcePatternResolver#findPathMatchingResources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> |-PathMatchingResourcePatternResolver#doFindPathMatchingFileResources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |-PathMatchingResourcePatternResolver#doFindMatchingFileSystemResources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected Set&lt;Resource&gt; doFindMatchingFileSystemResources(File rootDir, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String subPattern) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 这里进行文件查找</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Set&lt;File&gt; matchingFiles = retrieveMatchingFiles(rootDir, subPattern);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Set&lt;Resource&gt; result = new LinkedHashSet&lt;&gt;(matchingFiles.size());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (File file : matchingFiles) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        result.add(new FileSystemResource(file));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在 <code>PathMatchingResourcePatternResolver#doFindMatchingFileSystemResources</code> 中，spring 将扫描到的 File 转换为 <code>FileSystemResource</code> 保存，这是我们遇到的第二个 <code>Resource</code> 类型了 (前面为 <code>UrlResource</code>，这里为 <code>FileSystemResource</code>).</p>
<p>接下我们重点关注 <code>Set&lt;File&gt; matchingFiles = retrieveMatchingFiles(rootDir, subPattern);</code>，看看 spring 是如何完成文件查找的：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">|-PathMatchingResourcePatternResolver#findPathMatchingResources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> |-PathMatchingResourcePatternResolver#doFindPathMatchingFileResources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |-PathMatchingResourcePatternResolver#doFindMatchingFileSystemResources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |-PathMatchingResourcePatternResolver#retrieveMatchingFiles</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-PathMatchingResourcePatternResolver#doRetrieveMatchingFiles</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected void doRetrieveMatchingFiles(String fullPattern, File dir, Set&lt;File&gt; result) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (File content : listDirectory(dir)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String currPath = StringUtils.replace(content.getAbsolutePath(), File.separator, &quot;/&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (content.isDirectory() &amp;&amp; getPathMatcher().matchStart(fullPattern, currPath + &quot;/&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!content.canRead()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 如果是文件夹，递归调用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                doRetrieveMatchingFiles(fullPattern, content, result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 如果是文件且文件路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (getPathMatcher().match(fullPattern, currPath)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.add(content);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上代码比较简单，与我们平常遍历文件的方式是一样的。</p>
<p>值得一提的是，<code>getPathMatcher().match(fullPattern, currPath)</code> 最终调用到的是 <code>AntPathMatcher#doMatch</code>，这是一个 ant 风格的路径匹配验证，即路径中带有 <code>*</code>，如传入的 pattern 是 <code>/xxx/spring-framework/spring-learn/build/classes/java/main/org/springframework/learn/demo01/**/*.class</code>，表示匹配 <code>/xxx/spring-framework/spring-learn/build/classes/java/main/org/springframework/learn/demo01/</code> 及其子文件夹下所有以<code>.class</code> 文件结尾的文件，当前传入的 path 是 <code>/xxx/spring-framework/spring-learn/build/classes/java/main/org/springframework/learn/demo01/BeanObj2.class</code>，显然匹配。关于 <code>AntPathMatcher#doMatch</code> 方法是如何进行匹配的，这里就不进行展开了。</p>
<p>经过了以上步骤，我们终于得到了 class 文件对应的 Resource 了.</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="13-将-resource-转化为-beandefinition">1.3 将 Resource 转化为 BeanDefinition<a href="#13-将-resource-转化为-beandefinition" class="hash-link" aria-label="Direct link to 1.3 将 Resource 转化为 BeanDefinition" title="Direct link to 1.3 将 Resource 转化为 BeanDefinition">​</a></h4>
<p>将 Resource 转化为 BeanDefinition，代码是</p>
<blockquote>
<p>ClassPathScanningCandidateComponentProvider#scanCandidateComponents</p>
</blockquote>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">// 从 resource 得到 MetadataReader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MetadataReader metadataReader = getMetadataReaderFactory().getMetadataReader(resource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 这里做了两件事：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 1\. 是否需要初始化为spring bean，即是否有 @Component、@Service等注解</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 2\. 查看配置类是否有@Conditional一系列的注解，然后是否满足注册Bean的条件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (isCandidateComponent(metadataReader)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 将 metadataReader 转换为 ScannedGenericBeanDefinition，这也是BeanDefinition家族中的一员</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ScannedGenericBeanDefinition sbd = new ScannedGenericBeanDefinition(metadataReader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_HWLp" id="1-从-resource-得到-metadatareader">1. 从 Resource 得到 MetadataReader<a href="#1-从-resource-得到-metadatareader" class="hash-link" aria-label="Direct link to 1. 从 Resource 得到 MetadataReader" title="Direct link to 1. 从 Resource 得到 MetadataReader">​</a></h5>
<p>我们追踪下 <code>MetadataReader</code> 的获取：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">|-ClassPathScanningCandidateComponentProvider#scanCandidateComponents</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> |-CachingMetadataReaderFactory#getMetadataReader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |-SimpleMetadataReaderFactory#getMetadataReader(Resource)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |-SimpleMetadataReader#SimpleMetadataReader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>代码最终运行到了 <code>SimpleMetadataReader</code> 的构造方法:</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">SimpleMetadataReader(Resource resource, @Nullable ClassLoader classLoader) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SimpleAnnotationMetadataReadingVisitor visitor </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        = new SimpleAnnotationMetadataReadingVisitor(classLoader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 这里发生了class文件的读取与解析</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    getClassReader(resource).accept(visitor, PARSING_OPTIONS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.resource = resource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.annotationMetadata = visitor.getMetadata();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>再进一步追踪，发现 class 文件的读取与解析发生在 <code>ClassReader</code> 类：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-595687d3a766ffaacf69f31216a5b09f9d5.png" alt="" class="img_kGBN"></p>
<p>这个类使用 asm 来读取 class 文件，代码比较复杂，就不深究了。</p>
<p>一直以来，我都以为 spring 是通过反射来获取类信息的，到这里才知道，<strong>原来 spring 是通过 asm 直接读取 class 文件来获取类的信息的</strong> 。</p>
<p>最后我们来看下得到的 <code>MetadataReader</code> 的结果：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-9df07587a3a8191231da87fe21d80052357.png" alt="" class="img_kGBN"></p>
<p>这里重点关注 <code>annotations</code> 属性，里面有一个 <code>annotations</code> 和 <code>mappings</code>，<code>annotations</code> 内容为 <code>@Service</code>，<code>mappings</code> 是一个数组，内容为</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">0-@Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1-@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2-@Index</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-f5c7e8768b92b7a4303c4e1beb58863fe03.png" alt="" class="img_kGBN"></p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-38b493e0b4b7b73dda5f06f371b66f16d3e.png" alt="" class="img_kGBN"></p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-930a4e6844efd3f9f52c6d3f4e13a200337.png" alt="" class="img_kGBN"></p>
<p><code>annotations</code> 本人猜测是 <code>BeanObj1</code> 上的注解：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-77271c438dde39f2bc905aa9f2cf9fb73d8.png" alt="" class="img_kGBN"></p>
<p>至于 <code>mappings</code> 是啥，我不好猜测，不过也可以从注解中发现一些端倪：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-f31efb6252beb2108dc0ce93d482666f8d0.png" alt="" class="img_kGBN"></p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-a8ce5d11b4b02907f0ff497c6369a1c1dde.png" alt="" class="img_kGBN"></p>
<p><code>@Service</code> 上有 <code>@Component</code> 注解，<code>@Component</code> 上有 <code>@Indexed</code>，而这三者都出现在了 <code>mappings</code> 中，这看着像是专门用来保存拿注解之上的注解的？不纠结这个了，暂且就当作是这功能吧！<strong>注意：<code>mappings</code> 里面的内容很重要，后面会用来！</strong></p>
<h5 class="anchor anchorWithStickyNavbar_HWLp" id="2-iscandidatecomponentmetadatareader判断是否需要实例化为-spring-bean">2. <code>isCandidateComponent(MetadataReader)</code>：判断是否需要实例化为 spring bean<a href="#2-iscandidatecomponentmetadatareader判断是否需要实例化为-spring-bean" class="hash-link" aria-label="Direct link to 2-iscandidatecomponentmetadatareader判断是否需要实例化为-spring-bean" title="Direct link to 2-iscandidatecomponentmetadatareader判断是否需要实例化为-spring-bean">​</a></h5>
<p>在上一步中，我们得到了 basePackage 下<strong>所有类</strong>的 <code>MetadataReader</code> 描述文件，注意这里是<strong>所有类</strong>，但这些类是不是都要转成 <code>spring bean</code>，托管到 spring 容器呢？这就是 <code>isCandidateComponent(MetadataReader)</code> 的功能了。废话少说，上代码：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected boolean isCandidateComponent(MetadataReader metadataReader) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 省略部分代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (TypeFilter tf : this.includeFilters) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 这里判断是否需要托管到spring容器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (tf.match(metadataReader, getMetadataReaderFactory())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 判断是否有@Conditional一系列的注解</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return isConditionMatch(metadataReader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这段主要是做了两个判断：</p>
<ul>
<li>是否需要为 spring bean</li>
<li>是否有 <code>@Conditional</code> 等一系列的注解</li>
</ul>
<p>这里我们先来看第一个判断。</p>
<p>在 spring 中，标明 spring bean 的注解有很多，像 <code>@Component</code>、<code>@Repository</code>、<code>@Service</code>、<code>@Controller</code>、<code>@Configuration</code>，甚至是你自己写的注解类，只要上面标了这些注解，像</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Target(ElementType.TYPE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Documented</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 添加 @Component 或 @Service 或 @Repository 等其中之一</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface MySpringBean {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>都能被 spring 识别。如果是 spring 提供的注解（<code>@Component</code>、<code>@Repository</code> 等），在判断是不是 spring bean 时，只需要做类似</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">if(annotation == Component.class || annotation == Repository.class) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>的判断就行了。但对于自定义的注解 <code>@MySpringBean</code>，spring 是怎么知道这是 spring bean 呢？在我们定义 <code>@MySpringBean</code> 时，一定要在类上添加 <code>@Component</code> 或 <code>@Service</code> 或 <code>@Repository</code> 等其中之一才能被 spring 识别，这其中有什么玄机呢？我们跟进代码 <code>AbstractTypeHierarchyTraversingFilter#match(MetadataReader, MetadataReaderFactory)</code>，这里我们对不重要的代码依旧只给出调用链：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">|-ClassPathScanningCandidateComponentProvider#isCandidateComponent(MetadataReader)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> |-AbstractTypeHierarchyTraversingFilter#match(MetadataReader, MetadataReaderFactory)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |-AnnotationTypeFilter#matchSelf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>代码最终到了 <code>AnnotationTypeFilter#matchSelf</code>:</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected boolean matchSelf(MetadataReader metadataReader) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AnnotationMetadata metadata = metadataReader.getAnnotationMetadata();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 这里的annotationType就  是 @Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return metadata.hasAnnotation(this.annotationType.getName()) ||</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        (this.considerMetaAnnotations &amp;&amp; metadata.hasMetaAnnotation(this.annotationType.getName()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>关键就在这了：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">metadata.hasAnnotation(this.annotationType.getName())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">与</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">this.considerMetaAnnotations &amp;&amp; metadata.hasMetaAnnotation(this.annotationType.getName())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们先看 <code>metadata.hasAnnotation(this.annotationType.getName())</code> 的比较：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">// AnnotationMetadata#hasAnnotation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default boolean hasAnnotation(String annotationName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return getAnnotations().isDirectlyPresent(annotationName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里的 <code>getAnnotations()</code> 得到的结果是</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-3e46b2ece5ddb2328342a469dc7dd554d9e.png" alt="" class="img_kGBN"></p>
<p>mappings 里的内容是</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">0-@Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1-@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2-@Index</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这其实就是我们前面得到的 <code>MetadataReader</code> 里的内容！</p>
<p>再追踪下去，发现 <code>isDirectlyPresent</code> 就是判断 <code>annotations</code> 与 <code>mappings</code> 里有没有出现 <code>@Component</code>:</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">private boolean isPresent(Object requiredType, boolean directOnly) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 判断 annotations 里有没有出现 @Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (MergedAnnotation&lt;?&gt; annotation : this.annotations) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;? extends Annotation&gt; type = annotation.getType();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (type == requiredType || type.getName().equals(requiredType)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!directOnly) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 判断 mappings 里有没有出现 @Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (AnnotationTypeMappings mappings : this.mappings) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (int i = 1; i &lt; mappings.size(); i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                AnnotationTypeMapping mapping = mappings.get(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (isMappingForType(mapping, requiredType)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接着我们再来看 <code>this.considerMetaAnnotations &amp;&amp; metadata.hasMetaAnnotation(this.annotationType.getName())</code>，查看调用：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">|-AnnotationTypeFilter#matchSelf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> |-AnnotationMetadata#hasMetaAnnotation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |-MergedAnnotationsCollection#get(String, Predicate)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |-MergedAnnotationsCollection#get(String, Predicate, MergedAnnotationSelector)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    |-MergedAnnotationsCollection#find</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最终的查找方法在 <code>MergedAnnotationsCollection#find</code>:</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">private &lt;A extends Annotation&gt; MergedAnnotation&lt;A&gt; find(Object requiredType,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Nullable Predicate&lt;? super MergedAnnotation&lt;A&gt;&gt; predicate,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Nullable MergedAnnotationSelector&lt;A&gt; selector) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MergedAnnotation&lt;A&gt; result = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 0; i &lt; this.annotations.length; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MergedAnnotation&lt;?&gt; root = this.annotations[i];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AnnotationTypeMappings mappings = this.mappings[i];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // mappings 遍历 mappings</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int mappingIndex = 0; mappingIndex &lt; mappings.size(); mappingIndex++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            AnnotationTypeMapping mapping = mappings.get(mappingIndex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!isMappingForType(mapping, requiredType)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 到这里，就是找到了 @Component 注解</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            MergedAnnotation&lt;A&gt; candidate = (mappingIndex == 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ? (MergedAnnotation&lt;A&gt;) root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                : TypeMappedAnnotation.createIfPossible(mapping, root, IntrospectionFailureLogger.INFO));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (candidate != null &amp;&amp; (predicate == null || predicate.test(candidate))) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (selector.isBestCandidate(candidate)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return candidate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                result = (result != null ? selector.select(result, candidate) : candidate);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可以看到，查找方式跟上面的 <code>metadata.hasAnnotation(this.annotationType.getName())</code> 高度相似。</p>
<p>以上就是 spring 用来判断是否包含 <code>@Service</code>、<code>@Component</code> 等注解的逻辑了。</p>
<p>在 <code>java</code> 中，注解是不能继承的，如</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Target({ElementType.TYPE, ElementType.METHOD})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Documented</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface Base {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target({ElementType.TYPE, ElementType.METHOD})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Documented</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface Child extends  Base {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上语法在 java 中不被允许的，spring 就是采用这解析<code>注解的注解</code>的方式，实现了类似于继承的功能。</p>
<p>接着我们再来看 <code>ClassPathScanningCandidateComponentProvider#isConditionMatch</code> 方法。实际上，这个方法是用来判断类是否含有 <code>@Conditional</code> 注解的，满足条件则会识别为 spring bean，代码最终调用到了 <code>ConditionEvaluator#shouldSkip(AnnotatedTypeMetadata, ConfigurationCondition.ConfigurationPhase)</code>:</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public boolean shouldSkip(@Nullable AnnotatedTypeMetadata metadata, @Nullable ConfigurationPhase phase) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 省略了一些代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 得到 condition 对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;Condition&gt; conditions = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String[] conditionClasses : getConditionClasses(metadata)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (String conditionClass : conditionClasses) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Condition condition = getCondition(conditionClass, this.context.getClassLoader());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                conditions.add(condition);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AnnotationAwareOrderComparator.sort(conditions);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 遍历，判断 condition 条件是否成立</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (Condition condition : conditions) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigurationPhase requiredPhase = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (condition instanceof ConfigurationCondition) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            requiredPhase = ((ConfigurationCondition) condition).getConfigurationPhase();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if ((requiredPhase == null || requiredPhase == phase) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 判断 condition 条件是否成立，一个条件满足就返回true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &amp;&amp; !condition.matches(this.context, metadata)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 通过反射获取 Condition 对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private Condition getCondition(String conditionClassName, @Nullable ClassLoader classloader) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Class&lt;?&gt; conditionClass = ClassUtils.resolveClassName(conditionClassName, classloader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (Condition) BeanUtils.instantiateClass(conditionClass);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里做了两件事：</p>
<ol>
<li>获取 condition 对象</li>
<li>遍历 condition 对象，调用 <code>condition.matches()</code> 方法，判断条件是否成立</li>
</ol>
<h5 class="anchor anchorWithStickyNavbar_HWLp" id="3-从-metadatareader-得到-scannedgenericbeandefinition">3. 从 <code>MetadataReader</code> 得到 <code>ScannedGenericBeanDefinition</code><a href="#3-从-metadatareader-得到-scannedgenericbeandefinition" class="hash-link" aria-label="Direct link to 3-从-metadatareader-得到-scannedgenericbeandefinition" title="Direct link to 3-从-metadatareader-得到-scannedgenericbeandefinition">​</a></h5>
<p>这里仅是做了一个简单的赋值，看下 <code>ScannedGenericBeanDefinition</code> 的构造方法就明白了：</p>
<blockquote>
<p>ScannedGenericBeanDefinition#ScannedGenericBeanDefinition</p>
</blockquote>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public ScannedGenericBeanDefinition(MetadataReader metadataReader) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Assert.notNull(metadataReader, &quot;MetadataReader must not be null&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.metadata = metadataReader.getAnnotationMetadata();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    setBeanClassName(this.metadata.getClassName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>代码比较简单，就不多做分析了。</p>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="2-丰富-beandefinition-信息">2. 丰富 beanDefinition 信息<a href="#2-丰富-beandefinition-信息" class="hash-link" aria-label="Direct link to 2. 丰富 beanDefinition 信息" title="Direct link to 2. 丰富 beanDefinition 信息">​</a></h3>
<p>历经千难万险，终于得到了 <code>beanDefinition</code>，但此时 <code>beanDefinition</code> 并不丰富，接下来就是进一步扩展 <code>beanDefinition</code> 的信息了。这些信息包括 <code>bean的名称</code>、<code>bean的作用域</code>、<code>@Lazy</code> 注解、<code>@Primary</code> 注解、<code>@DependsOn</code> 注解等，代码如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AnnotationConfigUtils {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 进一步丰富 BeanDefinition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static void processCommonDefinitionAnnotations(AnnotatedBeanDefinition abd, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            AnnotatedTypeMetadata metadata) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理 @Lazy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AnnotationAttributes lazy = attributesFor(metadata, Lazy.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (lazy != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            abd.setLazyInit(lazy.getBoolean(&quot;value&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else if (abd.getMetadata() != metadata) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            lazy = attributesFor(abd.getMetadata(), Lazy.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (lazy != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                abd.setLazyInit(lazy.getBoolean(&quot;value&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理 @Primary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (metadata.isAnnotated(Primary.class.getName())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            abd.setPrimary(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理 @DependsOn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AnnotationAttributes dependsOn = attributesFor(metadata, DependsOn.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (dependsOn != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            abd.setDependsOn(dependsOn.getStringArray(&quot;value&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理 @Role</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AnnotationAttributes role = attributesFor(metadata, Role.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (role != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            abd.setRole(role.getNumber(&quot;value&quot;).intValue());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理 @Description</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AnnotationAttributes description = attributesFor(metadata, Description.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (description != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            abd.setDescription(description.getString(&quot;value&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="3-registerbeandefinitiondefinitionholder-thisregistry-添加-beandefinition-到-beanfactory">3.<code> registerBeanDefinition(definitionHolder, this.registry)</code>: 添加 BeanDefinition 到 beanFactory<a href="#3-registerbeandefinitiondefinitionholder-thisregistry-添加-beandefinition-到-beanfactory" class="hash-link" aria-label="Direct link to 3-registerbeandefinitiondefinitionholder-thisregistry-添加-beandefinition-到-beanfactory" title="Direct link to 3-registerbeandefinitiondefinitionholder-thisregistry-添加-beandefinition-到-beanfactory">​</a></h3>
<p>将 <code>BeanDefinition</code> 到 <code>beanFactory</code> 的操作比较简单，关键的代码如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">|-ClassPathBeanDefinitionScanner#registerBeanDefinition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> |-BeanDefinitionReaderUtils#registerBeanDefinition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |-GenericApplicationContext#registerBeanDefinition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   |-DefaultListableBeanFactory#registerBeanDefinition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>DefaultListableBeanFactory#registerBeanDefinition</p>
</blockquote>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">this.beanDefinitionMap.put(beanName, beanDefinition);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>从 <code>ClassPathBeanDefinitionScanner#registerBeanDefinition</code> 到 <code>DefaultListableBeanFactory#registerBeanDefinition</code>，这其中虽然经历了一些弯弯绕绕，但依旧不妨碍我们找到关键的代码。</p>
<p>到此，磁盘上的 class 文件，经过 spring 扫描，终于变成了 <code>BeanDefinition</code>，保存在 <code>BeanFactory</code> 中了。</p>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="4-总结">4. 总结<a href="#4-总结" class="hash-link" aria-label="Direct link to 4. 总结" title="Direct link to 4. 总结">​</a></h3>
<p>本文比较长，主要分析了 spring 扫描包路径得到 <code>beanDefinition</code> 的过程，主要流程如下：</p>
<ol>
<li>根据包名得到路径 <code>Resource</code>；</li>
<li>根据路径 <code>Resouce</code> 得到该路径下所有 class 文件的 <code>Resouce</code>；</li>
<li>根据 class 文件的 <code>Resouce</code> 通过 asm 解析得到 <code>MetadataReader</code>，注意：这里的 <code>MetadataReader</code> 还是所有 class 文件的 <code>MetadataReader</code>；</li>
<li>从 <code>MetadataReader</code> 中找到需要 spring 托管的 <code>MetadataReader</code>，将其转化为 <code>ScannedGenericBeanDefinition</code>，<code>ScannedGenericBeanDefinition</code> 为 <code>BeanDefinition</code> 的子类；</li>
<li>进一步丰富 <code>ScannedGenericBeanDefinition</code> 的信息；</li>
<li>将上面得到的 <code>BeanDefinition</code> 添加到 <code>BeanFactory</code> 中</li>
</ol>
<p>至此，包名转换为 <code>BeanDefinition</code> 完成。</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-f8ff2e4071ba3941e2a0664f6e478b78961.png" alt="" class="img_kGBN"></p>
<p>本文还有两个值得注意的地方：</p>
<ol>
<li>spring 在获取类上的注解时，不是通过反射，而是使用 asm 直接解析 class 文件，然后再获取类上的注解的</li>
<li>在处理注解时，spring 通过解析 “注解的注解” 实现了一套类似于注解继承的方式，这也是 spring 能识别 <code>@Component</code>、<code>@Service</code> 甚至是开发者自定义注解的原因。</li>
</ol>
<p>得到了 <code>BeanDefinition</code> 后，接着就是 spring 容器的初始化了，我们下篇文章再见。</p>
<hr>
<p><em>本文原文链接：<a href="https://my.oschina.net/funcy/blog/4614071" target="_blank" rel="noopener noreferrer">https://my.oschina.net/funcy/blog/4614071</a> ，限于作者个人水平，文中难免有错误之处，欢迎指正！原创不易，商业转载请联系作者获得授权，非商业转载请注明出处。</em></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Spring全家桶/Spring源码分析/Spring启动流程/Spring启动流程（三）：包的扫描流程.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_EYjg" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_eevz"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring启动流程/Spring启动流程（七）：国际化与事件处理"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Spring启动流程（七）：国际化与事件处理</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring启动流程/Spring启动流程（十）：启动完成的处理"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Spring启动流程（十）：启动完成的处理</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_lc2k thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-根据包路径得到-beandefinition" class="table-of-contents__link toc-highlight">1. 根据包路径得到 BeanDefinition</a></li><li><a href="#2-丰富-beandefinition-信息" class="table-of-contents__link toc-highlight">2. 丰富 beanDefinition 信息</a></li><li><a href="#3-registerbeandefinitiondefinitionholder-thisregistry-添加-beandefinition-到-beanfactory" class="table-of-contents__link toc-highlight">3.<code> registerBeanDefinition(definitionHolder, this.registry)</code>: 添加 BeanDefinition 到 beanFactory</a></li><li><a href="#4-总结" class="table-of-contents__link toc-highlight">4. 总结</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/code-note-blog/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/code-note-blog/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>