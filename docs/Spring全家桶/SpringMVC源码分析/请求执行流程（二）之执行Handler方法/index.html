<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Spring全家桶/SpringMVC源码分析/请求执行流程（二）之执行Handler方法" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.0">
<title data-rh="true">请求执行流程（二）之执行Handler方法 | Tommy</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aiden-coding.github.io/code-note-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://aiden-coding.github.io/code-note-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/请求执行流程（二）之执行Handler方法"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="请求执行流程（二）之执行Handler方法 | Tommy"><meta data-rh="true" name="description" content="本文是 springmvc 请求执行流程的第二篇文章，在上一篇文章中，我们分析了 DispatcherServlet#doDispatch 方法，总结出请求执行分为如下步骤："><meta data-rh="true" property="og:description" content="本文是 springmvc 请求执行流程的第二篇文章，在上一篇文章中，我们分析了 DispatcherServlet#doDispatch 方法，总结出请求执行分为如下步骤："><link data-rh="true" rel="icon" href="/code-note-blog/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/请求执行流程（二）之执行Handler方法"><link data-rh="true" rel="alternate" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/请求执行流程（二）之执行Handler方法" hreflang="en"><link data-rh="true" rel="alternate" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/请求执行流程（二）之执行Handler方法" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/code-note-blog/blog/rss.xml" title="Tommy RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/code-note-blog/blog/atom.xml" title="Tommy Atom Feed"><link rel="stylesheet" href="/code-note-blog/assets/css/styles.dd5372db.css">
<script src="/code-note-blog/assets/js/runtime~main.f999fb27.js" defer="defer"></script>
<script src="/code-note-blog/assets/js/main.a0bfbaed.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_XYiV" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/code-note-blog/"><b class="navbar__title text--truncate">Tommy</b></a><a class="navbar__item navbar__link" href="/code-note-blog/docs/Java/basic/抽象类和接口">java</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/JavaWeb/走进JavaWeb技术世界：JavaWeb的由来和基础知识">javaweb</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/cache/探索Redis设计与实现：连接底层与表面的数据结构robj">cache</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/backend/后端技术杂谈：白话虚拟化技术">backend</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/cs/algorithms/剑指offer">cs</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/database/重新学习MySQL数据库：『浅入浅出』MySQL和InnoDB">database</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/distributed/basic/分布式系统理论基础 ：CAP">distributed</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/interview/BATJ-Experience/面阿里,终获offer">interview</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/mq/kafka/消息队列kafka详解：如何实现死信队列">mq</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/code-note-blog/docs/Spring全家桶/Spring/第一个Spring应用">spring</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/mianshi/collection">面试</a><a href="https://aiden-coding.github.io/code-note-blog/SpringCloud%E7%AC%AC3%E5%AD%A32024.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="toggle_XbAW colorModeToggle_r5NY"><button class="clean-btn toggleButton_Jx0n toggleButtonDisabled_zYO7" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_FjAw"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_qmEt"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_wJfS"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_LABv"><div class="docsWrapper_pdvB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_Jioa" type="button"></button><div class="docRoot_qx_v"><aside class="theme-doc-sidebar-container docSidebarContainer_NHKT"><div class="sidebarViewport_uyYB"><div class="sidebar_SZG4"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_VP_k"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/Spring/第一个Spring应用">Spring</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：初探SpringIOC核心流程">Spring源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringBoot/给你一份SpringBoot知识清单">SpringBoot</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBoot启动流程（四）：启动IOC容器">SpringBoot源码解析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloud/SpringCloudConsul">SpringCloud</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudConfig源码分析">SpringCloud源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba/SpringCloudAlibaba概览">SpringCloudAlibaba</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba源码分析/SpringCloudAlibabaNacos源码分析：服务发现">SpringCloudAlibaba源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringMVC/SpringMVC常见注解">SpringMVC</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/请求执行流程（二）之执行Handler方法">SpringMVC源码分析</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/请求执行流程（二）之执行Handler方法">请求执行流程（二）之执行Handler方法</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/请求执行流程（一）之获取Handler">请求执行流程（一）之获取Handler</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/DispatcherServlet初始化流程">DispatcherServlet初始化流程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringMVC源  码分析/RequestMapping初始化流程">RequestMapping初始化流程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/Spring容器启动Tomcat">Spring容器启动Tomcat</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/SpringMVC的Demo与@EnableWebMvc注解">SpringMVC的Demo与@EnableWebMvc注解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/SpringMVC源码分析：消息转换器HttpMessageConverter与@ResponseBody注解">SpringMVC源码分析：消息转换器HttpMessageConverter与@ResponseBody注解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/SpringMVC源码分析：DispatcherServlet的初始化与请求转发">SpringMVC源码分析：DispatcherServlet的初始化与请求转发</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/SpringMVC源码分析：DispatcherServlet如何找到正确的Controller">SpringMVC源码分析：DispatcherServlet如何找到正确的Controller</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/SpringMVC源码分析：SpringMVC的视图解析原理">SpringMVC源码分析：SpringMVC的视图解析原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/SpringMVC源码分析：SpringMVC概述">SpringMVC源码分析：SpringMVC概述</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/SpringMVC源码分析：SpringMVC设计理念与DispatcherServlet">SpringMVC源码分析：SpringMVC设计理念与DispatcherServlet</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/SpringMVC整体源码结构总结">SpringMVC整体源码结构总结</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_SejT"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_j3Yw"><div class="docItemContainer_XOSC"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_F6gm" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/code-note-blog/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YCxa"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">SpringMVC源码分析</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">请求执行流程（二）之执行Handler方法</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ToOY theme-doc-toc-mobile tocMobile_suYB"><button type="button" class="clean-btn tocCollapsibleButton_VzP_">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>请求执行流程（二）之执行Handler方法</h1></header><p>本文是 <strong>springmvc 请求执行流程</strong>的第二篇文章，在上一篇文章中，我们分析了 <code>DispatcherServlet#doDispatch</code> 方法，总结出请求执行分为如下步骤：</p>
<ol>
<li>获取对应的 <code>HandlerExecutionChain</code>, 获取的 <code>HandlerExecutionChain</code> 中包含真正地处理器（<code>Controller</code> 中的方法）和一组 <code>HandlerInterceptor</code> 拦截器；</li>
<li>获取对应的 <code>handlerAdapter</code>，该对象用来运行 <code>handler(xxx)</code> 方法；</li>
<li>执行 spring 的拦截器，运行 <code>HandlerInterceptor#preHandle</code> 方法；</li>
<li>处理请求，也就是通过上面获取到的 <code>handlerAdapter</code> 来调用 <code>handle(xxx)</code> 方法；</li>
<li>执行 spring 的拦截器，运行 <code>HandlerInterceptor#postHandle</code> 方法；</li>
<li>处理返回结果，这里会渲染视图，以及执行 spring 拦截器的 <code>HandlerInterceptor#afterCompletion</code>。</li>
</ol>
<p>接着，我们继续分析 <code>HandlerExecutionChain</code> 的获取以及 <code>handlerAdapter</code> 的获取，书接上回，本文将继续分析接下来的步骤。</p>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="5-执行-spring-的拦截器handlerinterceptorprehandle">5. 执行 spring 的拦截器：<code>HandlerInterceptor#preHandle</code><a href="#5-执行-spring-的拦截器handlerinterceptorprehandle" class="hash-link" aria-label="Direct link to 5-执行-spring-的拦截器handlerinterceptorprehandle" title="Direct link to 5-执行-spring-的拦截器handlerinterceptorprehandle">​</a></h3>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected void doDispatch(HttpServletRequest request, HttpServletResponse response) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 3\. 运行spring的拦截器, 运行 HandlerInterceptor#preHandle 方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 这个mappedHandler，就是第1步获取的HandlerExecutionChain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!mappedHandler.applyPreHandle(processedRequest, response)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上面的 <code>mappedHandler</code>，就是第 1 步获取的 <code>HandlerExecutionChain</code>，进入 <code>HandlerExecutionChain#applyPreHandle</code>：</p>
<blockquote>
<p>HandlerExecutionChain#applyPreHandle</p>
</blockquote>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 执行 HandlerInterceptor#preHandle 方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">boolean applyPreHandle(HttpServletRequest request, HttpServletResponse response) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 获取所有的拦截器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HandlerInterceptor[] interceptors = getInterceptors();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!ObjectUtils.isEmpty(interceptors)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 遍历执行 preHandle 方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; interceptors.length; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            HandlerInterceptor interceptor = interceptors[i];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!interceptor.preHandle(request, response, this.handler)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 失败了，还会继续执行 HandlerInterceptor#afterCompletion 方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                triggerAfterCompletion(request, response, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.interceptorIndex = i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 执行 HandlerInterceptor#afterCompletion 方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 为了保证HandlerInterceptor#afterCompletion的执行，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 接下来的分析会看到，这个方法会在多个方法调用到</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void triggerAfterCompletion(HttpServletRequest request, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HttpServletResponse response, @Nullable Exception ex) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HandlerInterceptor[] interceptors = getInterceptors();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!ObjectUtils.isEmpty(interceptors)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 遍历执行 HandlerInterceptor#afterCompletion 方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = this.interceptorIndex; i &gt;= 0; i--) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            HandlerInterceptor interceptor = interceptors[i];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                interceptor.afterCompletion(request, response, this.handler, ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            catch (Throwable ex2) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                logger.error(&quot;HandlerInterceptor.afterCompletion threw exception&quot;, ex2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们来看一眼 <code>HandlerExecutionChain</code>：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-40ba62630b5d83a16ed9aba35aba48af8be.png" alt="" class="img_kGBN"></p>
<p>再来看看传入 <code>HandlerInterceptor</code> 的 <code>handler</code> 是啥：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-6c50a936804c1db4a7b817dbb5ff417034d.png" alt="" class="img_kGBN"></p>
<p>这个 <code>handler</code> 就是 <code>HandlerMethod</code>，里面包含的信息还是挺丰富的，像 <code>bean</code>/<code>beanFactory</code>/<code>method</code>，利用这几个属性，我们可以对其进行各种操作。</p>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="6-方法的执行abstracthandlermethodadapterhandle">6. 方法的执行：<code>AbstractHandlerMethodAdapter#handle</code><a href="#6-方法的执行abstracthandlermethodadapterhandle" class="hash-link" aria-label="Direct link to 6-方法的执行abstracthandlermethodadapterhandle" title="Direct link to 6-方法的执行abstracthandlermethodadapterhandle">​</a></h3>
<p>我们再回到 <code>DispatcherServlet#doDispatch</code>，执行完 <code>HandlerInterceptor#preHandle</code> 方法后，就来到所有流程中的重头戏：<code>handler</code> 的执行，也就是 <code>controller</code> 中，<code>url</code> 对应的方法执行：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected void doDispatch(HttpServletRequest request, HttpServletResponse response) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 4\. 通过上面获取到的handlerAdapter来调用handle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>一  路跟进去，最终来到了 <code>RequestMappingHandlerAdapter#invokeHandlerMethod</code> 方法：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected ModelAndView invokeHandlerMethod(HttpServletRequest request,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HttpServletResponse response, HandlerMethod handlerMethod) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 包装reques与request对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServletWebRequest webRequest = new ServletWebRequest(request, response);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取 @InitBinder 注解的方法，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 包含当前controller与 @ControllerAdvice 标注的类里的 @InitBinder 注解的方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        WebDataBinderFactory binderFactory = getDataBinderFactory(handlerMethod);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取 @ModelAttribute 注解的方法，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 包含当前controller与 @ControllerAdvice 标注的类里的 @ModelAttribute 注解的方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ModelFactory modelFactory = getModelFactory(handlerMethod, binderFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建方法执行对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ServletInvocableHandlerMethod invocableMethod = createInvocableHandlerMethod(handlerMethod);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.argumentResolvers != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            invocableMethod.setHandlerMethodArgumentResolvers(this.argumentResolvers);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.returnValueHandlers != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            invocableMethod.setHandlerMethodReturnValueHandlers(this.returnValueHandlers);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        invocableMethod.setDataBinderFactory(binderFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        invocableMethod.setParameterNameDiscoverer(this.parameterNameDiscoverer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建ModelAndView的容器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ModelAndViewContainer mavContainer = new ModelAndViewContainer();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mavContainer.addAllAttributes(RequestContextUtils.getInputFlashMap(request));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        modelFactory.initModel(webRequest, mavContainer, invocableMethod);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mavContainer.setIgnoreDefaultModelOnRedirect(this.ignoreDefaultModelOnRedirect);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理异步请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AsyncWebRequest asyncWebRequest = WebAsyncUtils.createAsyncWebRequest(request, response);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        asyncWebRequest.setTimeout(this.asyncRequestTimeout);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        asyncManager.setTaskExecutor(this.taskExecutor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        asyncManager.setAsyncWebRequest(asyncWebRequest);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        asyncManager.registerCallableInterceptors(this.callableInterceptors);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        asyncManager.registerDeferredResultInterceptors(this.deferredResultInterceptors);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (asyncManager.hasConcurrentResult()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object result = asyncManager.getConcurrentResult();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mavContainer = (ModelAndViewContainer) asyncManager.getConcurrentResultContext()[0];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            asyncManager.clearConcurrentResult();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LogFormatUtils.traceDebug(logger, traceOn -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String formatted = LogFormatUtils.formatValue(result, !traceOn);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return &quot;Resume with async result [&quot; + formatted + &quot;]&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            invocableMethod = invocableMethod.wrapConcurrentResult(result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 执行Controller的方法（重点）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        invocableMethod.invokeAndHandle(webRequest, mavContainer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (asyncManager.isConcurrentHandlingStarted()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理返回结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return getModelAndView(mavContainer, modelFactory, webRequest);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        webRequest.requestCompleted();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个方法有点长，但重点方法只有一行：<code>invocableMethod.invokeAndHandle(webRequest, mavContainer);</code>，在这个方法前的部分都是在做方法执行前的准备工作，如获取 <code>@InitBinder</code> 注解的方法、获取 <code>@ModelAttribute</code> 注解的方法，准备方法参数 <code>webRequest</code>(包装 <code>request</code> 与 <code>response</code> 对象) 与 <code>mavContainer</code>(<code>ModelAndView</code> 包装对象) 等。这里我们直接进入 <code>invocableMethod.invokeAndHandle</code>，看看方法是如何执行的：</p>
<blockquote>
<p>ServletInvocableHandlerMethod#invokeAndHandle</p>
</blockquote>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public void invokeAndHandle(ServletWebRequest webRequest, ModelAndViewContainer mavContainer,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object... providedArgs) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 执行handler方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object returnValue = invokeForRequest(webRequest, mavContainer, providedArgs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 设置 RequestHandled 属性值，springmvc会根据该值判断要不要跳转</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (returnValue == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (isRequestNotModified(webRequest) || getResponseStatus() != null </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                || mavContainer.isRequestHandled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            disableContentCachingIfNecessary(webRequest);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mavContainer.setRequestHandled(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else if (StringUtils.hasText(getResponseStatusReason())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mavContainer.setRequestHandled(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mavContainer.setRequestHandled(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Assert.state(this.returnValueHandlers != null, &quot;No return value handlers&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理返回结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.returnValueHandlers.handleReturnValue(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                returnValue, getReturnValueType(returnValue), mavContainer, webRequest);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catch (Exception ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw ex;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里方法先是调用了 <code>invokeForRequest</code> 执行方法，然后再根据方法的返回值来设置 <code>mavContainer</code> 的 <code>RequestHandled</code> 值，最后处理返回结果。继续跟进 <code>invokeForRequest</code> 方法：</p>
<blockquote>
<p>InvocableHandlerMethod#invokeForRequest</p>
</blockquote>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Object invokeForRequest(NativeWebRequest request, @Nullable ModelAndViewContainermavContainer,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object... providedArgs) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 处理参数绑定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object[] args = getMethodArgumentValues(request, mavContainer, providedArgs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 反射调用方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return doInvoke(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个方法里先是处理了参数解析，然后使用反射进行方法调用。事实上，整个执行流程中，最核心的就是参数解析了，在 controller 里的 handler 方法中，我们可以这样指定参数：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">// 直接传参</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;xxx&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Object test(String name) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 在参数上标有@RequestParam、@RequestHeader等注解</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;xxx&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Object test(@RequestParam(&quot;name&quot;) String name, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   @RequestHeader(&quot;uid&quot;) String uid) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 将传入的参数封装为对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;xxx&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Object test(User user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 上面的方法都是使用form表单传参(也就是k1=v1&amp;2=v2&amp;...的方法)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 这个方法使用 RequestBody 方式传参，将参数内容放入消息体中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;xxx&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Object test(@RequestBody User user) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>当我们按规范传入参数时，springmvc 都能正常处理，我们来看看 springmvc 是如何做到这一点的。</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="参数解析">参数解析<a href="#参数解析" class="hash-link" aria-label="Direct link to 参数解析" title="Direct link to 参数解析">​</a></h4>
<p>继续，进入 <code>InvocableHandlerMethod#getMethodArgumentValues</code> 方法：</p>
<blockquote>
<p>InvocableHandlerMethod#getMethodArgumentValues</p>
</blockquote>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected Object[] getMethodArgumentValues(NativeWebRequest request, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Nullable ModelAndViewContainer mavContainer, Object... providedArgs) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 获取方法的所有参数，可以简单理解为利用反射获取handler方法参数，然后包装为 MethodParameter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MethodParameter[] parameters = getMethodParameters();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ObjectUtils.isEmpty(parameters)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return EMPTY_ARGS;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object[] args = new Object[parameters.length];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 依次处理每个参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 0; i &lt; parameters.length; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MethodParameter parameter = parameters[i];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        parameter.initParameterNameDiscovery(this.parameterNameDiscoverer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        args[i] = findProvidedArgument(parameter, providedArgs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (args[i] != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 判断是否有参数解析类支持当前参数的解析</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!this.resolvers.supportsParameter(parameter)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalStateException(formatArgumentError(parameter, &quot;No suitable resolver&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 处理参数解析</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            args[i] = this.resolvers.resolveArgument(parameter, mavContainer, request, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    this.dataBinderFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        catch (Exception ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw ex;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return args;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个方法先获取了 handler 方法的参数 (可以简单理解为利用反射获取 handler 方法参数，然后包装为 <code>MethodParameter</code>)，然后对这些参数逐个解析。解析时，会用到两个重要的方法：<code>resolvers.supportsParameter(...)</code> 与 <code>resolvers.resolveArgument(...)</code>，这两个方法最终调用的方法在 <code>HandlerMethodArgumentResolverComposite</code> 中：</p>
<blockquote>
<p>HandlerMethodArgumentResolverComposite</p>
</blockquote>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Object resolveArgument(MethodParameter parameter, @Nullable ModelAndViewContainermavContainer,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        NativeWebRequest webRequest, @Nullable WebDataBinderFactory binderFactory) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 获取一个解析器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HandlerMethodArgumentResolver resolver = getArgumentResolver(parameter);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (resolver == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalArgumentException(...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 解析参数，调用 HandlerMethodArgumentResolver#resolveArgument 方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return resolver.resolveArgument(parameter, mavContainer, webRequest, binderFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private HandlerMethodArgumentResolver getArgumentResolver(MethodParameter parameter) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HandlerMethodArgumentResolver result = this.argumentResolverCache.get(parameter);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (result == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 遍历所有的解析器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (HandlerMethodArgumentResolver resolver : this.argumentResolvers) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 找到其中一个解析器，返回</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 调用 HandlerMethodArgumentResolver#supportsParameter 方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (resolver.supportsParameter(parameter)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                result = resolver;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.argumentResolverCache.put(parameter, result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这两个方法主要是遍历解析器，然后调用 <code>HandlerMethodArgumentResolver#supportsParameter</code> 与 <code>HandlerMethodArgumentResolver#resolveArgument</code> 处理具体的操作。<code>HandlerMethodArgumentResolver</code> 是个接口，里面仅有两个方法：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public interface HandlerMethodArgumentResolver {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 当前是否支持处理当前参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean supportsParameter(MethodParameter parameter);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 具体的解析操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object resolveArgument(MethodParameter parameter, @Nullable ModelAndViewContainer mavContainer,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            NativeWebRequest webRequest, @Nullable WebDataBinderFactory binderFactory) throws Exception;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个就是真正的参数解析器了。在 springmvc 中，提供了多少种参数解析器呢？经过本人的调试，发现多达 26 个：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-fd30bc847fc2cf7082de3731e68df6ae5f9.png" alt="" class="img_kGBN"> <img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-894b391bbe4567734ee7237d900bc55ee31.png" alt="" class="img_kGBN"></p>
<p>正是在这些参数解析器的帮助下，springmvc 能支持多种参数接收方式！对于参数解析器，由于设计比较复杂，涉及多种传参方式，本文并不想展开讨论，感兴趣的小伙伴可自行查阅相关文档。</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="执行-handler-方法">执行 handler 方法<a href="#执行-handler-方法" class="hash-link" aria-label="Direct link to 执行 handler 方法" title="Direct link to 执  行 handler 方法">​</a></h4>
<p>处理完参数解析后，就开始执行 handler 方法了。让我们回到 <code>InvocableHandlerMethod#invokeForRequest</code> 方法：</p>
<blockquote>
<p>InvocableHandlerMethod#invokeForRequest</p>
</blockquote>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Object invokeForRequest(NativeWebRequest request, @Nullable ModelAndViewContainermavContainer,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object... providedArgs) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 处理参数绑定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object[] args = getMethodArgumentValues(request, mavContainer, providedArgs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 反射调用方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return doInvoke(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>进入 <code>doInvoke</code> 方法：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected Object doInvoke(Object... args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 使用反射执行方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ReflectionUtils.makeAccessible(getBridgedMethod());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 这里就是反射操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return getBridgedMethod().invoke(getBean(), args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catch (...) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个方法很简单，就是利用反射来进行方法执行的，就不过多分析了。</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="处理返回参数">处理返回参数<a href="#处理返回参数" class="hash-link" aria-label="Direct link to 处理返回参数" title="Direct link to 处理返回参数">​</a></h4>
<p>让我们回到 <code>ServletInvocableHandlerMethod#invokeAndHandle</code> 方法：</p>
<blockquote>
<p>ServletInvocableHandlerMethod#invokeAndHandle</p>
</blockquote>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public void invokeAndHandle(ServletWebRequest webRequest, ModelAndViewContainer mavContainer,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object... providedArgs) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 执行handle方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object returnValue = invokeForRequest(webRequest, mavContainer, providedArgs);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理返回结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.returnValueHandlers.handleReturnValue(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                returnValue, getReturnValueType(returnValue), mavContainer, webRequest);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catch (Exception ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw ex;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>处理完方法执行后，接着就处理 返回结果：</p>
<blockquote>
<p>HandlerMethodReturnValueHandlerComposite#handleReturnValue</p>
</blockquote>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void handleReturnValue(@Nullable Object returnValue, MethodParameter returnType,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 根据返回类型找一个合适的handler来处理返回数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HandlerMethodReturnValueHandler handler = selectHandler(returnValue, returnType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (handler == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalArgumentException(...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    handler.handleReturnValue(returnValue, returnType, mavContainer, webRequest);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private HandlerMethodReturnValueHandler selectHandler(@Nullable Object value, MethodParameterreturnType) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean isAsyncValue = isAsyncReturnValue(value, returnType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 遍历，逐个判断是否能处理当前返回类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (HandlerMethodReturnValueHandler handler : this.returnValueHandlers) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (isAsyncValue &amp;&amp; !(handler instanceof AsyncHandlerMethodReturnValueHandler)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (handler.supportsReturnType(returnType)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return handler;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>获取 <code>ReturnValueHandler</code> 的套路与前面获取 <code>ArgumentResolver</code> 的套路相关无几，<code>ReturnValueHandler</code> 是 <code>HandlerMethodReturnValueHandler</code> 的子类，<code>HandlerMethodReturnValueHandler</code> 代码如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public interface HandlerMethodReturnValueHandler {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 判断当前ReturnValueHandler能否处理传入的returnType</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean supportsReturnType(MethodParameter returnType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 具体的处理逻辑</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void handleReturnValue(@Nullable Object returnValue, MethodParameter returnType,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>同前面参数解析器一样，这个接口里也有两个方法：</p>
<ul>
<li><code>boolean supportsReturnType(xxx)</code>：判断当前 <code>ReturnValueHandler</code> 能否处理传入的 <code>returnType</code></li>
<li><code>void handleReturnValue(xxx)</code>：具体的处理逻辑</li>
</ul>
<p>同样地，springmvc 也提供了非常多的实现来处理返回参数：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-8e3c1fd4dca7c13efbceac5800e26145963.png" alt="" class="img_kGBN"></p>
<p>对于参数的返回，我们来看一个简单的示例：</p>
<p>如果我们像这样返回值时：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Controller</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/xxx&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class XxxController {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @RequestMapping(&quot;/index&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String index() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return &quot;index&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>返回到页面的将是一个视图，对应的 <code>HandlerMethodReturnValueHandler</code> 为 <code>ViewNameMethodReturnValueHandler</code>：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class ViewNameMethodReturnValueHandler implements HandlerMethodReturnValueHandler {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String[] redirectPatterns;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 省略 redirectPatterns 的setter与getter方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean supportsReturnType(MethodParameter returnType) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Class&lt;?&gt; paramType = returnType.getParameterType();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 支持处理的返回值类型：返回值类型为void，或者为字符串类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (void.class == paramType || CharSequence.class.isAssignableFrom(paramType));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 具体的处理逻辑</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void handleReturnValue(@Nullable Object returnValue, MethodParameter returnType,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ModelAndViewContainer mavContainer, NativeWebRequest webRequest) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (returnValue instanceof CharSequence) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // viewName 就是返回值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String viewName = returnValue.toString();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mavContainer.setViewName(viewName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (isRedirectViewName(viewName)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 是否需要跳转</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                mavContainer.setRedirectModelScenario(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else if (returnValue != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new UnsupportedOperationException(...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 判断是否需要跳转</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected boolean isRedirectViewName(String viewName) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // this.redirectPatterns 默认为null，可以自行调用 setter 方法设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (PatternMatchUtils.simpleMatch(this.redirectPatterns, viewName) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 匹配 redirect: 开头，也就是说，如果我们返回 &quot;redirect:index&quot;，就表明该结果需要跳转</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            || viewName.startsWith(&quot;redirect:&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个类比较简单，关键部分已在代码中作了注释，这里就不多说了。值得一提的是，在 <code>handleReturnValue(xxx)</code> 方法中，springmvc 将返回的字符串设置为 <code>viewName</code> 需要注意下，后面在处理视图时，会利用这个 <code>viewName</code> 拿到对应的 <code>View</code>。</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="获取-modelandview">获取 ModelAndView<a href="#获取-modelandview" class="hash-link" aria-label="Direct link to 获取 ModelAndView" title="Direct link to 获取 ModelAndView">​</a></h4>
<p>让我们回到 <code>RequestMappingHandlerAdapter#invokeHandlerMethod</code> 方法：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected ModelAndView invokeHandlerMethod(HttpServletRequest request,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HttpServletResponse response, HandlerMethod handlerMethod) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServletWebRequest webRequest = new ServletWebRequest(request, response);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 执行Controller的方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        invocableMethod.invokeAndHandle(webRequest, mavContainer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (asyncManager.isConcurrentHandlingStarted()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理执行结果，从中拿到 ModelAndView</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return getModelAndView(mavContainer, modelFactory, webRequest);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        webRequest.requestCompleted();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>执行完 <code>invocableMethod.invokeAndHandle(webRequest, mavContainer)</code> 方法后接着就是从执行结果中拿到 <code>ModelAndView</code> 了，进入 <code>RequestMappingHandlerAdapter#getModelAndView</code> 方法：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">private ModelAndView getModelAndView(ModelAndViewContainer mavContainer,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ModelFactory modelFactory, NativeWebRequest webRequest) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 这个 ModelFactory，就是前面获取的 包含@ModelAttribute 注解的方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    modelFactory.updateModel(webRequest, mavContainer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (mavContainer.isRequestHandled()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ModelMap model = mavContainer.getModel();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 创建视图对象，把mavContainer.getViewName()传入到ModelAndView的构造方法中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ModelAndView mav = new ModelAndView(mavContainer.getViewName(), </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            model, mavContainer.getStatus());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!mavContainer.isViewReference()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mav.setView((View) mavContainer.getView());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 处理重定向参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (model instanceof RedirectAttributes) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, ?&gt; flashAttributes = ((RedirectAttributes) model).getFlashAttributes();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HttpServletRequest request = webRequest.getNativeRequest(HttpServletRequest.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (request != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            RequestContextUtils.getOutputFlashMap(request).putAll(flashAttributes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return mav;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可以看到，<code>ModelAndView</code> 就是从前面执行结果的 <code>viewName</code> 得到的。</p>
<p>至此，<code>AbstractHandlerMethodAdapter#handle</code> 执行完毕。</p>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="7-执行拦截器handlerinterceptorposthandle">7. 执行拦截器：<code>HandlerInterceptor#postHandle</code><a href="#7-执行拦截器handlerinterceptorposthandle" class="hash-link" aria-label="Direct link to 7-执行拦截器handlerinterceptorposthandle" title="Direct link to 7-执行拦截器handlerinterceptorposthandle">​</a></h3>
<p>让我们再回到 <code>DispatcherServlet#doDispatch</code> 方法：</p>
<blockquote>
<p>DispatcherServlet#doDispatch</p>
</blockquote>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected void doDispatch(HttpServletRequest request, HttpServletResponse response) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 4.通过上面获取到的handlerAdapter来调用handle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 5.如果函数调用没有返回视图则使用默认的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            applyDefaultViewName(processedRequest, mv);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 6\. 执行拦截器，运行 HandlerInterceptor#postHandle 方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            mappedHandler.applyPostHandle(processedRequest, response, mv);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        catch (...) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 7\. 处理返回结果，在这个方法里会执行 HandlerInterceptor.afterCompletion</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catch (...) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>执行完 <code>handler</code> 方法后，就开始执行拦截器的 <code>HandlerInterceptor#postHandle</code> 方法了：</p>
<blockquote>
<p>HandlerExecutionChain#applyPostHandle</p>
</blockquote>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">void applyPostHandle(HttpServletRequest request, HttpServletResponse response, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @NullableModelAndView mv) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HandlerInterceptor[] interceptors = getInterceptors();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!ObjectUtils.isEmpty(interceptors)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 遍历执行 postHandle(...) 方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = interceptors.length - 1; i &gt;= 0; i--) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            HandlerInterceptor interceptor = interceptors[i];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            interceptor.postHandle(request, response, this.handler, mv);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个同前面执行拦截器方法类似，这里就不过多分析了。需要强调的是，<code>HandlerInterceptor#postHandle</code> 的执行时机是<strong>在执行完 <code>handler</code> 方法后之后，在视图解析之前</strong>。因此，我们可以在拦截器的这个方法里处理一些额外的渲染参数。</p>
<p>限于篇幅，本文就先到这里了，request 执行的后续流程，我们下篇文章再分析。</p>
<hr>
<p><em>本文原文链接：<a href="https://my.oschina.net/funcy/blog/4741104" target="_blank" rel="noopener noreferrer">https://my.oschina.net/funcy/blog/4741104</a> ，限于作者个人水平，文中难免有错误之处，欢迎指正！原创不易，商业转载请联系作者获得授权，非商业转载 请注明出处。</em></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Spring全家桶/SpringMVC源码分析/请求执行流程（二）之执行Handler方法.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_EYjg" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_eevz"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/code-note-blog/docs/Spring全家桶/SpringMVC/SpringMVC中的异常处理器"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Spring MVC 处理器异常解析器</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/请求执行流程（一）之获取Handler"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">请求执行流程（一）之获取Handler</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_lc2k thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#5-执行-spring-的拦截器handlerinterceptorprehandle" class="table-of-contents__link toc-highlight">5. 执行 spring 的拦截器：<code>HandlerInterceptor#preHandle</code></a></li><li><a href="#6-方法的执行abstracthandlermethodadapterhandle" class="table-of-contents__link toc-highlight">6. 方法的执行：<code>AbstractHandlerMethodAdapter#handle</code></a></li><li><a href="#7-执行拦截器handlerinterceptorposthandle" class="table-of-contents__link toc-highlight">7. 执行拦截器：<code>HandlerInterceptor#postHandle</code></a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/code-note-blog/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/code-note-blog/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>