<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Spring全家桶/Spring/Spring中的Environment环境变量" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.0">
<title data-rh="true">Spring中的Environment环境变量 | Tommy</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aiden-coding.github.io/code-note-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://aiden-coding.github.io/code-note-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/Spring/Spring中的Environment环境变量"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Spring中的Environment环境变量 | Tommy"><meta data-rh="true" name="description" content="如今，致力于帮助开发者用更少的代码、更快地写出生产级系统的 Spring Boot 已然成为 Java 应用开发的事实标准。在 Spring Boot 提供的众多特性中，自动配置无疑是对提升开发体验最显著的一个特性，Spring Boot 基于这一特性为开发人员自动声明了若干开箱即用、具备某一功能的 Bean。大多数情况下，自动配置的 Bean 刚好能满足大家的需求，但在某些情况下，不得不完整地覆盖它们，这个时候只需要重新声明相关类型的 Bean 即可，因为绝大多数自动配置的 Bean 都会由@ConditionalOnMissingBean注解修饰。幸运的是，如果只是想微调一些细节，比如改改端口号 (server.port) 和数据源 URL (spring.datasource.url) ，那压根没必要重新声明ServerProperties和DataSourceProperties这俩 Bean 来覆盖自动配置的 Bean。 Spring Boot 为自动配置的 Bean 提供了1000多个用于微调的属性，当需要调整设置时，只需要在环境变量、命令行参数或配置文件 (application.properties/application.yml) 中进行指定即可，这就是 Spring Boot 的Externalized Configuration (配置外化) 特性。"><meta data-rh="true" property="og:description" content="如今，致力于帮助开发者用更少的代码、更快地写出生产级系统的 Spring Boot 已然成为 Java 应用开发的事实标准。在 Spring Boot 提供的众多特性中，自动配置无疑是对提升开发体验最显著的一个特性，Spring Boot 基于这一特性为开发人员自动声明了若干开箱即用、具备某一功能的 Bean。大多数情况下，自动配置的 Bean 刚好能满足大家的需求，但在某些情况下，不得不完整地覆盖它们，这个时候只需要重新声明相关类型的 Bean 即可，因为绝大多数自动配置的 Bean 都会由@ConditionalOnMissingBean注解修饰。幸运的是，如果只是想微调一些细节，比如改改端口号 (server.port) 和数据源 URL (spring.datasource.url) ，那压根没必要重新声明ServerProperties和DataSourceProperties这俩 Bean 来覆盖自动配置的 Bean。 Spring Boot 为自动配置的 Bean 提供了1000多个用于微调的属性，当需要调整设置时，只需要在环境变量、命令行参数或配置文件 (application.properties/application.yml) 中进行指定即可，这就是 Spring Boot 的Externalized Configuration (配置外化) 特性。"><link data-rh="true" rel="icon" href="/code-note-blog/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/Spring/Spring中的Environment环境变量"><link data-rh="true" rel="alternate" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/Spring/Spring中的Environment环境变量" hreflang="en"><link data-rh="true" rel="alternate" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/Spring/Spring中的Environment环境变量" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/code-note-blog/blog/rss.xml" title="Tommy RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/code-note-blog/blog/atom.xml" title="Tommy Atom Feed"><link rel="stylesheet" href="/code-note-blog/assets/css/styles.dd5372db.css">
<script src="/code-note-blog/assets/js/runtime~main.f999fb27.js" defer="defer"></script>
<script src="/code-note-blog/assets/js/main.a0bfbaed.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_XYiV" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/code-note-blog/"><b class="navbar__title text--truncate">Tommy</b></a><a class="navbar__item navbar__link" href="/code-note-blog/docs/Java/basic/抽象类和接口">java</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/JavaWeb/走进JavaWeb技术世界：JavaWeb的由来和基础知识">javaweb</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/cache/探索Redis设计与实现：连接底层与表面的数据结构robj">cache</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/backend/后端技术杂谈：白话虚拟化技术">backend</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/cs/algorithms/剑指offer">cs</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/database/重新学习MySQL数据库：『浅入浅出』MySQL和InnoDB">database</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/distributed/basic/分布式系统理论基础 ：CAP">distributed</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/interview/BATJ-Experience/面阿里,终获offer">interview</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/mq/kafka/消息队列kafka详解：如何实现死信队列">mq</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/code-note-blog/docs/Spring全家桶/Spring/第一个Spring应用">spring</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/mianshi/collection">面试</a><a href="https://aiden-coding.github.io/code-note-blog/SpringCloud%E7%AC%AC3%E5%AD%A32024.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="toggle_XbAW colorModeToggle_r5NY"><button class="clean-btn toggleButton_Jx0n toggleButtonDisabled_zYO7" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_FjAw"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_qmEt"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_wJfS"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_LABv"><div class="docsWrapper_pdvB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_Jioa" type="button"></button><div class="docRoot_qx_v"><aside class="theme-doc-sidebar-container docSidebarContainer_NHKT"><div class="sidebarViewport_uyYB"><div class="sidebar_SZG4"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_VP_k"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/code-note-blog/docs/Spring全家桶/Spring/第一个Spring应用">Spring</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring/第一个Spring应用">第一个Spring应用</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring/Spring常见注解">Spring注解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring/Spring概述">Spring概述</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring/Spring合集">Spring</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring/Spring容器与IOC">Spring容器与IOC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring/Spring事务基本用法">Spring事务核心接口</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring/Spring中的配置元数据（管理配置的基本数据）">Spring 配置元数据</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring/Spring中的事件处理机制">Spring 中的事件处理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring/Spring中的资源管理">Spring中的资源管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring/Spring中的Environment环境变量">Spring中的Environment环境变量</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring/Spring中对于数据库的访问">Spring中对于数据库的访问</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring/Spring中对于校验功能的支持">Spring 校验</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring/SpringAOP的概念与作用">Spring 框架的 AOP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/Spring/SpringBean的定义与管理（核心）">SpringBean的定义与管理（核心）</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：初探SpringIOC核心流程">Spring源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringBoot/给你一份SpringBoot知识清单">SpringBoot</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBoot启动流程（四）：启动IOC容器">SpringBoot源码解析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloud/SpringCloudConsul">SpringCloud</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudConfig源码分析">SpringCloud源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba/SpringCloudAlibaba概览">SpringCloudAlibaba</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba源码分析/SpringCloudAlibabaNacos源码分析：服务发现">SpringCloudAlibaba源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringMVC/SpringMVC常见注解">SpringMVC</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/请求执行流程（二）之执行Handler方法">SpringMVC源码分析</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_SejT"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_j3Yw"><div class="docItemContainer_XOSC"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_F6gm" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/code-note-blog/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YCxa"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Spring</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Spring中的Environment环境变量</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ToOY theme-doc-toc-mobile tocMobile_suYB"><button type="button" class="clean-btn tocCollapsibleButton_VzP_">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Spring中的Environment环境变量</h1></header><p>如今，致力于帮助开发者用更少的代码、更快地写出生产级系统的 Spring Boot 已然成为 Java 应用开发的事实标准。在 Spring Boot 提供的众多特性中，<strong>自动配置</strong>无疑是对提升开发体验最显著的一个特性，Spring Boot 基于这一特性为开发人员自动声明了若干开箱即  用、具备某一功能的 Bean。大多数情况下，自动配置的 Bean 刚好能满足大家的需求，但在某些情况下，不得不完整地覆盖它们，这个时候只需要重新声明相关类型的 Bean 即可，因为绝大多数自动配置的 Bean 都会由<code>@ConditionalOnMissingBean</code>注解修饰。幸运的是，如果只是想微调一些细节，比如改改端口号 (server.port) 和数据源 URL (spring.datasource.url) ，那压根没必要重新声明<code>ServerProperties</code>和<code>DataSourceProperties</code>这俩 Bean 来覆盖自动配置的 Bean。 Spring Boot 为自动配置的 Bean 提供了1000多个用于微调的属性，当需要调整设置时，只需要在环境变量、命令行参数或配置文件 (application.properties/application.yml) 中进行指定即可，这就是 Spring Boot 的<code>Externalized Configuration</code> (配置外化) 特性。</p>
<p>当然，外部配置源并不局限于环境变量、命令行参数和配置文件这三种，感兴趣的读者可以自行阅读 Spring Boot 官方文档。在 Spring 中，<code>BeanFactory</code>扮演着 Bean 容器的角色，而<code>Environment</code>同样定位为一个容器，即外部配置源中的属性都会被添加到 <em>Environment</em> 中。<strong>在微服务大行其道的今天，外部配置源又衍生出了_Disconf_、<em>Apollo</em> 和 <em>Nacos</em> 等分布式配置中心，但在 Spring 的地盘，还是要入乡随俗，从配置中心中读取到的属性依然会被追加到 <em>Environment</em> 中</strong>。</p>
<p>笔者之所以写这篇文章，是受<code>jasypt</code>组件的启发。第一次接触它是在2018年，当时就很好奇这玩意儿究竟是如何实现对敏感属性加解密的；现在来看，要想实现这么一个东东，不仅需要熟悉 Bean 的生命周期、IoC 容器拓展点 (IoC Container Extension Points) 和 Spring Boot 的启动流程等知识，还需要掌握 <em>Environment</em>。</p>
<blockquote>
<p>jasypt 上手十分简单。首先通过<code>jasypt-maven-plugin</code>这一 maven 插件为敏感属性值生成密文，然后用<code>ENC(密文)</code>替换敏感属性值即可。如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">jasypt.encryptor.password=crimson_typhoon</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.datasource.url=jdbc:mysql://HOST:PORT/db_sql_boy?characterEncoding=UTF-8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.datasource.hikari.driver-class-name=com.mysql.cj.jdbc.Driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.datasource.hikari.username=root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.datasource.hikari.password=ENC(qS8+DEIlHxvhPHgn1VaW3oHkn2twrmwNOHewWLIfquAXiCDBrKwvIhDoqalKyhIF)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_HWLp" id="1-认识-environmnent">1 认识 Environmnent<a href="#1-认识-environmnent" class="hash-link" aria-label="Direct link to 1 认识 Environmnent" title="Direct link to 1 认识 Environmnent">​</a></h2>
<p>在实际工作中，我们与 <em>Environment</em> 打交道的机会并不多；如果业务 Bean 确实需要获取外部配置源中的某一属性值，可以手动将 <em>Environment</em> 注入到该业务 Bean 中，也可以直接实现<code>EnvironmentAware</code>接口，得到 <em>Environment</em> 类型的 Bean 实例之后可以通过<code>getProperty()</code>获取具体属性值。<em>Environment</em> 接口内容如下所示：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public interface Environment extends PropertyResolver {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String[] getActiveProfiles();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String[] getDefaultProfiles();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean acceptsProfiles(Profiles profiles);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface PropertyResolver {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean containsProperty(String key);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String getProperty(String key);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String getProperty(String key, String defaultValue);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;T&gt; T getProperty(String key, Class&lt;T&gt; targetType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;T&gt; T getProperty(String key, Class&lt;T&gt; targetType, T defaultValue);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String resolvePlaceholders(String text);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>大家不要受 <em>Environment</em> 中 <em>getProperty()</em> 方法的误导，外部配置源中的属性并不是以单个属性为维度被添加到 <em>Environment</em> 中的，而是以<code>PropertySource</code>为维度</strong>。<em>PropertySource</em> 是对属性源名称和该属性源中一组属性的抽象，<code>MapPropertySource</code>是一种最简单的实现，它通过 <code>_Map&lt;String, Object&gt;_ </code>来承载相关的属性。<em>PropertySource</em> 内容如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class PropertySource&lt;T&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected final String name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected final T source;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public PropertySource(String name, T source) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.name = name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.source = source;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getName() { return this.name; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public T getSource() { return this.source; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public abstract Object getProperty(String name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>从上述 <em>PropertySource</em> 内容来看，<em>PropertySource</em> 自身是具备根据属性名获取属性值这一能力的。</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="getproperty内部执行逻辑"><strong><strong>getProperty()内部执行逻辑</strong></strong><a href="#getproperty内部执行逻辑" class="hash-link" aria-label="Direct link to getproperty内部执行逻辑" title="Direct link to getproperty内部执行逻辑">​</a></h4>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/QQ%E6%88%AA%E5%9B%BE20230416193319.jpg" alt="" class="img_kGBN"></p>
<p>一般，<em>Environment</em> 实现类中会持有一个<code>PropertyResolver</code>类型的成员变量，进而交由 <em>PropertyResolver</em> 负责执行 <em>getProperty()</em> 逻辑。<em>PropertyResolver</em> 实现类中又会持有两个成员变量，分别是：<code>ConversionService</code>与<code>PropertySources</code>；首先，<em>PropertyResolver</em> 遍历 <code>PropertySources</code> 中的 <em>PropertySource</em>，获取原生属性值；然后委派 <em>ConversionService</em> 对原生属性值进行数据类型转换 (如果有必要的话)。<strong>虽然 PropertySource 自身是具备根据属性名获取属性值这一能力的，但不具备占位符解析与类型转换能力，于是在中间引入具备这 两种能力的 PropertyResolver， 这也印证了一个段子：在计算机科学中，没有什么问题是在中间加一层解决不了的，如果有，那就再加一层</strong>。</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="propertysource内部更新逻辑"><strong><strong>PropertySource内部更新逻辑</strong></strong><a href="#propertysource内部更新逻辑" class="hash-link" aria-label="Direct link to propertysource内部更新逻辑" title="Direct link to propertysource内部更新逻辑">​</a></h4>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/QQ%E6%88%AA%E5%9B%BE20230416193319.jpg" alt="" class="img_kGBN"></p>
<p><em>Environment</em> 实现类中除了持有<code>PropertyResolver</code>类型的成员变量外，还有一个<code>MutablePropertySources</code>类型的成员变量，但并不提供直接操作该 <em>MutablePropertySources</em> 的方法，我们只能通过<code>getPropertySources()</code>方法获取 <em>MutablePropertySources</em> 实例，然后借助 <em>MutablePropertySources</em> 中的<code>addFirst()</code>、<code>addLast()</code>和<code>replace()</code>等方法去更新 <em>PropertySource</em>。<em>MutablePropertySources</em> 是 <em>PropertySources</em> 唯一一个实现类，如下图所示：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/20230416193420.png" alt="" class="img_kGBN"></p>
<p>总的来说，<em>Environment</em> 是对 <em>PropertySource</em> 和 <em>Profile</em> 的顶级抽象，下面介绍 <em>Profile</em> 的概念。当应用程序需要部署到不同的运行环境时，一些属性项通常会有所不同，比如，数据源 URL 在开发环境和测试环境就会不一样。Spring 从3.1版本开始支持基于 <em>Profile</em> 的条件化配置。</p>
<p><strong>Profile in Spring 3.1</strong></p>
<p>在 Spring 发布3.1版本时，Spring Boot 还未问世，可以说此时的 <em>Profile</em> 特性还是有些<strong>瑕疵</strong>的，但瑕不  掩瑜。主要体现在：针对同一类型的 Bean，必须声明多次。一起来感受下这种小瑕疵：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration(proxyBeanMethods = false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSourceConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Profile(&quot;dev&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataSource devDataSource () {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataSourceBuilder.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .driverClassName(&quot;com.mysql.jdbc.Driver&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .url(&quot;jdbc:mysql://DEV_HOST:PORT/db_sql_boy?characterEncoding=UTF-8&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .username(&quot;dev&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .password(&quot;dev&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Profile(&quot;test&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataSource testDataSource () {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataSourceBuilder.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .driverClassName(&quot;com.mysql.jdbc.Driver&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .url(&quot;jdbc:mysql://TEST_HOST:PORT/db_sql_boy?characterEncoding=UTF-8&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .username(&quot;test&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .password(&quot;test&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Profile in Spring Boot</strong></p>
<p>Spring Boot 发布后，<code>@Profile</code>注解可以扔到九霄云外了。官方开发大佬肯定也意识到 <em>Profile in Spring 3.1</em> 中这种瑕疵，于是在 Spring Boot 的第一版本 <em>(1.0.0.RELEASE)</em> 中就迫不及待地支持为 <em>application.properties</em> 和 <em>application.yml</em> 里的属性项配置 <em>Profile</em> 了。换个口味，一起来感受下这种优雅：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration(proxyBeanMethods = false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSourceConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DataSource devDataSource (DataSourceProperties dataSourceProperties) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return DataSourceBuilder.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .driverClassName(dataSourceProperties.getDriverClassName())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .url(dataSourceProperties.getUrl())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .username(dataSourceProperties.getUsername())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .password(dataSourceProperties.getPassword())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><em>application-dev.properties</em> 内容如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">spring.datasource.url=jdbc:mysql://DEV_HOST:PORT/db_sql_boy?characterEncoding=UTF-8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.datasource.hikari.driver-class-name=com.mysql.jdbc.Driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.datasource.hikari.password=dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.datasource.hikari.username=dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><em>application-test.properties</em> 内容如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">spring.datasource.url=jdbc:mysql://TEST_HOST:PORT/db_sql_boy?characterEncoding=UTF-8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.datasource.hikari.driver-class-name=com.mysql.jdbc.Driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.datasource.hikari.password=test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.datasource.hikari.username=test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在原生 Spring 3.1 和 Spring Boot 中，均是通过<code>spring.profiles.active</code>来为 <em>Environment</em> 指定激活的 <em>Profile</em>，否则_Environment_ 中默认激活的 <em>Profile</em> 名称为<code>default</code>。写到这里，笔者脑海中闪现一个问题：一般，<code>@Profile</code> 注解主要与 <em>@Configuration</em> 注解或 <em>@Bean</em> 注解搭配使用，如果 <em>spring.profiles.active</em> 的值为 <em>dev</em> 时，那么那些由 <em>@Configuration</em> 或 <em>@Bean</em> 注解标记 (但没有<code>@Profile</code>注解的身影哈) 的 Bean 还会被解析为若干<code>BeanDefinition</code>实例吗？答案是会的。<code>ConfigurationClassPostProcessor</code>负责将 <em>@Configuration</em> 配置类解析为 <em>BeanDefinition</em>，在此过程中会执行<code>ConditionEvaluator</code>的<code>shouldSkip()</code>方法，主要内容如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class ConditionEvaluator {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean shouldSkip(AnnotatedTypeMetadata metadata, ConfigurationCondition.ConfigurationPhase phase) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (metadata == null || !metadata.isAnnotated(Conditional.class.getName())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (phase == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (metadata instanceof AnnotationMetadata &amp;&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ConfigurationClassUtils.isConfigurationCandidate((AnnotationMetadata) metadata)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return shouldSkip(metadata, ConfigurationCondition.ConfigurationPhase.PARSE_CONFIGURATION);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return shouldSkip(metadata, ConfigurationCondition.ConfigurationPhase.REGISTER_BEAN);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Condition&gt; conditions = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String[] conditionClasses : getConditionClasses(metadata)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (String conditionClass : conditionClasses) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Condition condition = getCondition(conditionClass, this.context.getClassLoader());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                conditions.add(condition);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AnnotationAwareOrderComparator.sort(conditions);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Condition condition : conditions) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConfigurationCondition.ConfigurationPhase requiredPhase = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (condition instanceof ConfigurationCondition) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                requiredPhase = ((ConfigurationCondition) condition).getConfigurationPhase();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if ((requiredPhase == null || requiredPhase == phase) &amp;&amp; !condition.matches(this.context, metadata)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>shouldSkip()</code>方法第一行 <em>if</em> 语句就是答案，<code>@Profile</code>注解由<code>@Conditional(ProfileCondition.class)</code>修饰，那如果一个配置类头上没有<code>Condition</code>的身影，直接返回<code>false</code>了，那就是不跳过该配置类的意思喽！</p>
<p><em>Environment</em> 中的这些 <em>PropertySource</em> 究竟有啥用啊？当然是为了填充 <em>Bean</em> 喽，废话不多说，上图。</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/20230416193443.png" alt="" class="img_kGBN"></p>
<blockquote>
<p>笔者以前都是用 visio 和 processOn 画图，第一次体验 draw.io，没想到如此优秀，强烈安利一波！</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_HWLp" id="2-environmnent-初始化流程">2 Environmnent 初始化流程<a href="#2-environmnent-初始化流程" class="hash-link" aria-label="Direct link to 2 Environmnent 初始化流程" title="Direct link to 2 Environmnent 初始化流程">​</a></h2>
<p>本节主要介绍 Spring Boot 在启动过程中向 <em>Environmnt</em> 中究竟注册了哪些 <em>PropertySource</em>。启动入口位于<code>SpringApplication</code>中的<code>run(String... args)</code>方法，如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class SpringApplication {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConfigurableApplicationContext run(String... args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StopWatch stopWatch = new StopWatch();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stopWatch.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefaultBootstrapContext bootstrapContext = createBootstrapContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigurableApplicationContext context = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        configureHeadlessProperty();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SpringApplicationRunListeners listeners = getRunListeners(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        listeners.starting(bootstrapContext, this.mainApplicationClass);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ApplicationArguments applicationArguments = new DefaultApplicationArguments(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConfigurableEnvironment environment = prepareEnvironment(listeners, bootstrapContext, applicationArguments);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            configureIgnoreBeanInfo(environment);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Banner printedBanner = printBanner(environment);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            context = createApplicationContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            context.setApplicationStartup(this.applicationStartup);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            prepareContext(bootstrapContext, context, environment, listeners, applicationArguments, printedBanner);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            refreshContext(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            afterRefresh(context, applicationArguments);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            stopWatch.stop();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (this.logStartupInfo) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new StartupInfoLogger(this.mainApplicationClass).logStarted(getApplicationLog(), stopWatch);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            listeners.started(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            callRunners(context, applicationArguments);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            handleRunFailure(context, ex, listeners);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalStateException(ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            listeners.running(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            handleRunFailure(context, ex, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalStateException(ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可以明显看出，<em>Environmnt</em> 的初始化是在<code>refreshContext(context)</code>之前完成的，这是毫无疑问的。<em>run()</em> 方法很复杂，但与本文主题契合的逻辑只有<strong>一</strong>处：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">prepareEnvironment(listeners, bootstrapContext, applicationArguments);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>下面分别分析这两处核心逻辑。</p>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="21-prepareenvironment">2.1 prepareEnvironment()<a href="#21-prepareenvironment" class="hash-link" aria-label="Direct link to 2.1 prepareEnvironment()" title="Direct link to 2.1 prepareEnvironment()">​</a></h3>
<p>显然，核心内容都在<code>prepareEnvironment()</code>方法内，下面分小节逐一分析。</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class SpringApplication {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ConfigurableEnvironment prepareEnvironment(SpringApplicationRunListeners listeners,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                       DefaultBootstrapContext bootstrapContext,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                       ApplicationArguments applicationArguments) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigurableEnvironment environment = getOrCreateEnvironment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.1.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        configureEnvironment(environment, applicationArguments.getSourceArgs());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.1.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigurationPropertySources.attach(environment);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.1.4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        listeners.environmentPrepared(bootstrapContext, environment);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefaultPropertiesPropertySource.moveToEnd(environment);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bindToSpringApplication(environment);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigurationPropertySources.attach(environment);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return environment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="211-getorcreateenvironment">2.1.1 getOrCreateEnvironment()<a href="#211-getorcreateenvironment" class="hash-link" aria-label="Direct link to 2.1.1 getOrCreateEnvironment()" title="Direct link to 2.1.1 getOrCreateEnvironment()">​</a></h4>
<p><code>getOrCreateEnvironment()</code>主要负责构建 <em>Environment</em> 实例。如果当前应用是基于<code>同步阻塞I/O</code>模型的，则 <em>Environment</em> 选用<code>ApplicationServletEnvironment</code>；相反地，如果当前应用是基于<code>异步非阻塞I/O</code>模型的，则 <em>Environment</em> 选用<code>ApplicationReactiveWebEnvironment</code>。我们工作中基本都是基于 Spring MVC 开发应用，Spring MVC 是一款构建于<code>Servlet API</code>之上、基于同步阻塞 I/O 模型的主流 Java Web 开发框架，这种 I/O 模型意味着一个 HTTP 请求对应一个线程，即每一个 HTTP 请求都是在各自线程上下文中完成处理的。<em>ApplicationServletEnvironment</em> 继承关系如下图所示：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/20230416193515.png" alt="" class="img_kGBN"></p>
<p>从上图可以看出 <em>ApplicationServletEnvironment</em> 家族相当庞大，在执行 <em>ApplicationServletEnvironment</em> 构造方法的时候必然会触发各级父类构造方法中的逻辑，<strong>依次为</strong>：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractEnvironment implements ConfigurableEnvironment {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public AbstractEnvironment() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this(new MutablePropertySources());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected AbstractEnvironment(MutablePropertySources propertySources) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.propertySources = propertySources;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // createPropertyResolver(propertySources)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // |___ ConfigurationPropertySources.createPropertyResolver(propertySources)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //      |___ new ConfigurationPropertySourcesPropertyResolver(propertySources)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.propertyResolver = createPropertyResolver(propertySources);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        customizePropertySources(propertySources);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class StandardServletEnvironment extends StandardEnvironment implements ConfigurableWebEnvironment {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void customizePropertySources(MutablePropertySources propertySources) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        propertySources.addLast(new StubPropertySource(&quot;servletConfigInitParams&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        propertySources.addLast(new StubPropertySource(&quot;servletContextInitParams&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super.customizePropertySources(propertySources);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class StandardEnvironment extends AbstractEnvironment {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void customizePropertySources(MutablePropertySources propertySources) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        propertySources.addLast(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new PropertiesPropertySource(&quot;systemProperties&quot;, (Map) System.getProperties()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        propertySources.addLast(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new SystemEnvironmentPropertySource(&quot;systemEnvironment&quot;, (Map) System.getenv()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>随着 <em>ApplicationServletEnvironment</em> 构造方法的执行，此时在 <em>Environment</em> 里 <em>MutablePropertySources</em> 类型的成员变量<code>propertySources</code>中已经有了<strong>四</strong>个 <em>PropertySource</em> 了，名称依次是：<code>servletConfigInitParams</code>、<code>servletContextInitParams</code>、<code>systemProperties</code>和<code>systemEnvironment</code>。此外，也要记住 <em>ApplicationServletEnvironment</em> 中的两个重要成员变量，即<code>MutablePropertySources</code>和<code>ConfigurationPropertySourcesPropertyResolver</code>。</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="212-configureenvironment">2.1.2 configureEnvironment()<a href="#212-configureenvironment" class="hash-link" aria-label="Direct link to 2.1.2 configureEnvironment()" title="Direct link to 2.1.2 configureEnvironment()">​</a></h4>
<p><code>configureEnvironment()</code>方法中的逻辑也很简单哈。首先，为 <em>Environment</em> 中的 <em>PropertySourcesPropertyResolver</em> 设定 <em>ConversionService</em>；然后，向 <em>Environment</em> 中的 <em>MutablePropertySources</em> 追加一个名称为<code>commandLineArgs</code>的 <em>PropertySource</em> 实例，注意使用的是<code>addFirst()</code>方法哦，这意味着这个名称为<code>commandLineArgs</code>的 <em>PropertySource</em> 优先级是最高的。主要逻辑如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class SpringApplication {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void configureEnvironment(ConfigurableEnvironment environment, String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.addConversionService) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            environment.getPropertyResolver().setConversionService(new ApplicationConversionService());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.addCommandLineProperties &amp;&amp; args.length &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            MutablePropertySources sources = environment.getPropertySources();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sources.addFirst(new SimpleCommandLinePropertySource(args));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>继续<code>SimpleCommandLinePropertySource</code>：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class SimpleCommandLinePropertySource extends CommandLinePropertySource&lt;CommandLineArgs&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SimpleCommandLinePropertySource(String... args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 其父类构造方法为：super(&quot;commandLineArgs&quot;, source)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(new SimpleCommandLineArgsParser().parse(args));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>命令行参数还是比较常用的，比如我们在启动 Spring Boot 应用时会这样声明命令行参数：<code>java -jar app.jar --server.port=8088</code>。</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="213-configurationpropertysourcesattach">2.1.3 ConfigurationPropertySources.attach()<a href="#213-configurationpropertysourcesattach" class="hash-link" aria-label="Direct link to 2.1.3 ConfigurationPropertySources.attach()" title="Direct link to 2.1.3 ConfigurationPropertySources.attach()">​</a></h4>
<p><code>attach()</code>方法主要就是在 <em>Environment</em> 中 <em>MutablePropertySources</em> 的头部位置插入加一个名称为<code>configurationProperties</code>的 <em>PropertySource</em> 实例。主要逻辑如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ConfigurationPropertySources {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void attach(org.springframework.core.env.Environment environment) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MutablePropertySources sources = ((ConfigurableEnvironment) environment).getPropertySources();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PropertySource&lt;?&gt; attached = getAttached(sources);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (attached != null &amp;&amp; attached.getSource() != sources) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sources.remove(ATTACHED_PROPERTY_SOURCE_NAME);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            attached = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (attached == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sources.addFirst(new ConfigurationPropertySourcesPropertySource(&quot;configurationProperties&quot;, new SpringConfigurationPropertySources(sources)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static PropertySource&lt;?&gt; getAttached(MutablePropertySources sources) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (sources != null) ? sources.get(&quot;configurationProperties&quot;) : null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>笔者盯着这玩意儿看了好久，压根没看出这个名称为<code>configurationProperties</code>的 <em>PropertySource</em> 究竟有啥用。最后，还是在官方文档中关于<code>Relaxed Binding</code> (宽松绑定) 的描述中猜出了些端倪。还是通过代码来解读比较直接。首先，在 <em>application.properties</em> 中追加一个配置项：<code>a.b.my-first-key=hello spring environment</code>；然后，通过 <em>Environment</em> 取出这个配置项的值，如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@SpringBootApplication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DemoApplication {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigurableApplicationContext configurableApplicationContext = SpringApplication.run(DemoApplication.class, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigurableWebEnvironment environment = (ConfigurableWebEnvironment)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                configurableApplicationContext.getBean(Environment.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(environment.getProperty(&quot;a.b.my-first-key&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>启动应用后，控制台打印出了 <em>hello spring environment</em> 字样，这与预期是相符的。可当我们通过<code>environment.getProperty(&quot;a.b.myfirstkey&quot;)</code>或者<code>environment.getProperty(&quot;a.b.my-firstkey&quot;)</code>依然能够获取到配置项的内容。<code>a.b.myfirstkey</code>和<code>a.b.my-firstkey</code>并不是配置文件中的属性名称，只是相似而已，这的确很<strong>宽松</strong>啊，哈哈。感兴趣的读者可以自行 DEBUG 看看  其中的原理。</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="214-listenersenvironmentprepared">2.1.4 listeners.environmentPrepared()<a href="#214-listenersenvironmentprepared" class="hash-link" aria-label="Direct link to 2.1.4 listeners.environmentPrepared()" title="Direct link to 2.1.4 listeners.environmentPrepared()">​</a></h4>
<p>敲黑板，各位大佬，这个要考的 ！<code>environmentPrepared()</code>方法会广播一个<code>ApplicationEnvironmentPreparedEvent</code>事件，接着由<code>EnvironmentPostProcessorApplicationListener</code>响应该事件，这应该是典型的<strong>观察者模式</strong>。主要内容如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class SpringApplicationRunListeners {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final List&lt;SpringApplicationRunListener&gt; listeners;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void environmentPrepared(ConfigurableBootstrapContext bootstrapContext, ConfigurableEnvironment environment) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        doWithListeners(&quot;spring.boot.application.environment-prepared&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                (listener) -&gt; listener.environmentPrepared(bootstrapContext, environment));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void doWithListeners(String stepName, Consumer&lt;SpringApplicationRunListener&gt; listenerAction) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StartupStep step = this.applicationStartup.start(stepName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.listeners.forEach(listenerAction);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        step.end();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EventPublishingRunListener implements SpringApplicationRunListener, Ordered {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void environmentPrepared(ConfigurableBootstrapContext bootstrapContext,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    ConfigurableEnvironment environment) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.initialMulticaster.multicastEvent(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new ApplicationEnvironmentPreparedEvent(bootstrapContext, this.application, this.args, environment));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SimpleApplicationEventMulticaster extends AbstractApplicationEventMulticaster {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void multicastEvent(ApplicationEvent event) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        multicastEvent(event, resolveDefaultEventType(event));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void multicastEvent(final ApplicationEvent event, @Nullable ResolvableType eventType) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ResolvableType type = (eventType != null ? eventType : resolveDefaultEventType(event));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Executor executor = getTaskExecutor();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (ApplicationListener&lt;?&gt; listener : getApplicationListeners(event, type)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (executor != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                executor.execute(() -&gt; invokeListener(listener, event));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                invokeListener(listener, event);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>下面来看一下<code>EnvironmentPostProcessorApplicationListener</code>的庐山真面目：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class EnvironmentPostProcessorApplicationListener implements SmartApplicationListener, Ordered {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(ApplicationEvent event) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (event instanceof ApplicationEnvironmentPreparedEvent) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            onApplicationEnvironmentPreparedEvent((ApplicationEnvironmentPreparedEvent) event);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (event instanceof ApplicationPreparedEvent) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            onApplicationPreparedEvent();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (event instanceof ApplicationFailedEvent) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            onApplicationFailedEvent();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void onApplicationEnvironmentPreparedEvent(ApplicationEnvironmentPreparedEvent event) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigurableEnvironment environment = event.getEnvironment();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SpringApplication application = event.getSpringApplication();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (EnvironmentPostProcessor postProcessor : getEnvironmentPostProcessors(application.getResourceLoader(), event.getBootstrapContext())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            postProcessor.postProcessEnvironment(environment, application);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>EnvironmentPostProcessor</code>是 Spring Boot 为 <em>Environment</em> 量身打造的扩展点。这里引用官方文档中比较精炼的一句话：<em>Allows for customization of the application&#x27;s Environment prior to the application context being refreshed</em>。<em>EnvironmentPostProcessor</em> 是一个函数性接口，内容如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public interface EnvironmentPostProcessor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void postProcessEnvironment(ConfigurableEnvironment environment, SpringApplication application);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在上述 <em>EnvironmentPostProcessorApplicationListener</em> 事件处理逻辑中，<code>getEnvironmentPostProcessors</code>负责加载出所有的 <em>EnvironmentPostProcessor</em> 。看一下内部加载逻辑：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public interface EnvironmentPostProcessorsFactory {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static EnvironmentPostProcessorsFactory fromSpringFactories(ClassLoader classLoader) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ReflectionEnvironmentPostProcessorsFactory(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                classLoader, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                SpringFactoriesLoader.loadFactoryNames(EnvironmentPostProcessor.class, classLoader)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>继续进入<code>SpringFactoriesLoader</code>一探究竟：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public final class SpringFactoriesLoader {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static final String FACTORIES_RESOURCE_LOCATION = &quot;META-INF/spring.factories&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static List&lt;String&gt; loadFactoryNames(Class&lt;?&gt; factoryType, ClassLoader classLoader) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ClassLoader classLoaderToUse = classLoader;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (classLoaderToUse == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            classLoaderToUse = SpringFactoriesLoader.class.getClassLoader();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String factoryTypeName = factoryType.getName();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return loadSpringFactories(classLoaderToUse).getOrDefault(factoryTypeName, Collections.emptyList());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static Map&lt;String, List&lt;String&gt;&gt; loadSpringFactories(ClassLoader classLoader) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, List&lt;String&gt;&gt; result = cache.get(classLoader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (result != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        result = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Enumeration&lt;URL&gt; urls = classLoader.getResources(FACTORIES_RESOURCE_LOCATION);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (urls.hasMoreElements()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                URL url = urls.nextElement();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                UrlResource resource = new UrlResource(url);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Properties properties = PropertiesLoaderUtils.loadProperties(resource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (Map.Entry&lt;?, ?&gt; entry : properties.entrySet()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String factoryTypeName = ((String) entry.getKey()).trim();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String[] factoryImplementationNames = StringUtils.commaDelimitedListToStringArray((String) entry.getValue());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    for (String factoryImplementationName : factoryImplementationNames) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        result.computeIfAbsent(factoryTypeName, key -&gt; new ArrayList&lt;&gt;())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                .add(factoryImplementationName.trim());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.replaceAll((factoryType, implementations) -&gt; implementations.stream().distinct()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .collect(Collectors.collectingAndThen(Collectors.toList(), Collections::unmodifiableList)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cache.put(classLoader, result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (IOException ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalArgumentException(&quot;Unable to load factories from location [&quot; + FACTORIES_RESOURCE_LOCATION + &quot;]&quot;, ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p><strong>Spring SPI</strong></p>
<blockquote>
<p><em>SpringFactoriesLoader</em> 这一套逻辑就是 Spring 中的<code>SPI</code>机制；直白点说，就是从<code>classpath</code>下的<code>META-INF/spring.factories</code> 文件中加载 <em>EnvironmentPostProcessor</em> ，如果大家有需求就将自己实现的 <em>EnvironmentPostProcessor</em> 放到该文件中就行了。其实与<code>JDK</code>中的<code>SPI</code>机制很类似哈。</p>
</blockquote>
</blockquote>
<p>在当前版本，Spring Boot 内置了7个 <em>EnvironmentPostProcessor</em> 实现类。接下来挑几个比较典型的分析下。</p>
<p><strong>RandomValuePropertySourceEnvironmentPostProcessor</strong></p>
<p><code>RandomValuePropertySourceEnvironmentPostProcessor</code>向 <em>Environment</em> 中追加了一个名称为<code>random</code>的 <em>PropertySource</em>，即<code>RandomValuePropertySource</code>。内容如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class RandomValuePropertySourceEnvironmentPostProcessor implements EnvironmentPostProcessor, Ordered {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static final int ORDER = Ordered.HIGHEST_PRECEDENCE + 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Log logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public RandomValuePropertySourceEnvironmentPostProcessor(Log logger) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.logger = logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int getOrder() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ORDER;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void postProcessEnvironment(ConfigurableEnvironment environment, SpringApplication application) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RandomValuePropertySource.addToEnvironment(environment, this.logger);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>那么这个 <em>RandomValuePropertySource</em> 有啥作用呢？主要就是用于生成随机数，比如：<code>environment.getProperty(&quot;random.int(5,10)&quot;)</code>可以获取一个随机数。以<code>random.int</code>为属性名可以获取一个 <em>int</em> 类型的随机数；以<code>random.long</code>为属性名可以获取一个 <em>long</em> 类型的随机数；以<code>random.int(5,10)</code>为属性名可以获取一个 <em>[5, 10}</em> 区间内 <em>int</em> 类型的随机数，更多玩法大家自行探索。</p>
<p><em>SystemEnvironmentPropertySourceEnvironmentPostProcessor</em></p>
<p>当前，<em>Environment</em> 中已经存在一个名称为<code>systemEnvironment</code>的 <em>PropertySource</em>，即<code>SystemEnvironmentPropertySource</code>。<code>SystemEnvironmentPropertySourceEnvironmentPostProcessor</code>用于将该 <em>SystemEnvironmentPropertySource</em> 替换为<code>OriginAwareSystemEnvironmentPropertySource</code>，咋有点“脱裤子放屁，多此一举”的感觉呢，哈哈。</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class SystemEnvironmentPropertySourceEnvironmentPostProcessor implements EnvironmentPostProcessor, Ordered {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static final int DEFAULT_ORDER = SpringApplicationJsonEnvironmentPostProcessor.DEFAULT_ORDER - 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int order = DEFAULT_ORDER;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int getOrder() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.order;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void postProcessEnvironment(ConfigurableEnvironment environment, SpringApplication application) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sourceName = &quot;systemEnvironment&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PropertySource&lt;?&gt; propertySource = environment.getPropertySources().get(sourceName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (propertySource != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            replacePropertySource(environment, sourceName, propertySource, application.getEnvironmentPrefix());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void replacePropertySource(ConfigurableEnvironment environment, String sourceName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       PropertySource&lt;?&gt; propertySource, String environmentPrefix) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, Object&gt; originalSource = (Map&lt;String, Object&gt;) propertySource.getSource();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SystemEnvironmentPropertySource source = new OriginAwareSystemEnvironmentPropertySource(sourceName, originalSource, environmentPrefix);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        environment.getPropertySources().replace(sourceName, source);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>SpringApplicationJsonEnvironmentPostProcessor</strong></p>
<p>我们在通过<code>java -jar -Dspring.application.json={&quot;name&quot;:&quot;duxiaotou&quot;} app.jar</code>启动 Spring Boot 应用的时候，该属性会被自动添加到 JVM 系统属性中 (其实 <em>-Dkey=value</em> 这种形式的属性均是如此)，其等效于<code>System.setProperty(key, value)</code>；而当存在<code>SPRING_APPLICATION_JSON</code>这一系统变量时，自然也会在<code>System.getenv()</code>中出现。前面曾经提到过<code>System.getProperties()</code>代表的是<code>systemProperties</code>这一 <em>PropertySource</em>，而<code>System.getenv()</code>则代表的是<code>systemEnvironment</code>这一 <em>PropertySource</em>。<code>SpringApplicationJsonEnvironmentPostProcessor</code>就是用于从这两个 <em>PropertySource</em> 中抽取出 <em>spring.application.json</em> 或 <em>SPRING_APPLICATION_JSON</em> 的 <em>JSON</em> 串，进而单独向 <em>Environment</em> 中追加一个名称为<code>spring.application.json</code>的 <em>PropertySource</em>，即<code>JsonPropertySource</code>。</p>
<p><strong>ConfigDataEnvironmentPostProcessor</strong></p>
<p><code>ConfigDataEnvironmentPostProcessor</code>负责将<code>optional:classpath:/</code>、<code>optional:classpath:/config/</code>、<code>optional:file:./</code>、<code>optional:file:./config/</code>和<code>optional:file:./config/*/</code>这些目  录下的 <em>application.properties</em> 配置文件加载出来；如果还指定了 _spring.profiles.active_的话，同时也会将这些目录下的 <code>_application-{profile}.properties_ </code>配置文件加载出来。最终，<em>ConfigDataEnvironmentPostProcessor</em> 将会向 <em>Environment</em> 中追加两个<code>OriginTrackedMapPropertySource</code>，这俩 <em>PropertySource</em> 位于 <em>Environment</em> 的尾部；其中 <em><code>application-{profile}.properties</code></em> 所代表的 <em>OriginTrackedMapPropertySource</em> 是排在 <em>application.properties</em> 所代表的 <em>OriginTrackedMapPropertySource</em> 前面的，这一点挺重要。</p>
<h2 class="anchor anchorWithStickyNavbar_HWLp" id="3-jasypt-核心原理解读">3 jasypt 核心原理解读<a href="#3-jasypt-核心原理解读" class="hash-link" aria-label="Direct link to 3 jasypt 核心原理解读" title="Direct link to 3 jasypt 核心原理解读">​</a></h2>
<blockquote>
<p><code>jasypt</code>基础组件库与<code>jasypt-spring-boot-starter</code>是不同作者写的，后者只是为 jasypt 组件开发了 Spring Boot 的起步依赖组件而已。本文所分析的其实就是这个起步依赖组件。</p>
</blockquote>
<p><em>application.properties</em> 配置文件中关于数据源的密码是一个加密后的密文，如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">spring.datasource.hikari.password=ENC(4+t9a5QG8NkNdWVS6UjIX3dj18UtYRMqU6eb3wUKjivOiDHFLZC/RTK7HuWWkUtV)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>当<code>HikariDataSource</code>完成属性填充操作后，该 Bean 中 <em>password</em> 字段的值咋就变为解密后的 <em>qwe@1234</em> 这一明文了呢？显然，Spring Boot 为 <em>Environment</em> 提供的<code>EnvironmentPostProcessor</code>这一拓展点可以实现偷天换日！但作者没有用它，而是使用了 Spring 中的一个 <em>IoC 拓展点</em>，即<code>BeanFactoryPostProcessor</code>，这也是完全可以的，因为当执行到 <em>BeanFactoryPostProcessor</em> 中的<code>postProcessBeanFactory()</code>逻辑时，只是完成了所有<code>BeanDefinition</code>的加载，但还没有实例化 <em>BeanDefinition</em> 各自所对应的 Bean。</p>
<p>下面看一下<code>EnableEncryptablePropertiesBeanFactoryPostProcessor</code>中的内容：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class EnableEncryptablePropertiesBeanFactoryPostProcessor implements BeanFactoryPostProcessor, Ordered {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ConfigurableEnvironment environment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final EncryptablePropertySourceConverter converter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public EnableEncryptablePropertiesBeanFactoryPostProcessor(ConfigurableEnvironment environment, EncryptablePropertySourceConverter converter) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.environment = environment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.converter = converter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MutablePropertySources propSources = environment.getPropertySources();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        converter.convertPropertySources(propSources);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int getOrder() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Ordered.LOWEST_PRECEDENCE - 100;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上述源码表明该 <em>BeanFactoryPostProcessor</em> 借助<code>EncryptablePropertySourceConverter</code>对 <em>MutablePropertySources</em> 做了一层转换，那么转换成啥了呢？</p>
<p>接着，跟进 <em>EncryptablePropertySourceConverter</em>，核心内容如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class EncryptablePropertySourceConverter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void convertPropertySources(MutablePropertySources propSources) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        propSources.stream()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(ps -&gt; !(ps instanceof EncryptablePropertySource))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(this::makeEncryptable)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(toList())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .forEach(ps -&gt; propSources.replace(ps.getName(), ps));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public &lt;T&gt; PropertySource&lt;T&gt; makeEncryptable(PropertySource&lt;T&gt; propertySource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (propertySource instanceof EncryptablePropertySource </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                || skipPropertySourceClasses.stream().anyMatch(skipClass -&gt; skipClass.equals(propertySource.getClass()))) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return propertySource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PropertySource&lt;T&gt; encryptablePropertySource = convertPropertySource(propertySource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return encryptablePropertySource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; PropertySource&lt;T&gt; convertPropertySource(PropertySource&lt;T&gt; propertySource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PropertySource&lt;T&gt; encryptablePropertySource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (propertySource instanceof SystemEnvironmentPropertySource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            encryptablePropertySource = (PropertySource&lt;T&gt;) new EncryptableSystemEnvironmentPropertySourceWrapper((SystemEnvironmentPropertySource) propertySource, propertyResolver, propertyFilter);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (propertySource instanceof MapPropertySource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            encryptablePropertySource = (PropertySource&lt;T&gt;) new EncryptableMapPropertySourceWrapper((MapPropertySource) propertySource, propertyResolver, propertyFilter);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (propertySource instanceof EnumerablePropertySource) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            encryptablePropertySource = new EncryptableEnumerablePropertySourceWrapper&lt;&gt;((EnumerablePropertySource) propertySource, propertyResolver, propertyFilter);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            encryptablePropertySource = new EncryptablePropertySourceWrapper&lt;&gt;(propertySource, propertyResolver, propertyFilter);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return encryptablePropertySource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>显然，它将相关原生 <em>PropertySource</em> 转换为了一个<code>EncryptablePropertySourceWrapper</code>，那这个肯定可以实现密文解密，必须的！</p>
<p>继续，跟进<code>EncryptablePropertySourceWrapper</code>，内容如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class EncryptablePropertySourceWrapper&lt;T&gt; extends PropertySource&lt;T&gt; implements EncryptablePropertySource&lt;T&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final CachingDelegateEncryptablePropertySource&lt;T&gt; encryptableDelegate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public EncryptablePropertySourceWrapper(PropertySource&lt;T&gt; delegate, EncryptablePropertyResolver resolver, EncryptablePropertyFilter filter) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(delegate.getName(), delegate.getSource());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        encryptableDelegate = new CachingDelegateEncryptablePropertySource&lt;&gt;(delegate, resolver, filter);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object getProperty(String name) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return encryptableDelegate.getProperty(name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public PropertySource&lt;T&gt; getDelegate() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return encryptableDelegate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>失望！没看出啥解密逻辑，但从其 <em>getProperty</em> 方法来看，将具体解析逻辑委派给了<code>CachingDelegateEncryptablePropertySource</code>。</p>
<p>没办法，只能到 <em>CachingDelegateEncryptablePropertySource</em> 中一探究竟了：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class CachingDelegateEncryptablePropertySource&lt;T&gt; extends PropertySource&lt;T&gt; implements EncryptablePropertySource&lt;T&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final PropertySource&lt;T&gt; delegate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final EncryptablePropertyResolver resolver;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final EncryptablePropertyFilter filter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Map&lt;String, Object&gt; cache;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public CachingDelegateEncryptablePropertySource(PropertySource&lt;T&gt; delegate, EncryptablePropertyResolver resolver, EncryptablePropertyFilter filter) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(delegate.getName(), delegate.getSource());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.delegate = delegate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.resolver = resolver;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.filter = filter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.cache = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public PropertySource&lt;T&gt; getDelegate() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return delegate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object getProperty(String name) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (cache.containsKey(name)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return cache.get(name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (name.intern()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!cache.containsKey(name)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Object resolved = getProperty(resolver, filter, delegate, name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (resolved != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    cache.put(name, resolved);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return cache.get(name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>终于，跟进到<code>EncryptablePropertySource</code>中看到了解密的最终逻辑。其中，<code>EncryptablePropertyDetector</code>负责探测相关属性是否需要对其解密，主要通过判断该属性值是否由<code>ENC()</code>包裹。</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public interface EncryptablePropertySource&lt;T&gt; extends OriginLookup&lt;String&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default Object getProperty(EncryptablePropertyResolver resolver, EncryptablePropertyFilter filter, PropertySource&lt;T&gt; source, String name) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object value = source.getProperty(name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (value != null &amp;&amp; filter.shouldInclude(source, name) &amp;&amp; value instanceof String) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String stringValue = String.valueOf(value);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return resolver.resolvePropertyValue(stringValue);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DefaultPropertyResolver implements EncryptablePropertyResolver {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Environment environment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private StringEncryptor encryptor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private EncryptablePropertyDetector detector;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String resolvePropertyValue(String value) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Optional.ofNullable(value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(environment::resolvePlaceholders)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(detector::isEncrypted)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(resolvedValue -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        String unwrappedProperty = detector.unwrapEncryptedValue(resolvedValue.trim());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        String resolvedProperty = environment.resolvePlaceholders(unwrappedProperty);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        return encryptor.decrypt(resolvedProperty);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (EncryptionOperationNotPossibleException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        throw new DecryptionException(&quot;Unable to decrypt property: &quot; + value + &quot; resolved to: &quot; + resolvedValue + &quot;. Decryption of Properties failed,  make sure encryption/decryption &quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                &quot;passwords match&quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .orElse(value);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">复制代码</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_HWLp" id="4-总结">4 总结<a href="#4-总结" class="hash-link" aria-label="Direct link to 4 总结" title="Direct link to 4 总结">​</a></h2>
<p>总结性的文字就不再说了，笔者现在文思泉涌，否则又能水300字。最后，希望大家记住在当前 Spring Boot 版本中，由<code>ApplicationServletEnvironment</code>扮演 <em>Environment</em>，其最终将委派<code>ConfigurationPropertySourcesPropertyResolver</code>去获取属性值。</p>
<p>作者：程序猿杜小头
链接：<a href="https://juejin.cn/post/7098299623759937543" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/7098299623759937543</a>
来源：稀土掘金
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>
<h1>参考文章</h1>
<p><a href="https://www.w3cschool.cn/wkspring" target="_blank" rel="noopener noreferrer">https://www.w3cschool.cn/wkspring</a>
<a href="https://www.runoob.com/w3cnote/basic-knowledge-summary-of-spring.html" target="_blank" rel="noopener noreferrer">https://www.runoob.com/w3cnote/basic-knowledge-summary-of-spring.html</a>
<a href="http://codepub.cn/2015/06/21/Basic-knowledge-summary-of-Spring" target="_blank" rel="noopener noreferrer">http://codepub.cn/2015/06/21/Basic-knowledge-summary-of-Spring</a>
<a href="https://dunwu.github.io/spring-tutorial" target="_blank" rel="noopener noreferrer">https://dunwu.github.io/spring-tutorial</a>
<a href="https://mszlu.com/java/spring" target="_blank" rel="noopener noreferrer">https://mszlu.com/java/spring</a>
<a href="http://c.biancheng.net/spring/aop-module.html" target="_blank" rel="noopener noreferrer">http://c.biancheng.net/spring/aop-module.html</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Spring全家桶/Spring/Spring中的Environment环境变量.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_EYjg" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_eevz"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/code-note-blog/docs/Spring全家桶/Spring/Spring中的资源管理"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Spring中的资源管理</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/code-note-blog/docs/Spring全家桶/Spring/Spring中对于数据库的访问"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Spring中对于数据库的访问</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_lc2k thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-认识-environmnent" class="table-of-contents__link toc-highlight">1 认识 Environmnent</a></li><li><a href="#2-environmnent-初始化流程" class="table-of-contents__link toc-highlight">2 Environmnent 初始化流程</a><ul><li><a href="#21-prepareenvironment" class="table-of-contents__link toc-highlight">2.1 prepareEnvironment()</a></li></ul></li><li><a href="#3-jasypt-核心原理解读" class="table-of-contents__link toc-highlight">3 jasypt 核心原理解读</a></li><li><a href="#4-总结" class="table-of-contents__link toc-highlight">4 总结</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/code-note-blog/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/code-note-blog/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>