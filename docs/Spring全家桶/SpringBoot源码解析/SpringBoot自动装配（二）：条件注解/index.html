<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Spring全家桶/SpringBoot源码解析/SpringBoot自动装配（二）：条件注解" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.0">
<title data-rh="true">SpringBoot自动装配（二）：条件注解 | Tommy</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aiden-coding.github.io/code-note-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://aiden-coding.github.io/code-note-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBoot自动装配（二）：条件注解"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="SpringBoot自动装配（二）：条件注解 | Tommy"><meta data-rh="true" name="description" content="1\. 条件注解及其判断类"><meta data-rh="true" property="og:description" content="1\. 条件注解及其判断类"><link data-rh="true" rel="icon" href="/code-note-blog/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBoot自动装配（二）：条件注解"><link data-rh="true" rel="alternate" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBoot自动装配（二）：条件注解" hreflang="en"><link data-rh="true" rel="alternate" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBoot自动装配（二）：条件注解" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/code-note-blog/blog/rss.xml" title="Tommy RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/code-note-blog/blog/atom.xml" title="Tommy Atom Feed"><link rel="stylesheet" href="/code-note-blog/assets/css/styles.dd5372db.css">
<script src="/code-note-blog/assets/js/runtime~main.f999fb27.js" defer="defer"></script>
<script src="/code-note-blog/assets/js/main.a0bfbaed.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_XYiV" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/code-note-blog/"><b class="navbar__title text--truncate">Tommy</b></a><a class="navbar__item navbar__link" href="/code-note-blog/docs/Java/basic/抽象类和接口">java</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/JavaWeb/走进JavaWeb技术世界：JavaWeb的由来和基础知识">javaweb</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/cache/探索Redis设计与实现：连接底层与表面的数据结构robj">cache</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/backend/后端技术杂谈：白话虚拟化技术">backend</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/cs/algorithms/剑指offer">cs</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/database/重新学习MySQL数据库：『浅入浅出』MySQL和InnoDB">database</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/distributed/basic/分布式系统理论基础 ：CAP">distributed</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/interview/BATJ-Experience/面阿里,终获offer">interview</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/mq/kafka/消息队列kafka详解：如何实现死信队列">mq</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/code-note-blog/docs/Spring全家桶/Spring/第一个Spring应用">spring</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/mianshi/collection">面试</a><a href="https://aiden-coding.github.io/code-note-blog/SpringCloud%E7%AC%AC3%E5%AD%A32024.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="toggle_XbAW colorModeToggle_r5NY"><button class="clean-btn toggleButton_Jx0n toggleButtonDisabled_zYO7" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_FjAw"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_qmEt"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_wJfS"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_LABv"><div class="docsWrapper_pdvB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_Jioa" type="button"></button><div class="docRoot_qx_v"><aside class="theme-doc-sidebar-container docSidebarContainer_NHKT"><div class="sidebarViewport_uyYB"><div class="sidebar_SZG4"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_VP_k"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/Spring/第一个Spring应用">Spring</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：初探SpringIOC核心流程">Spring源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringBoot/给你一份SpringBoot知识清单">SpringBoot</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBoot启动流程（四）：启动IOC容器">SpringBoot源码解析</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBoot启动流程（四）：启动IOC容器">SpringBoot启动流程（四）：启动IOC容器</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/@SpringBootApplication注解">@SpringBootApplication注解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBoot启动流程（二）：准备运行环境">SpringBoot启动流程（二）：准备运行环境</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBoot启动流程（六）：启动流程总结">SpringBoot启动流程（六）：启动流程总结</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringBoot  源码解析/SpringBoot启动流程（三）：准备IOC容器">SpringBoot启动流程（三）：准备IOC容器</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBoot启动流程（五）：完成启动">SpringBoot启动流程（五）：完成启动</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBoot启动流程（一）：准备SpringApplication">SpringBoot启动流程（一）：准备SpringApplication</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBoot自动装配（二）：条件注解">SpringBoot自动装配（二）：条件注解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBoot自动装配（三）：自动装配顺序">SpringBoot自动装配（三）：自动装配顺序</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBoot自动装配（一）：加载自动装配类">SpringBoot自动装配（一）：加载自动装配类</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBootWeb应用（二）：WebMvc装配过程">SpringBootWeb应用（二）：WebMvc装配过程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBootWeb应用（一）：servlet组件的注册流程">SpringBootWeb应用（一）：servlet组件的注册流程</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloud/SpringCloudConsul">SpringCloud</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudConfig源码分析">SpringCloud源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba/SpringCloudAlibaba概览">SpringCloudAlibaba</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba源码分析/SpringCloudAlibabaNacos源码分析：服务发现">SpringCloudAlibaba源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringMVC/SpringMVC常见注解">SpringMVC</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/请求执行流程（二）之执行Handler方法">SpringMVC源码分析</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_SejT"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_j3Yw"><div class="docItemContainer_XOSC"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_F6gm" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/code-note-blog/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YCxa"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">SpringBoot源码解析</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">SpringBoot自动装配（二）：条件注解</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ToOY theme-doc-toc-mobile tocMobile_suYB"><button type="button" class="clean-btn tocCollapsibleButton_VzP_">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>SpringBoot自动装配（二）：条件注解</h1></header><h3 class="anchor anchorWithStickyNavbar_HWLp" id="1-条件注解及其判断类">1. 条件注解及其判断类<a href="#1-条件注解及其判断类" class="hash-link" aria-label="Direct link to 1. 条件注解及其判断类" title="Direct link to 1. 条件注解及其判断类">​</a></h3>
<p>在 <a href="https://my.oschina.net/funcy/blog/4870868" target="_blank" rel="noopener noreferrer">springboot 自动装配之加载自动装配类</a>一文中，我们分析到 springboot 会加载 <code>META-INF/spring.factories</code> 文件中定义的自动装配类，加载到这些自动装配类后，这些类中的 bean 就一定会初始化吗？并不是，我们可以在对应的 Bean 生成方法上使用<strong>条件注解</strong>来控制类是否进行初始化！</p>
<p>springboot 提供的条件注解如下：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-0e8d27c887fb6ca142672cad1c60e9de207.png" alt="" class="img_kGBN"></p>
<p>这里列举部分如下：</p>
<table><thead><tr><th>注解类型</th><th>注解类型</th><th>功能说明</th></tr></thead><tbody><tr><td>class 条件注解</td><td><code>@ConditionalOnClass</code>/<code>@ConditionalOnMissingClass</code></td><td>当指定的类<strong>存在 / 缺失</strong>时初始化该 bean</td></tr><tr><td>bean 条件注解</td><td><code>@ConditionalOnBean</code>/<code>@ConditionalOnMissingBean</code></td><td>当指定的 bean <strong>存在 / 缺失</strong>时初始化该 bean</td></tr><tr><td>属性条件注解</td><td><code>@ConditionalOnProperty</code></td><td>当指定的属性存在初始化该 bean</td></tr><tr><td>Resource 条件注解</td><td><code>@ConditionalOnResource</code></td><td>当指定的资源存在初始化该 bean</td></tr><tr><td>Web 应用条件注解</td><td><code>@ConditionalOnWebApplication</code> / <code>@ConditionalOnNotWebApplication</code></td><td>当前应用<strong>为 / 不为</strong> web 应用时初始化该 bean</td></tr><tr><td>spring 表达式条件注解</td><td><code>@ConditionalOnExpression</code></td><td>当表达式结果为 true 时初始化该 bean</td></tr></tbody></table>
<p>我们进入 <code>@ConditionalOnClass</code> 看看该注解的内容：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Conditional(OnClassCondition.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface ConditionalOnClass {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可以看到，<code>ConditionalOnClass</code> 组合了 <code>@Conditional</code> 注解的功能，处理类是 <code>OnClassCondition.class</code>。</p>
<p>关于 <code>@Conditional</code> 注解可以参考 <a href="https://my.oschina.net/funcy/blog/4873444" target="_blank" rel="noopener noreferrer">ConfigurationClassPostProcessor 之处理 @Conditional 注解</a>，这里我们直接说 <code>@Conditional</code> 的使用方式：</p>
<ol>
<li>
<p><code>@Conditional</code> 是 spring 处理的条件注解；</p>
</li>
<li>
<p><code>@Conditional</code> 提供了一个属性 <code>value</code>，类型为 <code>Class</code>，其必须是 <code>Condition</code> 的子类：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">Class&lt;? extends Condition&gt;[] value();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p><code>Condition</code> 是一个接口，其中有一个 <code>matches(...)</code> 方法：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public interface Condition {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>只有在 <code>matches(...)</code> 方法返回 <code>true</code> 时，<code>ConfigurationClassPostProcessor</code> 才会将其对应的 bean 注册到 <code>beanFactory</code> 的 <code>beanDefinitionMap</code> 中.</p>
</li>
</ol>
<p>总结完 <code>@Conditional</code> 的使用方式后，我们就明白了：<code>OnClassCondition.class</code> 是 <code>Condition</code> 的子类，其 <code>matches(...)</code> 方法用来处理主要条件规则。同理，其他条件注解的处理方式也类似，这里总结下条件注解的判断类：</p>
<table><thead><tr><th>注解类型</th><th>注解类型</th><th>条件判断类</th></tr></thead><tbody><tr><td>class 条件注解</td><td><code>@ConditionalOnClass</code>/<code>@ConditionalOnMissingClass</code></td><td><code>OnClassCondition</code></td></tr><tr><td>bean 条件注解</td><td><code>@ConditionalOnBean</code>/<code>@ConditionalOnMissingBean</code></td><td><code>OnBeanCondition</code></td></tr><tr><td>属性条件注解</td><td><code>@ConditionalOnProperty</code></td><td><code>OnPropertyCondition</code></td></tr><tr><td>Resource 条件注解</td><td><code>@ConditionalOnResource</code></td><td><code>OnResourceCondition</code></td></tr><tr><td>Web 应用条件注解</td><td><code>@ConditionalOnWebApplication</code> / <code>@ConditionalOnNotWebApplication</code></td><td><code>OnWebApplicationCondition</code></td></tr><tr><td>spring 表达式条件注解</td><td><code>@ConditionalOnExpression</code></td><td><code>OnExpressionCondition</code></td></tr></tbody></table>
<p>接下来，分析目的就很明确了：要分析这些条件注解的判断逻辑，只需要分析对应条件判断类的 <code>matches(...)</code> 方法就可以了。</p>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="2-springbootconditionmatches">2. <code>SpringBootCondition#matches</code><a href="#2-springbootconditionmatches" class="hash-link" aria-label="Direct link to 2-springbootconditionmatches" title="Direct link to 2-springbootconditionmatches">​</a></h3>
<p>进入 <code>OnClassCondition#matches</code> 方法，发现来到的是 <code>SpringBootCondition</code>，相关方法如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class SpringBootCondition implements Condition {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Log logger = LogFactory.getLog(getClass());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public final boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String classOrMethodName = getClassOrMethodName(metadata);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 获取条件匹配结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConditionOutcome outcome = getMatchOutcome(context, metadata);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 打印一条日志</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logOutcome(classOrMethodName, outcome);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 记录条件评估的发生，简单理解为记录一条条件判断记录吧</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            recordEvaluation(context, classOrMethodName, outcome);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 这里返回最终结果：true 或 false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return outcome.isMatch();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        catch (NoClassDefFoundError ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalStateException(...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        catch (RuntimeException ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalStateException(...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 这是个抽象方式，具体内容由子类实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public abstract ConditionOutcome getMatchOutcome(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConditionContext context, AnnotatedTypeMetadata metadata);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>SpringBootCondition</code> 的 <code>matches(...)</code> 关键就两行：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ConditionOutcome outcome = getMatchOutcome(context, metadata);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return outcome.isMatch();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>而 <code>SpringBootCondition</code> 的 <code>getMatchOutcome(...)</code> 又是个抽象方法，具体的逻辑由子类提供，<code>OnClassCondition</code> 它的实现之一。实际上，上述条件判断类都是 <code>SpringBootCondition</code> 的子类，后面我们就直接进入具体类的 <code>getMatchOutcome(...)</code> 方法分析了。</p>
<p><code>getMatchOutcome(...)</code> 方法返回的结果是 <code>ConditionOutcome</code>，接下来我们来看看 <code>ConditionOutcome</code> 是个啥：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class ConditionOutcome {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final boolean match;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ConditionMessage message;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 构造方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConditionOutcome(boolean match, String message) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this(match, ConditionMessage.of(message));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 构造方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConditionOutcome(boolean match, ConditionMessage message) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assert.notNull(message, &quot;ConditionMessage must not be null&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.match = match;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.message = message;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 返回匹配的结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean isMatch() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.match;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>从代码来看，这个类就是用来封装比较结果的，内部有两个属性：<code>match</code> 与 <code>message</code>:</p>
<ul>
<li><code>match</code> 的类型是 <code>boolean</code>，这个就是最终匹配成功还是失败的标识</li>
<li><code>message</code> 的类型是 <code>ConditionMessage</code>，它表示匹配结果的说明</li>
</ul>
<p>我们再来看看 <code>ConditionMessage</code>:</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ConditionMessage {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String message;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ConditionMessage() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this(null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ConditionMessage(String message) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.message = message;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>它仅有一个属性：<code>message</code>，这表明它就是对说明信息的包装。</p>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="3-conditionalonclass-onclassconditiongetmatchoutcome">3. <code>@ConditionalOnClass</code>: <code>OnClassCondition#getMatchOutcome</code><a href="#3-conditionalonclass-onclassconditiongetmatchoutcome" class="hash-link" aria-label="Direct link to 3-conditionalonclass-onclassconditiongetmatchoutcome" title="Direct link to 3-conditionalonclass-onclassconditiongetmatchoutcome">​</a></h3>
<p>接下来我们来分析 <code>OnClassCondition</code> 的匹配逻辑，直接进入 <code>getMatchOutcome</code> 方法：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public ConditionOutcome getMatchOutcome(ConditionContext context, AnnotatedTypeMetadata metadata) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClassLoader classLoader = context.getClassLoader();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConditionMessage matchMessage = ConditionMessage.empty();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1\. 处理 @ConditionalOnClass 注解</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;String&gt; onClasses = getCandidates(metadata, ConditionalOnClass.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (onClasses != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1.1 处理条件判断</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;String&gt; missing = filter(onClasses, ClassNameFilter.MISSING, classLoader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!missing.isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 1.2 构建返回结果：不匹配的情况</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return ConditionOutcome.noMatch(ConditionMessage.forCondition(ConditionalOnClass.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .didNotFind(&quot;required class&quot;, &quot;required classes&quot;).items(Style.QUOTE, missing));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        matchMessage = matchMessage.andCondition(ConditionalOnClass.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .found(&quot;required class&quot;, &quot;required classes&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .items(Style.QUOTE, filter(onClasses, ClassNameFilter.PRESENT, classLoader));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 2\. 处理 @ConditionalOnMissingClass 注解</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;String&gt; onMissingClasses = getCandidates(metadata, ConditionalOnMissingClass.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (onMissingClasses != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.1 处理条件判断</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;String&gt; present = filter(onMissingClasses, ClassNameFilter.PRESENT, classLoader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!present.isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2.2 构建返回结果：不匹配的情况</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return ConditionOutcome.noMatch(ConditionMessage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .forCondition(ConditionalOnMissingClass.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .found(&quot;unwanted class&quot;, &quot;unwanted classes&quot;).items(Style.QUOTE, present));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        matchMessage = matchMessage.andCondition(ConditionalOnMissingClass.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .didNotFind(&quot;unwanted class&quot;, &quot;unwanted classes&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .items(Style.QUOTE, filter(onMissingClasses, ClassNameFilter.MISSING, classLoader));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 最后返回匹配的结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ConditionOutcome.match(matchMessage);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个方法同时处理了 <code>@ConditionalOnClass</code> 与 <code>@ConditionalOnMissingClass</code> 两个注解，处理流程极其相似，两个注解的条件判断都是通过 <code>FilteringSpringBootCondition#filter</code> 内容如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected final List&lt;String&gt; filter(Collection&lt;String&gt; classNames, ClassNameFilter classNameFilter,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ClassLoader classLoader) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (CollectionUtils.isEmpty(classNames)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Collections.emptyList();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;String&gt; matches = new ArrayList&lt;&gt;(classNames.size());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (String candidate : classNames) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 进行条件匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (classNameFilter.matches(candidate, classLoader)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            matches.add(candidate);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return matches;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>由此可见，传入的 <code>classNameFilter</code> 成了关键：</p>
<ul>
<li>处理 <code>@ConditionalOnClass</code> 时，<code>classNameFilter</code> 为 <code>ClassNameFilter.MISSING</code></li>
<li>处理 <code>@ConditionalOnMissingClass</code> 时，<code>classNameFilter</code> 为 <code>ClassNameFilter.PRESENT</code></li>
</ul>
<p>让我们进入 <code>ClassNameFilter</code> 一探究竟，它是 <code>FilteringSpringBootCondition</code> 的子类，内容如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">abstract class FilteringSpringBootCondition extends SpringBootCondition</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        implements AutoConfigurationImportFilter, BeanFactoryAware, BeanClassLoaderAware {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 如果 classLoader 存在，则调用 ClassLoader#loadClass 方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 否则调用 Class#forName 方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected static Class&lt;?&gt; resolve(String className, ClassLoader classLoader) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throws ClassNotFoundException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (classLoader != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return classLoader.loadClass(className);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Class.forName(className);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 处理条件匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected enum ClassNameFilter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PRESENT {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public boolean matches(String className, ClassLoader classLoader) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return isPresent(className, classLoader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MISSING {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public boolean matches(String className, ClassLoader classLoader) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return !isPresent(className, classLoader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        abstract boolean matches(String className, ClassLoader classLoader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Class 是否存在</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         * 通过捕获类加载时的异常来判断类是否存在，未抛出异常则表示类存在</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        static boolean isPresent(String className, ClassLoader classLoader) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (classLoader == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                classLoader = ClassUtils.getDefaultClassLoader();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 通过异常捕获来判断是否存在该class</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                resolve(className, classLoader);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            catch (Throwable ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>看到这里我们就明白了：判断 <code>Class</code> 是否存在，spring 是通过捕获 <code>ClassLoader.load(String)</code> 或 <code>Class.forName(String)</code> 方法的异常来处理的，如果抛出了异常就表明 <code>Class</code> 不存在。</p>
<p>这里总结下 <code>@ConditionalOnClass</code>/<code>@ConditionalOnMissingClass</code> 的处理方式：<strong>两者的处理类都为 <code>OnClassCondition</code>，通过捕获 <code>ClassLoader.load(String)</code> 或 <code>Class.forName(String)</code> 方法的异常来判断 <code>Class</code> 是否存在，如果抛出了异常就表明 <code>Class</code> 不存在</strong>。</p>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="4-conditionalonbean-onbeanconditiongetmatchoutcome">4. <code>@ConditionalOnBean</code>: <code>OnBeanCondition#getMatchOutcome</code><a href="#4-conditionalonbean-onbeanconditiongetmatchoutcome" class="hash-link" aria-label="Direct link to 4-conditionalonbean-onbeanconditiongetmatchoutcome" title="Direct link to 4-conditionalonbean-onbeanconditiongetmatchoutcome">​</a></h3>
<p>继续看看 <code>@ConditionalOnBean</code> 的 处理，直接进入 <code>OnBeanCondition#getMatchOutcome</code>：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public ConditionOutcome getMatchOutcome(ConditionContext context, AnnotatedTypeMetadata metadata) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConditionMessage matchMessage = ConditionMessage.empty();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MergedAnnotations annotations = metadata.getAnnotations();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 处理 @ConditionalOnBean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (annotations.isPresent(ConditionalOnBean.class)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Spec&lt;ConditionalOnBean&gt; spec = new Spec&lt;&gt;(context, metadata, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                annotations, ConditionalOnBean.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MatchResult matchResult = getMatchingBeans(context, spec);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 注意判断条件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!matchResult.isAllMatched()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String reason = createOnBeanNoMatchReason(matchResult);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return ConditionOutcome.noMatch(spec.message().because(reason));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        matchMessage = spec.message(matchMessage).found(&quot;bean&quot;, &quot;beans&quot;).items(Style.QUOTE,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                matchResult.getNamesOfAllMatches());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 处理 @ConditionalOnSingleCandidate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (metadata.isAnnotated(ConditionalOnSingleCandidate.class.getName())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Spec&lt;ConditionalOnSingleCandidate&gt; spec </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                = new SingleCandidateSpec(context, metadata, annotations);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MatchResult matchResult = getMatchingBeans(context, spec);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 注意判断条件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!matchResult.isAllMatched()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return ConditionOutcome.noMatch(spec.message().didNotFind(&quot;any beans&quot;).atAll());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else if (!hasSingleAutowireCandidate(context.getBeanFactory(), </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                matchResult.getNamesOfAllMatches(), spec.getStrategy() == SearchStrategy.ALL)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return ConditionOutcome.noMatch(spec.message().didNotFind(&quot;a primary bean from beans&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .items(Style.QUOTE, matchResult.getNamesOfAllMatches()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        matchMessage = spec.message(matchMessage).found(&quot;a primary bean from beans&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .items(Style.QUOTE, matchResult.getNamesOfAllMatches());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 处理 @ConditionalOnMissingBean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (metadata.isAnnotated(ConditionalOnMissingBean.class.getName())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Spec&lt;ConditionalOnMissingBean&gt; spec = new Spec&lt;&gt;(context, metadata, annotations,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ConditionalOnMissingBean.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MatchResult matchResult = getMatchingBeans(context, spec);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 注意判断条件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (matchResult.isAnyMatched()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String reason = createOnMissingBeanNoMatchReason(matchResult);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return ConditionOutcome.noMatch(spec.message().because(reason));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        matchMessage = spec.message(matchMessage).didNotFind(&quot;any beans&quot;).atAll();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ConditionOutcome.match(matchMessage);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可以看到，这个方法一共处理了两个注解的条件匹配：<code>@ConditionalOnBean</code>、<code>@ConditionalOnSingleCandidate</code> 与 <code>@ConditionalOnMissingBean</code>，三者都调用了同一个方法 <code>getMatchingBeans(...)</code> 来获取匹配结果，然后使用 <code>matchResult.isAllMatched()</code> 或 <code>matchResult.isAnyMatched()</code> 来做最终的结果判断。</p>
<h4 class="anchor anchorWithStickyNavbar_HWLp" id="onbeanconditiongetmatchingbeans"><code>OnBeanCondition#getMatchingBeans</code><a href="#onbeanconditiongetmatchingbeans" class="hash-link" aria-label="Direct link to onbeanconditiongetmatchingbeans" title="Direct link to onbeanconditiongetmatchingbeans">​</a></h4>
<p><code>getMatchingBeans(...)</code> 的代码如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected final MatchResult getMatchingBeans(ConditionContext context, Spec&lt;?&gt; spec) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClassLoader classLoader = context.getClassLoader();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConfigurableListableBeanFactory beanFactory = context.getBeanFactory();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean considerHierarchy = spec.getStrategy() != SearchStrategy.CURRENT;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Set&lt;Class&lt;?&gt;&gt; parameterizedContainers = spec.getParameterizedContainers();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (spec.getStrategy() == SearchStrategy.ANCESTORS) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        BeanFactory parent = beanFactory.getParentBeanFactory();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assert.isInstanceOf(ConfigurableListableBeanFactory.class, parent,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;Unable to use SearchStrategy.ANCESTORS&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        beanFactory = (ConfigurableListableBeanFactory) parent;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MatchResult result = new MatchResult();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1\. 获取 ignoreType，只有 @ConditionalOnMissingBean 有这个属性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Set&lt;String&gt; beansIgnoredByType = getNamesOfBeansIgnoredByType(classLoader, beanFactory, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            considerHierarchy, spec.getIgnoredTypes(), parameterizedContainers);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 2\. 处理 types</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (String type : spec.getTypes()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collection&lt;String&gt; typeMatches = getBeanNamesForType(classLoader, considerHierarchy, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                beanFactory, type, parameterizedContainers);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        typeMatches.removeAll(beansIgnoredByType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (typeMatches.isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.recordUnmatchedType(type);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.recordMatchedType(type, typeMatches);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 3\. 处理类上的注解 @ConditionalOnMissingBean 有这个属性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (String annotation : spec.getAnnotations()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Set&lt;String&gt; annotationMatches = getBeanNamesForAnnotation(classLoader, beanFactory, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                annotation, considerHierarchy);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        annotationMatches.removeAll(beansIgnoredByType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (annotationMatches.isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.recordUnmatchedAnnotation(annotation);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.recordMatchedAnnotation(annotation, annotationMatches);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 4\. 处理 beanName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (String beanName : spec.getNames()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!beansIgnoredByType.contains(beanName) &amp;&amp; containsBean(beanFactory, beanName, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                considerHierarchy)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.recordMatchedName(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.recordUnmatchedName(beanName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>需要说明的是，这个方法会处理 3 个注解的匹配规则：<code>@ConditionalOnBean</code>、<code>@ConditionalOnSingleCandidate</code> 与 <code>@ConditionalOnMissingBean</code>，处理步骤如下：</p>
<ol>
<li>获取 <code>ignoreType</code>，只有 <code>@ConditionalOnMissingBean</code> 有这个属性</li>
<li>处理 <code>types</code> 的匹配规则</li>
<li>处理注解（类上的注解）的匹配规则， 只有 <code>@ConditionalOnMissingBean</code> 有这个属性</li>
<li>处理 <code>beanName</code> 的匹配规则</li>
</ol>
<p>关于以上步骤的具体细节，本文就不具体展开了，这里仅提供流程：</p>
<ol>
<li>获取 <code>ignoreType</code>：<!-- -->
<ol>
<li>使用 <code>ListableBeanFactory#getBeanNamesForType(Class, boolean, boolean)</code> 方法获取容器中所有的 <code>ignoreType</code> 的 <code>beanName</code></li>
<li>结果为 <code>beansIgnoredByType</code>(类型是 <code>Set&lt;String&gt;</code>)</li>
</ol>
</li>
<li>处理 <code>types</code> 的匹配规则<!-- -->
<ol>
<li>使用 <code>ListableBeanFactory#getBeanNamesForType(Class, boolean, boolean)</code> 方法获取容器中所有的 <code>type</code> 对应的 <code>beanName</code>，结果为 <code>typeMatches</code></li>
<li>将 <code>typeMatches</code> 中的值去除 <code>ignoreType</code></li>
<li>判断第二步得到的 <code>typeMatches</code>，如果内容为空，将当前 <code>Type</code> 保存到 <code>unmatchedTypes</code> 中，否则保存到 <code>matchedTypes</code> 与 <code>namesOfAllMatches</code> 中</li>
</ol>
</li>
<li>处理注解的匹配规则<!-- -->
<ol>
<li>使用 <code>ListableBeanFactory#getBeanNamesForAnnotation</code> 方法获取容器中所有的 <code>annotation</code> 对应的 <code>beanName</code>，结果为 <code>annotationMatches</code></li>
<li>将 <code>annotationMatches</code> 中的值去除 <code>ignoreType</code></li>
<li>判断第二步得到的 <code>annotationMatches</code>，如果内容为空，将当前 <code>Annotation</code> 保存到 <code>unmatchedAnnotations</code> 中，否则保存到 <code>matchedAnnotations</code> 与 <code>namesOfAllMatches</code> 中</li>
</ol>
</li>
<li>处理 <code>beanName</code> 的匹配规则<!-- -->
<ol>
<li>判断 <code>beansIgnoredByType</code> 是否包含 <code>beanName</code></li>
<li>使用 <code>BeanFactory#containsBean</code> 方法判断容器中有该 <code>beanName</code></li>
<li>如果第 2 步结果为 <code>false</code>，第二步结果为 <code>true</code>，则将当前 <code>beanName</code> 加入到 <code>matchedNames</code> 与 <code>namesOfAllMatches</code>，否则保存到 <code>unmatchedNames</code> 中</li>
</ol>
</li>
</ol>
<p>得到 <code>matchedTypes</code>、<code>unmatchedNames</code> 等内容后，<code>matchResult.isAllMatched()</code> 或 <code>matchResult.isAnyMatched()</code> 最终的判断结果就是判断这些结构是否空：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">boolean isAllMatched() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return this.unmatchedAnnotations.isEmpty() &amp;&amp; this.unmatchedNames.isEmpty()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &amp;&amp; this.unmatchedTypes.isEmpty();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">boolean isAnyMatched() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (!this.matchedAnnotations.isEmpty()) || (!this.matchedNames.isEmpty())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            || (!this.matchedTypes.isEmpty());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>看来，<code>@ConditionalOnBean</code>/<code>@ConditionalOnMissingBean</code> 的关键，就是使用 <code>ListableBeanFactory#getBeanNamesForType</code> 或 <code>BeanFactory#containsBean</code> 来判断 <code>beanName</code>、<code>beanType</code> 是否存在了。</p>
<p>在使用 <code>@ConditionalOnBean</code>/<code>@ConditionalOnMissingBean</code> 时，有一个坑需要特别注意：条件注解的执行时机是在 spring 的 <code>ConfigurationClassPostProcessor</code> 中的，确切地说，是在将 <code>bean</code> 加入到 <code>beanFactory</code> 的 <code>beanDefinitionMap</code> 之前判断的，如果满足条件则添加到 <code>beanDefinitionMap</code> 中，否则就不添加。这样就导致了一个问题：如果在 <code>@ConditionalOnBean</code>/<code>@ConditionalOnMissingBean</code> 的 <code>bean</code> 在该 <code>bean</code> 之后加入到 <code>beanDefinitionMap</code> 中，就有可能出现误判，举例说明：</p>
<p>现在有两个类：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnMissingBean(&quot;b&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class A {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class B {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其中 <code>A</code> 与 <code>B</code> 都添加了 <code>@Component</code>，表明这是 spring bean ，然后在 <code>A</code> 上添加了注解 <code>@ConditionalOnMissingBean(&quot;b&quot;)</code>，表明在 <code>b</code> 不存在时，<code>A</code> 才进行初始化。有了这些前提，我们再来看看两种情况：</p>
<ol>
<li>如果 <code>b</code> 先添加到 <code>beanDefinitionMap</code> 中，在将 <code>a</code> 添加到 <code>beanDefinitionMap</code> 时，发现 <code>b</code> 已经存在了，于是就不添加了，符合我们的预期；</li>
<li>如果 <code>a</code> 先被处理，在添加时，发现 <code>beanDefinitionMap</code> 中并没有 <code>b</code>，于是 <code>a</code> 被添加到 <code>beanDefinitionMap</code> 中，再处理 <code>b</code>，<code>b</code> 也会被添加到 <code>beanDefinitionMap</code>，这样一来，<code>a</code> 与 <code>b</code> 同时存在于 <code>beanDefinitionMap</code> 中，最终都会被初始化成 spring bean，这与我们的预期不符。</li>
</ol>
<p>那么 springboot 如何解决以上问题呢？我们来看看 <code>@ConditionalOnBean</code>/<code>@ConditionalOnMissingBean</code> 的说明：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-30df67cb01c73a6b201695298aad14fd0a5.png" alt="" class="img_kGBN"></p>
<p>稍微翻译如下：</p>
<p>该条件只能匹配到目前为止的应用程序上下文中的 bean 存在情况，因此，强烈建议仅于自动配置类中使用。如果候选 bean 要在另一种自动配置下创建，请确保使用此条件的配置在此之后运行。</p>
<p>对以上内容，我的解读如下：</p>
<ul>
<li>被 <code>@ConditionalOnBean</code>/<code>@ConditionalOnMissingBean</code> 标记 <code>bean</code> 加入到 <code>beanDefinitionMap</code> 那一刻，仅匹配目前为止 <code>beanDefinitionMap</code> 中已存在的 bean，对之后加入的 bean 不考虑，这就有可能造成误判，可以参考上面举的 <code>a</code> 与 <code>b</code> 的例子</li>
<li>强烈建议仅在自动配置类中使用 <code>@ConditionalOnBean</code>/<code>@ConditionalOnMissingBean</code> 这两个注解，也就是说在自动配置类中使用的话，能正确处理匹配</li>
<li>还是拿上面的 <code>a</code> 与 <code>b</code> 举例，如果 <code>a</code> 与 <code>b</code> 分别位于不同的自动配置类中，那么 <code>a</code> 需要在 <code>b</code> 之后加载到 <code>beanDefinitionMap</code> 中，这个可以通过 <code>@AutoConfigureAfter</code>、<code>@AutoConfigureBefore</code>、<code>@AutoConfigureOrder</code> 等注解来指定</li>
</ul>
<p>关于自动配置类的加载顺序，后面再做分析吧。</p>
<p>限于篇幅，本文就先到这里了，下篇继续分析剩下的条件注解。</p>
<hr>
<p>本文是 springboot 条件注解分析的第二篇，上文我们总结了 springboot 的几个条件总结：</p>
<table><thead><tr><th>注解类型</th><th>注解类型</th><th>条件判断类</th></tr></thead><tbody><tr><td>class 条件注解</td><td><code>@ConditionalOnClass</code>/<code>@ConditionalOnMissingClass</code></td><td><code>OnClassCondition</code></td></tr><tr><td>bean 条件注解</td><td><code>@ConditionalOnBean</code>/<code>@ConditionalOnMissingBean</code></td><td><code>OnBeanCondition</code></td></tr><tr><td>属性条件注解</td><td><code>@ConditionalOnProperty</code></td><td><code>OnPropertyCondition</code></td></tr><tr><td>Resource 条件注解</td><td><code>@ConditionalOnResource</code></td><td><code>OnResourceCondition</code></td></tr><tr><td>Web 应用条件注解</td><td><code>@ConditionalOnWebApplication</code> / <code>@ConditionalOnNotWebApplication</code></td><td><code>OnWebApplicationCondition</code></td></tr><tr><td>spring 表达式条件注解</td><td><code>@ConditionalOnExpression</code></td><td><code>OnExpressionCondition</code></td></tr></tbody></table>
<p>本文继续分析条件判断。</p>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="5-conditionalonpropertyonpropertyconditiongetmatchoutcome">5. <code>@ConditionalOnProperty</code>：<code>OnPropertyCondition#getMatchOutcome</code><a href="#5-conditionalonpropertyonpropertyconditiongetmatchoutcome" class="hash-link" aria-label="Direct link to 5-conditionalonpropertyonpropertyconditiongetmatchoutcome" title="Direct link to 5-conditionalonpropertyonpropertyconditiongetmatchoutcome">​</a></h3>
<p>我们再来看看 <code>@ConditionalOnProperty</code> 的处理，进入 <code>OnPropertyCondition#getMatchOutcome</code> 方法：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">class OnPropertyCondition extends SpringBootCondition {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConditionOutcome getMatchOutcome(ConditionContext context, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            AnnotatedTypeMetadata metadata) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取 @ConditionalOnProperty 的属性值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;AnnotationAttributes&gt; allAnnotationAttributes = annotationAttributesFromMultiValueMap(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                metadata.getAllAnnotationAttributes(ConditionalOnProperty.class.getName()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConditionMessage&gt; noMatch = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConditionMessage&gt; match = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (AnnotationAttributes annotationAttributes : allAnnotationAttributes) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 在 determineOutcome(...) 方法中进行判断，注意参数：context.getEnvironment()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConditionOutcome outcome = determineOutcome(annotationAttributes, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    context.getEnvironment());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (outcome.isMatch() ? match : noMatch).add(outcome.getConditionMessage());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!noMatch.isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return ConditionOutcome.noMatch(ConditionMessage.of(noMatch));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ConditionOutcome.match(ConditionMessage.of(match));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个方法还是比较简单的，先是获取 <code>@ConditionalOnProperty</code> 的属性值，再调用 <code>determineOutcome(...)</code> 方法进行处理，让我们再进行 <code>OnPropertyCondition#determineOutcome</code> 方法：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 处理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 注意：resolver 传入的的是 Environment，这就是 applicationContext 中的 Environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private ConditionOutcome determineOutcome(AnnotationAttributes annotationAttributes, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PropertyResolver resolver) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Spec spec = new Spec(annotationAttributes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;String&gt; missingProperties = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;String&gt; nonMatchingProperties = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 处理操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec.collectProperties(resolver, missingProperties, nonMatchingProperties);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 判断结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!missingProperties.isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ConditionOutcome.noMatch(ConditionMessage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .forCondition(ConditionalOnProperty.class, spec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .didNotFind(&quot;property&quot;, &quot;properties&quot;).items(Style.QUOTE, missingProperties));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 判断结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!nonMatchingProperties.isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ConditionOutcome.noMatch(ConditionMessage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .forCondition(ConditionalOnProperty.class, spec)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .found(&quot;different value in property&quot;, &quot;different value in properties&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .items(Style.QUOTE, nonMatchingProperties));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 判断结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ConditionOutcome.match(ConditionMessage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .forCondition(ConditionalOnProperty.class, spec).because(&quot;matched&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 处理属性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private void collectProperties(PropertyResolver resolver, List&lt;String&gt; missing, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;String&gt; nonMatching) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (String name : this.names) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = this.prefix + name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // resolver 传入的 environment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // properties 条件判断就是判断 environment 里有没有相应属性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (resolver.containsProperty(key)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!isMatch(resolver.getProperty(key), this.havingValue)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nonMatching.add(name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!this.matchIfMissing) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                missing.add(name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可以看到，<code>@ConditionalOnProperty</code> 最终是通过判断 <code>environment</code> 中是否有该属性来处理条件判断的。</p>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="6-conditionalonresourceonresourceconditiongetmatchoutcome">6. <code>@ConditionalOnResource</code>：<code>OnResourceCondition#getMatchOutcome</code><a href="#6-conditionalonresourceonresourceconditiongetmatchoutcome" class="hash-link" aria-label="Direct link to 6-conditionalonresourceonresourceconditiongetmatchoutcome" title="Direct link to 6-conditionalonresourceonresourceconditiongetmatchoutcome">​</a></h3>
<p>我们再来看看 <code>@ConditionalOnResource</code> 的处理，一般我们这样使用：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnResource(resources = &quot;classpath:config.properties&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Config config() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>表示当 <code>classpath</code> 中存在 <code>config.properties</code> 时，<code>config</code> 才会被初始化 springbean。</p>
<p>再进入 <code>OnResourceCondition#getOutcomes</code> 方法：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public ConditionOutcome getMatchOutcome(ConditionContext context, AnnotatedTypeMetadata metadata) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MultiValueMap&lt;String, Object&gt; attributes = metadata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .getAllAnnotationAttributes(ConditionalOnResource.class.getName(), true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 获取 ResourceLoader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ResourceLoader loader = context.getResourceLoader();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;String&gt; locations = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    collectValues(locations, attributes.get(&quot;resources&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Assert.isTrue(!locations.isEmpty(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;@ConditionalOnResource annotations must specify at least one resource location&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;String&gt; missing = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 遍历判断资源是否存在</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (String location : locations) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // location 中可能有占位符，在这里处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String resource = context.getEnvironment().resolvePlaceholders(location);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 判断 resource 是否存在</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!loader.getResource(resource).exists()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            missing.add(location);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 处理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!missing.isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ConditionOutcome.noMatch(ConditionMessage.forCondition(ConditionalOnResource.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .didNotFind(&quot;resource&quot;, &quot;resources&quot;).items(Style.QUOTE, missing));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ConditionOutcome.match(ConditionMessage.forCondition(ConditionalOnResource.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .found(&quot;location&quot;, &quot;locations&quot;).items(locations));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>先是通过 <code>OnResourceCondition#getOutcomes</code> 方法来获取 <code>ResourceLoader</code>，通过调试方式发现当前的 <code>ResourceLoader</code> 为 <code>AnnotationConfigServletWebServerApplicationContext</code>：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-8f1de99f757eca7aeb0307b06b28d1020d2.png" alt="" class="img_kGBN"></p>
<p>获取到 <code>ResourceLoader</code> 后，调用 <code>ResourceLoader#getResource(String)</code> 来获取资源，然后调用 <code>Resource#exists</code> 来判断资源是否存在，最后处理匹配结果。</p>
<p>整个流程的关键是在 <code>ResourceLoader#getResource(String)</code>，我们来看看该方法的处理，进入到 <code>GenericApplicationContext#getResource</code> 方法：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Resource getResource(String location) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (this.resourceLoader != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.resourceLoader.getResource(location);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return super.getResource(location);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里的 <code>this.resourceLoader</code> 为 <code>null</code>，进入父类的方法 <code>DefaultResourceLoader#getResource</code>：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public Resource getResource(String location) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Assert.notNull(location, &quot;Location must not be null&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (ProtocolResolver protocolResolver : getProtocolResolvers()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Resource resource = protocolResolver.resolve(location, this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (resource != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return resource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 处理/开头的资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (location.startsWith(&quot;/&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return getResourceByPath(location);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else if (location.startsWith(CLASSPATH_URL_PREFIX)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理classpath开头的资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ClassPathResource(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            location.substring(CLASSPATH_URL_PREFIX.length()), getClassLoader());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 以上都不满足，使用 url 来解析</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            URL url = new URL(location);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return (ResourceUtils.isFileURL(url) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ? new FileUrlResource(url) : new UrlResource(url));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        catch (MalformedURLException ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // url解析出了问题，最终还是用 getResourceByPath(...) 来解析</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return getResourceByPath(location);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 通过路径得到 Resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected Resource getResourceByPath(String path) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new ClassPathContextResource(path, getClassLoader());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可以看到，<code>DefaultResourceLoader#getResource</code> 通过判断 <code>location</code> 的前缀，得到了 4 种 <code>Resource</code>：</p>
<ul>
<li><code>ClassPathContextResource</code></li>
<li><code>FileUrlResource</code></li>
<li><code>UrlResource</code></li>
</ul>
<p>得到 <code>Resource</code> 后，接着就是判断该 <code>Resource</code> 是否存在了，我们先来看看 <code>ClassPathContextResource#exist</code> 方法，该方法在 <code>ClassPathResource#exists</code>：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 判断 Resource 是否存在</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public boolean exists() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (resolveURL() != null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 资源能获取到，则返回资源对应的url，否则返回null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Nullable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected URL resolveURL() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (this.clazz != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 使用当前的 class 对应的 classLoader 来获取</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.clazz.getResource(this.path);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else if (this.classLoader != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 使用指定的 classLoader 来获取</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.classLoader.getResource(this.path);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取系统类加载器获取</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ClassLoader.getSystemResource(this.path);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>从代码可以看到，最终是通过 <code>classLoader</code> 获取文件的 <code>url</code>，通过判断文件 <code>url</code> 是否为 <code>null</code> 来判断 <code>resource</code> 是否存在。</p>
<p>再来看看 <code>FileUrlResource</code> 的判断，实际上 <code>FileUrlResource</code> 与 <code>UrlResource</code> 的 <code>exist()</code> 方法都是 <code>AbstractFileResolvingResource#exists</code>，这里统一分析就可以了，该方法内容如下：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public boolean exists() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        URL url = getURL();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (ResourceUtils.isFileURL(url)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 如果是文件，直接判断文件是否存在</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return getFile().exists();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 否则使用网络文件来处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            URLConnection con = url.openConnection();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            customizeConnection(con);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            HttpURLConnection httpCon =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    (con instanceof HttpURLConnection ? (HttpURLConnection) con : null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 如果是http，则判断看看链接返回的状态码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (httpCon != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                int code = httpCon.getResponseCode();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (code == HttpURLConnection.HTTP_OK) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                else if (code == HttpURLConnection.HTTP_NOT_FOUND) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 连接 contentLengthLong 大于0，也当成是true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (con.getContentLengthLong() &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (httpCon != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                httpCon.disconnect();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                getInputStream().close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catch (IOException ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果是本地文件，直接使用 <code>File#exists()</code> 方法判断文件是否存在，否则就判断网络文件是否存在，判断方式这里就不细说了。</p>
<p>总的来说，springboot 对 <code>@ConditionalOnResource</code> 的判断还是有些复杂的，这里总结如下：</p>
<ol>
<li>如果是 <code>classpath</code> 文件，通过 <code>classloader</code> 获取文件对应的 <code>url</code> 是否为 <code>null</code> 来判断文件是否存在；</li>
<li>如果是普通文件，则直接 <code>File#exists()</code> 方法判断文件是否存在；</li>
<li>如果是网络文件，先打开一个网络连接，判断文件是否存在。</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="7-conditionalonwebapplicationonwebapplicationconditiongetmatchoutcome">7. <code>@ConditionalOnWebApplication</code>：<code>OnWebApplicationCondition#getMatchOutcome</code><a href="#7-conditionalonwebapplicationonwebapplicationconditiongetmatchoutcome" class="hash-link" aria-label="Direct link to 7-conditionalonwebapplicationonwebapplicationconditiongetmatchoutcome" title="Direct link to 7-conditionalonwebapplicationonwebapplicationconditiongetmatchoutcome">​</a></h3>
<p>我们再来看看 <code>@ConditionalOnWebApplication</code> 的处理，进入 <code>OnWebApplicationCondition#getOutcomes</code> 方法：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected ConditionOutcome[] getOutcomes(String[] autoConfigurationClasses,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AutoConfigurationMetadata autoConfigurationMetadata) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConditionOutcome[] outcomes = new ConditionOutcome[autoConfigurationClasses.length];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 0; i &lt; outcomes.length; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String autoConfigurationClass = autoConfigurationClasses[i];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (autoConfigurationClass != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 处理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            outcomes[i] = getOutcome(autoConfigurationMetadata.get(autoConfigurationClass, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ConditionalOnWebApplication&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return outcomes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 处理结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * springboot支持的web类型有两种：SERVLET，REACTIVE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private ConditionOutcome getOutcome(String type) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (type == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConditionMessage.Builder message = ConditionMessage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .forCondition(ConditionalOnWebApplication.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 如果指定的类型是 SERVLET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ConditionalOnWebApplication.Type.SERVLET.name().equals(type)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!ClassNameFilter.isPresent(SERVLET_WEB_APPLICATION_CLASS, getBeanClassLoader())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return ConditionOutcome.noMatch(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                message.didNotFind(&quot;servlet web application classes&quot;).atAll());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 如果指定的类型是 REACTIVE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ConditionalOnWebApplication.Type.REACTIVE.name().equals(type)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!ClassNameFilter.isPresent(REACTIVE_WEB_APPLICATION_CLASS, getBeanClassLoader())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return ConditionOutcome.noMatch(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                message.didNotFind(&quot;reactive web application classes&quot;).atAll());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 如果没有指定web类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!ClassNameFilter.isPresent(SERVLET_WEB_APPLICATION_CLASS, getBeanClassLoader())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &amp;&amp; !ClassUtils.isPresent(REACTIVE_WEB_APPLICATION_CLASS, getBeanClassLoader())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ConditionOutcome.noMatch(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            message.didNotFind(&quot;reactive or servlet web application classes&quot;).atAll());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个方法很简单，处理逻辑为：根据 <code>@ConditionalOnWebApplication</code> 中指定的类型，判断对应 的类是否存在，判断方式与 <code>@ConditionalOnClass</code> 判断类是否存在一致，而两种类型对应的类如下：</p>
<ul>
<li>Servlet：<code>org.springframework.web.context.support.GenericWebApplicationContext</code></li>
<li>Reactive：<code>org.springframework.web.reactive.HandlerResult</code></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="8-conditionalonexpressiononexpressionconditiongetmatchoutcome">8. <code>@ConditionalOnExpression</code>：<code>OnExpressionCondition#getMatchOutcome</code><a href="#8-conditionalonexpressiononexpressionconditiongetmatchoutcome" class="hash-link" aria-label="Direct link to 8-conditionalonexpressiononexpressionconditiongetmatchoutcome" title="Direct link to 8-conditionalonexpressiononexpressionconditiongetmatchoutcome">​</a></h3>
<p>我们再来看看 <code>@ConditionalOnExpression</code> 的处理，进入 <code>OnExpressionCondition#getOutcomes</code> 方法：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 处理匹配结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public ConditionOutcome getMatchOutcome(ConditionContext context, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AnnotatedTypeMetadata metadata) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 获取表达式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String expression = (String) metadata.getAnnotationAttributes(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConditionalOnExpression.class.getName()).get(&quot;value&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    expression = wrapIfNecessary(expression);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConditionMessage.Builder messageBuilder = ConditionMessage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .forCondition(ConditionalOnExpression.class, &quot;(&quot; + expression + &quot;)&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 处理占位符</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    expression = context.getEnvironment().resolvePlaceholders(expression);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConfigurableListableBeanFactory beanFactory = context.getBeanFactory();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (beanFactory != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 计算表达式的值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean result = evaluateExpression(beanFactory, expression);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ConditionOutcome(result, messageBuilder.resultedIn(result));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ConditionOutcome.noMatch(messageBuilder.because(&quot;no BeanFactory available.&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 计算表达式的值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private Boolean evaluateExpression(ConfigurableListableBeanFactory beanFactory, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String expression) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BeanExpressionResolver resolver = beanFactory.getBeanExpressionResolver();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (resolver == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        resolver = new StandardBeanExpressionResolver();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 在这里解析表达式的值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BeanExpressionContext expressionContext = new BeanExpressionContext(beanFactory, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object result = resolver.evaluate(expression, expressionContext);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (result != null &amp;&amp; (boolean) result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可以看到，springboot 最终是通过 <code>BeanExpressionResolver#evaluate</code> 方法来计算表达式结果，关于 spring 表达式，本文就不展开分析了。</p>
<p>好了，spring 条件注解的分析就到这里了，需要说明的是，springboot 还 有其他条件注解：</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/up-0e8d27c887fb6ca142672cad1c60e9de207.png" alt="" class="img_kGBN"></p>
<p>这些注解的判断方式与本文的方式相类似，就不一一进行分析了。</p>
<hr>
<p><em>本文原文链接：<a href="https://my.oschina.net/funcy/blog/4921590" target="_blank" rel="noopener noreferrer">https://my.oschina.net/funcy/blog/4921590</a> ，限于作者个人水平，文中难免有错误之处，欢迎指正！原创不易，商业转载请联系作者获得授权，非商业转载请注明出处。</em></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Spring全家桶/SpringBoot源码解析/SpringBoot自动装配（二）：条件注解.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_EYjg" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_eevz"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBoot启动流程（一）：准备SpringApplication"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">SpringBoot启动流程（一）：准备SpringApplication</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBoot自动装配（三）：自动装配顺序"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">SpringBoot自动装配（三）：自动装配顺序</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_lc2k thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-条件注解及其判断类" class="table-of-contents__link toc-highlight">1. 条件注解及其判断类</a></li><li><a href="#2-springbootconditionmatches" class="table-of-contents__link toc-highlight">2. <code>SpringBootCondition#matches</code></a></li><li><a href="#3-conditionalonclass-onclassconditiongetmatchoutcome" class="table-of-contents__link toc-highlight">3. <code>@ConditionalOnClass</code>: <code>OnClassCondition#getMatchOutcome</code></a></li><li><a href="#4-conditionalonbean-onbeanconditiongetmatchoutcome" class="table-of-contents__link toc-highlight">4. <code>@ConditionalOnBean</code>: <code>OnBeanCondition#getMatchOutcome</code></a></li><li><a href="#5-conditionalonpropertyonpropertyconditiongetmatchoutcome" class="table-of-contents__link toc-highlight">5. <code>@ConditionalOnProperty</code>：<code>OnPropertyCondition#getMatchOutcome</code></a></li><li><a href="#6-conditionalonresourceonresourceconditiongetmatchoutcome" class="table-of-contents__link toc-highlight">6. <code>@ConditionalOnResource</code>：<code>OnResourceCondition#getMatchOutcome</code></a></li><li><a href="#7-conditionalonwebapplicationonwebapplicationconditiongetmatchoutcome" class="table-of-contents__link toc-highlight">7. <code>@ConditionalOnWebApplication</code>：<code>OnWebApplicationCondition#getMatchOutcome</code></a></li><li><a href="#8-conditionalonexpressiononexpressionconditiongetmatchoutcome" class="table-of-contents__link toc-highlight">8. <code>@ConditionalOnExpression</code>：<code>OnExpressionCondition#getMatchOutcome</code></a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/code-note-blog/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/code-note-blog/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>