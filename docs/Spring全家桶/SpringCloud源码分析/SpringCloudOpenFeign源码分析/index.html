<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Spring全家桶/SpringCloud源码分析/SpringCloudOpenFeign源码分析" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.0">
<title data-rh="true">SpringCloudOpenFeign源码分析 | Tommy</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aiden-coding.github.io/code-note-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://aiden-coding.github.io/code-note-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudOpenFeign源码分析"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="SpringCloudOpenFeign源码分析 | Tommy"><meta data-rh="true" name="description" content="作者 | 宇木木兮"><meta data-rh="true" property="og:description" content="作者 | 宇木木兮"><link data-rh="true" rel="icon" href="/code-note-blog/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudOpenFeign源码分析"><link data-rh="true" rel="alternate" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudOpenFeign源码分析" hreflang="en"><link data-rh="true" rel="alternate" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudOpenFeign源码分析" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/code-note-blog/blog/rss.xml" title="Tommy RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/code-note-blog/blog/atom.xml" title="Tommy Atom Feed"><link rel="stylesheet" href="/code-note-blog/assets/css/styles.dd5372db.css">
<script src="/code-note-blog/assets/js/runtime~main.f999fb27.js" defer="defer"></script>
<script src="/code-note-blog/assets/js/main.a0bfbaed.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_XYiV" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/code-note-blog/"><b class="navbar__title text--truncate">Tommy</b></a><a class="navbar__item navbar__link" href="/code-note-blog/docs/Java/basic/抽象类和接口">java</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/JavaWeb/走进JavaWeb技术世界：JavaWeb的由来和基础知识">javaweb</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/cache/探索Redis设计与实现：连接底层与表面的数据结构robj">cache</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/backend/后端技术杂谈：白话虚拟化技术">backend</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/cs/algorithms/剑指offer">cs</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/database/重新学习MySQL数据库：『浅入浅出』MySQL和InnoDB">database</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/distributed/basic/分布式系统理论基础 ：CAP">distributed</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/interview/BATJ-Experience/面阿里,终获offer">interview</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/mq/kafka/消息队列kafka详解：如何实现死信队列">mq</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/code-note-blog/docs/Spring全家桶/Spring/第一个Spring应用">spring</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/mianshi/collection">面试</a><a href="https://aiden-coding.github.io/code-note-blog/SpringCloud%E7%AC%AC3%E5%AD%A32024.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="toggle_XbAW colorModeToggle_r5NY"><button class="clean-btn toggleButton_Jx0n toggleButtonDisabled_zYO7" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_FjAw"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_qmEt"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_wJfS"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_LABv"><div class="docsWrapper_pdvB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_Jioa" type="button"></button><div class="docRoot_qx_v"><aside class="theme-doc-sidebar-container docSidebarContainer_NHKT"><div class="sidebarViewport_uyYB"><div class="sidebar_SZG4"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_VP_k"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/Spring/第一个Spring应用">Spring</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：初探SpringIOC核心流程">Spring源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringBoot/给你一份SpringBoot知识清单">SpringBoot</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBoot启动流程（四）：启动IOC容器">SpringBoot源码解析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloud/SpringCloudConsul">SpringCloud</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudConfig源码分析">SpringCloud源码分析</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudConfig源码分析">SpringCloudConfig源码分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudEureka源码分析">SpringCloudEureka源码分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudGateway源码分析">SpringCloudGateway源码分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudHystrix源码分析">SpringCloudHystrix源码分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudLoadBalancer源码分析">Spring Cloud LoadBalancer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudOpenFeign源码分析">SpringCloudOpenFeign源码分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudRibbon源码分析">SpringCloudRibbon源码分析</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba/SpringCloudAlibaba概览">SpringCloudAlibaba</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba源码分析/SpringCloudAlibabaNacos源码分析：服  务发现">SpringCloudAlibaba源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringMVC/SpringMVC常见注解">SpringMVC</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/请求执行流程（二）之执行Handler方法">SpringMVC源码分析</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_SejT"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_j3Yw"><div class="docItemContainer_XOSC"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_F6gm" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/code-note-blog/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YCxa"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">SpringCloud源码分析</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">SpringCloudOpenFeign源码分析</span><meta itemprop="position" content="2"></li></ul></nav><div class="theme-doc-markdown markdown"><p>作者 | 宇木木兮
来源 |今日头条</p>
<p><strong>学习目标</strong></p>
<ol>
<li>为什么加一个注解就能实现远程过程调用呢？推导它底层的实现主流程？</li>
<li>OpenFeign怎么实现RPC的基本功能的</li>
<li>通过源码验证
<strong>第1章 OpenFeign主流程推导</strong>
要明确OpenFeign的主流程首先我们还是要明确它的核心目标是什么？</li>
</ol>
<p>说白了，OpenFeign最核心的目标就是让客户端在远程调用过程中不需要做什么多余的操作，只要拿到一个对象，然后调用该对象的方法就好了，剩下的操作都交给OpenFeign去帮你完成，那剩下一些什么操作呢？</p>
<ol>
<li>首先肯定是保证网络通信，那我们大胆地猜测一下，OpenFeign其实底层帮我们封装了请求的地址、端口、请求参数以及响应的参数。</li>
<li>其次，当我们要用对象去请求方法，那这个对象是远程的服务，这个对象肯定不简单，这里也大胆猜测一下，该对象也是OpenFeign给我们创建的。</li>
<li>然后在调用过程中，如果服务是由多台服务器提供的，那又涉及到负载均衡了，这肯定也是OpenFeign帮我们完成了。</li>
<li>除了上面的问题，再联想一下，既然存在服务端是集群的情况，那服务端的地址和端口还需要一个注册中心来注册，这肯定也不能由客户端来完成，因为客户端只关注业务代码。那想都不用想，也是OpenFeign来完成了。</li>
</ol>
<p>OK，上面推导了OpenFeign应该完成的主要目标，接下来我们再来分析分析它是怎么做的。
<img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/b45564c706ab4113cc23492cc0796907b851f8.jpg" alt="SpringCloud系列—Spring Cloud 源码分析之OpenFeign-开源基础软件社区" title="SpringCloud系列—Spring Cloud 源码分析之OpenFeign-开源基础软件社区" class="img_kGBN">之前的文章有讲过一个概念，不管是什么组件，只要是集成spring或者springboot的话，那一定是想通过spring或者springboot去管理bean对象的创建的，当通过容器拿到对象之后再去调用对象的核心方法，那OpenFeign在集成springboot的时候理念也应该是这样。</p>
<ol>
<li>所以第一步，OpenFeign集成springboot，通过springboot拿到核心bean对象，例如上图中的userService对象。</li>
<li>这个对象肯定不简单，不可能只有getUser的功能。那想一想，spring中做功能增强可以用什么来做呢？——代理嘛，那这个对象的类型就呼之欲出了，代理对象。</li>
<li>调用代理对象的方法时，流程先进入到invoke中，在这个invoke中，做的增强包括了负载均衡LoadBalance，因为我在真正调用getUser的时候要知道具体是调用哪台服务器的服务。</li>
<li>负载均衡做完就得拼接具体的http请求参数，请求头，请求地址，请求端口了。
OK，以上分析了OpenFeign底层要实现的具体功能，也分析了它的处理流程，那么接下来我们通过源码来验证一下，它是不是这么玩的。</li>
</ol>
<p><strong>第2章 源码验证</strong></p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/93070e354fbacedc2b85274846d2dde7dd170a.jpg" alt="SpringCloud系列—Spring Cloud 源码分析之OpenFeign-开源基础软件社区" title="SpringCloud系列—Spring Cloud 源码分析之OpenFeign-开源基础软件社区" class="img_kGBN"><strong>2.1 EnableFeignClients</strong>
我们从下面这个注解进行切入，这个注解开启了FeignClient的解析过程。</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@EnableFeignClients(basePackages = &quot;com.example.client&quot;)</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个注解的声明如下，它用到了一个@Import注解，我们知道Import是用来导入一个配置类的，接下来去看一下FeignClientsRegistrar的定义。</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target(ElementType.TYPE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Documented</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Import(FeignClientsRegistrar.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface EnableFeignClients {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>FeignClientsRegistrar实现了
ImportBeanDefinitionRegistrar，它是一个动态注入bean的接口，Spring Boot启动的时候，会去调用这个类中的registerBeanDefinitions来实现动态Bean的装载。registerBeanDefinitions是在spring容器启动时执行invokeBeanFactoryPostProcessors方法，然后对相应的类进行解析注册，它的作用类似于ImportSelector。</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">class FeignClientsRegistrar implements ImportBeanDefinitionRegistrar, ResourceLoaderAware,EnvironmentAware {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void registerBeanDefinitions(AnnotationMetadata metadata,BeanDefinitionRegistry registry) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerDefaultConfiguration(metadata, registry);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerFeignClients(metadata, registry);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>2.1.1 ImportBeanDefinitionRegistrar</strong>
简单给大家演示一下
ImportBeanDefinitionRegistrar的作用。</p>
<ul>
<li>定义一个需要被装载到IOC容器中的类HelloService</li>
</ul>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class HelloService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>定义一个Registrar的实现，定义 一个bean，装载到IOC容器</li>
</ul>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class FeignImportBeanDefinitionRegistrar implements ImportBeanDefinitionRegistrar {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        BeanDefinition beanDefinition = new GenericBeanDefinition();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        beanDefinition.setBeanClassName(HelloService.class.getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        registry.registerBeanDefinition(&quot;helloService&quot;,beanDefinition);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>
<p>定义一个注解类</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target({ElementType.TYPE})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Documented</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Import({FeignImportBeanDefinitionRegistrar.class})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface EnableFeignTest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>启动类</p>
</li>
</ul>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@EnableFeignClients(basePackages = &quot;com.example.clients&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableFeignTest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@SpringBootApplication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class OpenfeignUserServiceApplication {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigurableApplicationContext context = SpringApplication.run(OpenfeignUserServiceApplication.class, args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(context.getBean(HelloService.class));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>通过结果演示可以发现，HelloService这个bean 已经装载到了IOC容器。
这就是动态装载的功能实现，它相比于@Configuration配置注入，会多了很多的灵活性。 ok，再回到FeignClient的解析中来。</li>
</ul>
<p><strong>2.1.2 FeignClientsRegistrar</strong></p>
<ul>
<li>
<p>registerDefaultConfiguration 方法内部从 SpringBoot 启动类上检查是否有@EnableFeignClients, 有该注解的话， 则完成 Feign 框架相关的一些配置内容注册</p>
</li>
<li>
<p>registerFeignClients 方法内部从 classpath 中， 扫描获得 @FeignClient 修饰的类， 将类的内容解析为 BeanDefinition , 最终通过调用 Spring 框架中的BeanDefinitionReaderUtils.resgisterBeanDefinition 将解析处理过的 FeignClientBeanDeifinition 添加到 spring 容器中.</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void registerBeanDefinitions(AnnotationMetadata metadata,BeanDefinitionRegistry registry) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //注册@EnableFeignClients中定义defaultConfiguration属性下的类，包装成FeignClientSpecification，注册到Spring容器。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //在@FeignClient中有一个属性：configuration，这个属性是表示各个FeignClient自定义的配置类，后面也会通过调用registerClientConfiguration方法来注册成FeignClientSpecification到容器。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //所以，这里可以完全理解在@EnableFeignClients中配置的是做为兜底的配置，在各个@FeignClient配置的就是自定义的情况。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    registerDefaultConfiguration(metadata, registry);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    registerFeignClients(metadata, registry);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<p><strong>2.2 registerDefaultConfiguration</strong></p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">private void registerDefaultConfiguration(AnnotationMetadata metadata, BeanDefinitionRegistry registry) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 获取到metadata中关于EnableFeignClients的属性值键值对。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Map&lt;String, Object&gt; defaultAttrs = metadata.getAnnotationAttributes(EnableFeignClients.class.getName(), true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //如果配置了defaultConfiguration 进行配置,如果没有使用默认的configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (defaultAttrs != null &amp;&amp; defaultAttrs.containsKey(&quot;defaultConfiguration&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (metadata.hasEnclosingClass()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            name = &quot;default.&quot; + metadata.getEnclosingClassName();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            name = &quot;default.&quot; + metadata.getClassName();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //进行注册</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.registerClientConfiguration(registry, name, defaultAttrs.get(&quot;defaultConfiguration&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">private void registerClientConfiguration(BeanDefinitionRegistry registry, Object name, Object configuration) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //使用BeanDefinitionBuilder来生成BeanDefinition,并把它进行注册</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition(FeignClientSpecification.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    builder.addConstructorArgValue(name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    builder.addConstructorArgValue(configuration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    registry.registerBeanDefinition(name + &quot;.&quot; + FeignClientSpecification.class.getSimpleName(), builder.getBeanDefinition());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>方法的入参BeanDefinitionRegistry是spring框架用于动态注册BeanDefinition信息的接口，调用registerBeanDefinition方法可以将BeanDefinition注册到Spring容器中，其中name属性就是注册的BeanDefinition的名称，在这里它注册了一个FeignClientSpecification的对象。</p>
<p>FeignClientSpecification实现了
NamedContextFactory.Specification接口，它是Feign实例化的重要一环，在上面的方法中，它持有自定义配置的组件实例，SpringCloud使用NamedContextFactory创建一些列的运行上下文ApplicationContext来让对应的Specification在这些上下文中创建实例对象。</p>
<p>NamedContextFactory有3个功能：</p>
<ul>
<li>创建AnnotationConfigApplicationContext上下文。</li>
<li>在上下文中创建并获取bean实例。</li>
<li>当上下文销毁时清除其中的feign实例。
NamedContextFactory有个非常重要的子类FeignContext，用于存储各种OpenFeign的组件实例。</li>
</ul>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class FeignContext extends NamedContextFactory&lt;FeignClientSpecification&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public FeignContext() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       super(FeignClientsConfiguration.class, &quot;feign&quot;, &quot;feign.client.name&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>FeignContext是哪里构建的呢？</p>
<p>配置见：
pring-cloud-openfeign-core-2.2.3.RELEASE.jar!\META-INF\spring.factories<img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/d830f20713aca01438472786f5f84c7058232b.jpg" alt="SpringCloud系列—Spring Cloud 源码分析之OpenFeign-开源基础软件社区" title="SpringCloud系列—Spring Cloud 源码分析之OpenFeign-开源基础软件社区" class="img_kGBN"><strong>2.2.1 FeignAutoConfiguration</strong></p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/894c73791fbf7215782217d7132bc57f004085.jpg" alt="SpringCloud系列—Spring Cloud 源码分析之OpenFeign-开源基础软件社区" title="SpringCloud系列—Spring Cloud 源码分析之OpenFeign-开源基础软件社区" class="img_kGBN"></p>
<p>将默认的FeignClientsConfiguration作为参数传递给构造函数</p>
<p>FeignContext创建的时候会将之前FeignClientSpecification通过setConfigurations设置给context上下文。</p>
<p><strong>2.2.2 createContext</strong>
代码详见：
org.springframework.cloud.context.named.NamedContextFactory#createContext方法。</p>
<p>FeignContext的父类的createContext方法会将创建
AnnotationConfigApplicationContext实例，这实例将作为当前上下文的子上下文，用于关联feign组件的不同实例。在调用FeignClientFactoryBean的getObject方法时调用。（createContext调用在下文会讲解）</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected AnnotationConfigApplicationContext createContext(String name) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	//获取name所对应的configuration,如果有就注册到子context中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (this.configurations.containsKey(name)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Class&lt;?&gt; configuration : this.configurations.get(name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             .getConfiguration()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            context.register(configuration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //注册default的Configuration,也就是 FeignClientsRegistrar类中registerDefaultConfiguration方法中注册的Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (Map.Entry&lt;String, C&gt; entry : this.configurations.entrySet()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (entry.getKey().startsWith(&quot;default.&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (Class&lt;?&gt; configuration : entry.getValue().getConfiguration()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                context.register(configuration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //注册PropertyPlaceholderAutoConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.register(PropertyPlaceholderAutoConfiguration.class,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     this.defaultConfigType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //置Environment的propertySources属性源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.getEnvironment().getPropertySources().addFirst(new MapPropertySource(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.propertySourceName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collections.&lt;String, Object&gt;singletonMap(this.propertyName, name)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (this.parent != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Uses Environment from parent as well as beans</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.setParent(this.parent);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // jdk11 issue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // https://github.com/spring-cloud/spring-cloud-netflix/issues/3101</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.setClassLoader(this.parent.getClassLoader());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.setDisplayName(generateDisplayName(name));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context.refresh();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>由于NamedContextFactory实现了DisposableBean，所以当实例消亡的时候会调用</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void destroy() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Collection&lt;AnnotationConfigApplicationContext&gt; values = this.contexts.values();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (AnnotationConfigApplicationContext context : values) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // This can fail, but it never throws an exception (you see stack traces</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // logged as WARN).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.contexts.clear();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>总结：NamedContextFactory会创建出
AnnotationConfigApplicationContext实例，并以name作为唯一标识，然后每个AnnotationConfigApplicationContext实例都会注册部分配置类，从而可以给出一系列的基于配置类生成的组件实例，这样就可以基于name来管理一系列的组件实例，为不同的FeignClient准备不同配置组件实例。</p>
<p><strong>2.3 registerFeignClients</strong>
这个方法主要是扫描类路径下所有的@FeignClient注解，然后进行动态Bean的注入。它最终会调用 registerFeignClient 方法。</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public void registerFeignClients(AnnotationMetadata metadata,BeanDefinitionRegistry registry) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //省略代码...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    registerFeignClient(registry, annotationMetadata, attributes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在这个方法中，就是去组装BeanDefinition，也就是Bean的定义，然后注册到Spring IOC容器。</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">private void registerFeignClient(BeanDefinitionRegistry registry,AnnotationMetadata annotationMetadata, Map&lt;String, Object&gt; attributes) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String className = annotationMetadata.getClassName();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BeanDefinitionBuilder definition = BeanDefinitionBuilder.genericBeanDefinition(FeignClientFactoryBean.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //省略代码...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BeanDefinitionHolder holder = new BeanDefinitionHolder(beanDefinition,className,new String[] { alias });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BeanDefinitionReaderUtils.registerBeanDefinition(holder, registry);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们关注一下，BeanDefinitionBuilder是用来构建一个BeanDefinition的，它是通过genericBeanDefinition 来构建的，并且传入了一个FeignClientFactoryBean的类。</p>
<p>我们可以发现，FeignClient被动态注册成了一个FactoryBean</p>
<blockquote>
<p>Spring Cloud FengnClient实际上是利用Spring的代理工厂来生成代理类，所以在这里才会把所有的FeignClient的BeanDefinition设置为FeignClientFactoryBean类型，而FeignClientFactoryBean继承自FactoryBean，它是一个工厂Bean。</p>
<p>在Spring中，FactoryBean是一个工厂Bean，用来创建代理Bean。</p>
<p>工厂 Bean 是一种特殊的 Bean, 对于 Bean 的消费者来说， 他逻辑上是感知不到这个 Bean 是普通的 Bean 还是工厂 Bean, 只是按照正常的获取 Bean 方式去调用， 但工厂bean 最后返回的实例不是工厂Bean 本身， 而是执行工厂 Bean 的 getObject 逻辑返回的示例。（也就是在实例化工厂Bean的时候会去调用它的getObject方法）</p>
</blockquote>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public static BeanDefinitionBuilder genericBeanDefinition(Class&lt;?&gt; beanClass) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BeanDefinitionBuilder builder = new BeanDefinitionBuilder(new GenericBeanDefinition());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    builder.beanDefinition.setBeanClass(beanClass);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return builder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>简单来说，FeignClient标注的这个接口，会通过
FeignClientFactoryBean.getObject()这个方法获得一个代理对象。</p>
<p><strong>2.3.1 FeignClientFactoryBean.getObject</strong>
getObject调用的是getTarget方法，它从applicationContext取出FeignContext，FeignContext继承了NamedContextFactory，它是用来来统一维护feign中各个feign客户端相互隔离的上下文。</p>
<p>接着，构建feign.builder，在构建时会向FeignContext获取配置的Encoder，Decoder等各种信息。FeignContext在上篇中已经提到会为每个Feign客户端分配了一个容器，它们的父容器就是spring容器</p>
<p>配置完Feign.Builder之后，再判断是否需要LoadBalance，如果需要，则通过LoadBalance的方法来设置。实际上他们最终调用的是Target.target()方法。</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Object getObject() throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return getTarget();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;T&gt; T getTarget() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //实例化Feign上下文对象FeignContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FeignContext context = this.applicationContext.getBean(FeignContext.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Feign.Builder builder = feign(context);//构建Builder对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!StringUtils.hasText(this.url)) {//如果url为空，则走负载均衡，生成有负载均衡功能的代理类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!this.name.startsWith(&quot;http&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.url = &quot;http://&quot; + this.name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.url = this.name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.url += cleanPath();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (T) loadBalance(builder, context,new HardCodedTarget&lt;&gt;(this.type, this.name,this.url));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //如果指定了url，则生成默认的代理类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StringUtils.hasText(this.url) &amp;&amp; !this.url.startsWith(&quot;http&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.url = &quot;http://&quot; + this.url;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String url = this.url + cleanPath();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //调用FeignContext的getInstance方法获取Client对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Client client = getOptional(context, Client.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (client != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (client instanceof LoadBalancerFeignClient) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // not load balancing because we have a url,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // but ribbon is on the classpath, so unwrap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            client = ((LoadBalancerFeignClient) client).getDelegate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (client instanceof FeignBlockingLoadBalancerClient) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // not load balancing because we have a url,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // but Spring Cloud LoadBalancer is on the classpath, so unwrap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            client = ((FeignBlockingLoadBalancerClient) client).getDelegate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        builder.client(client);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }//生成默认代理类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Targeter targeter = get(context, Targeter.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (T) targeter.target(this, builder, context,new HardCodedTarget&lt;&gt;(this.type, this.name,url));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>2.3.2 loadBalance</strong>
生成具备负载均衡能力的feign客户端，为feign客户端构建起绑定负载均衡客户端.</p>
<p>Client client = (Client)this.getOptional(context, Client.class); 从上下文中获取一个Client，默认是LoadBalancerFeignClient。</p>
<p>它是在FeignRibbonClientAutoConfiguration这个自动装配类中，通过Import实现的</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Import({ HttpClientFeignLoadBalancedConfiguration.class,OkHttpFeignLoadBalancedConfiguration.class,DefaultFeignLoadBalancedConfiguration.class })</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected &lt;T&gt; T loadBalance(Builder builder, FeignContext context,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            HardCodedTarget&lt;T&gt; target) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Client client = (Client)this.getOptional(context, Client.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (client != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        builder.client(client);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Targeter targeter = (Targeter)this.get(context, Targeter.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return targeter.target(this, builder, context, target);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;No Feign Client for loadBalancing defined. Did you forget to include spring-cloud-starter-netflix-ribbon?&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>2.3.3 DefaultTarget.target</strong></p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public &lt;T&gt; T target(FeignClientFactoryBean factory, Feign.Builder feign,FeignContext context, Target.HardCodedTarget&lt;T&gt; target) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return feign.target(target);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>2.3.4 ReflectiveFeign.newInstance</strong>
这个方法是用来创建一个动态代理的方法，在生成动态代理之前，会根据Contract协议（协议解析规则，解析接口类的注解信息，解析成内部的MethodHandler的处理方式。</p>
<p>从实现的代码中可以看到熟悉的Proxy.newProxyInstance方法产生代理类。而这里需要对  每个定义的接口方法进行特定的处理实现，所以这里会出现一个MethodHandler的概念，就是对应方法级别的InvocationHandler。</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public &lt;T&gt; T newInstance(Target&lt;T&gt; target) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //根据接口类和Contract协议解析方式，解析接口类上的方法和注解，转换成内部的MethodHandler处理方式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Map&lt;String, MethodHandler&gt; nameToHandler = this.[targetToHandlersByName.apply(target)];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Map&lt;Method, MethodHandler&gt; methodToHandler = new LinkedHashMap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;DefaultMethodHandler&gt; defaultMethodHandlers = new LinkedList();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Method[] var5 = target.type().getMethods();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int var6 = var5.length;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for(int var7 = 0; var7 &lt; var6; ++var7) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Method method = var5[var7];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (method.getDeclaringClass() != Object.class) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Util.isDefault(method)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                DefaultMethodHandler handler = new DefaultMethodHandler(method);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                defaultMethodHandlers.add(handler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                methodToHandler.put(method, handler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                methodToHandler.put(method,nameToHandler.get(Feign.configKey(target.type(), method)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    InvocationHandler handler = this.factory.create(target, methodToHandler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 基于Proxy.newProxyInstance 为接口类创建动态实现，将所有的请求转换给InvocationHandler 处理。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    T proxy = Proxy.newProxyInstance(target.type().getClassLoader(), new Class[]{target.type()}, handler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Iterator var12 = defaultMethodHandlers.iterator();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while(var12.hasNext()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefaultMethodHandler defaultMethodHandler = (DefaultMethodHandler)var12.next();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        defaultMethodHandler.bindTo(proxy);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return proxy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>2.4 接口定义的参数解析</strong>
根据FeignClient接口的描述解析出对应的请求数据。</p>
<p><strong>2.4.1 targetToHandlersByName.apply(target)</strong>
根据Contract协议规则，解析接口类的注解信息，解析成内部表现：</p>
<p>targetToHandlersByName.apply(target);会解析接口方法上的注解，从而解析出方法粒度的特定的配置信息，然后生产一个SynchronousMethodHandler 然后需要维护一个<code>&lt;method，MethodHandler&gt;</code>的map，放入InvocationHandler的实现FeignInvocationHandler中。</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public Map&lt;String, MethodHandler&gt; apply(Target target) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;MethodMetadata&gt; metadata = contract.parseAndValidateMetadata(target.type());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Map&lt;String, MethodHandler&gt; result = new LinkedHashMap&lt;String,MethodHandler&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (MethodMetadata md : metadata) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        BuildTemplateByResolvingArgs buildTemplate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!md.formParams().isEmpty() &amp;&amp; md.template().bodyTemplate() == null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            buildTemplate = new BuildFormEncodedTemplateFromArgs(md, encoder, queryMapEncoder,target);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (md.bodyIndex() != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            buildTemplate = new BuildEncodedTemplateFromArgs(md, encoder,queryMapEncoder, target);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            buildTemplate = new BuildTemplateByResolvingArgs(md, queryMapEncoder,target);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (md.isIgnored()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.put(md.configKey(), args -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new IllegalStateException(md.configKey() + &quot; is not a method handled by feign&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.put(md.configKey(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       factory.create(target, md, buildTemplate, options, decoder,errorDecoder));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>2.4.2 SpringMvcContract</strong>
当前Spring Cloud 微服务解决方案中，为了降低学习成本，采用了Spring MVC的部分注解来完成 请求议解析，也就是说 ，写客户端请求接口和像写服务端代码一样：客户端和服务端可以通过SDK的方式进行约定，客户端只需要引入服务端发布的SDK API，就可以使用面向接口的编码方式对接服务。</p>
<p>该类继承了Contract.BaseContract并实现了ResourceLoaderAware接口，</p>
<p>其作用就是对RequestMapping、RequestParam、RequestHeader等注解进行解析的。</p>
<p><strong>2.5 OpenFeign调用过程</strong>
在前面的分析中，我们知道OpenFeign最终返回的是一个#
ReflectiveFeign.FeignInvocationHandler的对象。</p>
<p>那么当客户端发起请求时，会进入到
FeignInvocationHandler.invoke方法中，这个大家都知道，它是一个动态代理的实现。</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!&quot;equals&quot;.equals(method.getName())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (&quot;hashCode&quot;.equals(method.getName())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return this.hashCode();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return &quot;toString&quot;.equals(method.getName()) ? this.toString() :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ((MethodHandler)this.dispatch.get(method)).invoke(args);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object otherHandler = args.length &gt; 0 &amp;&amp; args[0] != null ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Proxy.getInvocationHandler(args[0]) : null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return this.equals(otherHandler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (IllegalArgumentException var5) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>而接着，在invoke方法中，会调用 this.dispatch.get(method)).invoke(args) 。this.dispatch.get(method) 会返回一个SynchronousMethodHandler,进行拦截处理。</p>
<p>这个方法会根据参数生成完成的RequestTemplate对象，这个对象是Http请求的模版，代码如下。</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public Object invoke(Object[] argv) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RequestTemplate template = this.buildTemplateFromArgs.create(argv);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Options options = this.findOptions(argv);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Retryer retryer = this.retryer.clone();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while(true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return this.executeAndDecode(template, options);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (RetryableException var9) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            RetryableException e = var9;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                retryer.continueOrPropagate(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (RetryableException var8) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Throwable cause = var8.getCause();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (this.propagationPolicy == ExceptionPropagationPolicy.UNWRAP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &amp;&amp; cause != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw cause;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw var8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (this.logLevel != Level.NONE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.logger.logRetry(this.metadata.configKey(), this.logLevel);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>2.5.1 executeAndDecode</strong>
经过上述的代码，我们已经将restTemplate拼装完成，上面的代码中有一个 executeAndDecode() 方法，该方法通过RequestTemplate生成Request请求对象，然后利用Http Client获取response，来获取响应信息。</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">Object executeAndDecode(RequestTemplate template, Options options) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //转化为Http请求报文</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Request request = this.targetRequest(template);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (this.logLevel != Level.NONE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.logger.logRequest(this.metadata.configKey(), this.logLevel,request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    long start = System.nanoTime();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Response response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //发起远程通信</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        response = this.client.execute(request, options);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //获取返回结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        response = response.toBuilder().request(request).requestTemplate(template).build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (IOException var16) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.logLevel != Level.NONE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.logger.logIOException(this.metadata.configKey(), this.logLevel,var16, this.elapsedTime(start));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw FeignException.errorExecuting(request, var16);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    long elapsedTime = TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - start);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean shouldClose = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Response var10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.logLevel != Level.NONE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            response = this.logger.logAndRebufferResponse(this.metadata.configKey(), this.logLevel,response, elapsedTime);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Response.class != this.metadata.returnType()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Object var21;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (response.status() &gt;= 200 &amp;&amp; response.status() &lt; 300) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (Void.TYPE == this.metadata.returnType()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    var10 = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return var10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                result = this.decode(response);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                shouldClose = this.closeAfterDecode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                var21 = result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return var21;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (this.decode404 &amp;&amp; response.status() == 404 &amp;&amp; Void.TYPE != this.metadata.returnType()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                result = this.decode(response);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                shouldClose = this.closeAfterDecode;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                var21 = result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return var21;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw this.errorDecoder.decode(this.metadata.configKey(), response);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (response.body() == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            var10 = response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return var10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (response.body().length() != null &amp;&amp; (long)response.body().length() &lt;= 8192L) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            byte[] bodyData = Util.toByteArray(response.body().asInputStream());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Response var11 = response.toBuilder().body(bodyData).build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return var11;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        shouldClose = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var10 = response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (IOException var17) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (this.logLevel != Level.NONE) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.logger.logIOException(this.metadata.configKey(), this.logLevel,var17, elapsedTime);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw FeignException.errorReading(request, response, var17);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (shouldClose) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Util.ensureClosed(response.body());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return var10;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>2.5.2 Client.execute</strong>
默认采用JDK的 HttpURLConnection 发起远程调用。</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Response execute(Request request, Options options) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HttpURLConnection connection = convertAndSend(request, options);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return convertResponse(connection, request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Response convertResponse(HttpURLConnection connection, Request request) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int status = connection.getResponseCode();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String reason = connection.getResponseMessage();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (status &lt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IOException(format(&quot;Invalid status(%s) executing %s %s&quot;,status,connection.getRequestMethod(),connection.getURL()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Map&lt;String, Collection&lt;String&gt;&gt; headers = new LinkedHashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (Map.Entry&lt;String, List&lt;String&gt;&gt; field :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         connection.getHeaderFields().entrySet()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // response message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (field.getKey() != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            headers.put(field.getKey(), field.getValue());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Integer length = connection.getContentLength();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (length == -1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        length = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    InputStream stream;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (status &gt;= 400) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stream = connection.getErrorStream();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stream = connection.getInputStream();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Response.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .status(status)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .reason(reason)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .headers(headers)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .request(request)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .body(stream, length)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>参考文章</h1>
<p><a href="https://lijunyi.xyz/docs/SpringCloud/SpringCloud.html#_2-2-x-%E5%88%86%E6%94%AF" target="_blank" rel="noopener noreferrer">https://lijunyi.xyz/docs/SpringCloud/SpringCloud.html#_2-2-x-%E5%88%86%E6%94%AF</a>
<a href="https://mp.weixin.qq.com/s/2jeovmj77O9Ux96v3A0NtA" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s/2jeovmj77O9Ux96v3A0NtA</a>
<a href="https://juejin.cn/post/6931922457741770760" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6931922457741770760</a>
<a href="https://github.com/D2C-Cai/herring" target="_blank" rel="noopener noreferrer">https://github.com/D2C-Cai/herring</a>
<a href="http://c.biancheng.net/springcloud" target="_blank" rel="noopener noreferrer">http://c.biancheng.net/springcloud</a>
<a href="https://github.com/macrozheng/springcloud-learning" target="_blank" rel="noopener noreferrer">https://github.com/macrozheng/springcloud-learning</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Spring全家桶/SpringCloud源码分析/SpringCloudOpenFeign源码分析.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_EYjg" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_eevz"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudLoadBalancer源码分析"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Spring Cloud LoadBalancer</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudRibbon源码分析"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">SpringCloudRibbon源码分析</div></a></nav></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/code-note-blog/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/code-note-blog/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>