<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Spring全家桶/SpringCloud源码分析/SpringCloudRibbon源码分析" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.0">
<title data-rh="true">SpringCloudRibbon源码分析 | Tommy</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aiden-coding.github.io/code-note-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://aiden-coding.github.io/code-note-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudRibbon源码分析"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="SpringCloudRibbon源码分析 | Tommy"><meta data-rh="true" name="description" content="学习目标"><meta data-rh="true" property="og:description" content="学习目标"><link data-rh="true" rel="icon" href="/code-note-blog/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudRibbon源码分析"><link data-rh="true" rel="alternate" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudRibbon源码分析" hreflang="en"><link data-rh="true" rel="alternate" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudRibbon源码分析" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/code-note-blog/blog/rss.xml" title="Tommy RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/code-note-blog/blog/atom.xml" title="Tommy Atom Feed"><link rel="stylesheet" href="/code-note-blog/assets/css/styles.dd5372db.css">
<script src="/code-note-blog/assets/js/runtime~main.f999fb27.js" defer="defer"></script>
<script src="/code-note-blog/assets/js/main.a0bfbaed.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_XYiV" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/code-note-blog/"><b class="navbar__title text--truncate">Tommy</b></a><a class="navbar__item navbar__link" href="/code-note-blog/docs/Java/basic/抽象类和接口">java</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/JavaWeb/走进JavaWeb技术世界：JavaWeb的由来和基础知识">javaweb</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/cache/探索Redis设计与实现：连接底层与表面的数据结构robj">cache</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/backend/后端技术杂谈：白话虚拟化技术">backend</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/cs/algorithms/剑指offer">cs</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/database/重新学习MySQL数据库：『浅入浅出』MySQL和InnoDB">database</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/distributed/basic/分布式系统理论基础 ：CAP">distributed</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/interview/BATJ-Experience/面阿里,终获offer">interview</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/mq/kafka/消息队列kafka详解：如何实现死信队列">mq</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/code-note-blog/docs/Spring全家桶/Spring/第一个Spring应用">spring</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/mianshi/collection">面试</a><a href="https://aiden-coding.github.io/code-note-blog/SpringCloud%E7%AC%AC3%E5%AD%A32024.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="toggle_XbAW colorModeToggle_r5NY"><button class="clean-btn toggleButton_Jx0n toggleButtonDisabled_zYO7" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_FjAw"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_qmEt"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_wJfS"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_LABv"><div class="docsWrapper_pdvB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_Jioa" type="button"></button><div class="docRoot_qx_v"><aside class="theme-doc-sidebar-container docSidebarContainer_NHKT"><div class="sidebarViewport_uyYB"><div class="sidebar_SZG4"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_VP_k"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/Spring/第一个Spring应用">Spring</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：初探SpringIOC核心流程">Spring源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringBoot/给你一份SpringBoot知识清单">SpringBoot</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBoot启动流程（四）：启动IOC容器">SpringBoot源码解析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloud/SpringCloudConsul">SpringCloud</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudConfig源码分析">SpringCloud源码分析</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudConfig源码分析">SpringCloudConfig源码分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudEureka源码分析">SpringCloudEureka源码分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudGateway源码分析">SpringCloudGateway源码分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudHystrix源码分析">SpringCloudHystrix源码分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudLoadBalancer源码分析">Spring Cloud LoadBalancer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudOpenFeign源码分析">SpringCloudOpenFeign源码分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudRibbon源码分析">SpringCloudRibbon源码分析</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba/SpringCloudAlibaba概览">SpringCloudAlibaba</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba源码分析/SpringCloudAlibabaNacos源码分析：服  务发现">SpringCloudAlibaba源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringMVC/SpringMVC常见注解">SpringMVC</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/请求执行流程（二）之执行Handler方法">SpringMVC源码分析</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_SejT"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_j3Yw"><div class="docItemContainer_XOSC"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_F6gm" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/code-note-blog/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YCxa"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">SpringCloud源码分析</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">SpringCloudRibbon源码分析</span><meta itemprop="position" content="2"></li></ul></nav><div class="theme-doc-markdown markdown"><p><strong>学习目标</strong></p>
<ol>
<li>推导Ribbon的核心流程</li>
<li>手写一个简易版的Ribbon</li>
<li>通过源码验证推导的流程
<strong>第1章 核心流程推导</strong>
其实Ribbon的核心流程很简单，我们在使用过程中无非就是引入了一个spring-cloud-starter-netflix-ribbon的jar包，然后在程序启动的时候注入了一个RestTemplate对象，在该对象上面增加了一个@LoadBalanced注解，然后在通过RestTemplate对象去调用URL的时候就能根据不同的负载均衡策略去调不同的服务，那这个注解，或者说这个jar包到底做了什么事情呢？</li>
</ol>
<p>首先我们要明白，spring-cloud-starter-netflix-ribbon这个jar包从名字上来看就知道，它是基于starter组件的，那它肯定是依据springboot的自动装配原理，在容器启动的时候提供了一个自动配置类，将我们所需要用的对象注入到IoC容器里面去了，这点毋庸置疑。</p>
<p>然后当要用RestTemplate对象去请求目标服务的时候，这个时候，我们肯定是要用真实的IP和端口来替换服务名。这一步其实就是核心步骤，它要怎么做呢？怎么在真正请求之前将地址和端口狸猫换太子换成真实的呢？</p>
<p>在我们日常开发中，我们应该知道，有一个过滤器和一个拦截器其实可以做到这个操作，对吧，所以，实际上就是在获取RestTemplate对象的时候，将该对象里面添加了一个拦截器，当RestTemplate对象执行某个方法的时候，都会去拦截器里面执行一遍。然后就完事了。</p>
<p>具体的流程图推导如下：<img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/1790fb324161913dd79098940f8102d652cd86.jpg" alt="SpringCloud系列—Ribbon源码分析-开源基础软件社区" title="SpringCloud系列—Ribbon源码分析-开源基础软件社区" class="img_kGBN"><strong>第2章 简易版Ribbon实现</strong>
根据上面的推导过程，我们接下 来来实现一个简易版的Ribbon。</p>
<p>具体的步骤我们要有清晰的思路：</p>
<p>1.首先要实现一个starter组件，集成我们springboot，让springboot在启动的时候可以拿到相应的RestTemplate的bean对象。创建一个Maven的quickstart项目</p>
<p>2.然后引包</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;groupId&gt;com.example&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  myribbon-spring-cloud-starter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;name&gt;myribbon-spring-cloud-starter&lt;/name&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;!-- FIXME change it to the project&#x27;s website --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;url&gt;http://www.example.com&lt;/url&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;properties&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;spring-boot.version&gt;2.3.2.RELEASE&lt;/spring-boot.version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/properties&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;!-- RestTemplate必须要用到SpringMVC --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;dependencies&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      spring-boot-starter-web</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &lt;version&gt;${spring-boot.version}&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      spring-boot-starter-test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &lt;version&gt;${spring-boot.version}&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;!-- 这个包里面集成了一些核心接口 --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      spring-cloud-commons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &lt;version&gt;2.2.6.RELEASE&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/dependencies&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;build&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;pluginManagement&gt;&lt;!-- lock down plugins versions to avoid using Maven defaults (may be moved to parent pom) --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &lt;plugins&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- clean lifecycle, see https://maven.apache.org/ref/current/maven-core/lifecycles.html#clean_Lifecycle --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;plugin&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          maven-clean-plugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &lt;version&gt;3.1.0&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/plugin&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- default lifecycle, jar packaging: see https://maven.apache.org/ref/current/maven-core/default-bindings.html#Plugin_bindings_for_jar_packaging --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;plugin&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          maven-resources-plugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &lt;version&gt;3.0.2&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/plugin&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;plugin&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          maven-compiler-plugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &lt;version&gt;3.8.0&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/plugin&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;plugin&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          maven-surefire-plugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &lt;version&gt;2.22.1&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/plugin&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;plugin&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          maven-jar-plugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &lt;version&gt;3.0.2&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/plugin&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;plugin&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          maven-install-plugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &lt;version&gt;2.5.2&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/plugin&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;plugin&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          maven-deploy-plugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &lt;version&gt;2.8.2&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/plugin&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!-- site lifecycle, see https://maven.apache.org/ref/current/maven-core/lifecycles.html#site_Lifecycle --&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;plugin&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          maven-site-plugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &lt;version&gt;3.7.1&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/plugin&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;plugin&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          maven-project-info-reports-plugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &lt;version&gt;3.0.0&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/plugin&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &lt;/plugins&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/pluginManagement&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/build&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/project&gt;</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>3.创建配置类</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyRibbonAutoConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //简易版的Ribbon是靠这个类去完成负载均衡算法以及真实的ip和端口替换的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public LoadBalancerClient loadBalancerClient(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new MyLoadBalancerClient();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //收集所有带MyLoadBalanced注解的RestTemplate对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @MyLoadBalanced</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired(required = false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private List&lt;RestTemplate&gt; restTemplates = Collections.emptyList();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnMissingBean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public LoadBalancerRequestFactory loadBalancerRequestFactory(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LoadBalancerClient loadBalancerClient) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new LoadBalancerRequestFactory(loadBalancerClient);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //这就是核心的拦截器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public MyLoadBalancerInterceptor myLoadBalancerInterceptor(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LoadBalancerClient loadBalancerClient,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LoadBalancerRequestFactory requestFactory){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new MyLoadBalancerInterceptor(loadBalancerClient,requestFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //收集到的RestTemplate对象，在这里都会配置一个拦截器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SmartInitializingSingleton smartInitializingSingleton(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            final MyLoadBalancerInterceptor myLoadBalancerInterceptor){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ()-&gt;{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (RestTemplate restTemplate : MyRibbonAutoConfiguration.this.restTemplates) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;ClientHttpRequestInterceptor&gt; list = new ArrayList&lt;&gt;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        restTemplate.getInterceptors());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                list.add(myLoadBalancerInterceptor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                restTemplate.setInterceptors(list);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>4.创建MyLoadBalancerClient</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class MyLoadBalancerClient implements LoadBalancerClient {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AbstractEnvironment environment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //1.在拦截器里面会调用这个方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public &lt;T&gt; T execute(String serviceId, LoadBalancerRequest&lt;T&gt; request) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ServiceInstance server = this.choose(serviceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return execute(serviceId, server, request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //3.真正执行Http请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public &lt;T&gt; T execute(String serviceId, ServiceInstance serviceInstance, LoadBalancerRequest&lt;T&gt; request) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T returnVal = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            returnVal = request.apply(serviceInstance);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return returnVal;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	//4.这一步就是用真实的ip和port替换服务名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public URI reconstructURI(ServiceInstance instance, URI original) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String host = instance.getHost();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int port = instance.getPort();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (host.equals(original.getHost())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &amp;&amp; port == original.getPort()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return original;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            StringBuilder sb = new StringBuilder();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sb.append(&quot;http&quot;).append(&quot;://&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!Strings.isNullOrEmpty(original.getRawUserInfo())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sb.append(original.getRawUserInfo()).append(&quot;@&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sb.append(host);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (port &gt;= 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sb.append(&quot;:&quot;).append(port);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sb.append(original.getRawPath());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!Strings.isNullOrEmpty(original.getRawQuery())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sb.append(&quot;?&quot;).append(original.getRawQuery());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!Strings.isNullOrEmpty(original.getRawFragment())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                sb.append(&quot;#&quot;).append(original.getRawFragment());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            URI newURI = new URI(sb.toString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return newURI;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }catch (URISyntaxException e){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new RuntimeException(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //2.负载均衡算法在这一步进行服务的ip和端口选择，我这里用的是随机算法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ServiceInstance choose(String serviceId) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Server instance = new Server(serviceId,null,&quot;127.0.0.1&quot;,8080);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String sr = environment.getProperty(serviceId+&quot;.ribbon.listOfServers&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!StringUtils.isEmpty(sr)){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String[] arr = sr.split(&quot;,&quot;,-1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Random selector = new Random();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int next = selector.nextInt(arr.length);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String a = arr[next];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String[] srr = a.split(&quot;:&quot;,-1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            instance.setHost(srr[0]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            instance.setPort(Integer.parseInt(srr[1]));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return instance;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>5.拦截器的逻辑其实很简单，就是在真正发送http请求之前先来执行我的逻辑</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class MyLoadBalancerInterceptor implements ClientHttpRequestInterceptor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private LoadBalancerClient loadBalancerClient;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private LoadBalancerRequestFactory requestFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public MyLoadBalancerInterceptor(LoadBalancerClient loadBalancerClient,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                   LoadBalancerRequestFactory requestFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.loadBalancerClient = loadBalancerClient;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.requestFactory = requestFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ClientHttpResponse intercept(HttpRequest request, byte[] body, ClientHttpRequestExecution execution) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final URI originalUri = request.getURI();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String serviceName = originalUri.getHost();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.loadBalancerClient.execute(serviceName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.requestFactory.createRequest(request, body, execution));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>6.定义自己的注解</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Target({ ElementType.FIELD, ElementType.PARAMETER, ElementType.METHOD })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Documented</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Inherited</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Qualifier</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface MyLoadBalanced {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>7.定义一个自己的Server实体类</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public class Server implements ServiceInstance {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String serviceId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String instanceId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String host;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int port;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Server(String serviceId, String instanceId, String host, int port) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.serviceId = serviceId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.instanceId = instanceId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.host = host;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.port = port;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Server() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setServiceId(String serviceId) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.serviceId = serviceId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setInstanceId(String instanceId) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.instanceId = instanceId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setHost(String host) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.host = host;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setPort(int port) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.port = port;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getInstanceId() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getServiceId() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getHost() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return host;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int getPort() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return port;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean isSecure() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public URI getUri() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Map&lt;String, String&gt; getMetadata() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getScheme() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>8.写spring.factories文件</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    com.example.config.MyRibbonAutoConfiguration</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>9.打成jar包，测试，测试的时候，需要加配置文件</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;serverName&gt;.ribbon.listOfServers=127.0.0.1:2223,127.0.0.1:2222</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>第3章 源码验证</strong>
<strong>3.1 @LoadBalanced</strong>
从上节课的代码看，我们只是在RestTemplate上面加了一个@LoadBalance,就可以实现负载均衡了，可是我们点击进入@LoadBalance看了一下，在这个注解里面有一个@Qualifier注解。该注解限定哪个bean应该被自动注入。当Spring无法判断出哪个bean应该被注入时，@Qualifier注解有助于消除歧义bean的自动注入，例子见代码。</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Annotation to mark a RestTemplate or WebClient bean to be configured to use a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * LoadBalancerClient.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @author Spencer Gibb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Target({ ElementType.FIELD, ElementType.PARAMETER, ElementType.METHOD })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Retention(RetentionPolicy.RUNTIME)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Documented</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Inherited</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Qualifier</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public @interface LoadBalanced {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>从注释中可以知道，这个注解是用来给RestTemplate做标记，以使用负载均衡客户端（LoadBalancerClient）来配置它。所以，我们在生成的RestTemplate的bean上添加这么一个注解，这个bean就会配置LoadBalancerClient。</p>
<p><strong>3.2 LoadBalancerClient</strong>
那么，就再看下LoadBalancerClient的代码：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public interface LoadBalancerClient extends ServiceInstanceChooser {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	&lt;T&gt; T execute(String serviceId, LoadBalancerRequest&lt;T&gt; request) throws IOException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	&lt;T&gt; T execute(String serviceId, ServiceInstance serviceInstance,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			LoadBalancerRequest&lt;T&gt; request) throws IOException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	URI reconstructURI(ServiceInstance instance, URI original);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface ServiceInstanceChooser {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ServiceInstance choose(String serviceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>LoadBalancerClient是一个接口，里面有三个方法。</p>
<p>ServiceInstance choose(String serviceId);从方法名上就可以看出，是根据传入的serviceId（服务名），从负载均衡器中选择一个服务实例，服务实例通过ServiceInstance类来表示。
execute方法，使用从负载均衡器中选择的服务实例来执行请求内容。
URI reconstructURI(ServiceInstance instance, URI original);方法，是重新构建一个URI的，还记得我们在代码中，通过RestTemplate请求服务时，写的是服务名吧，这个方法就会把这个请求的URI进行转换，返回host+port，通过host+port的形式去请求服务。
<strong>3.3 自动装配</strong>
当springboot启动之后，会通过自动装配自动去
spring-cloud-netflix-ribbon这个jar包的META-INF目录找spring.factories文件，并且将RibbonAutoConfiguration配置类进行注入。而在RibbonAutoConfiguration配置类中因为存在@AutoConfigureBefore注解，所以又会加载LoadBalancerAutoConfiguration配置类。在LoadBalancerAutoConfiguration类中，spring容器会将所有被@LoadBalance注解修饰的bean注入到IOC容器中</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@LoadBalanced</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Autowired(required = false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private List&lt;RestTemplate&gt; restTemplates = Collections.emptyList();</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>同时，在LoadBalancerAutoConfiguration配置类中还会为每个RestTemplate实例添加LoadBalancerInterceptor拦截器。</p>
<p>在RibbonAutoConfiguration类中注入了LoadBalancerClient接口的实现类RibbonLoadBalancerClient</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnMissingBean(LoadBalancerClient.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public LoadBalancerClient loadBalancerClient() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new RibbonLoadBalancerClient(springClientFactory());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>3.4 拦截器</strong>
由于在自动配置类中，对restTemplate实例添加了LoadBalancerInterceptor拦截器，所以，当用restTemplate发送http请求时，就会执行这个拦截器的intercept方法。</p>
<p>intercept方法中，会根据request.getURI()，获取请求的uri，再获取host，我们在发送http请求的时候，是用的服务名作为host，所以，这里就会拿到服务名，再调用具体LoadBalancerClient实例的execute方法，发送请求。</p>
<p>LoadBalancerClient的实现类为RibbonLoadBalancerClient，最终的负载均衡请求由它来执行，所以，还需要再梳理下RibbonLoadBalancerClient的逻辑。</p>
<p>先看下RibbonLoadBalancerClient中的execute方法：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public &lt;T&gt; T execute(String serviceId, LoadBalancerRequest&lt;T&gt; request, Object hint)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ILoadBalancer loadBalancer = getLoadBalancer(serviceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Server server = getServer(loadBalancer, hint);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (server == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;No instances available for &quot; + serviceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RibbonServer ribbonServer = new RibbonServer(serviceId, server,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                 isSecure(server, serviceId),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                 serverIntrospector(serviceId).getMetadata(server));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return execute(serviceId, ribbonServer, request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public &lt;T&gt; T execute(String serviceId, ServiceInstance serviceInstance,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     LoadBalancerRequest&lt;T&gt; request) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Server server = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (serviceInstance instanceof RibbonServer) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        server = ((RibbonServer) serviceInstance).getServer();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (server == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new IllegalStateException(&quot;No instances available for &quot; + serviceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RibbonLoadBalancerContext context = this.clientFactory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .getLoadBalancerContext(serviceId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RibbonStatsRecorder statsRecorder = new RibbonStatsRecorder(context, server);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T returnVal = request.apply(serviceInstance);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        statsRecorder.recordStats(returnVal);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return returnVal;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // catch IOException and rethrow so RestTemplate behaves correctly</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catch (IOException ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        statsRecorder.recordStats(ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw ex;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catch (Exception ex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        statsRecorder.recordStats(ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ReflectionUtils.rethrowRuntimeException(ex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>服务名作为serviceId字段传进来，先通过getLoadBalancer获取loadBalancer，再根据loadBalancer获取server，下面是getServer的代码：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">protected Server getServer(ILoadBalancer loadBalancer, Object hint) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (loadBalancer == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Use &#x27;default&#x27; on a null hint, or just pass it on?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return loadBalancer.chooseServer(hint != null ? hint : &quot;default&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果loadBalancer为空，就直接返回空，否则就调用loadBalancer的chooseServer方法，获取相应的server。</p>
<p>看一下ILoadBalancer是一个接口，里面声明了一系列负载均衡实现的方法：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public interface ILoadBalancer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	public void addServers(List&lt;Server&gt; newServers);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	public Server chooseServer(Object key);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	public void markServerDown(Server server);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	@Deprecated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	public List&lt;Server&gt; getServerList(boolean availableOnly);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;Server&gt; getReachableServers();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	public List&lt;Server&gt; getAllServers();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这些方法名比较直观，很容易就能猜出是干啥的，addServers是用来添加一个server集合，chooseServer是选择一个server，markServerDown用来标记某个服务下线，getReachableServers获取可用的Server集合，getAllServers是获取所有的server集合。
ILoadBalancer有很多实现，那具体是用的哪个类呢，在RibbonAutoConfiguration类中注入SpringClientFactory，通过RibbonClientConfiguration类看到，这个配置类在初始化的时候，返回了ZoneAwareLoadBalancer作为负载均衡器。</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnMissingBean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public ILoadBalancer ribbonLoadBalancer(IClientConfig config,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        ServerList&lt;Server&gt; serverList, ServerListFilter&lt;Server&gt; serverListFilter,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        IRule rule, IPing ping, ServerListUpdater serverListUpdater) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (this.propertiesFactory.isSet(ILoadBalancer.class, name)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.propertiesFactory.get(ILoadBalancer.class, config, name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new ZoneAwareLoadBalancer&lt;&gt;(config, rule, ping, serverList,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       serverListFilter, serverListUpdater);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>3.5 ZoneAwareLoadBalancer</strong>
ZoneAwareLoadBalancer从名字中可以看出来，这个负载均衡器和zone是有关系的。下面看下ZoneAwareLoadBalancer中的chooseServer方法：</p>
<blockquote>
<p>eureka提供了region和zone两个概念来进行分区，这两个概念均来自于亚马逊的AWS：
region：可以简单理解为地理上的分区，比如亚洲地区，或者华北地区，再或者北京等等，没有具体大小的限制。根据项目具体的情况，可以自行合理划分region。
zone：可以简单理解为region内的具体机房，比如说region划分为北京，然后北京有两个  机房，就可以在此region之下划分出zone1,zone2两个zone。</p>
</blockquote>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Server chooseServer(Object key) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //只有当负载均衡器中维护的实例所属的Zone区域的个数大于1的时候才会执行选择策略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //否则还是使用父类的实现</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!ENABLED.get() || getLoadBalancerStats().getAvailableZones().size() &lt;= 1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.debug(&quot;Zone aware logic disabled or there is only one zone&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return super.chooseServer(key);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Server server = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LoadBalancerStats lbStats = getLoadBalancerStats();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //为当前负载均衡器中的所有Zone区域分别创建快照，保存在zoneSnapshot中，这些快照中的数据用于后续的算法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, ZoneSnapshot&gt; zoneSnapshot = ZoneAvoidanceRule.createSnapshot(lbStats);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.debug(&quot;Zone snapshots: {}&quot;, zoneSnapshot);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (triggeringLoad == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            triggeringLoad = DynamicPropertyFactory.getInstance().getDoubleProperty(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ZoneAwareNIWSDiscoveryLoadBalancer.&quot; + this.getName() + &quot;.triggeringLoadPerServerThreshold&quot;, 0.2d);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (triggeringBlackoutPercentage == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            triggeringBlackoutPercentage = DynamicPropertyFactory.getInstance().getDoubleProperty(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;ZoneAwareNIWSDiscoveryLoadBalancer.&quot; + this.getName() + &quot;.avoidZoneWithBlackoutPercetage&quot;, 0.99999d);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //获得可用Zone区域的集合，getAvailableZones会通过zoneSnapshot实现可用区域挑选</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Set&lt;String&gt; availableZones = ZoneAvoidanceRule.getAvailableZones(zoneSnapshot, triggeringLoad.get(), triggeringBlackoutPercentage.get());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.debug(&quot;Available zones: {}&quot;, availableZones);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (availableZones != null &amp;&amp;  availableZones.size() &lt; zoneSnapshot.keySet().size()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //随机选择一个Zone区域</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String zone = ZoneAvoidanceRule.randomChooseZone(zoneSnapshot, availableZones);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger.debug(&quot;Zone chosen: {}&quot;, zone);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (zone != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //获得对应区域的负载均衡器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                BaseLoadBalancer zoneLoadBalancer = getLoadBalancer(zone);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //选择具体的服务实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //在chooseServer中将会使用IRule接口的choose函数来选择具体服务实例。在这里，IRule接口的实现会实现ZoneAvoidanceRule来挑选具体的服务实例。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                server = zoneLoadBalancer.chooseServer(key);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.error(&quot;Error choosing server using zone aware logic for load balancer={}&quot;, name, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (server != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return server;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        logger.debug(&quot;Zone avoidance logic is not invoked.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return super.chooseServer(key);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个方法会根据server的zone和可用性来选择具体的实例，返回一个Server对象。</p>
<p>这个类里面的几个方法：</p>
<ol>
<li>setServerListForZones : 这个基于Zone进行服务划分</li>
<li>chooseServer这里也是主要跟zone有关的计算，当然默认的Zone只有一个，所以直接是调用的父类的chooseServer（key)</li>
<li>getLoadBalancer(String zone) 基于zone去获取LoadBalancer</li>
<li>setRule(IRule rule) 为每个负载均衡器设置规则。
这里可以看到，其实这个主要是针对Zone做了一些分类处理，就是将原来属于同一服务的服务实例，再根据地区进行划分。这也是为了能够快速响应而设置的。</li>
</ol>
<p><strong>3.5.1 DynamicServerListLoadBalancer</strong></p>
<blockquote>
<p>ZoneAwareLoadBalancer的父类</p>
</blockquote>
<p>这个类按照名称来说就是动态加载服务列表使用的。其中有几个比较重要的方法</p>
<ol>
<li>updateListOfServers:服务列表并更新本地缓存的服务列表</li>
<li>enableAndInitLearnNewServersFeature:开启服务列表更新定时任务</li>
<li>开启监听:@Monitor</li>
</ol>
<p>DynamicServerListLoadBalancer的核心就是获取服务列表，在Eureka中默认是通过DomainExtractingServerList来获取，这个类是在org.springframework.cloud.netflix.ribbon.eureka.EurekaRibbonClientConfiguration#ribbonServerList，这里没有集成Eureka，暂时不讲</p>
<p><strong>3.5.2 BaseLoadBalancer</strong></p>
<blockquote>
<p>DynamicServerListLoadBalancer的父类</p>
</blockquote>
<p>核心默认值</p>
<ul>
<li>默认的负载均衡策略RoundRobinRule</li>
<li>默认的Ping策略SerialPingStrategy</li>
<li>所有服务实例容器：allServerList</li>
<li>在线服务实例容器：upServerList
<img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/b2db0bc66c3045288a762907ff72e01883bf20.jpg" alt="SpringCloud系列—Ribbon源码分析-开源基础软件社 区" title="SpringCloud系列—Ribbon源码分析-开源基础软件社区" class="img_kGBN">从子类构造中将对应的负载均衡规则，ping策略，ping等传递过来</li>
</ul>
<p><strong>ping做了些什么？</strong></p>
<p>PingTask作为一个线程任务，就是定期检查服务是否都存活，跟ServerListUpdater服务更新机制不冲突。这是ribbon自己维护的一套服务检测机制，主要是为了降低访问失败的概率。默认在使用eureka时，ping是使用的是NIWSDiscoveryPing来完成服务保活检测。由eureka 和 ServerListUpdater来刷新服务列表。<img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/27db4c518aa7c100d427761832a9fa19fa8f04.jpg" alt="SpringCloud系列—Ribbon源码分析-开源基础软件社区" title="SpringCloud系列—Ribbon源码分析-开源基础软件社区" class="img_kGBN">这里有个常用的定时任务快速退出的方法，我觉得在我们自己写的时候也可以使用。</p>
<p>就是在同一个定时任务如果执行时间超过了定时周期，那么下一个定时任务发现上一个定时任务还没有执行完时，就先取消。<img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/f2d669b11f17530d2e62603d45949e934a5931.jpg" alt="SpringCloud系列—Ribbon源码分析-开源基础软件社区" title="SpringCloud系列—Ribbon源码分析-开源基础软件社区" class="img_kGBN">这里也用了很多锁机制，比如所有服务实例到一个新的对象时使用的是读锁，就是告诉allServers现在只能读不能写。<img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/711c81e67b2c1cd3fb91005f53ea1e1352ad9a.png" alt="SpringCloud系列—Ribbon源码分析-开源基础软件社区" title="SpringCloud系列—Ribbon源码分析-开源基础软件社区" class="img_kGBN">在发送ping后，将检测通过的服务放入newUpList中，最后通过写锁，将upServerList锁住。</p>
<p>这里就是只能有一个写，且不能读。<img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/047543857174aa1130b0747d1d149ffd6d5632.jpg" alt="SpringCloud系列—Ribbon源码分析-开源基础软件社区" title="SpringCloud系列—Ribbon源码分析-开源基础软件社区" class="img_kGBN">上面是ping在检测过程中关于读写锁和原子类的使用。</p>
<p>主要流程就是：</p>
<ol>
<li>读取全部服务实例列表</li>
<li>检测服务实例是否存活pingServers</li>
<li>将服务状态发生改变的放入changedServers</li>
<li>将服务在线的放入newUpList</li>
<li>将newUpList赋值到upServerList 在线服务实例列表中</li>
</ol>
<p>这里面pingServers就是检查心跳的</p>
<p><strong>BaseLoadBalancer的其他功能简述</strong></p>
<ol>
<li>对allServerList和upServerList的读写锁方法</li>
<li>提供对allServerList和upServerList的增删改功能</li>
<li>提供了PingTask（ping的定时任务），Pinger（ping的执行器）</li>
<li>基于负载均衡策略选择服务rule.choose(key)</li>
<li>提供默认的ping策略SerialPingStrategy
<strong>3.6 LoadBalancerRequest</strong>
通过ZoneAwareLoadBalancer选择具体的Server之后，再包装成RibbonServer对象，之前返回的server是该对象中的一个字段，除此之外，还有服务名serviceId，是否需要使用https等信息。最后，通过LoadBalancerRequest的apply方法，向具体的server发请求，从而实现了负载均衡。</li>
</ol>
<p>下面是apply方法的定义：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public interface LoadBalancerRequest&lt;T&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    T apply(ServiceInstance instance) throws Exception;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在请求时，传入的ribbonServer对象，被当成ServiceInstance类型的对象进行接收。ServiceInstance是一个接口，定义了服务治理系统中，每个实例需要提供的信息，比如serviceId，host，port等。</p>
<p>LoadBalancerRequest是一个接口，最终会通过实现类的apply方法去执行，实现类是在LoadBalancerInterceptor中调用RibbonLoadBalancerClient的execute方法时，传进来的一个匿名类，可以通过查看LoadBalancerInterceptor的代码看到。</p>
<p>创建LoadBalancerRequest匿名类的时候，就重写了apply方法，apply方法中，还新建了一个ServiceRequestWrapper的内部类，这个类中，就重写了getURI方法，getURI方法会调用loadBalancer的reconstructURI方法来构建uri。</p>
<p>看到这里，已经可以大体知道Ribbon实现负载均衡的流程了，我们在RestTemplate上添加注解，就会有LoadBalancerClient的对象来配置它，也就是RibbonLoadBalancerClient。同时，
LoadBalancerAutoConfiguration会进行配置，创建一个LoadBalancerInterceptor，并且拿到我们声明的所有restTemplate，在这些restTemplate中添加LoadBalancerInterceptor拦截器。</p>
<p>当通过restTemplate发送请求时，就会经过这个拦截器，在拦截器中，就会调用RibbonLoadBalancerClient中的方法，获取到根据服务名，通过负载均衡方法获取到服务实例，然后去请求这个实例。</p>
<p><strong>3.7 获取服务列表</strong>
上面说的这些，是如何对请求进行负载均衡的，但是还有个问题，我们请求的实例，是从Eureka Server上获取到的，那这个实例列表是如何获取的呢？怎么保证这个实例列表中的实例是可用的呢？</p>
<p>在RibbonLoadBalancerClient选择实例的时候，是通过ILoadBalancer的实现类根据负载均衡算法选择服务实例的，也就是ZoneAwareLoadBalancer的chooseServer中的逻辑，那就在这里找线索。查看ZoneAwareLoadBalancer的继承关系，可以看到如下图所示。<img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/425d8ff567d9ac6171f6036dab1726a7da04a3.jpg" alt="SpringCloud系列—Ribbon源码分析-开源基础软件社区" title="SpringCloud系列—Ribbon源码分析-开源基础软件社区" class="img_kGBN">可以看到，最上面是ILoadBalancer接口，AbstractLoadBalancer类继承了这个接口，BaseLoadBalancer继承了AbstractLoadBalancer类，
DynamicServerListLoadBalancer继承了BaseLoadBalancer，ZoneAwareLoadBalancer继承了DynamicServerListLoadBalancer。</p>
<p>ILoadBalancer接口的代码已经看过了，现在看下AbstractLoadBalancer的代码：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractLoadBalancer implements ILoadBalancer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public enum ServerGroup{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ALL,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        STATUS_UP,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        STATUS_NOT_UP        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * delegate to {@link #chooseServer(Object)} with parameter null.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Server chooseServer() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    	return chooseServer(null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * List of servers that this Loadbalancer knows about</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param serverGroup Servers grouped by status, e.g., {@link ServerGroup#STATUS_UP}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public abstract List&lt;Server&gt; getServerList(ServerGroup serverGroup);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Obtain LoadBalancer related Statistics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public abstract LoadBalancerStats getLoadBalancerStats();    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这是一个抽象类，里面加了一个枚举，增加了两个抽象方法。定义的chooseServer方法。</p>
<p>下面再看BaseLoadBalancer类，BaseLoadBalancer类就算是负载均衡器的一个基础实现类，在里面可以看到定义了两个list：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Monitor(name = PREFIX + &quot;AllServerList&quot;, type = DataSourceType.INFORMATIONAL)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected volatile List&lt;Server&gt; allServerList = Collections</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .synchronizedList(new ArrayList&lt;Server&gt;());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Monitor(name = PREFIX + &quot;UpServerList&quot;, type = DataSourceType.INFORMATIONAL)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected volatile List&lt;Server&gt; upServerList = Collections</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .synchronizedList(new ArrayList&lt;Server&gt;());</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>从名字上看，这就是维护所有服务的实例列表，和维护状态为up的实例列表。
而且还可以看到BaseLoadBalancer中实现的ILoadBalancer接口中的方法，比如下面这两个，获取可用的服务列表，就会把upServerList返回，获取所有的服务列表，就会把allServerList返回。</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public List&lt;Server&gt; getReachableServers() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Collections.unmodifiableList(upServerList);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public List&lt;Server&gt; getAllServers() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Collections.unmodifiableList(allServerList);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接下来，再看DynamicServerListLoadBalancer类。从类头上的注释可以知道，这个类可以动态的获取服务列表，并且利用filter对服务列表进行过滤。</p>
<p>在DynamicServerListLoadBalancer类中，能看到定义了一个ServerList类型的serverListImpl字段，ServerList是一个接口，里面有两个方法：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public interface ServerList&lt;T extends Server&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;T&gt; getInitialListOfServers();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Return updated list of servers. This is called say every 30 secs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * (configurable) by the Loadbalancer&#x27;s Ping cycle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;T&gt; getUpdatedListOfServers();   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>getInitialListOfServers是获取初始化的服务列表。
getUpdatedListOfServers是获取更新的服务列表。
ServerList有多个实现类，具体用的哪个呢，可以在
EurekaRibbonClientConfiguration类中找到，这是Ribbon和Eureka结合的自动配置类，但是目前我们没有整合Eureka，是通过配置文件配置，所以会走ConfigurationBasedServerList类。</p>
<h1>参考文章</h1>
<p><a href="https://lijunyi.xyz/docs/SpringCloud/SpringCloud.html#_2-2-x-%E5%88%86%E6%94%AF" target="_blank" rel="noopener noreferrer">https://lijunyi.xyz/docs/SpringCloud/SpringCloud.html#_2-2-x-%E5%88%86%E6%94%AF</a>
<a href="https://mp.weixin.qq.com/s/2jeovmj77O9Ux96v3A0NtA" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s/2jeovmj77O9Ux96v3A0NtA</a>
<a href="https://juejin.cn/post/6931922457741770760" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6931922457741770760</a>
<a href="https://github.com/D2C-Cai/herring" target="_blank" rel="noopener noreferrer">https://github.com/D2C-Cai/herring</a>
<a href="http://c.biancheng.net/springcloud" target="_blank" rel="noopener noreferrer">http://c.biancheng.net/springcloud</a>
<a href="https://github.com/macrozheng/springcloud-learning" target="_blank" rel="noopener noreferrer">https://github.com/macrozheng/springcloud-learning</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Spring全家桶/SpringCloud源码分析/SpringCloudRibbon源码分析.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_EYjg" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_eevz"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudOpenFeign源码分析"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">SpringCloudOpenFeign 源码分析</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba/SpringCloudAlibaba概览"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">SpringCloudAlibaba概览</div></a></nav></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/code-note-blog/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/code-note-blog/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>