<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Spring全家桶/SpringCloudAlibaba源码分析/SpringCloudRocketMQ源码分析" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.0">
<title data-rh="true">SpringCloudRocketMQ源码分析 | Tommy</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aiden-coding.github.io/code-note-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://aiden-coding.github.io/code-note-blog/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba源码分析/SpringCloudRocketMQ源码分析"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="SpringCloudRocketMQ源码分析 | Tommy"><meta data-rh="true" name="description" content="一、NameServer启动"><meta data-rh="true" property="og:description" content="一、NameServer启动"><link data-rh="true" rel="icon" href="/code-note-blog/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba源码分析/SpringCloudRocketMQ源码分析"><link data-rh="true" rel="alternate" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba源码分析/SpringCloudRocketMQ源码分析" hreflang="en"><link data-rh="true" rel="alternate" href="https://aiden-coding.github.io/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba源码分析/SpringCloudRocketMQ源码分析" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/code-note-blog/blog/rss.xml" title="Tommy RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/code-note-blog/blog/atom.xml" title="Tommy Atom Feed"><link rel="stylesheet" href="/code-note-blog/assets/css/styles.dd5372db.css">
<script src="/code-note-blog/assets/js/runtime~main.f999fb27.js" defer="defer"></script>
<script src="/code-note-blog/assets/js/main.a0bfbaed.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_XYiV" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/code-note-blog/"><b class="navbar__title text--truncate">Tommy</b></a><a class="navbar__item navbar__link" href="/code-note-blog/docs/Java/basic/抽象类和接口">java</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/JavaWeb/走进JavaWeb技术世界：JavaWeb的由来和基础知识">javaweb</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/cache/探索Redis设计与实现：连接底层与表面的数据结构robj">cache</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/backend/后端技术杂谈：白话虚拟化技术">backend</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/cs/algorithms/剑指offer">cs</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/database/重新学习MySQL数据库：『浅入浅出』MySQL和InnoDB">database</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/distributed/basic/分布式系统理论基础 ：CAP">distributed</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/interview/BATJ-Experience/面阿里,终获offer">interview</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/mq/kafka/消息队列kafka详解：如何实现死信队列">mq</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/code-note-blog/docs/Spring全家桶/Spring/第一个Spring应用">spring</a><a class="navbar__item navbar__link" href="/code-note-blog/docs/mianshi/collection">面试</a><a href="https://aiden-coding.github.io/code-note-blog/SpringCloud%E7%AC%AC3%E5%AD%A32024.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><div class="toggle_XbAW colorModeToggle_r5NY"><button class="clean-btn toggleButton_Jx0n toggleButtonDisabled_zYO7" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_FjAw"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_qmEt"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_wJfS"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_LABv"><div class="docsWrapper_pdvB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_Jioa" type="button"></button><div class="docRoot_qx_v"><aside class="theme-doc-sidebar-container docSidebarContainer_NHKT"><div class="sidebarViewport_uyYB"><div class="sidebar_SZG4"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_VP_k"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/Spring/第一个Spring应用">Spring</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/Spring源码分析/Spring源码剖析：初探SpringIOC核心流程">Spring源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringBoot/给你一份SpringBoot知识清单">SpringBoot</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringBoot源码解析/SpringBoot启动流程（四）：启动IOC容器">SpringBoot源码解析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloud/SpringCloudConsul">SpringCloud</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloud源码分析/SpringCloudConfig源码分析">SpringCloud源码分析</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba/SpringCloudAlibaba概览">SpringCloudAlibaba</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/code-note-blog/docs/Spring全家 桶/SpringCloudAlibaba源码分析/SpringCloudAlibabaNacos源码分析：服务发现">SpringCloudAlibaba源码分析</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba源码分析/SpringCloudAlibabaNacos源码分析：服务发现">一、Nacos服务发现流程图</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba源码分析/SpringCloudAlibabaNacos源码分析：服务注册">一、 Nacos服务注册源码解析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba源码分析/SpringCloudAlibabaNacos源码分析：概览">SpringCloudAlibabaNacos源码分析：概览</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba源码分析/SpringCloudAlibabaNacos源码分析：配置中心">Nacos配置中心</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba源码分析/SpringCloudRocketMQ源码分析">SpringCloudRocketMQ源码分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba源码分析/SpringCloudSeata源码分析">SpringCloudSeata源码分析</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba源码分析/SpringCloudSentinel源码分析">SpringCloudSentinel源码分析</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringMVC/SpringMVC常见注解">SpringMVC</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/code-note-blog/docs/Spring全家桶/SpringMVC源码分析/请求执行流程（二）之执行Handler方法">SpringMVC源码分析</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_SejT"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_j3Yw"><div class="docItemContainer_XOSC"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_F6gm" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/code-note-blog/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YCxa"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">SpringCloudAlibaba源码分析</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">SpringCloudRocketMQ源码分析</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ToOY theme-doc-toc-mobile tocMobile_suYB"><button type="button" class="clean-btn tocCollapsibleButton_VzP_">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>SpringCloudRocketMQ源码分析</h1></header><h3 class="anchor anchorWithStickyNavbar_HWLp" id="一nameserver启动">一、NameServer启动<a href="#一nameserver启动" class="hash-link" aria-label="Direct link to 一、NameServer启动" title="Direct link to 一、NameServer启动">​</a></h3>
<p>源码入口：NamesrvStartup#main</p>
<h5 class="anchor anchorWithStickyNavbar_HWLp" id="1namesrvcontroller-controller--createnamesrvcontrollerargs">1.NamesrvController controller = createNamesrvController(args);<a href="#1namesrvcontroller-controller--createnamesrvcontrollerargs" class="hash-link" aria-label="Direct link to 1.NamesrvController controller = createNamesrvController(args);" title="Direct link to 1.NamesrvController controller = createNamesrvController(args);">​</a></h5>
<ul>
<li>检测命令行参数</li>
<li>创建核心配置对象，NamesrvConfig、NettyServerConfig</li>
<li>解析 -c 、-p参数</li>
<li>检查RocketMQ_HOME环境变量</li>
<li>final NamesrvController controller = new NamesrvController(namesrvConfig, nettyServerConfig);创建controller</li>
<li>controller.getConfiguration().registerConfig(properties); 注册所有配置信息</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_HWLp" id="2startcontroller">2.start(controller);<a href="#2startcontroller" class="hash-link" aria-label="Direct link to 2.start(controller);" title="Direct link to 2.start(controller);">​</a></h5>
<ul>
<li>controller.initialize()； 执行初始化
○ this.kvConfigManager.load(); 加载KV配置
○ this.remotingServer = new NettyRemotingServer(this.nettyServerConfig, this.brokerHousekeepingService);创建NettyServer网络处理对象
○ this.remotingExecutor =Executors.newFixedThreadPool(nettyServerConfig.getServerWorkerThreads(), new ThreadFactoryImpl(&quot;RemotingExecutorThread_&quot;)); 创建Netty服务器工作线程池
○ this.registerProcessor(); 注册NameServer的Processor 注册到RemotingServer中
○ NamesrvController.this.routeInfoManager.scanNotActiveBroker() 启动定时任务，移除不活跃的Broker
○ NamesrvController.this.kvConfigManager.printAllPeriodically() 定时打印KV配置信息</li>
<li>Runtime.getRuntime().addShutdownHook 注册关闭钩子，在关闭服务时释放资源</li>
<li>controller.start()； 启动controller</li>
</ul>
<p>NameServer的作用主要有两个：
1.维护broker的服务地址信息，并进行更新
2.给Producer、consumer提供Broker的服务列表</p>
<p><img loading="lazy" src="https://java-tutorial.oss-cn-shanghai.aliyuncs.com/3245844-46ca880d83fb583b.png" alt="" class="img_kGBN"></p>
<p>image.png</p>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="二broker启动">二、Broker启动<a href="#二broker启动" class="hash-link" aria-label="Direct link to 二、Broker启动" title="Direct link to 二、Broker启动">​</a></h3>
<p>源码入口：Brokerstartup#main</p>
<h5 class="anchor anchorWithStickyNavbar_HWLp" id="1createbrokercontrollerargs">1.createBrokerController(args)<a href="#1createbrokercontrollerargs" class="hash-link" aria-label="Direct link to 1.createBrokerController(args)" title="Direct link to 1.createBrokerController(args)">​</a></h5>
<ul>
<li>构建四个核心配置对象：BrokerConfig、NettyServerConfig、NettyClientConfig、MessageStoreConfig</li>
<li>BrokerConfig只解析 -c参数</li>
<li>RocketMq_HOME环境变量检查</li>
<li>RemotingUtil.string2SocketAddress(addr) 将namesrvAddr地址进行拆分</li>
<li>messageStoreConfig.getBrokerRole() 通过BrokerId判断主从：masterId=0，Deldger集群的所有Broker节点ID都是-1</li>
<li>解析 -p、-m参数，并将解析的参数添加到四个核心配置对象中</li>
<li>BrokerController controller = new BrokerController 创建brokerController，将四个核心配置类传入</li>
<li>controller.getConfiguration().registerConfig(properties); 重新注册（更新）配置</li>
<li>controller.initialize(); 初始化controller
○ 加载磁盘上的配置文件：topicConfigManager、consumerOffsetManager、subscriptionGroupManager、consumerFilterManager
○ this.messageStore =new DefaultMessageStore() 构建消息存储组件
○ this.messageStore.load() 加载磁盘文件
○ this.remotingServer = new NettyRemotingServer 构建Netty网络组件
○ this.fastRemotingServer = new NettyRemotingServer 这个fastRemotingServer与RemotingServer功能基本差不多，处理VIP端口请求
○ 后面就是初始化一些线程池
○ this.registerProcessor(); broker注册一些Processor处理方法</li>
<li>Runtime.getRuntime().addShutdownHook 注册关闭钩子</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_HWLp" id="2startbrokercontroller-controller">2.start(BrokerController controller)<a href="#2startbrokercontroller-controller" class="hash-link" aria-label="Direct link to 2.start(BrokerController controller)" title="Direct link to 2.start(BrokerController controller)">​</a></h5>
<ul>
<li>this.messageStore.start(); 这里启动服务主要是为了将CommitLog的写入事件分发给ComsumeQueue和IndexFile</li>
<li>启动两个Netty服务：remotingServer、fastRemotingServer</li>
<li>this.fileWatchService.start(); 文件监听服务</li>
<li>this.brokerOuterAPI.start(); brokerOuterAPI可以理解为一个Netty客户端，往外发请求的组件，例如发送心跳</li>
<li>this.pullRequestHoldService.start(); 长轮询请求暂停服务</li>
<li>this.filterServerManager.start(); 使用filter进行过滤</li>
<li>BrokerController.this.registerBrokerAll() Broker核心的心跳注册任务,主要作用就是将broker注册到Namesrv中</li>
</ul>
<p>broker的核心作用：
<strong>1.作为client时，向nameServer发送心跳信息、发起事务的状态检查</strong>
<strong>2.作为服务端时，用于存储消息、响应consumer端的请 求</strong></p>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="三netty服务注册框架">三、Netty服务注册框架<a href="#三netty服务注册框架" class="hash-link" aria-label="Direct link to 三、Netty服务注册框架" title="Direct link to 三、Netty服务注册框架">​</a></h3>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="四broker心跳注册过程">四、Broker心跳注册过程<a href="#四broker心跳注册过程" class="hash-link" aria-label="Direct link to 四、Broker心跳注册过程" title="Direct link to 四、Broker心跳注册过程">​</a></h3>
<p>源码入口：BrokerController.this.registerBrokerAll(true, false, brokerConfig.isForceRegister())</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public synchronized void registerBrokerAll(final boolean checkOrderConfig, boolean oneway, boolean forceRegister) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TopicConfigSerializeWrapper topicConfigWrapper = this.getTopicConfigManager().buildTopicConfigSerializeWrapper();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!PermName.isWriteable(this.getBrokerConfig().getBrokerPermission())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        || !PermName.isReadable(this.getBrokerConfig().getBrokerPermission())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConcurrentHashMap&lt;String, TopicConfig&gt; topicConfigTable = new ConcurrentHashMap&lt;String, TopicConfig&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (TopicConfig topicConfig : topicConfigWrapper.getTopicConfigTable().values()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            TopicConfig tmp =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new TopicConfig(topicConfig.getTopicName(), topicConfig.getReadQueueNums(), topicConfig.getWriteQueueNums(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                this.brokerConfig.getBrokerPermission());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            topicConfigTable.put(topicConfig.getTopicName(), tmp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        topicConfigWrapper.setTopicConfigTable(topicConfigTable);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //这里才是比较关键的地方。先判断是否需要注册，然后调用doRegisterBrokerAll方法真正去注册。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (forceRegister || needRegister(this.brokerConfig.getBrokerClusterName(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      this.getBrokerAddr(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      this.brokerConfig.getBrokerName(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      this.brokerConfig.getBrokerId(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      this.brokerConfig.getRegisterBrokerTimeoutMills())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        doRegisterBrokerAll(checkOrderConfig, oneway, topicConfigWrapper);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">// Broker注册最核心的部分</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private void doRegisterBrokerAll(boolean checkOrderConfig, boolean oneway,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 TopicConfigSerializeWrapper topicConfigWrapper) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 注册broker方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;RegisterBrokerResult&gt; registerBrokerResultList = this.brokerOuterAPI.registerBrokerAll(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.brokerConfig.getBrokerClusterName(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.getBrokerAddr(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.brokerConfig.getBrokerName(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.brokerConfig.getBrokerId(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.getHAServerAddr(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        topicConfigWrapper,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.filterServerManager.buildNewFilterServerList(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        oneway,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.brokerConfig.getRegisterBrokerTimeoutMills(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.brokerConfig.isCompressedRegister());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (registerBrokerResultList.size() &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RegisterBrokerResult registerBrokerResult = registerBrokerResultList.get(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (registerBrokerResult != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //注册完保存主从节点的地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (this.updateMasterHAServerAddrPeriodically &amp;&amp; registerBrokerResult.getHaServerAddr() != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.messageStore.updateHaMasterAddress(registerBrokerResult.getHaServerAddr());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.slaveSynchronize.setMasterAddr(registerBrokerResult.getMasterAddr());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (checkOrderConfig) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.getTopicConfigManager().updateOrderTopicConfig(registerBrokerResult.getKvTable());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public List&lt;RegisterBrokerResult&gt; registerBrokerAll(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String clusterName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String brokerAddr,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String brokerName,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final long brokerId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String haServerAddr,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final TopicConfigSerializeWrapper topicConfigWrapper,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final List&lt;String&gt; filterServerList,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final boolean oneway,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final int timeoutMills,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final boolean compressed) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //使用CopyOnWriteArrayList提升并发安全性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final List&lt;RegisterBrokerResult&gt; registerBrokerResultList = new CopyOnWriteArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 获取所有nameServer的地址信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;String&gt; nameServerAddressList = this.remotingClient.getNameServerAddressList();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (nameServerAddressList != null &amp;&amp; nameServerAddressList.size() &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final RegisterBrokerRequestHeader requestHeader = new RegisterBrokerRequestHeader();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestHeader.setBrokerAddr(brokerAddr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestHeader.setBrokerId(brokerId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestHeader.setBrokerName(brokerName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestHeader.setClusterName(clusterName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestHeader.setHaServerAddr(haServerAddr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestHeader.setCompressed(compressed);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RegisterBrokerBody requestBody = new RegisterBrokerBody();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestBody.setTopicConfigSerializeWrapper(topicConfigWrapper);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestBody.setFilterServerList(filterServerList);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final byte[] body = requestBody.encode(compressed);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final int bodyCrc32 = UtilAll.crc32(body);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestHeader.setBodyCrc32(bodyCrc32);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //通过CountDownLatch，保证在所有NameServer上完成注册后再一起结束。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final CountDownLatch countDownLatch = new CountDownLatch(nameServerAddressList.size());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (final String namesrvAddr : nameServerAddressList) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            brokerOuterExecutor.execute(new Runnable() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                public void run() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        RegisterBrokerResult result = registerBroker(namesrvAddr, oneway, timeoutMills, requestHeader, body);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (result != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            registerBrokerResultList.add(result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        log.info(&quot;register broker[{}]to name server {} OK&quot;, brokerId, namesrvAddr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        log.warn(&quot;registerBroker Exception, {}&quot;, namesrvAddr, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        countDownLatch.countDown();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            countDownLatch.await(timeoutMills, TimeUnit.MILLISECONDS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (InterruptedException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return registerBrokerResultList;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>NameServer处理请求：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">//NameServer处理请求的核心代码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public RemotingCommand processRequest(ChannelHandlerContext ctx,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                          RemotingCommand request) throws RemotingCommandException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (ctx != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.debug(&quot;receive request, {} {} {}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  request.getCode(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  RemotingHelper.parseChannelRemoteAddr(ctx.channel()),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    switch (request.getCode()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case RequestCode.PUT_KV_CONFIG:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return this.putKVConfig(ctx, request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case RequestCode.GET_KV_CONFIG:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return this.getKVConfig(ctx, request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case RequestCode.DELETE_KV_CONFIG:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return this.deleteKVConfig(ctx, request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case RequestCode.QUERY_DATA_VERSION:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return queryBrokerTopicConfig(ctx, request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case RequestCode.REGISTER_BROKER: //Broker注册请求处理。版本默认是当前框架版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Version brokerVersion = MQVersion.value2Version(request.getVersion());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (brokerVersion.ordinal() &gt;= MQVersion.Version.V3_0_11.ordinal()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return this.registerBrokerWithFilterServer(ctx, request); //当前版本</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return this.registerBroker(ctx, request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case RequestCode.UNREGISTER_BROKER:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return this.unregisterBroker(ctx, request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case RequestCode.GET_ROUTEINFO_BY_TOPIC:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return this.getRouteInfoByTopic(ctx, request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case RequestCode.GET_BROKER_CLUSTER_INFO:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return this.getBrokerClusterInfo(ctx, request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case RequestCode.WIPE_WRITE_PERM_OF_BROKER:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return this.wipeWritePermOfBroker(ctx, request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case RequestCode.GET_ALL_TOPIC_LIST_FROM_NAMESERVER:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return getAllTopicListFromNameserver(ctx, request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case RequestCode.DELETE_TOPIC_IN_NAMESRV:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return deleteTopicInNamesrv(ctx, request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case RequestCode.GET_KVLIST_BY_NAMESPACE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return this.getKVListByNamespace(ctx, request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case RequestCode.GET_TOPICS_BY_CLUSTER:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return this.getTopicsByCluster(ctx, request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case RequestCode.GET_SYSTEM_TOPIC_LIST_FROM_NS:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return this.getSystemTopicListFromNs(ctx, request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case RequestCode.GET_UNIT_TOPIC_LIST:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return this.getUnitTopicList(ctx, request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case RequestCode.GET_HAS_UNIT_SUB_TOPIC_LIST:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return this.getHasUnitSubTopicList(ctx, request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case RequestCode.GET_HAS_UNIT_SUB_UNUNIT_TOPIC_LIST:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return this.getHasUnitSubUnUnitTopicList(ctx, request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case RequestCode.UPDATE_NAMESRV_CONFIG:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return this.updateConfig(ctx, request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case RequestCode.GET_NAMESRV_CONFIG:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return this.getConfig(ctx, request);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>实际就是将broker信息注册到routeInfo中：</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public RemotingCommand registerBrokerWithFilterServer(ChannelHandlerContext ctx, RemotingCommand request)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throws RemotingCommandException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final RemotingCommand response = RemotingCommand.createResponseCommand(RegisterBrokerResponseHeader.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final RegisterBrokerResponseHeader responseHeader = (RegisterBrokerResponseHeader) response.readCustomHeader();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final RegisterBrokerRequestHeader requestHeader =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        (RegisterBrokerRequestHeader) request.decodeCommandCustomHeader(RegisterBrokerRequestHeader.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!checksum(ctx, request, requestHeader)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        response.setCode(ResponseCode.SYSTEM_ERROR);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        response.setRemark(&quot;crc32 not match&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RegisterBrokerBody registerBrokerBody = new RegisterBrokerBody();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (request.getBody() != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            registerBrokerBody = RegisterBrokerBody.decode(request.getBody(), requestHeader.isCompressed());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new RemotingCommandException(&quot;Failed to decode RegisterBrokerBody&quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerBrokerBody.getTopicConfigSerializeWrapper().getDataVersion().setCounter(new AtomicLong(0));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerBrokerBody.getTopicConfigSerializeWrapper().getDataVersion().setTimestamp(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //routeInfoManager就是管理路由信息的核心组件。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RegisterBrokerResult result = this.namesrvController.getRouteInfoManager().registerBroker(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestHeader.getClusterName(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestHeader.getBrokerAddr(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestHeader.getBrokerName(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestHeader.getBrokerId(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestHeader.getHaServerAddr(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerBrokerBody.getTopicConfigSerializeWrapper(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        registerBrokerBody.getFilterServerList(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx.channel());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    responseHeader.setHaServerAddr(result.getHaServerAddr());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    responseHeader.setMasterAddr(result.getMasterAddr());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    byte[] jsonValue = this.namesrvController.getKvConfigManager().getKVListByNamespace(NamesrvUtil.NAMESPACE_ORDER_TOPIC_CONFIG);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    response.setBody(jsonValue);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    response.setCode(ResponseCode.SUCCESS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    response.setRemark(null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="五producer发送消息">五、Producer发送消息<a href="#五producer发送消息" class="hash-link" aria-label="Direct link to 五、Producer发送消息" title="Direct link to 五、Producer发送消息">​</a></h3>
<p>源码入口：DefaultMQProducer#start
1.this.defaultMQProducerImpl.start(); 生产端启动</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public void start(final boolean startFactory) throws MQClientException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    switch (this.serviceState) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case CREATE_JUST:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 默认就是CREATE_JUST</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.serviceState = ServiceState.START_FAILED;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.checkConfig();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //修改当前的instanceName为当前进程ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!this.defaultMQProducer.getProducerGroup().equals(MixAll.CLIENT_INNER_PRODUCER_GROUP)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.defaultMQProducer.changeInstanceNameToPID();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //客户端核心的MQ客户端工厂 对于事务消息发送者，在这里面会完成事务消息的发送者的服务注册</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.mQClientFactory = MQClientManager.getInstance().getOrCreateMQClientInstance(this.defaultMQProducer, rpcHook);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //注册MQ客户端工厂示例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boolean registerOK = mQClientFactory.registerProducer(this.defaultMQProducer.getProducerGroup(), this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!registerOK) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.serviceState = ServiceState.CREATE_JUST;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new MQClientException(&quot;The producer group[&quot; + this.defaultMQProducer.getProducerGroup()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            + &quot;] has been created before, specify another name please.&quot; + FAQUrl.suggestTodo(FAQUrl.GROUP_NAME_DUPLICATE_URL),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                            null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.topicPublishInfoTable.put(this.defaultMQProducer.getCreateTopicKey(), new TopicPublishInfo());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //启动示例 --所有客户端组件都交由mQClientFactory启动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (startFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                mQClientFactory.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.info(&quot;the producer [{}] start OK. sendMessageWithVIPChannel={}&quot;, this.defaultMQProducer.getProducerGroup(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     this.defaultMQProducer.isSendMessageWithVIPChannel());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.serviceState = ServiceState.RUNNING;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case RUNNING:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case START_FAILED:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case SHUTDOWN_ALREADY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new MQClientException(&quot;The producer service state not OK, maybe started once, &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        + this.serviceState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        + FAQUrl.suggestTodo(FAQUrl.CLIENT_SERVICE_NOT_OK),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 向所有的broker发送心跳</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.mQClientFactory.sendHeartbeatToAllBrokerWithLock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.startScheduledTask();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_HWLp" id="六consumer消费消息">六、Consumer消费消息<a href="#六consumer消费消息" class="hash-link" aria-label="Direct link to 六、Consumer消费消息" title="Direct link to 六、Consumer消费消息">​</a></h3>
<p>消费端入口：DefaultMQPushConsumer#start
this.defaultMQPushConsumerImpl.start();</p>
<div class="codeBlockContainer_Ty55 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_zoWS"><pre tabindex="0" class="prism-code language-text codeBlock_Po6r thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Llrq"><span class="token-line" style="color:#393A34"><span class="token plain">public synchronized void start() throws MQClientException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    switch (this.serviceState) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        case CREATE_JUST:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.info(&quot;the consumer [{}] start beginning. messageModel={}, isUnitMode={}&quot;, this.defaultMQPushConsumer.getConsumerGroup(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     this.defaultMQPushConsumer.getMessageModel(), this.defaultMQPushConsumer.isUnitMode());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.serviceState = ServiceState.START_FAILED;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.checkConfig();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.copySubscription();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (this.defaultMQPushConsumer.getMessageModel() == MessageModel.CLUSTERING) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.defaultMQPushConsumer.changeInstanceNameToPID();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //客户端示例工厂，生产者也是交由这个工厂启动的。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.mQClientFactory = MQClientManager.getInstance().getOrCreateMQClientInstance(this.defaultMQPushConsumer, this.rpcHook);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //负载均衡策略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.rebalanceImpl.setConsumerGroup(this.defaultMQPushConsumer.getConsumerGroup());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.rebalanceImpl.setMessageModel(this.defaultMQPushConsumer.getMessageModel());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.rebalanceImpl.setAllocateMessageQueueStrategy(this.defaultMQPushConsumer.getAllocateMessageQueueStrategy());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.rebalanceImpl.setmQClientFactory(this.mQClientFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.pullAPIWrapper = new PullAPIWrapper(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                mQClientFactory,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.defaultMQPushConsumer.getConsumerGroup(), isUnitMode());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.pullAPIWrapper.registerFilterMessageHook(filterMessageHookList);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (this.defaultMQPushConsumer.getOffsetStore() != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.offsetStore = this.defaultMQPushConsumer.getOffsetStore();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //从这里可以看出，广播模式与集群模式的最本质区别就是offset存储的地方不一样。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                switch (this.defaultMQPushConsumer.getMessageModel()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        //广播模式是在消费者本地存储offset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    case BROADCASTING:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        this.offsetStore = new LocalFileOffsetStore(this.mQClientFactory, this.defaultMQPushConsumer.getConsumerGroup());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        //集群模式是在Broker远端存储offset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    case CLUSTERING:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        this.offsetStore = new RemoteBrokerOffsetStore(this.mQClientFactory, this.defaultMQPushConsumer.getConsumerGroup());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.defaultMQPushConsumer.setOffsetStore(this.offsetStore);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.offsetStore.load();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //顺序消费监听创建ConsumeMessageOrderlyService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (this.getMessageListenerInner() instanceof MessageListenerOrderly) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.consumeOrderly = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.consumeMessageService =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    new ConsumeMessageOrderlyService(this, (MessageListenerOrderly) this.getMessageListenerInner());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //并发消费监听创建ConsumeMessageConcurrentlyService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (this.getMessageListenerInner() instanceof MessageListenerConcurrently) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               this.consumeOrderly = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               this.consumeMessageService =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               new ConsumeMessageConcurrentlyService(this, (MessageListenerConcurrently) this.getMessageListenerInner());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           this.consumeMessageService.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           //注册消费者。与生产者类似，客户端只要按要求注册即可，后续会随mQClientFactory一起启动。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           boolean registerOK = mQClientFactory.registerConsumer(this.defaultMQPushConsumer.getConsumerGroup(), this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           if (!registerOK) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               this.serviceState = ServiceState.CREATE_JUST;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               this.consumeMessageService.shutdown(defaultMQPushConsumer.getAwaitTerminationMillisWhenShutdown());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               throw new MQClientException(&quot;The consumer group[&quot; + this.defaultMQPushConsumer.getConsumerGroup()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               + &quot;] has been created before, specify another name please.&quot; + FAQUrl.suggestTodo(FAQUrl.GROUP_NAME_DUPLICATE_URL),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           mQClientFactory.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           log.info(&quot;the consumer [{}] start OK.&quot;, this.defaultMQPushConsumer.getConsumerGroup());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           this.serviceState = ServiceState.RUNNING;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           case RUNNING:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           case START_FAILED:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           case SHUTDOWN_ALREADY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new MQClientException(&quot;The PushConsumer service state not OK, maybe started once, &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                + this.serviceState</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                + FAQUrl.suggestTodo(FAQUrl.CLIENT_SERVICE_NOT_OK),null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               this.updateTopicSubscribeInfoWhenSubscriptionChanged();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               this.mQClientFactory.checkClientInBroker();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               this.mQClientFactory.sendHeartbeatToAllBrokerWithLock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               this.mQClientFactory.rebalanceImmediately();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_EjFN"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_RXpO" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_sabX"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_WdXf"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>1、consumer端的消费模式：</strong>
● 集群模式：集群模式下每个consumer都会分配不同的消息
● 广播模式：广播模式下每个消息都推送给所有consumer
<strong>2、关于offset存储：</strong>
● 广播模式：this.offsetStore = new LocalFileOffsetStore(); 存储在每个consumer中
● 集群模式：this.offsetStore = new RemoteBrokerOffsetStore(); 存储在broker端</p>
<p>作者：枫叶红花
链接：<a href="https://www.jianshu.com/p/8dd4cfeae39d" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/8dd4cfeae39d</a>
来源：简书
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>
<h1>参考文章</h1>
<p><a href="https://lijunyi.xyz/docs/SpringCloud/SpringCloud.html#_2-2-x-%E5%88%86%E6%94%AF" target="_blank" rel="noopener noreferrer">https://lijunyi.xyz/docs/SpringCloud/SpringCloud.html#_2-2-x-%E5%88%86%E6%94%AF</a>
<a href="https://mp.weixin.qq.com/s/2jeovmj77O9Ux96v3A0NtA" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s/2jeovmj77O9Ux96v3A0NtA</a>
<a href="https://juejin.cn/post/6931922457741770760" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6931922457741770760</a>
<a href="https://github.com/D2C-Cai/herring" target="_blank" rel="noopener noreferrer">https://github.com/D2C-Cai/herring</a>
<a href="http://c.biancheng.net/springcloud" target="_blank" rel="noopener noreferrer">http://c.biancheng.net/springcloud</a>
<a href="https://github.com/macrozheng/springcloud-learning" target="_blank" rel="noopener noreferrer">https://github.com/macrozheng/springcloud-learning</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Spring全家桶/SpringCloudAlibaba源码分析/SpringCloudRocketMQ源码分析.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_EYjg" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_eevz"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba源码分析/SpringCloudAlibabaNacos源码分析：配置中心"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Nacos配置中心</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/code-note-blog/docs/Spring全家桶/SpringCloudAlibaba源码分析/SpringCloudSeata源码分析"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">SpringCloudSeata源码分析</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_lc2k thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#一nameserver启动" class="table-of-contents__link toc-highlight">一、NameServer启动</a></li><li><a href="#二broker启动" class="table-of-contents__link toc-highlight">二、Broker启动</a></li><li><a href="#三netty服务注册框架" class="table-of-contents__link toc-highlight">三、Netty服务注册框架</a></li><li><a href="#四broker心跳注册过程" class="table-of-contents__link toc-highlight">四、Broker心跳注册过程</a></li><li><a href="#五producer发送消息" class="table-of-contents__link toc-highlight">五、Producer发送消息</a></li><li><a href="#六consumer消费消息" class="table-of-contents__link toc-highlight">六、Consumer消费消息</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/code-note-blog/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/code-note-blog/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_B3Gq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>